<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-Course Assessment - Coaching & Leadership</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <!-- *** Include Supabase JS Library *** -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- Base Styles (Enhanced) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f8fafc; margin: 0; padding: 0; line-height: 1.6; color: #374151; display: flex; flex-direction: column; min-height: 100vh; }
        main { flex-grow: 1; display: flex; justify-content: center; align-items: flex-start; flex-direction: column; width: 100%; max-width: 1000px; margin: 20px auto; padding: 0 20px; /* Adjusted padding */ }
        .header { background: linear-gradient(90deg, #2c3e50, #34495e); color: white; padding: 18px 0; text-align: center; font-size: 26px; font-weight: 600; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); width: 100%; border-bottom: 3px solid #3498db; }
        .user-bar { background-color: #ffffff; padding: 12px 30px; display: flex; justify-content: space-between; align-items: center; color: #4b5563; font-size: 15px; width: 100%; border-bottom: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-info svg { color: #3498db; opacity: 1; }
        .user-details-bar { display: flex; flex-direction: column; }
        .user-name-bar { font-weight: 600; font-size: 16px; color: #1f2937; }
        .user-email-bar { font-size: 13px; opacity: 0.8; color: #6b7280; }
        .logout-button { background-color: #ef4444; color: white; border: none; padding: 9px 18px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; }
        .logout-button:hover { background-color: #dc2626; box-shadow: 0 2px 5px rgba(239, 68, 68, 0.3); transform: translateY(-1px); }
        .logout-button:active { transform: translateY(0); }
        .footer { text-align: center; padding: 25px 30px; background: #f9fafb; color: #6b7280; margin-top: auto; font-size: 14px; width: 100%; border-top: 1px solid #e5e7eb; }

        /* --- Assessment Container Styles --- */
        #assessmentSection {
            background: white;
            padding: 35px 45px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            width: 100%;
            margin-bottom: 35px;
            text-align: left;
            opacity: 0; /* Initially hidden for fade-in */
            transition: opacity 0.7s ease-in-out;
            border: 1px solid #e5e7eb;
        }
        #assessmentSection.fade-in { opacity: 1; }
        #assessmentSection h2 {
            color: #1f2937;
            margin-bottom: 25px;
            font-size: 28px;
            font-weight: 600;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 15px;
        }

        /* --- Pre-Course Assessment Styles --- */
        #assessmentSection .intro-note {
            background-color: #eff6ff; /* Light blue */
            border-left: 5px solid #3b82f6;
            padding: 18px 25px;
            margin-bottom: 30px;
            border-radius: 6px;
            font-size: 16px;
            color: #374151;
            line-height: 1.7;
        }
        #assessmentForm .form-group { margin-bottom: 30px; }
        #assessmentForm label { display: block; margin-bottom: 10px; font-weight: 600; color: #374151; font-size: 17px; }
        #assessmentForm textarea, #assessmentForm input[type="number"], #assessmentForm select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
            color: #1f2937;
        }
        #assessmentForm textarea { min-height: 120px; resize: vertical; }
        #assessmentForm textarea:focus, #assessmentForm input[type="number"]:focus, #assessmentForm select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
            outline: none;
        }
        #assessmentForm .input-meta-info { display: flex; justify-content: space-between; align-items: center; margin-top: 6px; }
        #assessmentForm .word-count-info { font-size: 13px; color: #6b7280; }
        #assessmentForm .paste-warning { font-size: 13px; color: #f97316; display: none; }
        #assessmentForm .error-message { color: #ef4444; font-size: 14px; margin-top: 8px; display: none; font-weight: 500;}
        #assessmentForm input.invalid, #assessmentForm textarea.invalid { border-color: #ef4444; }
        #assessmentSubmitBtn {
            background-color: #10b981; /* Emerald green */
            color: white;
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
            min-width: 180px; /* Ensure enough width for 'Submitting...' */
            text-align: center;
        }
        #assessmentSubmitBtn:hover { background-color: #059669; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2); }
        #assessmentSubmitBtn:disabled { background-color: #9ca3af; cursor: not-allowed; transform: none; box-shadow: none;}

        /* Success Popup */
        #assessmentSuccessPopup {
            display: none; position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%);
            background-color: white; padding: 45px 50px; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); z-index: 1000; text-align: center;
            border-top: 6px solid #10b981; min-width: 350px;
        }
         #assessmentSuccessPopup p { font-size: 19px; color: #374151; margin-bottom: 30px; line-height: 1.6; }
         #assessmentSuccessPopup button {
            background-color: #3b82f6; color: white; padding: 12px 25px; border: none;
            border-radius: 6px; cursor: pointer; font-size: 17px; transition: background-color 0.3s; font-weight: 500;
         }
         #assessmentSuccessPopup button:hover { background-color: #2563eb; }
         .popup-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 999; }

         /* Loading Message */
         #loadingMessage { text-align: center; padding: 60px 20px; font-size: 20px; color: #6b7280; width: 100%; }

         /* Responsive Adjustments */
         @media (max-width: 768px) {
             main { padding: 0 15px; margin: 15px auto; }
             #assessmentSection { padding: 25px 30px; }
             .header { font-size: 22px; padding: 15px 0; }
             .user-bar { padding: 10px 20px; }
         }
         @media (max-width: 600px) {
             #assessmentSection { padding: 20px; }
             #assessmentSuccessPopup { width: 90%; padding: 30px 25px; }
             #assessmentForm textarea { min-height: 100px; }
             #assessmentForm label { font-size: 16px; }
             #assessmentForm input[type="number"], #assessmentForm textarea, #assessmentForm select { padding: 12px 14px; font-size: 15px; }
             #assessmentSubmitBtn { padding: 12px 25px; font-size: 16px; }
         }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">Coaching & Leadership Dashboard</header>

    <!-- User Bar -->
    <div class="user-bar">
        <div class="user-info">
             <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path> <circle cx="12" cy="7" r="4"></circle> </svg>
            <div class="user-details-bar">
                <span class="user-name-bar" id="userNameBar">Loading...</span>
                <span class="user-email-bar" id="userEmailBar"></span>
            </div>
        </div>
        <button class="logout-button" onclick="logout()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path> <polyline points="16 17 21 12 16 7"></polyline> <line x1="21" y1="12" x2="9" y2="12"></line> </svg>
            Logout
        </button>
    </div>

    <!-- Main Content Area -->
    <main>
        <div id="loadingMessage">Loading Assessment...</div>

        <!-- Pre-Course Assessment Section -->
        <section id="assessmentSection" style="display: none;"> <!-- Initially hidden until logic runs -->
            <h2>Pre-Course Assessment</h2>
            <p class="intro-note">
                <strong>Welcome!</strong> Before you begin the course modules, please take a moment to answer these questions. Your answers help us personalize your experience. Please answer honestly in your own words. <span id="adminAssessmentNote" style="display: none; font-weight: bold; color: #b45309;"> (Admin: Word count and paste restrictions are disabled for your account.)</span>
            </p>
            <form id="assessmentForm" novalidate>
                 <!-- Question 1 -->
                <div class="form-group">
                    <label for="q1_coaching_meaning">What does coaching mean to you?</label>
                    <textarea id="q1_coaching_meaning" name="coaching_meaning" required data-min-words="20" placeholder="Describe your understanding of coaching..."></textarea>
                    <div class="input-meta-info">
                        <div class="paste-warning" id="q1_paste_warning">Pasting content is discouraged. Please use your own words.</div>
                        <div class="word-count-info" id="q1_word_count_container">Words: <span id="q1_word_count">0</span>/20</div>
                    </div>
                    <div class="error-message" id="q1_error"></div>
                </div>

                <!-- Question 2 (Randomized) -->
                 <div class="form-group" id="randomQuestionContainer">
                     <!-- Label and Input will be inserted here by JS -->
                     <div class="input-meta-info">
                         <div class="paste-warning" id="q_random_paste_warning">Pasting content is discouraged. Please use your own words.</div>
                         <div class="word-count-info" id="q_random_word_count_container">Words: <span id="q_random_word_count">0</span>/<span id="q_random_min_words_display">?</span></div>
                     </div>
                     <div class="error-message" id="q_random_error"></div>
                 </div>

                <!-- Question 3 -->
                <div class="form-group">
                    <label for="q3_expectations">What are your expectations from this course?</label>
                    <textarea id="q3_expectations" name="expectations" required data-min-words="15" placeholder="What do you hope to learn or achieve?"></textarea>
                     <div class="input-meta-info">
                         <div class="paste-warning" id="q3_paste_warning">Pasting content is discouraged. Please use your own words.</div>
                         <div class="word-count-info" id="q3_word_count_container">Words: <span id="q3_word_count">0</span>/15</div>
                     </div>
                    <div class="error-message" id="q3_error"></div>
                </div>

                <!-- Question 4 -->
                 <div class="form-group">
                    <label for="q4_confidence_rating">Rate your current coaching confidence (1=Low, 5=High)</label>
                    <input type="number" id="q4_confidence_rating" name="confidence_rating" required min="1" max="5" step="1" placeholder="Enter a number between 1 and 5">
                    <div class="error-message" id="q4_rating_error"></div>

                    <label for="q4_confidence_explanation" style="margin-top: 15px;">Briefly explain your rating:</label>
                    <textarea id="q4_confidence_explanation" name="confidence_explanation" required data-min-words="10" placeholder="Why did you choose this rating?"></textarea>
                     <div class="input-meta-info">
                         <div class="paste-warning" id="q4_exp_paste_warning">Pasting content is discouraged. Please use your own words.</div>
                         <div class="word-count-info" id="q4_exp_word_count_container">Words: <span id="q4_exp_word_count">0</span>/10</div>
                     </div>
                    <div class="error-message" id="q4_exp_error"></div>
                </div>

                <button type="submit" id="assessmentSubmitBtn">Submit Assessment</button>
            </form>
        </section>

         <!-- Success Popup -->
         <div class="popup-overlay" id="popupOverlay"></div>
         <div id="assessmentSuccessPopup">
             <p>Thank you! Your answers have been saved. You can now start your journey!</p>
             <button id="startJourneyBtn">Start Course</button>
         </div>

    </main>

    <!-- Footer -->
    <footer class="footer">
        © 2025 Elmenisy Leadership Coaching - All Rights Reserved
    </footer>

    <script>
        // --- Constants ---
        const LOGGED_IN_KEY = 'isUserLoggedIn';
        const CURRENT_USER_KEY = 'currentUser';
        const SIGNUP_FLAG_KEY = 'hasSignedUpBefore';
        const ADMIN_EMAIL = 'm.elsayed@thechefz.co'; // Case-insensitive comparison
        const DASHBOARD_URL = 'Dashboard.html'; // URL for the main dashboard

        // *** Supabase Configuration ***
        const SUPABASE_URL = 'YOUR_SUPABASE_URL'; // <--- استبدل هذا بالـ URL الخاص بك
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY'; // <--- استبدل هذا بالـ Anon Key الخاص بك
        let supabase = null; // Will hold the Supabase client instance

        // Assessment Question Pool
        const randomQuestionPool = [
            { id: 'q_leadership_vs_management', label: 'How do you differentiate leadership from management?', minWords: 20 },
            { id: 'q_coaching_challenge', label: 'What do you see as the biggest challenge in coaching others?', minWords: 20 },
            { id: 'q_leadership_style', label: 'Briefly describe your ideal leadership style.', minWords: 15 }
        ];
        let selectedRandomQuestion = null; // Will hold the chosen question object

        // --- Global variable for admin status ---
        let IS_ADMIN_USER = false;

        // --- Supabase Client Initialization ---
        try {
            if (!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_URL === 'YOUR_SUPABASE_URL') {
                throw new Error("Supabase URL or Anon Key is not configured. Please update the script.");
            }
            supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log("Supabase client initialized successfully.");
        } catch (error) {
            console.error("FATAL: Error initializing Supabase client:", error);
            // Display a persistent error message to the user as the app likely won't work
            const mainElement = document.querySelector('main');
            if (mainElement) {
                mainElement.innerHTML = `<div style="color: red; text-align: center; padding: 40px; font-size: 18px; border: 1px solid red; background: #ffebee; border-radius: 8px; margin: 20px;">
                    <strong>Database Connection Error!</strong><br> Could not connect to the required services. Please contact support or try again later. <br><small>(${error.message})</small>
                    </div>`;
            } else {
                alert(`Database Connection Error: ${error.message}. The application cannot load.`);
            }
            // We might stop further script execution here depending on the desired behavior
            // throw new Error("Stopping script due to Supabase init failure.");
        }

        // --- IMMEDIATE REDIRECTION LOGIC ---
        console.log("%cAssessment Page: Running IMMEDIATE redirection check...", "color: purple; font-weight: bold;");
        function quickCheckCurrentUserFormat() {
            const data = localStorage.getItem(CURRENT_USER_KEY);
            // Also check if ID is present, as it's needed for Supabase ops
            try {
                if (data && data.length > 2 && data.startsWith('{') && data.endsWith('}')) {
                    const user = JSON.parse(data);
                    return !!user.id; // Return true only if user object has an ID
                }
                return false;
            } catch (e) {
                console.warn("Error parsing user data during quick check:", e);
                return false;
            }
        }
        const isLoggedIn_immediate = localStorage.getItem(LOGGED_IN_KEY) === 'true' && quickCheckCurrentUserFormat();
        const hasSignedUp_immediate = localStorage.getItem(SIGNUP_FLAG_KEY) === 'true';

        if (!isLoggedIn_immediate) {
            const targetUrl = hasSignedUp_immediate ? 'login.html' : 'signup.html';
            console.error(`%cAssessment Page IMMEDIATE Redirect: Not logged in or user data/ID invalid. Redirecting to ${targetUrl}...`, "color: orange;");
            window.location.replace(`${targetUrl}?redirect=${encodeURIComponent(window.location.pathname)}`);
            throw new Error("Redirecting user: Not logged in or invalid/incomplete user data.");
        } else {
            console.log("%cAssessment Page IMMEDIATE Check: User IS logged in with valid data format. Proceeding.", "color: green;");
        }
        // --- END IMMEDIATE REDIRECTION ---

        document.addEventListener('DOMContentLoaded', function() {
            console.log("Assessment page DOM loaded.");

             // Check if Supabase failed to initialize earlier
             if (!supabase) {
                 console.error("DOM Loaded: Supabase client is not available. Assessment cannot proceed.");
                 // Error message should already be displayed.
                 return; // Stop further setup
             }

            // --- Element References ---
            const loadingMessage = document.getElementById('loadingMessage');
            const assessmentSection = document.getElementById('assessmentSection');
            const assessmentForm = document.getElementById('assessmentForm');
            const assessmentSuccessPopup = document.getElementById('assessmentSuccessPopup');
            const popupOverlay = document.getElementById('popupOverlay');
            const startJourneyBtn = document.getElementById('startJourneyBtn');

            // Get current user data
            const currentUser = getCurrentUser(); // getCurrentUser now ensures 'id' exists

            if (!currentUser) {
                console.error("Assessment DOMContentLoaded: Critical - User data missing/invalid after initial check. Forcing logout.");
                logout(); // Force logout if user data is corrupt/missing
                return; // Stop further execution
            }

            console.log("Current User Data (Assessment):", currentUser);

            // *** Determine if the current user is the admin ***
            IS_ADMIN_USER = currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
            console.log(`User is admin: ${IS_ADMIN_USER}`);

            // Populate user info in the top bar immediately
            populateTopBar(currentUser);

            // --- Assessment Check ---
            // Check BOTH localStorage flag AND potentially query Supabase if needed for robustness
            // For now, we rely on the localStorage flag which should be set by handleAssessmentSubmit
            if (currentUser.assessmentCompleted) {
                console.log("Assessment already completed (according to localStorage). Redirecting to Dashboard.");
                window.location.replace(DASHBOARD_URL); // Redirect immediately
            } else {
                console.log("Assessment not completed. Displaying assessment form.");
                setupAssessmentForm(); // Setup the form (knows about IS_ADMIN_USER)
                loadingMessage.style.display = 'none';
                assessmentSection.style.display = 'block';
                setTimeout(() => assessmentSection.classList.add('fade-in'), 50); // Fade in effect
            }

             // Attach listener for the success popup button
             startJourneyBtn.addEventListener('click', () => {
                 console.log("Start Journey button clicked. Redirecting to Dashboard.");
                 window.location.href = DASHBOARD_URL; // Redirect to the main dashboard page
             });
        });

        // --- Helper Functions ---

        function getCurrentUser() {
            try {
                const userData = localStorage.getItem(CURRENT_USER_KEY);
                if (!userData) {
                    console.warn("getCurrentUser: No current user data found.");
                    return null;
                }
                const parsedUser = JSON.parse(userData);

                // **CRITICAL CHECK**: Ensure essential fields including 'id' exist
                if (parsedUser && typeof parsedUser === 'object' && parsedUser.name && parsedUser.email && parsedUser.id) {
                     // Initialize flags/objects if they are missing (defensive programming)
                     parsedUser.assessmentCompleted = parsedUser.assessmentCompleted || false;
                     parsedUser.assessmentAnswers = (typeof parsedUser.assessmentAnswers === 'object' && parsedUser.assessmentAnswers !== null) ? parsedUser.assessmentAnswers : {};
                     parsedUser.progress = (typeof parsedUser.progress === 'object' && parsedUser.progress !== null) ? parsedUser.progress : {};
                     // No need to save here unless something was initialized
                     if (parsedUser.assessmentCompleted === undefined || parsedUser.assessmentAnswers === undefined || parsedUser.progress === undefined) {
                         saveCurrentUser(parsedUser); // Save if defaults were added
                     }
                    return parsedUser;
                } else {
                    console.error("getCurrentUser: Parsed user data is invalid or missing required fields (name, email, id).", parsedUser);
                    logout(); // Force logout if data is bad/incomplete
                    return null;
                }
            } catch (error) {
                console.error("Error parsing current user data:", error);
                logout(); // Force logout on parsing error
                return null;
            }
        }

        function saveCurrentUser(userObject) {
             try {
                 if (!userObject || typeof userObject !== 'object' || !userObject.id) { throw new Error("Invalid or incomplete user object for saving."); }
                 localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(userObject));
                 console.log("Saved user data to localStorage:", userObject);
             } catch (error) {
                 console.error("Error saving current user data:", error);
             }
        }

        function populateTopBar(user) {
            const userNameBar = document.getElementById('userNameBar');
            const userEmailBar = document.getElementById('userEmailBar');
            if (userNameBar) userNameBar.textContent = user.name;
            if (userEmailBar) userEmailBar.textContent = user.email;
        }

        function setupAssessmentForm() {
             const form = document.getElementById('assessmentForm');
             const q1Textarea = document.getElementById('q1_coaching_meaning');
             const q3Textarea = document.getElementById('q3_expectations');
             const q4Rating = document.getElementById('q4_confidence_rating');
             const q4Explanation = document.getElementById('q4_confidence_explanation');
             const randomQuestionContainer = document.getElementById('randomQuestionContainer');

             // Show admin note if applicable
             if (IS_ADMIN_USER) {
                document.getElementById('adminAssessmentNote').style.display = 'inline';
                q1Textarea.placeholder = "Admin: No word count required.";
                q3Textarea.placeholder = "Admin: No word count required.";
                q4Explanation.placeholder = "Admin: No word count required.";
             } else {
                q1Textarea.placeholder = `Describe your understanding of coaching... (min ${q1Textarea.getAttribute('data-min-words')} words)`;
                q3Textarea.placeholder = `What do you hope to learn or achieve? (min ${q3Textarea.getAttribute('data-min-words')} words)`;
                q4Explanation.placeholder = `Why did you choose this rating? (min ${q4Explanation.getAttribute('data-min-words')} words)`;
             }

             // --- Select and Inject Random Question ---
             selectedRandomQuestion = randomQuestionPool[Math.floor(Math.random() * randomQuestionPool.length)];
             const randomPlaceholder = IS_ADMIN_USER ? "Admin: No word count required." : `Please provide your thoughts... (min ${selectedRandomQuestion.minWords} words)`;
             const randomWordCountDisplay = IS_ADMIN_USER ? '' : `/${selectedRandomQuestion.minWords}`;

             randomQuestionContainer.innerHTML = `
                 <label for="${selectedRandomQuestion.id}">${selectedRandomQuestion.label}</label>
                 <textarea id="${selectedRandomQuestion.id}" name="${selectedRandomQuestion.id}" required data-min-words="${selectedRandomQuestion.minWords}" placeholder="${randomPlaceholder}"></textarea>
                 <div class="input-meta-info">
                     <div class="paste-warning" id="${selectedRandomQuestion.id}_paste_warning">Pasting content is discouraged. Please use your own words.</div>
                     <div class="word-count-info" id="${selectedRandomQuestion.id}_word_count_container">Words: <span id="${selectedRandomQuestion.id}_word_count">0</span>${randomWordCountDisplay}</div>
                 </div>
                 <div class="error-message" id="${selectedRandomQuestion.id}_error"></div>
             `;
             const qRandomTextarea = document.getElementById(selectedRandomQuestion.id);

             // --- Setup Conditional Validation/Restrictions ---
             setupWordCountValidation(q1Textarea, document.getElementById('q1_word_count'), document.getElementById('q1_error'), document.getElementById('q1_word_count_container'), IS_ADMIN_USER);
             setupWordCountValidation(qRandomTextarea, document.getElementById(`${selectedRandomQuestion.id}_word_count`), document.getElementById(`${selectedRandomQuestion.id}_error`), document.getElementById(`${selectedRandomQuestion.id}_word_count_container`), IS_ADMIN_USER);
             setupWordCountValidation(q3Textarea, document.getElementById('q3_word_count'), document.getElementById('q3_error'), document.getElementById('q3_word_count_container'), IS_ADMIN_USER);
             setupWordCountValidation(q4Explanation, document.getElementById('q4_exp_word_count'), document.getElementById('q4_exp_error'), document.getElementById('q4_exp_word_count_container'), IS_ADMIN_USER);

             setupPastePrevention(q1Textarea, document.getElementById('q1_paste_warning'), IS_ADMIN_USER);
             setupPastePrevention(qRandomTextarea, document.getElementById(`${selectedRandomQuestion.id}_paste_warning`), IS_ADMIN_USER);
             setupPastePrevention(q3Textarea, document.getElementById('q3_paste_warning'), IS_ADMIN_USER);
             setupPastePrevention(q4Explanation, document.getElementById('q4_exp_paste_warning'), IS_ADMIN_USER);

             // --- Form Submission ---
             form.addEventListener('submit', handleAssessmentSubmit); // Now async
        }

        function countWords(text) {
            return text ? text.trim().split(/\s+/).filter(Boolean).length : 0;
        }

        function setupWordCountValidation(textarea, countSpan, errorElement, countContainer, isAdmin) {
            const minWords = parseInt(textarea.getAttribute('data-min-words'), 10);
            if (isAdmin) {
                if(countContainer) countContainer.style.display = 'none'; // Hide count for admin
                 return;
            }
             if (!countContainer || !countSpan || !errorElement) {
                 console.warn("Word count elements missing for:", textarea.id);
                 return;
             }
             textarea.addEventListener('input', () => {
                 const words = countWords(textarea.value);
                 countSpan.textContent = words;
                 validateWordCount(textarea, minWords, errorElement, isAdmin);
             });
             validateWordCount(textarea, minWords, errorElement, isAdmin); // Initial check
        }

        function validateWordCount(textarea, minWords, errorElement, isAdmin) {
             if (isAdmin) {
                 if (errorElement) errorElement.style.display = 'none';
                 textarea.classList.remove('invalid');
                 return true;
             }
             const words = countWords(textarea.value);
             const isFieldEmpty = !textarea.value.trim();

             if (!isFieldEmpty && words < minWords) {
                 errorElement.textContent = `Minimum ${minWords} words required.`;
                 errorElement.style.display = 'block';
                 textarea.classList.add('invalid');
                 return false;
             } else {
                 errorElement.style.display = 'none';
                 textarea.classList.remove('invalid');
                 return true;
             }
        }

        function setupPastePrevention(textarea, warningElement, isAdmin) {
            if (!isAdmin) {
                if (!warningElement) {
                    console.warn("Paste warning element missing for:", textarea.id);
                    return;
                }
                textarea.addEventListener('paste', (event) => {
                    event.preventDefault();
                    warningElement.textContent = 'Pasting is disabled. Please type your answer.';
                    warningElement.style.display = 'block';
                    setTimeout(() => { warningElement.style.display = 'none'; }, 4000);
                });
            } else {
                 if (warningElement) warningElement.style.display = 'none'; // Ensure hidden for admin
            }
        }


        // --- MODIFIED: Assessment Submission Handler (Async for Supabase) ---
        async function handleAssessmentSubmit(event) {
            event.preventDefault();
            console.log("Assessment submit triggered.");
            const form = event.target;
            const submitButton = document.getElementById('assessmentSubmitBtn');
            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...'; // Indicate processing

            // Clear previous errors
            form.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            form.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));

            // Get elements
            const q1Textarea = document.getElementById('q1_coaching_meaning');
            const qRandomTextarea = document.getElementById(selectedRandomQuestion.id);
            const q3Textarea = document.getElementById('q3_expectations');
            const q4Rating = document.getElementById('q4_confidence_rating');
            const q4Explanation = document.getElementById('q4_confidence_explanation');

            // Get error elements
            const q1Error = document.getElementById('q1_error');
            const qRandomError = document.getElementById(`${selectedRandomQuestion.id}_error`);
            const q3Error = document.getElementById('q3_error');
            const q4RatingError = document.getElementById('q4_rating_error');
            const q4ExpError = document.getElementById('q4_exp_error');

            let isValid = true;

            // --- Validation (Checks isAdmin internally where needed) ---
            if (!q1Textarea.value.trim()) { q1Error.textContent = 'This field is required.'; q1Error.style.display = 'block'; q1Textarea.classList.add('invalid'); isValid = false; }
            else if (!validateWordCount(q1Textarea, parseInt(q1Textarea.getAttribute('data-min-words'), 10), q1Error, IS_ADMIN_USER)) { isValid = false; }

            if (!qRandomTextarea.value.trim()) { qRandomError.textContent = 'This field is required.'; qRandomError.style.display = 'block'; qRandomTextarea.classList.add('invalid'); isValid = false; }
            else if (!validateWordCount(qRandomTextarea, selectedRandomQuestion.minWords, qRandomError, IS_ADMIN_USER)) { isValid = false; }

            if (!q3Textarea.value.trim()) { q3Error.textContent = 'This field is required.'; q3Error.style.display = 'block'; q3Textarea.classList.add('invalid'); isValid = false; }
            else if (!validateWordCount(q3Textarea, parseInt(q3Textarea.getAttribute('data-min-words'), 10), q3Error, IS_ADMIN_USER)) { isValid = false; }

            const ratingVal = parseInt(q4Rating.value, 10);
            if (!q4Rating.value || isNaN(ratingVal) || ratingVal < 1 || ratingVal > 5) { q4RatingError.textContent = 'Please enter a valid rating between 1 and 5.'; q4RatingError.style.display = 'block'; q4Rating.classList.add('invalid'); isValid = false; }

            if (!q4Explanation.value.trim()) { q4ExpError.textContent = 'This field is required.'; q4ExpError.style.display = 'block'; q4Explanation.classList.add('invalid'); isValid = false; }
            else if (!validateWordCount(q4Explanation, parseInt(q4Explanation.getAttribute('data-min-words'), 10), q4ExpError, IS_ADMIN_USER)) { isValid = false; }

            // --- Process if Valid ---
            if (isValid) {
                console.log("Assessment form is valid. Attempting to save to Supabase...");

                // Ensure Supabase client is ready
                if (!supabase) {
                     console.error("Supabase client is not initialized. Cannot save assessment.");
                     alert("Database connection error. Please refresh the page or contact support.");
                     submitButton.disabled = false;
                     submitButton.textContent = 'Submit Assessment';
                     return;
                }

                const currentUser = getCurrentUser();
                // **CRITICAL CHECK**: Ensure currentUser and its ID are valid before Supabase operations
                if (!currentUser || !currentUser.id) {
                    console.error("Cannot save assessment: Critical user data (including ID) is missing from localStorage.");
                    alert("Your session seems invalid. Please log out and log back in to continue.");
                    logout(); // Force logout
                    // No need to re-enable button as we are logging out
                    return;
                }

                // 1. Prepare data for the 'assessments' table
                // Ensure these 'question_id' values match your potential analysis needs
                // Ensure 'question_text' captures the question asked
                const answersToInsert = [
                    {
                        user_id: currentUser.id,
                        user_email: currentUser.email,
                        question_id: q1Textarea.name, // 'coaching_meaning'
                        question_text: document.querySelector('label[for="q1_coaching_meaning"]')?.textContent || 'What does coaching mean to you?',
                        answer: q1Textarea.value.trim(),
                        page: 'pre_course_assessment',
                        type: 'textarea',
                        // submitted_at: new Date() // Supabase can handle timestamp with default value CURRENT_TIMESTAMP
                    },
                    {
                        user_id: currentUser.id,
                        user_email: currentUser.email,
                        question_id: selectedRandomQuestion.id, // e.g., 'q_leadership_vs_management'
                        question_text: selectedRandomQuestion.label,
                        answer: qRandomTextarea.value.trim(),
                        page: 'pre_course_assessment',
                        type: 'textarea'
                    },
                    {
                        user_id: currentUser.id,
                        user_email: currentUser.email,
                        question_id: q3Textarea.name, // 'expectations'
                        question_text: document.querySelector('label[for="q3_expectations"]')?.textContent || 'What are your expectations from this course?',
                        answer: q3Textarea.value.trim(),
                        page: 'pre_course_assessment',
                        type: 'textarea'
                    },
                    {
                        user_id: currentUser.id,
                        user_email: currentUser.email,
                        question_id: q4Rating.name, // 'confidence_rating'
                        question_text: document.querySelector('label[for="q4_confidence_rating"]')?.textContent || 'Rate your current coaching confidence (1=Low, 5=High)',
                        answer: ratingVal.toString(), // Store number as string, adjust if column type is numeric
                        page: 'pre_course_assessment',
                        type: 'number'
                    },
                    {
                        user_id: currentUser.id,
                        user_email: currentUser.email,
                        question_id: q4Explanation.name, // 'confidence_explanation'
                        question_text: document.querySelector('label[for="q4_confidence_explanation"]')?.textContent || 'Briefly explain your rating:',
                        answer: q4Explanation.value.trim(),
                        page: 'pre_course_assessment',
                        type: 'textarea'
                    }
                ];

                try {
                    // 2. Insert answers into 'assessments' table
                    console.log("Inserting answers:", answersToInsert);
                    const { error: insertError } = await supabase
                        .from('assessments')
                        .insert(answersToInsert);

                    if (insertError) {
                        console.error("Supabase insert error:", insertError);
                        throw new Error(`Failed to save answers: ${insertError.message}`); // Throw specific error
                    }
                    console.log("Answers successfully inserted into Supabase 'assessments' table.");

                    // 3. Update 'assessment_completed' status in 'users' table
                    console.log(`Updating user ${currentUser.id} assessment status...`);
                    const { error: updateError } = await supabase
                        .from('users')
                        .update({ assessment_completed: true }) // Column name from your 'users' table image
                        .eq('id', currentUser.id); // Match the user ID

                    if (updateError) {
                        // Log warning but proceed, as answers were saved. Consider if this needs stricter handling.
                        console.warn(`Could not update user assessment status in Supabase for user ${currentUser.id}:`, updateError);
                        // Optionally alert the user about partial success?
                        // alert("Your answers were saved, but there was an issue updating your completion status. Please contact support if problems persist.");
                    } else {
                         console.log("User status updated successfully in Supabase 'users' table.");
                    }

                    // --- (Optional) Add entry to user_progress ---
                    // Uncomment and adapt if you want to log this as a progress step
                    /*
                    console.log("Logging completion to user_progress...");
                    const { error: progressError } = await supabase
                        .from('user_progress') // Correct table name from your image
                        .insert({
                            user_id: currentUser.id,
                            section_id: 'assessment_precourse', // Unique ID for this assessment
                            section_title: 'Pre-Course Assessment',
                            status: 'completed',
                            progress_percentage: 100, // Mark as 100% done
                            page: 'assessment.html', // Page identifier
                            section_type: 'assessment' // Type identifier
                            // score: null, // No score for this type?
                            // submitted_at: new Date() // Or rely on default timestamp
                        });

                     if (progressError) {
                         console.warn("Could not log assessment completion in user_progress:", progressError);
                         // Don't block the user for this optional logging
                     } else {
                         console.log("Assessment completion logged in user_progress.");
                     }
                    */

                    // 4. Update localStorage AFTER successful Supabase operations
                    currentUser.assessmentCompleted = true;
                    // Decide if you still need to store answers in localStorage
                    // For simplicity now, we keep it. Remove if Supabase is the only source needed.
                    currentUser.assessmentAnswers = {
                        [q1Textarea.name]: q1Textarea.value.trim(),
                        [qRandomTextarea.name]: qRandomTextarea.value.trim(),
                        [q3Textarea.name]: q3Textarea.value.trim(),
                        [q4Rating.name]: ratingVal,
                        [q4Explanation.name]: q4Explanation.value.trim()
                    };
                    saveCurrentUser(currentUser); // Save updated status and answers locally

                    // 5. Show success popup
                    document.getElementById('assessmentSuccessPopup').style.display = 'block';
                    document.getElementById('popupOverlay').style.display = 'block';
                    // Button remains disabled, user clicks popup button to proceed

                } catch (error) {
                    console.error("Error during Supabase save process:", error);
                    alert(`An error occurred while saving your assessment: ${error.message}. Please check your connection and try again.`);
                    submitButton.disabled = false; // Re-enable button on Supabase error
                    submitButton.textContent = 'Submit Assessment';
                }

            } else {
                console.log("Assessment form is invalid.");
                submitButton.disabled = false; // Re-enable button if validation fails
                submitButton.textContent = 'Submit Assessment';
                 // Scroll to the first error for better UX
                 const firstError = form.querySelector('.invalid');
                 if (firstError) {
                     firstError.focus();
                     firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                 }
            }
        }


        function logout() {
            console.log("Logging out user from Assessment page...");
            try {
                // Optionally clear Supabase session if using auth helpers, but simple localStorage clear is primary here
                // supabase?.auth.signOut(); // Uncomment if using Supabase auth helpers extensively
                localStorage.removeItem(LOGGED_IN_KEY);
                localStorage.removeItem(CURRENT_USER_KEY);
                IS_ADMIN_USER = false; // Reset global flag
                console.log("Local storage cleared for logout.");
                // Redirect to login page, do not add assessment page to history
                window.location.replace('login.html');
            } catch (e) {
                console.error("Error during logout:", e);
                // Fallback redirect
                window.location.replace('login.html');
            }
        }
    </script>
</body>
</html>
