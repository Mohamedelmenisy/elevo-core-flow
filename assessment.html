
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pre-Course Assessment - Coaching & Leadership</title>
  <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f8fafc; margin: 0; padding: 0; }
    header { background: linear-gradient(90deg, #2c3e50, #34495e); color: white; text-align: center; padding: 20px; font-size: 24px; }
    main { padding: 20px; max-width: 800px; margin: auto; background: white; margin-top: 20px; border-radius: 8px; }
    textarea, input[type="number"] { width: 100%; margin-top: 10px; margin-bottom: 20px; padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
    button { background: #10b981; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
    button:hover { background: #059669; }
    #progressBarContainer { background: #e5e7eb; border-radius: 8px; overflow: hidden; height: 24px; margin-bottom: 20px; }
    #progressBar { background: linear-gradient(90deg, #3b82f6, #60a5fa); width: 0%; height: 100%; transition: width 0.5s ease-in-out; text-align: center; color: white; font-weight: bold; line-height: 24px; font-size: 14px; animation: pulse 2s infinite ease-in-out alternate; }
    @keyframes pulse { from { opacity: 0.8; } to { opacity: 1; } }
    #loadingMessage, #completionMessage, #successMessage, #errorMessage { text-align: center; margin-top: 20px; font-size: 20px; font-weight: bold; display: none; }
    #completionMessage { color: #16a34a; }
    #successMessage { color: #3b82f6; }
    #errorMessage { color: #ef4444; }
  </style>
</head>
<body>
<header>Coaching & Leadership Assessment</header>
<main>
  <div id="progressBarContainer">
    <div id="progressBar">0%</div>
  </div>
  <form id="assessmentForm">
    <label for="q1_coaching_meaning">What does coaching mean to you?</label>
    <textarea id="q1_coaching_meaning" required></textarea>

    <label for="q_random">Random Question</label>
    <textarea id="q_random" required></textarea>

    <label for="q3_expectations">What are your expectations from this course?</label>
    <textarea id="q3_expectations" required></textarea>

    <label for="q4_confidence_rating">Rate your current coaching confidence (1-5)</label>
    <input type="number" id="q4_confidence_rating" min="1" max="5" required>

    <label for="q4_confidence_explanation">Explain your rating</label>
    <textarea id="q4_confidence_explanation" required></textarea>

    <button type="submit">Submit Assessment</button>
  </form>
  <div id="loadingMessage">Saving your answers, please wait...</div>
  <div id="successMessage">🎯 Well done! Your answers have been saved successfully! 🎯<br>Submission is now closed ✅</div>
  <div id="completionMessage">🎉 You completed 100% of the assessment! 🎉</div>
  <div id="errorMessage">🚨 An error occurred while saving your answers. Please try again 🚨</div>
</main>

<script>
const supabaseUrl = 'https://lgcutmuspcaralydycmg.supabase.co';
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // (مخفي هنا للأمان)
const supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);

const currentUser = JSON.parse(localStorage.getItem('currentUser')) || { id: Math.random().toString(36).substring(2), email: 'test@example.com' };

const fields = ['q1_coaching_meaning', 'q_random', 'q3_expectations', 'q4_confidence_rating', 'q4_confidence_explanation'];

function updateProgressBar() {
  const answered = fields.filter(id => document.getElementById(id).value.trim() !== '').length;
  const percentage = Math.round((answered / fields.length) * 100);
  const progressBar = document.getElementById('progressBar');
  progressBar.style.width = percentage + '%';
  progressBar.textContent = percentage + '%';

  if (percentage === 100) {
    document.getElementById('completionMessage').style.display = 'block';
  } else {
    document.getElementById('completionMessage').style.display = 'none';
  }
}

fields.forEach(id => {
  document.getElementById(id).addEventListener('input', updateProgressBar);
});

async function saveAssessment(answers) {
  const insertData = Object.entries(answers).map(([key, value]) => ({
    user_id: currentUser.id,
    user_email: currentUser.email,
    question_id: key,
    answer: value,
    submitted_at: new Date(),
    created_at: new Date(),
    page: 'assessment.html',
    type: 'pre_course',
    completion_status: 'completed'
  }));

  const { error } = await supabase.from('assessments').insert(insertData);
  if (error) throw error;
}

async function saveProgress() {
  const { error } = await supabase.from('user_progress').upsert([{
    user_id: currentUser.id,
    section_type: 'assessment',
    section_id: 'pre_course',
    section_title: 'Pre-Course Assessment',
    page: 'assessment.html',
    progress: 100,
    progress_percentage: 100,
    status: 'completed',
    submitted_at: new Date(),
    updated_at: new Date()
  }], { onConflict: ['user_id', 'section_id'] });
  if (error) throw error;
}

let formSubmitted = false;

document.getElementById('assessmentForm').addEventListener('submit', async function(event) {
  event.preventDefault();
  if (formSubmitted) return;
  formSubmitted = true;

  document.getElementById('assessmentForm').style.display = 'none';
  document.getElementById('loadingMessage').style.display = 'block';

  const answers = {
    q1_coaching_meaning: document.getElementById('q1_coaching_meaning').value,
    q_random: document.getElementById('q_random').value,
    q3_expectations: document.getElementById('q3_expectations').value,
    q4_confidence_rating: document.getElementById('q4_confidence_rating').value,
    q4_confidence_explanation: document.getElementById('q4_confidence_explanation').value
  };

  try {
    await saveAssessment(answers);
    await saveProgress();
    document.getElementById('loadingMessage').style.display = 'none';
    document.getElementById('successMessage').style.display = 'block';
  } catch (error) {
    console.error('Save error:', error);
    document.getElementById('loadingMessage').style.display = 'none';
    document.getElementById('errorMessage').style.display = 'block';
  }
});
</script>
</body>
</html>
