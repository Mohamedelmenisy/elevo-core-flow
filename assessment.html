<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-Course Assessment - Coaching & Leadership</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <style>
        /* --- Base Styles (Enhanced) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f8fafc; margin: 0; padding: 0; line-height: 1.6; color: #374151; display: flex; flex-direction: column; min-height: 100vh; }
        main { flex-grow: 1; display: flex; justify-content: center; align-items: flex-start; flex-direction: column; width: 100%; max-width: 1000px; margin: 20px auto; padding: 0 20px; /* Adjusted padding */ }
        .header { background: linear-gradient(90deg, #2c3e50, #34495e); color: white; padding: 18px 0; text-align: center; font-size: 26px; font-weight: 600; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); width: 100%; border-bottom: 3px solid #3498db; }
        .user-bar { background-color: #ffffff; padding: 12px 30px; display: flex; justify-content: space-between; align-items: center; color: #4b5563; font-size: 15px; width: 100%; border-bottom: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-info svg { color: #3498db; opacity: 1; }
        .user-details-bar { display: flex; flex-direction: column; }
        .user-name-bar { font-weight: 600; font-size: 16px; color: #1f2937; }
        .user-email-bar { font-size: 13px; opacity: 0.8; color: #6b7280; }
        .logout-button { background-color: #ef4444; color: white; border: none; padding: 9px 18px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; }
        .logout-button:hover { background-color: #dc2626; box-shadow: 0 2px 5px rgba(239, 68, 68, 0.3); transform: translateY(-1px); }
        .logout-button:active { transform: translateY(0); }
        .footer { text-align: center; padding: 25px 30px; background: #f9fafb; color: #6b7280; margin-top: auto; font-size: 14px; width: 100%; border-top: 1px solid #e5e7eb; }

        /* --- Assessment Container Styles --- */
        #assessmentSection {
            background: white;
            padding: 35px 45px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            width: 100%;
            margin-bottom: 35px;
            text-align: left;
            opacity: 0; /* Initially hidden for fade-in */
            transition: opacity 0.7s ease-in-out;
            border: 1px solid #e5e7eb;
        }
        #assessmentSection.fade-in { opacity: 1; }
        #assessmentSection h2 {
            color: #1f2937;
            margin-bottom: 25px;
            font-size: 28px;
            font-weight: 600;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 15px;
        }

        /* --- Pre-Course Assessment Styles --- */
        #assessmentSection .intro-note {
            background-color: #eff6ff; /* Light blue */
            border-left: 5px solid #3b82f6;
            padding: 18px 25px;
            margin-bottom: 30px;
            border-radius: 6px;
            font-size: 16px;
            color: #374151;
            line-height: 1.7;
        }
        #assessmentForm .form-group { margin-bottom: 30px; }
        #assessmentForm label { display: block; margin-bottom: 10px; font-weight: 600; color: #374151; font-size: 17px; }
        #assessmentForm textarea, #assessmentForm input[type="number"], #assessmentForm select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
            color: #1f2937;
        }
        #assessmentForm textarea { min-height: 120px; resize: vertical; }
        #assessmentForm textarea:focus, #assessmentForm input[type="number"]:focus, #assessmentForm select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
            outline: none;
        }
        #assessmentForm .input-meta-info { display: flex; justify-content: space-between; align-items: center; margin-top: 6px; }
        #assessmentForm .word-count-info { font-size: 13px; color: #6b7280; }
        #assessmentForm .paste-warning { font-size: 13px; color: #f97316; display: none; }
        #assessmentForm .error-message { color: #ef4444; font-size: 14px; margin-top: 8px; display: none; font-weight: 500;}
        #assessmentForm input.invalid, #assessmentForm textarea.invalid { border-color: #ef4444; }
        #assessmentSubmitBtn {
            background-color: #10b981; /* Emerald green */
            color: white;
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
        }
        #assessmentSubmitBtn:hover { background-color: #059669; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2); }
        #assessmentSubmitBtn:disabled { background-color: #9ca3af; cursor: not-allowed; transform: none; box-shadow: none;}

        /* Success Popup */
        #assessmentSuccessPopup {
            display: none; position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%);
            background-color: white; padding: 45px 50px; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); z-index: 1000; text-align: center;
            border-top: 6px solid #10b981; min-width: 350px;
        }
         #assessmentSuccessPopup p { font-size: 19px; color: #374151; margin-bottom: 30px; line-height: 1.6; }
         #assessmentSuccessPopup button {
            background-color: #3b82f6; color: white; padding: 12px 25px; border: none;
            border-radius: 6px; cursor: pointer; font-size: 17px; transition: background-color 0.3s; font-weight: 500;
         }
         #assessmentSuccessPopup button:hover { background-color: #2563eb; }
         .popup-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 999; }

         /* Loading Message */
         #loadingMessage { text-align: center; padding: 60px 20px; font-size: 20px; color: #6b7280; width: 100%; }

         /* Responsive Adjustments */
         @media (max-width: 768px) {
             main { padding: 0 15px; margin: 15px auto; }
             #assessmentSection { padding: 25px 30px; }
             .header { font-size: 22px; padding: 15px 0; }
             .user-bar { padding: 10px 20px; }
         }
         @media (max-width: 600px) {
             #assessmentSection { padding: 20px; }
             #assessmentSuccessPopup { width: 90%; padding: 30px 25px; }
             #assessmentForm textarea { min-height: 100px; }
             #assessmentForm label { font-size: 16px; }
             #assessmentForm input[type="number"], #assessmentForm textarea, #assessmentForm select { padding: 12px 14px; font-size: 15px; }
             #assessmentSubmitBtn { padding: 12px 25px; font-size: 16px; }
         }
    </style>

<style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: #f9fafb;
  margin: 0;
  padding: 0;
}
.container {
  max-width: 800px;
  margin: 40px auto;
  padding: 30px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.05);
}
h1, h2 {
  color: #1f2937;
  text-align: center;
}
form {
  display: flex;
  flex-direction: column;
  gap: 20px;
}
textarea, input[type="text"], select {
  width: 100%;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  font-size: 16px;
}
button {
  background: #4f46e5;
  color: white;
  padding: 12px;
  font-size: 16px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}
button:hover {
  background: #4338ca;
}
</style>

</head>
<body>
    <!-- Header -->
    <header class="header">Coaching & Leadership Dashboard</header>

    <!-- User Bar -->
    <div class="user-bar">
        <div class="user-info">
             <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path> <circle cx="12" cy="7" r="4"></circle> </svg>
            <div class="user-details-bar">
                <span class="user-name-bar" id="userNameBar">Loading...</span>
                <span class="user-email-bar" id="userEmailBar"></span>
            </div>
        </div>
        <button class="logout-button" onclick="logout()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path> <polyline points="16 17 21 12 16 7"></polyline> <line x1="21" y1="12" x2="9" y2="12"></line> </svg>
            Logout
        </button>
    </div>

    <!-- Main Content Area -->
    <main>
        <div id="loadingMessage">Loading Assessment...</div>

        <!-- Pre-Course Assessment Section -->
        <section id="assessmentSection" style="display: none;"> <!-- Initially hidden until logic runs -->
            <h2>Pre-Course Assessment</h2>
            <p class="intro-note">
                <strong>Welcome!</strong> Before you begin the course modules, please take a moment to answer these questions. Your answer help us personalize your experience. Please answer honestly in your own words. <span id="adminAssessmentNote" style="display: none; font-weight: bold; color: #b45309;"> (Admin: Word count and paste restrictions are disabled for your account.)</span>
            </p>
            
<!-- Progress Bar -->
<div class="mb-4" style="width: 100%; margin-top: 20px;">
    <label style="font-weight: bold; margin-bottom: 8px; display: block;">Progress</label>
    <div style="background-color: #e5e7eb; border-radius: 8px; overflow: hidden; height: 20px;">
        <div id="progressBar" style="width: 0%; background-color: #3b82f6; height: 100%; transition: width 0.5s;"></div>
    </div>
</div>

<form id="assessmentForm" novalidate>
                 <!-- Question 1 -->
                <div class="form-group">
                    <label for="q1_coaching_meaning">What does coaching mean to you?</label>
                    <textarea id="q1_coaching_meaning" name="coaching_meaning" required data-min-words="20" placeholder="Describe your understanding of coaching..."></textarea>
<button type="button" class="btn btn-success mt-2 save-answer" data-question-id="q1_coaching_meaning">Save Answer</button>
                    <div class="input-meta-info">
                        <div class="paste-warning" id="q1_paste_warning">Pasting content is discouraged. Please use your own words.</div>
                        <div class="word-count-info" id="q1_word_count_container">Words: <span id="q1_word_count">0</span>/20</div>
                    </div>
                    <div class="error-message" id="q1_error"></div>
                </div>

                <!-- Question 2 (Randomized) -->
                 <div class="form-group" id="randomQuestionContainer">
                     <!-- Label and Input will be inserted here by JS -->
                     <div class="input-meta-info">
                         <div class="paste-warning" id="q_random_paste_warning">Pasting content is discouraged. Please use your own words.</div>
                         <div class="word-count-info" id="q_random_word_count_container">Words: <span id="q_random_word_count">0</span>/<span id="q_random_min_words_display">?</span></div>
                     </div>
                     <div class="error-message" id="q_random_error"></div>
                 </div>

                <!-- Question 3 -->
                <div class="form-group">
                    <label for="q3_expectations">What are your expectations from this course?</label>
                    <textarea id="q3_expectations" name="expectations" required data-min-words="15" placeholder="What do you hope to learn or achieve?"></textarea>
<button type="button" class="btn btn-success mt-2 save-answer" data-question-id="q3_expectations">Save Answer</button>
                     <div class="input-meta-info">
                         <div class="paste-warning" id="q3_paste_warning">Pasting content is discouraged. Please use your own words.</div>
                         <div class="word-count-info" id="q3_word_count_container">Words: <span id="q3_word_count">0</span>/15</div>
                     </div>
                    <div class="error-message" id="q3_error"></div>
                </div>

                <!-- Question 4 -->
                 <div class="form-group">
                    <label for="q4_confidence_rating">Rate your current coaching confidence (1=Low, 5=High)</label>
                    <input type="number" id="q4_confidence_rating" name="confidence_rating" required min="1" max="5" step="1" placeholder="Enter a number between 1 and 5">
<button type="button" class="btn btn-success mt-2 save-answer" data-question-id="q4_confidence_rating">Save Answer</button>
                    <div class="error-message" id="q4_rating_error"></div>

                    <label for="q4_confidence_explanation" style="margin-top: 15px;">Briefly explain your rating:</label>
                    <textarea id="q4_confidence_explanation" name="confidence_explanation" required data-min-words="10" placeholder="Why did you choose this rating?"></textarea>
<button type="button" class="btn btn-success mt-2 save-answer" data-question-id="q4_confidence_explanation">Save Answer</button>
                     <div class="input-meta-info">
                         <div class="paste-warning" id="q4_exp_paste_warning">Pasting content is discouraged. Please use your own words.</div>
                         <div class="word-count-info" id="q4_exp_word_count_container">Words: <span id="q4_exp_word_count">0</span>/10</div>
                     </div>
                    <div class="error-message" id="q4_exp_error"></div>
                </div>

                <button type="submit" id="assessmentSubmitBtn">Submit Assessment</button>
            </form>
        </section>

         <!-- Success Popup -->
         <div class="popup-overlay" id="popupOverlay"></div>
         <div id="assessmentSuccessPopup">
             <p>Thank you! Your answer have been saved. You can now start your journey!</p>
             <button id="startJourneyBtn">Start Course</button>
         </div>

    </main>

    <!-- Footer -->
    <footer class="footer">
        © 2025 Elmenisy Leadership Coaching - All Rights Reserved
    </footer>

    <script>
        // --- Constants ---
        const LOGGED_IN_KEY = 'isUserLoggedIn';
        const CURRENT_USER_KEY = 'currentUser';
        const SIGNUP_FLAG_KEY = 'hasSignedUpBefore';
        const ADMIN_EMAIL = 'm.elsayed@thechefz.co'; // Case-insensitive comparison
        const DASHBOARD_URL = 'dashboard.html'; // URL for the main dashboard (lowercase)

        // Assessment Question Pool
        const randomQuestionPool = [
            { id: 'q_leadership_vs_management', label: 'How do you differentiate leadership from management?', minWords: 20 },
            { id: 'q_coaching_challenge', label: 'What do you see as the biggest challenge in coaching others?', minWords: 20 },
            { id: 'q_leadership_style', label: 'Briefly describe your ideal leadership style.', minWords: 15 }
        ];
        let selectedRandomQuestion = null; // Will hold the chosen question object

        // --- Global variable for admin status ---
        let IS_ADMIN_USER = false;

        // ***** ---> IMMEDIATE REDIRECTION LOGIC (Checks if user should be here) <--- *****
        console.log("%cAssessment Page: Running IMMEDIATE redirection check...", "color: purple; font-weight: bold;");
        function quickCheckCurrentUserFormat() {
            const data = localStorage.getItem(CURRENT_USER_KEY);
            // Basic check for non-empty, JSON-like string
            return data && data.length > 2 && data.startsWith('{') && data.endsWith('}');
        }
        const isLoggedIn_immediate = localStorage.getItem(LOGGED_IN_KEY) === 'true' && quickCheckCurrentUserFormat();
        const hasSignedUp_immediate = localStorage.getItem(SIGNUP_FLAG_KEY) === 'true';

        if (!isLoggedIn_immediate) {
            // If not logged in or data format is wrong, redirect to login or signup
            const targetUrl = hasSignedUp_immediate ? 'login.html' : 'signup.html';
            console.error(`%cAssessment Page IMMEDIATE Redirect: Not logged in or user data invalid. Redirecting to ${targetUrl}...`, "color: orange;");
            // Include current page as redirect parameter for login page to handle
            window.location.replace(`${targetUrl}?redirect=${encodeURIComponent(window.location.pathname + window.location.search)}`);
            throw new Error("Redirecting user: Not logged in or invalid user data."); // Stop script execution
        } else {
            console.log("%cAssessment Page IMMEDIATE Check: User IS logged in and data format seems ok. Proceeding.", "color: green;");
        }
        // ***** ---> END IMMEDIATE REDIRECTION LOGIC <--- *****


        document.addEventListener('DOMContentLoaded', function() {
            console.log("Assessment page DOM loaded.");

            // --- Element References ---
            const loadingMessage = document.getElementById('loadingMessage');
            const assessmentSection = document.getElementById('assessmentSection');
            const assessmentForm = document.getElementById('assessmentForm');
            const assessmentSuccessPopup = document.getElementById('assessmentSuccessPopup');
            const popupOverlay = document.getElementById('popupOverlay');
            const startJourneyBtn = document.getElementById('startJourneyBtn');

             // --- DOMContentLoaded User Check (Failsafe) ---
            const currentUser = getCurrentUser();
            if (!currentUser) {
                // This handles cases where immediate check passed but parsing/validation inside getCurrentUser failed
                console.error("Assessment DOMContentLoaded: Critical - User data missing or invalid after initial load! Forcing logout.");
                logout(); // Force logout and redirect to login
                return; // Stop further execution
            }
            // --- End Failsafe Check ---

            console.log("Current User Data (Assessment - DOMContentLoaded):", currentUser);

            // Determine if the current user is the admin
            IS_ADMIN_USER = currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
            console.log(`User is admin: ${IS_ADMIN_USER}`);

            // Populate user info in the top bar immediately
            populateTopBar(currentUser);

            // --- Assessment Completion Check ---
            // ✅ MODIFICATION START: Restructured this block based on user request for clarity.
            // It checks if the assessment is NOT completed first, and only shows the form in that case.
            // Otherwise, it redirects. This reinforces the protection against premature redirection.
            if (!currentUser.assessmentCompleted) {
                // Display the form ONLY if not completed
                console.log("Assessment not completed according to user data. Setting up and displaying assessment form.");
                setupAssessmentForm(); // Setup the form content and validation
                loadingMessage.style.display = 'none'; // Hide loading message
                assessmentSection.style.display = 'block'; // Show assessment section
                setTimeout(() => assessmentSection.classList.add('fade-in'), 50); // Apply fade-in effect
            } else {
                // Redirect ONLY if already completed
                console.log("Assessment already completed according to user data. Redirecting to Dashboard.");
                window.location.replace(DASHBOARD_URL); // Use replace to avoid adding Assessment page to history
            }
            // ✅ MODIFICATION END

             // Attach listener for the success popup button (after successful submission)
             startJourneyBtn.addEventListener('click', () => {
                 console.log("Start Journey button clicked. Redirecting to Dashboard.");
                 window.location.href = DASHBOARD_URL; // Redirect to the main dashboard page (uses constant)
             });
        });

        // --- Helper Functions ---

        function getCurrentUser() {
            // Retrieves and validates user data from localStorage
            try {
                const userData = localStorage.getItem(CURRENT_USER_KEY);
                if (!userData) {
                    console.warn("getCurrentUser: No current user data found in localStorage.");
                    return null;
                }
                const parsedUser = JSON.parse(userData);

                // Validate essential properties
                if (parsedUser && typeof parsedUser === 'object' && parsedUser.name && parsedUser.email) {
                    // Initialize missing optional properties if necessary
                     if (parsedUser.assessmentCompleted === undefined) {
                         console.log("getCurrentUser: Initializing assessmentCompleted to false."); // Log initialization
                         parsedUser.assessmentCompleted = false;
                     }
                     if (typeof parsedUser.assessmentAnswers !== 'object' || parsedUser.assessmentAnswers === null) {
                         parsedUser.assessmentAnswers = {};
                     }
                     if (typeof parsedUser.progress !== 'object' || parsedUser.progress === null) {
                         parsedUser.progress = {};
                     }
                    return parsedUser; // Return the valid (and potentially initialized) user object
                } else {
                    console.error("getCurrentUser: Parsed user data is invalid or missing essential properties (name, email).", parsedUser);
                    return null; // Indicate invalid data
                }
            } catch (error) {
                console.error("Error parsing current user data from localStorage:", error);
                return null; // Indicate parsing failure
            }
        }

        function saveCurrentUser(userObject) {
            // Saves the user object to localStorage after validation
             try {
                 // Basic validation before saving
                 if (!userObject || typeof userObject !== 'object' || !userObject.email || !userObject.name) {
                     throw new Error("Attempted to save invalid user object.");
                 }
                 localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(userObject));
                 console.log("Saved user data to localStorage:", userObject); // Log saved data for debugging
             } catch (error) {
                 console.error("Error saving current user data:", error);
             }
        }

        function populateTopBar(user) {
            // Populates user info in the header bar
            const userNameBar = document.getElementById('userNameBar');
            const userEmailBar = document.getElementById('userEmailBar');
            if (userNameBar && user?.name) userNameBar.textContent = user.name;
            if (userEmailBar && user?.email) userEmailBar.textContent = user.email;
        }

        function setupAssessmentForm() {
            // Sets up the dynamic parts of the assessment form (random question, admin notes, validation)
             const form = document.getElementById('assessmentForm');
             const q1Textarea = document.getElementById('q1_coaching_meaning');
             const q3Textarea = document.getElementById('q3_expectations');
             const q4Rating = document.getElementById('q4_confidence_rating');
             const q4Explanation = document.getElementById('q4_confidence_explanation');
             const randomQuestionContainer = document.getElementById('randomQuestionContainer');
             const adminNoteSpan = document.getElementById('adminAssessmentNote');

             // Show admin-specific notes and adjust placeholders
             if (IS_ADMIN_USER && adminNoteSpan) {
                adminNoteSpan.style.display = 'inline';
                q1Textarea.placeholder = "Admin: No word count required.";
                q3Textarea.placeholder = "Admin: No word count required.";
                q4Explanation.placeholder = "Admin: No word count required.";
             } else {
                 // Ensure placeholders show requirements for non-admins
                const q1MinWords = q1Textarea.getAttribute('data-min-words') || '20';
                const q3MinWords = q3Textarea.getAttribute('data-min-words') || '15';
                const q4ExpMinWords = q4Explanation.getAttribute('data-min-words') || '10';
                q1Textarea.placeholder = `Describe your understanding of coaching... (min ${q1MinWords} words)`;
                q3Textarea.placeholder = `What do you hope to learn or achieve? (min ${q3MinWords} words)`;
                q4Explanation.placeholder = `Why did you choose this rating? (min ${q4ExpMinWords} words)`;
             }

             // Select and Inject Random Question
             selectedRandomQuestion = randomQuestionPool[Math.floor(Math.random() * randomQuestionPool.length)];
             const randomPlaceholder = IS_ADMIN_USER ? "Admin: No word count required." : `Please provide your thoughts... (min ${selectedRandomQuestion.minWords} words)`;
             // Display min words next to count only for non-admins
             const randomMinWordsDisplay = IS_ADMIN_USER ? '?' : selectedRandomQuestion.minWords;
             const randomWordCountDenominator = IS_ADMIN_USER ? '' : `/${selectedRandomQuestion.minWords}`;


             randomQuestionContainer.innerHTML = `
                 <label for="${selectedRandomQuestion.id}">${selectedRandomQuestion.label}</label>
                 <textarea id="${selectedRandomQuestion.id}" name="${selectedRandomQuestion.id}" required data-min-words="${selectedRandomQuestion.minWords}" placeholder="${randomPlaceholder}"></textarea>
<button type="button" class="btn btn-success mt-2 save-answer" data-question-id="${selectedRandomQuestion.id}">Save Answer</button>
                 <div class="input-meta-info">
                     <div class="paste-warning" id="${selectedRandomQuestion.id}_paste_warning">Pasting content is discouraged. Please use your own words.</div>
                     <div class="word-count-info" id="${selectedRandomQuestion.id}_word_count_container">Words: <span id="${selectedRandomQuestion.id}_word_count">0</span>${randomWordCountDenominator}</div>
                 </div>
                 <div class="error-message" id="${selectedRandomQuestion.id}_error"></div>
             `;
             // Update the separate span for min words (if needed elsewhere, though now part of label)
             const minWordsSpan = document.getElementById('q_random_min_words_display');
             if(minWordsSpan) minWordsSpan.textContent = randomMinWordsDisplay;

             const qRandomTextarea = document.getElementById(selectedRandomQuestion.id); // Get reference after injection

             // Setup Validation and Paste Prevention (Conditional based on IS_ADMIN_USER)
             // These functions now correctly handle the isAdmin flag internally
             setupWordCountValidation(q1Textarea, document.getElementById('q1_word_count'), document.getElementById('q1_error'), document.getElementById('q1_word_count_container'), IS_ADMIN_USER);
             setupWordCountValidation(qRandomTextarea, document.getElementById(`${selectedRandomQuestion.id}_word_count`), document.getElementById(`${selectedRandomQuestion.id}_error`), document.getElementById(`${selectedRandomQuestion.id}_word_count_container`), IS_ADMIN_USER);
             setupWordCountValidation(q3Textarea, document.getElementById('q3_word_count'), document.getElementById('q3_error'), document.getElementById('q3_word_count_container'), IS_ADMIN_USER);
             setupWordCountValidation(q4Explanation, document.getElementById('q4_exp_word_count'), document.getElementById('q4_exp_error'), document.getElementById('q4_exp_word_count_container'), IS_ADMIN_USER);

             setupPastePrevention(q1Textarea, document.getElementById('q1_paste_warning'), IS_ADMIN_USER);
             setupPastePrevention(qRandomTextarea, document.getElementById(`${selectedRandomQuestion.id}_paste_warning`), IS_ADMIN_USER);
             setupPastePrevention(q3Textarea, document.getElementById('q3_paste_warning'), IS_ADMIN_USER);
             setupPastePrevention(q4Explanation, document.getElementById('q4_exp_paste_warning'), IS_ADMIN_USER);

             // Attach Form Submission Handler
             if (form) {
                 form.addEventListener('submit', handleAssessmentSubmit);
             } else {
                 console.error("Assessment form element not found for attaching submit listener.");
             }
        }

        function countWords(text) {
            // Counts words in a given string
            return text ? text.trim().split(/\s+/).filter(Boolean).length : 0;
        }

       function setupWordCountValidation(textarea, countSpan, errorElement, countContainer, isAdmin) {
             // Sets up real-time word count display and validation, skipping for admin
             if (!textarea || !countSpan || !errorElement || !countContainer) {
                 console.warn("Word count setup missing required elements for:", textarea?.id);
                 return;
             }
             const minWords = parseInt(textarea.getAttribute('data-min-words') || '0', 10);

             if (isAdmin) {
                 countContainer.style.display = 'none'; // Hide word count elements for admin
                 errorElement.style.display = 'none'; // Ensure error is hidden too
                 textarea.classList.remove('invalid'); // Ensure no invalid class
                 return; // No listener needed for admin
             }

             // Add listener for non-admins
             textarea.addEventListener('input', () => {
                 const words = countWords(textarea.value);
                 countSpan.textContent = words;
                 validateWordCount(textarea, minWords, errorElement, isAdmin); // Validate on input
             });
             // Initial check in case field is pre-filled (though unlikely here)
             validateWordCount(textarea, minWords, errorElement, isAdmin);
         }

        function validateWordCount(textarea, minWords, errorElement, isAdmin) {
            // Validates if the word count meets the minimum, returns true/false. Skips for admin.
             if (isAdmin) {
                 if(errorElement) errorElement.style.display = 'none';
                 if(textarea) textarea.classList.remove('invalid');
                 return true; // Always valid for admin regarding word count
             }

             if (!textarea || !errorElement || minWords <= 0) {
                  // Don't validate if elements are missing or no minimum is set
                  if(errorElement) errorElement.style.display = 'none';
                  if(textarea) textarea.classList.remove('invalid');
                  return true;
             }

             const words = countWords(textarea.value);
             const isFieldEmpty = !textarea.value.trim();

             // Show error only if user has typed something but not enough words
             if (!isFieldEmpty && words < minWords) {
                 errorElement.textContent = `Minimum ${minWords} words required.`;
                 errorElement.style.display = 'block';
                 textarea.classList.add('invalid');
                 return false; // Invalid
             } else {
                 // Valid if enough words OR if field is empty (required validation is separate)
                 errorElement.style.display = 'none';
                 textarea.classList.remove('invalid');
                 return true; // Valid
             }
        }

        function setupPastePrevention(textarea, warningElement, isAdmin) {
            // Prevents pasting into textarea for non-admins and shows a warning
            if (!textarea || !warningElement) return;

            if (!isAdmin) {
                textarea.addEventListener('paste', (event) => {
                    event.preventDefault(); // Block the paste
                    warningElement.textContent = 'Pasting is disabled. Please type your answer.';
                    warningElement.style.display = 'block';
                    // Hide warning after a delay
                    setTimeout(() => { warningElement.style.display = 'none'; }, 4000);
                });
            } else {
                // Ensure warning is hidden for admin
                warningElement.style.display = 'none';
            }
        }


        function handleAssessmentSubmit(event) {
            event.preventDefault();
            console.log("Assessment submit triggered.");
            const form = event.target;
            const submitButton = document.getElementById('assessmentSubmitBtn');
             if (!form || !submitButton) {
                 console.error("Form or submit button not found in handleAssessmentSubmit.");
                 return;
             }
            submitButton.disabled = true; // Disable button immediately

            // --- Clear Previous Errors ---
            form.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            form.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));

            // --- Get References to Form Elements ---
            const q1Textarea = document.getElementById('q1_coaching_meaning');
            const qRandomTextarea = document.getElementById(selectedRandomQuestion?.id); // Use optional chaining
            const q3Textarea = document.getElementById('q3_expectations');
            const q4Rating = document.getElementById('q4_confidence_rating');
            const q4Explanation = document.getElementById('q4_confidence_explanation');

            // --- Get References to Error Elements ---
            const q1Error = document.getElementById('q1_error');
            const qRandomError = document.getElementById(`${selectedRandomQuestion?.id}_error`); // Use optional chaining
            const q3Error = document.getElementById('q3_error');
            const q4RatingError = document.getElementById('q4_rating_error');
            const q4ExpError = document.getElementById('q4_exp_error');

            let isValid = true;

            // --- Run Validation Checks ---

            // Helper function to simplify required field validation
            const validateRequired = (element, errorElement, message = 'This field is required.') => {
                 if (!element?.value.trim()) {
                    if (errorElement) {
                        errorElement.textContent = message;
                        errorElement.style.display = 'block';
                    }
                    if (element) element.classList.add('invalid');
                    return false;
                 }
                 return true;
            };

            // Check Required Fields (Apply to all users)
            if (!validateRequired(q1Textarea, q1Error)) isValid = false;
            if (!validateRequired(qRandomTextarea, qRandomError)) isValid = false; // qRandomTextarea might be null if setup failed
            if (!validateRequired(q3Textarea, q3Error)) isValid = false;
            if (!validateRequired(q4Rating, q4RatingError, 'Rating is required.')) isValid = false; // Uses element.value check
            if (!validateRequired(q4Explanation, q4ExpError)) isValid = false;


            // Check Word Count (Only if fields are filled and user is not admin)
            if (q1Textarea?.value.trim() && !validateWordCount(q1Textarea, parseInt(q1Textarea.getAttribute('data-min-words') || '0', 10), q1Error, IS_ADMIN_USER)) { isValid = false; }
            // Add null check for selectedRandomQuestion
            if (qRandomTextarea?.value.trim() && selectedRandomQuestion && !validateWordCount(qRandomTextarea, selectedRandomQuestion.minWords || 0, qRandomError, IS_ADMIN_USER)) { isValid = false; }
            if (q3Textarea?.value.trim() && !validateWordCount(q3Textarea, parseInt(q3Textarea.getAttribute('data-min-words') || '0', 10), q3Error, IS_ADMIN_USER)) { isValid = false; }
            if (q4Explanation?.value.trim() && !validateWordCount(q4Explanation, parseInt(q4Explanation.getAttribute('data-min-words') || '0', 10), q4ExpError, IS_ADMIN_USER)) { isValid = false; }

             // Check Rating Range (Apply to all users, only if a value exists)
             const ratingVal = parseInt(q4Rating?.value, 10);
             if (q4Rating?.value && (isNaN(ratingVal) || ratingVal < 1 || ratingVal > 5)) {
                if (q4RatingError) {
                    q4RatingError.textContent = 'Please enter a valid rating between 1 and 5.';
                    q4RatingError.style.display = 'block';
                }
                 if (q4Rating) q4Rating.classList.add('invalid');
                 isValid = false;
             }

            // --- Process if Valid ---
            if (isValid) {
                console.log("Assessment form is valid. Saving data...");
                const currentUser = getCurrentUser(); // Re-fetch user data to ensure it's current
                if (!currentUser) {
                    console.error("Cannot save assessment, user data lost or invalid before saving.");
                    alert("An error occurred saving your data. Please try logging out and back in.");
                     submitButton.disabled = false; // Re-enable button on error
                    return;
                }

                // Ensure all elements exist before trying to read their values/names
                const answer = {};
                if (q1Textarea) answer[q1Textarea.name] = q1Textarea.value.trim();
                if (qRandomTextarea) answer[qRandomTextarea.name] = qRandomTextarea.value.trim(); // Use name attribute
                if (q3Textarea) answer[q3Textarea.name] = q3Textarea.value.trim();
                if (q4Rating) answer[q4Rating.name] = ratingVal; // Use parsed ratingVal
                if (q4Explanation) answer[q4Explanation.name] = q4Explanation.value.trim();

                // Structure and save answer
                currentUser.assessmentAnswers = answer;
                currentUser.assessmentCompleted = true; // Mark assessment as completed

                saveCurrentUser(currentUser); // Save the updated user object

                // Show success popup
                const successPopup = document.getElementById('assessmentSuccessPopup');
                const overlay = document.getElementById('popupOverlay');
                if (successPopup) successPopup.style.display = 'block';
                if (overlay) overlay.style.display = 'block';
                // Button remains disabled, user clicks 'Start Course' in popup

            } else {
                console.log("Assessment form is invalid. Please review errors.");
                 submitButton.disabled = false; // Re-enable button if validation fails
                 // Scroll to the first element with an error
                 const firstErrorElement = form.querySelector('.invalid');
                 if (firstErrorElement) {
                     firstErrorElement.focus(); // Focus the field
                     // Scroll into view smoothly, centering if possible
                     firstErrorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                 }
            }
        }


        function logout() {
            console.log("Logging out user from Assessment page...");
            try {
                // Clear core session data
                localStorage.removeItem(LOGGED_IN_KEY);
                localStorage.removeItem(CURRENT_USER_KEY);
                // Optionally clear other related data if needed
                // localStorage.removeItem(SIGNUP_FLAG_KEY); // Keep this if you want to remember if they ever signed up
                IS_ADMIN_USER = false; // Reset global flag just in case
                console.log("Local storage cleared for logout.");
                // Redirect to login page using replace to avoid history issues
                window.location.replace('login.html'); // Ensure lowercase
            } catch (e) {
                console.error("Error during logout:", e);
                // Fallback redirect even if clearing fails
                window.location.replace('login.html'); // Ensure lowercase
            }
        }
    </script>




<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
const SUPABASE_URL = 'https://lgcutmuspcaralydycmg.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // ضع المفتاح هنا كاملا
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

document.addEventListener("DOMContentLoaded", async () => {
    const form = document.getElementById("assessmentForm");
    const progressBar = document.getElementById("progressBar");
    const successPopup = document.getElementById("assessmentSuccessPopup");
    const popupOverlay = document.getElementById("popupOverlay");

    let answered = 0;
    const totalQuestions = 5;
    const savedAnswers = {};
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    const userEmail = currentUser.email;

    function updateProgress() {
        const progress = (answered / totalQuestions) * 100;
        progressBar.style.width = `${progress}%`;
    }

    async function saveAnswer(questionId, value) {
        if (!value.trim()) return;
        await supabaseClient.from('assessment_answers').upsert({
            user_email: userEmail,
            question_id: questionId,
            answer: value,
            submitted_at: new Date().toISOString()
        }, { onConflict: ['user_email', 'question_id'] });

        if (!savedAnswers[questionId]) {
            savedAnswers[questionId] = true;
            answered++;
            updateProgress();
        }
    }

    document.querySelectorAll('.save-answer').forEach(button => {
        button.addEventListener('click', async () => {
            const questionId = button.getAttribute('data-question-id');
            const input = document.getElementById(questionId);
            if (input) {
                await saveAnswer(questionId, input.value);
                alert('✅ Answer saved successfully!');
            }
        });
    });

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (answered < totalQuestions) {
            alert('⚠️ Please save all answers before submitting.');
            return;
        }

        await supabaseClient.from('users').update({ assessment_completed: true }).eq('email', userEmail);

        await supabaseClient.from('user_progress').upsert({
            user_email: userEmail,
            section_type: 'assessment',
            section_id: 'pre-course',
            section_title: 'Pre-Course Assessment',
            progress: 100,
            updated_at: new Date().toISOString()
        }, { onConflict: ['user_email', 'section_id'] });

        successPopup.style.display = 'block';
        popupOverlay.style.display = 'block';
        form.reset();
        progressBar.style.width = '0%';
    });
});
</script>

</body>
</html>
