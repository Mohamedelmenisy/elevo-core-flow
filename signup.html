    <script>
        // Initialize Supabase client
        const supabaseUrl = 'https://lgcutmuspcaralydycmg.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnY3V0bXVzcGNhcmFseWR5Y21nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0NDY3MDEsImV4cCI6MjA2MTAyMjcwMX0.3u5Y7pkH2NNnnoGLMWVfAa5b8fq88o1itRYnG1K38tE'; // This is the ANON key
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        document.addEventListener('DOMContentLoaded', function() {
            // --- Constants ---
            const SIGNUP_FLAG_KEY = 'hasSignedUpBefore';

            // --- DOM Elements ---
            const signupForm = document.getElementById('signupForm');
            const nameInput = document.getElementById('name');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const confirmInput = document.getElementById('confirmPassword');
            const termsCheckbox = document.getElementById('terms');
            const submitButton = document.getElementById('submitButton');
            const passwordToggles = document.querySelectorAll('.password-toggle');
            const nameError = document.getElementById('nameError');
            const emailError = document.getElementById('emailError');
            const passwordError = document.getElementById('passwordError');
            const confirmError = document.getElementById('confirmError');
            const termsError = document.getElementById('termsError');
            const signupError = document.getElementById('signupError');
            const signupSuccess = document.getElementById('signupSuccess');
            const passwordStrength = document.getElementById('passwordStrength');

            // --- Utility Functions ---
            function showError(element, message) { if(element){ element.textContent = message; element.style.display = 'block';} }
            function hideError(element) { if(element) element.style.display = 'none'; }
            function updatePasswordStrength(password) {
                 if (!passwordStrength) return;
                 let strength = 0;
                 if (password.length >= 6) strength++;
                 if (password.length >= 8) strength++;
                 if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
                 if (password.match(/\d/)) strength++;
                 if (password.match(/[^a-zA-Z\d]/)) strength++; // Special character

                 passwordStrength.textContent = '';
                 passwordStrength.className = 'password-strength'; // Reset class

                 if (password.length > 0) {
                     if (strength <= 2) { passwordStrength.textContent = 'Weak'; passwordStrength.classList.add('strength-weak'); }
                     else if (strength <= 4) { passwordStrength.textContent = 'Medium'; passwordStrength.classList.add('strength-medium'); }
                     else { passwordStrength.textContent = 'Strong'; passwordStrength.classList.add('strength-strong'); }
                 }
            }
             function togglePasswordVisibility(toggleButton, inputElement) {
                 if (!toggleButton || !inputElement) return;
                 const isPassword = inputElement.type === 'password';
                 inputElement.type = isPassword ? 'text' : 'password';
                 toggleButton.innerHTML = isPassword ?
                     '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>' : // Eye-off icon
                     '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>'; // Eye icon
                 toggleButton.setAttribute('aria-label', isPassword ? 'Hide password' : 'Show password');
             }

            // --- Event Listeners ---
            if(passwordInput) { passwordInput.addEventListener('input', (e) => updatePasswordStrength(e.target.value)); }
            if(confirmInput) { confirmInput.addEventListener('input', () => { if (passwordInput?.value !== confirmInput.value) { showError(confirmError, "Passwords don't match"); } else { hideError(confirmError); } }); }
            passwordToggles.forEach(toggle => {
                 const input = toggle.previousElementSibling; // Input is now before the toggle span
                 if(input && input.tagName === 'INPUT') { // Check if previous element is indeed the input
                     toggle.addEventListener('click', () => togglePasswordVisibility(toggle, input));
                     toggle.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') togglePasswordVisibility(toggle, input); });
                 } else {
                     // Fallback: find input by ID if structure changes slightly
                     const inputId = toggle.closest('.input-group')?.querySelector('input')?.id;
                     const inputElement = document.getElementById(inputId);
                     if(inputElement){
                        toggle.addEventListener('click', () => togglePasswordVisibility(toggle, inputElement));
                        toggle.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') togglePasswordVisibility(toggle, inputElement); });
                     }
                 }
            });

            // --- Form Submit Listener ---
            if(signupForm) {
                signupForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    console.log("Signup form submitted.");

                    // Reset errors/messages
                    [nameError, emailError, passwordError, confirmError, termsError, signupError, signupSuccess].forEach(hideError);
                    if(submitButton) { submitButton.disabled = true; submitButton.textContent = 'Creating Account...'; }

                    // Get values
                    const name = nameInput?.value.trim();
                    const email = emailInput?.value.trim().toLowerCase();
                    const password = passwordInput?.value;
                    const confirmPassword = confirmInput?.value;
                    const termsAgreed = termsCheckbox?.checked;

                    // Validation
                    console.log("Validating input...");
                    let isValid = true;
                    if (!name) { showError(nameError, "Please enter your full name"); isValid = false; }
                    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showError(emailError, "Please enter a valid email address"); isValid = false; }
                    if (!password || password.length < 6) { showError(passwordError, "Password must be at least 6 characters"); isValid = false; }
                    if (password !== confirmPassword) { showError(confirmError, "Passwords don't match"); isValid = false; }
                    if (!termsAgreed) { showError(termsError, "You must agree to the terms"); isValid = false; }
                    console.log(`Input validation result: ${isValid}`);

                    // If validation fails, stop here
                    if (!isValid) {
                        console.log("Form is invalid. Stopping submission.");
                        if(submitButton) { submitButton.disabled = false; submitButton.textContent = 'Create Account'; }
                        const firstError = signupForm.querySelector('.error-message[style*="display: block"]');
                         if (firstError) {
                             const inputId = firstError.id.replace('Error','');
                             const inputElement = document.getElementById(inputId);
                             if(inputElement && typeof inputElement.focus === 'function') inputElement.focus();
                         }
                        return;
                    }

                    try {
                        // Sign up with Supabase Auth
                        console.log("Attempting to sign up with Supabase...");
                        const { data, error } = await supabase.auth.signUp({
                            email: email,
                            password: password,
                            options: {
                                data: {
                                    full_name: name // Pass name here if needed by Supabase Auth triggers/metadata
                                }
                            }
                        });

                        if (error) {
                            console.error("Supabase signup error:", error);
                            showError(signupError, error.message || "Registration failed. Please try again.");
                            if(submitButton) { submitButton.disabled = false; submitButton.textContent = 'Create Account'; }
                            return; // Stop execution if signup failed
                        }

                        // If successful auth signup
                        console.log("Supabase signup successful:", data);

                        // ---- START: Insert user data into 'users' table ----
                        if (data && data.user) { // Check if user object exists in response
                            const userId = data.user.id;
                            console.log(`Attempting to insert user data into 'users' table for ID: ${userId}`);
                            try {
                                const insertResponse = await fetch(`${supabaseUrl}/rest/v1/users`, {
                                    method: 'POST',
                                    headers: {
                                        // Use the ANON key for this direct REST call
                                        // Ensure RLS policies on 'users' table allow inserts by 'anon' or 'authenticated' role
                                        apikey: supabaseKey,
                                        Authorization: `Bearer ${supabaseKey}`,
                                        'Content-Type': 'application/json',
                                        Prefer: 'return=representation', // Optional: returns the inserted row
                                    },
                                    body: JSON.stringify({
                                        id: userId, // The UUID from Supabase Auth
                                        name: name,   // Use the validated 'name' variable
                                        email: email  // Use the validated 'email' variable
                                    }),
                                });

                                if (!insertResponse.ok) {
                                    // Log details if insertion failed, but don't necessarily stop the flow
                                    const errorBody = await insertResponse.text();
                                    console.error(`Failed to insert user data into 'users' table. Status: ${insertResponse.status}. Response: ${errorBody}`);
                                    // Optional: Show a modified success message or a specific error
                                    // showError(signupError, "Account created, but profile save failed. Contact support.");
                                } else {
                                    const insertedData = await insertResponse.json();
                                    console.log("Successfully inserted user data into 'users' table:", insertedData);
                                }
                            } catch (insertError) {
                                console.error("Error occurred during fetch to insert user data:", insertError);
                                // Optional: Handle fetch-specific errors (e.g., network issues)
                            }
                        } else {
                             console.warn("Supabase signup successful, but user data (with ID) was not found in the response. Skipping insert into 'users' table.");
                             // This case might indicate an issue with the signUp response or configuration
                        }
                        // ---- END: Insert user data into 'users' table ----


                        // Set signup flag in localStorage (Continue even if DB insert had issues, as auth succeeded)
                        localStorage.setItem(SIGNUP_FLAG_KEY, 'true');
                        console.log(`Signup Success: Set flag "${SIGNUP_FLAG_KEY}" to true.`);

                        // Show success message
                        if(signupSuccess) signupSuccess.style.display = 'block';
                        console.log("Signup success message displayed.");

                        // Redirect after a delay
                        console.log("Setting timeout for redirect to login.html...");
                        setTimeout(function() {
                            console.log("Executing redirect now!");
                            // Redirect to login page, passing email and a flag
                            window.location.href = 'login.html?email=' + encodeURIComponent(email) + '&signedup=true';
                        }, 1500); // 1.5 seconds delay

                    } catch (err) {
                        // Catch any unexpected errors during the entire process
                        console.error("Unexpected error during signup process:", err);
                        showError(signupError, "An unexpected error occurred. Please try again.");
                        if(submitButton) { submitButton.disabled = false; submitButton.textContent = 'Create Account'; }
                    }
                });
            }

            // --- Modal Handling Logic ---
            const modalTriggers = document.querySelectorAll('[data-modal-target]');
            const closeButtons = document.querySelectorAll('[data-close-modal]');

            modalTriggers.forEach(button => {
                 button.addEventListener('click', function(event) {
                     event.preventDefault(); // Prevent default link behavior
                     const modalId = this.dataset.modalTarget;
                     const modal = document.getElementById(modalId);
                     if (modal) {
                         openModal(modal);
                     }
                 });
             });

            closeButtons.forEach(button => {
                 button.addEventListener('click', function() {
                     const modal = this.closest('.modal');
                     if (modal) {
                         closeModal(modal);
                     }
                 });
             });

             // Close modal if background is clicked
             window.addEventListener('click', function(event) {
                 document.querySelectorAll('.modal').forEach(modal => {
                     if (event.target == modal) {
                         closeModal(modal);
                     }
                 });
             });

            function openModal(modal) {
                 if (modal == null) return;
                 modal.style.display = 'block';
                 document.body.classList.add('modal-open'); // Prevent background scrolling
            }

            function closeModal(modal) {
                 if (modal == null) return;
                 modal.style.display = 'none';
                 document.body.classList.remove('modal-open');
            }

            // --- Auto-focus on first field ---
            if(nameInput) nameInput.focus();

            console.log("Signup page script loaded and initialized.");
        });
    </script>
