<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - Elevo Core System</title>
    <!-- Favicon Links - Updated for Elevo Core System -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2317a2b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M3 12h18M3 6h12M3 18h15'/><path d='M17 9l4 3l-4 3'/></svg>">

    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- CSS (Original CSS from your provided file) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f5f7fa; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; background-image: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%); }
        .signup-container { width: 100%; max-width: 450px; background: #ffffff; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); padding: 40px; animation: fadeIn 0.5s ease-in-out; position: relative; overflow: hidden; }
        .signup-container::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: linear-gradient(90deg, #3498db, #2ecc71); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .logo { text-align: center; margin-bottom: 25px; }
        .logo svg { width: 48px; height: 48px; stroke: #3498db; stroke-width: 1.5; margin-bottom: 10px; display: block; margin-left: auto; margin-right: auto; }
        .logo h2 { color: #2c3e50; font-size: 20px; font-weight: 600; letter-spacing: 0.5px; margin-top: 0; }
        .signup-header { text-align: center; margin-bottom: 30px; margin-top: 0; }
        .signup-header h2 { color: #2c3e50; font-size: 24px; font-weight: 700; margin-bottom: 8px; }
        .signup-header p { color: #7f8c8d; font-size: 15px; }
        .input-group { margin-bottom: 20px; position: relative; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #34495e; font-size: 14px; }
        .input-group .input-icon { position: absolute; top: 45px; left: 15px; transform: translateY(-50%); color: #95a5a6; font-size: 18px; pointer-events: none; }
        .input-group .input-icon svg { width: 18px; height: 18px; vertical-align: middle; }
        .input-group input[type="text"], .input-group input[type="email"], .input-group input[type="password"] { width: 100%; padding: 14px 15px 14px 45px; border: 1px solid #e0e4e7; border-radius: 8px; font-size: 15px; transition: all 0.3s; background-color: #f9fafb; }
        .input-group input[type="password"] { padding-right: 40px; }
        .input-group input:hover:not(:focus) { border-color: #bdc3c7; }
        .input-group input:focus { border-color: #3498db; outline: none; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); background-color: #fff; }
        .password-toggle { position: absolute; top: 45px; right: 15px; transform: translateY(-50%); cursor: pointer; color: #95a5a6; font-size: 18px; user-select: none; }
        .password-toggle:hover { color: #7f8c8d; }
        .password-toggle svg { width: 20px; height: 20px; vertical-align: middle; }
        .signup-button { width: 100%; padding: 14px; background: linear-gradient(90deg, #3498db, #2980b9); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; margin-top: 10px; box-shadow: 0 4px 6px rgba(52, 152, 219, 0.1); }
        .signup-button:hover:not(:disabled) { background: linear-gradient(90deg, #2980b9, #3498db); box-shadow: 0 6px 8px rgba(52, 152, 219, 0.15); transform: translateY(-1px); }
        .signup-button:active:not(:disabled) { transform: translateY(0); }
        .signup-button:disabled { background: #bdc3c7; cursor: not-allowed; box-shadow: none; transform: none; }
        .login-link { text-align: center; margin-top: 25px; font-size: 14px; color: #7f8c8d; }
        .login-link a { color: #3498db; text-decoration: none; margin: 0 5px; transition: color 0.3s; font-weight: 500; }
        .login-link a:hover { color: #2c3e50; text-decoration: underline; }
        .error-message { color: #e74c3c; font-size: 13px; margin-top: 8px; display: none; font-weight: 500; }
        .success-message { color: #27ae60; font-size: 13px; margin-top: 8px; display: none; font-weight: 500; }
        .password-strength { margin-top: 8px; font-size: 13px; color: #7f8c8d; }
        .strength-weak { color: #e74c3c; } .strength-medium { color: #f39c12; } .strength-strong { color: #27ae60; }
        .terms { display: flex; align-items: flex-start; margin-bottom: 15px; font-size: 14px; color: #7f8c8d; }
        .terms input[type="checkbox"] { margin-top: 2px; margin-right: 8px; flex-shrink: 0; }
        .terms label { font-weight: normal; color: #7f8c8d; margin-bottom: 0; font-size: 14px; display: inline; }
        .terms a { color: #3498db; text-decoration: none; cursor: pointer; }
        .terms a:hover { text-decoration: underline; }
        .terms .error-message { margin-top: 5px; margin-left: 25px; }
        .data-privacy-notice { font-size: 12px; color: #95a5a6; text-align: center; margin-top: 15px; margin-bottom: 0; }
        .data-privacy-notice svg { width: 12px; height: 12px; vertical-align: middle; margin-right: 4px; stroke: currentColor; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); animation: fadeInModal 0.3s ease-out; }
        .modal-content { background-color: #fefefe; margin: 10vh auto; padding: 30px 40px; border-radius: 8px; max-width: 800px; max-height: 80vh; overflow-y: auto; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.2); animation: slideInModal 0.3s ease-out; }
        .modal-close { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; line-height: 1; cursor: pointer; transition: color 0.2s; }
        .modal-close:hover, .modal-close:focus { color: #333; text-decoration: none; }
        .modal-content h2 { color: #2c3e50; border-bottom: 1px solid #e0e4e7; padding-bottom: 10px; margin-top: 15px; margin-bottom: 20px; font-size: 22px; }
        .modal-content h1 { text-align: center; color: #2c3e50; font-size: 26px; margin-bottom: 25px; }
        .modal-content p, .modal-content li { margin-bottom: 15px; color: #555; font-size: 15px; line-height: 1.6; }
        .modal-content strong { font-weight: 600; color: #34495e; }
        .modal-content ul { padding-left: 25px; margin-bottom: 15px; }
        .modal-content .modal-date { text-align: right; font-style: italic; color: #7f8c8d; margin-bottom: 20px; font-size: 13px; }
        .modal-content a { color: #3498db; text-decoration: none; }
        .modal-content a:hover { text-decoration: underline; }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInModal { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        body.modal-open { overflow: hidden; }
    </style>
</head>
<body>
    <div class="signup-container">
        <div class="logo">
             <svg class="company-logo" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                <path d="M2 17l10 5 10-5"></path>
                <path d="M2 12l10 5 10-5"></path>
                <line x1="12" y1="22" x2="12" y2="12"></line>
                <line x1="7" y1="14.5" x2="7" y2="9.5"></line>
                <line x1="17" y1="14.5" x2="17" y2="9.5"></line>
             </svg>
           <h2>Elevo Core System</h2>
        </div>
        <div class="signup-header">
            <h2>Create Your Account</h2>
            <p>Access the Elevo Core Flow to streamline operations.</p>
        </div>

        <form id="signupForm" novalidate onsubmit="return false;">
            <div class="input-group">
                <label for="name">Full Name</label>
                <span class="input-icon" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></span>
                <input type="text" id="name" name="name" required placeholder="John Doe" aria-describedby="nameError">
                <div id="nameError" class="error-message">Please enter your full name</div>
            </div>
            <div class="input-group">
                <label for="email">Email Address</label>
                 <span class="input-icon" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></span>
                <input type="email" id="email" name="email" required placeholder="your@email.com" aria-describedby="emailError signupError">
                <div id="emailError" class="error-message">Please enter a valid email address</div>
            </div>
            <div class="input-group">
                <label for="password">Password</label>
                 <span class="input-icon" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg></span>
                <input type="password" id="password" name="password" minlength="6" required placeholder="••••••••" aria-describedby="passwordError passwordStrength">
                <span class="password-toggle" aria-label="Show password" role="button" tabindex="0"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg></span>
                <div class="password-strength" id="passwordStrength"></div>
                <div id="passwordError" class="error-message">Password must be at least 6 characters</div>
            </div>
            <div class="input-group">
                <label for="confirmPassword">Confirm Password</label>
                <span class="input-icon" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg></span>
                <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="••••••••" aria-describedby="confirmError">
                 <span class="password-toggle" aria-label="Show password" role="button" tabindex="0"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg></span>
                <div id="confirmError" class="error-message">Passwords don't match</div>
            </div>
            <div class="terms">
                <input type="checkbox" id="terms" name="terms" required aria-describedby="termsError">
                <div>
                    <label for="terms">I agree to the <a href="#" data-modal-target="termsModal">Terms of Service</a> and <a href="#" data-modal-target="privacyModal">Privacy Policy</a></label>
                    <div id="termsError" class="error-message">You must agree to the terms</div>
                </div>
            </div>

            <p class="data-privacy-notice">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                Your information is kept confidential and secure.
            </p>

            <div id="signupError" class="error-message">An error occurred. Please try again.</div>
            <div id="signupSuccess" class="success-message">Registration successful! Preparing your dashboard...</div>

            <button type="button" class="signup-button" id="submitButton">Create Account</button>
        </form>

        <div class="login-link">
            Already have an account? <a href="login.html">Log in</a>
        </div>
    </div>

    <!-- Modals -->
     <div id="termsModal" class="modal">
         <div class="modal-content">
             <span class="modal-close" data-close-modal>×</span>
             <h1>Terms of Service for Elevo Core System</h1>
             <p class="modal-date">Last updated: May 11, 2025</p>
             <h2>1. Acceptance of Terms</h2>
             <p>By creating an account and using the Elevo Core System ("Service"), operated by [Your Company/Project Name or Your Name] ("us", "we", or "our"), you agree to be bound by these Terms of Service ("Terms"). If you disagree with any part of the terms, then you may not access the Service.</p>
             <h2>2. Account Responsibility</h2>
             <p>You are responsible for maintaining the confidentiality of your account credentials (username and password) and for all activities that occur under your account. You agree to notify us immediately of any unauthorized use of your account or any other breach of security.</p>
             <h2>3. Use of the Service</h2>
             <p>The Elevo Core System is provided to assist agents in managing call flows, accessing knowledge base information, and tracking performance metrics. You agree to use the Service only for its intended purposes and in accordance with all applicable laws and regulations. Prohibited uses include, but are not limited to: attempting to gain unauthorized access to the Service or its related systems, interfering with the Service's operations, or using the Service for any illegal or fraudulent activity.</p>
             <h2>4. Data Collection and Use</h2>
             <p>The Service will collect data related to your usage, including but not limited to call scenarios accessed, time spent on steps, assessment results, and overall performance. This data is used for system operation, performance analysis, providing feedback, talent development, and improving the Service. All personal data will be handled in accordance with our Privacy Policy.</p>
             <h2>5. Intellectual Property</h2>
             <p>The Service and its original content (excluding Content provided by users), features, and functionality are and will remain the exclusive property of [Your Company/Project Name or Your Name] and its licensors. The Service is protected by copyright, trademark, and other laws.</p>
             <h2>6. Termination</h2>
             <p>We may terminate or suspend your account immediately, without prior notice or liability, for any reason whatsoever, including without limitation if you breach the Terms.</p>
             <h2>7. Disclaimer of Warranties</h2>
             <p>The Service is provided on an "AS IS" and "AS AVAILABLE" basis. Your use of the Service is at your sole risk. The Service is provided without warranties of any kind, whether express or implied, including, but not limited to, implied warranties of merchantability, fitness for a particular purpose, non-infringement, or course of performance.</p>
             <h2>8. Limitation of Liability</h2>
             <p>In no event shall [Your Company/Project Name or Your Name], nor its directors, employees, partners, agents, suppliers, or affiliates, be liable for any indirect, incidental, special, consequential or punitive damages, including without limitation, loss of profits, data, use, goodwill, or other intangible losses, resulting from your access to or use of or inability to access or use the Service.</p>
             <h2>9. Changes to Terms</h2>
             <p>We reserve the right, at our sole discretion, to modify or replace these Terms at any time. If a revision is material, we will try to provide at least 30 days' notice prior to any new terms taking effect. What constitutes a material change will be determined at our sole discretion.</p>
             <h2>10. Contact Us</h2>
             <p>If you have any questions about these Terms, please contact us at <a href="mailto:m.elsayed@thechefz.co">[Your Contact Email for Elevo Core System]</a>.</p>
         </div>
     </div>
     <div id="privacyModal" class="modal">
          <div class="modal-content">
              <span class="modal-close" data-close-modal>×</span>
             <h1>Privacy Policy for Elevo Core System</h1>
             <p class="modal-date">Last updated: May 11, 2025</p>
             <h2>1. Introduction</h2>
             <p>[Your Company/Project Name or Your Name] ("us", "we", or "our") operates the Elevo Core System (the "Service"). We are committed to protecting your privacy. This Privacy Policy explains how we collect, use, disclose, and safeguard your information when you use our Service. Please read this privacy policy carefully. If you do not agree with the terms of this privacy policy, please do not access the service.</p>
             <h2>2. Information We Collect</h2>
             <p>We may collect information about you in a variety of ways. The information we may collect via the Service includes:</p>
             <ul>
                 <li><strong>Personal Data:</strong> Personally identifiable information, such as your name and email address, that you voluntarily give to us when you register with the Service.</li>
                 <li><strong>Derivative Data:</strong> Information our servers automatically collect when you access the Service, such as your IP address, browser type, operating system, access times, and the pages you have viewed directly before and after accessing the Service. For internal agents, this may also include performance data such as call durations, scenario step timings, and assessment results.</li>
             </ul>
             <h2>3. Use of Your Information</h2>
             <p>[Your Company/Project Name or Your Name] uses the collected data for various purposes:</p>
             <ul>
                 <li>To provide and maintain our Service</li>
                 <li>To manage your account and provide user support</li>
                 <li>To monitor the usage of our Service</li>
                 <li>To detect, prevent and address technical issues</li>
                 <li>For performance analysis, training, and talent development purposes</li>
             </ul>
             <h2>4. Disclosure of Your Information</h2>
             <p>We may share information we have collected about you in certain situations. Your information may be disclosed as follows:</p>
             <ul>
                 <li><strong>By Law or to Protect Rights:</strong> If we believe the release of information about you is necessary to respond to legal process, to investigate or remedy potential violations of our policies, or to protect the rights, property, and safety of others, we may share your information as permitted or required by any applicable law, rule, or regulation.</li>
                 <li><strong>Third-Party Service Providers:</strong> We may share your information with third parties that perform services for us or on our behalf, including data analysis, hosting services (like  for authentication and database), customer service, and marketing assistance. These third parties are obligated to protect your information.</li>
                 <li><strong>Business Transfers:</strong> We may share or transfer your information in connection with, or during negotiations of, any merger, sale of company assets, financing, or acquisition of all or a portion of our business to another company.</li>
             </ul>
             <p>We do not sell your personal information to third parties.</p>
             <h2>5. Security of Your Information</h2>
             <p>We use administrative, technical, and physical security measures to help protect your personal information. While we have taken reasonable steps to secure the personal information you provide to us, please be aware that despite our efforts, no security measures are perfect or impenetrable, and no method of data transmission can be guaranteed against any interception or other type of misuse.</p>
             <h2>6. Your Data Protection Rights</h2>
             <p>Depending on your location, you may have certain data protection rights. These may include the right to access, correct, update, or request deletion of your personal information. If you wish to exercise any of these rights, please contact us.</p>
             <h2>7. Contact Us</h2>
             <p>If you have questions or comments about this Privacy Policy, please contact us at: <a href="mailto:m.elsayed@thechefz.co">[Your Contact Email for Elevo Core System]</a>.</p>
         </div>
     </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const SUPABASE_URL = 'https://lgcutmuspcaralydycmg.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnY3V0bXVzcGNhcmFseWR5Y21nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0NDY3MDEsImV4cCI6MjA2MTAyMjcwMX0.DX9NNZPYMaV96D1ohW9pwFWLzywKLYjP5s6tP89PLdbX';

            let supabase;
            try {
                if (!window.supabase || !window.supabase.createClient) {
                    throw new Error("Supabase library not loaded correctly!");
                }
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase client initialized.');
            } catch (error) {
                console.error("Initialization Error:", error.message);
                alert("Error: Could not initialize critical components. Please check the console and refresh. If the problem persists, contact support.");
                // Disable form submission if Supabase isn't initialized
                const submitBtn = document.getElementById('submitButton');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Initialization Failed';
                }
                return; // Stop further script execution
            }


            supabase.auth.onAuthStateChange((event, session) => {
                console.log(`Supabase auth state change. Event: ${event}`, session);
                if (event === "SIGNED_IN" && session && session.user) {
                    console.log("User signed in (event: SIGNED_IN):", session.user.id);
                    // Storing minimal info for potential use on the next page, if needed,
                    // but primarily relying on Supabase session management.
                    try {
                        localStorage.setItem('elCoreUserEmail', session.user.email);
                    } catch (e) {
                        console.warn("Could not save email to localStorage", e);
                    }
                    console.log("Redirecting to core-flow.html due to SIGNED_IN event.");
                    window.location.href = "core-flow.html";
                } else if (event === "SIGNED_OUT") {
                    console.log("User signed out (event: SIGNED_OUT)");
                    try {
                        localStorage.removeItem('elCoreUserEmail');
                    } catch (e) {
                        console.warn("Could not remove email from localStorage", e);
                    }
                }
            });

            const signupForm = document.getElementById('signupForm'); // Used for querySelector
            const nameInput = document.getElementById('name');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const confirmInput = document.getElementById('confirmPassword');
            const termsCheckbox = document.getElementById('terms');
            const submitButton = document.getElementById('submitButton');
            const passwordToggles = document.querySelectorAll('.password-toggle');
            const nameError = document.getElementById('nameError');
            const emailError = document.getElementById('emailError');
            const passwordError = document.getElementById('passwordError');
            const confirmError = document.getElementById('confirmError');
            const termsError = document.getElementById('termsError');
            const signupError = document.getElementById('signupError');
            const signupSuccess = document.getElementById('signupSuccess');
            const passwordStrength = document.getElementById('passwordStrength');

            function showError(element, message) { if(element){ element.textContent = message; element.style.display = 'block';} }
            function hideError(element) { if(element) element.style.display = 'none'; }
            function updatePasswordStrength(password) {
                 if (!passwordStrength) return;
                 let strength = 0;
                 if (password.length >= 6) strength++;
                 if (password.length >= 8) strength++;
                 if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
                 if (password.match(/\d/)) strength++;
                 if (password.match(/[^a-zA-Z\d]/)) strength++;
                 passwordStrength.textContent = '';
                 passwordStrength.className = 'password-strength';
                 if (password.length > 0) {
                     if (strength <= 2) { passwordStrength.textContent = 'Weak'; passwordStrength.classList.add('strength-weak'); }
                     else if (strength <= 4) { passwordStrength.textContent = 'Medium'; passwordStrength.classList.add('strength-medium'); }
                     else { passwordStrength.textContent = 'Strong'; passwordStrength.classList.add('strength-strong'); }
                 }
            }
            function togglePasswordVisibility(toggleButton, inputElement) {
                 if (!toggleButton || !inputElement) return;
                 const isPassword = inputElement.type === 'password';
                 inputElement.type = isPassword ? 'text' : 'password';
                 toggleButton.innerHTML = isPassword ?
                     '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>' :
                     '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>';
                 toggleButton.setAttribute('aria-label', isPassword ? 'Hide password' : 'Show password');
            }

            if(passwordInput) { passwordInput.addEventListener('input', (e) => updatePasswordStrength(e.target.value)); }
            if(confirmInput) { confirmInput.addEventListener('input', () => { if (passwordInput?.value !== confirmInput.value) { showError(confirmError, "Passwords don't match"); } else { hideError(confirmError); } }); }
            passwordToggles.forEach(toggle => {
                 const input = toggle.previousElementSibling;
                 if(input && input.tagName === 'INPUT') {
                     toggle.addEventListener('click', () => togglePasswordVisibility(toggle, input));
                     toggle.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') togglePasswordVisibility(toggle, input); });
                 } else {
                     const inputId = toggle.closest('.input-group')?.querySelector('input')?.id;
                     const inputElement = document.getElementById(inputId);
                     if(inputElement){
                        toggle.addEventListener('click', () => togglePasswordVisibility(toggle, inputElement));
                        toggle.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') togglePasswordVisibility(toggle, inputElement); });
                     }
                 }
            });

            async function handleSignup() { // Removed 'e' parameter as it's not from a form submit event
                console.log("Create Account button clicked (JS handler).");
                // Ensure Supabase is available
                if (!supabase) {
                    console.error("Supabase client not available. Signup aborted.");
                    showError(signupError, "A critical error occurred. Please refresh the page.");
                    return;
                }

                [nameError, emailError, passwordError, confirmError, termsError, signupError, signupSuccess].forEach(hideError);
                if(submitButton) { submitButton.disabled = true; submitButton.textContent = 'Creating Account...'; }

                const name = nameInput?.value.trim();
                const email = emailInput?.value.trim().toLowerCase();
                const password = passwordInput?.value;
                const confirmPassword = confirmInput?.value;
                const termsAgreed = termsCheckbox?.checked;

                console.log("Validating input...");
                let isValid = true;
                if (!name) { showError(nameError, "Please enter your full name"); isValid = false; }
                if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showError(emailError, "Please enter a valid email address"); isValid = false; }
                if (!password || password.length < 6) { showError(passwordError, "Password must be at least 6 characters"); isValid = false; }
                if (password !== confirmPassword) { showError(confirmError, "Passwords don't match"); isValid = false; }
                if (!termsAgreed) { showError(termsError, "You must agree to the terms"); isValid = false; }

                if (!isValid) {
                    console.log("Frontend validation failed.");
                    if(submitButton) { submitButton.disabled = false; submitButton.textContent = 'Create Account'; }
                    // Focus on the first visible error field's input
                    const firstErrorField = signupForm.querySelector('.input-group .error-message[style*="display: block"]');
                    if (firstErrorField) {
                        const inputElement = firstErrorField.closest('.input-group')?.querySelector('input');
                        if(inputElement && typeof inputElement.focus === 'function') inputElement.focus();
                    } else if (termsError.style.display === 'block') {
                        termsCheckbox?.focus();
                    }
                    return;
                }

                try {
                    console.log(`Attempting Supabase signup for: ${email}`);
                    const { data: signUpResponse, error: signUpAuthError } = await supabase.auth.signUp({
                        email: email,
                        password: password
                        // We are not passing 'name' here in `options.data` as the original code was inserting separately.
                        // If Supabase supports `data` in signUp for profile creation directly, it could be an option.
                    });

                    if (signUpAuthError) {
                        console.error('Supabase auth.signUp error:', signUpAuthError);
                        showError(signupError, signUpAuthError.message || 'Signup failed. Please check your details.');
                        isValid = false;
                    } else if (!signUpResponse.user) {
                         console.warn('Supabase signup did not return a user object directly after auth.signUp. This often means email confirmation is required before the user object is fully active or a session is established.', signUpResponse);
                         // Even if email confirmation is required, Supabase creates the user entry.
                         // We can proceed to insert profile data if a user ID is available in signUpResponse.data.user (even if session is null)
                         // For now, following the original logic of checking signUpResponse.user strictly.
                         showError(signupError, 'Account registration initiated. Please check your email to confirm your account if required by the system.');
                         // Consider if it's a success that requires email confirmation
                         // signupSuccess.textContent = "Registration initiated. Check your email to confirm!"; signupSuccess.style.display = 'block';
                         isValid = false; // Mark as not fully valid for immediate redirect logic
                    } else {
                        // User object is present in signUpResponse.user
                        const user = signUpResponse.user;
                        console.log('Supabase auth.signUp successful. User ID:', user.id);

                        // The onAuthStateChange listener should handle SIGNED_IN if a session is established.
                        // If email confirmation is required, SIGNED_IN will fire after confirmation.

                        console.log(`Attempting to insert profile into 'users' table for user ID: ${user.id}`);
                        const { error: insertError } = await supabase
                            .from('users')
                            .insert({ id: user.id, name: name, email: email, is_admin: email === "m.elsayed@thechefz.co" });

                        if (insertError) {
                            console.error('Supabase profile insert error:', insertError);
                            // This is a tricky state: auth user created, but profile failed.
                            // Inform user and potentially log for admin intervention.
                            showError(signupError, `Account created, but there was an issue saving profile details. Please contact support. (Error: ${insertError.message})`);
                            isValid = false; // Mark as not fully successful for redirect logic
                        } else {
                            console.log(`Profile inserted successfully for user ${user.id}. is_admin set to: ${email === "m.elsayed@thechefz.co"}`);
                            isValid = true; // Full success
                            // Store minimal info for a brief period, if needed.
                            try {
                                localStorage.setItem('currentUserSignupName', name); // Storing name just in case
                                console.log('Signup name info saved to localStorage.');
                            } catch (storageError) {
                                console.error('Error saving signup name to localStorage:', storageError);
                            }
                        }
                    }
                } catch (err) {
                    console.error("Unexpected JavaScript error during signup process:", err);
                    showError(signupError, 'An unexpected error occurred. Please try again later or contact support.');
                    isValid = false;
                }

                if (isValid) {
                    console.log("Signup and profile insert (if applicable) successful by form logic.");
                    if(signupSuccess) {
                        signupSuccess.textContent = "Registration successful! Preparing your dashboard..."; // Or specific message
                        signupSuccess.style.display = 'block';
                    }
                    // The onAuthStateChange listener should handle redirection to core-flow.html if SIGNED_IN.
                    // The timeout below is a fallback or for cases where onAuthStateChange might not fire immediately
                    // or if email confirmation is needed (in which case user shouldn't be redirected to core-flow yet).
                    // If onAuthStateChange already redirected, this won't run or won't matter.
                    // This timeout logic for login.html redirection might be redundant if onAuthStateChange is robust.
                    // For now, if email confirmation is required, they shouldn't go to core-flow yet anyway.
                    // The "signedup=true" on login.html could show a "Please check your email" message.
                    if (!signUpError && !signUpResponse.session) { // If signUp was ok but no immediate session (email confirmation likely)
                        signupSuccess.textContent = "Registration complete! Please check your email to confirm your account.";
                        signupSuccess.style.display = 'block';
                        setTimeout(function() {
                            // Do not redirect to login.html if already on core-flow.html (handled by onAuthStateChange)
                            if (!window.location.pathname.endsWith('core-flow.html')) {
                                console.log('Redirecting to login.html to inform about email confirmation.');
                                window.location.href = 'login.html?signedup_awaiting_confirmation=true&email=' + encodeURIComponent(email);
                            }
                        }, 2500);
                    } else if (signUpResponse.session) {
                        // If session is active, onAuthStateChange should handle redirect.
                        // This is a safety net if onAuthStateChange is slow.
                        console.log("Session is active post-signup, onAuthStateChange should redirect to core-flow.html.");
                        // No explicit redirect here, let onAuthStateChange do its job.
                    }


                } else {
                    console.log("Signup process failed or requires further action (e.g., email confirmation).");
                    if(submitButton) { submitButton.disabled = false; submitButton.textContent = 'Create Account'; }
                    // Focus logic is already inside the validation block.
                }
            }

            if(submitButton) {
                submitButton.addEventListener('click', handleSignup);
            } else {
                console.error("Submit button (ID: submitButton) not found in the DOM!");
                alert("Critical error: Signup button is missing. Page cannot function.");
            }

            const modalTriggers = document.querySelectorAll('[data-modal-target]');
            const closeButtons = document.querySelectorAll('[data-close-modal]');
            modalTriggers.forEach(button => { button.addEventListener('click', function(event) { event.preventDefault(); const modalId = this.dataset.modalTarget; const modal = document.getElementById(modalId); if (modal) openModal(modal); }); });
            closeButtons.forEach(button => { button.addEventListener('click', function() { const modal = this.closest('.modal'); if (modal) closeModal(modal); }); });
            window.addEventListener('click', function(event) { document.querySelectorAll('.modal').forEach(modal => { if (event.target == modal) closeModal(modal); }); });
            function openModal(modal) { if (modal == null) return; modal.style.display = 'block'; document.body.classList.add('modal-open'); }
            function closeModal(modal) { if (modal == null) return; modal.style.display = 'none'; document.body.classList.remove('modal-open'); }

            if(nameInput) nameInput.focus();
            console.log("Signup page script loaded and all event listeners should be attached.");
        });
    </script>
</body>
</html>
