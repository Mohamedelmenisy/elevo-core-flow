<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Core Coaching Skills</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <style>
        /* --- Global Styles --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            margin: 0;
            padding: 0;
            line-height: 1.7;
            background-color: #f8f9fa;
            color: #343a40;
        }

        /* Accessibility: Style for visually hidden labels */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* --- User Bar Styles --- */
        .user-bar {
            background-color: #34495e;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .user-info svg {
             opacity: 0.8;
        }

        .user-details { display: flex; flex-direction: column; }
        .user-name { font-weight: 600; font-size: 14px; }
        .user-email { font-size: 12px; opacity: 0.8; }

        .logout-button {
            background-color: #e74c3c;
            color: white; border: none; padding: 8px 15px; border-radius: 6px;
            cursor: pointer; font-weight: 500; transition: all 0.3s ease;
            display: flex; align-items: center; gap: 6px; font-size: 13px;
        }
        .logout-button:hover { background-color: #c0392b; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .logout-button:active { transform: translateY(0); }

        /* --- Navigation Tabs --- */
        .nav-tab {
            background-color: #2c3e50; padding: 12px 10px; text-align: center;
            position: sticky; top: 0; z-index: 100;
            overflow-x: auto; white-space: nowrap;
            -webkit-overflow-scrolling: touch; scrollbar-width: thin; scrollbar-color: #556a80 #2c3e50;
        }
        .nav-tab::-webkit-scrollbar { height: 6px; }
        .nav-tab::-webkit-scrollbar-track { background: #2c3e50; }
        .nav-tab::-webkit-scrollbar-thumb { background-color: #556a80; border-radius: 10px; border: 1px solid #2c3e50; }

        .nav-tab a {
            color: white; text-decoration: none; margin: 0 8px; padding: 8px 12px;
            border-radius: 6px; transition: background-color 0.3s, color 0.3s;
            font-size: 14px; display: inline-block;
        }
        .nav-tab a:hover, .nav-tab a.active { background-color: #4e6a85; color: #fff; }

        /* --- Main Content Styles --- */
        h1 {
            color: #fff; background: linear-gradient(90deg, #3498db, #2980b9);
            padding: 20px; border-radius: 8px; text-align: center; margin: 25px auto;
            max-width: 800px; font-size: 26px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        h2 {
             margin-top: 35px; margin-bottom: 15px; color: #2c3e50;
             font-size: 22px; border-bottom: 2px solid #e9ecef; padding-bottom: 8px;
        }

        .container {
            max-width: 800px; margin: 25px auto; background: white;
            padding: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.07); border-radius: 8px;
        }

        .quote {
            font-style: italic; border-left: 5px solid #3498db;
            padding: 15px 20px; background-color: #f0f8ff;
            margin: 25px 0; color: #555; font-size: 15px;
        }

        .image-container { text-align: center; margin: 30px 0; }
        .image-container img {
            max-width: 100%;
            height: auto; /* Let height adjust automatically */
            max-height: 400px; /* ** Limit max height for all images in container ** */
            object-fit: cover; /* Crop image nicely if aspect ratio differs */
            border-radius: 8px;
            border: 1px solid #eee;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            background-color: #f0f0f0; /* Light grey background for placeholder area */
            display: block; /* Prevent extra space below */
            margin: 0 auto; /* Center if max-width is less than container */
        }
        .image-container p { font-size: 14px; color: #777; margin-top: 10px; font-style: italic; }

        .tip-box, .action-box { padding: 20px; border-radius: 8px; margin: 25px 0; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tip-box strong, .action-box strong { display: block; margin-bottom: 8px; font-size: 16px; }
        .tip-box { background: linear-gradient(135deg, #1abc9c, #16a085); }
        .action-box { background: linear-gradient(135deg, #f39c12, #e67e22); }

        .question-box {
            background-color: #fdfefe; padding: 25px; border-radius: 8px; margin: 25px 0;
            border: 1px solid #e9ecef; box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .question-box h3 { margin-bottom: 15px; color: #34495e; font-size: 18px; }

        textarea, input[type="text"] {
            width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 6px;
            margin-top: 8px; margin-bottom: 10px; resize: vertical; min-height: 100px;
            font-size: 15px; transition: border-color 0.3s, box-shadow 0.3s;
        }
        textarea:focus, input[type="text"]:focus { border-color: #80bdff; outline: 0; box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25); }
        td input[type="text"] { min-height: auto; }


        /* --- Table Styles --- */
        table { width: 100%; border-collapse: collapse; margin: 25px 0; font-size: 14px; background-color: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        table th, table td { border: 1px solid #dee2e6; padding: 12px; text-align: left; vertical-align: top; }
        table th { background-color: #f8f9fa; font-weight: 600; color: #495057; }
        .metaphor-table thead th { background-color: #3498db; color: white; }
        table tr:nth-child(even) td { background-color: #f8f9fa; }
        td .button-group { margin-top: 0; }


        /* Highlighted Sections */
        .highlight-section, .skills-list, .ei-elements, .trust-methods { padding: 25px; border-left-width: 5px; border-radius: 8px; margin: 25px 0; font-size: 15px; }
        .highlight-section { background-color: #eaf5ff; border-left-color: #3498db; }
        .skills-list { background-color: #e8f8f0; border-left-color: #2ecc71; }
        .skills-list ul { margin-top: 10px; margin-left: 20px; list-style: disc; }
        .skills-list li { margin-bottom: 8px; }
        .ei-elements { background-color: #f4ecf7; border-left-color: #9b59b6; }
        .ei-elements ol { margin-top: 10px; margin-left: 20px; }
        .ei-elements li { margin-bottom: 8px; }
        .trust-methods { background-color: #eaf2f8; border-left-color: #2980b9; }
        .trust-methods ul { margin-top: 10px; margin-left: 20px; list-style: disc; }
        .trust-methods li { margin-bottom: 8px; }


        /* Buttons */
        .save-button, .delete-button { color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; margin-top: 8px; transition: all 0.3s ease; font-size: 14px; font-weight: 500; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .save-button { background-color: #28a745; }
        .delete-button { background-color: #dc3545; margin-left: 10px;}
        .save-button:hover { background-color: #218838; transform: translateY(-1px); }
        .delete-button:hover { background-color: #c82333; transform: translateY(-1px); }
        .button-group { display: flex; align-items: center; margin-top: 10px; }

        /* Feedback Messages */
        .save-status { font-size: 13px; color: #28a745; margin-left: 10px; font-weight: 500; display: none; }
        .save-status.deleted { color: #6c757d; }
        .error-message { color: #dc3545; font-size: 13px; margin-left: 10px; font-weight: 500; display: none; }

        /* Required Field Indication */
        .required-field { border-color: #dc3545 !important; background-color: #fbeeed !important; box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important; }

        /* Navigation Buttons (Bottom) */
        .navigation-buttons { display: flex; justify-content: space-between; margin-top: 40px; gap: 15px; border-top: 1px solid #eee; padding-top: 25px; }
        .navigation-buttons a {
            text-decoration: none; padding: 12px 20px; color: white; background: linear-gradient(90deg, #3498db, #2980b9);
            border-radius: 6px; font-weight: 600; flex: 1; text-align: center; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 15px;
        }
        .navigation-buttons a:hover { background: linear-gradient(90deg, #2980b9, #3498db); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .navigation-buttons a:first-child { background: #6c757d; }
        .navigation-buttons a:first-child:hover { background: #5a6268; }


        /* Floating Warning Message */
        .floating-warning {
            background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 15px 25px;
            color: #856404; display: none; position: fixed; top: 75px; left: 50%;
            transform: translateX(-50%); z-index: 1001; border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15); animation: slideDownFadeIn 0.4s ease-out;
            font-weight: 500; max-width: 90%; text-align: center;
        }
        @keyframes slideDownFadeIn { from { opacity: 0; top: 50px; } to { opacity: 1; top: 75px; } }
        @keyframes fadeOutUp { from { opacity: 1; top: 75px;} to { opacity: 0; top: 50px;} }

        /* Highlight class for text */
        .highlight { color: #e67e22; font-weight: bold; }

        /* --- Responsive Adjustments --- */
        @media (max-width: 768px) {
            h1 { font-size: 22px; padding: 15px; margin: 20px 15px; }
            h2 { font-size: 20px; }
            .container { padding: 20px; margin: 20px 15px; }
             .user-bar { padding: 10px 15px; font-size: 13px; }
             .user-name { font-size: 13px; } .user-email { font-size: 11px; }
             .logout-button { padding: 7px 12px; font-size: 12px; }
             .nav-tab { padding: 10px 5px; }
             .nav-tab a { margin: 0 5px; padding: 7px 10px; font-size: 13px;}
             .quote, .tip-box, .action-box, .question-box, .highlight-section, .skills-list, .ei-elements, .trust-methods { padding: 15px; margin: 20px 0; }
             .question-box h3 { font-size: 16px;}
             textarea, input[type="text"] { font-size: 14px; min-height: 80px;}
             td input[type="text"] { min-height: auto; }
             .navigation-buttons { flex-direction: column; padding-top: 20px; margin-top: 30px; }
             .navigation-buttons a { font-size: 14px; padding: 12px 15px;}
             .floating-warning { padding: 12px 20px; font-size: 14px; top: 65px; width: calc(100% - 30px); max-width: 400px; }
              @keyframes slideDownFadeIn { from { opacity: 0; top: 45px; } to { opacity: 1; top: 65px; } }
              @keyframes fadeOutUp { from { opacity: 1; top: 65px;} to { opacity: 0; top: 45px;} }
              table td { padding: 8px; }
              .button-group { flex-wrap: wrap; }
              .image-container img { max-height: 300px; /* Further reduce height on mobile */ }
        }

    </style>
</head>
<body>
    <!-- User Info Bar -->
    <header class="user-bar">
        <div class="user-info">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <div class="user-details">
                <span class="user-name" id="userName">Welcome back</span>
                <span class="user-email" id="userEmail">user@example.com</span>
            </div>
        </div>
        <button class="logout-button" onclick="logout()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            Logout
        </button>
    </header>

    <!-- Navigation Tabs -->
    <nav class="nav-tab">
        <a href="index.html">Home</a>
        <a href="article1.html">Article 1</a>
        <a href="coaching-skills.html" class="active">Coaching Skills</a>
        <a href="coaching-individuals.html">Coaching Individuals</a>
        <a href="coaching-team.html">Team Coaching</a>
        <a href="coaching-yourself.html">Self Coaching</a>
        <a href="action-plan.html">Action Plan</a>
    </nav>

    <main>
        <h1>Core Coaching Skills</h1>

        <div class="floating-warning" id="warningMessage">
            <strong>Action Required:</strong> Please complete all required fields before proceeding.
        </div>

        <div class="container">

            <div class="highlight-section">
                <p>Feedback from people who have received coaching suggests that a coach's most important attributes are personal <span class="highlight">rapport, confidence, and a sense of humor</span>.</p>
                <p>A report by the International Coaching Federation shows that thousands of coaching clients valued rapport and compatibility more highly than a coach's formal education or years of experience. This gives you an advantage – because, as a manager, you likely already have working relationships with your team members.</p>
            </div>

            <div class="skills-list">
                <p>But effective coaching requires other crucial skills too. These form the foundation of successful coaching conversations:</p>
                <ul>
                    <li>Active Listening</li>
                    <li>Effective Communication (including Clean Language)</li>
                    <li>Powerful Questioning</li>
                    <li>Emotional Intelligence (EQ)</li>
                    <li>Building Trust</li>
                </ul>
                <p>In this section, we'll explore each of these skills in more detail and provide actionable steps for improvement.</p>
            </div>

            <div class="quote">
                <p>"A coach is someone who tells you what you don't want to hear, and has you see what you don't want to see, so you can be who you have always known you can be." - Tom Landry</p>
            </div>

            <!-- Section 1: Listening Skills -->
            <h2>1. Improving Your Listening Skills</h2>

             <div class="image-container">
                 <!-- ** IMAGE 1: Listening Skills (Alternative) ** -->
                 <img src="https://images.unsplash.com/photo-1517486808906-6ca8b3f04846?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=774&q=80"
                      alt="Two people having an engaged, focused conversation, representing active listening."
                      onerror="this.onerror=null; this.src='https://via.placeholder.com/800x400/1abc9c/ffffff?text=Active+Listening+Placeholder';">
                 <p>Truly hearing what's said (and unsaid) is the cornerstone of coaching.</p>
            </div>

            <p>The ability to listen well is arguably the <span class="highlight">most important</span> coaching skill...</p>
            <p>Specifically, you need strong <span class="highlight">active listening</span> skills...</p>
            <p>Show you're engaged with subtle cues...</p>
            <p><span class="highlight">Empathic listening</span> builds on this...</p>
             <p><span class="highlight">Mindful listening</span> takes it further...</p>
            <div class="tip-box">
                <strong>TIP: Deepen Your Listening</strong><br>
                Practice noticing not just the words, but the energy, tone, and pauses...
            </div>
            <div class="action-box">
                <strong>ACTION: Practice Active Listening</strong><br>
                In your next one-on-one meeting, consciously practice active listening...
            </div>
            <div class="question-box">
                <h3>Reflection: Active Listening Practice <span class="highlight">*</span></h3>
                <p>Describe a recent conversation where you practiced active listening. </p>

                <!-- ** CORRECTED ORDER OF TEXTAREAS ** -->
                <label for="listen-q1" class="sr-only">1. Did the other person's body language align with what they said? Explain.</label>
                <textarea id="listen-q1" placeholder="1. Did body language align? Explain..." class="required-answer" data-question="listen-q1" aria-describedby="error-listen-q1"></textarea>

                <label for="listen-q2" class="sr-only">2. Did active listening help you understand them better? If so, how?</label>
                <textarea id="listen-q2" placeholder="2. How did it help your understanding?..." class="required-answer" data-question="listen-q2" aria-describedby="error-listen-q2"></textarea>

                <label for="listen-q3" class="sr-only">3. How could applying active listening more consistently improve your relationships (work and personal)?</label>
                <textarea id="listen-q3" placeholder="3. How could it improve relationships?..." class="required-answer" data-question="listen-q3" aria-describedby="error-listen-q3"></textarea>

                <div class="button-group">
                    <button class="save-button" onclick="saveAnswer(['listen-q1', 'listen-q2', 'listen-q3'], 'save-status-listen', 'error-listen')">Save Reflection</button>
                    <button class="delete-button" onclick="deleteAnswer(['listen-q1', 'listen-q2', 'listen-q3'], 'save-status-listen', 'error-listen')">Delete Reflection</button>
                    <span class="save-status" id="save-status-listen">✓ Saved</span>
                    <span class="error-message" id="error-listen">Please complete all parts of the reflection.</span>
                </div>
            </div>

            <!-- Section 2: Communication Skills -->
            <h2>2. Developing Good Communication Skills</h2>
            <p>To be an effective coach, you need to communicate thoughts and ideas clearly...</p>
             <div class="image-container">
                 <!-- ** NEW IMAGE 2: Communication Skills (Alternative 2) ** -->
                  <img src="https://images.unsplash.com/photo-1516321497487-e288fb19713f?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1170&q=80"
                       alt="Diverse group collaborating around a table with sticky notes, symbolizing communication and idea sharing."
                       onerror="this.onerror=null; this.src='https://via.placeholder.com/800x400/f39c12/ffffff?text=Communication+Placeholder';">
                  <p>Clean Language helps maintain focus on the coachee's experience.</p>
             </div>
            <p>Consider this example...</p>
            <div class="quote"> ... </div>
            <p>Rahma's assumptions steered the conversation...</p>
            <p><span class="highlight">Clean Language</span> helps coaches avoid imposing...</p>
            <p>Key Clean Language Questions...</p>
            <ul> ... </ul>
            <p>Pay attention to the <span class="highlight">metaphors</span> your coachee uses...</p>
            <div class="tip-box"> ... </div>
            <div class="action-box"> ... </div>
            <table class="metaphor-table"> ... </table>

            <!-- Section 3: Questioning Skills -->
            <h2>3. Asking Better Questions</h2>
            <p>Great coaches listen more than they talk...</p>
            <p>Focus on asking <span class="highlight">open-ended questions</span>...</p>
            <p>Use <span class="highlight">probing questions</span>...</p>
            <p>Crucially, <span class="highlight">allow silence</span>...</p>
            <div class="tip-box"> ... </div>

            <!-- Section 4: Emotional Intelligence -->
            <h2>4. Developing Emotional Intelligence (EQ)</h2>
            <p>EQ is the ability to recognize, understand, and manage your own emotions...</p>
            <div class="ei-elements"> ... </div>
            <div class="action-box"> ... </div>
            <div class="question-box"> ... </div>
            <div class="question-box"> ... </div>

            <!-- Section 5: Building Trust -->
            <h2>5. Building Trust</h2>
            <p>Trust and confidentiality are the bedrock of any coaching relationship...</p>
             <div class="image-container">
                 <!-- ** NEW IMAGE 3: Building Trust (Alternative 2) ** -->
                 <img src="https://images.unsplash.com/photo-1543269865-cbf427effbad?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1170&q=80"
                      alt="Two people smiling and talking in a supportive manner, symbolizing trust and connection."
                      onerror="this.onerror=null; this.src='https://via.placeholder.com/800x400/2980b9/ffffff?text=Building+Trust+Placeholder';">
                 <p>Trust is earned through consistent, ethical behavior.</p>
            </div>
            <div class="trust-methods"> ... </div>
            <div class="tip-box"> ... </div>
            <div class="action-box"> ... </div>
            <div class="question-box"> ... </div>
             <p style="font-size: 13px; color: #6c757d; margin-top: 5px;"><span class="highlight">*</span> Required field</p>


            <!-- Navigation Buttons -->
            <div class="navigation-buttons">
                <a href="article1.html" class="nav-button">← Back: Intro</a>
                <a href="coaching-individuals.html" class="nav-button" id="nextButton">Next: Coaching Individuals →</a>
            </div>
        </div> <!-- /.container -->
    </main>

    <script>
        // --- Configuration ---
        const formspreeEndpoint = 'https://formspree.io/f/xzzeqvea'; // Your Formspree Endpoint URL
        const localStorageKeyPrefix = 'courseAnswers_';
        const currentPageKey = 'coachingSkills'; // Unique key for this page
        const localStorageKey = `${localStorageKeyPrefix}${currentPageKey}`;
        const currentUserKey = 'currentUser';

        // --- Combined Save/Delete Functionality ---
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            const currentUser = getCurrentUser();
            if (!currentUser || !currentUser.email) {
                console.error("User not logged in or email missing.");
                window.location.href = `login.html?redirect=${encodeURIComponent(window.location.pathname)}`;
                return;
            }
            displayUserInfo(currentUser);
            loadUserAnswers(currentUser.email);
            setupEventListeners(currentUser.email);
            highlightActiveNav();
        });

        // --- User Info & Authentication ---
        function getCurrentUser() {
            try {
                const userDataString = localStorage.getItem(currentUserKey);
                return userDataString ? JSON.parse(userDataString) : null;
            } catch (error) {
                console.error("Error parsing user data from localStorage:", error);
                return null;
            }
        }
        function displayUserInfo(user) {
            document.getElementById('userName').textContent = `Welcome, ${user.name || 'User'}`;
            document.getElementById('userEmail').textContent = user.email;
        }
        function logout() {
            localStorage.removeItem('loggedIn');
            localStorage.removeItem(currentUserKey);
            window.location.href = 'login.html';
        }
        function highlightActiveNav() {
             const currentPath = window.location.pathname.split('/').pop();
             const navLinks = document.querySelectorAll('.nav-tab a');
             navLinks.forEach(link => {
                 link.classList.toggle('active', link.getAttribute('href') === currentPath);
             });
         }

        // --- Answer Handling (Local Storage - Page Specific) ---
        function loadUserAnswers(userEmail) {
             if (!userEmail) return;
             const allPageAnswers = JSON.parse(localStorage.getItem(localStorageKey)) || {};
             const userAnswers = allPageAnswers[userEmail] || {};
             document.querySelectorAll('.required-answer').forEach(field => {
                 const questionId = field.getAttribute('data-question');
                 const savedAnswer = userAnswers[questionId];
                 const statusId = getStatusIdForField(field);
                 const statusElement = document.getElementById(statusId);

                 if (savedAnswer !== undefined) {
                     field.value = savedAnswer;
                     field.classList.remove('required-field');
                     hideError(getErrorIdForField(field));
                     if (savedAnswer.trim() !== '' && statusElement) {
                         showSaveStatus(statusId, '✓ Saved');
                     } else if (statusElement) {
                         statusElement.style.display = 'none';
                     }
                 } else {
                     field.value = '';
                     if (statusElement) statusElement.style.display = 'none';
                 }
             });
        }
        function saveAnswerToStorage(userEmail, questionId, answer) {
            if (!userEmail) return false;
            const allPageAnswers = JSON.parse(localStorage.getItem(localStorageKey)) || {};
            if (!allPageAnswers[userEmail]) allPageAnswers[userEmail] = {};
            allPageAnswers[userEmail][questionId] = answer;
            try {
                localStorage.setItem(localStorageKey, JSON.stringify(allPageAnswers));
                return true;
            } catch (error) {
                 console.error("Error saving to localStorage:", error);
                 alert("Could not save answer. Browser storage might be full.");
                 return false;
            }
        }
        function deleteAnswerFromStorage(userEmail, questionId) {
             if (!userEmail) return false;
             const allPageAnswers = JSON.parse(localStorage.getItem(localStorageKey)) || {};
             let updated = false;
             if (allPageAnswers[userEmail] && allPageAnswers[userEmail][questionId] !== undefined) {
                 delete allPageAnswers[userEmail][questionId];
                 updated = true;
                 if (Object.keys(allPageAnswers[userEmail]).length === 0) delete allPageAnswers[userEmail];
             }
             if(updated) {
                try {
                    localStorage.setItem(localStorageKey, JSON.stringify(allPageAnswers));
                    return true;
                } catch (error) {
                    console.error("Error saving to localStorage after delete:", error);
                    alert("Could not update storage after deleting answer.");
                    return false;
                }
             }
             return false;
        }

        // --- Event Listeners Setup ---
        function setupEventListeners(userEmail) {
             document.querySelectorAll('.required-answer').forEach(field => {
                field.addEventListener('input', function() {
                    if (this.value.trim() !== '') {
                        this.classList.remove('required-field');
                        hideError(getErrorIdForField(this));
                    }
                 });
             });
            const nextButton = document.getElementById('nextButton');
             if(nextButton) {
                 nextButton.addEventListener('click', function(e) {
                    if (!validateAllAnswers(true)) {
                        e.preventDefault();
                        showWarningMessage();
                    }
                 });
             }
        }

        // --- UI Feedback & Validation ---
        function validateAllAnswers(showErrors = false) {
             let allAnswered = true;
            document.querySelectorAll('.required-answer').forEach(field => {
                const errorId = getErrorIdForField(field);
                if (field.value.trim() === '') {
                    allAnswered = false;
                    if (showErrors) {
                        field.classList.add('required-field');
                        showError(errorId, field);
                    }
                } else {
                    field.classList.remove('required-field');
                    hideError(errorId);
                }
            });
            return allAnswered;
        }
        function showWarningMessage() {
             const warningElement = document.getElementById('warningMessage');
            warningElement.style.display = 'block';
            warningElement.style.animation = 'slideDownFadeIn 0.4s ease-out';
            const firstEmptyField = document.querySelector('.required-answer.required-field');
            if (firstEmptyField) {
                firstEmptyField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => firstEmptyField.focus({ preventScroll: true }), 500);
            }
            setTimeout(() => {
                warningElement.style.animation = 'fadeOutUp 0.5s ease-out forwards';
                 setTimeout(() => {
                      warningElement.style.display = 'none';
                      warningElement.style.animation = '';
                 }, 500);
            }, 4000);
        }
        function showSaveStatus(statusId, message = '✓ Saved') {
             const statusElement = document.getElementById(statusId);
             if (!statusElement) return;
             statusElement.textContent = message;
             statusElement.classList.remove('deleted');
             if (message.includes('deleted')) statusElement.classList.add('deleted');
             statusElement.style.display = 'inline-block';
             clearTimeout(statusElement.timer);
             statusElement.timer = setTimeout(() => { statusElement.style.display = 'none'; }, 3000);
        }
        function showError(errorId, field, message = 'This field is required.') {
              const errorElement = document.getElementById(errorId);
             if (!errorElement) return;
             errorElement.textContent = message;
             errorElement.style.display = 'inline-block';
             if (field) field.classList.add('required-field');
        }
        function hideError(errorId) {
              const errorElement = document.getElementById(errorId);
              if (!errorElement) return;
             errorElement.style.display = 'none';
        }

        // --- Helper functions to get related element IDs ---
        function getStatusIdForField(field) {
             const questionId = field.getAttribute('data-question');
             const groupButton = field.closest('.question-box')?.querySelector('.save-button[onclick*="saveAnswer("]');
             if (groupButton) {
                 const match = groupButton.getAttribute('onclick').match(/saveAnswer\(.*?,\s*'([^']*)'/);
                 if (match && match[1]) return match[1];
             }
             return `save-status-${questionId}`;
        }
        function getErrorIdForField(field) {
              const questionId = field.getAttribute('data-question');
              const groupButton = field.closest('.question-box')?.querySelector('.save-button[onclick*="saveAnswer("]');
              if (groupButton) {
                  const match = groupButton.getAttribute('onclick').match(/saveAnswer\(.*?,\s*'.*?',\s*'([^']*)'/);
                  if (match && match[1]) return match[1];
              }
              return `error-${questionId}`;
        }

        // --- Actions (Save, Delete) ---
        function saveAnswer(questionIds, statusId, errorId) {
            const currentUser = getCurrentUser();
            if (!currentUser || !currentUser.email) { alert('Session expired.'); window.location.href = 'login.html'; return; }
            const ids = Array.isArray(questionIds) ? questionIds : [questionIds];
            let allValid = true; const answersToSave = {}; let firstInvalidField = null;
            const generalErrorElement = document.getElementById(errorId);
            if(generalErrorElement) generalErrorElement.style.display = 'none';

            ids.forEach(id => {
                const field = document.querySelector(`.required-answer[data-question="${id}"]`);
                if (!field) { console.error(`Field not found: ${id}`); allValid = false; return; }
                const answer = field.value.trim();
                const specificErrorId = getErrorIdForField(field);
                const specificErrorElement = document.getElementById(specificErrorId);
                field.classList.remove('required-field');
                if (specificErrorElement) specificErrorElement.style.display = 'none';

                if (!answer) {
                    allValid = false; field.classList.add('required-field');
                    if (!firstInvalidField) firstInvalidField = field;
                    if(specificErrorElement) { specificErrorElement.textContent = 'This field is required.'; specificErrorElement.style.display = 'inline-block'; }
                } else { answersToSave[id] = field.value; }
            });

            if (!allValid) {
                 if(generalErrorElement && ids.length > 1) { generalErrorElement.textContent = "Please complete all required parts."; generalErrorElement.style.display = 'inline-block'; }
                 if(firstInvalidField) firstInvalidField.focus();
                return;
            }
            let saveSuccess = true;
            Object.keys(answersToSave).forEach(id => {
                if (!saveAnswerToStorage(currentUser.email, id, answersToSave[id])) saveSuccess = false;
                submitToFormspree(currentUser.email, id, answersToSave[id]);
            });
            if (saveSuccess) {
                 showSaveStatus(statusId);
                 ids.forEach(id => {
                      const field = document.querySelector(`.required-answer[data-question="${id}"]`);
                      if(field) field.classList.remove('required-field');
                      hideError(getErrorIdForField(field));
                 });
            }
        }
        function deleteAnswer(questionIds, statusId, errorId) {
             const currentUser = getCurrentUser();
             if (!currentUser || !currentUser.email) { alert('Session expired.'); window.location.href = 'login.html'; return; }
             const ids = Array.isArray(questionIds) ? questionIds : [questionIds];
             let deletedSomething = false;
             const generalStatusElement = document.getElementById(statusId);
             const generalErrorElement = document.getElementById(errorId);
             if(generalStatusElement) generalStatusElement.style.display = 'none';
             if(generalErrorElement) generalErrorElement.style.display = 'none';

             ids.forEach(id => {
                 const field = document.querySelector(`.required-answer[data-question="${id}"]`);
                 if (!field) return;
                 const specificStatusId = getStatusIdForField(field);
                 const specificErrorId = getErrorIdForField(field);
                 hideError(specificErrorId);
                 const specificStatusElement = document.getElementById(specificStatusId);
                 if (specificStatusElement) specificStatusElement.style.display = 'none';
                 field.classList.remove('required-field');
                 field.value = '';
                 if (deleteAnswerFromStorage(currentUser.email, id)) deletedSomething = true;
             });
            if (deletedSomething) showSaveStatus(statusId, 'Answer(s) deleted');
            else console.log("Nothing to delete from storage.");
        }

        // --- Formspree Submission ---
        function submitToFormspree(userEmail, questionId, answer) {
             if (!formspreeEndpoint || !userEmail) return;
            const formData = new FormData();
            formData.append('email', userEmail);
            formData.append('page_key', currentPageKey);
            formData.append('question_id', questionId);
            formData.append('answer_text', answer);
            const currentUser = getCurrentUser();
            if (currentUser?.name) formData.append('user_name', currentUser.name);
            fetch(formspreeEndpoint, { method: 'POST', body: formData, headers: { 'Accept': 'application/json' } })
            .then(response => {
                if (response.ok) console.log(`Formspree: ${currentPageKey}/${questionId} submitted.`);
                else response.json().then(data => console.error(`Formspree Error (${currentPageKey}/${questionId}):`, data.errors?.map(e => e.message).join(', ') || `Status ${response.status}`))
                                    .catch(() => console.error(`Formspree Error (${currentPageKey}/${questionId}): Status ${response.status}`));
            })
            .catch(error => console.error(`Formspree Network Error (${currentPageKey}/${questionId}):`, error));
        }

    </script>

</body>
</html>
