<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coaching Skills</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- Global Styles (Original) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html { scroll-behavior: smooth; }
        body { margin: 0; padding: 0; line-height: 1.6; background-color: #f9f9f9; color: #333; /* Removed body padding */ }
        /* User Bar (Original) */
        .user-bar { background-color: #34495e; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; color: white; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-info svg { opacity: 0.8; }
        .user-details { display: flex; flex-direction: column; }
        .user-name { font-weight: 600; font-size: 14px; }
        .user-email { font-size: 12px; opacity: 0.8; }
        .logout-button { background-color: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 6px; font-size: 13px; }
        .logout-button:hover { background-color: #c0392b; transform: translateY(-1px); }
        .logout-button:active { transform: translateY(0); }
        /* Nav Tabs (Original Sticky) */
        .nav-tab { background-color: #2c3e50; padding: 12px 10px; text-align: center; position: sticky; /* Kept sticky */ top: 0; /* Sticks to top */ z-index: 100; white-space: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: thin; scrollbar-color: #556a80 #2c3e50; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .nav-tab::-webkit-scrollbar { height: 6px; }
        .nav-tab::-webkit-scrollbar-track { background: #2c3e50; }
        .nav-tab::-webkit-scrollbar-thumb { background-color: #556a80; border-radius: 10px; border: 1px solid #2c3e50; }
        .nav-tab a { color: white; text-decoration: none; margin: 0 8px; padding: 8px 12px; border-radius: 6px; transition: background-color 0.3s, color 0.3s; font-size: 14px; display: inline-block; }
        .nav-tab a:hover, .nav-tab a.active { background-color: #34495e; color: #fff; }

        /* --- NEW Sticky Progress Bar --- */
        #sticky-progress-container {
            position: sticky; /* Sticks below the nav bar */
            top: 48px; /* Height of the nav-tab (adjust if nav-tab height changes) */
            left: 0;
            width: 100%;
            background-color: #f1f3f5; /* Lighter background */
            padding: 6px 0;
            z-index: 99; /* Below nav bar */
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            border-bottom: 1px solid #dee2e6;
        }
        #sticky-progress-bar-wrapper {
             max-width: 800px; /* Match container width */
             margin: 0 auto;
             background-color: #ced4da;
             border-radius: 5px;
             overflow: hidden;
             height: 18px;
        }
        #sticky-progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #2ecc71, #27ae60);
            border-radius: 5px;
            transition: width 0.5s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        #sticky-progress-text {
            font-size: 10px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
            padding: 0 5px;
        }
        /* --- End Sticky Progress Bar --- */

        /* Main Content (Original Styles + Padding Top Adjustment) */
        h1 { color: #fff; background-color: #e67e22; padding: 20px; border-radius: 8px; text-align: center; margin: 25px auto; max-width: 800px; font-size: 26px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { color: #34495e; margin-top: 35px; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 2px solid #ecf0f1; font-size: 1.6em; }
        h3 { color: #e67e22; margin-top: 20px; margin-bottom: 10px; font-size: 1.3em; }
        .container {
            max-width: 800px;
            margin: 20px auto 30px;
            background: white;
            padding: 30px;
             /* Removed padding-top, sticky progress bar handles offset */
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        .quote { font-style: italic; border-left: 4px solid #e67e22; padding: 15px 20px; background-color: #fdfaf6; margin: 25px 0; border-radius: 0 6px 6px 0; font-size: 1.05em; color: #555; }
        .quote p { margin-bottom: 10px; }
        .quote em { color: #c0392b; font-weight: 500; }
        .image-container { text-align: center; margin: 35px 0; }
        .image-container img { max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 6px 12px rgba(0,0,0,0.1); border: 1px solid #eee; }
        .image-container p.caption { font-size: 0.9em; color: #666; margin-top: 12px; font-style: italic; }
        .tip-box, .action-box { padding: 15px 20px; border-radius: 6px; margin: 25px 0; color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-left-width: 5px; border-left-style: solid; }
        .tip-box { background-color: #3498db; border-left-color: #2980b9; }
        .action-box { background-color: #e67e22; border-left-color: #d35400; }
        .tip-box strong, .action-box strong { display: block; margin-bottom: 8px; font-size: 1.1em; }
        .question-box { background-color: rgba(52, 152, 219, 0.08); padding: 25px; border-radius: 6px; margin: 25px 0; border: 1px solid rgba(52, 152, 219, 0.2); border-left: 5px solid #3498db; position: relative; }
        .question-box h3 { margin-top: 0; margin-bottom: 15px; color: #34495e; font-weight: 600; font-size: 1.2em; }
        .question-box h3 .required-star { color: #e74c3c; font-weight: bold; margin-left: 3px; }
        .question-box p strong { color: #34495e; display: block; margin-top: 15px; margin-bottom: 5px; font-weight: 600; }
        textarea, input[type="text"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; margin-top: 8px; margin-bottom: 10px; background-color: #fff; min-height: 45px; line-height: 1.6; display: block; color: #333; font-size: 15px; transition: border-color 0.3s, box-shadow 0.3s; }
        textarea { min-height: 80px; resize: vertical; }
        textarea:focus, input[type="text"]:focus { outline: none; border-color: #e67e22; box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.2); }
        textarea::placeholder, input::placeholder { color: #aaa; opacity: 1; }
        textarea:disabled, input[type="text"]:disabled { background-color: #f0f0f0 !important; cursor: not-allowed !important; color: #6c757d !important; border-color: #ddd !important; box-shadow: none !important;}

        /* Metaphor Section Styles */
        .metaphor-section { background-color: #f8f9fa; padding: 20px; border-radius: 6px; margin: 25px 0; border: 1px solid #eee; border-left: 5px solid #3498db; position: relative; }
         .metaphor-section h3 { margin-top: 0; margin-bottom: 20px; color: #34495e; font-weight: 600; font-size: 1.2em; text-align: center; border-bottom: 1px solid #e0e0e0; padding-bottom: 10px; }
         .metaphor-entry { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed #e0e0e0; }
          .metaphor-entry:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
         .metaphor-entry input[type="text"] { margin-top: 0; margin-bottom: 10px; padding: 10px; font-size: 14px; }
         .metaphor-entry .button-group { margin-top: 5px; justify-content: flex-start; }

        .button-group { display: flex; align-items: center; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .save-button, .delete-button { color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; transition: all 0.3s ease; font-size: 14px; font-weight: 500; }
        .save-button { background-color: #27ae60; }
        .delete-button { background-color: #e74c3c; }
        .save-button:hover:not(:disabled) { background-color: #2ecc71; transform: translateY(-1px); }
        .delete-button:hover:not(:disabled) { background-color: #c0392b; transform: translateY(-1px); }
        .save-button:active, .delete-button:active { transform: translateY(0); }
        .save-button:disabled, .delete-button:disabled { background-color: #bdc3c7 !important; cursor: not-allowed !important; transform: none !important; box-shadow: none !important; opacity: 0.7 !important; }
        .navigation-buttons { display: flex; justify-content: space-between; margin-top: 40px; gap: 20px; border-top: 1px solid #eee; padding-top: 25px; }
        .navigation-buttons a.nav-button { text-decoration: none; padding: 12px 20px; color: white; border-radius: 4px; font-weight: 600; flex: 1; text-align: center; transition: all 0.3s ease; font-size: 15px; border: none; cursor: pointer; background-color: #e67e22; }
        .navigation-buttons a.nav-button.back { background-color: #6c757d; }
        .navigation-buttons a.nav-button:hover { transform: translateY(-1px); filter: brightness(110%); }
        .navigation-buttons a.nav-button:active { transform: translateY(0); filter: brightness(100%); }
        .save-status { font-size: 14px; color: #27ae60; margin-top: 12px; display: none; font-weight: 600; }
        .error-message { color: #e74c3c; font-size: 13px; margin-left: 5px; display: none; font-weight: 500; margin-top: 5px; }
        .required-field { border: 2px solid #e74c3c !important; background-color: #fff2f1 !important; box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.2) !important; }
        .floating-warning { background-color: #fff8e1; border-left: 4px solid #ffc107; padding: 15px 25px; color: #333; display: none; position: fixed; top: 100px; /* Adjusted top for sticky elements */ left: 50%; transform: translateX(-50%); z-index: 1001; border-radius: 6px; box-shadow: 0 3px 10px rgba(0,0,0,0.2); animation: slideDownFadeInWarn 0.4s ease-out; font-weight: 500; max-width: 90%; width: auto; min-width: 300px; text-align: center; }
        @keyframes slideDownFadeInWarn { from { opacity: 0; top: 70px; } to { opacity: 1; top: 100px; } }
        @keyframes fadeOutUpWarn { from { opacity: 1; top: 100px; } to { opacity: 0; top: 70px; } }
        .required-star { color: #e74c3c; font-weight: bold; margin-left: 2px; }
        .highlight-section, .skills-list, .ei-elements, .trust-methods { padding: 20px; border-radius: 6px; margin: 25px 0; border-left-width: 5px; border-left-style: solid; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .highlight-section { background-color: rgba(52, 152, 219, 0.08); border-left-color: #3498db; }
        .skills-list { background-color: rgba(46, 204, 113, 0.08); border-left-color: #2ecc71; }
        .skills-list ul { margin-left: 25px; list-style: disc; padding-left: 15px; }
        .ei-elements { background-color: rgba(155, 89, 182, 0.08); border-left-color: #9b59b6; }
        .ei-elements ol { margin-left: 25px; padding-left: 15px; }
        .trust-methods { background-color: rgba(41, 128, 185, 0.08); border-left-color: #2980b9; }
        .trust-methods ul { margin-left: 25px; list-style: disc; padding-left: 15px; }
        .note { font-size: 0.9em; color: #555; margin-top: 15px; padding-left: 5px; }

         /* Removed old progress bar styles */
        .question-progress-container { display: none !important; }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
             /* Adjust sticky top based on potential nav bar height change on mobile */
             .nav-tab { /* Keep original sticky top: 0; */ }
             #sticky-progress-container { top: 48px; /* Match potential nav height */ padding: 4px 0; }
             #sticky-progress-bar-wrapper { height: 16px; }
             #sticky-progress-text { font-size: 9px; }
             h1 { font-size: 22px; padding: 15px; margin: 20px 15px; }
             h2 { font-size: 1.4em; } h3 { font-size: 1.15em; }
             .container { padding: 20px; margin: 15px auto 20px; } /* Adjusted margin */
             .user-bar { padding: 10px 15px; font-size: 13px; }
             .user-name { font-size: 13px; } .user-email { font-size: 11px; }
             .logout-button { padding: 7px 12px; font-size: 12px; }
             .nav-tab a { margin: 0 5px; padding: 7px 10px; font-size: 13px; }
             .highlight-section, .question-box, .skills-list, .ei-elements, .trust-methods, .tip-box, .action-box, .metaphor-section { padding: 15px; margin: 20px 0; }
             textarea, input[type="text"] { padding: 10px; font-size: 14px; }
             textarea { min-height: 70px; }
             .save-button, .delete-button { padding: 7px 13px; font-size: 13px; }
             .navigation-buttons { flex-direction: column; gap: 15px; }
             .navigation-buttons a.nav-button { font-size: 14px; padding: 12px 15px; }
             .floating-warning { padding: 12px 20px; font-size: 14px; top: 85px; /* Adjusted for sticky progress */ width: calc(100% - 30px); max-width: 400px; }
             @keyframes slideDownFadeInWarn { from { opacity: 0; top: 65px; } to { opacity: 1; top: 85px; } }
             @keyframes fadeOutUpWarn { from { opacity: 1; top: 85px; } to { opacity: 0; top: 65px; } }
             .metaphor-section input[type="text"] { padding: 8px; font-size: 13px; }
        }
        @media (max-width: 480px) {
             #sticky-progress-container { top: 48px; /* Assume nav height doesn't change drastically */ }
             h1 { font-size: 20px; } h2 { font-size: 1.3em; } h3 { font-size: 1.1em; }
             .container { padding: 15px; margin: 10px auto 15px; }
             .floating-warning { padding: 10px 15px; font-size: 13px; min-width: 260px; top: 80px; /* Adjusted */ }
             @keyframes slideDownFadeInWarn { from { opacity: 0; top: 60px; } to { opacity: 1; top: 80px; } }
             @keyframes fadeOutUpWarn { from { opacity: 1; top: 80px; } to { opacity: 0; top: 60px; } }
             .metaphor-section input[type="text"] { font-size: 12px; }
             .button-group { gap: 8px; }
        }
    </style>
</head>
<body>
    <!-- User Info Bar (Original Structure) -->
    <div class="user-bar">
        <div class="user-info">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path> <circle cx="12" cy="7" r="4"></circle> </svg>
            <div class="user-details">
                <span class="user-name" id="userName">Loading...</span>
                <span class="user-email" id="userEmail"></span>
            </div>
        </div>
        <button class="logout-button" onclick="logout()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path> <polyline points="16 17 21 12 16 7"></polyline> <line x1="21" y1="12" x2="9" y2="12"></line> </svg>
            Logout
        </button>
    </div>

    <!-- Navigation Tabs (Original Structure and Sticky) -->
    <nav class="nav-tab">
        <a href="dashboard.html">Dashboard</a>
        <a href="index.html">Home</a>
        <a href="introduction.html">Introduction</a>
        <a href="coaching-skills.html" class="active">Coaching Skills</a>
        <a href="coaching-individuals.html">Coaching Individuals</a>
        <a href="coaching-team.html">Team Coaching</a>
        <a href="coaching-yourself.html">Self Coaching</a>
        <a href="action-plan.html">Action Plan</a>
        <a href="ass.html">Assessment</a>
    </nav>

    <!-- Sticky Progress Bar -->
    <div id="sticky-progress-container">
        <div id="sticky-progress-bar-wrapper">
            <div id="sticky-progress-bar">
                <span id="sticky-progress-text">Progress: 0%</span>
            </div>
        </div>
    </div>

    <h1>1. Coaching Skills</h1>

    <!-- Floating Warning Message -->
    <div class="floating-warning" id="warningMessage"></div>

    <div class="container"> <!-- Content Starts Here -->
        <!-- Highlight Section -->
        <div class="highlight-section">
            <p>Feedback from people who have received coaching suggests that a coach's most important attributes are personal rapport, confidence, and a sense of humor.</p>
            <p>A report by the International Coaching Federation shows that thousands of coaching clients valued rapport and compatibility more highly than a coach's formal education, or his or her years of experience.</p>
            <p>This gives you an advantage – because, as a manager, you already have good working relationships with your team members.</p>
        </div>

        <!-- Skills List Section -->
        <div class="skills-list">
             <p>But coaching requires other important skills, too. These include:</p>
            <ul>
                <li>Listening</li>
                <li>Communicating</li>
                <li>Questioning</li>
                <li>Emotional intelligence</li>
                <li>Developing trust</li>
            </ul>
            <p>In this chapter, we'll look at these skills in more detail, and discuss how you can improve each one.</p>
        </div>

        <!-- Quote -->
        <div class="quote">
             <p>"A coach is someone who tells you what you don't want to hear, and has you see what you don't want to see, so you can be who you have always known you can be."</p>
            <p style="text-align: right;"><em>- Tom Landry</em></p>
        </div>

        <!-- Image Container - Active Listening -->
        <div class="image-container">
             <img src="https://images.unsplash.com/photo-1517048676732-d65bc937f952?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80"
                 alt="Two colleagues actively listening and engaging in a coaching conversation in a modern office setting"
                 onerror="this.onerror=null; this.src='https://via.placeholder.com/800x450/3498db/ffffff?text=Active+Listening';">
            <p class="caption">Developing active listening skills is crucial for effective coaching.</p>
        </div>

        <h2>1.1. Improving Your Listening Skills</h2>
        <p>The ability to listen well is the most important coaching skill...</p>
        <p>Specifically, you need good <strong>active listening</strong> skills...</p>
        <p>Show you're listening with subtle cues...</p>
        <p><strong>Empathic listening</strong> goes further...</p>
        <p><strong>Mindful listening</strong> involves listening without judgment...</p>

        <div class="tip-box">
            <strong>TIP:</strong> Regularly assess your listening skills...
        </div>
        <div class="action-box">
            <strong>ACTION:</strong> Practice active listening and reflect...
        </div>

        <!-- Listening Question 1 -->
        <div class="question-box" id="question-container-listen-q1">
            <h3>Did the other person's body language align...?<span class="required-star">*</span></h3>
            <textarea placeholder="Write your observations here..." class="required-answer editable-answer" data-question="listen-q1"></textarea>
            <div class="button-group">
                <button class="save-button" onclick="saveAnswer('listen-q1')">Save</button>
                <button class="delete-button" onclick="deleteAnswer('listen-q1')">Delete</button>
                <span class="error-message" id="error-listen-q1"></span>
            </div>
            <span class="save-status" id="save-status-listen-q1">Saved ✅</span>
        </div>

         <!-- Listening Question 2 -->
        <div class="question-box" id="question-container-listen-q2">
            <h3>Did active listening help you understand...?<span class="required-star">*</span></h3>
            <textarea placeholder="Explain how active listening impacted..." class="required-answer editable-answer" data-question="listen-q2"></textarea>
            <div class="button-group">
                <button class="save-button" onclick="saveAnswer('listen-q2')">Save</button>
                <button class="delete-button" onclick="deleteAnswer('listen-q2')">Delete</button>
                <span class="error-message" id="error-listen-q2"></span>
            </div>
             <span class="save-status" id="save-status-listen-q2">Saved ✅</span>
        </div>

         <!-- Listening Question 3 -->
        <div class="question-box" id="question-container-listen-q3">
            <h3>How could active listening improve your relationships...?<span class="required-star">*</span></h3>
            <textarea placeholder="Reflect on the potential benefits..." class="required-answer editable-answer" data-question="listen-q3"></textarea>
            <div class="button-group">
                <button class="save-button" onclick="saveAnswer('listen-q3')">Save</button>
                <button class="delete-button" onclick="deleteAnswer('listen-q3')">Delete</button>
                <span class="error-message" id="error-listen-q3"></span>
            </div>
             <span class="save-status" id="save-status-listen-q3">Saved ✅</span>
        </div>

        <h2>1.2. Developing Good Communication Skills</h2>
        <p>Effective coaches communicate thoughts and ideas clearly...</p>
        <div class="image-container">
             <img src="https://images.unsplash.com/photo-1434030216411-0b793f4b4173?ixlib=rb-1.2.1&auto=format&fit=crop&w=1170&q=80" alt="Communication" onerror="this.onerror=null; this.src='https://via.placeholder.com/800x450/e67e22/ffffff?text=Clear+Communication';">
            <p class="caption">Clear, objective communication is vital...</p>
        </div>
        <div class="quote">
             <p><strong>Example Scenario (with Assumptions):</strong></p>
             <!-- ... scenario ... -->
             <p><strong>Rahma (Coach):</strong> So tell me what happened this week.</p>
            <p><strong>Mohamed (Coachee):</strong> I just couldn't find the time to read that leadership development book or work on the exercises.</p>
            <p><strong>Rahma:</strong> Was it your boss again? Did he add more to your workload? <em>(Assumption/Leading Question)</em></p>
            <p><strong>Mohamed:</strong> Yes, he did.</p>
            <p><strong>Rahma:</strong> That probably made you feel stressed and unappreciated, right? <em>(Assumption/Leading Question)</em></p>
            <p><strong>Mohamed:</strong> Yes, it doesn't make me feel good when he does that...</p>
        </div>
        <p>This example shows how easily assumptions influence conversations...</p>
        <p>Pay close attention to the metaphors your coachee uses...</p>
        <ul>
            <li>"And when you are [metaphor]...?"</li>
            <li>"And is there anything else about that [metaphor/word]?"</li>
            <li>"And where could [metaphor/word] come from?"</li>
            <li>"And what happens next?"</li>
        </ul>
        <div class="tip-box"><strong>TIP:</strong> Explore resources on Clean Language...</div>
        <div class="action-box"><strong>ACTION:</strong> Pay attention to the metaphors *you* use...</div>

        <!-- Metaphor Section -->
        <div class="metaphor-section" id="metaphor-input-section">
             <h3>Metaphors You Use<span class="required-star">*</span> (Fill at least 2)</h3>
             <!-- Metaphor Entry 1 -->
             <div class="metaphor-entry" id="metaphor-container-m1">
                 <label for="m1" class="sr-only">Metaphor #1</label>
                 <input type="text" id="m1" class="required-answer metaphor-input editable-answer" placeholder="Enter metaphor #1 here..." data-question="m1" aria-describedby="error-m1">
                 <div class="button-group">
                     <button class="save-button" onclick="saveAnswer('m1')">Save</button>
                     <button class="delete-button" onclick="deleteAnswer('m1')">Delete</button>
                     <span class="error-message" id="error-m1"></span>
                 </div>
                  <span class="save-status" id="save-status-m1">Saved ✅</span>
             </div>
             <!-- Metaphor Entry 2 -->
              <div class="metaphor-entry" id="metaphor-container-m2">
                 <label for="m2" class="sr-only">Metaphor #2</label>
                 <input type="text" id="m2" class="required-answer metaphor-input editable-answer" placeholder="Enter metaphor #2 here..." data-question="m2" aria-describedby="error-m2">
                 <div class="button-group">
                     <button class="save-button" onclick="saveAnswer('m2')">Save</button>
                     <button class="delete-button" onclick="deleteAnswer('m2')">Delete</button>
                     <span class="error-message" id="error-m2"></span>
                 </div>
                   <span class="save-status" id="save-status-m2">Saved ✅</span>
             </div>
             <!-- Metaphor Entry 3 -->
              <div class="metaphor-entry" id="metaphor-container-m3">
                 <label for="m3" class="sr-only">Metaphor #3 (Optional)</label>
                 <input type="text" id="m3" class="metaphor-input editable-answer" placeholder="Optional: Enter another metaphor..." data-question="m3" aria-describedby="error-m3">
                 <div class="button-group">
                     <button class="save-button" onclick="saveAnswer('m3')">Save</button>
                     <button class="delete-button" onclick="deleteAnswer('m3')">Delete</button>
                     <span class="error-message" id="error-m3"></span>
                 </div>
                   <span class="save-status" id="save-status-m3">Saved ✅</span>
             </div>
             <p class="note">Note: You need to enter and save at least 2 metaphors...</p>
        </div>

        <div class="action-box"><strong>ACTION:</strong> Practice the Clean Language technique... (No submission).</div>

        <h2>1.3. Asking Better Questions</h2>
        <p>Great coaches listen more than they talk...</p>
        <div class="tip-box"><strong>TIP:</strong> Techniques like the <strong>5 Whys</strong>...</div>

        <h2>1.4. Learning Emotional Intelligence</h2>
        <p><strong>Emotional intelligence (EI)</strong> is the ability to recognize...</p>
        <div class="ei-elements">
            <p><strong>The Five Key Elements...</strong></p>
            <ol><li>Self-Awareness...</li><li>Self-Regulation...</li><li>Motivation...</li><li>Empathy...</li><li>Social Skills...</li></ol>
        </div>
        <div class="action-box"><strong>ACTION:</strong> Use the exercises below...</div>

        <!-- EI Question 1 -->
        <div class="question-box" id="question-container-eq1">
            <h3>Think about your reactions in stressful situations...<span class="required-star">*</span></h3>
            <textarea placeholder="Reflect on your stress responses..." class="required-answer editable-answer" data-question="eq1"></textarea>
            <div class="button-group">
                <button class="save-button" onclick="saveAnswer('eq1')">Save</button>
                <button class="delete-button" onclick="deleteAnswer('eq1')">Delete</button>
                <span class="error-message" id="error-eq1"></span>
            </div>
             <span class="save-status" id="save-status-eq1">Saved ✅</span>
        </div>

        <!-- EI Question 2 -->
        <div class="question-box" id="question-container-eq2">
            <h3>Recall a time you felt you lost emotional control...<span class="required-star">*</span></h3>
            <textarea placeholder="Describe the situation..." class="required-answer editable-answer" data-question="eq2"></textarea>
            <div class="button-group">
                <button class="save-button" onclick="saveAnswer('eq2')">Save</button>
                <button class="delete-button" onclick="deleteAnswer('eq2')">Delete</button>
                <span class="error-message" id="error-eq2"></span>
            </div>
            <span class="save-status" id="save-status-eq2">Saved ✅</span>
        </div>

        <!-- SWOT Analysis Questions -->
        <div class="question-box" id="question-container-swot">
            <h3>Conduct a Personal SWOT Analysis...<span class="required-star">*</span></h3>
            <p><strong>Your Strengths:</strong> (...)</p>
            <textarea placeholder="List your key strengths..." class="required-answer editable-answer" data-question="swot-strengths"></textarea>
            <div class="button-group">
                <button class="save-button" onclick="saveAnswer('swot-strengths')">Save</button>
                <button class="delete-button" onclick="deleteAnswer('swot-strengths')">Delete</button>
                <span class="error-message" id="error-swot-strengths"></span>
            </div>
            <span class="save-status" id="save-status-swot-strengths">Saved ✅</span>

            <p><strong>How can you leverage these strengths...?</strong><span class="required-star">*</span></p>
            <textarea placeholder="Explain how you'll consciously use..." class="required-answer editable-answer" data-question="swot-ideas"></textarea>
            <div class="button-group">
                <button class="save-button" onclick="saveAnswer('swot-ideas')">Save</button>
                <button class="delete-button" onclick="deleteAnswer('swot-ideas')">Delete</button>
                <span class="error-message" id="error-swot-ideas"></span>
            </div>
             <span class="save-status" id="save-status-swot-ideas">Saved ✅</span>

            <p><strong>Your Weaknesses:</strong> (...)</p>
            <textarea placeholder="Identify areas for improvement..." class="required-answer editable-answer" data-question="swot-weaknesses"></textarea>
            <div class="button-group">
                <button class="save-button" onclick="saveAnswer('swot-weaknesses')">Save</button>
                <button class="delete-button" onclick="deleteAnswer('swot-weaknesses')">Delete</button>
                <span class="error-message" id="error-swot-weaknesses"></span>
            </div>
             <span class="save-status" id="save-status-swot-weaknesses">Saved ✅</span>

            <p><strong>How might these weaknesses affect coaching...?</strong><span class="required-star">*</span></p>
            <textarea placeholder="Analyze the impact..." class="required-answer editable-answer" data-question="swot-thoughts"></textarea>
            <div class="button-group">
                <button class="save-button" onclick="saveAnswer('swot-thoughts')">Save</button>
                <button class="delete-button" onclick="deleteAnswer('swot-thoughts')">Delete</button>
                <span class="error-message" id="error-swot-thoughts"></span>
            </div>
             <span class="save-status" id="save-status-swot-thoughts">Saved ✅</span>
        </div>

        <h2>1.5. Building Trust</h2>
        <p>Trust and confidentiality are the absolute cornerstones...</p>
        <div class="trust-methods">
             <p><strong>Key Ways to Build and Maintain Trust:</strong></p>
             <ul><li>Be Honest...</li><li>Maintain Confidentiality...</li><li>Show Genuine Care...</li><li>Be Reliable...</li><li>Share Appropriately...</li><li>Demonstrate Competence...</li><li>Uphold Ethical Standards...</li></ul>
        </div>
        <div class="tip-box"><strong>TIP:</strong> View difficult conversations...</div>
        <div class="action-box"><strong>ACTION:</strong> Consider committing to daily journaling... (No submission).</div>
        <div class="action-box"><strong>ACTION:</strong> Reflect on this chapter's topics...</div>

        <!-- Final Question 1 -->
        <div class="question-box" id="question-container-final-q1">
            <h3>Which coaching skill... most challenging...?<span class="required-star">*</span></h3>
            <textarea placeholder="Identify your biggest challenge..." class="required-answer editable-answer" data-question="final-q1"></textarea>
            <div class="button-group">
                <button class="save-button" onclick="saveAnswer('final-q1')">Save</button>
                <button class="delete-button" onclick="deleteAnswer('final-q1')">Delete</button>
                <span class="error-message" id="error-final-q1"></span>
            </div>
            <span class="save-status" id="save-status-final-q1">Saved ✅</span>
        </div>

        <!-- Final Question 2 -->
        <div class="question-box" id="question-container-final-q2">
            <h3>Based on your reflections... what are 1-2 specific steps...?<span class="required-star">*</span></h3>
            <textarea placeholder="Outline concrete, measurable steps..." class="required-answer editable-answer" data-question="final-q2"></textarea>
            <div class="button-group">
                <button class="save-button" onclick="saveAnswer('final-q2')">Save</button>
                <button class="delete-button" onclick="deleteAnswer('final-q2')">Delete</button>
                <span class="error-message" id="error-final-q2"></span>
            </div>
            <span class="save-status" id="save-status-final-q2">Saved ✅</span>
        </div>
         <p class="note">Note: Fields marked with <span class="required-star">*</span> are required to proceed...</p>

        <h2>1.6. Drawing This Together</h2>
        <p>In this chapter, we explored the essential skills...</p>
        <div class="image-container">
             <img src="https://images.unsplash.com/photo-1552664730-d307ca884978?ixlib=rb-1.2.1&auto=format&fit=crop&w=1170&q=80" alt="Collaboration" onerror="this.onerror=null; this.src='https://via.placeholder.com/800x450/27ae60/ffffff?text=Coaching+Relationship+and+Process';">
            <p class="caption">Building strong coaching relationships...</p>
        </div>

        <!-- Navigation -->
        <div class="navigation-buttons">
            <a href="introduction.html" class="nav-button back">← Back to Introduction</a>
            <a href="coaching-individuals.html" class="nav-button" id="nextButton">Next: Coaching Individuals →</a>
        </div>
    </div><!-- /.container -->

    <script>
        // --- Supabase Configuration ---
        const SUPABASE_URL = 'https://lgcutmuspcaralydycmg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnY3V0bXVzcGNhcmFseWR5Y21nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0NDY3MDEsImV4cCI6MjA2MTAyMjcwMX0.3u5Y7pkH2NNnnoGLMWVfAa5b8fq88o1itRYnG1K38tE';
        let supabase = null;

        // --- Configuration ---
        const localStorageAnswersKey = 'allUserAnswers_coachingSkills';
        const SECTION_ID = 'skills';
        const PAGE_NAME = 'coaching-skills.html';

        // --- Unified Keys ---
        const LOGGED_IN_KEY = 'isUserLoggedIn';
        const CURRENT_USER_KEY = 'currentUser';
        const REQUIRED_METAPHOR_COUNT = 2;

        // --- Required Question IDs for Progress Bar ---
        const requiredQuestionIds = [
            'listen-q1', 'listen-q2', 'listen-q3',
            'm1', 'm2', // Metaphors 1 and 2 are required
            'eq1', 'eq2',
            'swot-strengths', 'swot-ideas', 'swot-weaknesses', 'swot-thoughts',
            'final-q1', 'final-q2'
        ];


        // Initialize Supabase Client
        try {
            if (window.supabase && window.supabase.createClient) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log(`Supabase client initialized successfully on ${PAGE_NAME}.`);
            } else { throw new Error("Supabase library not found."); }
        } catch (error) { console.error("CRITICAL ERROR initializing Supabase:", error); }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
             console.log(`%c${PAGE_NAME}: DOMContentLoaded event fired.`, "color: green;");
             if (!supabase) {
                 console.error(`Supabase client failed to initialize on ${PAGE_NAME}. Some features might not work.`);
             }

             const currentUser = getCurrentUser();
              if (!currentUser || !currentUser.id || !currentUser.email) {
                 console.error(`%c${PAGE_NAME}: User not logged in or essential data missing. Redirecting...`, "color: red;");
                  if (!window.location.search.includes('redir_attempt')) { window.location.href = `login.html?redirect=${encodeURIComponent(window.location.pathname + window.location.search)}&redir_attempt=1`; }
                  else { console.error("REDIRECTION LOOP DETECTED."); document.body.innerHTML = '<p style="color: red; padding: 20px;">Login check failed repeatedly.</p>'; }
                 return;
             }
             console.log(`%c${PAGE_NAME}: User validated (${currentUser.email}, ID: ${currentUser.id}). Initializing.`, "color: green;");
             displayUserInfo();
             loadUserAnswers(currentUser); // Loads answers and sets UI states
             updateStickyProgressBar();    // Calculate initial progress AFTER loading answers
             setupEventListeners(currentUser);
             highlightActiveNav();
             console.log(`%c${PAGE_NAME}: Initialization complete.`, "color: blue;");
        });

        // --- User Info & Auth ---
        function getCurrentUser() { try { const d = localStorage.getItem(CURRENT_USER_KEY); if (!d) return null; const p = JSON.parse(d); if (p && typeof p === 'object' && p.email && p.name && p.id) { if (typeof p.progress !== 'object' || p.progress === null) p.progress = {}; return p; } else { localStorage.removeItem(CURRENT_USER_KEY); localStorage.removeItem(LOGGED_IN_KEY); return null; } } catch (e) { console.error("GUC Error:", e); localStorage.removeItem(CURRENT_USER_KEY); localStorage.removeItem(LOGGED_IN_KEY); return null; } }
        function saveCurrentUser(userObject) { try { if (!userObject || typeof userObject !== 'object') throw new Error("Invalid user object"); localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(userObject)); /* console.log("Saved user data."); */ } catch (error) { console.error("SCU Error:", error); } }
        function displayUserInfo() { const u=getCurrentUser(); if(u){document.getElementById('userName').textContent=`Welcome, ${u.name || u.email.split('@')[0]}`; document.getElementById('userEmail').textContent=u.email;}else{console.warn("DIU: No user");}}
        function logout() { localStorage.removeItem(LOGGED_IN_KEY); localStorage.removeItem(CURRENT_USER_KEY); localStorage.removeItem(localStorageAnswersKey); window.location.href = 'login.html';}
        function highlightActiveNav() { const cP=window.location.pathname.split('/').pop()||PAGE_NAME; document.querySelectorAll('.nav-tab a').forEach(l=>{const lP=(l.getAttribute('href')||'').split('/').pop(); l.classList.toggle('active',lP===cP);});}

        // --- Answer Handling ---
        function loadUserAnswers(currentUser) {
             if (!currentUser || !currentUser.email) return;
             let allAnswers = {};
             try { const d = localStorage.getItem(localStorageAnswersKey); if (d) allAnswers = JSON.parse(d) || {}; }
             catch (e) { console.error("Load Answers Error:", e); }
             const userAnswers = allAnswers[currentUser.email] || {};

             // Add class 'editable-answer' to metaphor inputs for easier selection
             document.querySelectorAll('.editable-answer, .metaphor-input').forEach(field => {
                 const questionId = field.dataset.question;
                 if (questionId) {
                     loadFieldState(field, questionId, userAnswers);
                 }
             });
             // updateStickyProgressBar() called after this in DOMContentLoaded
        }

        // Modified loadFieldState for 'Save Once' with Persistent Status
        function loadFieldState(field, questionId, userAnswers) {
            if (!field) return;
            const errorId = `error-${questionId}`;
            const statusId = `save-status-${questionId}`;
            const statusElement = document.getElementById(statusId);
            const buttonGroup = field.closest('.metaphor-entry, .question-box')?.querySelector('.button-group'); // Find in container
            const saveButton = buttonGroup?.querySelector('.save-button');
            const deleteButton = buttonGroup?.querySelector('.delete-button');

            hideError(errorId);
            if (statusElement) statusElement.style.display = 'none';


            if (userAnswers[questionId] !== undefined && userAnswers[questionId] !== null && String(userAnswers[questionId]).trim() !== '') {
                // --- Saved Answer Found ---
                field.value = userAnswers[questionId];
                field.disabled = true;
                field.classList.remove('required-field');

                if (buttonGroup) {
                    buttonGroup.style.display = 'none';
                }
                if (statusElement) {
                    statusElement.textContent = 'Saved ✅';
                    statusElement.style.display = 'inline-block';
                    statusElement.classList.remove('deleted');
                    statusElement.style.color = '#27ae60';
                }

            } else {
                // --- No Saved Answer ---
                 field.value = ''; // Clear just in case
                 field.disabled = false;
                 field.classList.remove('required-field');

                if (buttonGroup) {
                    buttonGroup.style.display = 'flex';
                    if (saveButton) { saveButton.disabled = false; saveButton.textContent = 'Save'; }
                    if (deleteButton) { deleteButton.disabled = false; deleteButton.style.display = 'inline-block'; }
                }
                if (statusElement) {
                    statusElement.style.display = 'none';
                }
            }
        }


        function saveAnswerToStorage(userEmail, questionId, answer) { if(!userEmail) return false; let a={}; try{const d=localStorage.getItem(localStorageAnswersKey); if(d) a=JSON.parse(d)||{};}catch(e){a={};} if(!a[userEmail]) a[userEmail]={}; a[userEmail][questionId]=answer; try{localStorage.setItem(localStorageAnswersKey,JSON.stringify(a)); return true;} catch(e){console.error("Save Storage Err:",e); return false;} }
        function deleteAnswerFromStorage(userEmail, questionId) { if(!userEmail) return false; let a={}; try{const d=localStorage.getItem(localStorageAnswersKey); if(d) a=JSON.parse(d)||{}; else return false;} catch(e){return false;} let u=false; if(a[userEmail]?.[questionId]!==undefined){delete a[userEmail][questionId]; u=true; if(Object.keys(a[userEmail]).length===0) delete a[userEmail];} if(u){try{localStorage.setItem(localStorageAnswersKey,JSON.stringify(a)); return true;}catch(e){return false;}} return false; }

        // --- Event Listeners ---
        function setupEventListeners(currentUser) {
             if (!currentUser?.email) return;
             // Add 'editable-answer' class to metaphor inputs for listener
             document.querySelectorAll('.metaphor-input').forEach(el => el.classList.add('editable-answer'));

             document.querySelectorAll('.editable-answer').forEach(field => {
                 field.addEventListener('input', function() {
                     const questionId = this.dataset.question;
                     if (questionId) {
                         hideError(`error-${questionId}`);
                         if (this.value.trim() !== '') this.classList.remove('required-field');
                         if (!this.disabled) {
                            const buttonGroup = this.closest('.metaphor-entry, .question-box')?.querySelector('.button-group');
                            const saveButton = buttonGroup?.querySelector('.save-button');
                            if(saveButton) saveButton.disabled = false;
                         }
                     }
                 });
             });
             const nextButton = document.getElementById('nextButton');
             if (nextButton) { nextButton.addEventListener('click', function(e) { if (!validateAllAnswers(true)) { e.preventDefault(); showWarningMessage(); } }); }
        }


        // --- UI Feedback & Validation ---
        function validateAllAnswers(showErrors = false) {
             let allValid = true;
             let firstInvalidField = null;
             console.log(`Running validation (Show Errors: ${showErrors})`);
             hideWarningMessage();

             // Check all required fields using the array
             requiredQuestionIds.forEach(qId => {
                 const field = document.querySelector(`[data-question="${qId}"]`);
                 if (field) {
                     const eId = `error-${qId}`;
                     hideError(eId);
                     field.classList.remove('required-field');

                     if (!field.disabled && field.value.trim() === '') {
                         allValid = false;
                         if (showErrors) {
                            if (qId === 'm1' || qId === 'm2') {
                                showError(eId, field, `Metaphor required (Need ${REQUIRED_METAPHOR_COUNT} total).`);
                            } else {
                                showError(eId, field);
                            }
                         }
                         if (!firstInvalidField) firstInvalidField = field;
                     }
                 } else {
                      console.warn(`Required field ${qId} not found in DOM!`);
                      allValid = false;
                 }
             });

            // Extra check specifically for metaphor COUNT
             if (!checkMetaphorGroupCompletion()) { // Check based on localStorage
                  allValid = false;
                  console.log("Metaphor count validation failed.");
                  if (showErrors) {
                       // Try to find first empty required metaphor to highlight again
                       const m1Field = document.querySelector('[data-question="m1"]');
                       const m2Field = document.querySelector('[data-question="m2"]');
                       if (m1Field && !m1Field.disabled && m1Field.value.trim() === '') {
                           if (!firstInvalidField) firstInvalidField = m1Field;
                           showError('error-m1', m1Field, `Metaphor required (Need ${REQUIRED_METAPHOR_COUNT} total).`);
                       } else if (m2Field && !m2Field.disabled && m2Field.value.trim() === '') {
                           if (!firstInvalidField) firstInvalidField = m2Field;
                           showError('error-m2', m2Field, `Metaphor required (Need ${REQUIRED_METAPHOR_COUNT} total).`);
                       } else if (!firstInvalidField) {
                           // If required are filled, but count is low (e.g., only m1 filled, m2 empty but disabled?), show general warning
                           showWarningMessage(`Metaphor requirement not met (need at least ${REQUIRED_METAPHOR_COUNT} saved).`);
                           if(m1Field) firstInvalidField = m1Field; // Focus first one anyway
                       }
                  }
             }


             if (!allValid && showErrors && firstInvalidField) {
                 firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                 setTimeout(() => { try { firstInvalidField.focus({ preventScroll: true }); } catch(e){} }, 350);
                 showWarningMessage();
             } else if (!allValid && showErrors) {
                  showWarningMessage();
             }

             console.log("Validation result:", allValid);
             return allValid;
        }


        function showWarningMessage(message = "Please complete all required fields marked with *.") { const w=document.getElementById('warningMessage'); if(!w) return; w.innerHTML=`<strong>Action Required:</strong> ${message}`; w.style.animation='none'; void w.offsetWidth; w.style.display='block'; w.style.animation='slideDownFadeInWarn 0.4s ease-out'; clearTimeout(w.timer); w.timer=setTimeout(()=>{w.style.animation='fadeOutUpWarn 0.5s ease-out forwards'; setTimeout(()=>{if(w.style.animationName==='fadeOutUpWarn'){w.style.display='none'; w.style.animation='';}},500);},4000); }
        function hideWarningMessage() { const w=document.getElementById('warningMessage'); if(w && w.style.display !== 'none'){ w.style.animation='fadeOutUpWarn 0.5s ease-out forwards'; setTimeout(()=>{if(w.style.animationName==='fadeOutUpWarn'){w.style.display='none'; w.style.animation='';}},500);}}
        function showError(errorId, field, message = 'This field is required.') { const e=document.getElementById(errorId); if(e){e.textContent=message; e.style.display='inline-block';} if(field) field.classList.add('required-field');}
        function hideError(errorId) { const e=document.getElementById(errorId); if(e) e.style.display='none';}
        function hideMessages(statusId, errorId, field) {
             hideError(errorId);
             const s = statusId ? document.getElementById(statusId) : null; if(s)s.style.display='none';
             if (field) field.classList.remove('required-field');
         }


        // --- Actions (Save, Delete) ---
        // Modified saveAnswer for 'Save Once' behavior
        window.saveAnswer = async function(questionId) {
            if (!supabase) { alert('Database connection error. Cannot save.'); return; }
            const currentUser = getCurrentUser();
            if (!currentUser || !currentUser.email || !currentUser.id) { alert('Session expired.'); window.location.href = 'login.html'; return; }

            const field = document.querySelector(`[data-question="${questionId}"]`);
            const questionContainer = field?.closest('.question-box') || field?.closest('.metaphor-entry');
            const errorId = `error-${questionId}`;
            const statusId = `save-status-${questionId}`;
            const statusElement = document.getElementById(statusId);
            const buttonGroup = questionContainer?.querySelector('.button-group');
            const saveButton = buttonGroup?.querySelector('.save-button');
            const deleteButton = buttonGroup?.querySelector('.delete-button');

            if (!field || !questionContainer || !buttonGroup || !saveButton || !deleteButton) {
                console.error("Save Error: Required elements missing for", questionId); return;
            }
            if (field.disabled) { console.warn("Attempted to save already saved question:", questionId); return; }

            const answer = field.value;
            const trimmedAnswer = answer.trim();
            const isRequired = field.classList.contains('required-answer');

            hideMessages(statusId, errorId, field);

            if (isRequired && trimmedAnswer === '') {
                 showError(errorId, field);
                 updateStickyProgressBar(); // Update progress
                 return;
            }

            saveButton.disabled = true; saveButton.textContent = 'Saving...';
            deleteButton.disabled = true;

            try {
                // ... (Get questionText logic - unchanged) ...
                let questionText = `Answer for ${questionId}`; const isMetaphor = field.classList.contains('metaphor-input');
                if(isMetaphor){questionText=`Metaphor #${questionId.substring(1)}`;}else{const h3=questionContainer.querySelector('h3');const p_strong=field.previousElementSibling;if(h3){questionText=h3.textContent.replace('*','').trim();}else if(p_strong&&p_strong.tagName==='P'&&p_strong.querySelector('strong')){questionText=p_strong.textContent.trim();}}

                const submissionTime = new Date().toISOString();
                const userProgressPayload = { user_id:currentUser.id,email:currentUser.email,question_id:questionId,question_text:questionText,answer:answer,page:PAGE_NAME,status:'completed',submitted_at:submissionTime,updated_at:submissionTime,section_type:'article',section_id:SECTION_ID,section_title:document.title||'Coaching Skills',progress_percentage:100,score:null,is_passed:null};

                console.log("Attempting to upsert to user_progress:", userProgressPayload);
                const { data, error } = await supabase.from('user_progress').upsert([userProgressPayload], { onConflict: ['user_id', 'question_id'] }).select();
                if (error) throw new Error(`Supabase error: ${error.message}`);
                console.log("Supabase upsert successful:", data);

                // --- Update UI on SUCCESS ---
                field.disabled = true;
                field.classList.remove('required-field');
                if (buttonGroup) buttonGroup.style.display = 'none';
                if (statusElement) {
                    statusElement.textContent = 'Saved ✅';
                    statusElement.style.display = 'inline-block';
                } else { console.warn(`Save Success [${questionId}]: Status span #${statusId} not found.`); }

                saveAnswerToStorage(currentUser.email, questionId, answer);
                updateStickyProgressBar(); // Update overall progress bar

            } catch (error) {
                console.error(`Failed to save answer for ${questionId}:`, error);
                showError(errorId, field, `Save failed. Try again.`);
                if (buttonGroup) buttonGroup.style.display = 'flex';
                if(saveButton) { saveButton.disabled = false; saveButton.textContent = 'Save'; }
                if(deleteButton) { deleteButton.disabled = false; deleteButton.style.display = 'inline-block';}
                field.disabled = false;
                if (statusElement) statusElement.style.display = 'none';
                updateStickyProgressBar();
            }
        };

        // Modified deleteAnswer for 'Save Once' behavior
        window.deleteAnswer = function(questionId) {
            const field = document.querySelector(`[data-question="${questionId}"]`);
            if (!field) return;
            if (field.disabled) {
                 console.warn(`Attempted to delete saved/disabled answer: ${questionId}. Prevented.`);
                 const errorId = `error-${questionId}`;
                 showError(errorId, null, "Saved answers cannot be deleted.");
                 setTimeout(() => hideError(errorId), 3000);
                 return;
            }
            const currentUser = getCurrentUser(); if (!currentUser?.email) return;
            const errorId = `error-${questionId}`;
            const statusId = `save-status-${questionId}`;
            const statusElement = document.getElementById(statusId);
            hideMessages(statusId, errorId, field);
            field.value = '';
            deleteAnswerFromStorage(currentUser.email, questionId);
            console.log("Cleared unsaved answer locally for", questionId);
            field.classList.remove('required-field');
            updateStickyProgressBar(); // Update progress
            // Ensure buttons are visible and enabled
            const buttonGroup = field.closest('.metaphor-entry, .question-box')?.querySelector('.button-group');
            if (buttonGroup) {
                buttonGroup.style.display = 'flex';
                const saveButton = buttonGroup.querySelector('.save-button');
                const deleteButton = buttonGroup.querySelector('.delete-button');
                if(saveButton) saveButton.disabled = false;
                if(deleteButton) deleteButton.disabled = false;
            }
        };

        // --- Sticky Progress Bar Function ---
        function updateStickyProgressBar() {
            const currentUser = getCurrentUser();
            if (!currentUser || !currentUser.email) { return; } // Exit if no user

            let allAnswers = {};
            try { const d = localStorage.getItem(localStorageAnswersKey); if (d) allAnswers = JSON.parse(d) || {}; }
            catch (e) { console.error("Progress Bar LS Error:", e); return; }
            const userAnswers = allAnswers[currentUser.email] || {};

            const totalRequired = requiredQuestionIds.length;
            if (totalRequired === 0) { return; } // Avoid division by zero

            let savedRequiredCount = 0;
            requiredQuestionIds.forEach(qId => {
                // Count based on non-empty answers in localStorage for required questions
                if (userAnswers[qId] !== undefined && userAnswers[qId] !== null && String(userAnswers[qId]).trim() !== '') {
                    savedRequiredCount++;
                }
            });

            const percentage = Math.round((savedRequiredCount / totalRequired) * 100);

            // Update UI
            const barElement = document.getElementById('sticky-progress-bar');
            const textElement = document.getElementById('sticky-progress-text');
            if (barElement && textElement) {
                barElement.style.width = `${percentage}%`;
                textElement.textContent = `Progress: ${percentage}%`;
            }

            // Update overall user progress in localStorage
            if (!currentUser.progress) currentUser.progress = {};
            currentUser.progress[SECTION_ID] = percentage;
            saveCurrentUser(currentUser);
             console.log(`Sticky Progress Updated: ${percentage}% (${savedRequiredCount}/${totalRequired})`);
        }

        // Helper to check metaphor completion based on localStorage
        function checkMetaphorGroupCompletion() {
             const currentUser = getCurrentUser(); if (!currentUser?.email) return false;
             let allAnswers = {};
             try { const d = localStorage.getItem(localStorageAnswersKey); if (d) allAnswers = JSON.parse(d) || {}; }
             catch (e) { return false; }
             const userAnswers = allAnswers[currentUser.email] || {};
             let metaphorCount = 0;
             // Count saved required metaphors (m1, m2) plus any saved optional (m3)
             ['m1', 'm2', 'm3'].forEach(qId => {
                  if (userAnswers[qId] && userAnswers[qId].trim() !== '') {
                     metaphorCount++;
                 }
             });
             return metaphorCount >= REQUIRED_METAPHOR_COUNT; // Check if count is 2 or more
         }

    </script>
</body>
</html>
