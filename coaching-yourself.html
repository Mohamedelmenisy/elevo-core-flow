<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Self Coaching</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            line-height: 1.6;
            background-color: #f9f9f9;
            color: #333;
        }

        /* User Bar Styles */
        .user-bar {
            background-color: #34495e;
            padding: 10px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-size: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            font-size: 15px;
        }

        .user-email {
            font-size: 13px;
            opacity: 0.8;
        }

        .logout-button {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .logout-button:hover { background-color: #c0392b; transform: translateY(-1px); }
        .logout-button:active { transform: translateY(0); }

        /* Navigation Tabs */
        .nav-tab {
            background-color: #2c3e50;
            padding: 10px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .nav-tab a {
            color: white; text-decoration: none; margin: 0 10px; padding: 5px 10px;
            border-radius: 4px; transition: background-color 0.3s;
        }
        .nav-tab a:hover { background-color: #34495e; }

        /* Main Content Styles */
        header {
            background-color: #2c3e50; color: white; padding: 20px;
            text-align: center; margin-bottom: 20px;
        }
        .container {
            max-width: 800px; margin: 0 auto 30px; background: white; padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 8px;
        }
        .section-title {
            color: #3498db; font-size: 1.5em; margin: 25px 0 15px 0;
            border-bottom: 2px solid #3498db; padding-bottom: 8px;
        }
        .highlight-section {
            background-color: rgba(230, 126, 34, 0.1); padding: 15px;
            border-left: 4px solid #e67e22; border-radius: 0 4px 4px 0; margin: 15px 0;
        }
        .action-card {
            background-color: #e67e22; color: white; padding: 20px;
            border-radius: 6px; margin: 20px 0;
        }
        .media-container { text-align: center; margin: 20px 0; }
        .media-container img { max-width: 100%; height: auto; border-radius: 6px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .caption { font-style: italic; color: #777; margin-top: 8px; font-size: 14px; }

        .question-item {
            background-color: #f8f9fa; padding: 15px; border-radius: 6px;
            margin: 15px 0; border-left: 4px solid #3498db;
        }
        .question-text { color: #2c3e50; font-weight: bold; margin-bottom: 10px; }

         /* Unified class for all answer fields */
        .editable-answer {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px 0;
            background-color: white;
            min-height: 40px;
            line-height: 1.5;
            display: block;
            font-size: 14px;
        }
        /* Specific styles for textareas */
        textarea.editable-answer {
            min-height: 80px;
            resize: vertical;
        }
        .editable-answer:focus {
            outline: none; border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .save-btn {
            background-color: #27ae60; color: white; border: none; padding: 6px 12px;
            border-radius: 4px; cursor: pointer; transition: background-color 0.3s;
            margin-right: 5px; font-size: 13px;
        }
        .delete-btn {
            background-color: #e74c3c; color: white; border: none; padding: 6px 12px;
            border-radius: 4px; cursor: pointer; transition: background-color 0.3s;
            font-size: 13px;
        }
        .save-btn:hover { background-color: #219653; }
        .delete-btn:hover { background-color: #c0392b; }

        .saved-message { color: #27ae60; font-size: 12px; margin-left: 10px; display: none; font-style: italic; }
        .inline-error-message { color: #e74c3c; font-size: 12px; margin-left: 10px; display: none; font-style: italic; font-weight: 500; }

        table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 14px; }
        table, th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f2f2f2; font-weight: 600; }

        .action-card table { border: none; } /* Remove double border inside action card */
        .action-card th, .action-card td { border: 1px solid #e67e22; } /* Orange border inside action card */

        .button-container { display: flex; justify-content: space-between; margin-top: 30px; gap: 20px; }
        .button {
            background-color: #3498db; color: white; padding: 12px 20px; border-radius: 4px;
            text-decoration: none; font-weight: bold; border: none; cursor: pointer; flex: 1;
            text-align: center; transition: all 0.3s; font-size: 15px;
        }
        .button:hover { background-color: #2980b9; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .button:active { transform: translateY(0); box-shadow: none; }
        .button.back { background-color: #95a5a6; }
        .button.back:hover { background-color: #7f8c8d; }

        .warning-message { /* General warning */
            background-color: #fff8e1; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0;
            color: #333; display: none; font-size: 14px; line-height: 1.6; border-radius: 4px; font-weight: 500;
        }
        .required-field { /* Style for required fields */
            border: 2px solid #e74c3c !important; background-color: #fff2f2 !important;
            animation: pulse 1.5s infinite alternate ease-in-out;
        }
        @keyframes pulse { from { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.3); } to { box-shadow: 0 0 0 5px rgba(231, 76, 60, 0); } }

        @media (max-width: 600px) { .button-container { flex-direction: column; } }

        /* Section specific styles */
        .model-section, .trust-section, .rapport-section, .informal-tips {
            padding: 20px; border-radius: 6px; margin: 20px 0;
        }
        .model-section { background-color: rgba(52, 152, 219, 0.08); border-left: 4px solid #3498db; }
        .trust-section { background-color: rgba(46, 204, 113, 0.08); border-left: 4px solid #2ecc71; }
        .rapport-section { background-color: rgba(155, 89, 182, 0.08); border-left: 4px solid #9b59b6; }
        .informal-tips { background-color: rgba(241, 196, 15, 0.08); border-left: 4px solid #f1c40f; }

        .orange-row td { background-color: rgba(230, 126, 34, 0.05); }
        .orange-row .editable-answer { margin: 5px 0; } /* Consistent margin */

        .drawing-together {
            display: flex; align-items: center; gap: 20px; background-color: rgba(155, 89, 182, 0.08);
            padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #9b59b6;
        }
        .drawing-icon { font-size: 30px; color: #9b59b6; flex-shrink: 0; }

        .answer-buttons { display: flex; gap: 8px; align-items: center; margin-top: 8px; flex-wrap: wrap; }
        .table-action-buttons { margin-top: 15px; text-align: right; }

        /* Table specific header colors */
        .options-table th, .will-table th { color: white; }
        .options-table th:nth-child(1) { background-color: #3498db; } /* Blue */
        .options-table th:nth-child(2) { background-color: #2ecc71; } /* Green */
        .options-table th:nth-child(3) { background-color: #e74c3c; } /* Red */
        .will-table th:nth-child(1) { background-color: #3498db; } /* Blue */
        .will-table th:nth-child(2) { background-color: #9b59b6; } /* Purple */
        .will-table th:nth-child(3) { background-color: #e67e22; } /* Orange */

        /* Adjust delete button position in tables */
        .orange-row td .delete-btn, .options-table td .delete-btn, .will-table td .delete-btn {
            margin-left: auto; /* Push delete button to the right */
            margin-top: 5px; /* Add some top margin */
        }
         .orange-row td .answer-buttons, .options-table td .answer-buttons, .will-table td .answer-buttons {
            justify-content: flex-end; /* Align button group right */
         }
         .orange-row td:first-child .answer-buttons, .options-table td:first-child .answer-buttons, .will-table td:first-child .answer-buttons {
             justify-content: flex-start; /* Keep first column buttons left */
         }


        /* Modal Styles */
        .modal-overlay { /* Copied from previous example, seems fine */ }
        .modal-content { /* Copied from previous example, seems fine */ }
        .modal-button { /* Copied from previous example, seems fine */ }
        .close-modal { /* Copied from previous example, seems fine */ }
    </style>
</head>
<body>
    <!-- User Info Bar -->
    <div class="user-bar">
        <div class="user-info">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.8;">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <div class="user-details">
                <span class="user-name" id="userName">Welcome back</span>
                <span class="user-email" id="userEmail">user@example.com</span>
            </div>
        </div>
        <button class="logout-button" onclick="logout()">
             <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            Logout
        </button>
    </div>

    <!-- Navigation Tabs -->
    <nav class="nav-tab">
        <a href="index.html">Home</a>
        <a href="article1.html">Article 1</a>
        <a href="coaching-skills.html">Coaching Skills</a>
        <a href="coaching-individuals.html">Coaching Individuals</a>
        <a href="coaching-team.html">Team Coaching</a>
        <a href="coaching-yourself.html">Self Coaching</a>
    </nav>

    <header>
        <h1>Self Coaching</h1>
        <p>Applying coaching techniques for personal development</p>
    </header>

    <div class="container">
        <h2 class="section-title">4. Coaching Yourself</h2>

        <div class="highlight-section">
            <p>A coach's role is to solve problems, identify goals and put action plans into place. Once you've learned to use these skills, you can apply them to yourself, too.</p>
        </div>

        <p>As we've seen, the coaching process can boost your team members' confidence, build their self- awareness, and help to keep them motivated. So why stop there?</p>
        <p>Using the skills you've learned to coach yourself is a great way to "practice what you preach" with your team. And, as a role model, your people will be inspired to achieve their goals when they see you fulfilling yours.</p>

        <div class="media-container">
            <img src="https://images.unsplash.com/photo-1600880292203-757bb62b4baf?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80"
                 alt="Woman reviewing her personal development plan with coaching techniques"
                 loading="lazy">
            <p class="caption">Applying coaching techniques to your own development</p>
        </div>

        <h2 class="section-title">4.1. Identifying Your Strengths and Weaknesses</h2>
        <p>Before you begin any journey, you need to know your starting point. It's the same with coaching. When you begin to coach yourself, you have to understand your strengths and weaknesses.</p>
        <p>When you know what you're good at, you can use those strengths to achieve your goals. And when you identify your weakest areas, you can come up with strategies to address them, or to minimize their impact.</p>

        <!-- SWOT Analysis Action Card -->
        <div class="action-card">
            <h3>ACTION: Perform a personal SWOT analysis</h3>

            <table>
                <thead>
                    <tr>
                        <th style="background-color: #27ae60; color: white;">My Strengths</th>
                        <th style="background-color: #e74c3c; color: white;">My Weaknesses</th>
                    </tr>
                 </thead>
                 <tbody>
                    <!-- Row 1 -->
                    <tr class="orange-row">
                        <td>
                            <textarea class="editable-answer required-answer" data-question="strength1" placeholder="Enter your biggest strength..."></textarea>
                            <!-- Buttons removed from individual cells, moved to table-wide actions -->
                        </td>
                        <td>
                            <textarea class="editable-answer required-answer" data-question="weakness1" placeholder="Enter your biggest weakness..."></textarea>
                        </td>
                    </tr>
                     <!-- Row 2 -->
                    <tr class="orange-row">
                        <td>
                            <textarea class="editable-answer" data-question="strength2" placeholder="Enter another strength..."></textarea>
                        </td>
                        <td>
                            <textarea class="editable-answer" data-question="weakness2" placeholder="Enter another weakness..."></textarea>
                        </td>
                    </tr>
                    <!-- Row 3 -->
                    <tr class="orange-row">
                        <td>
                            <textarea class="editable-answer" data-question="strength3" placeholder="Enter another strength..."></textarea>
                        </td>
                        <td>
                            <textarea class="editable-answer" data-question="weakness3" placeholder="Enter another weakness..."></textarea>
                        </td>
                    </tr>
                 </tbody>
            </table>

            <div class="table-action-buttons">
                <button class="save-btn" onclick="saveTableData('swot')">Save SWOT Analysis</button>
                <button class="delete-btn" onclick="deleteTableData('swot')">Clear SWOT Analysis</button>
                <span class="saved-message" id="save-status-swot">✓ Saved</span>
                <span class="inline-error-message" id="error-swot">Strength 1 and Weakness 1 are required.</span>
            </div>
        </div>

        <!-- Reflection Question -->
        <div class="question-item">
            <div class="question-text">Reflection Questions: How do these strengths and weaknesses impact your professional development?</div>
            <!-- Use textarea, add required class -->
            <textarea class="editable-answer required-answer" data-question="reflection1" placeholder="Enter your reflection here..."></textarea>
            <div class="answer-buttons">
                <button class="save-btn" onclick="saveAnswer('reflection1')">Save Reflection</button>
                <button class="delete-btn" onclick="deleteAnswer('reflection1')">Delete Reflection</button>
                <span class="saved-message" id="save-status-reflection1">✓ Saved</span>
                <span class="inline-error-message" id="error-reflection1">Please enter an answer.</span>
            </div>
        </div>

        <div class="media-container">
            <img src="https://images.unsplash.com/photo-1454165804606-c3d57bc86b40?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80"
                 alt="Person analyzing their skills and competencies"
                 loading="lazy">
            <p class="caption">Honest self-assessment is the foundation of self-coaching</p>
        </div>

        <h2 class="section-title">4.2. The GROW Model</h2>
        <p>In Chapter 2, we discussed how to use The GROW Model in one-on-one coaching sessions. But you can use it to coach yourself, too.</p>
        <p>The GROW Model can help you to identify a goal and to decide on a plan of action to achieve it. If you use this model, be sure to set aside time each week to "check in" with yourself and assess your progress.</p>

        <!-- GROW Model Action Card -->
        <div class="action-card">
            <h3>ACTION: Use the GROW Model for Self-Coaching</h3>

            <!-- Step 1: Goal -->
            <div class="model-section">
                <h3>Step 1: Identify Your Goal</h3>
                <p>Your first step is to identify the goal that you want to achieve... Make sure your goal is SMART...</p>
                <div class="question-item">
                    <div class="question-text">My SMART Goal:</div>
                    <!-- Use textarea, add required class -->
                    <textarea class="editable-answer required-answer" data-question="smart-goal" placeholder="Enter your SMART goal here..."></textarea>
                    <div class="answer-buttons">
                        <button class="save-btn" onclick="saveAnswer('smart-goal')">Save Goal</button>
                        <button class="delete-btn" onclick="deleteAnswer('smart-goal')">Delete Goal</button>
                        <span class="saved-message" id="save-status-smart-goal">✓ Saved</span>
                        <span class="inline-error-message" id="error-smart-goal">Please enter an answer.</span>
                    </div>
                </div>
            </div>

            <!-- Step 2: Reality -->
            <div class="model-section">
                <h3>Step 2: Identify Your Current Reality</h3>
                <p>Next, look at your situation... Examine the factors that might help or hinder...</p>
                <div class="question-item">
                    <div class="question-text">Current Reality Assessment:</div>
                     <!-- Use textarea, add required class -->
                    <textarea class="editable-answer required-answer" data-question="current-reality" placeholder="Describe your current situation..."></textarea>
                    <div class="answer-buttons">
                        <button class="save-btn" onclick="saveAnswer('current-reality')">Save Assessment</button>
                        <button class="delete-btn" onclick="deleteAnswer('current-reality')">Delete Assessment</button>
                        <span class="saved-message" id="save-status-current-reality">✓ Saved</span>
                        <span class="inline-error-message" id="error-current-reality">Please enter an answer.</span>
                    </div>
                </div>
            </div>

            <!-- Step 3: Options -->
            <div class="model-section">
                <h3>Step 3: Explore the Options</h3>
                <p>Now, you need to think about how you will reach your goal...</p>
                <table class="options-table">
                     <thead>
                        <tr>
                            <th>Possible Options</th>
                            <th>Advantages</th>
                            <th>Disadvantages</th>
                        </tr>
                     </thead>
                     <tbody>
                         <!-- Row 1 -->
                        <tr class="orange-row">
                            <td><textarea class="editable-answer required-answer" data-question="option1" placeholder="Option 1..."></textarea></td>
                            <td><textarea class="editable-answer required-answer" data-question="pro1" placeholder="Pros..."></textarea></td>
                            <td><textarea class="editable-answer required-answer" data-question="con1" placeholder="Cons..."></textarea></td>
                        </tr>
                         <!-- Row 2 -->
                        <tr class="orange-row">
                            <td><textarea class="editable-answer" data-question="option2" placeholder="Option 2 (optional)..."></textarea></td>
                            <td><textarea class="editable-answer" data-question="pro2" placeholder="Pros (optional)..."></textarea></td>
                            <td><textarea class="editable-answer" data-question="con2" placeholder="Cons (optional)..."></textarea></td>
                        </tr>
                        <!-- Row 3 -->
                        <tr class="orange-row">
                            <td><textarea class="editable-answer" data-question="option3" placeholder="Option 3 (optional)..."></textarea></td>
                            <td><textarea class="editable-answer" data-question="pro3" placeholder="Pros (optional)..."></textarea></td>
                            <td><textarea class="editable-answer" data-question="con3" placeholder="Cons (optional)..."></textarea></td>
                        </tr>
                    </tbody>
                </table>
                <div class="table-action-buttons">
                    <button class="save-btn" onclick="saveTableData('options')">Save Options</button>
                    <button class="delete-btn" onclick="deleteTableData('options')">Clear Options</button>
                    <span class="saved-message" id="save-status-options">✓ Saved</span>
                     <span class="inline-error-message" id="error-options">Option 1 row requires all fields.</span>
                </div>
            </div>

            <!-- Step 4: Will -->
            <div class="model-section">
                <h3>Step 4: Establish the Will</h3>
                <p>Create a strategy to achieve your goal... Check your progress regularly.</p>
                <table class="will-table">
                    <thead>
                        <tr>
                            <th>Action Steps</th>
                            <th>Completion Date</th>
                            <th>Success Measures</th>
                        </tr>
                     </thead>
                     <tbody>
                        <!-- Row 1 -->
                        <tr class="orange-row">
                            <td><textarea class="editable-answer required-answer" data-question="action1" placeholder="Action step 1..."></textarea></td>
                            <td><input type="date" class="editable-answer required-answer" data-question="date1"></td>
                            <td><textarea class="editable-answer required-answer" data-question="measure1" placeholder="How will you measure success?..."></textarea></td>
                        </tr>
                         <!-- Row 2 -->
                        <tr class="orange-row">
                            <td><textarea class="editable-answer" data-question="action2" placeholder="Action step 2 (optional)..."></textarea></td>
                            <td><input type="date" class="editable-answer" data-question="date2"></td>
                            <td><textarea class="editable-answer" data-question="measure2" placeholder="Success measures (optional)..."></textarea></td>
                        </tr>
                         <!-- Row 3 -->
                        <tr class="orange-row">
                            <td><textarea class="editable-answer" data-question="action3" placeholder="Action step 3 (optional)..."></textarea></td>
                            <td><input type="date" class="editable-answer" data-question="date3"></td>
                            <td><textarea class="editable-answer" data-question="measure3" placeholder="Success measures (optional)..."></textarea></td>
                        </tr>
                     </tbody>
                </table>
                <div class="table-action-buttons">
                    <button class="save-btn" onclick="saveTableData('will')">Save Action Plan</button>
                    <button class="delete-btn" onclick="deleteTableData('will')">Clear Action Plan</button>
                    <span class="saved-message" id="save-status-will">✓ Saved</span>
                     <span class="inline-error-message" id="error-will">Action Plan row 1 requires all fields.</span>
                </div>
            </div>
        </div> <!-- End Action Card -->

        <div class="highlight-section">
            <p>TIP: Schedule regular "check-in" sessions with yourself (weekly or bi-weekly) to review your progress. Treat these sessions as seriously as you would a coaching session with someone else - put them in your calendar and prepare for them.</p>
        </div>

        <!-- General Warning Message -->
        <div class="warning-message" id="generalWarningMessage">
            <strong>Action Required:</strong> Please complete all required answers before proceeding.
            Unanswered questions are highlighted.
        </div>

        <!-- Navigation Buttons -->
        <div class="button-container">
             <!-- Updated back button link -->
            <a href="team-coaching.html" class="button back" id="backButton">← Back to Team Coaching</a>
             <!-- Next button triggers validation and modal -->
            <button type="button" class="button" id="nextButton">Next: Coaching Action Plan →</button>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">×</button>
            <h3>Section Complete!</h3>
            <p>All required answers for this section have been saved.</p>
            <p>You can now proceed to the next section.</p>
             <!-- Updated redirect function -->
            <button class="modal-button" onclick="redirectToNextPage()">CONTINUE TO ACTION PLAN</button>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const formspreeEndpoint = 'https://formspree.io/f/xzzeqvea'; // YOUR Formspree Endpoint
        const localStorageKey = 'allUserAnswers_selfCoaching'; // Specific key for THIS page
        const userEmailKey = 'userEmail';
        const currentUserKey = 'currentUser';

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            const userEmail = getUserEmail();
            if (!userEmail) {
                alert('User session not found. Please log in again.');
                window.location.href = 'login.html';
                return;
            }

            displayUserInfo(userEmail);
            loadUserAnswers(userEmail);
            setupEventListeners(userEmail);
        });

        // --- User Info & Authentication ---
        function getUserEmail() {
            const userData = JSON.parse(localStorage.getItem(currentUserKey));
            return userData?.email || localStorage.getItem(userEmailKey);
        }

        function displayUserInfo(userEmail) {
            const userData = JSON.parse(localStorage.getItem(currentUserKey)) || {};
            document.getElementById('userName').textContent = `Welcome, ${userData.name || 'User'}`;
            document.getElementById('userEmail').textContent = userEmail;
        }

        function logout() {
            localStorage.removeItem('loggedIn');
            localStorage.removeItem(currentUserKey);
            localStorage.removeItem(userEmailKey);
            window.location.href = 'login.html';
        }

        // --- Answer Handling (Local Storage) ---
        function loadUserAnswers(userEmail) {
            const allAnswers = JSON.parse(localStorage.getItem(localStorageKey)) || {};
            const userPageAnswers = allAnswers[userEmail] || {};

            // Load answers for all fields with data-question
            document.querySelectorAll('[data-question]').forEach(field => {
                 const questionId = field.getAttribute('data-question');
                 const statusId = `save-status-${questionId}` // Individual status (if exists)
                                || `save-status-${questionId.replace(/\d+$/, '')}` // Table status
                                || `save-status-${questionId.replace(/\d/g, '')}`; // Fallback base status

                 const statusElement = document.getElementById(statusId); // May be null for table rows

                 if (userPageAnswers[questionId] !== undefined) {
                    field.value = userPageAnswers[questionId];
                    // Remove required class on load if value exists
                    if (field.value.trim() !== '') {
                        field.classList.remove('required-field');
                    }
                     // Attempt to show saved status if applicable (for individual fields)
                    if (statusElement && field.value.trim() !== '') {
                         // Check if it's part of a table handled by table-wide save
                         const isSwot = questionId.startsWith('strength') || questionId.startsWith('weakness');
                         const isOptions = questionId.startsWith('option') || questionId.startsWith('pro') || questionId.startsWith('con');
                         const isWill = questionId.startsWith('action') || questionId.startsWith('date') || questionId.startsWith('measure');

                         if (!isSwot && !isOptions && !isWill) {
                            statusElement.textContent = '✓ Saved';
                            statusElement.style.display = 'inline';
                         }
                    }
                 } else {
                    // Reset field if no answer saved
                    field.value = (field.tagName === 'SELECT') ? '' : '';
                    // if (statusElement) statusElement.style.display = 'none'; // Don't hide table status just because one field is empty
                 }
            });

             // Show table-wide saved statuses based on whether *any* data exists for that table
             checkAndShowTableStatus('swot', userPageAnswers);
             checkAndShowTableStatus('options', userPageAnswers);
             checkAndShowTableStatus('will', userPageAnswers);

        }

        // Helper to show table status on load
         function checkAndShowTableStatus(tableType, userPageAnswers) {
             const statusElement = document.getElementById(`save-status-${tableType}`);
             if (!statusElement) return;

             let prefixes = [];
             if (tableType === 'swot') prefixes = ['strength', 'weakness'];
             else if (tableType === 'options') prefixes = ['option', 'pro', 'con'];
             else if (tableType === 'will') prefixes = ['action', 'date', 'measure'];
             else return;

             let hasData = false;
             for (let i = 1; i <= 3; i++) {
                 for (const prefix of prefixes) {
                     if (userPageAnswers[`${prefix}${i}`] !== undefined && userPageAnswers[`${prefix}${i}`] !== '') {
                         hasData = true;
                         break;
                     }
                 }
                 if (hasData) break;
             }
             statusElement.style.display = hasData ? 'inline' : 'none';
         }


        function saveAnswerToStorage(userEmail, questionId, answer) {
            const allAnswers = JSON.parse(localStorage.getItem(localStorageKey)) || {};
            if (!allAnswers[userEmail]) {
                allAnswers[userEmail] = {};
            }
            allAnswers[userEmail][questionId] = answer;
            localStorage.setItem(localStorageKey, JSON.stringify(allAnswers));
            console.log(`Saved locally: ${questionId}`);
        }

        function deleteAnswerFromStorage(userEmail, questionId) {
            const allAnswers = JSON.parse(localStorage.getItem(localStorageKey)) || {};
            if (allAnswers[userEmail]) {
                delete allAnswers[userEmail][questionId];
                if (Object.keys(allAnswers[userEmail]).length === 0) {
                    delete allAnswers[userEmail];
                }
            }
            localStorage.setItem(localStorageKey, JSON.stringify(allAnswers));
             console.log(`Deleted locally: ${questionId}`);
        }

        // --- Event Listeners Setup ---
        function setupEventListeners(userEmail) {
             // Auto-remove required styling on input/change for all fields
             document.querySelectorAll('.editable-answer').forEach(field => {
                 const eventType = (field.tagName === 'SELECT' || field.type === 'date') ? 'change' : 'input';
                 field.addEventListener(eventType, function() {
                     const questionId = this.getAttribute('data-question');
                     const isRequiredDirectly = this.classList.contains('required-answer');
                     const errorId = isRequiredDirectly ? `error-${questionId}` : null;
                     const errorElement = errorId ? document.getElementById(errorId) : null;

                     if (this.value.trim() !== '') {
                         this.classList.remove('required-field');
                         if (errorElement) errorElement.style.display = 'none';

                         // Clear table-wide error if a required field in a table becomes valid
                         const tableType = getTableTypeFromQuestionId(questionId);
                         if (tableType) {
                             clearTableErrorIfRowBecomesValid(tableType, questionId.slice(-1));
                         }
                     }
                 });
             });

            // Next button validation & modal trigger
            document.getElementById('nextButton').addEventListener('click', function(e) {
                if (!validateAllAnswers()) {
                    e.preventDefault();
                    showGeneralWarningMessage();
                } else {
                    e.preventDefault();
                    showSuccessModal();
                }
            });
        }

         // Helper to get table type
         function getTableTypeFromQuestionId(questionId) {
             if (questionId.startsWith('strength') || questionId.startsWith('weakness')) return 'swot';
             if (questionId.startsWith('option') || questionId.startsWith('pro') || questionId.startsWith('con')) return 'options';
             if (questionId.startsWith('action') || questionId.startsWith('date') || questionId.startsWith('measure')) return 'will';
             return null;
         }

        // Helper to clear table error if a specific row requirement is met
        function clearTableErrorIfRowBecomesValid(tableType, rowIndex) {
             const errorId = `error-${tableType}`;
             const errorElement = document.getElementById(errorId);
             if (!errorElement || errorElement.style.display === 'none') return;

             let requiredPrefixes = [];
             if (tableType === 'swot' && rowIndex === '1') requiredPrefixes = ['strength1', 'weakness1'];
             else if (tableType === 'options' && rowIndex === '1') requiredPrefixes = ['option1', 'pro1', 'con1'];
             else if (tableType === 'will' && rowIndex === '1') requiredPrefixes = ['action1', 'date1', 'measure1'];
             else return; // Only check first row requirements for now

             let rowNowValid = true;
             requiredPrefixes.forEach(prefix => {
                  const field = document.querySelector(`[data-question="${prefix}"]`);
                  if(!field || field.value.trim() === ''){
                      rowNowValid = false;
                  }
             });

             // If this required row is now valid, hide the table error
             // (Note: this assumes the table error was *only* due to this row)
             // A full re-validation is safer but more complex here.
             if(rowNowValid){
                errorElement.style.display = 'none';
             }
        }

        // --- UI Feedback & Validation ---

        function validateAllAnswers() {
            let allValid = true;

             // 1. Check single required textareas/inputs
             document.querySelectorAll('.required-answer:not(table .required-answer)').forEach(field => {
                const questionId = field.getAttribute('data-question');
                const errorId = `error-${questionId}`;
                 hideMessages(null, errorId, field); // Clear previous error

                 if (field.value.trim() === '') {
                    allValid = false;
                    showError(errorId, field, 'Please enter an answer.');
                }
            });

             // 2. Validate SWOT Table (Row 1 required)
             const swotErrorElement = document.getElementById('error-swot');
             hideMessages(null, 'error-swot', null);
             let swotValid = true;
             ['strength1', 'weakness1'].forEach(id => {
                 const field = document.querySelector(`[data-question="${id}"]`);
                 if (field && field.value.trim() === '') {
                     swotValid = false;
                     field.classList.add('required-field');
                 } else if (field) {
                     field.classList.remove('required-field');
                 }
             });
             if (!swotValid) {
                 allValid = false;
                 showError('error-swot', null, 'Strength 1 and Weakness 1 are required.');
             }

             // 3. Validate Options Table (Row 1 required)
             const optionsErrorElement = document.getElementById('error-options');
             hideMessages(null, 'error-options', null);
             let optionsValid = true;
             ['option1', 'pro1', 'con1'].forEach(id => {
                 const field = document.querySelector(`[data-question="${id}"]`);
                 if (field && field.value.trim() === '') {
                     optionsValid = false;
                     field.classList.add('required-field');
                 } else if (field) {
                      field.classList.remove('required-field');
                 }
             });
             if (!optionsValid) {
                 allValid = false;
                 showError('error-options', null, 'Option 1, Pro 1, and Con 1 are required.');
             }

             // 4. Validate Will Table (Row 1 required)
             const willErrorElement = document.getElementById('error-will');
             hideMessages(null, 'error-will', null);
             let willValid = true;
             ['action1', 'date1', 'measure1'].forEach(id => {
                 const field = document.querySelector(`[data-question="${id}"]`);
                  if (field && field.value.trim() === '') {
                     willValid = false;
                     field.classList.add('required-field');
                 } else if (field) {
                      field.classList.remove('required-field');
                 }
             });
             if (!willValid) {
                 allValid = false;
                 showError('error-will', null, 'Action Step 1, Date 1, and Measure 1 are required.');
             }

             // Clear borders from non-required table rows
             ['swot', 'options', 'will'].forEach(tableType => {
                 let prefixes = [];
                 if (tableType === 'swot') prefixes = ['strength', 'weakness'];
                 else if (tableType === 'options') prefixes = ['option', 'pro', 'con'];
                 else if (tableType === 'will') prefixes = ['action', 'date', 'measure'];

                 for(let i = 2; i <= 3; i++) { // Rows 2 and 3 are optional
                     prefixes.forEach(prefix => {
                        const field = document.querySelector(`[data-question="${prefix}${i}"]`);
                        if(field) field.classList.remove('required-field');
                     });
                 }
             });


            return allValid;
        }


        function showGeneralWarningMessage() {
            const warningElement = document.getElementById('generalWarningMessage');
            if (!warningElement) return;
            warningElement.style.display = 'block';
            warningElement.style.animation = 'fadeIn 0.3s ease-in-out';

            const firstEmptyField = document.querySelector('.required-field');
            if (firstEmptyField) {
                firstEmptyField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => firstEmptyField.focus(), 100);
            }

            setTimeout(() => {
                warningElement.style.animation = 'fadeOut 0.5s ease-in-out forwards';
                 setTimeout(() => {
                      warningElement.style.display = 'none';
                      warningElement.style.animation = '';
                 }, 500);
            }, 4000);
        }

         function showSaveStatus(statusId, message = '✓ Saved') {
             const statusElement = document.getElementById(statusId);
             if (!statusElement) return;
             statusElement.textContent = message;
             statusElement.style.display = 'inline';
             setTimeout(() => {
                 statusElement.style.display = 'none';
             }, 2500);
        }

        function showError(errorId, field, message = 'Required field.') {
             const errorElement = document.getElementById(errorId);
             if (!errorElement) return;
             errorElement.textContent = message;
             errorElement.style.display = 'inline';
             if (field) {
                 field.classList.add('required-field');
                  // Don't auto-focus on table errors shown outside the fields
                 if (!errorId.includes('swot') && !errorId.includes('options') && !errorId.includes('will')) {
                     // Small delay before focus can help after error message display
                      setTimeout(() => field.focus(), 50);
                 }
             }
        }

        function hideMessages(statusId, errorId, field) {
             const statusElement = statusId ? document.getElementById(statusId) : null;
             const errorElement = errorId ? document.getElementById(errorId) : null;
             if (statusElement) statusElement.style.display = 'none';
             if (errorElement) errorElement.style.display = 'none';
             // Keep required-field removal within validation or successful save/delete logic
             // if (field) field.classList.remove('required-field');
        }

        // --- Actions (Save/Delete Single Fields) ---
        function saveAnswer(questionId) {
             const userEmail = getUserEmail();
             if (!userEmail) return;

             const field = document.querySelector(`[data-question="${questionId}"]`);
             if (!field) { console.error(`Field not found for ${questionId}`); return; }

             const statusId = `save-status-${questionId}`;
             const errorId = `error-${questionId}`;
             const answer = field.value.trim();

             hideMessages(statusId, errorId, field);

             // Check if this specific field is marked as required
             const isRequired = field.classList.contains('required-answer');

             if (isRequired && !answer) {
                showError(errorId, field, 'Please enter an answer.');
                return;
             }

             // Save even if optional and empty (to clear previous value)
             saveAnswerToStorage(userEmail, questionId, field.value);
             // Only submit non-empty answers to Formspree
             if (answer) {
                 submitToFormspree(userEmail, questionId, field.value);
             }
             showSaveStatus(statusId);
             field.classList.remove('required-field'); // Remove border after successful save
        }

        function deleteAnswer(questionId) {
            const userEmail = getUserEmail();
            if (!userEmail) return;

            const field = document.querySelector(`[data-question="${questionId}"]`);
             if (!field) { console.error(`Field not found for ${questionId}`); return; }

             const statusId = `save-status-${questionId}`;
             const errorId = `error-${questionId}`;

             hideMessages(statusId, errorId, field);
             field.value = (field.type === 'date' || field.tagName === 'SELECT') ? '' : ''; // Clear field correctly
             deleteAnswerFromStorage(userEmail, questionId);
             showSaveStatus(statusId, '✓ Deleted');
             field.classList.remove('required-field');
        }

        // --- Actions (Save/Delete Entire Tables) ---
         function saveTableData(tableType) {
             const userEmail = getUserEmail();
             if (!userEmail) return;

             const statusId = `save-status-${tableType}`;
             const errorId = `error-${tableType}`;
             hideMessages(statusId, errorId, null); // Clear previous table messages

             let prefixes = [];
             let requiredPrefixes = []; // Prefixes required for row 1
             if (tableType === 'swot') { prefixes = ['strength', 'weakness']; requiredPrefixes = ['strength1', 'weakness1']; }
             else if (tableType === 'options') { prefixes = ['option', 'pro', 'con']; requiredPrefixes = ['option1', 'pro1', 'con1']; }
             else if (tableType === 'will') { prefixes = ['action', 'date', 'measure']; requiredPrefixes = ['action1', 'date1', 'measure1']; }
             else return;

             let dataToSave = {};
             let validationPassed = true;
             let hasData = false; // Track if any field in the table has data

             // Validate required row 1 first
             requiredPrefixes.forEach(reqId => {
                  const field = document.querySelector(`[data-question="${reqId}"]`);
                  if (field && field.value.trim() === '') {
                      validationPassed = false;
                      field.classList.add('required-field');
                  } else if (field) {
                       field.classList.remove('required-field'); // Clear border if valid
                  }
             });

             if (!validationPassed) {
                 showError(errorId, null, `Row 1 in the ${tableType} table requires all fields.`);
                 return; // Stop if required row is invalid
             }

             // Collect all data from the table
             for (let i = 1; i <= 3; i++) {
                 for (const prefix of prefixes) {
                     const questionId = `${prefix}${i}`;
                     const field = document.querySelector(`[data-question="${questionId}"]`);
                     if (field) {
                         const value = field.value; // Save original value
                         dataToSave[questionId] = value;
                         if (value.trim() !== '') {
                             hasData = true;
                         }
                         // Clear validation border for optional rows if saving
                         if (i > 1) field.classList.remove('required-field');
                     }
                 }
             }

             // Save and Submit if validation passed and there's data
             if (hasData) {
                 for (const questionId in dataToSave) {
                     saveAnswerToStorage(userEmail, questionId, dataToSave[questionId]);
                     if (dataToSave[questionId]?.trim()) { // Submit only non-empty
                         submitToFormspree(userEmail, questionId, dataToSave[questionId]);
                     }
                 }
                 showSaveStatus(statusId);
             } else {
                  // Saved successfully (empty table) - maybe don't show saved message?
                  // Or show a specific "Table cleared" message? Let's just not show saved.
             }
         }

         function deleteTableData(tableType) {
             const userEmail = getUserEmail();
             if (!userEmail) return;

             const statusId = `save-status-${tableType}`;
             const errorId = `error-${tableType}`;
             hideMessages(statusId, errorId, null);

             let prefixes = [];
              if (tableType === 'swot') prefixes = ['strength', 'weakness'];
             else if (tableType === 'options') prefixes = ['option', 'pro', 'con'];
             else if (tableType === 'will') prefixes = ['action', 'date', 'measure'];
             else return;

             for (let i = 1; i <= 3; i++) {
                 for (const prefix of prefixes) {
                     const questionId = `${prefix}${i}`;
                     const field = document.querySelector(`[data-question="${questionId}"]`);
                     if (field) {
                         field.value = (field.type === 'date' || field.tagName === 'SELECT') ? '' : '';
                         field.classList.remove('required-field');
                         deleteAnswerFromStorage(userEmail, questionId);
                     }
                 }
             }
             showSaveStatus(statusId, '✓ Cleared');
         }


        // --- Formspree Submission ---
        function submitToFormspree(userEmail, questionId, answer) {
            if (!answer?.trim()) {
                console.log(`Skipping Formspree submission for empty answer: ${questionId}`);
                return;
            }

            const formData = new FormData();
            formData.append('email', userEmail);
            formData.append('page', document.title);
            formData.append('question_id', questionId);
            formData.append('answer_text', answer);

            fetch(formspreeEndpoint, {
                method: 'POST',
                body: formData,
                headers: { 'Accept': 'application/json' }
            })
            .then(response => {
                if (response.ok) {
                    console.log(`Answer submitted to Formspree: ${questionId}`);
                } else {
                     response.json().then(data => {
                         console.error(`Formspree error for ${questionId}:`, data.errors ? data.errors.map(e => e.message).join(', ') : `Status ${response.status}`);
                    }).catch(() => console.error(`Formspree non-JSON error for ${questionId}. Status: ${response.status}`));
                }
            })
            .catch(error => console.error(`Network error submitting to Formspree for ${questionId}:`, error));
        }

        // --- Modal Handling ---
        function showSuccessModal() {
             const modal = document.getElementById('successModal');
             if(modal) modal.style.display = 'flex';
        }

        function closeModal() {
            const modal = document.getElementById('successModal');
            if(modal) modal.style.display = 'none';
        }

        function redirectToNextPage() {
            window.location.href = 'coaching-action-plan.html'; // Make sure this is the correct next page filename
        }

    </script>
</body>
</html>
