<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coaching Action Plan | Leadership Coaching</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
     <!-- Supabase JS Library -->
     <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- Global Styles (Consistent) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html { scroll-behavior: smooth; }
        body { margin: 0; padding: 0; line-height: 1.7; background-color: #f9f9f9; color: #333; }
        /* User Bar Styles (Consistent) */
        .user-bar { background-color: #34495e; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; color: white; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-info svg { opacity: 0.8; }
        .user-details { display: flex; flex-direction: column; }
        .user-name { font-weight: 600; font-size: 14px; }
        .user-email { font-size: 12px; opacity: 0.8; }
        .logout-button { background-color: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 6px; font-size: 13px; }
        .logout-button:hover { background-color: #c0392b; transform: translateY(-1px); }
        .logout-button:active { transform: translateY(0); }
        /* Navigation Tabs (Consistent) */
        .nav-tab { background-color: #2c3e50; padding: 12px 10px; text-align: center; position: sticky; top: 0; z-index: 100; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; scrollbar-width: thin; scrollbar-color: #556a80 #2c3e50; }
        .nav-tab::-webkit-scrollbar { height: 6px; }
        .nav-tab::-webkit-scrollbar-track { background: #2c3e50; }
        .nav-tab::-webkit-scrollbar-thumb { background-color: #556a80; border-radius: 10px; border: 1px solid #2c3e50; }
        .nav-tab a { color: white; text-decoration: none; margin: 0 8px; padding: 8px 12px; border-radius: 6px; transition: background-color 0.3s, color 0.3s; font-size: 14px; display: inline-block; }
        .nav-tab a:hover, .nav-tab a.active { background-color: #34495e; color: #fff; }
        /* Main Content Styles (Consistent) */
        h1 { color: #fff; background-color: #e67e22; padding: 20px; border-radius: 8px; text-align: center; margin: 25px auto; max-width: 800px; font-size: 26px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { color: white; background-color: #34495e; padding: 12px 15px; border-radius: 6px; text-align: left; margin: 30px 0 20px; font-size: 1.4em; }
        h3 { color: #e67e22; margin: 20px 0 15px; text-align: left; font-size: 1.2em; }
        .container {
            max-width: 800px;
            margin: 0 auto 30px;
            background: white;
            padding: 30px;
            padding-top: 30px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 8px;
            position: relative;
        }
        .highlight-section { background-color: rgba(230, 126, 34, 0.07); padding: 20px; border-left: 5px solid #e67e22; border-radius: 6px; margin: 25px 0; }
        .image-container { text-align: center; margin: 30px 0; }
        .image-container img { max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .caption { color: #555; margin-top: 10px; font-size: 14px; }
        .question-box { background-color: rgba(52, 152, 219, 0.08); padding: 25px; border-radius: 6px; margin: 25px 0; border: 1px solid rgba(52, 152, 219, 0.2); border-left: 5px solid #3498db; }
        .question-box h4 { margin-top: 0; margin-bottom: 10px; color: #34495e; font-weight: 600; font-size: 1.1em; }
        .question-box h4 .required-star { color: #e74c3c; font-weight: bold; margin-left: 3px; }
        textarea, input[type="text"], input[type="date"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; margin-top: 8px; margin-bottom: 5px; background-color: white; min-height: 45px; line-height: 1.6; display: block; color: #333; font-size: 15px; transition: border-color 0.3s, box-shadow 0.3s; }
        textarea { min-height: 80px; resize: vertical; }
        textarea:focus, input[type="text"]:focus, input[type="date"]:focus { outline: none; border-color: #e67e22; box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.2); }
        textarea::placeholder, input::placeholder { color: #aaa; opacity: 1; }
        textarea:disabled, input:disabled { background-color: #f0f0f0 !important; cursor: not-allowed !important; color: #6c757d !important; border-color: #ddd !important; box-shadow: none !important;}
        ol { list-style: decimal; margin-left: 25px; margin-bottom: 15px; padding-left: 0; }
        ul { list-style: disc; margin-left: 25px; margin-bottom: 15px; }
        li { margin-bottom: 15px; list-style-position: outside; padding-left: 5px; }
        ol textarea, ul textarea { min-height: 50px; margin-top: 5px; margin-bottom: 5px; }
        /* --- Button styles specific to this page --- */
        .save-button, .delete-button { color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; transition: all 0.3s ease; font-size: 14px; font-weight: 500; }
        .save-button { background-color: #27ae60; }
        .delete-button { background-color: #e74c3c; margin-left: 8px; }
        .save-button:hover:not(:disabled) { background-color: #2ecc71; transform: translateY(-1px); }
        .delete-button:hover:not(:disabled) { background-color: #c0392b; transform: translateY(-1px); }
        .save-button:active, .delete-button:active { transform: translateY(0); }
        .save-button:disabled, .delete-button:disabled { background-color: #bdc3c7 !important; cursor: not-allowed !important; transform: none !important; box-shadow: none !important; opacity: 0.7 !important; }
        .answer-buttons { display: flex; align-items: center; margin-top: 8px; flex-wrap: wrap; gap: 10px; /* Removed bottom margin, min-height handled by status span */ }
        .save-status { /* Style for the persistent 'Saved' message */ font-size: 14px; color: #27ae60; margin-top: 12px; /* Space above status message */ display: none; /* Hidden by default */ font-weight: 600; }
        .inline-error-message { color: #e74c3c; font-size: 13px; display: block; margin-top: 4px; /* Space above error */ margin-bottom: 10px; font-weight: 500; min-height: 1.2em; display: none; }
        /* Navigation Buttons */
        .navigation-buttons { display: flex; justify-content: space-between; margin-top: 40px; gap: 20px; border-top: 1px solid #eee; padding-top: 25px; }
        .navigation-buttons a, .navigation-buttons button { text-decoration: none; padding: 12px 20px; color: white; border-radius: 4px; font-weight: 600; flex: 1; text-align: center; transition: all 0.3s ease; font-size: 15px; border: none; cursor: pointer; }
        .navigation-buttons .back { background-color: #6c757d; }
        .navigation-buttons #completeButton { background-color: #e67e22; }
        .navigation-buttons a:hover, .navigation-buttons button:hover:not(:disabled) { transform: translateY(-1px); filter: brightness(110%); }
        .navigation-buttons a:active, .navigation-buttons button:active:not(:disabled) { transform: translateY(0); filter: brightness(100%); }
        .navigation-buttons #completeButton:disabled { background-color: #bdc3c7 !important; cursor: not-allowed !important; transform: none !important; box-shadow: none !important; filter: none !important; opacity: 0.7 !important; }
        .floating-warning { background-color: #fff8e1; border-left: 4px solid #ffc107; padding: 15px 25px; color: #333; display: none; position: fixed; top: 75px; left: 50%; transform: translateX(-50%); z-index: 1001; border-radius: 6px; box-shadow: 0 3px 10px rgba(0,0,0,0.2); animation: slideDownFadeIn 0.4s ease-out; font-weight: 500; max-width: 90%; width: auto; min-width: 300px; text-align: center; }
        @keyframes slideDownFadeIn { from { opacity: 0; top: 50px; } to { opacity: 1; top: 75px; } }
        @keyframes fadeOutUp { from { opacity: 1; top: 75px;} to { opacity: 0; top: 50px;} }
        .completion-message { background-color: rgba(39, 174, 96, 0.1); padding: 25px; border-left: 5px solid #27ae60; border-radius: 8px; margin: 30px 0; text-align: center; display: none; border: 1px solid rgba(39, 174, 96, 0.2); }
        .completion-message h3 { color: #27ae60; margin-bottom: 15px; font-size: 1.3em;}
        .completion-message p { color: #333; margin-bottom: 10px; }
        .required-field { border: 2px solid #e74c3c !important; background-color: #fff2f1 !important; box-shadow: none !important; }
        .required-star { color: #e74c3c; font-weight: bold; margin-left: 2px; }

         /* --- Progress Bar Styles (Overall Page) --- */
        #overall-progress-container { margin-bottom: 30px; background-color: #ecf0f1; border-radius: 8px; overflow: hidden; height: 20px; width: 100%; }
        #overall-progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #3498db, #2980b9); border-radius: 8px; transition: width 0.6s ease-in-out; display: flex; align-items: center; justify-content: center; }
        #overall-progress-text { font-size: 11px; font-weight: 600; color: white; text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.3); white-space: nowrap; overflow: hidden; padding: 0 8px; }
        /* Remove individual section progress bars */
        .question-progress-container { display: none !important; }


        @media (max-width: 768px) {
            h1 { font-size: 22px; padding: 15px; margin: 20px 15px; }
            h2 { font-size: 1.2em; padding: 10px 15px; }
            .container { padding: 20px; padding-top: 20px; margin: 0 15px 20px; }
            .user-bar { padding: 10px 15px; font-size: 13px; }
            .user-name { font-size: 13px; }
            .user-email { font-size: 11px; }
            .logout-button { padding: 7px 12px; font-size: 12px; }
            .nav-tab { padding: 10px 5px; }
            .nav-tab a { margin: 0 5px; padding: 7px 10px; font-size: 13px;}
            .highlight-section, .question-box { padding: 15px; margin: 20px 0; }
            textarea { min-height: 80px; }
            ol textarea { min-height: 50px; }
            .save-button, .delete-button { padding: 7px 13px; font-size: 13px; }
            .navigation-buttons { flex-direction: column; }
            .navigation-buttons a, .navigation-buttons button { font-size: 14px; padding: 12px 15px;}
            .floating-warning { padding: 12px 20px; font-size: 14px; top: 65px; width: calc(100% - 30px); max-width: 400px; }
            @keyframes slideDownFadeIn { from { opacity: 0; top: 45px; } to { opacity: 1; top: 65px; } }
            @keyframes fadeOutUp { from { opacity: 1; top: 65px;} to { opacity: 0; top: 45px;} }
            .completion-message { padding: 20px; }
            .completion-message h3 { font-size: 1.2em; }
            .answer-buttons { justify-content: flex-start; margin-top: 8px; }
        }
    </style>
</head>
<body>
    <!-- User Info Bar -->
    <div class="user-bar"> <!-- ... User bar content ... --> </div>

    <!-- Navigation Tabs -->
    <nav class="nav-tab"> <!-- ... Nav tab content ... --> </nav>

    <h1>Your Coaching Action Plan</h1>
    <div class="floating-warning" id="generalWarningMessage"></div>

    <div class="container">
        <!-- Overall Progress Bar -->
        <div id="overall-progress-container">
            <div id="overall-progress-bar">
                <span id="overall-progress-text">0% Complete</span>
            </div>
        </div>

        <div class="highlight-section"> <!-- ... Highlight content ... --> </div>
        <div class="image-container"> <!-- ... Image content ... --> </div>

        <!-- Section 5.1 -->
        <h2>5.1 Your Coaching Motivation</h2>
        <div class="question-box" data-section="motivation" id="section-container-motivation">
            <h4>Coaching excites me because<span class="required-star">*</span></h4>
            <textarea placeholder="What aspects of helping others grow and develop energize you?" class="editable-answer required-answer" data-question="excitement"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('excitement')">Save</button> <button class="delete-button" onclick="deleteAnswer('excitement')">Delete</button> </div>
            <span class="save-status" id="save-status-excitement">Saved ✅</span> <!-- Status Span AFTER buttons -->
            <span class="inline-error-message" id="error-excitement"></span>

            <h4>Through coaching, I could personally gain<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., better delegation skills, stronger relationships, improved team performance..." class="editable-answer required-answer" data-question="personal-gain"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('personal-gain')">Save</button> <button class="delete-button" onclick="deleteAnswer('personal-gain')">Delete</button> </div>
             <span class="save-status" id="save-status-personal-gain">Saved ✅</span>
             <span class="inline-error-message" id="error-personal-gain"></span>

            <h4>It's worthwhile investing time and energy in coaching my team, because<span class="required-star">*</span></h4>
            <textarea placeholder="Connect coaching to specific team or organizational benefits." class="editable-answer required-answer" data-question="team-benefits"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('team-benefits')">Save</button> <button class="delete-button" onclick="deleteAnswer('team-benefits')">Delete</button> </div>
             <span class="save-status" id="save-status-team-benefits">Saved ✅</span>
             <span class="inline-error-message" id="error-team-benefits"></span>
        </div>

        <!-- Section 5.2 -->
        <div class="image-container"> <!-- ... Image content ... --> </div>
        <h2>5.2 Making Time for Coaching</h2>
        <div class="question-box" data-section="time" id="section-container-time">
            <h4>To make time for coaching, the habit/process I need to stop or change first is<span class="required-star">*</span></h4>
            <textarea placeholder="Identify one specific time-consuming activity you can adjust." class="editable-answer required-answer" data-question="habits-to-change"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('habits-to-change')">Save</button> <button class="delete-button" onclick="deleteAnswer('habits-to-change')">Delete</button> </div>
            <span class="save-status" id="save-status-habits-to-change">Saved ✅</span>
            <span class="inline-error-message" id="error-habits-to-change"></span>

            <h4>Potential blockers to making this change are<span class="required-star">*</span></h4>
            <textarea placeholder="Anticipate obstacles (e.g., urgent tasks, existing commitments)." class="editable-answer required-answer" data-question="blockers"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('blockers')">Save</button> <button class="delete-button" onclick="deleteAnswer('blockers')">Delete</button> </div>
            <span class="save-status" id="save-status-blockers">Saved ✅</span>
            <span class="inline-error-message" id="error-blockers"></span>

            <h4>My first step to tackling these blockers is<span class="required-star">*</span></h4>
            <textarea placeholder="Define a concrete, actionable first step." class="editable-answer required-answer" data-question="first-step"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('first-step')">Save</button> <button class="delete-button" onclick="deleteAnswer('first-step')">Delete</button> </div>
             <span class="save-status" id="save-status-first-step">Saved ✅</span>
             <span class="inline-error-message" id="error-first-step"></span>

            <h4>To make and sustain these changes, I need the support of<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., My manager, my team, specific colleagues..." class="editable-answer required-answer" data-question="support-needed"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('support-needed')">Save</button> <button class="delete-button" onclick="deleteAnswer('support-needed')">Delete</button> </div>
            <span class="save-status" id="save-status-support-needed">Saved ✅</span>
             <span class="inline-error-message" id="error-support-needed"></span>

            <h4>I will discuss this with them by (date/method)<span class="required-star">*</span></h4>
            <textarea placeholder="Plan how and when you'll have this conversation." class="editable-answer required-answer" data-question="discussion-plan"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('discussion-plan')">Save</button> <button class="delete-button" onclick="deleteAnswer('discussion-plan')">Delete</button> </div>
             <span class="save-status" id="save-status-discussion-plan">Saved ✅</span>
             <span class="inline-error-message" id="error-discussion-plan"></span>

            <h4>A Time Management resource that might help me is<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., Eisenhower Matrix, Time Blocking article, specific app..." class="editable-answer required-answer" data-question="resources"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('resources')">Save</button> <button class="delete-button" onclick="deleteAnswer('resources')">Delete</button> </div>
            <span class="save-status" id="save-status-resources">Saved ✅</span>
             <span class="inline-error-message" id="error-resources"></span>
        </div>

        <!-- Section 5.3 -->
        <h2>5.3 Developing Your Coaching Skills</h2>
        <div class="question-box" data-section="skills" id="section-container-skills">
            <h4>My strongest listening skill currently is<span class="required-star">*</span></h4>
            <textarea placeholder="Identify your best listening trait (e.g., patience, summarizing)." class="editable-answer required-answer" data-question="listening-strength"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('listening-strength')">Save</button> <button class="delete-button" onclick="deleteAnswer('listening-strength')">Delete</button> </div>
             <span class="save-status" id="save-status-listening-strength">Saved ✅</span>
             <span class="inline-error-message" id="error-listening-strength"></span>

            <h4>I'll develop my listening further by applying these two techniques:<span class="required-star">*</span></h4>
            <ol>
                <li><textarea placeholder="First technique (e.g., paraphrase more, notice body language)." class="editable-answer required-answer" data-question="listening-tip1"></textarea>
                    <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('listening-tip1')">Save</button> <button class="delete-button" onclick="deleteAnswer('listening-tip1')">Delete</button> </div>
                    <span class="save-status" id="save-status-listening-tip1">Saved ✅</span>
                    <span class="inline-error-message" id="error-listening-tip1"></span>
                </li>
                <li><textarea placeholder="Second technique (e.g., ask clarifying questions, minimize distractions)." class="editable-answer required-answer" data-question="listening-tip2"></textarea>
                     <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('listening-tip2')">Save</button> <button class="delete-button" onclick="deleteAnswer('listening-tip2')">Delete</button> </div>
                     <span class="save-status" id="save-status-listening-tip2">Saved ✅</span>
                     <span class="inline-error-message" id="error-listening-tip2"></span>
                </li>
            </ol>

            <h4>When I notice myself making an assumption, I will<span class="required-star">*</span></h4>
            <textarea placeholder="Define your strategy (e.g., ask 'What makes you say that?', state the assumption)." class="editable-answer required-answer" data-question="assumption-plan"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('assumption-plan')">Save</button> <button class="delete-button" onclick="deleteAnswer('assumption-plan')">Delete</button> </div>
            <span class="save-status" id="save-status-assumption-plan">Saved ✅</span>
             <span class="inline-error-message" id="error-assumption-plan"></span>

            <h4>Two new non-leading questions I will practice asking are:<span class="required-star">*</span></h4>
            <ol>
                <li><textarea placeholder="e.g., 'What options have you considered?', 'How does that align with X?'" class="editable-answer required-answer" data-question="question1"></textarea>
                     <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('question1')">Save</button> <button class="delete-button" onclick="deleteAnswer('question1')">Delete</button> </div>
                     <span class="save-status" id="save-status-question1">Saved ✅</span>
                      <span class="inline-error-message" id="error-question1"></span>
                </li>
                <li><textarea placeholder="e.g., 'What would success look like?', 'What support do you need?'" class="editable-answer required-answer" data-question="question2"></textarea>
                     <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('question2')">Save</button> <button class="delete-button" onclick="deleteAnswer('question2')">Delete</button> </div>
                     <span class="save-status" id="save-status-question2">Saved ✅</span>
                     <span class="inline-error-message" id="error-question2"></span>
                </li>
            </ol>

            <h4>The coachee emotions I find most challenging are... and when they arise, I feel...<span class="required-star">*</span></h4>
            <textarea placeholder="Identify 1-2 challenging emotions (e.g., frustration, apathy) and your reaction." class="editable-answer required-answer" data-question="emotion-challenge"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('emotion-challenge')">Save</button> <button class="delete-button" onclick="deleteAnswer('emotion-challenge')">Delete</button> </div>
            <span class="save-status" id="save-status-emotion-challenge">Saved ✅</span>
             <span class="inline-error-message" id="error-emotion-challenge"></span>

            <h4>My own preoccupations/mood (e.g., feeling stressed, thinking about deadlines) can sometimes hinder open conversation.<span class="required-star">*</span></h4>
            <textarea placeholder="Acknowledge your internal distractions." class="editable-answer required-answer" data-question="own-mood"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('own-mood')">Save</button> <button class="delete-button" onclick="deleteAnswer('own-mood')">Delete</button> </div>
             <span class="save-status" id="save-status-own-mood">Saved ✅</span>
              <span class="inline-error-message" id="error-own-mood"></span>

            <h4>I'll manage these emotional challenges (mine and theirs) better by<span class="required-star">*</span></h4>
            <textarea placeholder="Outline strategies (e.g., deep breaths, acknowledge feelings, refocus)." class="editable-answer required-answer" data-question="improvement-plan"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('improvement-plan')">Save</button> <button class="delete-button" onclick="deleteAnswer('improvement-plan')">Delete</button> </div>
             <span class="save-status" id="save-status-improvement-plan">Saved ✅</span>
              <span class="inline-error-message" id="error-improvement-plan"></span>

            <h4>I can build trust more effectively by<span class="required-star">*</span></h4>
            <textarea placeholder="List 1-2 specific trust-building actions (e.g., maintain confidentiality, follow through)." class="editable-answer required-answer" data-question="trust-building"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('trust-building')">Save</button> <button class="delete-button" onclick="deleteAnswer('trust-building')">Delete</button> </div>
            <span class="save-status" id="save-status-trust-building">Saved ✅</span>
             <span class="inline-error-message" id="error-trust-building"></span>

            <h4>My key professional strengths are... and I can apply these to coaching by<span class="required-star">*</span></h4>
            <textarea placeholder="Connect your existing strengths to coaching behaviors." class="editable-answer required-answer" data-question="strengths-application"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('strengths-application')">Save</button> <button class="delete-button" onclick="deleteAnswer('strengths-application')">Delete</button> </div>
            <span class="save-status" id="save-status-strengths-application">Saved ✅</span>
             <span class="inline-error-message" id="error-strengths-application"></span>
        </div>

        <!-- Section 5.4 -->
        <h2>5.4 Implementing Coaching Models</h2>
        <div class="question-box" data-section="model" id="section-container-model">
            <h4>The first model I plan to use is... with...<span class="required-star">*</span></h4>
            <textarea placeholder="Choose a model (GROW, Skill/Will, Solution-Focused) and a specific person/situation." class="editable-answer required-answer" data-question="model-choice"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('model-choice')">Save</button> <button class="delete-button" onclick="deleteAnswer('model-choice')">Delete</button> </div>
             <span class="save-status" id="save-status-model-choice">Saved ✅</span>
             <span class="inline-error-message" id="error-model-choice"></span>

            <h4>Because...<span class="required-star">*</span></h4>
            <textarea placeholder="Explain why this model fits this coachee or situation." class="editable-answer required-answer" data-question="model-reason"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('model-reason')">Save</button> <button class="delete-button" onclick="deleteAnswer('model-reason')">Delete</button> </div>
             <span class="save-status" id="save-status-model-reason">Saved ✅</span>
             <span class="inline-error-message" id="error-model-reason"></span>

            <h4>I'll need to prepare for this session by<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., Reviewing the model steps, drafting opening questions, clearing my schedule." class="editable-answer required-answer" data-question="preparation"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('preparation')">Save</button> <button class="delete-button" onclick="deleteAnswer('preparation')">Delete</button> </div>
             <span class="save-status" id="save-status-preparation">Saved ✅</span>
             <span class="inline-error-message" id="error-preparation"></span>

            <div class="image-container"> <!-- ... Image content ... --> </div>

            <h4>I can show my coachee I have their best interests in mind by<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., Focusing fully on them, celebrating small wins, linking goals to their aspirations." class="editable-answer required-answer" data-question="best-interests"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('best-interests')">Save</button> <button class="delete-button" onclick="deleteAnswer('best-interests')">Delete</button> </div>
             <span class="save-status" id="save-status-best-interests">Saved ✅</span>
             <span class="inline-error-message" id="error-best-interests"></span>

            <h4>I will demonstrate coaching integrity and humility by<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., Admitting I don't have all answers, respecting their views, maintaining confidentiality." class="editable-answer required-answer" data-question="integrity"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('integrity')">Save</button> <button class="delete-button" onclick="deleteAnswer('integrity')">Delete</button> </div>
             <span class="save-status" id="save-status-integrity">Saved ✅</span>
             <span class="inline-error-message" id="error-integrity"></span>

            <h4>Two tips from successful coaches I'd feel comfortable applying are:<span class="required-star">*</span></h4>
            <ol>
                <li><textarea placeholder="e.g., Start session by asking 'What's on your mind?', Use silence effectively." class="editable-answer required-answer" data-question="tip1"></textarea>
                     <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('tip1')">Save</button> <button class="delete-button" onclick="deleteAnswer('tip1')">Delete</button> </div>
                     <span class="save-status" id="save-status-tip1">Saved ✅</span>
                      <span class="inline-error-message" id="error-tip1"></span>
                </li>
                <li><textarea placeholder="e.g., End session by asking 'What was most useful?', Follow up on actions." class="editable-answer required-answer" data-question="tip2"></textarea>
                     <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('tip2')">Save</button> <button class="delete-button" onclick="deleteAnswer('tip2')">Delete</button> </div>
                     <span class="save-status" id="save-status-tip2">Saved ✅</span>
                      <span class="inline-error-message" id="error-tip2"></span>
                </li>
            </ol>
        </div>

        <!-- Section 5.5 -->
        <h2>5.5 Informal and Team Coaching</h2>
        <div class="question-box" data-section="team" id="section-container-team">
            <h4>I'll avoid being isolated from the team's daily work by<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., Regular check-ins, being present, participating in informal chats." class="editable-answer required-answer" data-question="shop-floor"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('shop-floor')">Save</button> <button class="delete-button" onclick="deleteAnswer('shop-floor')">Delete</button> </div>
            <span class="save-status" id="save-status-shop-floor">Saved ✅</span>
             <span class="inline-error-message" id="error-shop-floor"></span>

            <div class="image-container"> <!-- ... Image content ... --> </div>

            <h4>I can improve my judgment about when to intervene informally by<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., Paying closer attention to cues, asking clarifying questions first." class="editable-answer required-answer" data-question="intervention"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('intervention')">Save</button> <button class="delete-button" onclick="deleteAnswer('intervention')">Delete</button> </div>
            <span class="save-status" id="save-status-intervention">Saved ✅</span>
             <span class="inline-error-message" id="error-intervention"></span>

            <h4>I plan to use team coaching with this team/group<span class="required-star">*</span></h4>
            <textarea placeholder="Identify the specific team or group." class="editable-answer required-answer" data-question="team-group"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('team-group')">Save</button> <button class="delete-button" onclick="deleteAnswer('team-group')">Delete</button> </div>
             <span class="save-status" id="save-status-team-group">Saved ✅</span>
              <span class="inline-error-message" id="error-team-group"></span>

            <h4>...to help them work on this topic or issue<span class="required-star">*</span></h4>
            <textarea placeholder="Define the specific focus for team coaching (e.g., conflict resolution, goal alignment)." class="editable-answer required-answer" data-question="team-issue"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('team-issue')">Save</button> <button class="delete-button" onclick="deleteAnswer('team-issue')">Delete</button> </div>
             <span class="save-status" id="save-status-team-issue">Saved ✅</span>
             <span class="inline-error-message" id="error-team-issue"></span>

            <h4>I'll prepare for team coaching by exploring personality/working styles using<span class="required-star">*</span></h4>
            <textarea placeholder="Name a model/tool (e.g., DiSC, Belbin - even informally) or describe your approach." class="editable-answer required-answer" data-question="personality-test"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('personality-test')">Save</button> <button class="delete-button" onclick="deleteAnswer('personality-test')">Delete</button> </div>
             <span class="save-status" id="save-status-personality-test">Saved ✅</span>
             <span class="inline-error-message" id="error-personality-test"></span>

            <h4>...and by facilitating appreciation of diverse strengths/preferences through<span class="required-star">*</span></h4>
            <textarea placeholder="Describe the activity or discussion you will lead." class="editable-answer required-answer" data-question="strengths-appreciation"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('strengths-appreciation')">Save</button> <button class="delete-button" onclick="deleteAnswer('strengths-appreciation')">Delete</button> </div>
             <span class="save-status" id="save-status-strengths-appreciation">Saved ✅</span>
             <span class="inline-error-message" id="error-strengths-appreciation"></span>

            <h4>Together, we'll develop a team charter following these steps<span class="required-star">*</span></h4>
            <textarea placeholder="Outline your collaborative process (e.g., brainstorm session, draft, review)." class="editable-answer required-answer" data-question="charter-steps"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('charter-steps')">Save</button> <button class="delete-button" onclick="deleteAnswer('charter-steps')">Delete</button> </div>
             <span class="save-status" id="save-status-charter-steps">Saved ✅</span>
             <span class="inline-error-message" id="error-charter-steps"></span>

            <h4>I will address potential conflicting priorities by discussing them with<span class="required-star">*</span></h4>
            <textarea placeholder="Identify who needs to be involved (e.g., team, specific individuals, other managers)." class="editable-answer required-answer" data-question="conflict-resolution"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('conflict-resolution')">Save</button> <button class="delete-button" onclick="deleteAnswer('conflict-resolution')">Delete</button> </div>
             <span class="save-status" id="save-status-conflict-resolution">Saved ✅</span>
             <span class="inline-error-message" id="error-conflict-resolution"></span>

            <h4>I plan to try the POSITIVE model at this upcoming meeting/situation<span class="required-star">*</span></h4>
            <textarea placeholder="Identify a specific opportunity to use the POSITIVE model." class="editable-answer required-answer" data-question="positive-model"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('positive-model')">Save</button> <button class="delete-button" onclick="deleteAnswer('positive-model')">Delete</button> </div>
             <span class="save-status" id="save-status-positive-model">Saved ✅</span>
              <span class="inline-error-message" id="error-positive-model"></span>

            <h4>...and the PRACTICE model in this session/situation<span class="required-star">*</span></h4>
            <textarea placeholder="Identify a specific opportunity to use the PRACTICE model." class="editable-answer required-answer" data-question="practice-model"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('practice-model')">Save</button> <button class="delete-button" onclick="deleteAnswer('practice-model')">Delete</button> </div>
             <span class="save-status" id="save-status-practice-model">Saved ✅</span>
             <span class="inline-error-message" id="error-practice-model"></span>
        </div>

        <!-- Section 5.6 -->
        <h2>5.6 Self-Reflection and Review</h2>
        <div class="question-box" data-section="reflection" id="section-container-reflection">
            <h4>My personal SWOT analysis highlighted<span class="required-star">*</span></h4>
            <textarea placeholder="Summarize your key strengths and weaknesses identified earlier." class="editable-answer required-answer" data-question="swot-highlights"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('swot-highlights')">Save</button> <button class="delete-button" onclick="deleteAnswer('swot-highlights')">Delete</button> </div>
             <span class="save-status" id="save-status-swot-highlights">Saved ✅</span>
              <span class="inline-error-message" id="error-swot-highlights"></span>

            <h4>As a result, a key action I will take is<span class="required-star">*</span></h4>
            <textarea placeholder="Define one specific action based on your SWOT (leverage strength or address weakness)." class="editable-answer required-answer" data-question="swot-actions"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('swot-actions')">Save</button> <button class="delete-button" onclick="deleteAnswer('swot-actions')">Delete</button> </div>
            <span class="save-status" id="save-status-swot-actions">Saved ✅</span>
            <span class="inline-error-message" id="error-swot-actions"></span>

            <h4>The personal goal I'm working on using the GROW model is<span class="required-star">*</span></h4>
            <textarea placeholder="Restate your SMART goal from the GROW exercise." class="editable-answer required-answer" data-question="grow-goal"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('grow-goal')">Save</button> <button class="delete-button" onclick="deleteAnswer('grow-goal')">Delete</button> </div>
             <span class="save-status" id="save-status-grow-goal">Saved ✅</span>
              <span class="inline-error-message" id="error-grow-goal"></span>

            <h4>My first action step towards this goal is<span class="required-star">*</span></h4>
            <textarea placeholder="Restate your first action step from the GROW 'Will' section." class="editable-answer required-answer" data-question="first-grow-action"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('first-grow-action')">Save</button> <button class="delete-button" onclick="deleteAnswer('first-grow-action')">Delete</button> </div>
             <span class="save-status" id="save-status-first-grow-action">Saved ✅</span>
             <span class="inline-error-message" id="error-first-grow-action"></span>

            <h4>I've scheduled my first self-review for this toolkit on<span class="required-star">*</span></h4>
            <input type="date" class="editable-answer required-answer" data-question="review-date">
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('review-date')">Save</button> <button class="delete-button" onclick="deleteAnswer('review-date')">Delete</button> </div>
            <span class="save-status" id="save-status-review-date">Saved ✅</span>
             <span class="inline-error-message" id="error-review-date"></span>

            <h4>Since starting this toolkit, changes I've observed in myself/my work include<span class="required-star">*</span></h4>
            <textarea placeholder="Reflect on any shifts in your perspective or behavior so far." class="editable-answer required-answer" data-question="self-changes"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('self-changes')">Save</button> <button class="delete-button" onclick="deleteAnswer('self-changes')">Delete</button> </div>
            <span class="save-status" id="save-status-self-changes">Saved ✅</span>
             <span class="inline-error-message" id="error-self-changes"></span>

            <h4>Changes I've observed in my team's behavior/performance include<span class="required-star">*</span></h4>
            <textarea placeholder="Reflect on any impacts on your team, even small ones." class="editable-answer required-answer" data-question="team-changes"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('team-changes')">Save</button> <button class="delete-button" onclick="deleteAnswer('team-changes')">Delete</button> </div>
            <span class="save-status" id="save-status-team-changes">Saved ✅</span>
             <span class="inline-error-message" id="error-team-changes"></span>

            <div class="image-container"> <!-- ... Image content ... --> </div>
        </div>

        <!-- Completion Message -->
        <div class="completion-message" id="completionMessage"> <h3>Congratulations on Completing Your Coaching Action Plan!</h3> <p>Thank you for taking the time to thoughtfully complete this action plan. You've taken important steps toward becoming a more effective coach for your team and yourself.</p> <p>Remember to review your plan regularly (starting on the date you set above!) and adjust as needed. Consistent application of these strategies will help you see the best results.</p> <p>Good luck with your coaching journey!</p> </div>

         <!-- General Warning Placeholder - Content added by JS -->
         <div class="warning-message" id="generalInlineWarningMessage" style="color: #e74c3c; font-weight: 500; margin-top: 15px; text-align: center; display: none;"></div>

        <!-- Navigation Buttons -->
        <div class="navigation-buttons"> <a href="coaching-yourself.html" class="button back" id="backButton">← Back to Self Coaching</a> <button type="button" class="button" id="completeButton">Mark Action Plan as Complete</button> </div>
    </div><!-- /.container -->

    <script>
        // --- Supabase Configuration ---
        const SUPABASE_URL = 'https://lgcutmuspcaralydycmg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnY3V0bXVzcGNhcmFseWR5Y21nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0NDY3MDEsImV4cCI6MjA2MTAyMjcwMX0.3u5Y7pkH2NNnnoGLMWVfAa5b8fq88o1itRYnG1K38tE';
        let supabase = null;

        // --- Configuration ---
        const localStorageKey = 'allUserAnswers_actionPlan';
        const SECTION_ID = 'action';
        const PAGE_NAME = 'action-plan.html';

        // --- Unified Keys ---
        const LOGGED_IN_KEY = 'isUserLoggedIn';
        const CURRENT_USER_KEY = 'currentUser';

        // Array of all REQUIRED question IDs on this page
        const requiredQuestionIds = [
            'excitement', 'personal-gain', 'team-benefits',
            'habits-to-change', 'blockers', 'first-step', 'support-needed', 'discussion-plan', 'resources',
            'listening-strength', 'listening-tip1', 'listening-tip2', 'assumption-plan', 'question1', 'question2', 'emotion-challenge', 'own-mood', 'improvement-plan', 'trust-building', 'strengths-application',
            'model-choice', 'model-reason', 'preparation', 'best-interests', 'integrity', 'tip1', 'tip2',
            'shop-floor', 'intervention', 'team-group', 'team-issue', 'personality-test', 'strengths-appreciation', 'charter-steps', 'conflict-resolution', 'positive-model', 'practice-model',
            'swot-highlights', 'swot-actions', 'grow-goal', 'first-grow-action', 'review-date', 'self-changes', 'team-changes'
        ];

        // Initialize Supabase Client
        try {
            if (window.supabase && window.supabase.createClient) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log(`Supabase client initialized successfully on ${PAGE_NAME}.`);
            } else { throw new Error("Supabase library not found."); }
        } catch (error) { console.error("CRITICAL ERROR initializing Supabase:", error); }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
             console.log(`%c${PAGE_NAME}: DOMContentLoaded event fired.`, "color: green;");
             if (!supabase) {
                 console.error(`Supabase client failed to initialize on ${PAGE_NAME}. Some features might not work.`);
                 showGeneralWarningMessage('Database connection failed. Progress might not save correctly.', true);
             }

             const currentUser = getCurrentUser();
             if (!currentUser || !currentUser.id || !currentUser.email) {
                 console.error(`%c${PAGE_NAME}: User not logged in or essential data missing. Redirecting...`, "color: red;");
                  if (!window.location.search.includes('redir_attempt')) { window.location.href = `login.html?redirect=${encodeURIComponent(window.location.pathname + window.location.search)}&redir_attempt=1`; }
                  else { console.error("REDIRECTION LOOP DETECTED."); document.body.innerHTML = '<p style="color: red; padding: 20px;">Login check failed repeatedly.</p>'; }
                 return;
             }
             console.log(`%c${PAGE_NAME}: User validated (${currentUser.email}, ID: ${currentUser.id}). Initializing.`, "color: green;");
             displayUserInfo();
             loadUserAnswers(currentUser); // Load answers and set button/status states correctly
             setupEventListeners(currentUser);
             highlightActiveNav();
             checkCompletionState(currentUser.email);
             console.log(`%c${PAGE_NAME}: Initialization complete.`, "color: blue;");
        });

        // --- User Info & Auth ---
        function getCurrentUser() { try { const d = localStorage.getItem(CURRENT_USER_KEY); if (!d) return null; const p = JSON.parse(d); if (p && typeof p === 'object' && p.email && p.name && p.id) { if (typeof p.progress !== 'object' || p.progress === null) p.progress = {}; return p; } else { localStorage.removeItem(CURRENT_USER_KEY); localStorage.removeItem(LOGGED_IN_KEY); return null; } } catch (e) { console.error("GUC Error:", e); localStorage.removeItem(CURRENT_USER_KEY); localStorage.removeItem(LOGGED_IN_KEY); return null; } }
        function saveCurrentUser(userObject) { try { if (!userObject || typeof userObject !== 'object') throw new Error("Invalid user object"); localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(userObject)); /* console.log("Saved user data."); */ } catch (error) { console.error("SCU Error:", error); } }
        function displayUserInfo() { const u=getCurrentUser(); if(u){document.getElementById('userName').textContent=`Welcome, ${u.name || u.email.split('@')[0]}`; document.getElementById('userEmail').textContent=u.email;}else{console.warn("DIU: No user");}}
        function logout() { const u=getCurrentUser(); const e=u?u.email:null; localStorage.removeItem(LOGGED_IN_KEY); localStorage.removeItem(CURRENT_USER_KEY); if(e){const k=`${localStorageKey}_completed_${e}`; localStorage.removeItem(k); console.log(`Removed completion key: ${k}`);} window.location.href = 'login.html';}
        function highlightActiveNav() { const cP=window.location.pathname.split('/').pop()||PAGE_NAME; document.querySelectorAll('.nav-tab a').forEach(l=>{const lP=(l.getAttribute('href')||'').split('/').pop(); l.classList.toggle('active',lP===cP);}); }


        // --- Answer Handling (Local Storage & UI Locking) ---
        function loadUserAnswers(currentUser) {
            if (!currentUser || !currentUser.email) return;
            let allAnswers = {};
            try { const d = localStorage.getItem(localStorageKey); if (d) allAnswers = JSON.parse(d) || {}; }
            catch(e) { console.error("Load Answers Error:", e); }
            const userPageAnswers = allAnswers[currentUser.email] || {};

            document.querySelectorAll('.editable-answer[data-question]').forEach(field => {
                loadFieldState(field, field.dataset.question, userPageAnswers);
            });

             updateOverallProgress();
        }

        // --- CORRECTED loadFieldState for 'Save Once' Behavior ---
        function loadFieldState(field, questionId, userAnswers) {
            if (!field) return;
            const errorId = `error-${questionId}`;
            const statusId = `save-status-${questionId}`;
            const statusElement = document.getElementById(statusId); // Get the status span element
            const buttonContainer = field.closest('li, .question-box') || field.parentElement;
            const buttonGroup = buttonContainer?.querySelector('.answer-buttons');
            // Find buttons even if they will be hidden, needed for the 'else' case
            const saveButton = buttonGroup?.querySelector('.save-button');
            const deleteButton = buttonGroup?.querySelector('.delete-button');

            // Always hide error message initially
            hideError(errorId);
            // Always hide persistent status initially
            if (statusElement) statusElement.style.display = 'none';


            if (userAnswers[questionId] !== undefined && userAnswers[questionId] !== null && String(userAnswers[questionId]).trim() !== '') {
                // --- Saved Answer Found ---
                field.value = userAnswers[questionId];
                field.disabled = true;
                field.classList.remove('required-field');

                // --- Hide Buttons, Show Status ---
                if (buttonGroup) {
                    buttonGroup.style.display = 'none'; // Hide the whole button group
                } else {
                     console.warn(`loadFieldState [${questionId}]: Button group not found.`);
                }
                if (statusElement) { // Show persistent status
                    statusElement.textContent = 'Saved ✅'; // Ensure text is correct
                    statusElement.style.display = 'inline-block'; // Make it visible
                    statusElement.classList.remove('deleted');
                    statusElement.style.color = '#27ae60';
                } else {
                     console.warn(`loadFieldState [${questionId}]: Status span #${statusId} not found.`);
                }

            } else {
                // --- No Saved Answer Found ---
                 field.value = (field.type === 'date') ? '' : '';
                 field.disabled = false; // Ensure field is enabled
                 field.classList.remove('required-field');

                // --- Show Buttons, Reset Them, Hide Status ---
                if (buttonGroup) {
                    buttonGroup.style.display = 'flex'; // Ensure button group is visible
                    // Reset individual buttons inside
                    if (saveButton) { saveButton.disabled = false; saveButton.textContent = 'Save'; }
                    if (deleteButton) { deleteButton.disabled = false; deleteButton.style.display = 'inline-block'; }
                } else {
                    console.warn(`loadFieldState [${questionId}]: Button group not found for reset.`);
                }
                if (statusElement) { // Hide status message
                    statusElement.style.display = 'none';
                }
            }
        }
        // --- END OF loadFieldState ---


        function saveAnswerToStorage(userEmail, questionId, answer) { /* ... (unchanged) ... */ if(!userEmail) return false; let a={}; try{const d=localStorage.getItem(localStorageKey); if(d)a=JSON.parse(d)||{};}catch(e){a={};} if(!a[userEmail])a[userEmail]={}; a[userEmail][questionId]=answer; try{localStorage.setItem(localStorageKey,JSON.stringify(a)); return true;}catch(e){console.error("AP Save Err:",e);return false;} }
        function deleteAnswerFromStorage(userEmail, questionId) { /* ... (unchanged, though less likely to be called) ... */ if(!userEmail) return false; let a={}; try{const d=localStorage.getItem(localStorageKey); if(d)a=JSON.parse(d)||{}; else return false;}catch(e){return false;} let u=false; if(a[userEmail]?.[questionId]!==undefined){delete a[userEmail][questionId]; u=true; if(Object.keys(a[userEmail]).length===0)delete a[userEmail];} if(u){try{localStorage.setItem(localStorageKey,JSON.stringify(a)); return true;}catch(e){return false;}} return false;}

        // --- Progress Calculation & Display ---
        function updateOverallProgress(forcePercentage = null) { /* ... (unchanged) ... */ const currentUser=getCurrentUser();if(!currentUser||!currentUser.email)return 0;let allAnswers={};try{const d=localStorage.getItem(localStorageKey);if(d)allAnswers=JSON.parse(d)||{};}catch(e){}const userAnswers=allAnswers[currentUser.email]||{};let progressPercentage=0;if(forcePercentage!==null&&!isNaN(forcePercentage)){progressPercentage=Math.max(0,Math.min(100,Math.round(forcePercentage)));}else{const totalRequired=requiredQuestionIds.length;if(totalRequired===0)return 0;let answeredRequiredCount=0;requiredQuestionIds.forEach(qId=>{if(userAnswers[qId]!==undefined&&userAnswers[qId]!==null&&String(userAnswers[qId]).trim()!==''){answeredRequiredCount++;}});progressPercentage=Math.round((answeredRequiredCount/totalRequired)*100);}if(!currentUser.progress)currentUser.progress={};currentUser.progress[SECTION_ID]=progressPercentage;saveCurrentUser(currentUser);const progressBar=document.getElementById('overall-progress-bar');const progressText=document.getElementById('overall-progress-text');if(progressBar&&progressText){progressBar.style.width=`${progressPercentage}%`;progressText.textContent=`${progressPercentage}% Complete`;}else{console.warn("Overall progress bar elements not found.");}return progressPercentage;}

        // --- Event Listeners Setup ---
        function setupEventListeners(currentUser) { /* ... (unchanged) ... */ if(!currentUser?.email)return;document.querySelectorAll('.editable-answer').forEach(f=>{const eT=(f.tagName==='TEXTAREA'||f.type==='text')?'input':'change';f.addEventListener(eT,function(){const qId=this.dataset.question;if(qId){const eId=`error-${qId}`;this.classList.remove('required-field');hideError(eId);if(!this.disabled){const buttonContainer=this.closest('li, .question-box')||this.parentElement;const saveButton=buttonContainer?.querySelector('.save-button');if(saveButton&&saveButton.textContent!=='Saved ✔️'){saveButton.disabled=false;}}}});});const cB=document.getElementById('completeButton');if(cB){cB.addEventListener('click',()=>handleCompleteButtonClick(currentUser.email));}else{console.warn("Complete button not found.");}}
        function handleCompleteButtonClick(userEmail) { /* ... (unchanged) ... */ if(!userEmail){alert("Session error. Please log in again.");logout();return;}if(!validateAllAnswers(true)){showGeneralWarningMessage('Please complete all required fields marked with *');console.log("Validation failed.");}else{console.log("Validation passed.");markPlanAsComplete(userEmail);}}

        // --- UI Feedback & Validation ---
        function validateAllAnswers(showErrors = false) { /* ... (unchanged - still validates required fields) ... */ let allValid=true;let firstInvalidField=null;console.log("AP: Validating all answers...");const generalWarningDiv=document.getElementById('generalInlineWarningMessage');if(generalWarningDiv)generalWarningDiv.style.display='none';requiredQuestionIds.forEach(qId=>{const field=document.querySelector(`[data-question="${qId}"]`);if(field){const eId=`error-${qId}`;hideError(eId);field.classList.remove('required-field');if(!field.disabled&&String(field.value).trim()===''){allValid=false;if(!firstInvalidField)firstInvalidField=field;if(showErrors){field.classList.add('required-field');showError(eId,null,'Required.');}}}else{console.warn(`Required field with data-question="${qId}" not found!`);allValid=false;}});if(!allValid&&showErrors&&firstInvalidField){firstInvalidField.scrollIntoView({behavior:'smooth',block:'center'});setTimeout(()=>{try{firstInvalidField.focus({preventScroll:true});}catch(e){console.warn("Focus failed:",e)}},400);}else if(!allValid&&showErrors){showGeneralWarningMessage('Please complete all required fields marked with *');if(generalWarningDiv){generalWarningDiv.textContent='Please scroll up and complete all required fields marked with *.';generalWarningDiv.style.display='block';}}console.log("AP Validation result:",allValid);return allValid;}
        function showGeneralWarningMessage(message = 'Action Required: Please complete all required fields marked with *', sticky = false) { /* ... (unchanged) ... */ const w=document.getElementById('generalWarningMessage');if(!w)return;w.innerHTML=`<strong>${message.includes(':')?message.split(':')[0]:'Warning'}:</strong> ${message.includes(':')?message.split(':')[1].trim():message}`;w.style.animation='none';void w.offsetWidth;w.style.display='block';w.style.animation='slideDownFadeIn 0.4s ease-out';clearTimeout(w.timer);if(!sticky){w.timer=setTimeout(()=>{w.style.animation='fadeOutUp 0.5s ease-out forwards';setTimeout(()=>{if(w.style.animationName==='fadeOutUp'){w.style.display='none';w.style.animation='';}},500);},4000);}}
        function hideGeneralWarningMessage() { /* ... (unchanged) ... */ const w=document.getElementById('generalWarningMessage');if(w&&w.style.display!=='none'){w.style.animation='fadeOutUp 0.5s ease-out forwards';setTimeout(()=>{if(w.style.animationName==='fadeOutUp'){w.style.display='none';w.style.animation='';}},500);}}
        function showError(errorId, fieldToMark, message = 'Required.') { /* ... (unchanged) ... */ const e=document.getElementById(errorId);if(!e)return;e.textContent=message;e.style.color='#e74c3c';e.style.display='block';if(fieldToMark)fieldToMark.classList.add('required-field');}
        function hideError(errorId) { /* ... (unchanged) ... */ const e=document.getElementById(errorId);if(e){e.style.display='none';e.textContent='';}}
        function hideMessages(statusId, errorId, field) { // Hides error and ensures field isn't highlighted
             hideError(errorId);
             // Don't hide the persistent status message here, only errors
             // const s = statusId ? document.getElementById(statusId) : null; if(s)s.style.display='none';
             if (field) field.classList.remove('required-field');
         }


        // --- Actions (Save/Delete Single Fields/Cells) ---
        // --- CORRECTED saveAnswer for 'Save Once' Behavior ---
        window.saveAnswer = async function(questionId) {
            if (!supabase) { alert('Database connection error. Cannot save.'); return; }
            const currentUser = getCurrentUser(); if (!currentUser?.email || !currentUser.id) { alert('Session expired.'); logout(); return; }

            const field = document.querySelector(`[data-question="${questionId}"]`); if (!field) { console.error("Save Error: Field missing for", questionId); return; }

            const errorId = `error-${questionId}`;
            const statusId = `save-status-${questionId}`;
            const statusElement = document.getElementById(statusId); // Find status span
            const buttonContainer = field.closest('li, .question-box') || field.parentElement;
            const buttonGroup = buttonContainer?.querySelector('.answer-buttons');
            const saveButton = buttonGroup?.querySelector('.save-button');
            const deleteButton = buttonGroup?.querySelector('.delete-button');

            if (!buttonGroup || !saveButton || !deleteButton) { // Check if button group exists
                console.error(`Save Error: Button group or buttons missing for ${questionId}.`);
                showError(errorId, field, 'Internal Error: UI component missing.');
                return;
            }
            if (field.disabled) { console.warn(`Attempted to save already saved answer: ${questionId}.`); return; }

            const answer = field.value;
            const trimmedAnswer = String(answer).trim();
            const isRequired = field.classList.contains('required-answer');

            hideMessages(statusId, errorId, field); // Clear only errors

            if (isRequired && trimmedAnswer === '') {
                showError(errorId, field, 'Required field cannot be empty.');
                if (statusElement) statusElement.style.display = 'none'; // Ensure status hidden if error shown
                updateOverallProgress();
                return;
            }

            // Visual feedback: disable buttons immediately
            saveButton.disabled = true; saveButton.textContent = 'Saving...';
            deleteButton.disabled = true;

            try {
                // ... (Get questionText - unchanged) ...
                let questionText = `Answer for ${questionId}`;
                const qTextElement = field.closest('li')?.previousElementSibling || field.closest('.question-box')?.querySelector('h4') || field.previousElementSibling;
                if (qTextElement && (qTextElement.tagName === 'H4' || qTextElement.tagName === 'P' || qTextElement.tagName === 'LABEL')) {
                    questionText = qTextElement.textContent.replace(/\*/g,'').replace(/\s+/g, ' ').trim();
                } else {
                    const parentBox = field.closest('.question-box');
                    const boxH4 = parentBox?.querySelector('h4');
                    if(boxH4) { questionText = boxH4.textContent.replace(/\*/g,'').replace(/\s+/g, ' ').trim() + ` (${questionId})`;}
                }

                const submissionTime = new Date().toISOString();
                const userProgressPayload = { /* ... (payload unchanged) ... */ user_id: currentUser.id, email: currentUser.email, question_id: questionId, question_text: questionText.substring(0, 250), answer: answer, page: PAGE_NAME, status: 'completed', submitted_at: submissionTime, updated_at: submissionTime, section_type: 'action_plan', section_id: SECTION_ID, section_title: document.title || 'Coaching Action Plan', progress_percentage: 100, score: null, is_passed: null };

                const { data, error } = await supabase.from('user_progress').upsert([userProgressPayload], { onConflict: ['user_id', 'question_id'] }).select();

                if (error) { throw new Error(`Supabase error: ${error.message} (Code: ${error.code})`); }

                // --- Update UI on SUCCESS ---
                field.disabled = true;
                field.classList.remove('required-field');

                if (buttonGroup) { // Hide Button Group
                    buttonGroup.style.display = 'none';
                } else { console.warn(`Save Success [${questionId}]: Button group not found to hide.`); }

                if (statusElement) { // Show Persistent Status
                    statusElement.textContent = 'Saved ✅';
                    statusElement.style.display = 'inline-block';
                    statusElement.classList.remove('deleted');
                    statusElement.style.color = '#27ae60';
                } else { console.warn(`Save Success [${questionId}]: Status span #${statusId} not found.`); }

                saveAnswerToStorage(currentUser.email, questionId, answer);
                updateOverallProgress();

            } catch (error) {
                 console.error(`[${questionId}] CAUGHT ERROR during save:`, error);
                 showError(errorId, field, `Save failed. Try again.`);
                 // --- Restore UI on Failure ---
                 field.disabled = false; // Re-enable field
                 if (buttonGroup) buttonGroup.style.display = 'flex'; // Show buttons again
                 if (saveButton) { saveButton.disabled = false; saveButton.textContent = 'Save'; }
                 if (deleteButton) { deleteButton.disabled = false; deleteButton.style.display = 'inline-block';}
                 if (statusElement) statusElement.style.display = 'none'; // Hide status message
                 updateOverallProgress();
            }
        }
        // --- END OF saveAnswer ---

        // --- CORRECTED deleteAnswer for 'Save Once' Behavior ---
        window.deleteAnswer = async function(questionId) {
            const field = document.querySelector(`[data-question="${questionId}"]`); if (!field) return;

            // --- Prevent deletion if already saved ---
            if (field.disabled) {
                 console.warn(`Attempted to delete already saved/disabled answer: ${questionId}. Action prevented.`);
                 // Maybe provide visual feedback? A temporary message?
                 const errorId = `error-${questionId}`;
                 const existingError = document.getElementById(errorId);
                 if (existingError) {
                     existingError.textContent = "Saved answers cannot be deleted.";
                     existingError.style.display = 'block';
                     setTimeout(() => { hideError(errorId); }, 3000); // Hide message after 3s
                 }
                 return;
            }
            // --- End Prevention ---

            // If somehow called on an unsaved field (e.g., user clicks delete before save finishes/fails)
            // The confirm dialog is removed as per the requirement (no deletion after save).
            // If needed for unsaved items, add confirm() back here.

            const currentUser = getCurrentUser(); if (!currentUser?.email || !currentUser.id) { return; } // Need user for storage

            const errorId = `error-${questionId}`;
            const statusId = `save-status-${questionId}`;
            const statusElement = document.getElementById(statusId);
            const buttonContainer = field.closest('li, .question-box') || field.parentElement;
            const buttonGroup = buttonContainer?.querySelector('.answer-buttons');
            const saveButton = buttonGroup?.querySelector('.save-button');
            const deleteButton = buttonGroup?.querySelector('.delete-button');

            hideMessages(statusId, errorId, field); // Clear errors, doesn't affect persistent status yet
            field.value = (field.type === 'date') ? '' : ''; // Clear the field

            // Since deletion is prevented for saved items, this part only runs if somehow
            // delete is clicked on an *unsaved* item.
             deleteAnswerFromStorage(currentUser.email, questionId); // Remove potential draft from storage
             console.log("Cleared unsaved answer locally for", questionId);

            // Reset UI elements (buttons remain visible, field enabled)
            field.classList.remove('required-field');
            if (statusElement) statusElement.style.display = 'none'; // Ensure status is hidden
            if (saveButton) { saveButton.disabled = false; saveButton.textContent = 'Save';} // Ensure save is usable
            if (deleteButton) { deleteButton.disabled = false; deleteButton.style.display = 'inline-block';} // Ensure delete is usable
            updateOverallProgress();
        }
        // --- END OF deleteAnswer ---


        // --- Completion Handling ---
        function markPlanAsComplete(userEmail) { /* ... (unchanged) ... */ if(!userEmail)return;if(!validateAllAnswers(false)){showGeneralWarningMessage('Cannot complete: Missing required answers.');return;}const k=`${localStorageKey}_completed_${userEmail}`;console.log('AP: Marking complete with key:',k);try{localStorage.setItem(k,'true');updateOverallProgress(100);displayCompletionState();const cM=document.getElementById('completionMessage');if(cM){cM.style.display='block';cM.scrollIntoView({behavior:'smooth',block:'center'});}hideGeneralWarningMessage();const generalWarningDiv=document.getElementById('generalInlineWarningMessage');if(generalWarningDiv)generalWarningDiv.style.display='none';logCompletionEvent(userEmail);}catch(e){console.error("AP: Error saving completion status:",e);alert("Could not save completion status due to storage error.");}}
        async function logCompletionEvent(userEmail) { /* ... (unchanged) ... */ if(!supabase||!userEmail)return;const currentUser=getCurrentUser();if(!currentUser||!currentUser.id)return;console.log(`Logging completion event for ${userEmail} on ${PAGE_NAME}`);try{const{error}=await supabase.from('user_progress').insert([{user_id:currentUser.id,email:userEmail,question_id:`${SECTION_ID}_completion_marker`,question_text:`Action Plan Marked Complete`,answer:'Completed',page:PAGE_NAME,status:'completed',submitted_at:new Date().toISOString(),updated_at:new Date().toISOString(),section_type:'completion_status',section_id:SECTION_ID,section_title:document.title||'Coaching Action Plan',progress_percentage:100,score:null,is_passed:true}]);if(error)console.error("Error logging completion event to Supabase:",error);else console.log("Completion event logged successfully.");}catch(e){console.error("Exception while logging completion event:",e);}}
        function checkCompletionState(userEmail) { /* ... (unchanged - relies on loadFieldState) ... */ if(!userEmail)return;const completionKey=`${localStorageKey}_completed_${userEmail}`;const isComplete=localStorage.getItem(completionKey)==='true';const cM=document.getElementById('completionMessage');const cB=document.getElementById('completeButton');const bB=document.getElementById('backButton');const generalWarningDiv=document.getElementById('generalInlineWarningMessage');if(generalWarningDiv)generalWarningDiv.style.display='none';if(isComplete){console.log("AP: Plan is already marked complete for",userEmail);displayCompletionState();}else{console.log("AP: Plan not complete for",userEmail);if(cM)cM.style.display='none';if(cB){cB.style.display='block';cB.disabled=false;}if(bB){bB.textContent='← Back to Self Coaching';bB.href='coaching-yourself.html';}updateOverallProgress();}}
        function displayCompletionState() { /* ... (unchanged - locks UI correctly) ... */ console.log('AP: Displaying completion state UI');const cM=document.getElementById('completionMessage');const cB=document.getElementById('completeButton');const bB=document.getElementById('backButton');const generalWarningDiv=document.getElementById('generalInlineWarningMessage');if(generalWarningDiv)generalWarningDiv.style.display='none';if(cM)cM.style.display='block';if(cB){cB.style.display='none';cB.disabled=true;}const cont=document.querySelector('.container');if(cont){cont.querySelectorAll('textarea, input, select').forEach(el=>{el.disabled=true;el.style.backgroundColor='#f0f0f0';el.style.cursor='not-allowed';});cont.querySelectorAll('.save-button, .delete-button').forEach(el=>{el.disabled=true;el.style.cursor='not-allowed';el.style.backgroundColor='#bdc3c7';el.style.opacity='0.7';if(el.classList.contains('delete-button')){el.style.display='none';}if(el.classList.contains('save-button')){/* Button might already be hidden, but set text just in case */ el.textContent='Saved ✔️';}});}if(bB){bB.textContent='← Back to Dashboard';bB.href='dashboard.html';}updateOverallProgress(100);hideGeneralWarningMessage();}

    </script>

</body>
</html>
