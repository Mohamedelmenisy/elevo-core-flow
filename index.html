<!DOCTYPE html>
<html lang="ar" dir="rtl">  <!-- Added Arabic language and direction -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ ÙÙŠ Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© | ÙƒÙˆØ±Ø³ Ø§Ù„ÙƒÙˆØªØ´ÙŠÙ†Ø¬ ÙˆØ§Ù„Ù‚ÙŠØ§Ø¯Ø©</title> <!-- Updated Title -->
    <!-- Favicon Links (Keep as is) -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <!-- Supabase JS Library (Keep as is) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- Base Styles (Keep most as is, adjusted for RTL) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html { scroll-behavior: smooth; } /* For smooth scrolling */
        body { background-color: #f8fafc; margin: 0; padding: 0; line-height: 1.6; color: #333; display: flex; flex-direction: column; min-height: 100vh; direction: rtl; /* Right-to-left */ }
        main { flex-grow: 1; }
        .header { background-color: #2c3e50; color: white; padding: 15px 0; text-align: center; font-size: 24px; position: relative; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
        .user-bar { background-color: #34495e; padding: 10px 30px; display: flex; justify-content: space-between; align-items: center; color: white; font-size: 15px; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-info svg { opacity: 0.8; margin-left: 8px; /* Adjusted for RTL */ }
        .user-details { display: flex; flex-direction: column; text-align: right; /* Adjusted for RTL */ }
        .user-name { font-weight: 600; font-size: 15px; }
        .user-email { font-size: 13px; opacity: 0.8; }
        .logout-button { background-color: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s; display: flex; align-items: center; gap: 6px; }
        .logout-button svg { margin-left: 6px; /* Adjusted for RTL */ }
        .logout-button:hover { background-color: #c0392b; transform: translateY(-1px); }
        .logout-button:active { transform: translateY(0); }
        .container { max-width: 800px; /* Slightly narrower */ margin: 40px auto; background: white; padding: 30px 40px; /* Adjusted padding */ box-shadow: 0px 0px 20px rgba(0, 0, 0, 0.05); border-radius: 10px; }
        .question-section { margin-bottom: 30px; padding: 25px; background-color: #fdfdff; /* Lighter background */ border-radius: 8px; border: 1px solid #e8eaf6; /* Softer border */ }
        .start-quiz-section { margin-top: 40px; padding: 30px; background-color: #f9f9f9; border-radius: 8px; border: 1px solid #eee; text-align: center; border-top: 3px solid #3498db; /* Accent line */ display: none; /* Initially hidden */ opacity: 0; transition: opacity 0.5s ease-in-out; }
        .start-quiz-section.visible { display: block; opacity: 1; }

        /* --- Footer Styling (Keep as is, check RTL icons if needed) --- */
        .footer { text-align: center; padding: 20px 30px; background: #2c3e50; color: rgba(255, 255, 255, 0.8); margin-top: 40px; font-size: 14px; display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 25px; }
        /* ... (rest of footer styles are fine) ... */
         .footer-text { text-align: center; }
        .social-icons { display: flex; gap: 18px; align-items: center; }
        .social-icons a { color: rgba(255, 255, 255, 0.8); text-decoration: none; display: inline-block; transition: transform 0.3s ease, color 0.3s ease; }
        .social-icons a:hover { color: #ffffff; transform: translateY(-2px); }
        .social-icons svg { width: 22px; height: 22px; fill: currentColor; vertical-align: middle; }

        /* --- Form & Button Styles (Keep base, adjust specific buttons) --- */
        .input-field { width: 100%; padding: 14px; margin: 10px 0; font-size: 16px; border: 1px solid #e0e4e7; border-radius: 8px; transition: all 0.3s; background-color: #f9fafb; direction: rtl; /* Ensure textarea is RTL */}
        .input-field:focus { border-color: #3498db; outline: none; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); background-color: #fff; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }
        .submit-button { background: linear-gradient(90deg, #3498db, #2980b9); color: white; border: none; padding: 14px 25px; font-size: 16px; cursor: pointer; border-radius: 8px; display: block; width: 100%; font-weight: 600; transition: all 0.3s; margin-top: 20px; box-shadow: 0 4px 6px rgba(52, 152, 219, 0.1); }
        .submit-button:hover:not(:disabled) { background: linear-gradient(90deg, #2980b9, #3498db); box-shadow: 0 6px 8px rgba(52, 152, 219, 0.15); transform: translateY(-1px); }
        .submit-button:active:not(:disabled) { transform: translateY(0); }
        .submit-button:disabled { background: #bdc3c7; cursor: not-allowed; box-shadow: none; }
        .error-message { color: #e74c3c; font-size: 14px; margin-top: 8px; display: none; font-weight: 500; text-align: right; /* RTL */ }
        .invalid-field-style { border-color: #e74c3c !important; box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1) !important; }
        h2, h3 { color: #2c3e50; }
        h2 { margin-bottom: 20px; font-size: 28px; text-align: center; }
        h3 { margin: 15px 0 10px; font-size: 20px; /* Slightly smaller */ font-weight: 600; color: #34495e; }
        p { margin-bottom: 15px; color: #555; line-height: 1.7; }

        /* --- Progress Bar Styles --- */
        .progress-container { margin-top: 10px; margin-bottom: 15px; background-color: #ecf0f1; border-radius: 25px; /* Rounded ends */ overflow: hidden; height: 12px; /* Slimmer */ width: 100%; display: none; /* Hidden initially */ }
        .progress-bar { height: 100%; width: 0%; /* Starts at 0 */ background: linear-gradient(90deg, #56ab2f, #a8e063); /* Green gradient */ border-radius: 25px; transition: width 0.4s ease-out; /* Smoother transition */ display: flex; align-items: center; justify-content: center; position: relative; }
        .progress-text { font-size: 9px; /* Smaller text */ font-weight: bold; color: white; text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.3); white-space: nowrap; position: absolute; left: 50%; transform: translateX(-50%); /* Centered */ }

        /* --- Success Message Styles --- */
        .success-message { background-color: #e8f5e9; /* Light green */ color: #2e7d32; /* Darker green text */ border: 1px solid #c8e6c9; /* Soft green border */ padding: 15px 20px; border-radius: 8px; margin: 20px 0; text-align: center; font-weight: 500; display: none; /* Hidden initially */ opacity: 0; transition: opacity 0.5s ease; }
        .success-message.visible { display: block; opacity: 1; }
        .success-message::before { content: 'âœ…'; margin-left: 10px; /* Space for RTL */ }

        /* --- Scroll Down Indicator --- */
        .scroll-indicator { text-align: center; margin-top: 15px; display: none; /* Hidden initially */ opacity: 0; transition: opacity 0.5s ease; animation: bounce 2s infinite; }
        .scroll-indicator svg { width: 30px; height: 30px; fill: #3498db; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-10px); } 60% { transform: translateY(-5px); } }

        /* --- Start Quiz Button Styles --- */
        .start-quiz-button { display: inline-block; padding: 14px 35px; text-decoration: none; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; transition: background 0.5s ease, color 0.5s ease, box-shadow 0.4s ease, transform 0.3s ease; font-size: 17px; }
        .start-quiz-button.locked { background: linear-gradient(90deg, #adb5bd, #9fa8b0); color: #e9ecef; box-shadow: none; cursor: not-allowed; pointer-events: none; opacity: 0.8; transform: none; }
        .start-quiz-button.unlocked { background: linear-gradient(105deg, #198754, #20c997); color: white; box-shadow: 0 5px 10px rgba(25, 135, 84, 0.3); }
        .start-quiz-button.unlocked:hover { background: linear-gradient(105deg, #1a9960, #25dab3); box-shadow: 0 7px 14px rgba(25, 135, 84, 0.35); transform: translateY(-2px); }
        .start-quiz-button.unlocked:active { background: linear-gradient(105deg, #147546, #1bb88a); transform: translateY(0); box-shadow: 0 3px 6px rgba(25, 135, 84, 0.25); }
        .lock-prompt { color: #777; font-size: 14px; margin-bottom: 15px; font-style: italic; display: block; /* Show by default */ }
        .start-quiz-button.unlocked ~ .lock-prompt { display: none; /* Hide when button is unlocked */ } /* Simple way to hide prompt */

        /* Media query (Keep as is) */
        @media (max-width: 600px) { .footer { flex-direction: column; } .footer-text { text-align: center; } .container { padding: 20px; } }
    </style>
</head>
<body>
    <!-- Header (Keep as is) -->
    <header class="header">ÙƒÙˆØ±Ø³ Ø§Ù„ÙƒÙˆØªØ´ÙŠÙ†Ø¬ ÙˆØ§Ù„Ù‚ÙŠØ§Ø¯Ø©</header>
    <!-- User Bar (Keep as is, content filled by JS) -->
    <div class="user-bar">
        <div class="user-info">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path> <circle cx="12" cy="7" r="4"></circle> </svg>
            <div class="user-details">
                <span class="user-name" id="userName">Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                <span class="user-email" id="userEmail"></span>
            </div>
        </div>
        <button class="logout-button" onclick="logout()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path> <polyline points="16 17 21 12 16 7"></polyline> <line x1="21" y1="12" x2="9" y2="12"></line> </svg>
            ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        </button>
    </div>

    <!-- Main Content -->
    <main class="container" id="mainContainer" style="display: none;">
        <h2>ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø±Ø­Ù„ØªÙƒ Ù†Ø­Ùˆ Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©!</h2>
        <p>Ø§Ø¨Ø¯Ø£ Ø®Ø·ÙˆØªÙƒ Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¨Ø§Ù„ØªÙÙƒÙŠØ± ÙÙŠ Ø£Ù‡Ø¯Ø§ÙÙƒ. Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø³ØªØ³Ø§Ø¹Ø¯Ùƒ Ø¹Ù„Ù‰ ØªØ±ÙƒÙŠØ² Ø¬Ù‡ÙˆØ¯Ùƒ ÙˆØªÙØªØ­ Ù„Ùƒ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£ÙˆÙ„ÙŠ.</p>

        <!-- Introductory Question Section -->
        <div class="question-section" id="introQuestionSection">
            <h3>Ø®Ø·ÙˆØªÙƒ Ø§Ù„Ø£ÙˆÙ„Ù‰: Ù…Ø§ Ù‡Ùˆ Ù‡Ø¯ÙÙƒØŸ</h3>
            <p>Ù…Ø§ Ù‡Ùˆ Ù‡Ø¯ÙÙƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø§Ù„Ø°ÙŠ ØªØ³Ø¹Ù‰ Ù„ØªØ­Ù‚ÙŠÙ‚Ù‡ Ù…Ù† Ø®Ù„Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ±Ø³ØŸ (Ø§ÙƒØªØ¨ 25 Ø­Ø±ÙÙ‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)</p>
            <form id="introGoalForm" novalidate>
                <label for="goalAnswer" class="sr-only">Ø¥Ø¬Ø§Ø¨ØªÙƒ Ø¹Ù† Ù‡Ø¯ÙÙƒ</label>
                <textarea id="goalAnswer" class="input-field" placeholder="Ø§ÙƒØªØ¨ Ù‡Ø¯ÙÙƒ Ù‡Ù†Ø§..." rows="5" required minlength="25" data-question-id="intro_goal"></textarea>

                <!-- Progress Bar -->
                <div class="progress-container" id="goalProgressContainer">
                    <div class="progress-bar" id="goalProgressBar">
                        <span class="progress-text" id="goalProgressText">0%</span>
                    </div>
                </div>

                <p id="goalErrorMessage" class="error-message" aria-live="polite"></p> <!-- For accessibility -->
                <button type="submit" class="submit-button" id="submitGoalButton">Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¬Ø§Ø¨ØªÙŠ</button>
            </form>
        </div>

        <!-- Success Message Area -->
        <div id="successMessageArea" class="success-message" aria-live="polite">
            Ø±Ø§Ø¦Ø¹! ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø¥Ø¬Ø§Ø¨ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­.
        </div>

        <!-- Scroll Down Indicator -->
        <div id="scrollIndicator" class="scroll-indicator">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 15.586l-4.293-4.293a1 1 0 0 0-1.414 1.414l5 5a1 1 0 0 0 1.414 0l5-5a1 1 0 0 0-1.414-1.414L12 15.586z"/><path d="M12 8.586l-4.293-4.293a1 1 0 1 0-1.414 1.414l5 5a1 1 0 0 0 1.414 0l5-5a1 1 0 1 0-1.414-1.414L12 8.586z"/></svg>
        </div>

        <!-- Start Quiz Section (Initially Hidden/Locked) -->
        <section id="startQuizSection" class="start-quiz-section" aria-labelledby="startQuizHeading">
            <h3 id="startQuizHeading" style="margin-bottom: 10px;">Ø£Ù†Øª Ø§Ù„Ø¢Ù† Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø¯Ø¡!</h3>
            <span class="lock-prompt" id="quizLockPrompt">Ø£Ø¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø£Ø¹Ù„Ø§Ù‡ Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£ÙˆÙ„ÙŠ.</span>
            <a href="Assessment.html" id="startQuizButton" class="start-quiz-button locked" aria-describedby="quizLockPrompt">
                ğŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£ÙˆÙ„ÙŠ
            </a>
        </section>

    </main>

    <!-- Footer (Keep as is) -->
    <footer class="footer">
      <span class="footer-text">Â© 2025 Elmenisy Leadership Coaching - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</span>
      <div class="social-icons">
          <a href="https://www.linkedin.com/in/mohamedmenisy17/" target="_blank" rel="noopener noreferrer" aria-label="LinkedIn Profile"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg> </a>
          <a href="https://wa.me/201014527321" target="_blank" rel="noopener noreferrer" aria-label="WhatsApp Chat"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01s-.521.074-.792.372c-.272.296-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg> </a>
          <a href="https://www.instagram.com/mohamed_menisyy/profilecard/?igsh=d3ZwZDM4czRqMzB2" target="_blank" rel="noopener noreferrer" aria-label="Instagram Profile"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 1.172.053 1.905.33 2.46.538.7.268 1.192.64 1.64 1.092.45.447.83 1.004 1.093 1.64.208.555.485 1.288.538 2.46.058 1.265.07 1.646.07 4.85s-.012 3.584-.07 4.85c-.053 1.172-.33 1.905-.538 2.46-.268.7-.64 1.192-1.092 1.64-.447.45-.997.827-1.64 1.093-.555.208-1.288.485-2.46.538-1.265.058-1.646.07-4.85.07s-3.584-.012-4.85-.07c-1.172-.053-1.905-.33-2.46-.538-.697-.268-1.19-.64-1.64-1.093-.45-.447-.827-.997-1.093-1.64-.208-.555-.485-1.288-.538-2.46-.058-1.265-.07-1.646-.07-4.85s.012-3.584.07-4.85c.053-1.172.33-1.905.538-2.46.268-.697.64-1.19 1.093-1.64.45-.45.997-.827 1.64-1.093.555-.208 1.288.485 2.46.538 1.265-.058 1.646-.07 4.85-.07zm0-2.163c-3.259 0-3.667.014-4.947.072-1.356.06-2.31.344-3.174.732-.884.396-1.627.96-2.377 1.71-.755.752-1.318 1.494-1.716 2.378-.386.863-.67 1.818-.73 3.172C.014 8.333 0 8.741 0 12s.014 3.667.072 4.947c.06 1.356.344 2.31.73 3.174.396.884.96 1.627 1.716 2.377.752.755 1.494 1.318 2.378 1.716.863.386 1.818.67 3.172.73 1.28.058 1.688.072 4.947.072s3.667-.014 4.947-.072c1.356-.06 2.31-.344 3.174-.73.884-.396 1.627-.96 2.377-1.716.755-.752 1.318-1.494 1.716-2.378.386.863.67-1.818.73-3.172.058-1.28.072-1.688.072-4.947s-.014-3.667-.072-4.947c-.06-1.356-.344-2.31-.73-3.174-.396-.884-.96-1.627-1.716-2.377-.752-.755-1.494-1.318-2.378-1.716-.863-.386-1.818-.67-3.172-.73C15.667.014 15.259 0 12 0zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.162 6.162 6.162 6.162-2.759 6.162-6.162S15.403 5.838 12 5.838zm0 10.333c-2.306 0-4.171-1.865-4.171-4.171s1.865-4.171 4.171-4.171 4.171 1.865 4.171 4.171-1.865 4.171-4.171 4.171zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg> </a>
      </div>
    </footer>

    <!-- NO MODAL NEEDED FOR THIS PAGE - Using inline success message -->

    <script>
        // --- Supabase Configuration (Keep as is) ---
        const SUPABASE_URL = 'https://lgcutmuspcaralydycmg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnY3V0bXVzcGNhcmFseWR5Y21nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0NDY3MDEsImV4cCI6MjA2MTAyMjcwMX0.3u5Y7pkH2NNnnoGLMWVfAa5b8fq88o1itRYnG1K38tE';
        let supabase = null;

        // --- Unified Keys & Configuration ---
        const LOGGED_IN_KEY = 'isUserLoggedIn';
        const CURRENT_USER_KEY = 'currentUser';
        const SIGNUP_FLAG_KEY = 'hasSignedUpBefore';
        // --- NEW: Key for storing intro goal completion ---
        const INTRO_GOAL_COMPLETED_KEY = 'introGoalCompleted_v1'; // Added version for potential future changes
        const INTRO_GOAL_ANSWER_KEY = 'introGoalAnswer_v1';
        const MIN_ANSWER_LENGTH = 25; // Set minimum length for the goal answer

        // Initialize Supabase Client (Keep as is)
        try {
            if (window.supabase && window.supabase.createClient) {
                 supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                 console.log("Supabase client initialized successfully.");
            } else { throw new Error("Supabase library not found."); }
        } catch (error) { console.error("CRITICAL ERROR initializing Supabase:", error); /* Consider user feedback */ }

        // ***** ---> IMMEDIATE REDIRECTION LOGIC <--- ***** (Keep as is)
        console.log("%cIndex Page: Running IMMEDIATE redirection check...", "color: purple; font-weight: bold;"); function quickCheckCurrentUser() { const data = localStorage.getItem(CURRENT_USER_KEY); return data && data.startsWith('{') && data.endsWith('}'); } const isLoggedIn_immediate = localStorage.getItem(LOGGED_IN_KEY) === 'true' && quickCheckCurrentUser(); const hasSignedUp_immediate = localStorage.getItem(SIGNUP_FLAG_KEY) === 'true'; const currentPage_immediate = window.location.pathname.split('/').pop() || 'index.html'; console.log(`Index Page IMMEDIATE Check: isLoggedIn=${isLoggedIn_immediate}, hasSignedUp=${hasSignedUp_immediate}, currentPage=${currentPage_immediate}`); if (!isLoggedIn_immediate && (currentPage_immediate === 'index.html' || currentPage_immediate === '')) { const targetUrl = hasSignedUp_immediate ? 'login.html' : 'signup.html'; console.error(`%cIndex Page IMMEDIATE Redirect: Not logged in. Redirecting to ${targetUrl}...`, "color: orange;"); window.location.replace(targetUrl); throw new Error("Redirecting user based on initial check."); } else if (isLoggedIn_immediate) { console.log("%cIndex Page IMMEDIATE Check: User IS logged in. Proceeding.", "color: green;"); } else { console.log(`%cIndex Page IMMEDIATE Check: Not logged in but not on index.html (${currentPage_immediate}). No redirect needed.`, "color: grey;"); }

        // --- DOM Element References ---
        let userNameDisplay, userEmailDisplay, mainContainer, introGoalForm, goalAnswerInput, goalErrorMessage, submitGoalButton, goalProgressContainer, goalProgressBar, goalProgressText, successMessageArea, scrollIndicator, startQuizSection, startQuizButton, introQuestionSection;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log("%cIndex page: DOMContentLoaded event fired.", "color: green;");
            mainContainer = document.getElementById('mainContainer');
            try {
                // Assign elements
                userNameDisplay = document.getElementById('userName');
                userEmailDisplay = document.getElementById('userEmail');
                introGoalForm = document.getElementById('introGoalForm');
                goalAnswerInput = document.getElementById('goalAnswer');
                goalErrorMessage = document.getElementById('goalErrorMessage');
                submitGoalButton = document.getElementById('submitGoalButton');
                goalProgressContainer = document.getElementById('goalProgressContainer');
                goalProgressBar = document.getElementById('goalProgressBar');
                goalProgressText = document.getElementById('goalProgressText');
                successMessageArea = document.getElementById('successMessageArea');
                scrollIndicator = document.getElementById('scrollIndicator');
                startQuizSection = document.getElementById('startQuizSection');
                startQuizButton = document.getElementById('startQuizButton');
                introQuestionSection = document.getElementById('introQuestionSection');


                if (!mainContainer || !userNameDisplay || !userEmailDisplay || !introGoalForm || !goalAnswerInput || !goalErrorMessage || !submitGoalButton || !goalProgressContainer || !goalProgressBar || !goalProgressText || !successMessageArea || !scrollIndicator || !startQuizSection || !startQuizButton || !introQuestionSection) {
                    throw new Error("Essential DOM elements for initialization not found!");
                }

                if (!supabase && submitGoalButton) {
                     console.warn("Supabase client not available. Disabling submit.");
                     setButtonLoading(true, 'Ø§Ù„Ø§ØªØµØ§Ù„ ØºÙŠØ± Ù…ØªØ§Ø­');
                }

                const currentUser = getCurrentUser();
                if (!currentUser || !currentUser.id) { // Check for ID as well
                     console.error("Index DOMContentLoaded: Failsafe check - User data or ID missing! Redirecting.");
                     const failsafeTarget = localStorage.getItem(SIGNUP_FLAG_KEY) === 'true' ? 'login.html' : 'signup.html';
                     window.location.replace(failsafeTarget);
                     return; // Stop further execution
                }

                console.log(`%cIndex DOMContentLoaded: User verified (${currentUser.email}, ID: ${currentUser.id}). Initializing page content.`, "color: green;");
                initializePageContent(currentUser);
                if(mainContainer) mainContainer.style.display = 'block'; // Show content only after checks pass
                console.log("Index page content successfully initialized and displayed.");

            } catch (error) { console.error("CRITICAL ERROR during DOMContentLoaded or initializePageContent:", error); if(mainContainer){ mainContainer.innerHTML = `<p style="color: red; font-weight: bold; text-align: center; padding: 30px;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ«. Ø§Ù„Ø®Ø·Ø£: ${error.message}</p>`; mainContainer.style.display = 'block'; } else { document.body.innerHTML = `<p style="color: red; padding: 20px;">Ø®Ø·Ø£ Ø­Ø±Ø¬: Ù‡ÙŠÙƒÙ„ Ø§Ù„ØµÙØ­Ø© ØºÙŠØ± Ù…ÙƒØªÙ…Ù„ Ø£Ùˆ Ø®Ø·Ø£ Ø¨Ø±Ù…Ø¬ÙŠ ÙƒØ¨ÙŠØ±. (${error.message})</p>`; } }
        });

        function initializePageContent(currentUser) {
            console.log("%cIndex page: Running initializePageContent()...", "color: blue;");
            displayUserInfo(currentUser);
            checkIntroGoalStatus(); // Check if already answered
            addEventListeners();
            console.log("initializePageContent() finished successfully.");
        }

        // --- Core User Functions (Keep getCurrentUser, saveCurrentUser, displayUserInfo, logout as is) ---
        function getCurrentUser() {
             try {
                 const userData = localStorage.getItem(CURRENT_USER_KEY);
                 if (!userData) return null;
                 const user = JSON.parse(userData);
                 // IMPORTANT: Ensure the user object stored includes the 'id' field from Supabase Auth
                 if (user && typeof user === 'object' && user.email && user.id) { // Check for id
                     // If name is missing, try to add a default or handle it
                     if (!user.name) user.name = user.email.split('@')[0]; // Simple default name
                     return user;
                 } else {
                     console.warn("Stored user data is invalid or missing ID. Clearing.");
                     localStorage.removeItem(CURRENT_USER_KEY);
                     localStorage.removeItem(LOGGED_IN_KEY);
                     return null;
                 }
             } catch (e) {
                 console.error("Error parsing current user data:", e);
                 localStorage.removeItem(CURRENT_USER_KEY);
                 localStorage.removeItem(LOGGED_IN_KEY);
                 return null;
             }
         }
        function saveCurrentUser(userObject) { /* ... keep original ... */ localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(userObject));}
        function displayUserInfo(currentUser) {
            try {
                let uN = 'Ø²Ø§Ø¦Ø±';
                let uE = '';
                if (currentUser) {
                    // Use name if available, otherwise derive from email
                    uN = currentUser.name || currentUser.email.split('@')[0];
                    uE = currentUser.email || '';
                }
                if (userNameDisplay) userNameDisplay.textContent = `Ø£Ù‡Ù„Ø§Ù‹ØŒ ${uN}`;
                if (userEmailDisplay) userEmailDisplay.textContent = uE;
            } catch (err) { console.error("Error in displayUserInfo:", err); }
        }
        function logout() {
            try {
                localStorage.removeItem(LOGGED_IN_KEY);
                localStorage.removeItem(CURRENT_USER_KEY);
                localStorage.removeItem(INTRO_GOAL_COMPLETED_KEY); // Clear completion flag
                localStorage.removeItem(INTRO_GOAL_ANSWER_KEY); // Clear saved answer
                localStorage.removeItem(SIGNUP_FLAG_KEY); // Optional: clear this too if you want fresh signup check
                console.log("User logged out, relevant keys cleared.");
                window.location.href = 'login.html';
            } catch (e) { console.error("Logout error:", e); window.location.href = 'login.html'; }
        }

        // --- NEW: Check if intro goal was already completed ---
        function checkIntroGoalStatus() {
            try {
                const isCompleted = localStorage.getItem(INTRO_GOAL_COMPLETED_KEY) === 'true';
                const savedAnswer = localStorage.getItem(INTRO_GOAL_ANSWER_KEY);

                if (isCompleted) {
                    console.log("Intro goal already completed.");
                    if (goalAnswerInput && savedAnswer) {
                        goalAnswerInput.value = savedAnswer;
                        goalAnswerInput.disabled = true; // Make textarea read-only
                    }
                    if (introQuestionSection) {
                       introQuestionSection.style.opacity = '0.7'; // Dim the completed question section
                       // Optionally hide the submit button entirely if the form is disabled
                       if(submitGoalButton) submitGoalButton.style.display = 'none';
                       if(goalProgressContainer) goalProgressContainer.style.display = 'none'; // Hide progress bar too
                    }
                    unlockStartQuiz(); // Unlock the next section immediately
                    // Don't show success message or scroll indicator on page load if already done
                } else {
                    console.log("Intro goal not yet completed.");
                    lockStartQuiz(); // Ensure quiz section is locked
                    // Ensure form is enabled (default state)
                     if (goalAnswerInput) goalAnswerInput.disabled = false;
                     if (introQuestionSection) introQuestionSection.style.opacity = '1';
                     if(submitGoalButton) submitGoalButton.style.display = 'block';

                }
            } catch (err) {
                console.error("Error in checkIntroGoalStatus:", err);
                // Default to locked state in case of error
                lockStartQuiz();
            }
        }

        // --- Event Listeners ---
        function addEventListeners() {
            try {
                if (introGoalForm) introGoalForm.addEventListener('submit', handleGoalSubmit);
                if (goalAnswerInput) goalAnswerInput.addEventListener('input', handleAnswerInput);
                // Remove keydown listener for Escape modal, as we don't have one here
            } catch (err) { console.error("Error adding event listeners:", err); }
        }

        // --- NEW: Handle Textarea Input for Progress Bar ---
        function handleAnswerInput() {
            hideError(); // Hide error when user starts typing
            try {
                const currentLength = goalAnswerInput.value.trim().length;
                let percentage = Math.min(100, Math.round((currentLength / MIN_ANSWER_LENGTH) * 100));

                if (currentLength > 0) {
                    goalProgressContainer.style.display = 'block';
                    goalProgressBar.style.width = `${percentage}%`;
                    goalProgressText.textContent = `${percentage}%`;
                } else {
                    goalProgressContainer.style.display = 'none'; // Hide if empty
                }
            } catch (err) {
                console.error("Error updating progress bar:", err);
            }
        }

        // --- NEW: Supabase Submission for Intro Goal ---
        async function sendIntroGoalToSupabase(userId, userEmail, userName, answer) {
            if (!supabase) {
                console.error("Supabase client is not initialized. Cannot submit.");
                showError("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø¥Ø¬Ø§Ø¨ØªÙƒ. Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© Ø£Ùˆ ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù….");
                return false;
            }
            // --- Ensure you have user ID ---
             if (!userId) {
                 console.error("User ID is missing. Cannot submit.");
                 showError("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± ÙƒØ§Ù…Ù„Ø©. Ø­Ø§ÙˆÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
                 return false;
            }

            const questionId = goalAnswerInput.dataset.questionId || 'intro_goal'; // Get ID from data attribute
            console.log("Sending intro goal to Supabase:", { userId, userEmail, userName, questionId, answer_length: answer.length });

            try {
                const { data, error } = await supabase
                    .from('assessments') // Target the 'assessments' table
                    .insert([{
                        user_id: userId,         // UUID from auth user
                        user_email: userEmail,   // Email from auth user
                        name: userName,          // Name from auth user (or derived)
                        question_id: questionId, // Specific ID for this question
                        answer: answer,          // The user's typed answer
                        type: 'intro-goal',      // Type identifier for this assessment entry
                        submitted_at: new Date() // Timestamp of submission
                        // score, is_correct, goal_answer, section_id etc. can be null or default if not applicable here
                    }])
                    .select(); // Optionally select the inserted data back

                if (error) {
                    console.error('%cSupabase Insert Error (Intro Goal):', 'color: red;', error);
                    // Handle specific errors if needed (like duplicates, though less likely here if it's just one goal per user)
                    showError(`ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.`);
                    return false;
                }
                console.log('%cSupabase Insert Success (Intro Goal):', 'color: green;', data);
                return true; // Indicate success

            } catch (networkError) {
                console.error('%cNetwork or other error during Supabase submission:', 'color: red;', networkError);
                showError(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©: ${networkError.message}. Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹.`);
                return false;
            }
        }


        // --- Form Submit Handler (Adapted for Intro Goal) ---
        async function handleGoalSubmit(event) {
            event.preventDefault();
            console.log("handleGoalSubmit: Starting...");
            hideError(); // Clear previous errors

            const currentUser = getCurrentUser();
            if (!currentUser || !currentUser.id || !currentUser.email) {
                showError("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", goalAnswerInput);
                return;
            }

            const answer = goalAnswerInput.value.trim();
            const userName = currentUser.name || currentUser.email.split('@')[0]; // Use name or derive

            // Validation
            if (answer.length < MIN_ANSWER_LENGTH) {
                showError(`ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø¥Ø¬Ø§Ø¨Ø© Ø£Ø·ÙˆÙ„ ( ${MIN_ANSWER_LENGTH} Ø­Ø±ÙÙ‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„).`, goalAnswerInput);
                return;
            }

            setButtonLoading(true, 'Ø¬Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...'); // Disable button

            try {
                // Attempt Supabase submission FIRST
                const submissionSuccess = await sendIntroGoalToSupabase(currentUser.id, currentUser.email, userName, answer);

                if (submissionSuccess) {
                    console.log("Supabase submission successful.");
                    // Store completion status and answer LOCALLY only AFTER successful DB submission
                    localStorage.setItem(INTRO_GOAL_COMPLETED_KEY, 'true');
                    localStorage.setItem(INTRO_GOAL_ANSWER_KEY, answer);

                    // --- UI Updates on Success ---
                    // 1. Optionally disable form/textarea
                    goalAnswerInput.disabled = true;
                    if (introQuestionSection) introQuestionSection.style.opacity = '0.7';

                    // 2. Show temporary success message
                    successMessageArea.classList.add('visible');

                    // 3. Hide submit button
                     submitGoalButton.style.display = 'none';


                    // 4. Set timeout to hide success message and show next steps
                    setTimeout(() => {
                        successMessageArea.classList.remove('visible'); // Hide message

                        // 5. Show scroll indicator
                        scrollIndicator.style.display = 'block';
                        requestAnimationFrame(() => { // Ensure display:block is applied before opacity change
                            scrollIndicator.style.opacity = '1';
                        });


                        // 6. Unlock and show the quiz section
                        unlockStartQuiz();

                        // 7. Scroll smoothly to the quiz section
                        startQuizSection.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    }, 2000); // 2 seconds delay

                } else {
                    // Error handled by sendIntroGoalToSupabase (showError was called there)
                    console.warn("Supabase submission failed. Button will be re-enabled.");
                    setButtonLoading(false); // Re-enable button only on failure
                }

            } catch (err) {
                console.error("CRITICAL Error in handleGoalSubmit logic:", err);
                showError(`Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: ${err.message}. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.`);
                setButtonLoading(false); // Re-enable on unexpected error
            }
            // No finally block needed here as button state is managed within try/catch based on success/failure
        }

        // --- UI Control Functions ---
        function lockStartQuiz() {
             if (startQuizButton) {
                startQuizButton.classList.add('locked');
                startQuizButton.classList.remove('unlocked');
                startQuizButton.setAttribute('aria-disabled', 'true');
            }
             if (startQuizSection) startQuizSection.classList.remove('visible'); // Hide it if locked
        }

        function unlockStartQuiz() {
             if (startQuizButton) {
                startQuizButton.classList.remove('locked');
                startQuizButton.classList.add('unlocked');
                startQuizButton.removeAttribute('aria-disabled');
            }
             if (startQuizSection) startQuizSection.classList.add('visible'); // Show it when unlocked
        }

        function setButtonLoading(isLoading, text = 'Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¬Ø§Ø¨ØªÙŠ') {
            if (!submitGoalButton) return;
            submitGoalButton.disabled = isLoading;
            submitGoalButton.textContent = isLoading ? 'Ø¬Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...' : text;
            // Optional: add a class for spinner later
            // submitGoalButton.classList.toggle('loading', isLoading);
        }

        function showError(message, field) {
            try {
                if (goalErrorMessage) {
                    goalErrorMessage.textContent = message;
                    goalErrorMessage.style.display = "block";
                }
                if (field) {
                    field.classList.add('invalid-field-style');
                    field.focus();
                }
                console.error("Displayed error to user:", message);
            } catch (err) { console.error("Error in showError:", err); }
        }

        function hideError() {
            try {
                if (goalErrorMessage) goalErrorMessage.style.display = "none";
                if (goalAnswerInput) goalAnswerInput.classList.remove('invalid-field-style');
            } catch (err) { console.error("Error in hideError:", err); }
        }

    </script>
</body>
</html>
