<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Start Your Leadership Journey | Coaching & Leadership Course</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- Base Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html { scroll-behavior: smooth; }
        body { background-color: #f8fafc; margin: 0; padding: 0; line-height: 1.65; /* Slightly increased line-height */ color: #374151; display: flex; flex-direction: column; min-height: 100vh; font-size: 16px; /* Base font size for desktop */ }
        main { flex-grow: 1; }
        .header { background-color: #1f2937; color: white; padding: 18px 0; text-align: center; font-size: 1.5rem; /* Use rem */ font-weight: 600; position: relative; box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1); }
        .user-bar { background-color: #374151; padding: 10px 30px; display: flex; justify-content: space-between; align-items: center; color: #e5e7eb; font-size: 0.95rem; /* Use rem */ }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-info svg { opacity: 0.8; margin-right: 8px; width: 24px; height: 24px; }
        .user-details { display: flex; flex-direction: column; text-align: left; }
        .user-name { font-weight: 600; font-size: 0.95rem; color: #f9fafb; }
        .user-email { font-size: 0.8rem; opacity: 0.8; }
        .logout-button { background-color: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s; display: flex; align-items: center; gap: 6px; font-size: 0.9rem; /* Use rem */}
        .logout-button svg { margin-right: 6px; width: 18px; height: 18px; }
        .logout-button:hover { background-color: #dc2626; transform: translateY(-1px); }
        .logout-button:active { transform: translateY(0); }
        .container { max-width: 850px; margin: 40px auto; background: white; padding: 35px 45px; box-shadow: 0 4px 25px rgba(0, 0, 0, 0.07); border-radius: 12px; width: 92%; }

        /* --- Intro & Quote Styles --- */
        .intro-text { margin-bottom: 25px; font-size: 1.05rem; /* Adjusted */ color: #4b5563; }
        .author-name { color: #f59e0b; font-weight: 600; }
        .quote-block { background-color: #f9fafb; border-left: 5px solid #3b82f6; padding: 25px 30px; margin: 30px 0; font-style: italic; border-radius: 0 8px 8px 0; position: relative; }
        .quote-block p { margin-bottom: 10px; font-size: 1.1rem; /* Adjusted */ color: #374151; }
        .quote-block p:last-child { font-style: normal; text-align: right; font-weight: 500; color: #6b7280; }
        .course-image { width: 100%; height: auto; max-height: 400px; object-fit: cover; margin: 35px 0; border-radius: 10px; border: 1px solid #e5e7eb; box-shadow: 0 5px 15px rgba(0,0,0,0.06); }

        /* --- Question Section Styles --- */
        .question-section { margin-bottom: 30px; padding: 30px; background-color: #ffffff; border-radius: 8px; border: 1px solid #e5e7eb; position: relative; }
        .lock-prompt-container { text-align: center; margin-bottom: 20px; min-height: 40px; /* Reserve space */ }
        #lockPromptText { display: inline-block; background-color: #fef2f2; color: #dc2626; padding: 8px 18px; border-radius: 20px; font-size: 0.9rem; /* Adjusted */ font-weight: 500; border: 1px solid #fecaca; animation: pulse-red 2.5s infinite ease-in-out; transition: opacity 0.3s ease; /* Add transition */ }
        #lockPromptText.hidden { /* Class to hide smoothly */
             opacity: 0;
             pointer-events: none; /* Prevent interaction when hidden */
        }
        @keyframes pulse-red { /* Keep animation */ }
        /* Remove the CSS rule that hides based on .answered class, control via JS .hidden class */

        /* --- Form & Button Styles --- */
        .input-field { width: 100%; padding: 15px; margin: 10px 0; font-size: 1rem; /* Use rem */ border: 1px solid #d1d5db; border-radius: 8px; transition: all 0.3s; background-color: #f9fafb; }
        .input-field:focus { border-color: #3b82f6; outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); background-color: #fff; }
        .sr-only { /* Keep as is */ }
        .submit-button { background: linear-gradient(90deg, #3b82f6, #2563eb); color: white; border: none; padding: 14px 28px; font-size: 1.05rem; /* Use rem */ cursor: pointer; border-radius: 8px; display: block; /* Default */ width: 100%; font-weight: 600; transition: all 0.3s; margin-top: 20px; box-shadow: 0 4px 6px rgba(59, 130, 246, 0.15); }
        /* Add explicit style for hidden button */
        .submit-button.hidden { display: none; }
        .submit-button:hover:not(:disabled) { /* Keep as is */ }
        .submit-button:active:not(:disabled) { /* Keep as is */ }
        .submit-button:disabled { background: #9ca3af; cursor: not-allowed; box-shadow: none; }
        .error-message { color: #ef4444; font-size: 0.9rem; margin-top: 10px; display: none; font-weight: 500; text-align: left; }
        .invalid-field-style { /* Keep as is */ }
        h2, h3 { color: #111827; font-weight: 700; }
        h2 { margin-bottom: 25px; font-size: 1.8rem; /* Use rem */ text-align: center; }
        h3 { margin: 20px 0 15px; font-size: 1.35rem; /* Use rem */ color: #1f2937; }
        p { margin-bottom: 15px; color: #4b5563; line-height: 1.7; font-size: 1rem; /* Base paragraph size */ }

        /* --- Progress Bar Styles --- */
        .progress-container { /* Keep as is */ }
        .progress-bar { /* Keep as is */ }
        .progress-text { /* Keep as is */ }

        /* --- Success Message Styles --- */
        .success-message { /* Keep as is */ }
        .success-message.visible { /* Keep as is */ }
        .success-message::before { /* Keep as is */ }

        /* --- Scroll Down Indicator --- */
        .scroll-indicator { /* Keep as is */ }
        @keyframes bounce { /* Keep as is */ }

        /* --- Start Quiz Section Styles --- */
        .start-quiz-section { /* Keep as is */ }
        .start-quiz-button { /* Keep as is */ }
        .start-quiz-button.locked { /* Keep as is */ }
        .start-quiz-button.unlocked { /* Keep as is */ }
        .start-quiz-button.unlocked:hover { /* Keep as is */ }
        .start-quiz-button.unlocked:active { /* Keep as is */ }

        /* --- Footer Styling --- */
        .footer { /* Keep as is */ }
        .footer-text { /* Keep as is */ }
        .social-icons { /* Keep as is */ }
        .social-icons a { /* Keep as is */ }
        .social-icons a:hover { /* Keep as is */ }
        .social-icons svg { /* Keep as is */ }

        /* --- Media query for Mobile --- */
        @media (max-width: 700px) {
            body { font-size: 15px; /* Slightly smaller base for mobile */ }
            .header { font-size: 1.3rem; padding: 15px 0; }
            .user-bar { padding: 8px 15px; font-size: 0.9rem;}
            .user-name { font-size: 0.9rem; }
            .user-email { font-size: 0.75rem; }
            .logout-button { padding: 6px 12px; font-size: 0.85rem; }
             .logout-button svg { width: 16px; height: 16px; }
            .container { padding: 20px 15px; width: 95%; margin: 20px auto; }
            h2 { font-size: 1.5rem; margin-bottom: 15px;}
            h3 { font-size: 1.2rem; margin: 15px 0 10px;}
            p { font-size: 0.95rem;} /* Adjust relative to body */
            .intro-text { font-size: 0.95rem;}
            .quote-block { padding: 15px 20px; margin: 20px 0;}
            .quote-block p { font-size: 0.95rem;}
            .course-image { margin: 25px 0; max-height: 250px;}
            .question-section { padding: 20px; }
            #lockPromptText { font-size: 0.8rem; padding: 6px 12px;}
            .input-field { padding: 12px; font-size: 0.95rem;}
            .submit-button { padding: 12px 20px; font-size: 1rem;}
            .start-quiz-section { padding: 25px; margin-top: 30px;}
            .start-quiz-button { padding: 12px 30px; font-size: 1rem;}
            .footer { padding: 15px; font-size: 0.8rem; gap: 10px;}
            .social-icons svg { width: 20px; height: 20px;}
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">Coaching & Leadership Course</header>
    <!-- User Bar -->
    <div class="user-bar">
        <div class="user-info">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            <div class="user-details">
                <span class="user-name" id="userName">Loading...</span>
                <span class="user-email" id="userEmail"></span>
            </div>
        </div>
        <button class="logout-button" onclick="logout()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-log-out"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
            Logout
        </button>
    </div>

    <!-- Main Content -->
    <main class="container" id="mainContainer" style="display: none;">
        <h2>ðŸ‘‹ Welcome to the Coaching & Leadership Course!</h2>
        <p class="intro-text">This comprehensive course, expertly developed by <span class="author-name">Mohamed Elmenisy</span>, integrates insightful quizzes and interactive questions designed to sharpen your leadership skills.</p>

        <!-- Quote Block -->
        <div class="quote-block">
            <p>"Great leaders don't set out to be leaders. They set out to make a difference. It's never about the role - always about the goal."</p>
            <p>- Mohamed Elmenisy</p>
        </div>

        <!-- Image -->
        <img src="https://images.unsplash.com/photo-1556761175-5973dc0f32e7?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1032&q=80" alt="Team members collaborating around a laptop" class="course-image">

        <!-- Introductory Question Section -->
        <div class="question-section" id="introQuestionSection">
            <h3>Your First Step: Set Your Goal</h3>
            <p>What is your primary goal for taking this Coaching & Leadership course? (Minimum 25 characters)</p>

             <!-- Animated Lock Prompt -->
             <div class="lock-prompt-container">
                 <!-- The hidden class will be added/removed by JS -->
                <span id="lockPromptText">Answer the question below to unlock the first quiz!</span>
             </div>

            <form id="introGoalForm" novalidate>
                <label for="goalAnswer" class="sr-only">Your Goal Answer</label>
                <textarea id="goalAnswer" class="input-field" placeholder="Type your goal here..." rows="5" required minlength="25"
                          data-question-id="intro_goal_q1"
                          data-question-text="What is your primary goal for taking this Coaching & Leadership course?"></textarea>

                <p id="goalErrorMessage" class="error-message" aria-live="polite"></p>
                 <!-- The hidden class will be added/removed by JS -->
                <button type="submit" class="submit-button" id="submitGoalButton">Submit Your Answer</button>
            </form>

             <!-- Progress Bar (Initially Hidden) -->
             <div class="progress-container" id="goalProgressContainer">
                <div class="progress-bar" id="goalProgressBar">
                    <span class="progress-text" id="goalProgressText">0%</span>
                </div>
             </div>
        </div>

        <!-- Success Message Area -->
        <div id="successMessageArea" class="success-message" aria-live="polite">
           Excellent! Your goal has been submitted successfully.
        </div>

        <!-- Scroll Down Indicator -->
        <div id="scrollIndicator" class="scroll-indicator">
             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 15.586l-4.293-4.293a1 1 0 0 0-1.414 1.414l5 5a1 1 0 0 0 1.414 0l5-5a1 1 0 0 0-1.414-1.414L12 15.586z"/><path d="M12 8.586l-4.293-4.293a1 1 0 1 0-1.414 1.414l5 5a1 1 0 0 0 1.414 0l5-5a1 1 0 1 0-1.414-1.414L12 8.586z"/></svg>
        </div>

        <!-- Start Quiz Section (Visible but Locked Initially) -->
        <section id="startQuizSection" class="start-quiz-section" aria-labelledby="startQuizHeading">
            <h3 id="startQuizHeading" style="margin-bottom: 10px;">Next Step: Leadership Knowledge Check</h3>
            <p style="color: #6b7280; font-size: 15px; margin-bottom: 25px;">Test your foundational knowledge of leadership principles before diving deeper.</p>
            <a href="Assessment.html" id="startQuizButton" class="start-quiz-button locked">
                ðŸš€ Start Quiz 1
            </a>
        </section>

    </main>

    <!-- Footer -->
    <footer class="footer">
      <span class="footer-text">Â© 2025 Elmenisy Leadership Coaching - All Rights Reserved</span>
       <div class="social-icons">
         <a href="https://www.linkedin.com/in/mohamedmenisy17/" target="_blank" rel="noopener noreferrer" aria-label="LinkedIn Profile"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg> </a>
         <a href="https://wa.me/201014527321" target="_blank" rel="noopener noreferrer" aria-label="WhatsApp Chat"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01s-.521.074-.792.372c-.272.296-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg> </a>
         <a href="https://www.instagram.com/mohamed_menisyy/profilecard/?igsh=d3ZwZDM4czRqMzB2" target="_blank" rel="noopener noreferrer" aria-label="Instagram Profile"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 1.172.053 1.905.33 2.46.538.7.268 1.192.64 1.64 1.092.45.447.83 1.004 1.093 1.64.208.555.485 1.288.538 2.46.058 1.265.07 1.646.07 4.85s-.012 3.584-.07 4.85c-.053 1.172-.33 1.905-.538 2.46-.268.7-.64 1.192-1.092 1.64-.447.45-.997.827-1.64 1.093-.555.208-1.288.485-2.46.538-1.265.058-1.646.07-4.85.07s-3.584-.012-4.85-.07c-1.172-.053-1.905-.33-2.46-.538-.697-.268-1.19-.64-1.64-1.093-.45-.447-.827-.997-1.093-1.64-.208-.555-.485-1.288-.538-2.46-.058-1.265-.07-1.646-.07-4.85s.012-3.584.07-4.85c.053-1.172.33-1.905.538-2.46.268-.697.64-1.19 1.093-1.64.45-.45.997.827 1.64-1.093.555-.208 1.288.485 2.46.538 1.265-.058 1.646-.07 4.85-.07zm0-2.163c-3.259 0-3.667.014-4.947.072-1.356.06-2.31.344-3.174.732-.884.396-1.627.96-2.377 1.71-.755.752-1.318 1.494-1.716 2.378-.386.863-.67 1.818-.73 3.172C.014 8.333 0 8.741 0 12s.014 3.667.072 4.947c.06 1.356.344 2.31.73 3.174.396.884.96 1.627 1.716 2.377.752.755 1.494 1.318 2.378 1.716.863.386 1.818.67 3.172.73 1.28.058 1.688.072 4.947.072s3.667-.014 4.947-.072c1.356-.06 2.31-.344 3.174-.73.884-.396 1.627-.96 2.377-1.716.755-.752 1.318-1.494 1.716-2.378.386.863.67-1.818.73-3.172.058-1.28.072-1.688.072-4.947s-.014-3.667-.072-4.947c-.06-1.356-.344-2.31-.73-3.174-.396-.884-.96-1.627-1.716-2.377-.752-.755-1.494-1.318-2.378-1.716-.863-.386-1.818-.67-3.172-.73C15.667.014 15.259 0 12 0zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.162 6.162 6.162 6.162-2.759 6.162-6.162S15.403 5.838 12 5.838zm0 10.333c-2.306 0-4.171-1.865-4.171-4.171s1.865-4.171 4.171-4.171 4.171 1.865 4.171 4.171-1.865 4.171-4.171 4.171zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg> </a>
      </div>
    </footer>

    <script>
        // --- Supabase Configuration & Constants --- (Keep Identical)
        const SUPABASE_URL = 'https://lgcutmuspcaralydycmg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnY3V0bXVzcGNhcmFseWR5Y21nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0NDY3MDEsImV4cCI6MjA2MTAyMjcwMX0.3u5Y7pkH2NNnnoGLMWVfAa5b8fq88o1itRYnG1K38tE';
        let supabase = null;
        const LOGGED_IN_KEY = 'isUserLoggedIn'; const CURRENT_USER_KEY = 'currentUser'; const SIGNUP_FLAG_KEY = 'hasSignedUpBefore'; const INTRO_GOAL_COMPLETED_KEY = 'introGoalCompleted_v2'; const INTRO_GOAL_ANSWER_KEY = 'introGoalAnswer_v2'; const MIN_ANSWER_LENGTH = 25; const QUESTION_ID = 'intro_goal_q1'; const QUESTION_TEXT = "What is your primary goal for taking this Coaching & Leadership course?"; const SECTION_ID = 'intro-goal'; const SECTION_TITLE = 'Introduction Goal Setting'; const SECTION_TYPE = 'intro'; const PAGE_NAME = 'index.html'; const DEFAULT_SCORE = 10; const COMPLETION_STATUS = 'completed'; const IS_CORRECT_VALUE = true;

        // Initialize Supabase Client (Keep Identical)
        try { if (window.supabase && window.supabase.createClient) { supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); console.log("Supabase client initialized."); } else { throw new Error("Supabase library not found."); } } catch (error) { console.error("CRITICAL Supabase init error:", error); }

        // ***** ---> IMMEDIATE REDIRECTION LOGIC <--- ***** (Keep Identical)
        console.log("%cIndex Page: Running IMMEDIATE redirection check...", "color: purple; font-weight: bold;"); function quickCheckCurrentUser() { const data = localStorage.getItem(CURRENT_USER_KEY); return data && data.startsWith('{') && data.endsWith('}'); } const isLoggedIn_immediate = localStorage.getItem(LOGGED_IN_KEY) === 'true' && quickCheckCurrentUser(); const hasSignedUp_immediate = localStorage.getItem(SIGNUP_FLAG_KEY) === 'true'; const currentPage_immediate = window.location.pathname.split('/').pop() || 'index.html'; console.log(`Index Page IMMEDIATE Check: isLoggedIn=${isLoggedIn_immediate}, hasSignedUp=${hasSignedUp_immediate}, currentPage=${currentPage_immediate}`); if (!isLoggedIn_immediate && (currentPage_immediate === 'index.html' || currentPage_immediate === '')) { const targetUrl = hasSignedUp_immediate ? 'login.html' : 'signup.html'; console.error(`%cIndex Page IMMEDIATE Redirect: Not logged in. Redirecting to ${targetUrl}...`, "color: orange;"); window.location.replace(targetUrl); throw new Error("Redirecting user based on initial check."); } else if (isLoggedIn_immediate) { console.log("%cIndex Page IMMEDIATE Check: User IS logged in. Proceeding.", "color: green;"); } else { console.log(`%cIndex Page IMMEDIATE Check: Not logged in but not on index.html (${currentPage_immediate}). No redirect needed.`, "color: grey;"); }

        // --- DOM Element References --- (Keep Identical)
        let userNameDisplay, userEmailDisplay, mainContainer, introGoalForm, goalAnswerInput, goalErrorMessage, submitGoalButton, goalProgressContainer, goalProgressBar, goalProgressText, successMessageArea, scrollIndicator, startQuizSection, startQuizButton, introQuestionSection, lockPromptText;

        // --- Initialization --- (Keep Identical, ensure all elements are selected)
        document.addEventListener('DOMContentLoaded', function() {
            console.log("%cIndex page: DOMContentLoaded event fired.", "color: green;");
            mainContainer = document.getElementById('mainContainer');
            try {
                userNameDisplay = document.getElementById('userName'); userEmailDisplay = document.getElementById('userEmail'); introGoalForm = document.getElementById('introGoalForm'); goalAnswerInput = document.getElementById('goalAnswer'); goalErrorMessage = document.getElementById('goalErrorMessage'); submitGoalButton = document.getElementById('submitGoalButton'); goalProgressContainer = document.getElementById('goalProgressContainer'); goalProgressBar = document.getElementById('goalProgressBar'); goalProgressText = document.getElementById('goalProgressText'); successMessageArea = document.getElementById('successMessageArea'); scrollIndicator = document.getElementById('scrollIndicator'); startQuizSection = document.getElementById('startQuizSection'); startQuizButton = document.getElementById('startQuizButton'); introQuestionSection = document.getElementById('introQuestionSection'); lockPromptText = document.getElementById('lockPromptText');

                if (!mainContainer || !userNameDisplay || !userEmailDisplay || !introGoalForm || !goalAnswerInput || !goalErrorMessage || !submitGoalButton || !goalProgressContainer || !goalProgressBar || !goalProgressText || !successMessageArea || !scrollIndicator || !startQuizSection || !startQuizButton || !introQuestionSection || !lockPromptText) { throw new Error("Essential DOM elements not found!"); }
                if (!supabase && submitGoalButton) { console.warn("Supabase client not available."); setButtonLoading(true, 'Connection Unavailable'); }

                const currentUser = getCurrentUser();
                if (!currentUser || !currentUser.id) { console.error("Failsafe: User data/ID missing!"); const failsafeTarget = localStorage.getItem(SIGNUP_FLAG_KEY) === 'true' ? 'login.html' : 'signup.html'; window.location.replace(failsafeTarget); return; }

                console.log(`User verified (${currentUser.email}, ID: ${currentUser.id}). Initializing page.`);
                initializePageContent(currentUser);
                if(mainContainer) mainContainer.style.display = 'block';
                console.log("Page content initialized and displayed.");

            } catch (error) { console.error("CRITICAL ERROR during DOMContentLoaded:", error); if(mainContainer){ mainContainer.innerHTML = `<p style="color: red; font-weight: bold; text-align: center; padding: 30px;">Error loading page content. Please refresh. Error: ${error.message}</p>`; mainContainer.style.display = 'block'; } else { document.body.innerHTML = `<p style="color: red; padding: 20px;">Critical Error: (${error.message})</p>`; } }
        });

        function initializePageContent(currentUser) {
            console.log("Running initializePageContent()...");
            displayUserInfo(currentUser);
            checkIntroGoalStatus(); // This now handles button/prompt visibility
            addEventListeners();
            console.log("initializePageContent() finished.");
        }

        // --- Core User Functions --- (Keep Identical)
        function getCurrentUser() { try { const d = localStorage.getItem(CURRENT_USER_KEY); if (!d) return null; const u = JSON.parse(d); if (u && typeof u === 'object' && u.email && u.id) { if (!u.name) u.name = u.email.split('@')[0]; return u; } else { console.warn("Stored user data invalid/missing ID."); localStorage.removeItem(CURRENT_USER_KEY); localStorage.removeItem(LOGGED_IN_KEY); return null; } } catch (e) { console.error("Error parsing user data:", e); localStorage.removeItem(CURRENT_USER_KEY); localStorage.removeItem(LOGGED_IN_KEY); return null; } }
        function saveCurrentUser(userObject) { localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(userObject)); }
        function displayUserInfo(currentUser) { try { let uN = 'Guest'; let uE = ''; if (currentUser) { uN = currentUser.name || currentUser.email.split('@')[0]; uE = currentUser.email || ''; } if (userNameDisplay) userNameDisplay.textContent = `Welcome, ${uN}`; if (userEmailDisplay) userEmailDisplay.textContent = uE; } catch (err) { console.error("Error in displayUserInfo:", err); } }
        function logout() { try { localStorage.removeItem(LOGGED_IN_KEY); localStorage.removeItem(CURRENT_USER_KEY); localStorage.removeItem(INTRO_GOAL_COMPLETED_KEY); localStorage.removeItem(INTRO_GOAL_ANSWER_KEY); localStorage.removeItem(SIGNUP_FLAG_KEY); console.log("User logged out."); window.location.href = 'login.html'; } catch (e) { console.error("Logout error:", e); window.location.href = 'login.html'; } }

        // --- Check Intro Goal Status (Handles Button/Prompt Visibility) ---
        function checkIntroGoalStatus() {
            try {
                const isCompleted = localStorage.getItem(INTRO_GOAL_COMPLETED_KEY) === 'true';
                const savedAnswer = localStorage.getItem(INTRO_GOAL_ANSWER_KEY);

                if (isCompleted) {
                    console.log("Intro goal already completed.");
                    if (goalAnswerInput && savedAnswer) {
                        goalAnswerInput.value = savedAnswer;
                        goalAnswerInput.disabled = true;
                    }
                    if (introQuestionSection) {
                       introQuestionSection.style.opacity = '0.8';
                    }
                    // Hide Submit Button and Prompt if completed
                    if (submitGoalButton) submitGoalButton.classList.add('hidden'); // Use class to hide
                    if (lockPromptText) lockPromptText.classList.add('hidden'); // Use class to hide

                    if (goalProgressContainer) goalProgressContainer.style.display = 'none'; // Hide progress bar
                    unlockStartQuiz();
                } else {
                    console.log("Intro goal not yet completed.");
                    if (goalAnswerInput) goalAnswerInput.disabled = false;
                    if (introQuestionSection) {
                        introQuestionSection.style.opacity = '1';
                    }
                     // Show Submit Button and Prompt if not completed
                    if (submitGoalButton) submitGoalButton.classList.remove('hidden'); // Ensure button is visible
                    if (lockPromptText) lockPromptText.classList.remove('hidden'); // Ensure prompt is visible

                    lockStartQuiz();
                }
            } catch (err) {
                console.error("Error in checkIntroGoalStatus:", err);
                // Default to locked state and visible button/prompt in case of error
                lockStartQuiz();
                 if (submitGoalButton) submitGoalButton.classList.remove('hidden');
                 if (lockPromptText) lockPromptText.classList.remove('hidden');
            }
        }

        // --- Event Listeners --- (Keep Identical)
        function addEventListeners() { try { if (introGoalForm) introGoalForm.addEventListener('submit', handleGoalSubmit); if (goalAnswerInput) goalAnswerInput.addEventListener('input', hideError); } catch (err) { console.error("Error adding event listeners:", err); } }

        // --- Supabase Interaction Functions --- (Keep Identical)
        async function sendAssessmentData(assessmentPayload) { if (!supabase) { console.error("Supabase client not initialized."); showError("Database connection error."); return false; } console.log("Attempting insert 'assessments':", assessmentPayload); try { const { data, error } = await supabase.from('assessments').insert([assessmentPayload]).select(); if (error) { console.error('%cSupabase Insert Error (assessments):', 'color: red;', error); showError(`DB Error (assessments): ${error.message}.`); return false; } console.log('%cSupabase Insert Success (assessments):', 'color: green;', data); return true; } catch (networkError) { console.error('%cNetwork/Other Error (assessments):', 'color: red;', networkError); showError(`Network Error: ${networkError.message}.`); return false; } }
        async function updateUserProgressData(progressPayload) { if (!supabase) { console.error("Supabase client not initialized."); return false; } console.log("Attempting UPSERT 'user_progress':", progressPayload); try { const { data, error } = await supabase.from('user_progress').upsert(progressPayload, { onConflict: 'user_id, question_id' }).select(); if (error) { console.error('%cSupabase Upsert Error (user_progress):', 'color: red;', error); console.warn(`Failed to update user progress: ${error.message}`); return false; } console.log('%cSupabase Upsert Success (user_progress):', 'color: green;', data); return true; } catch (networkError) { console.error('%cNetwork/Other Error (user_progress):', 'color: red;', networkError); console.warn(`Network error updating progress: ${networkError.message}`); return false; } }


        // --- Form Submit Handler ---
        async function handleGoalSubmit(event) {
            event.preventDefault();
            console.log("handleGoalSubmit: Starting...");
            hideError();

            const currentUser = getCurrentUser();
            if (!currentUser || !currentUser.id || !currentUser.email) { showError("User data unavailable. Please log out and retry.", goalAnswerInput); return; }

            const answer = goalAnswerInput.value.trim();
            const userName = currentUser.name || currentUser.email.split('@')[0];

            // Validation
            if (answer.length < MIN_ANSWER_LENGTH) { showError(`Please provide a more detailed answer (at least ${MIN_ANSWER_LENGTH} characters).`, goalAnswerInput); return; }

            setButtonLoading(true, 'Submitting...');

            // Prepare payloads (Keep Identical)
            const submissionTime = new Date();
            const assessmentPayload = { user_id: currentUser.id, user_email: currentUser.email, name: userName, question_id: QUESTION_ID, answer: answer, goal_answer: answer, type: SECTION_TYPE, submitted_at: submissionTime, is_correct: IS_CORRECT_VALUE, score: DEFAULT_SCORE, completion_status: COMPLETION_STATUS, question_text: QUESTION_TEXT, page: PAGE_NAME, section_id: SECTION_ID };
            const progressPayload = { user_id: currentUser.id, progress_percentage: 100, section_type: SECTION_TYPE, section_id: SECTION_ID, section_title: SECTION_TITLE, question_id: QUESTION_ID, question_text: QUESTION_TEXT, page: PAGE_NAME, score: DEFAULT_SCORE, status: COMPLETION_STATUS, submitted_at: submissionTime, updated_at: submissionTime };


            try {
                const assessmentSuccess = await sendAssessmentData(assessmentPayload);

                if (assessmentSuccess) {
                    console.log("Assessment data submitted successfully.");
                    const progressSuccess = await updateUserProgressData(progressPayload); // Attempt progress update
                    if (!progressSuccess) { console.warn("User progress upsert failed, but proceeding."); }

                    // Update Local Storage
                    localStorage.setItem(INTRO_GOAL_COMPLETED_KEY, 'true');
                    localStorage.setItem(INTRO_GOAL_ANSWER_KEY, answer);

                    // --- UI Updates on Success ---
                    goalAnswerInput.disabled = true;
                    if (introQuestionSection) { introQuestionSection.style.opacity = '0.8'; }

                    // Explicitly Hide Submit Button and Prompt
                    if (submitGoalButton) submitGoalButton.classList.add('hidden'); // Use class to hide
                    if (lockPromptText) lockPromptText.classList.add('hidden'); // Use class to hide

                    // Show Progress Bar
                    if(goalProgressContainer && goalProgressBar && goalProgressText){
                        goalProgressContainer.style.display = 'block';
                        requestAnimationFrame(() => { // Ensure display:block before animating width
                            goalProgressBar.style.width = '100%';
                            goalProgressText.textContent = '100%';
                        });
                    }

                    // Show temporary success message
                    if(successMessageArea) successMessageArea.classList.add('visible');

                    // Hide success message & show next steps after delay
                    setTimeout(() => {
                       if(successMessageArea) successMessageArea.classList.remove('visible');
                       if(scrollIndicator){
                            scrollIndicator.style.display = 'block';
                            requestAnimationFrame(() => { scrollIndicator.style.opacity = '1'; });
                       }
                        unlockStartQuiz();
                       if(startQuizSection) startQuizSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 2000);

                } else {
                    // Error shown by sendAssessmentData
                    setButtonLoading(false); // Re-enable button on assessment failure
                }

            } catch (err) {
                console.error("CRITICAL Error in handleGoalSubmit flow:", err);
                showError(`An unexpected error occurred: ${err.message}. Please try again.`);
                setButtonLoading(false);
            }
        }

        // --- UI Control Functions --- (Keep Identical)
        function lockStartQuiz() { if (startQuizButton) { startQuizButton.classList.add('locked'); startQuizButton.classList.remove('unlocked'); startQuizButton.setAttribute('aria-disabled', 'true'); } }
        function unlockStartQuiz() { if (startQuizButton) { startQuizButton.classList.remove('locked'); startQuizButton.classList.add('unlocked'); startQuizButton.removeAttribute('aria-disabled'); } }
        function setButtonLoading(isLoading, text = 'Submit Your Answer') { if (!submitGoalButton) return; submitGoalButton.disabled = isLoading; submitGoalButton.textContent = isLoading ? 'Submitting...' : text; }
        function showError(message, field) { try { if (goalErrorMessage) { goalErrorMessage.textContent = message; goalErrorMessage.style.display = "block"; } if (field && !field.disabled) { field.classList.add('invalid-field-style'); field.focus(); } console.error("Displayed error to user:", message); } catch (err) { console.error("Error in showError:", err); } }
        function hideError() { try { if (goalErrorMessage) goalErrorMessage.style.display = "none"; if (goalAnswerInput) goalAnswerInput.classList.remove('invalid-field-style'); } catch (err) { console.error("Error in hideError:", err); } }

    </script>
</body>
</html>
