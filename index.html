<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... (Head content remains the same) ... -->
    <title>Coaching & Leadership Course</title>
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <style>
        /* --- CSS Rules (تبقى كما هي) --- */
        /* ... */
    </style>
</head>
<body>
    <!-- ... (Body content: Header, User Bar, Main container etc. remain) ... -->

    <script>
        // --- Unified Keys (Define them early) ---
        const LOGGED_IN_KEY = 'isUserLoggedIn';
        const CURRENT_USER_KEY = 'currentUser';
        const SIGNUP_FLAG_KEY = 'hasSignedUpBefore'; // Key for the new flag
        const UNLOCK_ANSWER_KEY = 'introGoalAnswer';
        const UNLOCK_NAME_KEY = 'introGoalSubmitterName';
        const FORMSPREE_ENDPOINT = 'https://formspree.io/f/xzzeqvea';

        // ***** ---> IMMEDIATE REDIRECTION LOGIC <--- *****
        // This runs as soon as this script block is parsed.
        console.log("%cIndex Page: Running IMMEDIATE redirection check...", "color: purple; font-weight: bold;");

        // Helper function to quickly check if currentUser data seems valid *without full parsing* if not needed
        // Or use the full function if necessary
        function quickCheckCurrentUser() {
            const data = localStorage.getItem(CURRENT_USER_KEY);
            // Basic check: does it exist and look like a JSON object start?
            return data && data.startsWith('{') && data.endsWith('}');
            // For a more robust check, you might still need the full parse like in getCurrentUser
        }

        // Check login status *first*
        const isLoggedIn = localStorage.getItem(LOGGED_IN_KEY) === 'true' && quickCheckCurrentUser();
        const hasSignedUp = localStorage.getItem(SIGNUP_FLAG_KEY) === 'true';
        const currentPage = window.location.pathname.split('/').pop() || 'index.html'; // Get current page

        console.log(`Index Page IMMEDIATE Check: isLoggedIn=${isLoggedIn}, hasSignedUp=${hasSignedUp}, currentPage=${currentPage}`); // DEBUG

        // --- REDIRECTION DECISION ---
        // Only redirect if the user is NOT logged in AND is currently on index.html
        if (!isLoggedIn && (currentPage === 'index.html' || currentPage === '')) { // Check for root path too
            if (hasSignedUp) {
                // User signed up before but isn't logged in -> Redirect to LOGIN
                console.error(`%cIndex Page IMMEDIATE Redirect: NOT logged in, HAS signed up flag. Redirecting to login.html...`, "color: orange;");
                window.location.replace('login.html'); // Use replace to avoid back button issues
            } else {
                // User has NEVER signed up (or cleared storage) -> Redirect to SIGNUP
                console.error(`%cIndex Page IMMEDIATE Redirect: NOT logged in, NO signup flag. Redirecting to signup.html...`, "color: orange;");
                window.location.replace('signup.html'); // Use replace
            }
            // IMPORTANT: Prevent further script execution after redirection starts
            // Throwing an error is one way, although the redirect often stops it anyway.
             throw new Error("Redirecting user based on initial check.");
        } else if (isLoggedIn) {
             console.log("%cIndex Page IMMEDIATE Check: User IS logged in. Proceeding with normal load.", "color: green;");
             // Let the rest of the script run (DOMContentLoaded will initialize the page)
        } else {
             console.log(`%cIndex Page IMMEDIATE Check: User is NOT logged in but NOT on index.html (${currentPage}). No redirect needed here.`, "color: grey;");
             // This case shouldn't typically happen if index.html is the entry point, but handles edge cases.
        }
        // ***** ---> END OF IMMEDIATE REDIRECTION LOGIC <--- *****


        // --- DOM Element References (Define after the immediate check or inside DOMContentLoaded) ---
        let userNameDisplay, userEmailDisplay, questionForm, nameInput, answerInput, errorMessageDisplay, lockMessage, articleLink, successModal, submitBtn;

        // --- Initialization (Runs ONLY if user wasn't redirected above) ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log("%cIndex page: DOMContentLoaded event fired.", "color: green;");

            // Re-verify login state *within* DOMContentLoaded just in case
            // This ensures the elements are available if we proceed
            const currentUser = getCurrentUser(); // Use the full check now
            if (!currentUser) {
                 // This should ideally not be reached if the immediate check worked, but acts as a failsafe
                 console.error("Index DOMContentLoaded: Failsafe check - User data missing! Redirecting to login.");
                 // Redirect based on signup flag again
                 window.location.replace(localStorage.getItem(SIGNUP_FLAG_KEY) === 'true' ? 'login.html' : 'signup.html');
                 return; // Stop initialization
            }

            console.log("%cIndex DOMContentLoaded: User verified. Initializing page elements and listeners.", "color: green;");

            // Assign DOM elements now that the DOM is ready
            userNameDisplay = document.getElementById('userName');
            userEmailDisplay = document.getElementById('userEmail');
            questionForm = document.getElementById('questionForm');
            nameInput = document.getElementById('name');
            answerInput = document.getElementById('answer');
            errorMessageDisplay = document.getElementById('error-message');
            lockMessage = document.getElementById('lockMessage');
            articleLink = document.getElementById('articleLink');
            successModal = document.getElementById('successModal');
            submitBtn = document.getElementById('submitBtn');

            // Now call the main initialization function for logged-in users
            initializePageContent(currentUser); // Pass the validated user data
        });

        // Renamed original initializePage to avoid confusion with the event listener
        function initializePageContent(currentUser) {
            console.log("Index page: initializePageContent() called for", currentUser.email); // DEBUG

            // Display User Info (uses the passed currentUser data)
            displayUserInfo(currentUser);

            // Check Unlock Status
            checkUnlockStatus();

            // Add Event Listeners
            addEventListeners();

            console.log("Index page content initialized for logged-in user."); // DEBUG
        }

        // --- Core Functions ---

        function getCurrentUser() {
            // (Use the robust version from previous answers)
            // console.log(`%cgetCurrentUser (Index): Reading key "${CURRENT_USER_KEY}"`, "color: darkcyan;"); // DEBUG
            try {
                const data = localStorage.getItem(CURRENT_USER_KEY);
                if (data) {
                    const parsedData = JSON.parse(data);
                    if (parsedData && typeof parsedData === 'object' && typeof parsedData.email === 'string' && parsedData.email.includes('@') && typeof parsedData.name === 'string' && parsedData.name.trim() !== '') {
                        return parsedData;
                    } else {
                        console.warn(`%cgetCurrentUser (Index): Data INVALID/incomplete. Removing keys.`, "color: orange;");
                        localStorage.removeItem(CURRENT_USER_KEY);
                        localStorage.removeItem(LOGGED_IN_KEY);
                        return null;
                    }
                }
                return null;
            } catch (e) {
                console.error(`%cgetCurrentUser (Index): Error parsing data:`, "color: red;", e);
                localStorage.removeItem(CURRENT_USER_KEY);
                localStorage.removeItem(LOGGED_IN_KEY);
                return null;
            }
        }

        // Modified to accept currentUser as argument
        function displayUserInfo(currentUser) {
            let userName = 'User';
            let userEmail = '';

            if (currentUser) {
                userName = currentUser.name || userName;
                userEmail = currentUser.email || userEmail;
                // Pre-fill name input if element exists
                if (nameInput) { // Check if nameInput is assigned yet
                    nameInput.value = userName;
                } else {
                     console.warn("displayUserInfo: nameInput element not ready for pre-fill."); // DEBUG
                }
            } else {
                 console.warn("displayUserInfo (Index): Called without valid currentUser data.");
            }

            // Update display elements if they exist
            if (userNameDisplay) userNameDisplay.textContent = `Welcome, ${userName}`;
            if (userEmailDisplay) userEmailDisplay.textContent = userEmail;
            // console.log(`displayUserInfo (Index): Display updated - Name: ${userName}, Email: ${userEmail}`); // DEBUG
        }

        // --- Other functions remain largely the same, ensure they use the correct keys ---
        // checkUnlockStatus, lockContent, unlockContent, storeAnswersLocally,
        // addEventListeners, handleFormSubmit, sendToFormspree, showError, hideError, etc.
        // Ensure logout uses LOGGED_IN_KEY and CURRENT_USER_KEY

        function logout() {
            console.log("%cLogging out from Index page...", "color: red;");
            try {
                localStorage.removeItem(LOGGED_IN_KEY);     // Use unified key
                localStorage.removeItem(CURRENT_USER_KEY); // Use unified key
                localStorage.removeItem(UNLOCK_ANSWER_KEY);
                localStorage.removeItem(UNLOCK_NAME_KEY);
                // Remove signup flag? Maybe not, user might want to log back in.
                // localStorage.removeItem(SIGNUP_FLAG_KEY);
                console.log("%cCleared login and unlock keys.", "color: red;");
                window.location.href = 'login.html'; // Redirect to login after logout
            } catch (error) {
                 console.error("Error during logout:", error);
                 window.location.href = 'login.html';
            }
        }

        // ...(Include all other necessary functions from your corrected index.html:
        // checkUnlockStatus, lockContent, unlockContent, storeAnswersLocally,
        // addEventListeners, handleFormSubmit, sendToFormspree, handleKeyDown,
        // handleLockedLinkClick, showError, hideError, showSuccessModal, closeModal,
        // redirectToArticle
        // Make sure they are defined correctly here)

        // Example stubs for missing functions (replace with your actual code)
        function checkUnlockStatus() { const storedAnswer = localStorage.getItem(UNLOCK_ANSWER_KEY); if (storedAnswer) { unlockContent(); /* ... prefill logic ... */ } else { lockContent(); } console.log("checkUnlockStatus run."); }
        function lockContent() { if(lockMessage) lockMessage.classList.remove('unlocked'); if(articleLink) articleLink.classList.add('locked'); console.log("lockContent run."); }
        function unlockContent() { if(lockMessage) lockMessage.classList.add('unlocked'); if(articleLink) articleLink.classList.remove('locked'); console.log("unlockContent run."); }
        function storeAnswersLocally(name, answer) { try { localStorage.setItem(UNLOCK_NAME_KEY, name); localStorage.setItem(UNLOCK_ANSWER_KEY, answer); } catch (e) { console.error(e); } console.log("storeAnswersLocally run."); }
        function addEventListeners() { if (questionForm) { questionForm.addEventListener('submit', handleFormSubmit); } document.addEventListener('keydown', handleKeyDown); if (articleLink) { articleLink.addEventListener('click', handleLockedLinkClick); } console.log("addEventListeners run."); }
        function handleFormSubmit(event) { event.preventDefault(); /* ... rest of your submit logic ... */ console.log("handleFormSubmit run."); /* Remember to call storeAnswersLocally, sendToFormspree, unlockContent, showSuccessModal */ }
        function sendToFormspree(formData) { return fetch(formspreeEndpoint, { method: 'POST', body: formData, headers: { 'Accept': 'application/json' } }).then(r => r.ok).catch(e => {console.error(e); return false;}); console.log("sendToFormspree run."); }
        function handleKeyDown(e) { if (e.key === 'Escape' && successModal && successModal.style.display === 'flex') { closeModal(); } }
        function handleLockedLinkClick(e) { if (articleLink && articleLink.classList.contains('locked')) { e.preventDefault(); /* ... feedback logic ... */ } }
        function showError(message, field) { if(errorMessageDisplay) { errorMessageDisplay.textContent = message; errorMessageDisplay.style.display = "block"; } if (field) { field.classList.add('invalid-field-style'); field.focus(); } console.log("showError run."); }
        function hideError() { if(errorMessageDisplay) errorMessageDisplay.style.display = "none"; if(nameInput) nameInput.classList.remove('invalid-field-style'); if(answerInput) answerInput.classList.remove('invalid-field-style'); }
        function showSuccessModal() { if(successModal) successModal.style.display = 'flex'; console.log("showSuccessModal run."); }
        function closeModal() { if(successModal) successModal.style.display = 'none'; console.log("closeModal run."); }
        function redirectToArticle() { if (articleLink && !articleLink.classList.contains('locked')) { window.location.href = articleLink.href; } else { closeModal(); } console.log("redirectToArticle run."); }


    </script>
</body>
</html>
