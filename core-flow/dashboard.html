<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Elevo Core</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M3 12h18M3 6h12M3 18h15'/><path d='M17 9l4 3l-4 3'/></svg>">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Additional page-specific styles for Dashboard */
        .dashboard-main { 
            max-width: 1600px; 
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .dashboard-header {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        .user-name-emphasis { font-weight: 600; color: var(--primary-color); }

        .stat-card .stat-period {
            font-size: 0.8rem;
            color: var(--text-color-subtle);
            margin-top: 0.25rem;
        }
        .quality-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-right: 0.5rem;
            vertical-align: middle;
        }
        .quality-icon svg { width: 100%; height: 100%; }
        .quality-icon.good svg { stroke: var(--success-color); }
        .quality-icon.normal svg { stroke: var(--warning-color); }
        .quality-icon.bad svg { stroke: var(--danger-color); }
        .quality-icon.na svg { stroke: var(--text-color-subtle); }
        
        .live-call-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        /* Chart Styles */
        .analytics-section.card h2, .filter-controls.card h3, .recent-activity-section.card h2 {
            margin-top: 0;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }
        .chart-container {
            padding: 1.5rem;
            border-radius: var(--border-radius);
            background-color: var(--bg-color);
        }
        .chart-container h3 {
            text-align: center;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div id="accessDeniedModal" style="display:none;" class="modal active">
         <div class="access-denied-content modal-content">
             <h3>Access Denied</h3>
             <p>You do not have permission to view this page. This section is restricted to administrators.</p>
             <button id="returnToAppBtn" class="primary-button">Return to Agent App</button>
         </div>
    </div>

    <div class="app-container" id="appContainerContent" style="display: none;">
        <header class="app-header">
            <div class="logo">
                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon></svg>
                <h2>Elevo Core Dashboard</h2>
            </div>
            <div class="header-controls">
                 <a href="core-flow.html">Core Flow</a>
                 <a href="agent-dashboard.html">Agent Portal</a>
                 <div class="user-info" id="userInfo" style="display: none;">
                    <span id="userNameDisplay" class="user-name-display"></span>
                    <button id="logoutButton" class="primary-button" style="background-color: var(--danger-color);">Logout</button>
                 </div>
            </div>
        </header>

        <main class="app-main dashboard-main">
            <div id="authLoadingMessage" class="loading-container">
                <div class="spinner"></div>
                <p>Verifying access and loading dashboard...</p>
            </div>

            <div id="dashboardContent" style="display:none;">
                <div class="dashboard-header">
                    <div class="greeting-section">
                        <div id="userAvatarCharacter" class="user-avatar-char-dashboard"></div>
                        <div>
                            <h1 id="dashboardUserGreeting">Welcome, Admin!</h1>
                            <p id="dashboardUserSubtext">Here's a complete overview of all agent activities and performance metrics.</p>
                        </div>
                    </div>
                </div>

                <div class="stats-grid" id="statsGrid">
                     <div class="stat-card card">
                        <h3>Total Calls (Filtered)</h3>
                        <p id="totalCalls">0</p>
                        <span class="stat-period" id="statsPeriod">All Agents</span>
                    </div>
                     <div class="stat-card card">
                        <h3>Avg. Call Duration</h3>
                        <p id="avgCallDuration">0m 0s</p>
                        <span class="stat-period" id="statsPeriodDuration">All Agents</span>
                    </div>
                     <div class="stat-card card">
                        <h3>Completion Rate</h3>
                        <p id="completionRate">0%</p>
                        <span class="stat-period" id="statsPeriodCompletion">All Agents</span>
                    </div>
                     <div class="stat-card card">
                        <h3>Avg. Call Quality</h3>
                        <div class="quality-gauge">
                            <div class="gauge-bar-container">
                                <div id="gaugeGood" class="gauge-segment good"></div>
                                <div id="gaugeNormal" class="gauge-segment normal"></div>
                                <div id="gaugeBad" class="gauge-segment bad"></div>
                            </div>
                            <span id="avgQualityText">N/A</span>
                        </div>
                    </div>
                </div>

                <div id="liveCallsContainerWrapper" class="card">
                    <h2>Live Call Monitoring</h2>
                    <div id="liveCallsContainer">
                        <p id="noLiveCallsMessage" style="text-align:center; padding: 1rem; color: var(--text-color-secondary);">Loading live calls...</p>
                    </div>
                </div>

                <div class="analytics-section card" id="analyticsSection">
                    <h2>Performance & Quality Analytics</h2>
                    <div class="charts-grid">
                        <div class="chart-container">
                            <h3>Quality Evolution Over Time</h3>
                            <canvas id="qualityEvolutionChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>Bad Call Reasons Breakdown</h3>
                            <canvas id="badQualityReasonsChart"></canvas>
                            <p id="noBadReasonsMessage" style="display:none; text-align:center; padding: 2rem;">No "Bad" quality calls with reasons in the selected period.</p>
                        </div>
                    </div>
                </div>

                <div class="filter-controls card" id="filterControlsCard">
                    <h3>Filter & Reporting Tools</h3>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end;">
                        <div><label for="userFilterDropdown">Agent:</label><select id="userFilterDropdown" class="input-wrapper"><option value="">All Agents</option></select></div>
                        <div><label for="searchInput">Search (Scenario, Reason):</label><input type="text" id="searchInput" placeholder="Type to search..." class="input-wrapper"></div>
                        <div><label for="qualityFilter">Call Quality:</label><select id="qualityFilter" class="input-wrapper"><option value="">All</option><option value="Good">Good</option><option value="Normal">Normal</option><option value="Bad">Bad</option><option value="N/A">N/A</option></select></div>
                        <div><label for="startDateFilter">Start Date:</label><input type="date" id="startDateFilter" class="input-wrapper"></div>
                        <div><label for="endDateFilter">End Date:</label><input type="date" id="endDateFilter" class="input-wrapper"></div>
                        <div style="align-self: end;"><button id="resetFiltersBtn" class="primary-button" style="background-color: var(--text-color-secondary); width: 100%;">Reset</button></div>
                    </div>
                </div>

                <div class="recent-activity-section card" id="recentActivitySection">
                    <h2 id="recentCallsTitle">Recent Call Sessions</h2>
                    <div class="table-responsive">
                        <table id="recentCallsTable">
                            <thead>
                                <tr>
                                    <th>Agent Name</th><th>Agent Email</th><th>Scenario</th><th>Start Time</th><th>Duration</th><th>Completed</th><th>Quality</th><th>Reason</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                    <div id="paginationControls" class="pagination-container"></div>
                    <div class="export-buttons" style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                        <button id="exportDataBtn" class="primary-button">Export as CSV</button>
                        <button id="exportDataXLSXBtn" class="primary-button">Export as XLSX (Excel)</button>
                    </div>
                </div>
            </div>
        </main>

        <footer class="app-footer">
            <p>Â© <span id="currentYear"></span> Mohamed Elmenisy - Elevo Core. All rights reserved.</p>
        </footer>
    </div>

    <script type="module">
        // This is the COMPLETE JavaScript for dashboard.html
        const SUPABASE_URL = 'https://aefiigottnlcmjzilqnh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlZmlpZ290dG5sY21qemlscW5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNzY2MDQsImV4cCI6MjA2Mjc1MjYwNH0.FypB02v3tGMnxXV9ZmZMdMC0oQpREKOJWgHMPxUzwX4';
        
        let supabase;
        try {
            supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (error) {
            console.error("Supabase client initialization failed:", error);
            document.getElementById('authLoadingMessage').innerHTML = '<p style="color:red;">Critical Error: Services unavailable.</p>';
        }

        // All DOM Elements
        const appContainerContent = document.getElementById('appContainerContent');
        const authLoadingMessageDiv = document.getElementById('authLoadingMessage');
        const dashboardContentDiv = document.getElementById('dashboardContent');
        const accessDeniedModal = document.getElementById('accessDeniedModal');
        const returnToAppBtn = document.getElementById('returnToAppBtn');
        const userNameDisplayHeader = document.getElementById('userNameDisplay');
        const dashboardUserGreeting = document.getElementById('dashboardUserGreeting');
        const userAvatarCharEl = document.getElementById('userAvatarCharacter');
        const userInfoDivHeader = document.getElementById('userInfo');
        const logoutButton = document.getElementById('logoutButton');
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        const totalCallsEl = document.getElementById('totalCalls');
        const avgCallDurationEl = document.getElementById('avgCallDuration');
        const completionRateEl = document.getElementById('completionRate');
        const gaugeGoodEl = document.getElementById('gaugeGood');
        const gaugeNormalEl = document.getElementById('gaugeNormal');
        const gaugeBadEl = document.getElementById('gaugeBad');
        const avgQualityTextEl = document.getElementById('avgQualityText');
        const statsPeriodEl = document.getElementById('statsPeriod');
        const statsPeriodDurationEl = document.getElementById('statsPeriodDuration');
        const statsPeriodCompletionEl = document.getElementById('statsPeriodCompletion');
        
        const userFilterDropdown = document.getElementById('userFilterDropdown');
        const searchInput = document.getElementById('searchInput');
        const qualityFilter = document.getElementById('qualityFilter');
        const startDateFilter = document.getElementById('startDateFilter');
        const endDateFilter = document.getElementById('endDateFilter');
        const resetFiltersBtn = document.getElementById('resetFiltersBtn');
        const recentCallsTableBody = document.querySelector('#recentCallsTable tbody');
        const recentCallsTitleEl = document.getElementById('recentCallsTitle');
        const paginationControlsContainer = document.getElementById('paginationControls');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const exportDataXLSXBtn = document.getElementById('exportDataXLSXBtn');
        
        const liveCallsContainer = document.getElementById('liveCallsContainer');
        const noLiveCallsMessage = document.getElementById('noLiveCallsMessage');
        const qualityEvolutionChartCanvas = document.getElementById('qualityEvolutionChart');
        const badQualityReasonsChartCanvas = document.getElementById('badQualityReasonsChart');
        const noBadReasonsMessageEl = document.getElementById('noBadReasonsMessage');
        
        let currentUser = null;
        let allCallSessions = [];
        let filteredCallSessions = [];
        let allAgents = [];
        let currentPage = 1;
        const ROWS_PER_PAGE = 10;
        let filterTimeoutId = null;
        let liveCallsChannel = null;
        let qualityEvolutionChartInstance = null;
        let badQualityReasonsChartInstance = null;

        async function initializeDashboard() {
            if (!supabase) return;
            setChartJsDefaults();
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.replace('login.html');
                return;
            }

            const { data: profile } = await supabase.from('users').select('name, is_admin').eq('id', session.user.id).single();
            currentUser = { id: session.user.id, email: session.user.email, name: profile?.name || session.user.email, isAdmin: profile?.is_admin || false };

            if (!currentUser.isAdmin) {
                showAccessDenied();
                return;
            }

            appContainerContent.style.display = 'flex';
            authLoadingMessageDiv.style.display = 'none';
            dashboardContentDiv.style.display = 'block';

            setupAdminUI();
            await loadInitialData();
            applyFiltersAndRender();
            setupEventListeners();
            setupLiveCallMonitoring();
        }

        function showAccessDenied() {
            authLoadingMessageDiv.style.display = 'none';
            dashboardContentDiv.style.display = 'none';
            accessDeniedModal.style.display = 'flex';
        }

        returnToAppBtn.addEventListener('click', () => { window.location.href = 'core-flow.html'; });
        
        function setupAdminUI() {
            userNameDisplayHeader.textContent = currentUser.name;
            dashboardUserGreeting.innerHTML = `ðŸ‘‹ Welcome back, <span class="user-name-emphasis">${currentUser.name}</span>!`;
            userAvatarCharEl.textContent = currentUser.name.charAt(0).toUpperCase();
            userInfoDivHeader.style.display = 'flex';
        }

        async function loadInitialData() {
            try {
                const { data: agentsData, error: agentsError } = await supabase.from('users').select('id, name, email').order('name');
                if (agentsError) throw agentsError;
                allAgents = agentsData || [];
                populateAgentFilter();

                const { data: sessionsData, error: sessionsError } = await supabase.from('call_sessions').select(`*, call_sessions_scenario_id_fkey(id, title)`).order('start_time', { ascending: false });
                if (sessionsError) throw sessionsError;
                allCallSessions = sessionsData || [];

            } catch (error) {
                console.error("Error loading initial dashboard data:", error);
                recentCallsTableBody.innerHTML = `<tr><td colspan="8" style="text-align:center; color:var(--danger-color);">Failed to load data: ${error.message}</td></tr>`;
            }
        }

        function populateAgentFilter() {
            userFilterDropdown.innerHTML = '<option value="">All Agents</option>';
            allAgents.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.id;
                option.textContent = agent.name ? `${agent.name} (${agent.email})` : agent.email;
                userFilterDropdown.appendChild(option);
            });
        }

        function applyFiltersAndRender() {
            let tempFiltered = [...allCallSessions];
            const searchTerm = searchInput.value.toLowerCase().trim();
            const selectedAgentId = userFilterDropdown.value;
            const selectedQuality = qualityFilter.value;
            const startDate = startDateFilter.value;
            const endDate = endDateFilter.value;

            if (selectedAgentId) tempFiltered = tempFiltered.filter(s => s.user_id === selectedAgentId);
            if (searchTerm) tempFiltered = tempFiltered.filter(s => 
                (s.call_sessions_scenario_id_fkey?.title || '').toLowerCase().includes(searchTerm) ||
                (s.quality_reason || '').toLowerCase().includes(searchTerm)
            );
            if (selectedQuality) tempFiltered = tempFiltered.filter(s => s.call_quality === selectedQuality || (selectedQuality === "N/A" && !s.call_quality));
            if (startDate) tempFiltered = tempFiltered.filter(s => s.start_time && new Date(s.start_time) >= new Date(startDate));
            if (endDate) tempFiltered = tempFiltered.filter(s => s.start_time && new Date(s.start_time) <= new Date(new Date(endDate).getTime() + 86400000));
            
            filteredCallSessions = tempFiltered;
            currentPage = 1;
            renderTable();
            updateStats();
            renderPagination();
            renderCharts();
        }

        function renderTable() {
            recentCallsTableBody.innerHTML = '';
            const paginatedSessions = filteredCallSessions.slice((currentPage - 1) * ROWS_PER_PAGE, currentPage * ROWS_PER_PAGE);
            if(paginatedSessions.length === 0) {
                recentCallsTableBody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding: 1.5rem;">No call sessions match the current filters.</td></tr>`;
                return;
            }
            paginatedSessions.forEach(session => {
                const agent = allAgents.find(a => a.id === session.user_id);
                const row = recentCallsTableBody.insertRow();
                row.insertCell().textContent = agent?.name || 'Unknown Agent';
                row.insertCell().textContent = agent?.email || 'N/A';
                row.insertCell().textContent = session.call_sessions_scenario_id_fkey?.title || 'N/A';
                row.insertCell().textContent = new Date(session.start_time).toLocaleString();
                const duration = session.duration || 0;
                row.insertCell().textContent = `${Math.floor(duration / 60)}m ${duration % 60}s`;
                row.insertCell().textContent = session.completed ? 'Yes' : 'No';
                
                const qualityCell = row.insertCell();
                const qualityIcon = `<span class="quality-icon ${session.call_quality?.toLowerCase() || 'na'}">${getQualityIcon(session.call_quality)}</span>`;
                qualityCell.innerHTML = `${qualityIcon} ${session.call_quality || 'N/A'}`;

                row.insertCell().textContent = session.quality_reason || '-';
            });
        }
        
        function getQualityIcon(quality) {
            switch(quality?.toLowerCase()) {
                case 'good': return `<svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`;
                case 'normal': return `<svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>`;
                case 'bad': return `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`;
                default: return `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="8" y1="12" x2="16" y2="12"></line></svg>`;
            }
        }

        function updateStats() {
            const count = filteredCallSessions.length;
            totalCallsEl.textContent = count;
            const agentName = userFilterDropdown.options[userFilterDropdown.selectedIndex].text;
            const statsPeriodText = userFilterDropdown.value ? agentName.split(' (')[0] : 'All Agents';
            [statsPeriodEl, statsPeriodDurationEl, statsPeriodCompletionEl].forEach(el => el.textContent = statsPeriodText);
            recentCallsTitleEl.textContent = userFilterDropdown.value ? `Call Sessions for ${statsPeriodText}` : 'All Recent Call Sessions';

            if (count > 0) {
                const totalDuration = filteredCallSessions.reduce((sum, s) => sum + (s.duration || 0), 0);
                const avgDuration = Math.round(totalDuration / count);
                avgCallDurationEl.textContent = `${Math.floor(avgDuration / 60)}m ${avgDuration % 60}s`;
                const completedCount = filteredCallSessions.filter(s => s.completed).length;
                completionRateEl.textContent = `${Math.round((completedCount / count) * 100)}%`;

                const qualityCounts = { good: 0, normal: 0, bad: 0, rated: 0 };
                filteredCallSessions.forEach(s => {
                    if (s.call_quality === 'Good') { qualityCounts.good++; qualityCounts.rated++; }
                    else if (s.call_quality === 'Normal') { qualityCounts.normal++; qualityCounts.rated++; }
                    else if (s.call_quality === 'Bad') { qualityCounts.bad++; qualityCounts.rated++; }
                });
                if (qualityCounts.rated > 0) {
                    gaugeGoodEl.style.width = `${(qualityCounts.good / qualityCounts.rated) * 100}%`;
                    gaugeNormalEl.style.width = `${(qualityCounts.normal / qualityCounts.rated) * 100}%`;
                    gaugeBadEl.style.width = `${(qualityCounts.bad / qualityCounts.rated) * 100}%`;
                    if (qualityCounts.bad / qualityCounts.rated > 0.3) avgQualityTextEl.textContent = "Improvement Needed";
                    else if (qualityCounts.good / qualityCounts.rated >= 0.7) avgQualityTextEl.textContent = "Excellent";
                    else avgQualityTextEl.textContent = "Mixed Quality";
                } else {
                    [gaugeGoodEl, gaugeNormalEl, gaugeBadEl].forEach(el => el.style.width = '0%');
                    avgQualityTextEl.textContent = 'No Rated Calls';
                }
            } else {
                avgCallDurationEl.textContent = '0m 0s';
                completionRateEl.textContent = '0%';
                [gaugeGoodEl, gaugeNormalEl, gaugeBadEl].forEach(el => el.style.width = '0%');
                avgQualityTextEl.textContent = 'No Calls';
            }
        }
        function renderPagination() {
            paginationControlsContainer.innerHTML = '';
            const totalPages = Math.ceil(filteredCallSessions.length / ROWS_PER_PAGE);
            if (totalPages <= 1) return;

            const prevBtn = document.createElement('button');
            prevBtn.innerHTML = '&laquo; Previous';
            prevBtn.disabled = currentPage === 1;
            prevBtn.addEventListener('click', () => { currentPage--; renderTable(); renderPagination(); });
            paginationControlsContainer.appendChild(prevBtn);

            const pageInfo = document.createElement('span');
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            pageInfo.style.margin = "0 10px";
            paginationControlsContainer.appendChild(pageInfo);

            const nextBtn = document.createElement('button');
            nextBtn.innerHTML = 'Next &raquo;';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.addEventListener('click', () => { currentPage++; renderTable(); renderPagination(); });
            paginationControlsContainer.appendChild(nextBtn);
        }

        function renderCharts() {
            renderQualityEvolutionChart();
            renderBadQualityReasonsChart();
        }

        function renderQualityEvolutionChart() {
            if (qualityEvolutionChartInstance) qualityEvolutionChartInstance.destroy();
            const dataByDate = {};
            filteredCallSessions.forEach(session => {
                const date = new Date(session.start_time).toLocaleDateString('en-CA');
                if (!dataByDate[date]) dataByDate[date] = { Good: 0, Normal: 0, Bad: 0 };
                if (session.call_quality === 'Good') dataByDate[date].Good++;
                if (session.call_quality === 'Normal') dataByDate[date].Normal++;
                if (session.call_quality === 'Bad') dataByDate[date].Bad++;
            });
            const labels = Object.keys(dataByDate).sort((a,b) => new Date(a) - new Date(b));
            const goodData = labels.map(l => dataByDate[l].Good);
            const normalData = labels.map(l => dataByDate[l].Normal);
            const badData = labels.map(l => dataByDate[l].Bad);
            
            qualityEvolutionChartInstance = new Chart(qualityEvolutionChartCanvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: 'Good', data: goodData, borderColor: 'var(--success-color)', tension: 0.1 },
                        { label: 'Normal', data: normalData, borderColor: 'var(--warning-color)', tension: 0.1 },
                        { label: 'Bad', data: badData, borderColor: 'var(--danger-color)', tension: 0.1 }
                    ]
                },
            });
        }

        function renderBadQualityReasonsChart() {
            if (badQualityReasonsChartInstance) badQualityReasonsChartInstance.destroy();
            const reasonCounts = {};
            filteredCallSessions.filter(s => s.call_quality === 'Bad' && s.quality_reason).forEach(s => {
                reasonCounts[s.quality_reason] = (reasonCounts[s.quality_reason] || 0) + 1;
            });
            
            if(Object.keys(reasonCounts).length === 0) {
                badQualityReasonsChartCanvas.style.display = 'none';
                noBadReasonsMessageEl.style.display = 'block';
                return;
            }
            badQualityReasonsChartCanvas.style.display = 'block';
            noBadReasonsMessageEl.style.display = 'none';

            badQualityReasonsChartInstance = new Chart(badQualityReasonsChartCanvas.getContext('2d'), {
                type: 'pie',
                data: {
                    labels: Object.keys(reasonCounts),
                    datasets: [{ 
                        data: Object.values(reasonCounts),
                        backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6', '#22c55e', '#8b5cf6', '#14b8a6']
                    }]
                },
                options: { plugins: { legend: { position: 'right' } } }
            });
        }
        
        async function setupLiveCallMonitoring() {
            await fetchAndRenderLiveCalls();
            liveCallsChannel = supabase
                .channel('public:call_sessions:live')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'call_sessions' }, async (payload) => {
                    await fetchAndRenderLiveCalls();
                    await loadInitialData(); // Reload all data for stats
                    applyFiltersAndRender();
                })
                .subscribe();
        }

        async function fetchAndRenderLiveCalls() {
            const { data, error } = await supabase.from('call_sessions').select('*, call_sessions_scenario_id_fkey(title)').is('end_time', null).order('start_time');
            if (error) { console.error(error); return; }
            liveCallsContainer.innerHTML = '';
            if (data.length > 0) {
                noLiveCallsMessage.style.display = 'none';
                data.forEach(call => {
                    const callDiv = document.createElement('div');
                    callDiv.className = 'live-call-item';
                    const agent = allAgents.find(a => a.id === call.user_id);
                    callDiv.innerHTML = `
                        <div><strong>${agent?.name || 'Unknown'}</strong> on "${call.call_sessions_scenario_id_fkey?.title || '...'}"</div>
                        <div>Started: ${new Date(call.start_time).toLocaleTimeString()}</div>
                    `;
                    liveCallsContainer.appendChild(callDiv);
                });
            } else {
                noLiveCallsMessage.style.display = 'block';
                noLiveCallsMessage.textContent = 'No active calls at the moment.';
            }
        }

        function setupEventListeners() {
            logoutButton.addEventListener('click', async () => {
                if (liveCallsChannel) supabase.removeChannel(liveCallsChannel);
                await supabase.auth.signOut();
                window.location.replace("login.html");
            });
            [userFilterDropdown, qualityFilter, startDateFilter, endDateFilter].forEach(el => el.addEventListener('change', applyFiltersAndRender));
            searchInput.addEventListener('input', () => {
                clearTimeout(filterTimeoutId);
                filterTimeoutId = setTimeout(applyFiltersAndRender, 500);
            });
            resetFiltersBtn.addEventListener('click', () => {
                userFilterDropdown.value = '';
                searchInput.value = '';
                qualityFilter.value = '';
                startDateFilter.value = '';
                endDateFilter.value = '';
                applyFiltersAndRender();
            });
            exportDataBtn.addEventListener('click', () => exportData(filteredCallSessions, 'csv'));
            exportDataXLSXBtn.addEventListener('click', () => exportData(filteredCallSessions, 'xlsx'));
        }
        
        function exportData(data, format) {
            const dataForExport = data.map(session => {
                const agent = allAgents.find(a => a.id === session.user_id);
                return {
                    "Agent Name": agent?.name || 'Unknown',
                    "Agent Email": agent?.email || 'N/A',
                    "Scenario": session.call_sessions_scenario_id_fkey?.title || 'N/A',
                    "Start Time": new Date(session.start_time).toLocaleString(),
                    "Duration (s)": session.duration || 0,
                    "Completed": session.completed ? 'Yes' : 'No',
                    "Quality": session.call_quality || 'N/A',
                    "Reason": session.quality_reason || '-'
                };
            });
            const worksheet = XLSX.utils.json_to_sheet(dataForExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "CallSessions");
            XLSX.writeFile(workbook, `elevo_dashboard_export_${new Date().toISOString().slice(0,10)}.${format}`);
        }
        
        function setChartJsDefaults() {
            const isDark = document.documentElement.classList.contains('dark');
            Chart.defaults.color = isDark ? '#f3f4f6' : '#374151';
            Chart.defaults.borderColor = isDark ? '#4b5563' : '#e5e7eb';
            Chart.defaults.font.family = "'Poppins', sans-serif";
        }

        if (supabase) {
            initializeDashboard();
        }
    </script>
</body>
</html>
