<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elevo Core Assistant</title>
        <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2317a2b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M3 12h18M3 6h12M3 18h15'/><path d='M17 9l4 3l-4 3'/></svg>">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <audio id="callStartSound" src="sounds/call_start.mp3" preload="auto"></audio>

    <div class="app-container">
        <header class="app-header">
            <div class="logo-container">
                <svg class="company-logo" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 17L10 17M6 12L12 12M6 7L14 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M15 6L19 10L15 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <rect x="3" y="3" width="18" height="18" rx="3" stroke="currentColor" stroke-width="1.5" fill="transparent" opacity="0.6"/>
                </svg>
                <span class="app-title">Elevo Core</span>
            </div>
            <div class="header-controls">
                 <a href="dashboard.html" class="nav-link" id="dashboardLink">Dashboard</a>
                <div class="user-info" id="userInfo" style="display: none;">
                    <span id="userName" class="user-name-display"></span>
                    <button id="logoutButton" class="logout-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
        </header>

        <div class="status-bar">
            <div id="systemStatus" class="status-indicator status-waiting">üî¥ Waiting for Call</div>
        </div>

        <div id="progressTracker" class="progress-tracker-container" style="display: none;">
             <div class="stepper-wrapper">
                 {/* Stepper will be dynamically generated here by JavaScript */}
            </div>
        </div>

         <div id="timer-container">
             <div id="callTimer" style="display: none;">00:00</div>
         </div>

        <main class="app-main">
            <div id="auth-loading" class="loading-container" style="display: flex;">
                <div class="spinner"></div>
                <p>Initializing Assistant...</p>
            </div>

            <div id="initial-view" class="card initial-card fade-in" style="display: none;">
                <div class="card-icon">
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="48" height="48"><path d="M12 2C6.486 2 2 6.486 2 12C2 17.514 6.486 22 12 22C17.514 22 22 17.514 22 12C22 6.486 17.514 2 12 2ZM12 20C7.589 20 4 16.411 4 12C4 7.589 7.589 4 12 4C16.411 4 20 7.589 20 12C20 16.411 16.411 20 12 20Z"/><path d="M12 11C10.897 11 10 10.103 10 9C10 7.897 10.897 7 12 7C13.103 7 14 7.897 14 9C14 10.103 13.103 11 12 11ZM12 9C11.514 9 11.121 9.229 11.038 9.583L12.962 10.417C12.879 10.771 12.486 11 12 11C11.448 11 11 10.552 11 10C11 9.448 11.448 9 12 9Z"/><path d="M16.002 16.246C15.483 15.219 14.544 14.5 13.333 14.5H10.667C9.456 14.5 8.517 15.219 7.998 16.246C7.933 16.386 7.996 16.553 8.114 16.641C8.657 17.053 9.737 17.5 12 17.5C14.263 17.5 15.343 17.053 15.886 16.641C16.004 16.553 16.067 16.386 16.002 16.246Z"/></svg>
                </div>
                <h2 class="card-title">Core Flow Assistant</h2>
                <p class="card-subtitle">Select a scenario and receive the call.</p>

                <div class="scenario-selector-container">
                    <label for="scenarioDropdown">Select Scenario:</label>
                    <select id="scenarioDropdown" class="scenario-dropdown">
                        <option value="">Loading scenarios...</option>
                    </select>
                </div>

                <div id="assistantBox" class="assistant-box" style="display: none;">
                    <span class="assistant-icon">üí°</span>
                    <p id="assistantMessageElement">Welcome to Elevo Core!</p>
                </div>

                <button id="receive-call-btn" class="action-button primary-button" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M6.05828 11.0452L4.00001 9.00002C4.00001 9.00002 3.58101 8.99902 3.51201 9.00002C2.04801 9.02602 1.00001 10.318 1.00001 11.785V12.214C1.00001 13.682 2.04801 14.973 3.51201 15H4.00001L6.05828 12.9548C6.12828 12.8848 6.16728 12.7948 6.16728 12C6.16728 11.2052 6.12828 11.1152 6.05828 11.0452ZM20.488 15H21C22.464 14.974 23.512 13.682 23.512 12.215V11.785C23.512 10.318 22.464 9.02602 21 9.00002C20.998 8.99902 20 9.00002 20 9.00002L17.9417 11.0452C17.8717 11.1152 17.8327 11.2052 17.8327 12C17.8327 12.7948 17.8717 12.8848 17.9417 12.9548L20.488 15Z"/><path d="M19.6623 5.08431C19.8803 5.08431 20.0943 5.17031 20.2503 5.32631L21.6743 6.74931C21.9863 7.06231 21.9863 7.56731 21.6743 7.87931C19.4003 10.1523 19.4003 13.8473 21.6743 16.1203C21.9863 16.4323 21.9863 16.9373 21.6743 17.2503L20.2503 18.6733C20.0943 18.8293 19.8803 18.9153 19.6623 18.9153C19.4443 18.9153 19.2303 18.8293 19.0743 18.6733C16.2573 15.8563 16.2573 8.14331 19.0743 5.32631C19.2303 5.17031 19.4443 5.08431 19.6623 5.08431ZM4.92575 5.32631C5.52575 4.72631 6.45075 4.72631 7.05075 5.32631C9.86775 8.14331 9.86775 15.8563 7.05075 18.6733C6.89475 18.8293 6.68075 18.9153 6.46275 18.9153C6.24475 18.9153 6.03075 18.8293 5.87475 18.6733L4.45075 17.2503C4.13875 16.9373 4.13875 16.4323 4.45075 16.1203C6.72375 13.8473 6.72375 10.1523 4.45075 7.87931C4.13875 7.56731 4.13875 7.06231 4.45075 6.74931L5.87475 5.32631C5.71875 5.17031 4.76975 5.17031 4.92575 5.32631Z"/></svg>
                    <span>Receive Call</span>
                </button>
            </div>

            <div id="call-flow-view" class="card call-flow-card fade-in" style="display: none;">
                <h3 id="scenario-title" class="card-title scenario-title-dynamic">Call Scenario</h3>
                <div id="steps-container" class="steps-area">
                    <p class="placeholder-text">Loading call steps...</p>
                </div>
                <div class="navigation-buttons">
                    <button id="prev-step-btn" class="nav-button secondary-button" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                        <span>Previous</span>
                    </button>
                    <button id="next-step-btn" class="nav-button primary-button">
                        <span>Next Step</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </button>
                </div>
                 <button id="end-call-btn" class="nav-button danger-button" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    <span>End Call</span>
                </button>
            </div>

            <div id="postCallSummary" class="card post-call-summary-card fade-in" style="display: none;">
                <h3 class="card-title">Call Summary</h3>
                <div id="callSummaryContent">
                    {/* Content will be injected by JS */}
                </div>
                <button id="returnToInitialViewBtn" class="action-button primary-button" style="margin-top: 1.5rem;">New Call</button>
            </div>
        </main>

        <footer class="app-footer">
            <p>¬© <span id="currentYear"></span> Mohamed Elmenisy - Elevo Core. All rights reserved.</p>
        </footer>
    </div>

    <script type="module">
        // Supabase Client Setup
        const SUPABASE_URL = 'https://aefiigottnlcmjzilqnh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlZmlpZ290dG5sY21qemlscW5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNzY2MDQsImV4cCI6MjA2Mjc1MjYwNH0.FypB02v3tGMnxXV9ZmZMdMC0oQpREKOJWgHMPxUzwX4';
        
        let supabase;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('Supabase client initialized for core-flow.html');
        } catch (error) {
            console.error("Supabase client initialization failed:", error);
            const authLoading = document.getElementById('auth-loading');
            if(authLoading) authLoading.innerHTML = '<p style="color:red; text-align:center;">Error connecting to services. Core Flow is unavailable.</p>';
        }

        // DOM Elements
        const authLoadingDiv = document.getElementById('auth-loading');
        const initialViewDiv = document.getElementById('initial-view');
        const callFlowViewDiv = document.getElementById('call-flow-view');
        const postCallSummaryDiv = document.getElementById('postCallSummary');
        
        const scenarioDropdown = document.getElementById('scenarioDropdown');
        const receiveCallBtn = document.getElementById('receive-call-btn');
        const scenarioTitleElement = document.getElementById('scenario-title');
        const stepsContainer = document.getElementById('steps-container');
        const prevStepBtn = document.getElementById('prev-step-btn');
        const nextStepBtn = document.getElementById('next-step-btn');
        const endCallBtn = document.getElementById('end-call-btn');
        
        const userInfoDiv = document.getElementById('userInfo');
        const userNameSpan = document.getElementById('userName');
        const logoutButton = document.getElementById('logoutButton');
        const dashboardLink = document.getElementById('dashboardLink');
        
        const systemStatusDiv = document.getElementById('systemStatus');
        const callTimerDiv = document.getElementById('callTimer');
        const progressTrackerContainer = document.getElementById('progressTracker');
        
        const assistantBox = document.getElementById('assistantBox');
        const assistantMessageElement = document.getElementById('assistantMessageElement');
        
        const callSummaryContentDiv = document.getElementById('callSummaryContent');
        const returnToInitialViewBtn = document.getElementById('returnToInitialViewBtn');
        const callStartSound = document.getElementById('callStartSound');
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        // State Variables
        let currentUser = null; // Will store {id, email, name, isAdmin}
        let currentScenario = null; // {id, name, steps}
        let currentStepIndex = 0;
        let callSessionId = null;
        let stepTimerInterval = null;
        let stepStartTime = 0; // Timestamp for current step's start
        let accumulatedStepDurations = []; // Array to store duration of each step in seconds

        const SESSION_STATE_KEY = 'elevoCoreActiveCallState_v2'; // Updated key for sessionStorage

        // --- Helper Functions ---
        function updateSystemStatus(statusText, statusClass = 'status-waiting') {
            if (systemStatusDiv) {
                systemStatusDiv.textContent = statusText;
                systemStatusDiv.className = `status-indicator ${statusClass}`;
            }
        }

        function animateView(viewElement) {
            if (viewElement) {
                viewElement.classList.remove('fade-in');
                void viewElement.offsetWidth; // Trigger reflow
                viewElement.classList.add('fade-in');
                viewElement.style.display = 'block';
            }
        }
        
        let assistantTimeout = null;
        let typingInterval = null;

        function typeWriterEffect(element, message, speed = 30, callback) {
            if (typingInterval) clearInterval(typingInterval);
            element.textContent = '';
            let i = 0;
            typingInterval = setInterval(() => {
                if (i < message.length) { element.textContent += message.charAt(i); i++; }
                else { clearInterval(typingInterval); typingInterval = null; if (callback) callback(); }
            }, speed);
        }
        
        function showAssistantMessage(message, isInitial = false, duration = 5000, onHideCallback = null) {
            if (!assistantBox || !assistantMessageElement) return;

            clearTimeout(assistantTimeout);
            if (typingInterval) clearInterval(typingInterval);

            assistantBox.classList.remove('show', 'assistant-initial-position'); // Clear old states
            void assistantBox.offsetWidth; // Reflow

            if (isInitial) {
                assistantBox.classList.add('assistant-initial-position');
            } else {
                assistantBox.classList.add('show'); // For fixed position slide-in
            }
            assistantBox.style.display = 'flex';

            typeWriterEffect(assistantMessageElement, message, 30, () => {
                if (duration > 0) {
                    assistantTimeout = setTimeout(() => {
                        hideAssistant(isInitial);
                        if (onHideCallback) onHideCallback();
                    }, duration);
                }
            });
        }

        function hideAssistant(wasInitial = false) {
             if (!assistantBox) return;
             if (wasInitial) {
                 assistantBox.classList.remove('assistant-initial-position');
             } else {
                assistantBox.classList.remove('show');
             }
             // Hide after transition or immediately
             setTimeout(() => {
                if (!assistantBox.classList.contains('show') && !assistantBox.classList.contains('assistant-initial-position')) {
                    assistantBox.style.display = 'none';
                }
             }, wasInitial ? 0 : 400); // 400ms for slide-out transition
        }


        // --- Authentication and Initialization ---
        async function initializeApp() {
            if (!supabase) { // Supabase client failed to init
                 authLoadingDiv.innerHTML = '<p style="color:red; text-align:center;">Critical Error: Services unavailable. Please try again later.</p>';
                 return;
            }

            const { data: { session }, error: sessionError } = await supabase.auth.getSession();

            if (sessionError) {
                console.error("Error fetching session:", sessionError);
                authLoadingDiv.innerHTML = '<p style="color:red;">Error verifying session. Try refreshing.</p>';
                return;
            }

           // ... ÿØÿßÿÆŸÑ ÿØÿßŸÑÿ© initializeApp() ŸÅŸä core-flow.html
            if (!session) {
                // MODIFIED: Redirect to login.html without redirectTo parameter to break the loop.
                console.log("No active session. Redirecting to login page.");
                window.location.replace('login.html'); 
                return;
            }

            // User is authenticated, fetch their details from localStorage or DB
            const storedUserData = JSON.parse(localStorage.getItem('elevoCoreUserData'));
            if (storedUserData && storedUserData.id === session.user.id) {
                currentUser = storedUserData;
            } else { // Fetch from DB if not in localStorage or mismatch
                const { data: profile, error: profileError } = await supabase
                    .from('users')
                    .select('name, is_admin')
                    .eq('id', session.user.id)
                    .single();
                
                if (profileError && profileError.code !== 'PGRST116') {
                    console.error("Error fetching user profile:", profileError);
                    authLoadingDiv.innerHTML = '<p style="color:red;">Could not load user profile.</p>';
                    return;
                }
                currentUser = {
                    id: session.user.id,
                    email: session.user.email,
                    name: profile?.name || session.user.user_metadata?.full_name || session.user.email.split('@')[0],
                    isAdmin: profile?.is_admin || false
                };
                localStorage.setItem('elevoCoreUserData', JSON.stringify(currentUser));
            }
            
            console.log("Authenticated User:", currentUser);
            if (userNameSpan) userNameSpan.textContent = currentUser.name;
            if (userInfoDiv) userInfoDiv.style.display = 'flex';
            if (dashboardLink && !currentUser.isAdmin) { // Hide dashboard link for non-admins
                dashboardLink.style.display = 'none';
            }


            authLoadingDiv.style.display = 'none';
            
            // Attempt to restore call state from sessionStorage
            if (restoreCallState()) {
                console.log("Restored active call session.");
                switchToCallFlowView(false); // false = don't animate on restore
                renderStep(); // This will also restart timer correctly
                updateSystemStatus("üü¢ In Call (Restored)", "status-in-call");
            } else {
                console.log("No active call state found or state invalid. Loading initial view.");
                switchToInitialView();
                await loadActiveScenarios();
                showAssistantMessage("Welcome! Select a scenario to begin.", true, 7000, () => {
                     if (initialViewDiv && initialViewDiv.style.display === 'block') { // Only show tip if still on initial view
                          showAssistantMessage("üí° Tip: Choose a scenario and click 'Receive Call'.", true, 0); // 0 for indefinite
                     }
                 });
            }
        }

        // --- View Switching ---
        function switchToInitialView() {
            callFlowViewDiv.style.display = 'none';
            postCallSummaryDiv.style.display = 'none';
            progressTrackerContainer.style.display = 'none';
            callTimerDiv.style.display = 'none';
            animateView(initialViewDiv);
            updateSystemStatus("üî¥ Waiting for Call", "status-waiting");
            hideAssistant(false); // Hide call-mode assistant
        }

        function switchToCallFlowView(animate = true) {
            initialViewDiv.style.display = 'none';
            postCallSummaryDiv.style.display = 'none';
            if (animate) animateView(callFlowViewDiv);
            else callFlowViewDiv.style.display = 'block';
            progressTrackerContainer.style.display = 'block'; // Show progress tracker
            updateSystemStatus("üü¢ In Call", "status-in-call");
            hideAssistant(true); // Hide initial-mode assistant
        }

        function switchToSummaryView() {
            initialViewDiv.style.display = 'none';
            callFlowViewDiv.style.display = 'none';
            progressTrackerContainer.style.display = 'none';
            callTimerDiv.style.display = 'none';
            animateView(postCallSummaryDiv);
            updateSystemStatus("üìä Review Call Summary", "status-summary");
            hideAssistant(false); // Hide call-mode assistant
        }

        // --- Scenario and Steps Logic ---
        async function loadActiveScenarios() {
            scenarioDropdown.disabled = true;
            receiveCallBtn.disabled = true;
            scenarioDropdown.innerHTML = '<option value="">Loading scenarios...</option>';

            try {
                const { data: scenarios, error } = await supabase
                    .from('call_scenarios')
                    .select('id, name')
                    .eq('is_active', true)
                    .order('name', { ascending: true });

                if (error) throw error;

                if (scenarios && scenarios.length > 0) {
                    scenarioDropdown.innerHTML = '<option value="">-- Select a Scenario --</option>';
                    scenarios.forEach(s => {
                        const option = document.createElement('option');
                        option.value = s.id;
                        option.textContent = s.name;
                        scenarioDropdown.appendChild(option);
                    });
                    scenarioDropdown.disabled = false;
                } else {
                    scenarioDropdown.innerHTML = '<option value="">No active scenarios</option>';
                     showAssistantMessage("‚ö†Ô∏è No active call scenarios available.", true, 0);
                }
            } catch (err) {
                console.error("Error loading scenarios:", err);
                scenarioDropdown.innerHTML = '<option value="">Error loading scenarios</option>';
                showAssistantMessage(`‚ö†Ô∏è Error loading scenarios: ${err.message}`, true, 8000);
            }
        }
        
        receiveCallBtn.addEventListener('click', async () => {
            const selectedScenarioId = scenarioDropdown.value;
            if (!selectedScenarioId) {
                showAssistantMessage("‚ö†Ô∏è Please select a scenario first.", true, 5000);
                return;
            }
            
            if(callStartSound) callStartSound.play().catch(e => console.warn("Audio play failed:", e));

            resetCallState(); // Clear any previous call state (logical and sessionStorage)
            switchToCallFlowView();
            updateSystemStatus("üü° Loading Scenario...", "status-loading");
            stepsContainer.innerHTML = '<p class="placeholder-text">Loading scenario details...</p>';
            scenarioTitleElement.textContent = 'Loading...';

            try {
                const { data: scenarioData, error: scenarioError } = await supabase
                    .from('call_scenarios')
                    .select('id, name, steps')
                    .eq('id', selectedScenarioId)
                    .single();

                if (scenarioError) throw scenarioError;
                if (!scenarioData || !Array.isArray(scenarioData.steps) || scenarioData.steps.length === 0) {
                    throw new Error("Scenario data is invalid or has no steps.");
                }

                currentScenario = scenarioData;
                currentStepIndex = 0;
                accumulatedStepDurations = new Array(currentScenario.steps.length).fill(0);

                // Create call session in Supabase
                const { data: newSession, error: sessionInsertError } = await supabase
                    .from('call_sessions')
                    .insert({
                        user_id: currentUser.id,
                        scenario_id: currentScenario.id,
                        start_time: new Date().toISOString(),
                        agent_name: currentUser.name,
                        agent_email: currentUser.email
                    })
                    .select('id')
                    .single();
                
                if (sessionInsertError) throw sessionInsertError;
                callSessionId = newSession.id;
                
                scenarioTitleElement.textContent = currentScenario.name;
                updateSystemStatus("üü¢ In Call", "status-in-call");
                renderStep(); // This will start the timer for the first step
                showAssistantMessage(`üöÄ Scenario "${currentScenario.name}" started! Follow the steps.`, false, 0);

            } catch (err) {
                console.error("Error starting call:", err);
                resetCallState();
                switchToInitialView();
                showAssistantMessage(`‚ö†Ô∏è Error starting call: ${err.message}`, true, 7000);
                await loadActiveScenarios(); // Reload scenarios as something might be wrong
            }
        });

        function renderStep() {
            if (!currentScenario || currentStepIndex < 0 || currentStepIndex >= currentScenario.steps.length) {
                stepsContainer.innerHTML = '<p class="placeholder-text">Error: Invalid step.</p>';
                return;
            }
            
            const stepText = currentScenario.steps[currentStepIndex];
            stepsContainer.innerHTML = `<p>${stepText}</p>`;
            
            // Update progress tracker
            renderProgressTracker();

            // Update navigation buttons
            prevStepBtn.style.display = currentStepIndex > 0 ? 'inline-flex' : 'none';
            if (currentStepIndex === currentScenario.steps.length - 1) {
                nextStepBtn.innerHTML = `<span>Finish Scenario</span>`;
            } else {
                nextStepBtn.innerHTML = `<span>Next Step</span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>`;
            }
            endCallBtn.style.display = 'inline-flex';

            // Start or restart timer for this step
            startStepTimer();
            saveCallState(); // Save state whenever a step is rendered

            showAssistantMessage(`üìå Step ${currentStepIndex + 1}: ${stepText.length > 45 ? stepText.substring(0, 42) + "..." : stepText}`, false, 0);
        }
        
        function renderProgressTracker() {
            if (!progressTrackerContainer || !currentScenario || currentScenario.steps.length === 0) {
                if(progressTrackerContainer) progressTrackerContainer.style.display = 'none';
                return;
            }
            const stepperWrapper = progressTrackerContainer.querySelector('.stepper-wrapper');
            if (!stepperWrapper) return;
            
            stepperWrapper.innerHTML = ''; // Clear previous
            const stepperUl = document.createElement('ul');
            stepperUl.className = 'stepper';

            currentScenario.steps.forEach((step, index) => {
                const stepLi = document.createElement('li');
                stepLi.className = 'step';
                if (index < currentStepIndex) stepLi.classList.add('completed');
                else if (index === currentStepIndex) stepLi.classList.add('active');

                const stepNumber = document.createElement('span');
                stepNumber.className = 'step-number';
                stepNumber.textContent = index < currentStepIndex ? '‚úì' : index + 1;
                stepLi.appendChild(stepNumber);
                // Titles are hidden by CSS, so not creating them for brevity
                stepperUl.appendChild(stepLi);

                if (index < currentScenario.steps.length - 1) {
                    const separator = document.createElement('li');
                    separator.className = 'step-separator';
                     if (index < currentStepIndex) separator.style.backgroundColor = 'var(--success-color)';
                    stepperUl.appendChild(separator);
                }
            });
            stepperWrapper.appendChild(stepperUl);
            progressTrackerContainer.style.display = 'block';
        }

        nextStepBtn.addEventListener('click', () => {
            stopAndRecordStepTimer();
            if (currentStepIndex < currentScenario.steps.length - 1) {
                currentStepIndex++;
                renderStep();
            } else {
                finishCall(true); // true = completed all steps
            }
        });

        prevStepBtn.addEventListener('click', () => {
            stopAndRecordStepTimer();
            if (currentStepIndex > 0) {
                currentStepIndex--;
                renderStep();
            }
        });
        
        endCallBtn.addEventListener('click', () => {
            stopAndRecordStepTimer();
            finishCall(false); // false = did not complete all steps
        });

        // --- Timer Logic ---
        function startStepTimer() {
            callTimerDiv.style.display = 'inline-block';
            if (stepTimerInterval) clearInterval(stepTimerInterval);
            
            // If restoring, stepStartTime is already set by restoreCallState and includes elapsed.
            // Otherwise, it's a new step.
            if (stepStartTime === 0) { // Means it's a fresh start for this step (not a restore)
                stepStartTime = Date.now();
            }
            
            function updateTimerDisplay() {
                const elapsedMilliseconds = Date.now() - stepStartTime;
                const totalSeconds = Math.floor(elapsedMilliseconds / 1000);
                const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
                const seconds = String(totalSeconds % 60).padStart(2, '0');
                callTimerDiv.textContent = `${minutes}:${seconds}`;
            }
            updateTimerDisplay(); // Initial display
            stepTimerInterval = setInterval(updateTimerDisplay, 1000);
        }

        function stopAndRecordStepTimer() {
            if (stepTimerInterval) clearInterval(stepTimerInterval);
            stepTimerInterval = null;
            if (stepStartTime > 0 && currentStepIndex < accumulatedStepDurations.length) {
                const durationSeconds = Math.floor((Date.now() - stepStartTime) / 1000);
                accumulatedStepDurations[currentStepIndex] += durationSeconds;
            }
            stepStartTime = 0; // Reset for the next step
        }
        
        // --- Call Completion & Summary ---
        async function finishCall(completedAllSteps) {
            stopAndRecordStepTimer(); // Ensure current step's time is recorded
            
            const totalDuration = accumulatedStepDurations.reduce((sum, dur) => sum + dur, 0);
            const quality = completedAllSteps ? 'Good' : (totalDuration > 0 ? 'Bad' : 'N/A'); // Simplified logic
            const reason = completedAllSteps ? 'All steps completed successfully.' : 'Call ended prematurely.';
            
            updateSystemStatus(completedAllSteps ? "‚úÖ Call Completed" : "‚ö™ Call Ended", 
                               completedAllSteps ? "status-completed" : "status-ended");

            // Update call session in Supabase
            if (callSessionId) {
                const { error: updateError } = await supabase
                    .from('call_sessions')
                    .update({
                        end_time: new Date().toISOString(),
                        total_duration_seconds: totalDuration,
                        completed_all_steps: completedAllSteps,
                        call_quality: quality, // To be updated by Edge Function
                        quality_reason: reason   // To be updated by Edge Function
                    })
                    .eq('id', callSessionId);
                if (updateError) console.error("Error updating call session (pre-eval):", updateError);

                // Invoke Edge Function to evaluate (as per original logic)
                 try {
                    console.log(`Invoking evaluate-call-session for session: ${callSessionId}`);
                    const { data: evalData, error: funcError } = await supabase.functions.invoke('evaluate-call-session', {
                        body: { sessionId: callSessionId, quality: quality, reason: reason }
                    });
                    if (funcError) throw funcError;
                    console.log("evaluate-call-session response:", evalData);
                    // The function should ideally update the DB directly. If it returns values, you might update local display here.
                } catch (err) {
                    console.error("Error invoking evaluate-call-session:", err);
                    // Use the locally determined quality/reason if function fails
                }
            }
            
            displayPostCallSummary(quality, reason, totalDuration);
            clearCallState(); // Clear sessionStorage after call is fully processed
        }

        function displayPostCallSummary(quality, reason, totalDurationSeconds) {
            let summaryHTML = `
                <p><strong>Call Quality:</strong> <span class="quality-text quality-${quality?.toLowerCase() || 'na'}">${quality || 'N/A'}</span></p>
                <p><strong>Reason:</strong> ${reason || "N/A"}</p>
                <p><strong>Total Duration:</strong> ${Math.floor(totalDurationSeconds / 60)}m ${totalDurationSeconds % 60}s</p>
                <hr style="margin: 1rem 0; border-color: var(--border-color);">
                <p><strong>Step Durations:</strong></p>
                <ul style="list-style: none; padding-left: 0; max-height: 150px; overflow-y: auto;">`;

            if (currentScenario && currentScenario.steps) {
                currentScenario.steps.forEach((step, index) => {
                    const duration = accumulatedStepDurations[index] || 0;
                    const stepShortText = step.length > 25 ? step.substring(0, 22) + "..." : step;
                    const timeStr = `${Math.floor(duration / 60)}m ${duration % 60}s`;
                    summaryHTML += `<li style="margin-bottom: 0.3rem;">${index + 1}. "${stepShortText}": ${timeStr}</li>`;
                });
            } else {
                summaryHTML += `<li>No step duration data available.</li>`;
            }
            summaryHTML += `</ul>`;
            callSummaryContentDiv.innerHTML = summaryHTML;
            switchToSummaryView();
        }
        
        returnToInitialViewBtn.addEventListener('click', async () => {
            resetCallState(true); // true = also reset UI to initial view
            await loadActiveScenarios();
            showAssistantMessage("üí° Ready for the next call! Select a scenario.", true, 7000);
        });

        // --- State Management (SessionStorage for reload resilience) ---
        function saveCallState() {
            if (!callSessionId || !currentScenario) return;
            const state = {
                callSessionId,
                currentScenario,
                currentStepIndex,
                accumulatedStepDurations: [...accumulatedStepDurations], // Shallow copy
                stepStartTime: stepStartTime, // Save the actual start time of the current step
                timestamp: Date.now()
            };
            try {
                sessionStorage.setItem(SESSION_STATE_KEY, JSON.stringify(state));
            } catch (e) { console.error("Error saving call state:", e); }
        }

        function restoreCallState() {
            try {
                const savedStateJSON = sessionStorage.getItem(SESSION_STATE_KEY);
                if (!savedStateJSON) return false;

                const savedState = JSON.parse(savedStateJSON);
                // Optional: Check timestamp for freshness, e.g., if (Date.now() - savedState.timestamp > some_timeout) return false;

                callSessionId = savedState.callSessionId;
                currentScenario = savedState.currentScenario;
                currentStepIndex = savedState.currentStepIndex;
                accumulatedStepDurations = savedState.accumulatedStepDurations || new Array(currentScenario.steps.length).fill(0);
                stepStartTime = savedState.stepStartTime; // Restore the original start time
                
                // Sanity checks
                if (!callSessionId || !currentScenario || !currentScenario.steps || currentStepIndex < 0) {
                    throw new Error("Invalid restored state data.");
                }
                return true;
            } catch (e) {
                console.error("Error restoring call state:", e);
                clearCallState();
                return false;
            }
        }

        function clearCallState() {
            sessionStorage.removeItem(SESSION_STATE_KEY);
            console.log("Cleared call state from sessionStorage.");
        }

        function resetCallState(switchToInitial = false) {
            stopAndRecordStepTimer(); // Stop any running timer
            clearCallState(); // Clear from SessionStorage

            callSessionId = null;
            currentScenario = null;
            currentStepIndex = 0;
            accumulatedStepDurations = [];
            stepStartTime = 0;
            
            if (switchToInitial) {
                switchToInitialView();
            }
            console.log("Call state reset.");
        }

        // --- Logout ---
        logoutButton.addEventListener('click', async () => {
            resetCallState(); // Clear any active call state
            localStorage.removeItem('elevoCoreUserData'); // Clear user data
            const { error } = await supabase.auth.signOut();
            if (error) console.error("Logout error:", error);
            window.location.replace("login.html");
        });

        // Dropdown listener (enable/disable receive call button)
        scenarioDropdown.addEventListener('change', () => {
            receiveCallBtn.disabled = !scenarioDropdown.value;
        });

        // --- Global Error Handler & Unload ---
        window.addEventListener('error', function(event) {
            console.error('Global error caught:', event.error, 'at', event.filename, ':', event.lineno);
        });
        window.addEventListener('beforeunload', () => {
            if (callSessionId && currentScenario) { // If a call is active
                saveCallState(); // Ensure state is saved before unload
            }
        });
        
        // Start the application
        initializeApp();
        console.log("Core-flow.html script loaded and initialized.");
    </script>
</body>
</html>
