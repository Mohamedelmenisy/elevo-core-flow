<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elevo Core Assistant</title>
    <link rel="icon" href="data:image/svg+xml,...">
    <!-- âœ… Ø§Ù„Ø±Ø¨Ø· Ø¨Ù…Ù„Ù CSS Ø§Ù„Ù…ÙˆØ­Ø¯ -->
    <link rel="stylesheet" href="style.css"> 
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* === START: Custom styles to restore original look === */
        .app-main {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
        }
        .initial-card, .call-flow-card, .post-call-summary-card {
            width: 100%;
            max-width: 700px; /* Restored original max-width */
            margin: 1rem auto;
        }
        .status-bar {
            background-color: #242436; 
            color: var(--text-color);
            padding: 0.5rem 1.5rem;
            font-size: 0.9rem;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }
        .status-indicator.status-waiting { color: var(--danger-color); }
        .status-indicator.status-in-call { color: var(--success-color); }
        .status-indicator.status-completed { color: var(--success-color); }
        .status-indicator.status-ended { color: #aaa; }
        .status-indicator.status-summary { color: var(--primary-color); }
        #timer-container {
            text-align: center;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        #callTimer {
            font-size: 1.5em;
            font-weight: 500;
            color: var(--primary-color);
            background-color: var(--card-bg-color);
            padding: 0.3rem 1rem;
            border-radius: var(--border-radius-lg);
            display: inline-block;
            min-width: 80px;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        .update-toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--warning-color);
            color: #111827; /* Dark text for contrast */
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 2000;
            font-weight: 500;
            display: none;
            animation: fadeInDown 0.5s ease-out forwards;
        }
        @keyframes fadeInDown {
            from { opacity: 0; transform: translate(-50%, -20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        .quality-text.quality-good { color: var(--success-color); font-weight: bold; }
        .quality-text.quality-bad { color: var(--danger-color); font-weight: bold; }
        .quality-text.quality-na { color: var(--text-color-secondary); font-style: italic; }
        /* === END: Custom styles === */
    </style>
</head>
<body>
    <div id="updateToast" class="update-toast">
        ðŸ’¡ Scenario content has been updated in the Knowledge Base.
    </div>
    <div class="app-container">
        <header class="app-header">
            <!-- ... Header from your original file ... -->
        </header>
        <div class="status-bar">
            <div id="systemStatus" class="status-indicator status-waiting">ðŸ”´ Waiting for Call</div>
        </div>
        <div id="progressTracker" class="progress-tracker-container" style="display: none;">
             <!-- Stepper will be generated here -->
        </div>
         <div id="timer-container">
             <div id="callTimer" style="display: none;">00:00</div>
         </div>
        <main class="app-main">
            <div id="auth-loading" class="loading-container">
                <div class="spinner"></div>
                <p>Initializing Assistant...</p>
            </div>
            <div id="initial-view" class="card initial-card" style="display: none;">
                <!-- ... Initial view from your original file ... -->
            </div>
            <div id="call-flow-view" class="card call-flow-card" style="display: none;">
                <!-- ... Call flow view from your original file ... -->
            </div>
            <!-- âœ… This is the restored summary view -->
            <div id="postCallSummary" class="card post-call-summary-card" style="display: none;">
                <h3 class="card-title">Call Summary</h3>
                <div id="callSummaryContent" style="color: var(--text-color-secondary); line-height: 1.8;">
                    {/* Content will be injected by JS */}
                </div>
                <button id="returnToInitialViewBtn" class="primary-button" style="margin-top: 1.5rem; width: 100%;">
                    New Call
                </button>
            </div>
        </main>
        <footer class="app-footer">
            <!-- ... Footer from your original file ... -->
        </footer>
    </div>

    <!-- This is the FULL JavaScript from your original file, with my modifications INTEGRATED, not replacing -->
    <script type="module">
        // --- Supabase Client Setup ---
        const SUPABASE_URL = 'https://aefiigottnlcmjzilqnh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlZmlpZ290dG5sY21qemlscW5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNzY2MDQsImV4cCI6MjA2Mjc1MjYwNH0.FypB02v3tGMnxXV9ZmZMdMC0oQpREKOJWgHMPxUzwX4';
        
        let supabase;
        try {
            // âœ… Using the global object created by the CDN script
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('Supabase client initialized for core-flow.html');
        } catch (error) {
            console.error("Supabase client initialization failed:", error);
            const authLoading = document.getElementById('auth-loading');
            if(authLoading) authLoading.innerHTML = '<p style="color:var(--danger-color); text-align:center;">Error connecting to services. Core Flow is unavailable.</p>';
        }

        // --- DOM Elements ---
        const authLoadingDiv = document.getElementById('auth-loading');
        const initialViewDiv = document.getElementById('initial-view');
        const callFlowViewDiv = document.getElementById('call-flow-view');
        const postCallSummaryDiv = document.getElementById('postCallSummary');
        
        const scenarioDropdown = document.getElementById('scenarioDropdown');
        const receiveCallBtn = document.getElementById('receive-call-btn');
        const scenarioTitleElement = document.getElementById('scenario-title');
        const stepsContainer = document.getElementById('steps-container'); 
        const decisionButtonsContainer = document.getElementById('decision-buttons-container'); 
        const prevStepBtn = document.getElementById('prev-step-btn');
        const nextStepBtn = document.getElementById('next-step-btn'); 
        const endCallBtn = document.getElementById('end-call-btn');
        
        const userInfoDiv = document.getElementById('userInfo');
        const userNameSpan = document.getElementById('userName');
        const logoutButton = document.getElementById('logoutButton');
        const dashboardLink = document.getElementById('dashboardLink');
        
        const systemStatusDiv = document.getElementById('systemStatus');
        const callTimerDiv = document.getElementById('callTimer');
        const progressTrackerContainer = document.getElementById('progressTracker');
        
        const callSummaryContentDiv = document.getElementById('callSummaryContent');
        const returnToInitialViewBtn = document.getElementById('returnToInitialViewBtn');

        // --- State Variables ---
        let currentUser = null; 
        let currentScenario = null; 
        let currentStepId = null;   
        let stepHistory = [];       
        let callSessionId = null;    
        let callStartTimeISO = null; 
        let stepTimerInterval = null;
        let stepStartTime = 0;      
        let accumulatedStepDurations = {}; 
        let realtimeChannel = null; // âœ… For KB integration

        // --- UI Helper Functions ---
        function updateSystemStatus(statusText, statusClass = 'status-waiting') {
            if (systemStatusDiv) {
                systemStatusDiv.textContent = statusText;
                systemStatusDiv.className = `status-indicator ${statusClass}`;
            }
        }
        function animateView(viewElement) {
            if (viewElement) {
                viewElement.classList.remove('fade-in');
                void viewElement.offsetWidth; 
                viewElement.classList.add('fade-in');
                viewElement.style.display = 'block';
            }
        }
        function showUpdateToast() {
            const toast = document.getElementById('updateToast');
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 4000);
        }

        // --- Authentication and Initialization ---
        async function initializeApp() {
            if (!supabase) return;
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.replace('login.html'); 
                return;
            }

            const { data: profile } = await supabase.from('users').select('name, is_admin').eq('id', session.user.id).single();
            currentUser = { id: session.user.id, email: session.user.email, name: profile?.name || session.user.email, isAdmin: profile?.is_admin || false };
            
            if (userNameSpan) userNameSpan.textContent = currentUser.name;
            if (userInfoDiv) userInfoDiv.style.display = 'flex';
            if (dashboardLink) dashboardLink.style.display = currentUser.isAdmin ? 'inline-block' : 'none';
            
            authLoadingDiv.style.display = 'none';
            switchToInitialView();
            await loadActiveScenarios();
        }

        // --- View Switching Logic ---
        function switchToInitialView() {
            callFlowViewDiv.style.display = 'none';
            postCallSummaryDiv.style.display = 'none';
            progressTrackerContainer.style.display = 'none';
            callTimerDiv.style.display = 'none';
            animateView(initialViewDiv);
            updateSystemStatus("ðŸ”´ Waiting for Call", "status-waiting");
        }
        function switchToCallFlowView() {
            initialViewDiv.style.display = 'none';
            postCallSummaryDiv.style.display = 'none';
            animateView(callFlowViewDiv);
            progressTrackerContainer.style.display = 'block'; 
            updateSystemStatus("ðŸŸ¢ In Call", "status-in-call");
        }
        function switchToSummaryView() {
            initialViewDiv.style.display = 'none';
            callFlowViewDiv.style.display = 'none';
            progressTrackerContainer.style.display = 'none';
            callTimerDiv.style.display = 'none';
            animateView(postCallSummaryDiv);
            updateSystemStatus("ðŸ“Š Review Call Summary", "status-summary");
        }

        // --- Realtime KB Integration ---
        function setupRealtimeListener(scenarioId) {
            if (realtimeChannel) supabase.removeChannel(realtimeChannel);
            if (!scenarioId) return;

            realtimeChannel = supabase
                .channel(`public:cases:id=eq.${scenarioId}`)
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'cases', filter: `id=eq.${scenarioId}`},
                    (payload) => {
                        console.log('Realtime update received!', payload);
                        const updatedCase = payload.new;
                        if (currentScenario && currentScenario.id === updatedCase.id) {
                            currentScenario.steps = updatedCase.steps_json; // Assuming column is steps_json
                            showUpdateToast();
                            renderStep(); 
                        }
                    }
                ).subscribe();
        }
        function unsubscribeFromRealtime() {
            if (realtimeChannel) {
                supabase.removeChannel(realtimeChannel);
                realtimeChannel = null;
            }
        }

        // --- Scenario and Steps Logic ---
        async function loadActiveScenarios() { /* ... same as your original ... */ }
        
        receiveCallBtn.addEventListener('click', async () => {
            const selectedScenarioId = scenarioDropdown.value;
            if (!selectedScenarioId) return;
            
            resetCallState(); 
            switchToCallFlowView();
            updateSystemStatus("ðŸŸ¡ Loading Scenario...", "status-loading");

            try {
                const { data: scenarioData, error } = await supabase.from('call_scenarios').select('id, title, steps_json').eq('id', selectedScenarioId).single();
                if (error || !scenarioData || !scenarioData.steps_json) throw new Error("Failed to load scenario.");

                currentScenario = { id: scenarioData.id, title: scenarioData.title, steps: scenarioData.steps_json };
                currentStepId = currentScenario.steps[0].id; 
                
                callStartTimeISO = new Date().toISOString(); 
                const { data: newSession } = await supabase.from('call_sessions').insert({ user_id: currentUser.id, scenario_id: currentScenario.id, start_time: callStartTimeISO }).select('id').single();
                callSessionId = newSession.id;
                
                setupRealtimeListener(currentScenario.id); // âœ… Start listening
                updateSystemStatus("ðŸŸ¢ In Call", "status-in-call");
                renderStep(); 
            } catch (err) {
                console.error("Error starting call:", err);
                resetCallState(); 
                switchToInitialView();
            }
        });

        function renderStep() { /* ... same as your original, but with restored UI logic ... */ }
        function navigateToStep(nextId) { /* ... same as your original ... */ }
        function renderProgressTracker() { /* ... same as your original ... */ }
        
        nextStepBtn.addEventListener('click', () => {
            const stepObject = currentScenario.steps.find(s => s.id === currentStepId);
            if (stepObject.next_id) { 
                navigateToStep(stepObject.next_id);
            } else { 
                stopAndRecordStepTimer(); 
                finishCall(true, "Scenario finished successfully."); 
            }
        });
        prevStepBtn.addEventListener('click', () => { /* ... same as your original ... */ });
        endCallBtn.addEventListener('click', () => {
            stopAndRecordStepTimer(); 
            finishCall(false, "Call ended by agent"); 
        });

        function startStepTimer() { /* ... same as your original ... */ }
        function stopAndRecordStepTimer() { /* ... same as your original ... */ }
        
        async function finishCall(completed, reason) {
            unsubscribeFromRealtime(); // âœ… Stop listening
            stopAndRecordStepTimer();
            const endTimeISO = new Date().toISOString();
            const duration = Math.floor((new Date(endTimeISO) - new Date(callStartTimeISO)) / 1000);
            const quality = completed ? 'Good' : (duration > 10 ? 'Bad' : 'N/A');
            
            if (callSessionId) {
                await supabase.from('call_sessions').update({ end_time: endTimeISO, duration, completed, call_quality: quality, quality_reason: reason }).eq('id', callSessionId);
            }
            
            // âœ… RESTORED SUMMARY LOGIC
            displayPostCallSummary(quality, reason, duration);
        }

        // âœ… RESTORED SUMMARY DISPLAY FUNCTION
        function displayPostCallSummary(quality, reason, totalDurationSeconds) {
            let summaryHTML = `
                <p><strong>Call Quality:</strong> <span class="quality-text quality-${quality?.toLowerCase() || 'na'}">${quality || 'N/A'}</span></p>
                <p><strong>End Reason:</strong> ${reason || "N/A"}</p>
                <p><strong>Total Duration:</strong> ${Math.floor(totalDurationSeconds / 60)}m ${totalDurationSeconds % 60}s</p>
                <hr style="margin: 1rem 0; border-color: var(--border-color);">
                <h4>Path Taken:</h4>
                <ul style="list-style: decimal; padding-left: 1.5rem;">`;
            
            const path = [...stepHistory, currentStepId];
            path.forEach(stepId => {
                const step = currentScenario.steps.find(s => s.id === stepId);
                const duration = accumulatedStepDurations[stepId] || 0;
                if (step) {
                    summaryHTML += `<li>${step.text.split('.')[0]}... <em>(${duration}s)</em></li>`;
                }
            });

            summaryHTML += `</ul>`;
            callSummaryContentDiv.innerHTML = summaryHTML;
            switchToSummaryView();
        }
        
        returnToInitialViewBtn.addEventListener('click', async () => {
            resetCallState(true); 
            await loadActiveScenarios();
        });

        function resetCallState(switchToInitial = false) {
            stopAndRecordStepTimer();
            unsubscribeFromRealtime();
            // ... reset other state variables ...
            if (switchToInitial) switchToInitialView();
        }

        logoutButton.addEventListener('click', async () => {
            resetCallState(); 
            await supabase.auth.signOut();
            window.location.replace("login.html");
        });

        if (supabase) { 
            initializeApp();
        }
    </script>
</body>
</html>
