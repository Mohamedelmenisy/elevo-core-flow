<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Portal - Elevo Core</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M3 12h18M3 6h12M3 18h15'/><path d='M17 9l4 3l-4 3'/></svg>">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Additional page-specific styles for Agent Portal */
        .dashboard-main { 
            max-width: 1400px; 
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .dashboard-header {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        .user-name-emphasis { font-weight: 600; color: var(--primary-color); }

        .stat-card .stat-period {
            font-size: 0.8rem;
            color: var(--text-color-subtle);
            margin-top: 0.25rem;
        }
        
        .chart-container {
            padding: 1.5rem;
            border-radius: var(--border-radius);
            background-color: var(--bg-color);
        }
        .chart-container h3 {
            text-align: center;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="app-container" id="appContainerContent" style="display: none;">
        <header class="app-header">
            <div class="logo">
                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon></svg>
                <h2>Elevo Core Agent Portal</h2>
            </div>
            <div class="header-controls">
                 <a href="core-flow.html">Core Flow</a>
                 <div id="admin-dashboard-link-container" style="display: none;">
                    <a href="dashboard.html">Admin Dashboard</a>
                 </div>
                 <div class="user-info" id="userInfo" style="display: none;">
                    <span id="userNameDisplay" class="user-name-display"></span>
                    <button id="logoutButton" class="primary-button" style="background-color: var(--danger-color);">Logout</button>
                 </div>
            </div>
        </header>

        <main class="app-main dashboard-main">
            <div id="authLoadingMessage" class="loading-container">
                <div class="spinner"></div>
                <p>Loading Your Portal...</p>
            </div>

            <div id="dashboardContent" style="display:none;">
                <div class="dashboard-header">
                    <div class="greeting-section">
                        <div id="userAvatarCharacter" class="user-avatar-char-dashboard"></div>
                        <div>
                            <h1 id="dashboardUserGreeting">Welcome, Agent!</h1>
                            <p id="dashboardUserSubtext">Here's your personal performance overview.</p>
                        </div>
                    </div>
                </div>

                <div class="stats-grid" id="statsGrid">
                     <div class="stat-card card">
                        <h3>Your Total Calls</h3>
                        <p id="totalCalls">0</p>
                    </div>
                     <div class="stat-card card">
                        <h3>Your Avg. Duration</h3>
                        <p id="avgCallDuration">0m 0s</p>
                    </div>
                     <div class="stat-card card">
                        <h3>Your Completion Rate</h3>
                        <p id="completionRate">0%</p>
                    </div>
                     <div class="stat-card card">
                        <h3>Your Avg. Quality Score</h3>
                        <p id="avgQualityScore">N/A</p>
                    </div>
                </div>

                <div class="filter-controls card" id="filterControlsCard">
                    <h3>Filter Your Calls & Generate Reports</h3>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end;">
                        <div><label for="startDateFilter">Start Date:</label><input type="date" id="startDateFilter" class="input-wrapper"></div>
                        <div><label for="endDateFilter">End Date:</label><input type="date" id="endDateFilter" class="input-wrapper"></div>
                        <div style="align-self: end; display: flex; gap: 1rem;">
                            <button id="resetFiltersBtn" class="primary-button" style="background-color: var(--text-color-secondary); width: 100%;">Reset Dates</button>
                            <button id="exportDataXLSXBtn" class="primary-button" style="width: 100%;">Export Report</button>
                        </div>
                    </div>
                </div>

                <div class="analytics-section card" id="analyticsSection">
                    <h2>Your Performance Over Time</h2>
                    <div class="chart-container">
                        <h3>Your Daily Call Volume & Quality</h3>
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>

                <div class="recent-activity-section card" id="recentActivitySection">
                    <h2 id="recentCallsTitle">Your Recent Call Sessions</h2>
                    <div class="table-responsive">
                        <table id="recentCallsTable">
                            <thead>
                                <tr>
                                    <th>Scenario</th><th>Start Time</th><th>Duration</th><th>Completed</th><th>Quality</th><th>Reason</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                    <div id="paginationControls" class="pagination-container"></div>
                </div>
            </div>
        </main>

        <footer class="app-footer">
            <p>Â© <span id="currentYear"></span> Mohamed Elmenisy - Elevo Core. All rights reserved.</p>
        </footer>
    </div>

    <script type="module">
        const SUPABASE_URL = 'https://aefiigottnlcmjzilqnh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlZmlpZ290dG5sY21qemlscW5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNzY2MDQsImV4cCI6MjA2Mjc1MjYwNH0.FypB02v3tGMnxXV9ZmZMdMC-oQpREKOJWgHMPxUzwX4';
        
        let supabase;
        try {
            supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (error) {
            console.error("Supabase client initialization failed:", error);
            document.getElementById('authLoadingMessage').innerHTML = '<p style="color:red;">Critical Error: Services unavailable.</p>';
        }

        // DOM Elements
        const appContainerContent = document.getElementById('appContainerContent');
        const authLoadingMessageDiv = document.getElementById('authLoadingMessage');
        const dashboardContentDiv = document.getElementById('dashboardContent');
        const userNameDisplayHeader = document.getElementById('userNameDisplay');
        const dashboardUserGreeting = document.getElementById('dashboardUserGreeting');
        const userAvatarCharEl = document.getElementById('userAvatarCharacter');
        const userInfoDivHeader = document.getElementById('userInfo');
        const logoutButton = document.getElementById('logoutButton');
        const adminDashboardLinkContainer = document.getElementById('admin-dashboard-link-container');
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        const totalCallsEl = document.getElementById('totalCalls');
        const avgCallDurationEl = document.getElementById('avgCallDuration');
        const completionRateEl = document.getElementById('completionRate');
        const avgQualityScoreEl = document.getElementById('avgQualityScore');
        
        const startDateFilter = document.getElementById('startDateFilter');
        const endDateFilter = document.getElementById('endDateFilter');
        const resetFiltersBtn = document.getElementById('resetFiltersBtn');
        const recentCallsTableBody = document.querySelector('#recentCallsTable tbody');
        const paginationControlsContainer = document.getElementById('paginationControls');
        const exportDataXLSXBtn = document.getElementById('exportDataXLSXBtn');
        const performanceChartCanvas = document.getElementById('performanceChart');
        
        let currentUser = null;
        let agentCallSessions = [];
        let filteredCallSessions = [];
        let currentPage = 1;
        const ROWS_PER_PAGE = 10;
        let performanceChartInstance = null;

        async function initializeAgentPortal() {
            if (!supabase) return;
            setChartJsDefaults();
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.replace('login.html');
                return;
            }

            const { data: profile } = await supabase.from('users').select('name, is_admin').eq('id', session.user.id).single();
            currentUser = { id: session.user.id, email: session.user.email, name: profile?.name || session.user.email, isAdmin: profile?.is_admin || false };

            appContainerContent.style.display = 'flex';
            authLoadingMessageDiv.style.display = 'none';
            dashboardContentDiv.style.display = 'block';

            setupAgentUI();
            await loadAgentData();
            applyFiltersAndRender();
            setupEventListeners();
        }

        function setupAgentUI() {
            userNameDisplayHeader.textContent = currentUser.name;
            dashboardUserGreeting.innerHTML = `Welcome to your portal, <span class="user-name-emphasis">${currentUser.name}</span>!`;
            userAvatarCharEl.textContent = currentUser.name.charAt(0).toUpperCase();
            userInfoDivHeader.style.display = 'flex';
            if (currentUser.isAdmin) {
                adminDashboardLinkContainer.style.display = 'block';
            }
        }

        async function loadAgentData() {
            try {
                const { data, error } = await supabase
                    .from('call_sessions')
                    .select(`*, call_sessions_scenario_id_fkey(id, title)`)
                    .eq('user_id', currentUser.id)
                    .order('start_time', { ascending: false });

                if (error) throw error;
                agentCallSessions = data || [];
            } catch (error) {
                console.error("Error loading agent data:", error);
                recentCallsTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:var(--danger-color);">Failed to load your call data.</td></tr>`;
            }
        }
        
        function applyFiltersAndRender() {
            let tempFiltered = [...agentCallSessions];
            const startDate = startDateFilter.value;
            const endDate = endDateFilter.value;

            if (startDate) tempFiltered = tempFiltered.filter(s => s.start_time && new Date(s.start_time) >= new Date(startDate));
            if (endDate) tempFiltered = tempFiltered.filter(s => s.start_time && new Date(s.start_time) <= new Date(new Date(endDate).getTime() + 86400000));
            
            filteredCallSessions = tempFiltered;
            currentPage = 1;
            renderTable();
            updateStats();
            renderPagination();
            renderPerformanceChart();
        }
        
        function renderTable() {
            recentCallsTableBody.innerHTML = '';
            const paginatedSessions = filteredCallSessions.slice((currentPage - 1) * ROWS_PER_PAGE, currentPage * ROWS_PER_PAGE);
            if(paginatedSessions.length === 0) {
                recentCallsTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 1.5rem;">You have no call sessions for the selected period.</td></tr>`;
                return;
            }
            paginatedSessions.forEach(session => {
                const row = recentCallsTableBody.insertRow();
                row.insertCell().textContent = session.call_sessions_scenario_id_fkey?.title || 'N/A';
                row.insertCell().textContent = new Date(session.start_time).toLocaleString();
                const duration = session.duration || 0;
                row.insertCell().textContent = `${Math.floor(duration / 60)}m ${duration % 60}s`;
                row.insertCell().textContent = session.completed ? 'Yes' : 'No';
                row.insertCell().textContent = session.call_quality || 'N/A';
                row.insertCell().textContent = session.quality_reason || '-';
            });
        }

        function updateStats() {
            const count = filteredCallSessions.length;
            totalCallsEl.textContent = count;

            if (count > 0) {
                const totalDuration = filteredCallSessions.reduce((sum, s) => sum + (s.duration || 0), 0);
                const avgDuration = Math.round(totalDuration / count);
                avgCallDurationEl.textContent = `${Math.floor(avgDuration / 60)}m ${avgDuration % 60}s`;
                
                const completedCount = filteredCallSessions.filter(s => s.completed).length;
                completionRateEl.textContent = `${Math.round((completedCount / count) * 100)}%`;

                const ratedSessions = filteredCallSessions.filter(s => s.call_quality);
                if (ratedSessions.length > 0) {
                    let score = 0;
                    ratedSessions.forEach(s => {
                        if (s.call_quality === 'Good') score += 100;
                        else if (s.call_quality === 'Normal') score += 70;
                        else if (s.call_quality === 'Bad') score += 30;
                    });
                    avgQualityScoreEl.textContent = `${Math.round(score / ratedSessions.length)} / 100`;
                } else {
                    avgQualityScoreEl.textContent = 'N/A';
                }
            } else {
                avgCallDurationEl.textContent = '0m 0s';
                completionRateEl.textContent = '0%';
                avgQualityScoreEl.textContent = 'N/A';
            }
        }
        
        function renderPagination() { /* ... Same logic as admin dashboard ... */ }

        function renderPerformanceChart() {
            if (performanceChartInstance) performanceChartInstance.destroy();
            
            const dataByDate = {};
            filteredCallSessions.forEach(session => {
                const date = new Date(session.start_time).toLocaleDateString('en-CA');
                if (!dataByDate[date]) dataByDate[date] = { Good: 0, Normal: 0, Bad: 0, total: 0 };
                if (session.call_quality === 'Good') dataByDate[date].Good++;
                if (session.call_quality === 'Normal') dataByDate[date].Normal++;
                if (session.call_quality === 'Bad') dataByDate[date].Bad++;
                dataByDate[date].total++;
            });
            
            const labels = Object.keys(dataByDate).sort((a,b) => new Date(a) - new Date(b));
            const goodData = labels.map(l => dataByDate[l].Good);
            const normalData = labels.map(l => dataByDate[l].Normal);
            const badData = labels.map(l => dataByDate[l].Bad);
            
            performanceChartInstance = new Chart(performanceChartCanvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: 'Good Calls', data: goodData, backgroundColor: 'var(--success-color)' },
                        { label: 'Normal Calls', data: normalData, backgroundColor: 'var(--warning-color)' },
                        { label: 'Bad Calls', data: badData, backgroundColor: 'var(--danger-color)' }
                    ]
                },
                options: {
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, beginAtZero: true }
                    },
                    plugins: { legend: { position: 'top' } }
                }
            });
        }

        function setupEventListeners() {
            logoutButton.addEventListener('click', async () => {
                await supabase.auth.signOut();
                window.location.replace("login.html");
            });
            
            [startDateFilter, endDateFilter].forEach(el => el.addEventListener('change', applyFiltersAndRender));
            
            resetFiltersBtn.addEventListener('click', () => {
                startDateFilter.value = '';
                endDateFilter.value = '';
                applyFiltersAndRender();
            });
            
            exportDataXLSXBtn.addEventListener('click', exportMyData);
        }

        function exportMyData() {
            if (filteredCallSessions.length === 0) {
                alert("You have no data to export for the selected period.");
                return;
            }
            const dataForExport = filteredCallSessions.map(session => ({
                "Scenario": session.call_sessions_scenario_id_fkey?.title || 'N/A',
                "Start Time": new Date(session.start_time).toLocaleString(),
                "Duration (s)": session.duration || 0,
                "Completed": session.completed ? 'Yes' : 'No',
                "Quality": session.call_quality || 'N/A',
                "Reason": session.quality_reason || '-'
            }));
            const worksheet = XLSX.utils.json_to_sheet(dataForExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "My Call Sessions");
            XLSX.writeFile(workbook, `my_elevo_report_${new Date().toISOString().slice(0,10)}.xlsx`);
        }
        
        function setChartJsDefaults() {
            const isDark = document.documentElement.classList.contains('dark');
            Chart.defaults.color = isDark ? '#f3f4f6' : '#374151';
            Chart.defaults.borderColor = isDark ? '#4b5563' : '#e5e7eb';
            Chart.defaults.font.family = "'Poppins', sans-serif";
        }

        if (supabase) {
            initializeAgentPortal();
        }
    </script>
</body>
</html>
Ø³Ø£Ø±Ø³Ù ÙÙ app.html ÙÙ Ø§ÙØ±Ø¯ Ø§ÙØªØ§ÙÙ.
