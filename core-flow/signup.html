<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - Elevo Core</title>
        <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2317a2b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M3 12h18M3 6h12M3 18h15'/><path d='M17 9l4 3l-4 3'/></svg>">
    <link rel="stylesheet" href="style.css">
    <!-- تم حذف السطر <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> من هنا -->
</head>
<body>
    <div class="signup-container">
        <div class="logo">
             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"> <circle cx="12" cy="12" r="10"></circle> <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon> </svg>
           <h2>Elevo Core</h2>
        </div>
        <div class="signup-header">
            <h2>Create Your Account</h2>
            <p>Join Elevo Core to streamline your workflows.</p>
        </div>

        <form id="signupForm" novalidate>
            <div class="input-group">
                <label for="name">Full Name</label>
                <span class="input-icon" aria-hidden="true">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                </span>
                <input type="text" id="name" name="name" required placeholder="E.g., Jane Doe" aria-describedby="nameError">
                <div id="nameError" class="error-message"></div>
            </div>
            <div class="input-group">
                <label for="email">Email Address</label>
                 <span class="input-icon" aria-hidden="true">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                </span>
                <input type="email" id="email" name="email" required placeholder="your.email@example.com" aria-describedby="emailError signupError">
                <div id="emailError" class="error-message"></div>
            </div>
            <div class="input-group">
                <label for="password">Password</label>
                 <span class="input-icon" aria-hidden="true">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                 </span>
                <input type="password" id="password" name="password" minlength="8" required placeholder="Minimum 8 characters" aria-describedby="passwordError passwordStrength">
                <span class="password-toggle" aria-label="Show password" role="button" tabindex="0">
                     <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                 </span>
                <div class="password-strength" id="passwordStrength"></div>
                <div id="passwordError" class="error-message"></div>
            </div>
            <div class="input-group">
                <label for="confirmPassword">Confirm Password</label>
                <span class="input-icon" aria-hidden="true">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                 </span>
                <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="Retype password" aria-describedby="confirmError">
                 <span class="password-toggle" aria-label="Show password" role="button" tabindex="0">
                     <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                 </span>
                <div id="confirmError" class="error-message"></div>
            </div>
            <div class="terms">
                <input type="checkbox" id="terms" name="terms" required aria-describedby="termsError">
                <div>
                    <label for="terms">I agree to the <a href="#" data-modal-target="termsModal">Terms of Service</a> and <a href="#" data-modal-target="privacyModal">Privacy Policy</a></label>
                    <div id="termsError" class="error-message"></div>
                </div>
            </div>

            <p class="data-privacy-notice">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                Your information is kept confidential and secure.
            </p>

            <div id="signupError" class="error-message" style="text-align: center; margin-bottom: 15px;"></div>
            <div id="signupSuccess" class="success-message" style="text-align: center; margin-bottom: 15px;"></div>

            <button type="submit" class="signup-button" id="submitButton">Create Account</button>
        </form>

        <div class="login-link">
            Already have an account? <a href="login.html">Log in</a>
        </div>
    </div>

    <!-- Modals -->
     <div id="termsModal" class="modal">
         <div class="modal-content">
             <span class="modal-close" data-close-modal>×</span>
             <h1>Terms of Service</h1>
             <p class="modal-date">Last updated: April 26, 2024</p>
             <h2>Welcome to Elevo Core!</h2>
             <p>These terms and conditions outline the rules and regulations for the use of Elevo Core's Website, located at this domain.</p>
             <p>By accessing this website we assume you accept these terms and conditions. Do not continue to use Elevo Core if you do not agree to take all of the terms and conditions stated on this page.</p>
             <h2>Cookies</h2>
             <p>We employ the use of cookies. By accessing Elevo Core, you agreed to use cookies in agreement with the Elevo Core's Privacy Policy.</p>
             <h2>License</h2>
             <p>Unless otherwise stated, Elevo Core and/or its licensors own the intellectual property rights for all material on Elevo Core. All intellectual property rights are reserved. You may access this from Elevo Core for your own personal use subjected to restrictions set in these terms and conditions.</p>
             <p>You must not: Republish material from Elevo Core, Sell, rent or sub-license material from Elevo Core, Reproduce, duplicate or copy material from Elevo Core, Redistribute content from Elevo Core.</p>
             <h2>User Comments</h2>
             <p>Parts of this website offer an opportunity for users to post and exchange opinions and information. Elevo Core does not filter, edit, publish or review Comments prior to their presence on the website. Comments do not reflect the views and opinions of Elevo Core,its agents and/or affiliates.</p>
             <h2>Disclaimer</h2>
             <p>To the maximum extent permitted by applicable law, we exclude all representations, warranties and conditions relating to our website and the use of this website. Nothing in this disclaimer will: limit or exclude our or your liability for death or personal injury; limit or exclude our or your liability for fraud or fraudulent misrepresentation; limit any of our or your liabilities in any way that is not permitted under applicable law; or exclude any of our or your liabilities that may not be excluded under applicable law.</p>
         </div>
     </div>
     <div id="privacyModal" class="modal">
          <div class="modal-content">
              <span class="modal-close" data-close-modal>×</span>
             <h1>Privacy Policy for Elevo Core</h1>
             <p class="modal-date">Last updated: April 26, 2024</p>
             <p>At Elevo Core, accessible from this domain, one of our main priorities is the privacy of our visitors. This Privacy Policy document contains types of information that is collected and recorded by Elevo Core and how we use it.</p>
             <h2>Log Files</h2>
             <p>Elevo Core follows a standard procedure of using log files. These files log visitors when they visit websites. All hosting companies do this and a part of hosting services' analytics. The information collected by log files include internet protocol (IP) addresses, browser type, Internet Service Provider (ISP), date and time stamp, referring/exit pages, and possibly the number of clicks. These are not linked to any information that is personally identifiable. The purpose of the information is for analyzing trends, administering the site, tracking users' movement on the website, and gathering demographic information.</p>
             <h2>Cookies and Web Beacons</h2>
             <p>Like any other website, Elevo Core uses 'cookies'. These cookies are used to store information including visitors' preferences, and the pages on the website that the visitor accessed or visited. The information is used to optimize the users' experience by customizing our web page content based on visitors' browser type and/or other information.</p>
             <h2>Personal Information</h2>
             <p>We collect your Full Name and Email Address during signup. This information is used to create and manage your account, and to communicate with you regarding the service. Your password is securely hashed and stored by Supabase; we do not have access to your plain-text password. We do not sell or share your personal information with third parties, except as required by law or to provide the service (e.g., Supabase as our backend provider).</p>
             <h2>Consent</h2>
             <p>By using our website, you hereby consent to our Privacy Policy and agree to its terms.</p>
         </div>
     </div>

    <script type="module">
        // تم نقل تعريف Supabase client إلى هنا باستخدام ES Modules
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // Supabase Client Setup
        // !!! استبدل القيم التالية ببيانات مشروعك الجديدة من Supabase !!!
        const SUPABASE_URL = 'https://aefiigottnlcmjzilqnh.supabase.co'; // <-- Project URL الخاص بك
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlZmlpZ290dG5sY21qemlscW5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNzY2MDQsImV4cCI6MjA2Mjc1MjYwNH0.FypB02v3tGMnxXV9ZmZMdMC0oQpREKOJWgHMPxUzwX4';

        let supabase;
        try {
            // لم نعد نستخدم window.supabase.createClient
            supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('Supabase client initialized for signup.html using ES Modules');
        } catch (error) {
            console.error("Supabase client initialization failed:", error);
            alert("Error connecting to services. Signup is currently unavailable.");
            const submitBtn = document.getElementById('submitButton');
            if(submitBtn) submitBtn.disabled = true;
        }

        // DOM Elements
        const signupForm = document.getElementById('signupForm');
        const nameInput = document.getElementById('name');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const confirmInput = document.getElementById('confirmPassword');
        const termsCheckbox = document.getElementById('terms');
        const submitButton = document.getElementById('submitButton');
        const passwordToggles = document.querySelectorAll('.password-toggle');
        
        const nameError = document.getElementById('nameError');
        const emailError = document.getElementById('emailError');
        const passwordError = document.getElementById('passwordError');
        const confirmError = document.getElementById('confirmError');
        const termsError = document.getElementById('termsError');
        const signupGeneralError = document.getElementById('signupError');
        const signupSuccessMessage = document.getElementById('signupSuccess');
        const passwordStrengthEl = document.getElementById('passwordStrength');

        // Utility Functions
        function displayError(element, message) {
            if(element) {
                element.textContent = message;
                element.style.display = 'block';
            }
        }
        function clearError(element) {
            if(element) {
                element.textContent = '';
                element.style.display = 'none';
            }
        }
        function displaySuccess(element, message) {
            if(element) {
                element.textContent = message;
                element.style.display = 'block';
            }
        }

        function updatePasswordStrength(password) {
            if (!passwordStrengthEl) return;
            let strength = 0;
            let feedback = "";
            if (!password) {
                passwordStrengthEl.textContent = '';
                passwordStrengthEl.className = 'password-strength';
                return;
            }

            if (password.length >= 8) strength++; else feedback = "Needs 8+ characters. ";
            if (password.match(/[a-z]/)) strength++; else feedback += "Needs lowercase. ";
            if (password.match(/[A-Z]/)) strength++; else feedback += "Needs uppercase. ";
            if (password.match(/\d/)) strength++; else feedback += "Needs number. ";
            if (password.match(/[^a-zA-Z\d\s]/)) strength++; else feedback += "Needs special char. ";

            passwordStrengthEl.className = 'password-strength'; 
            if (strength === 0 && password.length > 0) { passwordStrengthEl.textContent = 'Very Weak. ' + feedback.trim(); passwordStrengthEl.classList.add('strength-weak'); }
            else if (strength <= 2 && password.length > 0) { passwordStrengthEl.textContent = 'Weak. ' + feedback.trim(); passwordStrengthEl.classList.add('strength-weak'); }
            else if (strength <= 4) { passwordStrengthEl.textContent = 'Medium. Good start!'; passwordStrengthEl.classList.add('strength-medium'); }
            else { passwordStrengthEl.textContent = 'Strong!'; passwordStrengthEl.classList.add('strength-strong'); }
        }

        function togglePasswordVisibility(toggleButton, inputElement) {
            if (!toggleButton || !inputElement) return;
            const isPassword = inputElement.type === 'password';
            inputElement.type = isPassword ? 'text' : 'password';
            toggleButton.innerHTML = isPassword ?
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>' : 
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>'; 
            toggleButton.setAttribute('aria-label', isPassword ? 'Hide password' : 'Show password');
        }

        // Event Listeners
        if (passwordInput) {
            passwordInput.addEventListener('input', (e) => updatePasswordStrength(e.target.value));
        }
        if (confirmInput && passwordInput) {
            confirmInput.addEventListener('input', () => {
                if (passwordInput.value !== confirmInput.value) {
                    displayError(confirmError, "Passwords do not match.");
                } else {
                    clearError(confirmError);
                }
            });
        }

        passwordToggles.forEach(toggle => {
            const inputGroup = toggle.closest('.input-group');
            const inputElement = inputGroup ? inputGroup.querySelector('input[type="password"], input[type="text"]') : null;
            
            if (inputElement) {
                toggle.addEventListener('click', () => togglePasswordVisibility(toggle, inputElement));
                toggle.addEventListener('keydown', (e) => { 
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault(); 
                        togglePasswordVisibility(toggle, inputElement); 
                    }
                });
            }
        });

        if (signupForm && supabase) { 
            signupForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                
                [nameError, emailError, passwordError, confirmError, termsError, signupGeneralError, signupSuccessMessage].forEach(clearError);
                submitButton.disabled = true;
                submitButton.textContent = 'Creating Account...';

                const name = nameInput.value.trim();
                const email = emailInput.value.trim().toLowerCase();
                const password = passwordInput.value;
                const confirmPassword = confirmInput.value;
                const termsAgreed = termsCheckbox.checked;

                let isValid = true;

                if (!name) {
                    displayError(nameError, "Full name is required.");
                    isValid = false;
                }
                if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    displayError(emailError, "Please enter a valid email address.");
                    isValid = false;
                }
                if (!password || password.length < 8) { 
                    displayError(passwordError, "Password must be at least 8 characters.");
                    isValid = false;
                }
                if (password !== confirmPassword) {
                    displayError(confirmError, "Passwords do not match.");
                    isValid = false;
                }
                if (!termsAgreed) {
                    displayError(termsError, "You must agree to the terms and conditions.");
                    isValid = false;
                }

                if (!isValid) {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Create Account';
                    return;
                }

                try {
                    const { data: authData, error: authError } = await supabase.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            data: { 
                                full_name: name 
                            }
                        }
                    });

                    if (authError) {
                        throw authError; 
                    }

                    if (!authData.user && authData.session === null) {
                         displaySuccess(signupSuccessMessage, "Signup successful! Please check your email to confirm your account.");
                         signupForm.reset(); 
                         nameInput.focus();
                         submitButton.disabled = false;
                         submitButton.textContent = 'Create Account';
                         return; 
                    }
                    
                    if (authData.user) {
                        const isAdmin = (email === "m.elsayed@thechefz.co"); 
                        const { error: insertError } = await supabase
                            .from('users') 
                            .insert({
                                id: authData.user.id, 
                                name: name,
                                email: email,
                                is_admin: isAdmin 
                            });

                        if (insertError) {
                            console.error("Error inserting user profile:", insertError);
                            displayError(signupGeneralError, `Account created, but profile setup failed. Please contact support. (${insertError.message})`);
                            submitButton.disabled = false;
                            submitButton.textContent = 'Create Account';
                            return;
                        }
                        
                        displaySuccess(signupSuccessMessage, "Signup successful! Redirecting to login...");
                        setTimeout(() => {
                            window.location.href = `login.html?email=${encodeURIComponent(email)}&signedup=true`;
                        }, 2000);
                    } else {
                        displayError(signupGeneralError, "Signup seems to have succeeded but user data is unavailable. Please try logging in or contact support.");
                        submitButton.disabled = false;
                        submitButton.textContent = 'Create Account';
                    }

                } catch (error) {
                    console.error("Signup error:", error);
                    // Default message for the general error display area
                    let messageForGeneralErrorDiv = "An unexpected error occurred. Please try again.";

                    if (error && error.message) { // Check if error and error.message exist
                        const lowerCaseMsg = error.message.toLowerCase();

                        if (lowerCaseMsg.includes("user already registered") || lowerCaseMsg.includes("email already registered")) {
                            messageForGeneralErrorDiv = "This email is already registered. Please log in instead.";
                            if(emailError) clearError(emailError); // Clear specific email field error if any
                        } else if (lowerCaseMsg.includes("password should be at least")) {
                            // If it's a password length error, display it under the password field
                            if(passwordError) displayError(passwordError, error.message); 
                            // And do not show a general error message for this specific case
                            messageForGeneralErrorDiv = ""; // Clear general error message
                        } else {
                            // For other Supabase errors or unhandled messages
                            messageForGeneralErrorDiv = error.message;
                        }
                    }
                    
                    // Display the message in the general error div if it's not empty
                    if(signupGeneralError && messageForGeneralErrorDiv) {
                        displayError(signupGeneralError, messageForGeneralErrorDiv);
                    }
                    
                    // Reset button state
                    submitButton.disabled = false;
                    submitButton.textContent = 'Create Account';
                }
            });
        }

        // Modal Handling
        const modalTriggers = document.querySelectorAll('[data-modal-target]');
        const closeButtons = document.querySelectorAll('[data-close-modal]');

        modalTriggers.forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault();
                const modalId = this.dataset.modalTarget;
                const modal = document.getElementById(modalId);
                if (modal) openModal(modal);
            });
        });

        closeButtons.forEach(button => {
            button.addEventListener('click', function() {
                const modal = this.closest('.modal');
                if (modal) closeModal(modal);
            });
        });

        window.addEventListener('click', function(event) {
            document.querySelectorAll('.modal').forEach(modal => {
                if (event.target == modal) {
                    closeModal(modal);
                }
            });
        });
        window.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                 document.querySelectorAll('.modal').forEach(modal => {
                    if (modal.style.display === 'block') {
                        closeModal(modal);
                    }
                });
            }
        });

        function openModal(modal) {
            if (modal == null) return;
            modal.style.display = 'block';
            document.body.classList.add('modal-open');
            modal.setAttribute('aria-hidden', 'false');
            const firstFocusableElement = modal.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            if (firstFocusableElement) firstFocusableElement.focus();
        }

        function closeModal(modal) {
            if (modal == null) return;
            modal.style.display = 'none';
            document.body.classList.remove('modal-open');
            modal.setAttribute('aria-hidden', 'true');
        }

        if(nameInput) nameInput.focus();
        console.log("Signup page script loaded and initialized.");
    </script>
</body>
</html>
