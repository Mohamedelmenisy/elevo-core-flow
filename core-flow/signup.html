<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - Elevo Core</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M3 12h18M3 6h12M3 18h15'/><path d='M17 9l4 3l-4 3'/></svg>">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="signup-container">
        <div class="logo">
             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"> <circle cx="12" cy="12" r="10"></circle> <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon> </svg>
           <h2>Elevo Core</h2>
        </div>
        <div class="signup-header">
            <h2>Create Your Account</h2>
            <p>Join Elevo Core to streamline your workflows.</p>
        </div>

        <form id="signupForm" novalidate>
            <div class="form-group">
                <label for="name">Full Name</label>
                <div class="input-wrapper">
                    <span class="input-icon" aria-hidden="true">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    </span>
                    <input type="text" id="name" name="name" required placeholder="E.g., Jane Doe" aria-describedby="nameError">
                </div>
                <div id="nameError" class="error-message field-error-message"></div>
            </div>
            <div class="form-group">
                <label for="email">Email Address</label>
                <div class="input-wrapper">
                     <span class="input-icon" aria-hidden="true">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                    </span>
                    <input type="email" id="email" name="email" required placeholder="your.email@example.com" aria-describedby="emailError signupError">
                </div>
                <div id="emailError" class="error-message field-error-message"></div>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <div class="input-wrapper">
                     <span class="input-icon" aria-hidden="true">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                     </span>
                    <input type="password" id="password" name="password" minlength="8" required placeholder="Minimum 8 characters" aria-describedby="passwordError passwordStrength">
                    <span class="password-toggle" aria-label="Show password" role="button" tabindex="0">
                         <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                     </span>
                </div>
                <div class="password-strength" id="passwordStrength"></div>
                <div id="passwordError" class="error-message field-error-message"></div>
            </div>
            <div class="form-group">
                <label for="confirmPassword">Confirm Password</label>
                <div class="input-wrapper">
                    <span class="input-icon" aria-hidden="true">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                     </span>
                    <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="Retype password" aria-describedby="confirmError">
                     <span class="password-toggle" aria-label="Show password" role="button" tabindex="0">
                         <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                     </span>
                </div>
                <div id="confirmError" class="error-message field-error-message"></div>
            </div>
            <div class="terms">
                <input type="checkbox" id="terms" name="terms" required aria-describedby="termsError">
                <div>
                    <label for="terms">I agree to the <a href="#" data-modal-target="termsModal">Terms of Service</a> and <a href="#" data-modal-target="privacyModal">Privacy Policy</a></label>
                    <div id="termsError" class="error-message field-error-message"></div>
                </div>
            </div>

            <p class="data-privacy-notice" style="text-align: center; margin-top: 1rem; color: var(--text-color-light);">
                Note: All new accounts are created with Agent permissions. Admin privileges must be granted by an administrator.
            </p>

            <div id="signupError" class="form-message error-message general-form-error" style="display: none;"></div>
            <div id="signupSuccess" class="form-message success-message" style="display: none;"></div>

            <button type="submit" class="signup-button primary-button" id="submitButton"> <span class="btn-text">Create Account</span> <span class="loading-spinner"></span></button>
        </form>

        <div class="links">
            Already have an account? <a href="login.html">Log in</a>
        </div>
    </div>

    <!-- Modals -->
     <div id="termsModal" class="modal">
         <div class="modal-content">
             <span class="modal-close" data-close-modal>×</span>
             <h1>Terms of Service</h1>
             <p class="modal-date">Last updated: May 15, 2025</p>
             <p>These terms and conditions outline the rules and regulations for the use of Elevo Core's Website.</p>
             <p>By accessing this website we assume you accept these terms and conditions.</p>
             <h2>License</h2>
             <p>Unless otherwise stated, Elevo Core and/or its licensors own the intellectual property rights for all material on Elevo Core. All intellectual property rights are reserved.</p>
         </div>
     </div>
     <div id="privacyModal" class="modal">
          <div class="modal-content">
              <span class="modal-close" data-close-modal>×</span>
             <h1>Privacy Policy for Elevo Core</h1>
             <p class="modal-date">Last updated: May 15, 2025</p>
             <p>At Elevo Core, one of our main priorities is the privacy of our visitors. This Privacy Policy document contains types of information that is collected and recorded by Elevo Core and how we use it.</p>
             <h2>Personal Information</h2>
             <p>We collect your Full Name and Email Address during signup. This information is used to create and manage your account, and to communicate with you regarding the service.</p>
             <h2>Consent</h2>
             <p>By using our website, you hereby consent to our Privacy Policy and agree to its terms.</p>
         </div>
     </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const SUPABASE_URL = 'https://aefiigottnlcmjzilqnh.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlZmlpZ290dG5sY21qemlscW5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNzY2MDQsImV4cCI6MjA2Mjc1MjYwNH0.FypB02v3tGMnxXV9ZmZMdMC-oQpREKOJWgHMPxUzwX4';

        let supabase;
        try {
            supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (error) {
            console.error("Supabase client initialization failed:", error);
            const signupGeneralError = document.getElementById('signupError');
            if(signupGeneralError) {
                signupGeneralError.textContent = "Error: Could not initialize authentication service.";
                signupGeneralError.style.display = 'block';
                document.getElementById('signupForm').style.display = 'none';
            }
        }

        const signupForm = document.getElementById('signupForm');
        const nameInput = document.getElementById('name');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const confirmInput = document.getElementById('confirmPassword');
        const termsCheckbox = document.getElementById('terms');
        const submitButton = document.getElementById('submitButton');
        const passwordToggles = document.querySelectorAll('.password-toggle');
        
        const nameError = document.getElementById('nameError');
        const emailError = document.getElementById('emailError');
        const passwordError = document.getElementById('passwordError');
        const confirmError = document.getElementById('confirmError');
        const termsError = document.getElementById('termsError');
        const signupGeneralError = document.getElementById('signupError');
        const signupSuccessMessage = document.getElementById('signupSuccess');
        const passwordStrengthEl = document.getElementById('passwordStrength');

        function displayError(element, message) { if(element) { element.textContent = message; element.style.display = 'block'; } }
        function clearError(element) { if(element) { element.style.display = 'none'; } }
        function displaySuccess(element, message) { if(element) { element.textContent = message; element.style.display = 'block'; } }
        function setButtonLoading(isLoading) { 
            if (!submitButton) return;
            submitButton.disabled = isLoading;
            submitButton.classList.toggle('loading', isLoading); 
        }

        if (signupForm && supabase) { 
            signupForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                setButtonLoading(true);
                [nameError, emailError, passwordError, confirmError, termsError, signupGeneralError, signupSuccessMessage].forEach(clearError);

                const name = nameInput.value.trim();
                const emailValue = emailInput.value.trim().toLowerCase();
                const passwordValue = passwordInput.value;
                let isValid = true;
                if (!name) { displayError(nameError, 'Full name is required.'); isValid = false; }
                if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailValue)) { displayError(emailError, 'Please enter a valid email address.'); isValid = false; }
                if (passwordValue.length < 8) { displayError(passwordError, 'Password must be at least 8 characters.'); isValid = false; }
                if (passwordValue !== confirmInput.value) { displayError(confirmError, 'Passwords do not match.'); isValid = false; }
                if (!termsCheckbox.checked) { displayError(termsError, 'You must agree to the terms.'); isValid = false; }
                
                if (!isValid) {
                    setButtonLoading(false);
                    return;
                }

                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: emailValue,
                    password: passwordValue,
                    options: { data: { full_name: name } }
                });

                if (authError) {
                    displayError(signupGeneralError, `Signup failed: ${authError.message}`);
                    setButtonLoading(false);
                    return;
                }

                if (authData.user) {
                    const { error: profileError } = await supabase.from('users').insert({
                        id: authData.user.id,
                        name: name,
                        email: emailValue,
                        role: 'agent',
                        is_admin: false
                    });

                    if (profileError) {
                        console.warn("User authenticated, but profile insert failed:", profileError.message);
                    }
                    
                    displaySuccess(signupSuccessMessage, "Account created! Please check your email to confirm, then log in.");

                    setTimeout(async () => {
                        await supabase.auth.signOut();
                        window.location.replace(`login.html?signedup=true&email=${encodeURIComponent(emailValue)}`);
                    }, 3500);

                } else {
                    displayError(signupGeneralError, "An unknown error occurred. Please try again.");
                    setButtonLoading(false);
                }
            });
        }
        
        // Modal Handling and other UI functions (unchanged)
        const modalTriggers = document.querySelectorAll('[data-modal-target]');
        const closeButtons = document.querySelectorAll('[data-close-modal]');
        modalTriggers.forEach(btn => btn.addEventListener('click', e => openModal(document.getElementById(e.target.dataset.modalTarget))));
        closeButtons.forEach(btn => btn.addEventListener('click', e => closeModal(e.target.closest('.modal'))));
        function openModal(modal) { if(modal) modal.style.display = 'block'; }
        function closeModal(modal) { if(modal) modal.style.display = 'none'; }
    </script>
</body>
</html>
