<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leadership Skills Pre-Assessment | Coaching Course</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- Base, Header, User Bar --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html { scroll-behavior: smooth; }
        body { background-color: #f8fafc; margin: 0; padding: 0; line-height: 1.65; color: #374151; display: flex; flex-direction: column; min-height: 100vh; font-size: 16px; }
        main { flex-grow: 1; }
        .header { background-color: #1f2937; color: white; padding: 18px 0; text-align: center; font-size: 1.5rem; font-weight: 600; position: relative; box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1); }
        .user-bar { background-color: #374151; padding: 10px 30px; display: flex; justify-content: space-between; align-items: center; color: #e5e7eb; font-size: 0.95rem; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-info svg { opacity: 0.8; margin-right: 8px; width: 24px; height: 24px; }
        .user-details { display: flex; flex-direction: column; text-align: left; }
        .user-name { font-weight: 600; font-size: 0.95rem; color: #f9fafb; }
        .user-email { font-size: 0.8rem; opacity: 0.8; }
        .logout-button { background-color: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s; display: flex; align-items: center; gap: 6px; font-size: 0.9rem; }
        .logout-button svg { margin-right: 6px; width: 18px; height: 18px; }
        .logout-button:hover { background-color: #dc2626; transform: translateY(-1px); }
        .logout-button:active { transform: translateY(0); }

        /* --- Progress Bar (Sticky Top) --- */
        #overallProgressContainer {
            background-color: #e5e7eb;
            border-radius: 0;
            overflow: hidden;
            height: 20px;
            width: 100%;
            display: block;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: opacity 0.5s ease;
            opacity: 0.5;
        }
        #overallProgressContainer.active { opacity: 1; }
        #overallProgressBar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #3b82f6, #2563eb);
            border-radius: 0;
            transition: width 0.5s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        #overallProgressText {
            font-size: 11px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.4);
            white-space: nowrap;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        /* --- Main Container & Assessment Styles --- */
        .container { max-width: 850px; margin: 30px auto 40px auto; background: white; padding: 35px 45px; box-shadow: 0 4px 25px rgba(0, 0, 0, 0.07); border-radius: 12px; width: 92%; }
        h2 { margin-bottom: 15px; font-size: 1.8rem; text-align: center; color: #111827; font-weight: 700; } /* Increased margin slightly */
        .assessment-intro {
            text-align: center;
            margin-bottom: 35px;
            color: #4b5563;
            font-size: 1.05rem;
            line-height: 1.7;
        }
        .question-block { background-color: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 25px; margin-bottom: 25px; transition: box-shadow 0.3s ease, background-color 0.3s ease, border-color 0.3s ease; position: relative; }
        .question-block.locked { background-color: #f9fafb; border-left: 4px solid #10b981; }
        .question-block:focus-within:not(.locked) { box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        .question-text { font-weight: 600; color: #1f2937; margin-bottom: 15px; display: block; font-size: 1.1rem; }

        /* Input Styles */
        .radio-options label { display: block; background-color: #fff; padding: 12px 18px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s ease; position: relative; padding-left: 40px; font-size: 1rem; }
        .radio-options input[type="radio"] { opacity: 0; position: absolute; }
        .radio-options label:before { content: ''; position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; border: 2px solid #d1d5db; border-radius: 50%; background-color: #fff; transition: border-color 0.2s ease; }
        .radio-options label:after { content: ''; position: absolute; left: 17px; top: 50%; transform: translateY(-50%) scale(0); width: 8px; height: 8px; border-radius: 50%; background-color: #3b82f6; transition: transform 0.2s ease; }
        .radio-options input[type="radio"]:checked + label { border-color: #3b82f6; background-color: #eff6ff; }
        .radio-options input[type="radio"]:checked + label:before { border-color: #3b82f6; }
        .radio-options input[type="radio"]:checked + label:after { transform: translateY(-50%) scale(1); }
        .radio-options label:hover:not(.input-locked label) { background-color: #f9fafb; border-color: #9ca3af;}
        textarea.input-field { width: 100%; padding: 15px; font-size: 1rem; border: 1px solid #d1d5db; border-radius: 8px; transition: all 0.3s; background-color: #fff; min-height: 100px; }
        textarea.input-field:focus { border-color: #3b82f6; outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); background-color: #fff; }
        /* Locked Input Styling */
        .input-locked, .input-locked input[type="radio"], .input-locked label { cursor: not-allowed !important; opacity: 0.7; }
        .input-locked label { background-color: #f3f4f6 !important; border-color: #d1d5db !important; }
        .input-locked label:hover { background-color: #f3f4f6 !important; border-color: #d1d5db !important; }
        .input-locked textarea { background-color: #f3f4f6 !important; border-color: #d1d5db !important; resize: none; }
        .input-locked textarea:focus { box-shadow: none; }

        /* --- Save Button, Warning & Confirmation --- */
        .save-warning {
            font-size: 0.85rem;
            color: #f97316; /* Orange for warning */
            margin-top: 15px;
            margin-bottom: 8px;
            display: block; /* Initially visible */
            font-style: italic;
            transition: opacity 0.3s ease, height 0.3s ease, margin 0.3s ease;
        }
        .question-block.locked .save-warning {
             opacity: 0; height: 0; margin-top: 0; margin-bottom: 0;
             overflow: hidden; padding-top: 0; padding-bottom: 0;
        }
        .save-answer-button {
            background-color: #3b82f6; color: white; border: none;
            padding: 10px 20px; font-size: 0.95rem; cursor: pointer; border-radius: 6px;
            font-weight: 500; transition: all 0.3s; display: inline-block;
            vertical-align: middle; margin-top: 5px;
        }
        .save-answer-button:hover:not(:disabled) { background-color: #2563eb; box-shadow: 0 2px 5px rgba(59, 130, 246, 0.2); transform: translateY(-1px); }
        .save-answer-button:disabled { background: #9ca3af; cursor: not-allowed; box-shadow: none; opacity: 0.8; }
        .save-confirmation {
            color: #059669; font-size: 0.9rem; margin-left: 15px; display: none;
            font-weight: 500; align-items: center; gap: 5px; vertical-align: middle;
            opacity: 0; transition: opacity 0.4s ease;
        }
        .save-confirmation svg { width: 18px; height: 18px; /* Slightly bigger check */ }
        .save-confirmation.visible { display: inline-flex; opacity: 1; }


        /* Form Error Message (General) */
        #formErrorMessage { color: #ef4444; font-size: 0.95rem; margin-top: 15px; display: none; font-weight: 500; text-align: center; background-color: #fef2f2; padding: 12px 15px; border: 1px solid #fecaca; border-radius: 6px; }
        /* Per-question Error Styling (applied to block) */
        .question-block.invalid-block { border-color: #ef4444 !important; box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.15) !important; }

        /* Final Submit Button */
        #submitAssessmentButton { background: linear-gradient(90deg, #10b981, #059669); color: white; border: none; padding: 15px 30px; font-size: 1.1rem; cursor: pointer; border-radius: 8px; display: block; width: 100%; font-weight: 600; transition: all 0.3s; margin-top: 40px; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2); }
        #submitAssessmentButton:hover:not(:disabled) { background: linear-gradient(90deg, #059669, #047857); box-shadow: 0 6px 12px rgba(16, 185, 129, 0.3); transform: translateY(-2px); }
        #submitAssessmentButton:disabled { background: #9ca3af; cursor: not-allowed; box-shadow: none; opacity: 0.6; }

        /* Success Message Area (after final submit) */
        #successMessageArea { background-color: #ecfdf5; color: #059669; border: 1px solid #a7f3d0; padding: 20px 25px; border-radius: 8px; margin: 30px 0; text-align: center; font-weight: 500; display: none; opacity: 0; transition: opacity 0.5s ease; font-size: 1.1rem; }
        #successMessageArea.visible { display: block; opacity: 1; }
        #successMessageArea .redirect-message { font-size: 0.9rem; color: #374151; margin-top: 10px; }

        /* --- Footer --- MODIFIED --- */
        .footer {
            background-color: #e5e7eb;
            padding: 20px 30px; /* Slightly more padding */
            text-align: center;
            color: #4b5563;
            font-size: 0.9rem;
            display: flex;
            justify-content: center; /* Center the inner container */
            align-items: center;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: 20px; /* Gap between inner items if they wrap */
            border-top: 1px solid #d1d5db;
            margin-top: auto;
        }
        .footer-content { /* New wrapper */
            display: flex;
            align-items: center;
            justify-content: center; /* Center items within this wrapper */
            gap: 25px; /* Space between text and icons */
            flex-wrap: wrap; /* Allow text/icons to wrap */
        }
        .footer-text {
           order: 1; /* Keep text first logically */
           text-align: center; /* Center text if it wraps */
        }
        .social-icons {
            display: flex;
            gap: 18px; /* Slightly more gap between icons */
            order: 2; /* Icons come after text */
        }
        .social-icons a { color: #374151; transition: color 0.3s; }
        .social-icons a:hover { color: #1f2937; }
        .social-icons svg { width: 22px; height: 22px; fill: currentColor; }

        /* Media Queries */
        @media (max-width: 700px) {
            body { font-size: 15px; }
            .header { font-size: 1.3rem; padding: 15px 0; }
            .user-bar { padding: 8px 15px; font-size: 0.9rem; flex-direction: column; gap: 8px; text-align: center; }
            #overallProgressContainer { height: 16px; }
            #overallProgressText { font-size: 10px; }
            .container { padding: 25px 15px; width: 95%; margin: 20px auto 30px auto; }
            h2 { font-size: 1.5rem; }
            .assessment-intro { font-size: 1rem; }
            .question-block { padding: 20px; }
            .question-text { font-size: 1rem; }
            .radio-options label { padding: 10px 15px; padding-left: 35px; font-size: 0.95rem; }
            textarea.input-field { font-size: 0.95rem; }
            .save-warning { font-size: 0.8rem; margin-top: 12px; }
            .save-answer-button { padding: 8px 16px; font-size: 0.9rem; }
            .save-confirmation { font-size: 0.85rem; margin-left: 10px;}
            #submitAssessmentButton { padding: 12px 20px; font-size: 1rem; margin-top: 30px; }
            #successMessageArea { font-size: 1rem; padding: 15px; }
            .footer { padding: 15px; font-size: 0.8rem; }
            .footer-content { gap: 15px; flex-direction: column; /* Stack text and icons */ }
            .footer-text { order: 2; /* Icons first on mobile */ }
            .social-icons { order: 1; }
            .social-icons svg { width: 20px; height: 20px; }
        }
         @media (max-width: 480px) {
             .user-bar { text-align: center; }
             .user-details { text-align: center; }
             .logout-button { margin: 5px auto 0 auto; } /* Center logout button */
         }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">Coaching & Leadership Course</header>

    <!-- User Bar -->
    <div class="user-bar">
        <div class="user-info">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            <div class="user-details">
                <span class="user-name" id="userName">Loading...</span>
                <span class="user-email" id="userEmail"></span>
            </div>
        </div>
        <button class="logout-button" onclick="logout()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
            Logout
        </button>
    </div>

    <!-- Overall Progress Bar (Sticky) -->
    <div id="overallProgressContainer">
         <div id="overallProgressBar">
             <span id="overallProgressText">0% Complete</span>
         </div>
     </div>

    <!-- Main Content -->
    <main class="container" id="mainContainer" style="display: none;">
        <h2>Pre-Assessment: Coaching & Leadership Mindset</h2>
        <p class="assessment-intro">
            Welcome! This assessment helps understand your initial perspectives on coaching and leadership. Please answer honestly. Saved answers cannot be changed.
        </p>

        <!-- Using a div container for questions - UPDATED -->
        <div id="assessmentForm">

            <!-- Question 1: Definition of Coaching (Theory) -->
            <div class="question-block" id="q1-block" data-total-questions="6"> <!-- UPDATED total questions -->
                 <label for="q1_coaching_def" class="question-text">1. In your own words, what does "coaching" mean to you in a professional context? (Min. 20 chars)</label>
                 <textarea id="q1_coaching_def" name="q1_coaching_def" class="input-field" placeholder="Describe your understanding of coaching..." rows="4"
                           data-question-id="clp_q1" data-score-value="10" data-question-text="Definition of Coaching" minlength="20"></textarea> <!-- ADDED minlength -->
                 <p class="save-warning"><small>‚ö†Ô∏è Please review your answer carefully before saving. Minimum 20 characters required. It cannot be changed afterwards.</small></p>
                 <button class="save-answer-button" data-question-block-id="q1-block" type="button">Save Answer</button>
                 <div class="save-confirmation" id="q1-confirm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Saved
                </div>
            </div>

            <!-- Question 2: Handling Challenges (Choice) -->
            <div class="question-block" id="q2-block">
                <span class="question-text">2. When a team member struggles with a task, your first instinct is usually to:</span>
                <div class="radio-options" data-question-id="clp_q2" data-score-value="10" data-question-text="Instinct for Team Struggle">
                    <input type="radio" id="q2_opt1" name="q2_struggle" value="Provide the solution or do it for them to ensure it's done correctly.">
                    <label for="q2_opt1">Provide the solution or do it for them to ensure it's done correctly.</label>
                    <input type="radio" id="q2_opt2" name="q2_struggle" value="Ask questions to understand their challenge and guide them to find their own solution.">
                    <label for="q2_opt2">Ask questions to understand their challenge and guide them to find their own solution.</label>
                    <input type="radio" id="q2_opt3" name="q2_struggle" value="Suggest resources or connect them with someone else who can help.">
                    <label for="q2_opt3">Suggest resources or connect them with someone else who can help.</label>
                    <input type="radio" id="q2_opt4" name="q2_struggle" value="Give them space to figure it out, assuming they will ask if they need help.">
                    <label for="q2_opt4">Give them space to figure it out, assuming they will ask if they need help.</label>
                </div>
                <p class="save-warning"><small>‚ö†Ô∏è Please review your answer carefully before saving. It cannot be changed afterwards.</small></p>
                <button class="save-answer-button" data-question-block-id="q2-block" type="button">Save Answer</button>
                <div class="save-confirmation" id="q2-confirm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Saved
                </div>
            </div>

            <!-- Question 3: Leadership Skill Focus (Theory) -->
            <div class="question-block" id="q3-block">
                 <label for="q3_skill_focus" class="question-text">3. What specific leadership or coaching skill do you most want to develop during this course, and why is it important to you? (Min. 20 chars)</label>
                 <textarea id="q3_skill_focus" name="q3_skill_focus" class="input-field" placeholder="Describe the skill and your reason..." rows="4"
                           data-question-id="clp_q3" data-score-value="10" data-question-text="Desired Skill Development" minlength="20"></textarea> <!-- ADDED minlength -->
                 <p class="save-warning"><small>‚ö†Ô∏è Please review your answer carefully before saving. Minimum 20 characters required. It cannot be changed afterwards.</small></p>
                 <button class="save-answer-button" data-question-block-id="q3-block" type="button">Save Answer</button>
                 <div class="save-confirmation" id="q3-confirm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Saved
                </div>
            </div>

             <!-- Question 4: View on Failure (Choice) -->
            <div class="question-block" id="q4-block">
                <span class="question-text">4. How do you primarily view mistakes or failures within a team?</span>
                <div class="radio-options" data-question-id="clp_q4" data-score-value="10" data-question-text="View on Failure">
                    <input type="radio" id="q4_opt1" name="q4_failure" value="As valuable learning opportunities for growth and improvement.">
                    <label for="q4_opt1">As valuable learning opportunities for growth and improvement.</label>
                    <input type="radio" id="q4_opt2" name="q4_failure" value="As problems to be fixed quickly to minimize negative impact.">
                    <label for="q4_opt2">As problems to be fixed quickly to minimize negative impact.</label>
                    <input type="radio" id="q4_opt3" name="q4_failure" value="As something to be avoided, indicating a lack of competence or planning.">
                    <label for="q4_opt3">As something to be avoided, indicating a lack of competence or planning.</label>
                    <input type="radio" id="q4_opt4" name="q4_failure" value="Depends entirely on the context and severity of the mistake.">
                    <label for="q4_opt4">Depends entirely on the context and severity of the mistake.</label>
                </div>
                 <p class="save-warning"><small>‚ö†Ô∏è Please review your answer carefully before saving. It cannot be changed afterwards.</small></p>
                 <button class="save-answer-button" data-question-block-id="q4-block" type="button">Save Answer</button>
                 <div class="save-confirmation" id="q4-confirm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Saved
                </div>
            </div>

             <!-- Question 5: Past Influence Attempt (Theory) -->
             <div class="question-block" id="q5-block">
                 <label for="q5_influence_exp" class="question-text">5. Describe a time you tried to influence or guide someone (at work or elsewhere). What was your approach, and what was the outcome? (Min. 20 chars)</label>
                 <textarea id="q5_influence_exp" name="q5_influence_exp" class="input-field" placeholder="Share your experience..." rows="4"
                           data-question-id="clp_q5" data-score-value="10" data-question-text="Past Influence Experience" minlength="20"></textarea> <!-- ADDED minlength -->
                 <p class="save-warning"><small>‚ö†Ô∏è Please review your answer carefully before saving. Minimum 20 characters required. It cannot be changed afterwards.</small></p>
                 <button class="save-answer-button" data-question-block-id="q5-block" type="button">Save Answer</button>
                 <div class="save-confirmation" id="q5-confirm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Saved
                </div>
             </div>

             <!-- Question 6: Motivation Source (Choice) -->
             <div class="question-block" id="q6-block">
                 <span class="question-text">6. What do you believe is generally the strongest long-term motivator for most people at work?</span>
                 <div class="radio-options" data-question-id="clp_q6" data-score-value="10" data-question-text="Strongest Motivator Belief">
                    <input type="radio" id="q6_opt1" name="q6_motivation" value="Financial rewards and compensation.">
                    <label for="q6_opt1">Financial rewards and compensation.</label>
                    <input type="radio" id="q6_opt2" name="q6_motivation" value="Recognition, appreciation, and praise.">
                    <label for="q6_opt2">Recognition, appreciation, and praise.</label>
                    <input type="radio" id="q6_opt3" name="q6_motivation" value="A sense of purpose, autonomy, and mastery in their work.">
                    <label for="q6_opt3">A sense of purpose, autonomy, and mastery in their work.</label>
                    <input type="radio" id="q6_opt4" name="q6_motivation" value="Opportunities for career advancement and promotion.">
                    <label for="q6_opt4">Opportunities for career advancement and promotion.</label>
                 </div>
                 <p class="save-warning"><small>‚ö†Ô∏è Please review your answer carefully before saving. It cannot be changed afterwards.</small></p>
                 <button class="save-answer-button" data-question-block-id="q6-block" type="button">Save Answer</button>
                 <div class="save-confirmation" id="q6-confirm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Saved
                </div>
             </div>

            <!-- Form Error Message Area (General) -->
            <div id="formErrorMessage" role="alert"></div>

            <!-- Final Submit Button (Enabled only when all are saved) -->
            <button type="button" id="submitAssessmentButton" disabled>Complete Assessment</button>

        </div> <!-- End assessmentForm container -->

        <!-- Success Message Area (Shown after final submit) -->
        <div id="successMessageArea" role="alert">
            üéâ Assessment Complete! Thank you for sharing your initial thoughts.
            <p class="redirect-message">Redirecting you to the course dashboard shortly...</p>
        </div>

    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content"> <!-- Added wrapper -->
            <span class="footer-text">¬© 2025 Elmenisy Leadership Coaching - All Rights Reserved</span>
            <div class="social-icons">
               <a href="https://www.linkedin.com/in/mohamedmenisy17/" target="_blank" rel="noopener noreferrer" aria-label="LinkedIn Profile"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg> </a>
               <a href="https://wa.me/201014527321" target="_blank" rel="noopener noreferrer" aria-label="WhatsApp Chat"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01s-.521.074-.792.372c-.272.296-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg> </a>
               <a href="https://www.instagram.com/mohamed_menisyy/profilecard/?igsh=d3ZwZDM4czRqMzB2" target="_blank" rel="noopener noreferrer" aria-label="Instagram Profile"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 1.172.053 1.905.33 2.46.538.7.268 1.192.64 1.64 1.092.45.447.83 1.004 1.093 1.64.208.555.485 1.288.538 2.46.058 1.265.07 1.646.07 4.85s-.012 3.584-.07 4.85c-.053 1.172-.33 1.905-.538 2.46-.268.7-.64 1.192-1.092 1.64-.447.45-.997.827-1.64 1.093-.555.208-1.288.485-2.46.538-1.265.058-1.646.07-4.85.07s-3.584-.012-4.85-.07c-1.172-.053-1.905-.33-2.46-.538-.697-.268-1.19-.64-1.64-1.093-.45-.447-.827-.997-1.093-1.64-.208-.555-.485-1.288-.538-2.46-.058-1.265-.07-1.646-.07-4.85s.012-3.584.07-4.85c.053-1.172.33-1.905.538-2.46.268-.697.64-1.19 1.093-1.64.45-.45.997.827 1.64-1.093.555-.208 1.288.485 2.46.538 1.265-.058 1.646-.07 4.85-.07zm0-2.163c-3.259 0-3.667.014-4.947.072-1.356.06-2.31.344-3.174.732-.884.396-1.627.96-2.377 1.71-.755.752-1.318 1.494-1.716 2.378-.386.863-.67 1.818-.73 3.172C.014 8.333 0 8.741 0 12s.014 3.667.072 4.947c.06 1.356.344 2.31.73 3.174.396.884.96 1.627 1.716 2.377.752.755 1.494 1.318 2.378 1.716.863.386 1.818.67 3.172.73 1.28.058 1.688.072 4.947.072s3.667-.014 4.947-.072c1.356-.06 2.31-.344 3.174-.73.884-.396 1.627-.96 2.377-1.716.755-.752 1.318-1.494 1.716-2.378.386.863.67-1.818.73-3.172.058-1.28.072-1.688.072-4.947s-.014-3.667-.072-4.947c-.06-1.356-.344-2.31-.73-3.174-.396-.884-.96-1.627-1.716-2.377-.752-.755-1.494-1.318-2.378-1.716-.863-.386-1.818-.67-3.172-.73C15.667.014 15.259 0 12 0zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.162 6.162 6.162 6.162-2.759 6.162-6.162S15.403 5.838 12 5.838zm0 10.333c-2.306 0-4.171-1.865-4.171-4.171s1.865-4.171 4.171-4.171 4.171 1.865 4.171 4.171-1.865 4.171-4.171 4.171zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg> </a>
            </div>
        </div>
    </footer>

    <script>
        // --- Supabase Configuration & Constants ---
        const SUPABASE_URL = 'https://lgcutmuspcaralydycmg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnY3V0bXVzcGNhcmFseWR5Y21nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0NDY3MDEsImV4cCI6MjA2MTAyMjcwMX0.3u5Y7pkH2NNnnoGLMWVfAa5b8fq88o1itRYnG1K38tE';
        let supabase = null;
        const LOGGED_IN_KEY = 'isUserLoggedIn';
        const CURRENT_USER_KEY = 'currentUser';
        const SIGNUP_FLAG_KEY = 'hasSignedUpBefore';
        const ASSESSMENT_SECTION_ID = 'pre-assessment-clp'; // Changed ID slightly for clarity
        const ASSESSMENT_SECTION_TITLE = 'Pre-Assessment: Coaching & Leadership Mindset'; // Updated title
        const ASSESSMENT_SECTION_TYPE = 'pre-assessment-clp'; // Changed type slightly
        const ASSESSMENT_PAGE_NAME = 'AssessmentCLP.html'; // Consider renaming file if needed
        const COMPLETION_STATUS = 'completed';
        const REDIRECT_URL = 'dashboard.html';
        const REDIRECT_DELAY_MS = 2500;
        const MIN_TEXT_LENGTH = 20; // Constant for minimum length

        // Initialize Supabase Client
        try { if (window.supabase && window.supabase.createClient) { supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); console.log("Supabase client initialized."); } else { throw new Error("Supabase library not found."); } } catch (error) { console.error("CRITICAL Supabase init error:", error); }

        // ***** ---> IMMEDIATE REDIRECTION LOGIC <--- ***** (Keep identical)
        console.log("%cAssessment Page: Running IMMEDIATE redirection check...", "color: purple; font-weight: bold;"); function quickCheckCurrentUser() { const data = localStorage.getItem(CURRENT_USER_KEY); return data && data.startsWith('{') && data.endsWith('}'); } const isLoggedIn_immediate = localStorage.getItem(LOGGED_IN_KEY) === 'true' && quickCheckCurrentUser(); const hasSignedUp_immediate = localStorage.getItem(SIGNUP_FLAG_KEY) === 'true'; const currentPage_immediate = window.location.pathname.split('/').pop() || 'index.html'; /* Use actual page name */ const assessmentPageActualName = 'AssessmentCLP.html'; console.log(`Assessment Page IMMEDIATE Check: isLoggedIn=${isLoggedIn_immediate}, hasSignedUp=${hasSignedUp_immediate}, currentPage=${currentPage_immediate}`); if (!isLoggedIn_immediate && currentPage_immediate.toLowerCase() === assessmentPageActualName.toLowerCase()) { const targetUrl = hasSignedUp_immediate ? 'login.html' : 'signup.html'; console.error(`%cAssessment Page IMMEDIATE Redirect: Not logged in. Redirecting to ${targetUrl}...`, "color: orange;"); window.location.replace(targetUrl); throw new Error("Redirecting user based on initial check."); } else if (isLoggedIn_immediate) { console.log("%cAssessment Page IMMEDIATE Check: User IS logged in. Proceeding.", "color: green;"); }


        // --- DOM Element References ---
        let userNameDisplay, userEmailDisplay, mainContainer, assessmentFormDiv, submitAssessmentButton, overallProgressContainer, overallProgressBar, overallProgressText, formErrorMessage, successMessageArea;
        let questionBlocks = [];
        let totalQuestions = 0;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async function() { // Made async for await loadSavedAnswers
            console.log("Assessment page: DOMContentLoaded event fired.");
            mainContainer = document.getElementById('mainContainer');
            try {
                userNameDisplay = document.getElementById('userName');
                userEmailDisplay = document.getElementById('userEmail');
                assessmentFormDiv = document.getElementById('assessmentForm');
                submitAssessmentButton = document.getElementById('submitAssessmentButton');
                overallProgressContainer = document.getElementById('overallProgressContainer');
                overallProgressBar = document.getElementById('overallProgressBar');
                overallProgressText = document.getElementById('overallProgressText');
                formErrorMessage = document.getElementById('formErrorMessage');
                successMessageArea = document.getElementById('successMessageArea');
                questionBlocks = Array.from(assessmentFormDiv.querySelectorAll('.question-block'));

                const firstBlockWithData = questionBlocks.find(block => block.dataset.totalQuestions);
                totalQuestions = firstBlockWithData ? parseInt(firstBlockWithData.dataset.totalQuestions, 10) : questionBlocks.length;

                if (!mainContainer || !userNameDisplay || !userEmailDisplay || !assessmentFormDiv || !submitAssessmentButton || !overallProgressContainer || !overallProgressBar || !overallProgressText || !formErrorMessage || !successMessageArea || questionBlocks.length === 0 || totalQuestions !== 6) { // Check for 6 questions
                     throw new Error(`Essential DOM elements missing or totalQuestions is not 6 (${totalQuestions})!`);
                }
                 if (!supabase) {
                     console.warn("Supabase client not available.");
                     assessmentFormDiv.querySelectorAll('.save-answer-button').forEach(btn => btn.disabled = true);
                     submitAssessmentButton.disabled = true;
                     showError("Cannot connect to database. Saving is disabled.");
                 }

                const currentUser = getCurrentUser();
                if (!currentUser || !currentUser.id) {
                    console.error("Failsafe: User data/ID missing on Assessment page!");
                    const failsafeTarget = localStorage.getItem(SIGNUP_FLAG_KEY) === 'true' ? 'login.html' : 'signup.html';
                    window.location.replace(failsafeTarget); return;
                }

                console.log(`User verified (${currentUser.email}, ID: ${currentUser.id}). Initializing assessment page with ${totalQuestions} questions.`);
                await initializePageContent(currentUser); // Wait for initialization including loading answers
                if (mainContainer) mainContainer.style.display = 'block';
                console.log("Assessment page content initialized and displayed.");

            } catch (error) { console.error("CRITICAL ERROR during DOMContentLoaded:", error); if (mainContainer) { mainContainer.innerHTML = `<p style="color: red; font-weight: bold; text-align: center; padding: 30px;">Error loading assessment. Please refresh. Error: ${error.message}</p>`; mainContainer.style.display = 'block'; } else { document.body.innerHTML = `<p style="color: red; padding: 20px;">Critical Error: (${error.message})</p>`; } }
        });

        // MODIFIED to be async and load saved answers
        async function initializePageContent(currentUser) {
            console.log("Running initializePageContent() for Assessment...");
            displayUserInfo(currentUser);
            // Load saved answers BEFORE setting up listeners or initial progress
            await loadSavedAnswers(currentUser.id);
            addEventListeners(); // Add listeners after potential locking from loadSavedAnswers
            updateOverallProgress(); // Update progress based on loaded state
            checkCompletionAndEnableSubmit(); // Check completion based on loaded state
            console.log("initializePageContent() for Assessment finished.");
        }

        // --- Core User Functions --- (Keep Identical)
        function getCurrentUser() { try { const d = localStorage.getItem(CURRENT_USER_KEY); if (!d) return null; const u = JSON.parse(d); if (u && typeof u === 'object' && u.email && u.id) { if (!u.name) u.name = u.email.split('@')[0]; return u; } else { console.warn("Stored user data invalid/missing ID."); localStorage.removeItem(CURRENT_USER_KEY); localStorage.removeItem(LOGGED_IN_KEY); return null; } } catch (e) { console.error("Error parsing user data:", e); localStorage.removeItem(CURRENT_USER_KEY); localStorage.removeItem(LOGGED_IN_KEY); return null; } }
        function displayUserInfo(currentUser) { try { let uN = 'Guest'; let uE = ''; if (currentUser) { uN = currentUser.name || currentUser.email.split('@')[0]; uE = currentUser.email || ''; } if (userNameDisplay) userNameDisplay.textContent = `Welcome, ${uN}`; if (userEmailDisplay) userEmailDisplay.textContent = uE; } catch (err) { console.error("Error in displayUserInfo:", err); } }
        function logout() { try { localStorage.removeItem(LOGGED_IN_KEY); localStorage.removeItem(CURRENT_USER_KEY); localStorage.removeItem(SIGNUP_FLAG_KEY); console.log("User logged out."); window.location.href = 'login.html'; } catch (e) { console.error("Logout error:", e); window.location.href = 'login.html'; } }

        // --- Event Listeners ---
        function addEventListeners() {
            try {
                 assessmentFormDiv.querySelectorAll('.save-answer-button').forEach(button => {
                    // Add listener only if the button is not already disabled (by loadSavedAnswers)
                    if (!button.disabled) {
                       button.addEventListener('click', handleSaveAnswer);
                    }
                 });
                 if (submitAssessmentButton) {
                     submitAssessmentButton.addEventListener('click', handleFinalSubmit);
                 }
            } catch (err) { console.error("Error adding assessment event listeners:", err); }
        }

        // --- NEW Function: Load Saved Answers ---
        async function loadSavedAnswers(userId) {
            if (!supabase || !userId) {
                console.warn("Cannot load saved answers: Supabase client or User ID missing.");
                return;
            }
            console.log(`Attempting to load saved answers for user ${userId} and section ${ASSESSMENT_SECTION_ID}...`);
            try {
                const { data: savedAnswers, error } = await supabase
                    .from('assessments')
                    .select('question_id, answer')
                    .eq('user_id', userId)
                    .eq('section_id', ASSESSMENT_SECTION_ID); // Filter by specific assessment

                if (error) {
                    console.error("Error fetching saved answers:", error);
                    showError(`Could not load previous answers: ${error.message}`);
                    return;
                }

                if (savedAnswers && savedAnswers.length > 0) {
                    console.log(`Found ${savedAnswers.length} saved answers.`);
                    savedAnswers.forEach(saved => {
                        const questionBlock = document.querySelector(`.question-block [data-question-id="${saved.question_id}"]`)?.closest('.question-block');
                        if (questionBlock) {
                            const inputElement = questionBlock.querySelector('textarea.input-field, .radio-options');
                            const saveButton = questionBlock.querySelector('.save-answer-button');
                            const confirmationDiv = questionBlock.querySelector('.save-confirmation');

                            if (inputElement && saveButton && confirmationDiv) {
                                console.log(`Loading answer for ${saved.question_id}`);
                                if (inputElement.tagName === 'TEXTAREA') {
                                    inputElement.value = saved.answer;
                                } else if (inputElement.classList.contains('radio-options')) {
                                    const radioToCheck = inputElement.querySelector(`input[type="radio"][value="${CSS.escape(saved.answer)}"]`);
                                    if (radioToCheck) {
                                        radioToCheck.checked = true;
                                    } else {
                                        console.warn(`Could not find radio option with value "${saved.answer}" for question ${saved.question_id}`);
                                    }
                                }
                                // Lock everything for this question
                                lockQuestionInput(inputElement, true);
                                setSaveButtonLoading(saveButton, false, 'Saved'); // Set state to saved
                                saveButton.disabled = true; // Ensure it's disabled
                                confirmationDiv.classList.add('visible');
                                questionBlock.classList.add('locked'); // Ensure block style is applied
                            } else {
                                console.warn(`Could not find all elements for question ${saved.question_id} to load saved state.`);
                            }
                        } else {
                             console.warn(`Could not find question block for saved answer ID: ${saved.question_id}`);
                        }
                    });
                    console.log("Finished applying saved answers.");
                } else {
                    console.log("No saved answers found for this assessment.");
                }

            } catch (err) {
                console.error("Unexpected error loading saved answers:", err);
                showError(`Error processing saved answers: ${err.message}`);
            }
        }


        // --- Per-Question Save Handler --- [ADDED Min Length Check]
        async function handleSaveAnswer(event) {
            const saveButton = event.target;
            const blockId = saveButton.dataset.questionBlockId;
            const questionBlock = document.getElementById(blockId);
            const confirmationDiv = questionBlock.querySelector('.save-confirmation');

            if (!questionBlock || saveButton.disabled || questionBlock.classList.contains('locked')) return;
            if (!supabase) { showError("Database connection is unavailable.", questionBlock); return; }

            hideError();
            questionBlock.classList.remove('invalid-block');

            const questionInput = questionBlock.querySelector('textarea.input-field, .radio-options');
            if (!questionInput) { showError("Error finding input.", questionBlock); return; }

            let answerValue = null;
            let isAnswered = false;
            let isTextArea = questionInput.tagName === 'TEXTAREA';

            if (isTextArea) {
                answerValue = questionInput.value.trim();
                isAnswered = answerValue !== '';
            } else if (questionInput.classList.contains('radio-options')) {
                const checkedRadio = questionInput.querySelector('input[type="radio"]:checked');
                answerValue = checkedRadio ? checkedRadio.value : null;
                isAnswered = checkedRadio !== null;
            }

            if (!isAnswered) {
                showError("Please provide an answer before saving.", questionBlock);
                questionBlock.classList.add('invalid-block');
                if (questionInput.tagName !== 'DIV') questionInput.focus(); // Focus input/textarea
                return;
            }

            // *** NEW: Minimum Length Check for Textarea ***
            if (isTextArea && answerValue.length < MIN_TEXT_LENGTH) {
                showError(`Please provide a more detailed answer (minimum ${MIN_TEXT_LENGTH} characters).`, questionBlock);
                questionBlock.classList.add('invalid-block');
                questionInput.focus();
                return;
            }
            // *** END: Minimum Length Check ***

            setSaveButtonLoading(saveButton, true, 'Saving...');
            if (confirmationDiv) confirmationDiv.classList.remove('visible');

            const currentUser = getCurrentUser();
            if (!currentUser || !currentUser.id || !currentUser.email) {
                showError("User data lost. Please log in again.", questionBlock);
                setSaveButtonLoading(saveButton, false, 'Retry Save');
                return;
            }

            // Payloads match the schema checked previously
            const submissionTime = new Date();
            const questionId = questionInput.dataset.questionId;
            const questionText = questionInput.dataset.questionText || questionBlock.querySelector('.question-text')?.textContent.trim() || 'N/A';
            const scoreValue = parseInt(questionInput.dataset.scoreValue || '0', 10);
            const isPassed = scoreValue > 0;
            const progressPercentage = 100;

            const assessmentPayload = { /* ... same as before, matching assessments schema ... */
                 user_id: currentUser.id, user_email: currentUser.email, name: currentUser.name || currentUser.email.split('@')[0], question_id: questionId, question_text: questionText, answer: answerValue, goal_answer: null, type: ASSESSMENT_SECTION_TYPE, submitted_at: submissionTime, is_correct: null, score: scoreValue, completion_status: COMPLETION_STATUS, page: ASSESSMENT_PAGE_NAME, section_id: ASSESSMENT_SECTION_ID
            };
            const progressPayload = { /* ... same as before, matching user_progress schema (with 'email') ... */
                 user_id: currentUser.id, email: currentUser.email, progress_percentage: progressPercentage, section_type: ASSESSMENT_SECTION_TYPE, section_id: ASSESSMENT_SECTION_ID, section_title: ASSESSMENT_SECTION_TITLE, question_id: questionId, question_text: questionText, page: ASSESSMENT_PAGE_NAME, score: scoreValue, status: COMPLETION_STATUS, submitted_at: submissionTime, updated_at: submissionTime, is_passed: isPassed
            };

            let dbSuccess = false;
            let detailedError = null;

            try {
                console.log(`[${questionId}] Attempting Supabase upsert...`);
                // console.log(`[${questionId}] Assessment Payload:`, JSON.stringify(assessmentPayload)); // Keep for debugging if needed
                // console.log(`[${questionId}] Progress Payload:`, JSON.stringify(progressPayload)); // Keep for debugging if needed

                const results = await Promise.allSettled([
                    sendAssessmentData(assessmentPayload),
                    updateUserProgressData(progressPayload)
                ]);

                console.log(`[${questionId}] Promise results:`, results);

                const assessmentResult = results[0];
                const progressResult = results[1];
                const assessmentSucceeded = assessmentResult.status === 'fulfilled' && assessmentResult.value.success;
                const progressSucceeded = progressResult.status === 'fulfilled' && progressResult.value.success;

                if (assessmentSucceeded && progressSucceeded) {
                    dbSuccess = true;
                    console.log(`[${questionId}] Both upserts SUCCEEDED.`);
                } else {
                    const assessmentReason = assessmentSucceeded ? "Success" : (assessmentResult.value?.error ? `DB Error: ${assessmentResult.value.error.message}` : "Unknown Failure");
                    const progressReason = progressSucceeded ? "Success" : (progressResult.value?.error ? `DB Error: ${progressResult.value.error.message}` : "Unknown Failure");
                    detailedError = `Assessment: ${assessmentReason}. Progress: ${progressReason}`;
                    console.error(`[${questionId}] DB Save FAILED. Details: ${detailedError}`);
                }

                if (dbSuccess) {
                    setSaveButtonLoading(saveButton, false, 'Saved');
                    saveButton.disabled = true;
                    lockQuestionInput(inputElement, true);
                    questionBlock.classList.add('locked');
                    if (confirmationDiv) confirmationDiv.classList.add('visible');
                    updateOverallProgress();
                    checkCompletionAndEnableSubmit();
                } else {
                     showError(`Submission failed: ${detailedError || 'Please check console and try again.'}`, questionBlock);
                     setSaveButtonLoading(saveButton, false, 'Retry Save');
                     lockQuestionInput(inputElement, false);
                     questionBlock.classList.remove('locked');
                     if (confirmationDiv) confirmationDiv.classList.remove('visible');
                }

            } catch (err) {
                 console.error(`[${questionId}] UNEXPECTED JS error during save operation:`, err);
                 showError(`Error saving: ${err.message}. Please try again.`, questionBlock);
                 setSaveButtonLoading(saveButton, false, 'Retry Save');
                 lockQuestionInput(inputElement, false);
                 questionBlock.classList.remove('locked');
                 if (confirmationDiv) confirmationDiv.classList.remove('visible');
            }
        }


        // --- Update Overall Progress ---
        function updateOverallProgress() {
            if (!overallProgressBar || !overallProgressText || !totalQuestions || totalQuestions <= 0) return;
             const savedCount = assessmentFormDiv.querySelectorAll('.question-block.locked').length;
             const percentage = Math.round((savedCount / totalQuestions) * 100);
             overallProgressBar.style.width = `${percentage}%`;
             overallProgressText.textContent = `${percentage}% Complete`;
             console.log(`Progress updated: ${savedCount}/${totalQuestions} = ${percentage}%`);
             overallProgressContainer.classList.toggle('active', percentage > 0);
        }

         // --- Check if all questions are saved and enable final submit ---
         function checkCompletionAndEnableSubmit() {
             if (!submitAssessmentButton || !totalQuestions || totalQuestions <= 0) return;
             const savedCount = assessmentFormDiv.querySelectorAll('.question-block.locked').length;
             const isComplete = savedCount === totalQuestions;
             submitAssessmentButton.disabled = !isComplete;
             console.log(`${savedCount}/${totalQuestions} saved. Final submit ${isComplete ? 'enabled' : 'disabled'}.`);
         }

        // --- Final Submit Handler ---
        function handleFinalSubmit(event) {
            event.preventDefault();
            console.log("Final 'Complete Assessment' button clicked.");
            if (assessmentFormDiv.querySelectorAll('.question-block.locked').length !== totalQuestions) {
                 showError("Please ensure all answers are saved before completing."); return;
            }
            assessmentFormDiv.style.opacity = '0.5';
            assessmentFormDiv.style.pointerEvents = 'none';
            submitAssessmentButton.disabled = true;
            submitAssessmentButton.textContent = 'Completed';
            if (successMessageArea) {
                 successMessageArea.classList.add('visible');
                 successMessageArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            setTimeout(() => { window.location.href = REDIRECT_URL; }, REDIRECT_DELAY_MS);
        }


        // --- Supabase Interaction Functions --- [No changes needed here, return {success, error}]
        async function sendAssessmentData(assessmentPayload) {
            const qId = assessmentPayload.question_id;
            if (!supabase) { console.error(`[${qId}] Supabase client not initialized (assessment).`); return { success: false, error: { message: "Supabase client not initialized" } }; }
            console.log(`[${qId}] Attempting UPSERT 'assessments' with onConflict: user_id, question_id...`);
            try {
                const { data, error } = await supabase.from('assessments').upsert(assessmentPayload, { onConflict: 'user_id, question_id' }).select();
                if (error) { console.error(`[${qId}] Supabase Upsert Error (assessments table):`, error); return { success: false, error: error }; }
                console.log(`[${qId}] Supabase Upsert Success (assessments).`); return { success: true, error: null };
            } catch (networkError) { console.error(`[${qId}] Network/Other Error during upsert (assessments):`, networkError); return { success: false, error: networkError }; }
        }
        async function updateUserProgressData(progressPayload) {
             const qId = progressPayload.question_id;
             if (!supabase) { console.error(`[${qId}] Supabase client not initialized (progress).`); return { success: false, error: { message: "Supabase client not initialized" } }; }
             console.log(`[${qId}] Attempting UPSERT 'user_progress' with onConflict: user_id, question_id...`);
             try {
                 const { data, error } = await supabase.from('user_progress').upsert(progressPayload, { onConflict: 'user_id, question_id' }).select();
                 if (error) { console.error(`[${qId}] Supabase Upsert Error (user_progress table):`, error); return { success: false, error: error }; }
                 console.log(`[${qId}] Supabase Upsert Success (user_progress).`); return { success: true, error: null };
             } catch (networkError) { console.error(`[${qId}] Network/Other Error during upsert (user_progress):`, networkError); return { success: false, error: networkError }; }
         }

        // --- UI Control Functions ---
        function setSaveButtonLoading(button, isLoading, text = 'Save Answer') {
            if (!button) return;
            button.disabled = isLoading; button.textContent = text;
             if (!isLoading && text === 'Retry Save') { button.disabled = false; }
             if (!isLoading && text === 'Saved') { button.disabled = true; }
        }
         function lockQuestionInput(inputElement, lock) {
             if (!inputElement) return;
             const block = inputElement.closest('.question-block');
             inputElement.classList.toggle('input-locked', lock);
             if (inputElement.tagName === 'TEXTAREA') {
                 inputElement.readOnly = lock; inputElement.disabled = lock; inputElement.style.cursor = lock ? 'not-allowed' : '';
             } else if (inputElement.classList.contains('radio-options')) {
                 inputElement.querySelectorAll('input[type="radio"]').forEach(radio => radio.disabled = lock);
                 inputElement.querySelectorAll('label').forEach(label => { label.style.cursor = lock ? 'not-allowed' : 'pointer'; label.classList.toggle('input-locked', lock); });
             }
             if (block) { block.classList.toggle('locked', lock); }
         }
        function showError(message, contextElement = null) {
            try {
                if (formErrorMessage) {
                     formErrorMessage.textContent = message; formErrorMessage.style.display = "block";
                    const elementToScroll = contextElement && contextElement.classList.contains('question-block') ? contextElement : formErrorMessage;
                    try { elementToScroll.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
                    catch(scrollError){ console.warn("scrollIntoView failed:", scrollError); window.scrollTo({ top: 0, behavior: 'smooth' }); }
                }
                 if(contextElement && contextElement.classList.contains('question-block')){ contextElement.classList.add('invalid-block'); }
                console.error("Displayed error to user:", message);
            } catch (err) { console.error("Error in showError function itself:", err); }
        }
        function hideError() {
             try {
                 if (formErrorMessage) formErrorMessage.style.display = "none";
                 assessmentFormDiv.querySelectorAll('.question-block.invalid-block').forEach(el => el.classList.remove('invalid-block'));
             } catch (err) { console.error("Error in hideError:", err); }
         }

    </script>
</body>
</html>
