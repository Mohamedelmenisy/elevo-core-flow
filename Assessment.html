<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Assessment - Coaching & Leadership</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">

    <!-- *** Supabase JS Library *** -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- Base Styles --- */
        :root { --primary-color: #3b82f6; --primary-darker: #2563eb; --secondary-color: #10b981; --secondary-darker: #059669; --text-dark: #1f2937; --text-medium: #4b5563; --text-light: #6b7280; --bg-light: #f9fafb; --bg-white: #ffffff; --border-color: #e5e7eb; --error-red: #ef4444; --success-green: #22c55e; --success-bg-light: #f0fdf4; --success-border: #bbf7d0; --warn-yellow: #f59e0b; --info-blue: #eff6ff; /* Added for intro */ --saved-bg: #e0e7ff; /* Light indigo for saved */ --saved-border: #c7d2fe; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f8fafc; margin: 0; padding: 0; line-height: 1.6; color: var(--text-medium); display: flex; flex-direction: column; min-height: 100vh; padding-top: 62px; /* Space for fixed header */ }
        main { flex-grow: 1; display: flex; justify-content: center; align-items: flex-start; flex-direction: column; width: 100%; max-width: 900px; margin: 20px auto; padding: 0 20px; }

        /* --- Consistent Components (User Bar, Footer, Modals) --- */
        .user-bar { background-color: #34495e; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; color: white; font-size: 14px; position: fixed; top: 0; left: 0; width: 100%; z-index: 1010; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .user-info { display: flex; align-items: center; gap: 12px; } .user-info svg { opacity: 0.8; vertical-align: middle; color: white; } .user-details-bar { display: flex; flex-direction: column; } .user-name-bar { font-weight: 600; font-size: 14px; color: white; } .user-email-bar { font-size: 12px; opacity: 0.8; color: white; } .logout-button { background-color: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 6px; font-size: 13px; } .logout-button:hover { background-color: #c0392b; transform: translateY(-1px); } .logout-button svg { color: white; }
        .footer { text-align: center; padding: 25px 30px; background: #f9fafb; color: #6b7280; margin-top: auto; font-size: 14px; width: 100%; border-top: 1px solid #e5e7eb; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.65); display: none; align-items: center; justify-content: center; z-index: 9999; cursor: pointer; padding: 20px; } .modal-content-box { background: white; border-radius: 12px; padding: 35px 40px; max-width: 450px; width: 95%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.25); cursor: default; border-top: 5px solid #e74c3c; } .modal-content-box h2 { color: #e74c3c; margin-bottom: 18px; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; gap: 8px; } .modal-content-box p { margin-bottom: 28px; color: #374151; font-size: 1.05rem; line-height: 1.6; } .modal-content-box button { background-color: #3498db; color: white; padding: 11px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 500; transition: background-color 0.3s ease; } .modal-content-box button:hover { background-color: #2980b9; }

        /* --- Assessment Specific Styles --- */
        .assessment-container { background: white; padding: 35px 45px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); border-radius: 12px; width: 100%; margin-bottom: 35px; text-align: left; opacity: 0; transition: opacity 0.7s ease-in-out; border: 1px solid var(--border-color); display: none; }
        .assessment-container.fade-in { opacity: 1; }
        .assessment-container h2 { color: var(--text-dark); margin-bottom: 25px; font-size: 26px; font-weight: 600; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; text-align: center; }
        .assessment-container h2 .title-emoji { display: inline-block; margin-right: 8px; font-size: 1.1em; }
        .assessment-intro { background-color: var(--info-blue); border-left: 5px solid var(--primary-color); padding: 18px 25px; margin-bottom: 30px; border-radius: 6px; font-size: 15px; color: var(--text-medium); line-height: 1.7; }
        .assessment-intro strong { color: var(--primary-darker); }
        #adminAssessmentNote { font-weight: bold; color: #b45309; display: none; }
        .focus-reminder { background-color: #fffbeb; border: 1px solid #fcd34d; color: #92400e; padding: 12px 18px; margin-bottom: 30px; border-radius: 6px; font-size: 14px; display: flex; align-items: center; gap: 8px; }

        /* Sticky Progress Bar */
        #assessmentProgressContainer { position: sticky; top: 62px; background-color: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px); padding: 12px 0; z-index: 1005; margin-left: -45px; margin-right: -45px; padding-left: 45px; padding-right: 45px; border-bottom: 1px solid var(--border-color); margin-bottom: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        #assessmentProgressLabel { font-size: 14px; color: var(--text-medium); margin-bottom: 8px; text-align: center; font-weight: 500; }
        #assessmentProgress { width: 100%; height: 12px; background-color: var(--border-color); border-radius: 6px; overflow: hidden; }
        #assessmentProgressBar { width: 0%; height: 100%; background: linear-gradient(90deg, var(--secondary-color), var(--secondary-darker)); border-radius: 6px; transition: width 0.5s ease-out; }

        /* Form Group & Input Styles */
        #finalAssessmentForm .form-group { margin-bottom: 30px; padding: 25px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg-white); transition: background-color 0.3s ease, border-color 0.3s ease; position: relative; }
        #finalAssessmentForm label, #finalAssessmentForm legend { display: block; margin-bottom: 12px; font-weight: 600; color: var(--text-dark); font-size: 17px; }
        #finalAssessmentForm fieldset { border: none; padding: 0; margin: 0 0 15px 0; transition: background-color 0.3s ease; }
        #finalAssessmentForm fieldset label { font-weight: normal; font-size: 15px; margin-bottom: 8px; display: flex; align-items: center; cursor: pointer; }
        #finalAssessmentForm input[type="radio"] { margin-right: 8px; width: auto; accent-color: var(--primary-color); cursor: pointer; }
        #finalAssessmentForm textarea, #finalAssessmentForm input[type="number"] { width: 100%; padding: 12px 14px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 15px; transition: border-color 0.3s, box-shadow 0.3s, background-color 0.3s; color: var(--text-dark); background-color: var(--bg-light); }
        #finalAssessmentForm textarea { min-height: 120px; resize: vertical; }
        #finalAssessmentForm textarea:focus, #finalAssessmentForm input[type="number"]:focus, #finalAssessmentForm input[type="radio"]:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); outline: none; background-color: var(--bg-white); }

        /* Visual Feedback Styles */
        #finalAssessmentForm .answer-saved-visual { background-color: var(--saved-bg); border-color: var(--saved-border); }
        #finalAssessmentForm .submitted textarea, #finalAssessmentForm .submitted input, #finalAssessmentForm .submitted fieldset { background-color: #f3f4f6 !important; cursor: not-allowed !important; border-color: var(--border-color) !important; }
        #finalAssessmentForm .submitted input[type="radio"]:disabled + span { color: var(--text-light); cursor: not-allowed; }
         #finalAssessmentForm .submitted label { cursor: not-allowed; }

        #finalAssessmentForm .input-meta-info { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
        #finalAssessmentForm .word-count-info { font-size: 13px; color: var(--text-light); }
        #finalAssessmentForm .paste-warning { font-size: 13px; color: var(--warn-yellow); display: none; }
        #finalAssessmentForm .error-message { color: var(--error-red); font-size: 14px; margin-top: 8px; display: none; font-weight: 500;}
        #finalAssessmentForm .invalid textarea, #finalAssessmentForm .invalid input, #finalAssessmentForm .invalid fieldset { border-color: var(--error-red) !important; background-color: #fee2e2 !important; }
        #finalAssessmentForm .invalid fieldset legend { color: var(--error-red); }

        /* Save Status Indicator (Replaces Buttons) */
         .question-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; gap: 1rem;}
         .question-text { flex-grow: 1; }
         .save-status { font-size: 0.85rem; font-weight: 500; color: var(--text-light); visibility: hidden; opacity: 0; transition: opacity 0.5s, color 0.3s; white-space: nowrap; text-align: right; flex-shrink: 0; /* Prevent shrinking */ }
         .save-status.show { visibility: visible; opacity: 1; }
         .save-status.saving { color: var(--text-medium); }
         .save-status.saved { color: var(--success-green); }
         .save-status.error { color: var(--error-red); }
         .save-status .spinner { display: inline-block; border: 2px solid rgba(0, 0, 0, 0.1); border-left-color: currentColor; border-radius: 50%; width: 10px; height: 10px; animation: spin 1s linear infinite; margin-right: 4px; vertical-align: middle; }
          @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Hide Save/Clear Buttons */
        .answer-actions { display: none !important; }
        #finalSubmitBtn { display: none !important; } /* Hide final submit button */

        /* Completion Message (Replaces Submit Button) */
        #completionMessage { text-align: center; margin-top: 2.5rem; display: none; /* Hidden initially */ padding: 1.5rem; background-color: var(--success-bg-light); border: 1px solid var(--success-border); border-radius: 0.5rem; }
        #completionMessage p { font-weight: 600; color: var(--secondary-darker); margin-bottom: 1rem; font-size: 1.1rem; }
        #completionMessage .results-link { display: inline-block; background-color: var(--primary-color); color: white; padding: 0.8rem 1.6rem; text-decoration: none; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.3s, transform 0.2s; font-size: 1rem; }
        #completionMessage .results-link:hover { background-color: var(--primary-darker); transform: translateY(-1px); }


        /* Completion Popup (No Changes) */
        #assessmentCompletePopup { display: none; position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background-color: white; padding: 35px 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); z-index: 1002; text-align: center; border-top: 6px solid #4f46e5; min-width: 320px; max-width: 450px; }
        #assessmentCompletePopup .completion-icon { font-size: 3rem; color: #10b981; margin-bottom: 15px; }
        #assessmentCompletePopup p { font-size: 17px; color: #374151; margin-bottom: 10px; line-height: 1.6; }
        #assessmentCompletePopup .completion-score { font-size: 15px; color: #6b7280; margin-bottom: 25px; font-weight: 500; }
        #assessmentCompletePopup button { background-color: #3b82f6; color: white; padding: 11px 22px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; }
        #assessmentCompletePopup button:hover { background-color: #2563eb; }
        .popup-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 1001; }

        /* Loading / Error Messages */
        #loadingOrAccessMessage { text-align: center; padding: 60px 20px; font-size: 20px; color: var(--text-light); width: 100%; }
        #supabaseErrorMessage { color: var(--error-red); background-color: #fef2f2; border: 1px solid #fecaca; padding: 10px 15px; border-radius: 6px; text-align: center; margin: 20px auto; font-size: 14px; display: none; max-width: 860px; }

        /* Responsive Adjustments */
         @media (max-width: 768px) { main { padding: 0 15px; margin: 15px auto; } .assessment-container { padding: 25px 30px; } .user-bar { padding: 10px 15px; } #assessmentProgressContainer { margin-left: -30px; margin-right: -30px; padding-left: 30px; padding-right: 30px; top: 57px; /* Adjust if user bar height changes */ } }
         @media (max-width: 600px) { .assessment-container { padding: 20px 15px; } .assessment-container h2 { font-size: 22px; } #finalAssessmentForm textarea { min-height: 100px; } #finalAssessmentForm label, #finalAssessmentForm legend { font-size: 16px; } #finalAssessmentForm input[type="number"], #finalAssessmentForm textarea { padding: 10px 12px; font-size: 14px; } /* Save/Clear buttons removed */ #assessmentCompletePopup { width: 90%; padding: 25px 20px; } .modal-content-box { padding: 25px 15px; } .modal-content-box h2 { font-size: 1.3rem; } .modal-content-box p { font-size: 0.95rem; } .modal-content-box button { padding: 10px 20px; font-size: 0.9rem;} .focus-reminder { font-size: 13px; padding: 10px 15px; } #assessmentProgressContainer { margin-left: -15px; margin-right: -15px; padding-left: 15px; padding-right: 15px; top: 57px; /* Adjust if needed */ } #completionMessage { padding: 1rem; } #completionMessage p { font-size: 1rem;} #completionMessage .results-link { font-size: 0.9rem; padding: 0.7rem 1.4rem; } }

    </style>
</head>
<body>
    <!-- User Bar -->
    <div class="user-bar">
        <div class="user-info">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            <div class="user-details-bar">
                <span class="user-name-bar" id="userNameBar">Loading...</span>
                <span class="user-email-bar" id="userEmailBar"></span>
            </div>
        </div>
        <button class="logout-button" onclick="logout()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
            Logout
        </button>
    </div>

    <!-- Access Denied Modal -->
    <div id="accessDeniedModal" class="modal-overlay" style="display: none;">
       <div class="modal-content-box" onclick="event.stopPropagation()">
          <h2>ðŸš« Access Denied</h2>
          <p>You need to complete all course modules before taking the final assessment.</p>
          <button onclick="goBackToNext()">Go Back</button>
      </div>
    </div>

    <!-- Main Content Area -->
    <main>
        <div id="loadingOrAccessMessage">Loading Assessment...</div>
        <div id="supabaseErrorMessage"></div> <!-- Div for Supabase errors -->

        <!-- Final Assessment Container -->
        <section id="assessmentContainer" class="assessment-container">
            <h2><span class="title-emoji">ðŸ¤”</span> Post-Course Reflection</h2>
            <p class="assessment-intro">
                <strong>Congratulations on completing the core modules!</strong> This final assessment helps you reflect on your learning and how you'll apply it. Please answer thoughtfully and honestly. Your answers are saved automatically.
                <span id="adminAssessmentNote"> (Admin: Word count and paste restrictions are disabled.)</span>
            </p>
             <div class="focus-reminder">
                 <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                 <span>Please focus on providing your genuine reflections. Each answer should be considered carefully.</span>
             </div>

            <!-- Overall Progress Indicator (Sticky) -->
             <div id="assessmentProgressContainer">
                 <div id="assessmentProgressLabel">Assessment Progress: 0%</div>
                 <div id="assessmentProgress">
                     <div id="assessmentProgressBar"></div>
                 </div>
             </div>

            <form id="finalAssessmentForm" novalidate>
                <!-- Question 1: Situational Disengaged -->
                <div class="form-group" data-group-id="q_situational_disengaged">
                     <div class="question-header">
                        <label for="q_situational_disengaged" class="question-text">Scenario: You notice a team member who seems consistently disengaged during coaching sessions. They give short answers and avoid eye contact.</label>
                        <span class="save-status" id="status_q_situational_disengaged"></span>
                     </div>
                    <textarea id="q_situational_disengaged" name="situational_disengaged" required data-min-words="30" data-question-id="q_situational_disengaged" placeholder="Outline your approach... (Min 30 words)"></textarea>
                    <div class="input-meta-info">
                         <div class="paste-warning" id="q_situational_disengaged_paste_warning">Pasting...</div>
                         <div class="word-count-info" id="q_situational_disengaged_word_count_container">Words: <span id="q_situational_disengaged_word_count">0</span><span>/30</span></div>
                    </div>
                    <p class="question-error-message" id="error_q_situational_disengaged"></p>
                     <!-- Buttons removed -->
                </div>

                 <!-- Question 2: Situational Feedback -->
                 <div class="form-group" data-group-id="q_situational_feedback">
                      <div class="question-header">
                        <label for="q_situational_feedback" class="question-text">Scenario: You need to provide constructive feedback to a high-performing team member about a minor but recurring communication issue.</label>
                        <span class="save-status" id="status_q_situational_feedback"></span>
                     </div>
                     <textarea id="q_situational_feedback" name="situational_feedback" required data-min-words="30" data-question-id="q_situational_feedback" placeholder="Describe your feedback process... (Min 30 words)"></textarea>
                     <div class="input-meta-info">
                        <div class="paste-warning" id="q_situational_feedback_paste_warning">Pasting...</div>
                        <div class="word-count-info" id="q_situational_feedback_word_count_container">Words: <span id="q_situational_feedback_word_count">0</span><span>/30</span></div>
                     </div>
                     <p class="question-error-message" id="error_q_situational_feedback"></p>
                      <!-- Buttons removed -->
                 </div>

                 <!-- Question 3: Reflection Skill -->
                 <div class="form-group" data-group-id="q_reflection_skill">
                      <div class="question-header">
                        <label for="q_reflection_skill" class="question-text">Whatâ€™s one specific coaching skill (e.g., active listening, powerful questioning, goal setting) you feel you've significantly improved through this course?</label>
                        <span class="save-status" id="status_q_reflection_skill"></span>
                     </div>
                     <textarea id="q_reflection_skill" name="reflection_skill_improved" required data-min-words="30" data-question-id="q_reflection_skill" placeholder="Identify the skill... (Min 30 words)"></textarea>
                     <div class="input-meta-info">
                        <div class="paste-warning" id="q_reflection_skill_paste_warning">Pasting...</div>
                        <div class="word-count-info" id="q_reflection_skill_word_count_container">Words: <span id="q_reflection_skill_word_count">0</span><span>/30</span></div>
                     </div>
                     <p class="question-error-message" id="error_q_reflection_skill"></p>
                      <!-- Buttons removed -->
                 </div>

                 <!-- Question 4: Reflection Challenge -->
                 <div class="form-group" data-group-id="q_reflection_challenge">
                      <div class="question-header">
                        <label for="q_reflection_challenge" class="question-text">Reflecting on the course material, what was the most challenging concept or technique for you to grasp or consider implementing?</label>
                         <span class="save-status" id="status_q_reflection_challenge"></span>
                     </div>
                     <textarea id="q_reflection_challenge" name="reflection_challenge" required data-min-words="30" data-question-id="q_reflection_challenge" placeholder="Discuss your biggest challenge... (Min 30 words)"></textarea>
                     <div class="input-meta-info">
                        <div class="paste-warning" id="q_reflection_challenge_paste_warning">Pasting...</div>
                        <div class="word-count-info" id="q_reflection_challenge_word_count_container">Words: <span id="q_reflection_challenge_word_count">0</span><span>/30</span></div>
                     </div>
                     <p class="question-error-message" id="error_q_reflection_challenge"></p>
                     <!-- Buttons removed -->
                 </div>

                 <!-- Question 5: Evaluation (Rating + Explanation) -->
                 <div class="form-group" data-group-id="q_eval_confidence_rating">
                      <div class="question-header">
                         <label for="q_eval_confidence_rating" class="question-text">On a scale of 1 (Not confident) to 5 (Very confident), how confident do you feel in applying the coaching principles learned in this course *after* completing it?</label>
                         <span class="save-status" id="status_q_eval_confidence_rating"></span>
                      </div>
                     <input type="number" id="q_eval_confidence_rating" name="evaluation_confidence_rating" required min="1" max="5" step="1" data-question-id="q_eval_confidence_rating" placeholder="Enter 1-5">
                     <p class="question-error-message" id="error_q_eval_confidence_rating"></p>

                      <div class="question-header" style="margin-top: 20px;">
                        <label for="q_eval_confidence_explanation" class="question-text" style="margin-top:0;">Briefly explain your rating.</label>
                        <span class="save-status" id="status_q_eval_confidence_explanation"></span>
                     </div>
                     <textarea id="q_eval_confidence_explanation" name="evaluation_confidence_explanation" required data-min-words="25" data-question-id="q_eval_confidence_explanation" placeholder="Explain your confidence level... (Min 25 words)"></textarea>
                     <div class="input-meta-info">
                        <div class="paste-warning" id="q_eval_confidence_explanation_paste_warning">Pasting...</div>
                        <div class="word-count-info" id="q_eval_confidence_explanation_word_count_container">Words: <span id="q_eval_confidence_explanation_word_count">0</span><span>/25</span></div>
                     </div>
                     <p class="question-error-message" id="error_q_eval_confidence_explanation"></p>
                      <!-- Buttons removed -->
                 </div>

                 <!-- Question 6: Multiple Choice (NEW) -->
                 <div class="form-group" data-group-id="q_mc_model_preference">
                     <div class="question-header">
                          <legend class="question-text">Which coaching model discussed (or similar structured approaches) do you foresee yourself using most often?</legend>
                          <span class="save-status" id="status_q_mc_model_preference"></span>
                     </div>
                      <fieldset data-question-id="q_mc_model_preference">
                         <!-- Labels and Inputs remain the same -->
                         <label><input type="radio" name="mc_model_preference" value="grow" required> The GROW Model...</label>
                         <label><input type="radio" name="mc_model_preference" value="skillwill"> The Skill/Will Matrix...</label>
                         <label><input type="radio" name="mc_model_preference" value="solution"> Solution-Focused Coaching...</label>
                         <label><input type="radio" name="mc_model_preference" value="positive"> The POSITIVE Model...</label>
                         <label><input type="radio" name="mc_model_preference" value="practice"> The PRACTICE Model...</label>
                         <label><input type="radio" name="mc_model_preference" value="mix"> A mix, depending on the situation</label>
                         <label><input type="radio" name="mc_model_preference" value="unsure"> Unsure yet</label>
                      </fieldset>
                      <p class="question-error-message" id="error_q_mc_model_preference"></p>
                       <!-- Buttons removed -->
                 </div>

                 <!-- Submit Button Removed -->
                 <p id="quizErrorMessage" class="error-message" aria-live="polite" style="text-align: center; background: none; border: none;"></p>
                 <!-- Display message or link when all are answered -->
                 <div id="completionMessage">
                     <p>All answers saved! You have completed the final reflection.</p>
                     <a href="feedback.html" class="results-link" id="nextStepsLink">Proceed to Final Feedback</a>
                 </div>

            </form>
        </section>

        <!-- Completion Popup (Potentially repurposed or removed) -->
        <div class="popup-overlay" id="completionPopupOverlay"></div>
        <div id="assessmentCompletePopup" style="display: none;">
             <div class="completion-icon">ðŸŽ‰</div>
             <p>Assessment Submitted!</p>
             <p class="completion-score" id="completionScoreText"></p>
             <button id="proceedToFeedbackBtn">Proceed to Feedback</button>
        </div>

    </main>

    <!-- Footer -->
    <footer class="footer">
        <!-- Footer content remains the same -->
        <span class="footer-text">Â© 2025 Elmenisy Leadership Coaching - All Rights Reserved</span>
         <div class="social-icons">
             <a href="https://www.linkedin.com/in/mohamedmenisy17/" target="_blank" rel="noopener noreferrer" aria-label="LinkedIn Profile"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg> </a>
             <a href="https://wa.me/201014527321" target="_blank" rel="noopener noreferrer" aria-label="WhatsApp Chat"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01s-.521.074-.792.372c-.272.296-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg> </a>
             <a href="https://www.instagram.com/mohamed_menisyy/profilecard/?igsh=d3ZwZDM4czRqMzB2" target="_blank" rel="noopener noreferrer" aria-label="Instagram Profile"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 1.172.053 1.905.33 2.46.538.7.268 1.192.64 1.64 1.092.45.447.83 1.004 1.093 1.64.208.555.485 1.288.538 2.46.058 1.265.07 1.646.07 4.85s-.012 3.584-.07 4.85c-.053 1.172-.33 1.905-.538 2.46-.268.7-.64 1.192-1.092 1.64-.447.45-.997.827-1.64 1.093-.555.208-1.288.485-2.46.538-1.265.058-1.646.07-4.85.07s-3.584-.012-4.85-.07c-1.172-.053-1.905-.33-2.46-.538-.697-.268-1.19-.64-1.64-1.093-.45-.447-.827-.997-1.093-1.64-.208-.555-.485-1.288-.538-2.46-.058-1.265-.07-1.646-.07-4.85s.012-3.584.07-4.85c.053-1.172.33-1.905.538-2.46.268-.697.64-1.19 1.093-1.64.45-.45.997-.827 1.64-1.093.555-.208 1.288.485 2.46.538 1.265-.058 1.646-.07 4.85-.07zm0-2.163c-3.259 0-3.667.014-4.947.072-1.356.06-2.31.344-3.174.732-.884.396-1.627.96-2.377 1.71-.755.752-1.318 1.494-1.716 2.378-.386.863-.67 1.818-.73 3.172C.014 8.333 0 8.741 0 12s.014 3.667.072 4.947c.06 1.356.344 2.31.73 3.174.396.884.96 1.627 1.716 2.377.752.755 1.494 1.318 2.378 1.716.863.386 1.818.67 3.172.73 1.28.058 1.688.072 4.947.072s3.667-.014 4.947-.072c1.356-.06 2.31-.344 3.174-.73.884-.396 1.627-.96 2.377-1.716.755-.752 1.318-1.494 1.716-2.378.386.863.67-1.818.73-3.172.058-1.28.072-1.688.072-4.947s-.014-3.667-.072-4.947c-.06-1.356-.344-2.31-.73-3.174-.396-.884-.96-1.627-1.716-2.377-.752-.755-1.494-1.318-2.378-1.716-.863-.386-1.818-.67-3.172-.73C15.667.014 15.259 0 12 0zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.162 6.162 6.162 6.162-2.759 6.162-6.162S15.403 5.838 12 5.838zm0 10.333c-2.306 0-4.171-1.865-4.171-4.171s1.865-4.171 4.171-4.171 4.171 1.865 4.171 4.171-1.865 4.171-4.171 4.171zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg> </a>
        </div>
    </footer>

    <script>
        // --- Constants & Globals ---
        const LOGGED_IN_KEY = 'isUserLoggedIn'; const CURRENT_USER_KEY = 'currentUser'; const ADMIN_EMAIL = 'm.elsayed@thechefz.co'; /* Not used here, but kept for consistency */
        const FINAL_ASSESSMENT_ID = 'final_assessment'; // ID for the NEXT assessment
        const PAGE_NAME = 'pre.html'; // Name of this file
        const QUIZ_SECTION_ID = 'pre_assessment_quiz'; // Unique ID for THIS quiz in user_progress
        const SECTION_TITLE = 'Pre-Quiz: Leadership & Coaching';
        const SECTION_TYPE = 'quiz';
        const MIN_ESSAY_LENGTH = 20;
        const DEBOUNCE_DELAY = 1500; // ms delay for textarea save

        let IS_ADMIN_USER = false; // Determined during access check
        let currentUser = null; let supabase = null; let questionBlocks = []; let totalQuestions = 0;
        let savedAnswers = {}; // Cache for answers loaded/saved in this session { questionId: answer }
        let isSubmitted = false; // Tracks if the final_assessment_completed flag is true
        let debounceTimer;

        // --- DOM Element References ---
        let userNameDisplay, userEmailDisplay, mainContainer, quizForm, progressBarContainer, progressBar, progressText, completionMessageDiv;


        // --- Supabase Initialization ---
        try {
            if (window.supabase && window.supabase.createClient) { supabase = window.supabase.createClient('https://lgcutmuspcaralydycmg.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnY3V0bXVzcGNhcmFseWR5Y21nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0NDY3MDEsImV4cCI6MjA2MTAyMjcwMX0.3u5Y7pkH2NNnnoGLMWVfAa5b8fq88o1itRYnG1K38tE'); console.log("Supabase client initialized successfully on Pre-Assessment page."); } else { throw new Error("Supabase library not found."); }
        } catch (error) { console.error("CRITICAL ERROR initializing Supabase:", error); /* Error displayed in DOMContentLoaded */ }

        // --- IMMEDIATE REDIRECTION LOGIC ---
        console.log("%cPre-Assessment Page: Running IMMEDIATE redirection check...", "color: purple; font-weight: bold;");
        function quickCheckCurrentUser_pre() { try { const data = localStorage.getItem(CURRENT_USER_KEY); return data && JSON.parse(data).id; } catch { return false; } }
        const isLoggedIn_immediate_pre = localStorage.getItem(LOGGED_IN_KEY) === 'true' && quickCheckCurrentUser_pre();
        if (!isLoggedIn_immediate_pre) { const targetUrl_pre = 'login.html'; console.error(`%cPre-Assessment Page IMMEDIATE Redirect: Not logged in. Redirecting to ${targetUrl_pre}...`, "color: orange;"); window.location.replace(targetUrl_pre); throw new Error("Redirecting user: Not logged in."); } else { console.log("%cPre-Assessment Page IMMEDIATE Check: User IS logged in. Proceeding.", "color: green;"); }

        // --- Initialization on DOM Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("%cPre-Assessment page: DOMContentLoaded event fired.", "color: green;");
            mainContainer = document.getElementById('mainContainer');
            const loadingMsg = document.getElementById('loadingOrAccessMessage');
            const errorDiv = document.getElementById('supabaseErrorMessage');

            if (!supabase) { console.error("DOM Load Error: Supabase client failed to initialize."); if (loadingMsg) loadingMsg.style.display = 'none'; if (errorDiv) { errorDiv.textContent = 'Critical Error: Cannot connect to data services.'; errorDiv.style.display = 'block'; } return; }
            currentUser = getCurrentUser();
            if (!currentUser) { console.error("DOM Load Error: User data missing."); if (loadingMsg) loadingMsg.style.display = 'none'; if (errorDiv) { errorDiv.textContent = 'Critical Error: User session invalid. Please log out and back in.'; errorDiv.style.display = 'block'; } return; }

            // Assign remaining elements
            userNameDisplay = document.getElementById('userName'); userEmailDisplay = document.getElementById('userEmail'); quizForm = document.getElementById('quizForm'); progressBarContainer = document.getElementById('progressBarContainer'); progressBar = document.getElementById('progressBar'); progressText = document.getElementById('progressText'); questionBlocks = quizForm?.querySelectorAll('.question-block') || []; completionMessageDiv = document.getElementById('completionMessage');

            if (!mainContainer || !quizForm || !progressBarContainer || !questionBlocks || questionBlocks.length === 0 || !completionMessageDiv) { console.error("Essential DOM elements missing."); if (loadingMsg) loadingMsg.style.display = 'none'; if (errorDiv) { errorDiv.textContent = 'Error: Page structure is incomplete.'; errorDiv.style.display = 'block';} return; }
            totalQuestions = questionBlocks.length;

            try {
                displayUserInfo(currentUser);
                await loadAnswersFromSupabase(currentUser.id); // Load existing answers first
                addInputListeners(); // Add listeners for auto-save AFTER loading initial data
                updateProgressBar(); // Initial progress update
                checkCompletionStatusAndDisable(); // Check if *all* questions are saved

                if (loadingMsg) loadingMsg.style.display = 'none';
                mainContainer.style.display = 'block'; // Show content
                console.log("Pre-Assessment page initialized and displayed.");
            } catch (error) { console.error("Error during Pre-Assessment Initialization:", error); if (loadingMsg) loadingMsg.style.display = 'none'; if (errorDiv) { errorDiv.textContent = `Error loading assessment: ${error.message}. Please refresh.`; errorDiv.style.display = 'block';} }
        });

        // --- Core User Functions ---
        function getCurrentUser() { try { const d=localStorage.getItem(CURRENT_USER_KEY); if(!d) return null; const u=JSON.parse(d); return u&&typeof u==='object'&&u.id?u:null; } catch(e) { console.error("Error parsing user:",e); return null; } }
        function displayUserInfo(user) { if(userNameDisplay) userNameDisplay.textContent = `Welcome, ${user?.name || user?.email?.split('@')[0] || 'User'}`; if(userEmailDisplay) userEmailDisplay.textContent = user?.email || ''; }
        function logout() { try { localStorage.removeItem(LOGGED_IN_KEY); localStorage.removeItem(CURRENT_USER_KEY); window.location.href = 'login.html'; } catch (e) { console.error("Logout error:", e); window.location.href = 'login.html'; } }
        function getQuestionGroupElement(questionId) { const el = document.querySelector(`[data-question-id="${questionId}"]`); return el ? el.closest('.form-group') || el.closest('.question-block') : null; }

        // --- Load Answers from Supabase ---
        async function loadAnswersFromSupabase(userId) {
            console.log(`Fetching answers for user ${userId} and section ${QUIZ_SECTION_ID} from user_progress...`);
            savedAnswers = {}; // Reset local cache
            try {
                const { data, error } = await supabase.from('user_progress').select('question_id, answer').eq('user_id', userId).eq('section_id', QUIZ_SECTION_ID);
                if (error) throw error;
                if (data) { data.forEach(item => { if (item.question_id && item.answer !== null) savedAnswers[item.question_id] = item.answer; }); }
                console.log("Answers loaded from Supabase into local cache:", savedAnswers);
                populateFormFields(); // Populate UI from the cache
            } catch (error) { console.error("Error fetching answers:", error.message); showGlobalError("Error loading previous answers."); populateFormFields(); /* Try populating anyway */ }
        }

        // --- Populate Form Fields from savedAnswers cache ---
        function populateFormFields() {
            questionBlocks.forEach(block => {
                const questionId = block.dataset.questionId;
                const questionType = block.dataset.questionType;
                const answer = savedAnswers[questionId];
                const statusEl = document.getElementById(`status_${questionId}`);
                const groupEl = block; // Question block is the group element now

                // Clear existing state first
                if (questionType === 'mcq') block.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
                else if (questionType === 'text') block.querySelector('textarea').value = '';
                if (groupEl) groupEl.classList.remove('saved');
                if (statusEl) statusEl.className = 'save-status';

                // Populate and style if answer exists
                if (answer !== undefined && answer !== null && answer !== '') {
                    if (questionType === 'mcq') { const radio = block.querySelector(`input[value="${CSS.escape(answer)}"]`); if (radio) radio.checked = true; }
                     else if (questionType === 'text') { block.querySelector('textarea').value = answer; }
                    if (groupEl) groupEl.classList.add('saved');
                    if (statusEl) { statusEl.textContent = 'âœ“ Saved'; statusEl.className = 'save-status show saved'; }
                }
            });
            console.log("Form fields populated/styled from savedAnswers cache.");
        }

        // --- Add Input Listeners for Auto-Save ---
        function addInputListeners() {
            console.log("Adding auto-save listeners...");
            questionBlocks.forEach(block => {
                const questionId = block.dataset.questionId;
                const inputs = block.querySelectorAll('input[type="radio"], textarea');
                inputs.forEach(input => {
                    input.addEventListener('input', () => { // Clear status on any input
                        const groupElement = getQuestionGroupElement(questionId);
                        if (groupElement) groupElement.classList.remove('saved');
                        const statusEl = document.getElementById(`status_${questionId}`);
                        if (statusEl) statusEl.className = 'save-status';
                    });
                    if (input.type === 'radio') { input.addEventListener('change', (e) => { if (e.target.checked) saveSingleAnswerToSupabase(questionId); }); }
                     else if (input.tagName === 'TEXTAREA') {
                        input.addEventListener('input', () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(() => saveSingleAnswerToSupabase(questionId), DEBOUNCE_DELAY); });
                        input.addEventListener('blur', () => { clearTimeout(debounceTimer); saveSingleAnswerToSupabase(questionId); }); // Save immediately on blur
                     }
                });
            });
        }

        // --- Save Single Answer to Supabase ---
        async function saveSingleAnswerToSupabase(questionId) {
            if (!supabase || !currentUser || !currentUser.id) { console.error("Missing Supabase/user data."); showSaveStatus(questionId, 'Error!', 'error'); return; }
            const groupElement = getQuestionGroupElement(questionId);
            const inputElement = document.querySelector(`textarea[data-question-id="${questionId}"], fieldset[data-question-id="${questionId}"]`); // Find textarea or fieldset
            const labelElement = document.querySelector(`.question-text[data-question-text*="${questionId.split('_').pop()}"]`); // Heuristic to find label
            const questionText = labelElement?.dataset?.questionText || 'Unknown Question Text'; // Get text from data attribute if possible

            let answerValue = null; let isValid = true;
            const errorMsgElement = document.getElementById(`error_${questionId}`);
            if (errorMsgElement) errorMsgElement.style.display = 'none';
             if(groupElement) groupElement.classList.remove('invalid'); // Clear previous invalid state

            if (!inputElement) { console.error(`Cannot find input/fieldset for ${questionId}`); showSaveStatus(questionId, 'Form Error', 'error'); return; }

            // Get value & Validate
            if (inputElement.tagName === 'FIELDSET') {
                const checkedRadio = inputElement.querySelector('input[type="radio"]:checked');
                answerValue = checkedRadio ? checkedRadio.value : null;
                isValid = !!checkedRadio; // Valid if something is checked (as all radios are required)
                if (!isValid && inputElement.querySelector('[required]')) { showQuestionError("Please select an option.", errorMsgElement); }
            } else if (inputElement.tagName === 'TEXTAREA') {
                answerValue = inputElement.value;
                const trimmedValue = answerValue.trim();
                const minLength = parseInt(inputElement.getAttribute('minlength') || '0', 10);
                if (inputElement.hasAttribute('required') && !trimmedValue) { showQuestionError("Please enter your answer.", errorMsgElement); isValid = false; }
                 else if (trimmedValue && minLength > 0 && trimmedValue.length < minLength) { showQuestionError(`Min ${minLength} characters required.`, errorMsgElement); isValid = false; }
                 else { isValid = true; }
            }

            if (!isValid) { showSaveStatus(questionId, 'Invalid', 'error'); if(groupElement) groupElement.classList.add('invalid'); return; }

            showSaveStatus(questionId, 'Saving...', 'saving');
            const recordData = { user_id: currentUser.id, question_id: questionId, answer: answerValue, email: currentUser.email, section_id: QUIZ_SECTION_ID, page: PAGE_NAME, question_text: questionText, section_type: SECTION_TYPE, status: 'in_progress', updated_at: new Date() };

            try {
                const { error } = await supabase.from('user_progress').upsert(recordData, { onConflict: 'user_id, question_id' });
                if (error) throw error;
                console.log(`Auto-saved answer for ${questionId}`);
                savedAnswers[questionId] = answerValue; // Update local cache
                if(groupElement) groupElement.classList.add('saved');
                showSaveStatus(questionId, 'âœ“ Saved', 'saved');
                updateProgressBar();
                checkCompletionStatusAndDisable(); // Check if all done
            } catch (error) { console.error(`Error auto-saving ${questionId}:`, error.message); showSaveStatus(questionId, 'Error!', 'error'); if(groupElement) groupElement.classList.remove('saved'); }
        }

        // --- Show Save Status ---
        function showSaveStatus(questionId, text, statusClass = 'saving') {
            const statusEl = document.getElementById(`status_${questionId}`);
            if (statusEl) {
                const spinnerSpan = '<span class="spinner"></span>';
                statusEl.innerHTML = (statusClass === 'saving' ? spinnerSpan : '') + text; // Add spinner only when saving
                statusEl.className = `save-status show ${statusClass}`;
                if (statusClass !== 'saving') { setTimeout(() => { if (statusEl.classList.contains(statusClass)) statusEl.classList.remove('show'); }, 3000); }
            }
        }

        // --- Update Progress Bar ---
        function updateProgressBar() {
             const answeredCount = Object.keys(savedAnswers).filter(qid => savedAnswers[qid] !== null && savedAnswers[qid] !== '').length;
             const percentage = totalQuestions > 0 ? Math.round((answeredCount / totalQuestions) * 100) : 0;
             if (progressBar && progressText) { progressBar.style.width = `${percentage}%`; progressText.textContent = `${percentage}% Completed (${answeredCount}/${totalQuestions})`; }
         }

        // --- Check Completion Status and Disable Form / Show Message ---
        function checkCompletionStatusAndDisable() {
             const answeredCount = Object.keys(savedAnswers).filter(qid => savedAnswers[qid] !== null && savedAnswers[qid] !== '').length;
             if (answeredCount === totalQuestions) {
                 console.log("All questions answered and saved!");
                 if (completionMessageDiv) completionMessageDiv.style.display = 'block';
                 disableAllInputs(); // Disable form now
                 // Optionally: Make a final call to mark the overall quiz as 'completed' in assessments table
                 // markQuizAsCompletedInAssessments();
             } else {
                 if (completionMessageDiv) completionMessageDiv.style.display = 'none';
             }
         }

        // --- Disable All Inputs (Called after completion) ---
        function disableAllInputs() { /* ... (Keep existing implementation) ... */ if (!quizForm) return; quizForm.querySelectorAll('input, textarea').forEach(input => { input.disabled = true; }); questionBlocks.forEach(block => { block.classList.add('submitted'); block.classList.remove('saved'); const statusEl = block.querySelector('.save-status'); if (statusEl) statusEl.style.display = 'none'; }); console.log("All quiz inputs disabled."); }

        // --- Utility Functions ---
        function showQuestionError(message, element) { if(element){element.textContent=message;element.style.display="block";} }
        function showGlobalError(message) { const el=document.getElementById('quizErrorMessage'); if(el){el.innerHTML=message;el.style.display="block";} console.error("Displayed Global Error:",message); }
        function hideGlobalError() { const el=document.getElementById('quizErrorMessage'); if(el)el.style.display="none"; }

        // --- Placeholder for Final Summary Submission (If needed later) ---
        async function markQuizAsCompletedInAssessments() {
             if (!supabase || !currentUser || isSubmitted) return; // Prevent double submission
             console.log("Marking quiz as completed in assessments table...");
             const submissionTime = new Date();
             const summaryPayload = { user_id: currentUser.id, question_id: QUIZ_SECTION_ID, type: SECTION_TYPE, user_email: currentUser.email, name: currentUser.name || currentUser.email.split('@')[0], submitted_at: submissionTime.toISOString(), completion_status: 'completed', /* Add score/is_correct if applicable */ };
             try { const { error } = await supabase.from('assessments').upsert([summaryPayload], { onConflict: ['user_id', 'question_id', 'type'] }); if (error) throw error; isSubmitted = true; console.log("Quiz marked as completed in assessments table."); /* Optionally update user table flag too */ } catch (error) { console.error("Error marking quiz complete in assessments:", error); showGlobalError("Error finalizing assessment status."); }
         }

    </script>
</body>
</html>
