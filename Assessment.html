<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leadership Assessment | Quiz 1</title>
    <!-- Favicon Links (Same as index.html) -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- Base & Reused Styles (Copied from index.html for consistency) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html { scroll-behavior: smooth; }
        body {
            background-color: #f8fafc;
            margin: 0;
            padding: 0;
            line-height: 1.6;
            color: #374151;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            font-size: 16px;
        }
        main { flex-grow: 1; }
        .header { background-color: #1f2937; color: white; padding: 1.125rem 0; text-align: center; font-size: 1.625rem; font-weight: 600; position: relative; box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1); }
        .user-bar { background-color: #374151; padding: 0.625rem 1.875rem; display: flex; justify-content: space-between; align-items: center; color: #e5e7eb; font-size: 0.9375rem; }
        .user-info { display: flex; align-items: center; gap: 0.9375rem; }
        .user-info svg { opacity: 0.8; margin-right: 0.5rem; }
        .user-details { display: flex; flex-direction: column; text-align: left; }
        .user-name { font-weight: 600; font-size: 0.9375rem; color: #f9fafb; }
        .user-email { font-size: 0.8125rem; opacity: 0.8; }
        .logout-button { background-color: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; font-weight: 500; transition: all 0.3s; display: flex; align-items: center; gap: 0.375rem; font-size: 0.9375rem; }
        .logout-button svg { margin-right: 0.375rem; }
        .logout-button:hover { background-color: #dc2626; transform: translateY(-1px); }
        .logout-button:active { transform: translateY(0); }
        .container { max-width: 53.125rem; margin: 2.5rem auto; background: white; padding: 2.1875rem 2.8125rem; box-shadow: 0 4px 25px rgba(0, 0, 0, 0.07); border-radius: 0.75rem; }
        h2, h3 { color: #111827; font-weight: 700; }
        h2 { margin-bottom: 1.5625rem; font-size: 1.875rem; text-align: center; }
        h3 { margin: 1.25rem 0 0.9375rem; font-size: 1.375rem; color: #1f2937; }
        p { margin-bottom: 0.9375rem; color: #4b5563; line-height: 1.7; font-size: 1rem; }
        .submit-button { background: linear-gradient(90deg, #3b82f6, #2563eb); color: white; border: none; padding: 0.875rem 1.75rem; font-size: 1.0625rem; cursor: pointer; border-radius: 0.5rem; display: block; width: 100%; font-weight: 600; transition: all 0.3s; margin-top: 1.875rem; box-shadow: 0 4px 6px rgba(59, 130, 246, 0.15); }
        .submit-button:hover:not(:disabled) { background: linear-gradient(90deg, #2563eb, #1d4ed8); box-shadow: 0 6px 10px rgba(59, 130, 246, 0.2); transform: translateY(-2px); }
        .submit-button:active:not(:disabled) { transform: translateY(0); }
        .submit-button:disabled { background: #9ca3af; cursor: not-allowed; box-shadow: none; }
        .error-message { color: #ef4444; font-size: 0.875rem; margin-top: 0.625rem; display: none; font-weight: 500; text-align: center; background-color: #fef2f2; padding: 0.5rem; border-radius: 0.375rem; border: 1px solid #fecaca; }
        .footer { text-align: center; padding: 1.5625rem 1.875rem; background: #1f2937; color: rgba(229, 231, 235, 0.8); margin-top: 3.125rem; font-size: 0.875rem; display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 1.5625rem; border-top: 1px solid #374151; }
        .footer-text { text-align: center; }
        .social-icons { display: flex; gap: 1.25rem; align-items: center; }
        .social-icons a { color: rgba(229, 231, 235, 0.8); text-decoration: none; display: inline-block; transition: transform 0.3s ease, color 0.3s ease; }
        .social-icons a:hover { color: #ffffff; transform: translateY(-2px); }
        .social-icons svg { width: 1.5rem; height: 1.5rem; fill: currentColor; vertical-align: middle; }

        /* --- New Styles Specific to Assessment Page --- */
        .quiz-intro {
            text-align: center;
            margin-bottom: 2rem;
            color: #4b5563;
            font-size: 1.05rem;
        }

        .question-block {
            background-color: #f9fafb;
            padding: 1.5rem 1.8rem;
            margin-bottom: 1.5rem;
            border-radius: 0.6rem;
            border: 1px solid #e5e7eb;
            border-left: 4px solid #3b82f6; /* Accent border */
        }

        .question-block.correct { /* Style for correct answer feedback */
             border-left-color: #22c55e; /* Green */
             background-color: #f0fdf4;
        }
        .question-block.incorrect { /* Style for incorrect answer feedback */
             border-left-color: #ef4444; /* Red */
             background-color: #fef2f2;
        }


        .question-text {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1.2rem;
            font-size: 1.1rem;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .options-container label {
            display: block;
            background-color: #ffffff;
            padding: 0.8rem 1rem;
            border-radius: 0.4rem;
            border: 1px solid #d1d5db;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            position: relative; /* Needed for potential ::before pseudo-elements */
        }

        .options-container label:hover {
            background-color: #eff6ff; /* Light blue */
            border-color: #60a5fa;
        }

        .options-container input[type="radio"] {
           margin-right: 0.7rem;
           accent-color: #3b82f6; /* Style the radio button itself */
           vertical-align: middle;
           /* Alternative: Visually hide the radio and style the label */
           /* opacity: 0; position: absolute; */
        }

        /* Style for selected label */
        .options-container input[type="radio"]:checked + span {
             font-weight: 500;
             color: #1d4ed8; /* Darker blue for selected text */
        }

        .feedback { /* Area within question block for correct/incorrect text */
            margin-top: 1rem;
            font-size: 0.9rem;
            font-weight: 500;
            padding: 0.5rem 0.8rem;
            border-radius: 0.3rem;
            display: none; /* Hidden by default */
        }
        .feedback.correct {
            color: #15803d; /* Dark Green */
            background-color: #dcfce7; /* Light Green */
            border: 1px solid #bbf7d0;
            display: block;
        }
         .feedback.incorrect {
            color: #b91c1c; /* Dark Red */
            background-color: #fee2e2; /* Light Red */
            border: 1px solid #fecaca;
            display: block;
        }
         .feedback span { /* For correct answer text */
            font-weight: 600;
         }

        /* --- Results Area Styles --- */
        #resultsContainer {
            margin-top: 2.5rem;
            padding: 2rem;
            background-color: #f0fdf4; /* Light green background */
            border: 1px solid #bbf7d0;
            border-radius: 0.75rem;
            text-align: center;
            display: none; /* Hidden initially */
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #resultsContainer h3 {
            color: #166534; /* Darker Green */
            margin-bottom: 1rem;
        }

        #scoreDisplay {
            font-size: 1.5rem;
            font-weight: 700;
            color: #15803d; /* Even Darker Green */
            margin-bottom: 0.5rem;
        }
        #scorePercentage {
             font-size: 1.1rem;
             font-weight: 500;
             color: #16a34a;
             margin-bottom: 1.5rem;
        }

        #resultsMessage {
            font-size: 1.1rem;
            color: #14532d;
            margin-bottom: 1.8rem;
        }

        .results-link { /* Style for links/buttons in results */
            display: inline-block;
            background-color: #22c55e; /* Green */
            color: white;
            padding: 0.75rem 1.5rem;
            text-decoration: none;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.2s;
        }
        .results-link:hover {
            background-color: #16a34a;
            transform: translateY(-1px);
        }

        /* Media query adjustments (if needed, copy/adapt from index.html) */
        @media (max-width: 700px) {
            body { font-size: 15px; }
            .container { padding: 1.6667rem 1.3333rem; }
            .header { font-size: 1.4667rem; }
            h2 { font-size: 1.7333rem; }
            h3 { font-size: 1.3333rem; }
            .submit-button { padding: 0.8rem 1.6rem; font-size: 1rem; }
            .footer { flex-direction: column; gap: 1rem; }
             .question-block { padding: 1.2rem 1.3rem; }
             .question-text { font-size: 1.05rem; }
             .options-container label { padding: 0.7rem 0.9rem;}
             #resultsContainer { padding: 1.5rem; }
             #scoreDisplay { font-size: 1.3rem; }
        }

    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">Coaching & Leadership Course</header>

    <!-- User Bar -->
    <div class="user-bar">
        <div class="user-info">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path> <circle cx="12" cy="7" r="4"></circle> </svg>
            <div class="user-details">
                <span class="user-name" id="userName">Loading...</span>
                <span class="user-email" id="userEmail"></span>
            </div>
        </div>
        <button class="logout-button" onclick="logout()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path> <polyline points="16 17 21 12 16 7"></polyline> <line x1="21" y1="12" x2="9" y2="12"></line> </svg>
            Logout
        </button>
    </div>

    <!-- Main Content -->
    <main class="container" id="mainContainer" style="display: none;">
        <h2>Quiz 1: Leadership Principles</h2>
        <p class="quiz-intro">Test your understanding of fundamental leadership concepts. Please answer all questions.</p>

        <form id="quizForm" novalidate>

            <!-- Question 1 -->
            <div class="question-block" data-question-id="quiz_1_q1">
                <p class="question-text" data-question-text="1. Which leadership style involves setting clear expectations and rewarding performance?">1. Which leadership style involves setting clear expectations and rewarding performance?</p>
                <div class="options-container">
                    <label>
                        <input type="radio" name="q1" value="transformational" required> <span>Transformational</span>
                    </label>
                    <label>
                        <input type="radio" name="q1" value="transactional"> <span>Transactional</span>
                    </label>
                    <label>
                        <input type="radio" name="q1" value="laissez_faire"> <span>Laissez-faire</span>
                    </label>
                    <label>
                        <input type="radio" name="q1" value="autocratic"> <span>Autocratic</span>
                    </label>
                </div>
                <div class="feedback" id="feedback_q1"></div> <!-- Feedback area for Q1 -->
            </div>

            <!-- Question 2 -->
            <div class="question-block" data-question-id="quiz_1_q2">
                <p class="question-text" data-question-text="2. What is a key characteristic of emotional intelligence in leadership?">2. What is a key characteristic of emotional intelligence in leadership?</p>
                <div class="options-container">
                    <label>
                        <input type="radio" name="q2" value="technical_skill" required> <span>High technical skill</span>
                    </label>
                    <label>
                        <input type="radio" name="q2" value="ignoring_emotions"> <span>Ignoring team emotions</span>
                    </label>
                    <label>
                        <input type="radio" name="q2" value="self_awareness"> <span>Self-awareness and empathy</span>
                    </label>
                    <label>
                        <input type="radio" name="q2" value="strict_rules"> <span>Enforcing strict rules</span>
                    </label>
                </div>
                 <div class="feedback" id="feedback_q2"></div> <!-- Feedback area for Q2 -->
            </div>

            <!-- Question 3 -->
            <div class="question-block" data-question-id="quiz_1_q3">
                 <p class="question-text" data-question-text="3. Delegating tasks effectively primarily helps to:">3. Delegating tasks effectively primarily helps to:</p>
                 <div class="options-container">
                     <label>
                         <input type="radio" name="q3" value="reduce_leader_workload" required> <span>Only reduce the leader's workload</span>
                     </label>
                     <label>
                         <input type="radio" name="q3" value="empower_team"> <span>Empower team members and develop skills</span>
                     </label>
                     <label>
                          <input type="radio" name="q3" value="avoid_responsibility"> <span>Avoid responsibility for outcomes</span>
                     </label>
                     <label>
                          <input type="radio" name="q3" value="show_authority"> <span>Show authority over the team</span>
                     </label>
                 </div>
                 <div class="feedback" id="feedback_q3"></div> <!-- Feedback area for Q3 -->
            </div>

            <!-- Add more questions following the same structure -->

            <p id="quizErrorMessage" class="error-message" aria-live="polite"></p>
            <button type="submit" class="submit-button" id="submitQuizButton">Submit Answers</button>

        </form>

        <!-- Results Area (Initially Hidden) -->
        <div id="resultsContainer">
            <h3>Quiz Completed!</h3>
            <p id="scoreDisplay">Your Score: 0 / 0</p>
            <p id="scorePercentage">(0%)</p>
            <p id="resultsMessage">Review your answers above.</p>
            <a href="dashboard.html" class="results-link" id="nextStepsLink">Continue to Dashboard</a> <!-- Adjust link as needed -->
        </div>

    </main>

    <!-- Footer -->
    <footer class="footer">
       <span class="footer-text">© 2025 Elmenisy Leadership Coaching - All Rights Reserved</span>
       <div class="social-icons">
         <!-- Add social icons same as index.html -->
          <a href="https://www.linkedin.com/in/mohamedmenisy17/" target="_blank" rel="noopener noreferrer" aria-label="LinkedIn Profile"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg> </a>
         <a href="https://wa.me/201014527321" target="_blank" rel="noopener noreferrer" aria-label="WhatsApp Chat"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01s-.521.074-.792.372c-.272.296-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg> </a>
         <a href="https://www.instagram.com/mohamed_menisyy/profilecard/?igsh=d3ZwZDM4czRqMzB2" target="_blank" rel="noopener noreferrer" aria-label="Instagram Profile"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 1.172.053 1.905.33 2.46.538.7.268 1.192.64 1.64 1.092.45.447.83 1.004 1.093 1.64.208.555.485 1.288.538 2.46.058 1.265.07 1.646.07 4.85s-.012 3.584-.07 4.85c-.053 1.172-.33 1.905-.538 2.46-.268.7-.64 1.192-1.092 1.64-.447.45-.997.827-1.64 1.093-.555.208-1.288.485-2.46.538-1.265.058-1.646.07-4.85.07s-3.584-.012-4.85-.07c-1.172-.053-1.905-.33-2.46-.538-.697-.268-1.19-.64-1.64-1.093-.45-.447-.827-.997-1.093-1.64-.208-.555-.485-1.288-.538-2.46-.058-1.265-.07-1.646-.07-4.85s.012-3.584.07-4.85c.053-1.172.33-1.905.538-2.46.268-.697.64-1.19 1.093-1.64.45-.45.997-.827 1.64-1.093.555-.208 1.288.485 2.46.538 1.265-.058 1.646-.07 4.85-.07zm0-2.163c-3.259 0-3.667.014-4.947.072-1.356.06-2.31.344-3.174.732-.884.396-1.627.96-2.377 1.71-.755.752-1.318 1.494-1.716 2.378-.386.863-.67 1.818-.73 3.172C.014 8.333 0 8.741 0 12s.014 3.667.072 4.947c.06 1.356.344 2.31.73 3.174.396.884.96 1.627 1.716 2.377.752.755 1.494 1.318 2.378 1.716.863.386 1.818.67 3.172.73 1.28.058 1.688.072 4.947.072s3.667-.014 4.947-.072c1.356-.06 2.31-.344 3.174-.73.884-.396 1.627-.96 2.377-1.716.755-.752 1.318-1.494 1.716-2.378.386.863.67-1.818.73-3.172.058-1.28.072-1.688.072-4.947s-.014-3.667-.072-4.947c-.06-1.356-.344-2.31-.73-3.174-.396-.884-.96-1.627-1.716-2.377-.752-.755-1.494-1.318-2.378-1.716-.863-.386-1.818-.67-3.172-.73C15.667.014 15.259 0 12 0zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.162 6.162 6.162 6.162-2.759 6.162-6.162S15.403 5.838 12 5.838zm0 10.333c-2.306 0-4.171-1.865-4.171-4.171s1.865-4.171 4.171-4.171 4.171 1.865 4.171 4.171-1.865 4.171-4.171 4.171zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg> </a>
       </div>
    </footer>

    <script>
        // --- Supabase Configuration ---
        const SUPABASE_URL = 'https://lgcutmuspcaralydycmg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnY3V0bXVzcGNhcmFseWR5Y21nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0NDY3MDEsImV4cCI6MjA2MTAyMjcwMX0.3u5Y7pkH2NNnnoGLMWVfAa5b8fq88o1itRYnG1K38tE'; // Use your actual ANON key
        let supabase = null;

        // --- Unified Keys & Configuration ---
        const LOGGED_IN_KEY = 'isUserLoggedIn';
        const CURRENT_USER_KEY = 'currentUser';
        const SIGNUP_FLAG_KEY = 'hasSignedUpBefore'; // Keep consistent

        // --- Quiz Specific Configuration ---
        const QUIZ_ID = 'quiz_1'; // Unique ID for this specific quiz section
        const SECTION_TITLE = 'Quiz 1: Leadership Principles';
        const SECTION_TYPE = 'quiz';
        const PAGE_NAME = 'Assessment.html';
        const PASSING_PERCENTAGE = 50; // Example passing threshold

        // --- Correct Answers (Map: question_id -> correct_value) ---
        // IMPORTANT: Match question_id with the data-question-id in HTML
        const correctAnswers = {
            'quiz_1_q1': 'transactional',
            'quiz_1_q2': 'self_awareness',
            'quiz_1_q3': 'empower_team',
            // Add correct answers for other questions here
        };
        const totalQuestions = Object.keys(correctAnswers).length;


        // Initialize Supabase Client
        try {
            if (window.supabase && window.supabase.createClient) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log("Supabase client initialized successfully on Assessment page.");
            } else {
                throw new Error("Supabase library not found.");
            }
        } catch (error) {
            console.error("CRITICAL ERROR initializing Supabase:", error);
            // Optionally display an error message to the user on the page
            const mainContainer = document.getElementById('mainContainer');
            if(mainContainer) mainContainer.innerHTML = '<p class="error-message" style="display: block; text-align:center;">Failed to connect to required services. Please refresh or contact support.</p>';
        }

         // ***** ---> IMMEDIATE REDIRECTION LOGIC (Copy from index.html) <--- *****
         console.log("%cAssessment Page: Running IMMEDIATE redirection check...", "color: purple; font-weight: bold;");
         function quickCheckCurrentUser() { const data = localStorage.getItem(CURRENT_USER_KEY); return data && data.startsWith('{') && data.endsWith('}'); }
         const isLoggedIn_immediate_assess = localStorage.getItem(LOGGED_IN_KEY) === 'true' && quickCheckCurrentUser();
         const hasSignedUp_immediate_assess = localStorage.getItem(SIGNUP_FLAG_KEY) === 'true';
         const currentPage_immediate_assess = window.location.pathname.split('/').pop() || 'Assessment.html';
         console.log(`Assessment Page IMMEDIATE Check: isLoggedIn=${isLoggedIn_immediate_assess}, hasSignedUp=${hasSignedUp_immediate_assess}, currentPage=${currentPage_immediate_assess}`);

         if (!isLoggedIn_immediate_assess) {
             const targetUrl_assess = hasSignedUp_immediate_assess ? 'login.html' : 'signup.html';
             console.error(`%cAssessment Page IMMEDIATE Redirect: Not logged in. Redirecting to ${targetUrl_assess}...`, "color: orange;");
             window.location.replace(targetUrl_assess);
             // Throw error to stop further script execution on this page if redirecting
             throw new Error("Redirecting user: Not logged in.");
         } else {
             console.log("%cAssessment Page IMMEDIATE Check: User IS logged in. Proceeding.", "color: green;");
         }
         // ***** ---> END IMMEDIATE REDIRECTION LOGIC <--- *****


        // --- DOM Element References ---
        let userNameDisplay, userEmailDisplay, mainContainer, quizForm, submitQuizButton, quizErrorMessage, resultsContainer, scoreDisplay, scorePercentage, resultsMessage;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log("%cAssessment page: DOMContentLoaded event fired.", "color: green;");
            mainContainer = document.getElementById('mainContainer');

             // Failsafe: Check if Supabase is available after redirection logic passed
             if (!supabase) {
                 console.error("Supabase client failed to initialize. Stopping page load.");
                 if (mainContainer) mainContainer.innerHTML = '<p class="error-message" style="display: block; text-align:center;">Connection Error. Cannot load assessment.</p>';
                 return; // Stop further execution
             }

            try {
                // Assign elements
                userNameDisplay = document.getElementById('userName');
                userEmailDisplay = document.getElementById('userEmail');
                quizForm = document.getElementById('quizForm');
                submitQuizButton = document.getElementById('submitQuizButton');
                quizErrorMessage = document.getElementById('quizErrorMessage');
                resultsContainer = document.getElementById('resultsContainer');
                scoreDisplay = document.getElementById('scoreDisplay');
                scorePercentage = document.getElementById('scorePercentage');
                resultsMessage = document.getElementById('resultsMessage');

                // Basic check for essential elements
                if (!mainContainer || !quizForm || !submitQuizButton || !userNameDisplay || !userEmailDisplay || !resultsContainer) {
                    throw new Error("Essential DOM elements for assessment page not found!");
                }

                const currentUser = getCurrentUser();
                // **CRITICAL Failsafe Check** (even after immediate redirect check)
                if (!currentUser || !currentUser.id || !currentUser.email) {
                     console.error("Assessment DOMContentLoaded: Failsafe check - User data invalid/missing! Redirecting.");
                     const failsafeTarget = localStorage.getItem(SIGNUP_FLAG_KEY) === 'true' ? 'login.html' : 'signup.html';
                     window.location.replace(failsafeTarget);
                     return; // Stop execution
                }

                console.log(`%cAssessment DOMContentLoaded: User verified (${currentUser.email}, ID: ${currentUser.id}). Initializing page content.`, "color: green;");

                initializePageContent(currentUser);
                if(mainContainer) mainContainer.style.display = 'block'; // Show content now
                console.log("Assessment page content successfully initialized and displayed.");

            } catch (error) {
                 console.error("CRITICAL ERROR during Assessment DOMContentLoaded or initializePageContent:", error);
                 if(mainContainer){
                     mainContainer.innerHTML = `<p class="error-message" style="display: block; text-align:center;">An error occurred loading the assessment. Please refresh. Error: ${error.message}</p>`;
                     mainContainer.style.display = 'block';
                 } else {
                     // Fallback if even container is missing
                     document.body.innerHTML = `<p style="color: red; padding: 20px;">Critical Error: Page structure incomplete or major script error. (${error.message})</p>`;
                 }
            }
        });

        function initializePageContent(currentUser) {
            console.log("%cAssessment page: Running initializePageContent()...", "color: blue;");
            displayUserInfo(currentUser);
            addEventListeners();
            console.log("initializePageContent() finished successfully.");
        }

        // --- Core User Functions (Copied/Adapted from index.html) ---
        function getCurrentUser() {
             try {
                 const userData = localStorage.getItem(CURRENT_USER_KEY);
                 if (!userData) return null;
                 const user = JSON.parse(userData);
                 // Add more robust validation if necessary
                 if (user && typeof user === 'object' && user.email && user.id) {
                     if (!user.name) user.name = user.email.split('@')[0]; // Derive name if missing
                     return user;
                 } else {
                     console.warn("Stored user data is invalid or missing ID. Clearing.");
                     localStorage.removeItem(CURRENT_USER_KEY);
                     localStorage.removeItem(LOGGED_IN_KEY);
                     return null;
                 }
             } catch (e) {
                 console.error("Error parsing current user data:", e);
                 localStorage.removeItem(CURRENT_USER_KEY);
                 localStorage.removeItem(LOGGED_IN_KEY);
                 return null;
             }
        }

        function displayUserInfo(currentUser) {
             try {
                 let uN = 'User'; // Default
                 let uE = '';
                 if (currentUser) {
                     uN = currentUser.name || currentUser.email.split('@')[0]; // Use name or derive from email
                     uE = currentUser.email || '';
                 }
                 if (userNameDisplay) userNameDisplay.textContent = `Welcome, ${uN}`;
                 if (userEmailDisplay) userEmailDisplay.textContent = uE;
             } catch (err) {
                 console.error("Error in displayUserInfo:", err);
                 if (userNameDisplay) userNameDisplay.textContent = 'Welcome'; // Failsafe display
                 if (userEmailDisplay) userEmailDisplay.textContent = '';
             }
        }

        function logout() {
            try {
                // Clear assessment-specific storage if any, plus standard keys
                localStorage.removeItem(LOGGED_IN_KEY);
                localStorage.removeItem(CURRENT_USER_KEY);
                // Remove SIGNUP_FLAG_KEY only if appropriate for your flow (usually kept)
                // localStorage.removeItem(SIGNUP_FLAG_KEY);
                console.log("User logged out from Assessment page, relevant keys cleared.");
                window.location.href = 'login.html'; // Redirect to login
            } catch (e) {
                console.error("Logout error:", e);
                window.location.href = 'login.html'; // Force redirect even on error
            }
        }

        // --- Event Listeners ---
        function addEventListeners() {
            try {
                if (quizForm) {
                    quizForm.addEventListener('submit', handleQuizSubmit);
                } else {
                    console.error("Quiz form not found, cannot add submit listener.");
                }
                // Add listener for logout button defined in HTML
                const logoutBtn = document.querySelector('.logout-button');
                 if (logoutBtn && !logoutBtn.onclick) { // Avoid adding multiple listeners if already set inline
                     // logoutBtn.addEventListener('click', logout); // Inline onclick="logout()" is used
                 } else if (!logoutBtn) {
                     console.warn("Logout button not found.")
                 }

            } catch (err) {
                console.error("Error adding event listeners:", err);
            }
        }

        // --- Quiz Submission Logic ---
        async function handleQuizSubmit(event) {
            event.preventDefault();
            console.log("handleQuizSubmit: Starting...");
            hideError(); // Hide previous errors
            setButtonLoading(true, 'Submitting...');

            const currentUser = getCurrentUser();
            if (!currentUser || !currentUser.id || !currentUser.email) {
                showError("User session error. Please log out and log back in.", quizForm);
                setButtonLoading(false);
                return;
            }
            const userName = currentUser.name || currentUser.email.split('@')[0];

            // --- 1. Collect Answers & Validate ---
            const formData = new FormData(quizForm);
            const userAnswers = {};
            let answeredQuestionsCount = 0;
            const questionBlocks = quizForm.querySelectorAll('.question-block');

            questionBlocks.forEach(block => {
                const qId = block.dataset.questionId;
                const radioName = block.querySelector('input[type="radio"]').name; // e.g., "q1", "q2"
                const selectedValue = formData.get(radioName); // Get value of selected radio for this group

                if (qId) {
                    userAnswers[qId] = selectedValue; // Store selected value (or null if unanswered)
                    if (selectedValue) {
                        answeredQuestionsCount++;
                    }
                }
            });


            if (answeredQuestionsCount < questionBlocks.length) {
                 showError("Please answer all questions before submitting.", quizForm);
                 setButtonLoading(false);
                 return;
            }

            console.log("User Answers:", userAnswers);

            // --- 2. Process Results (Score, Correct/Incorrect) ---
            let score = 0;
            const results = []; // To store detailed results for feedback/DB
            const submissionTime = new Date(); // Use the same timestamp for all related entries

            for (const questionId in userAnswers) {
                if (correctAnswers.hasOwnProperty(questionId)) {
                    const userAnswer = userAnswers[questionId];
                    const correctAnswer = correctAnswers[questionId];
                    const isCorrect = userAnswer === correctAnswer;
                    const questionTextElement = document.querySelector(`.question-block[data-question-id="${questionId}"] .question-text`);
                    const questionText = questionTextElement ? questionTextElement.dataset.questionText || questionTextElement.textContent.trim() : 'Unknown Question Text'; // Get question text

                    if (isCorrect) {
                        score++;
                    }

                    results.push({
                        question_id: questionId,
                        user_answer: userAnswer,
                        correct_answer: correctAnswer,
                        is_correct: isCorrect,
                        question_text: questionText // Store the actual question text
                    });
                }
            }

            const percentage = totalQuestions > 0 ? Math.round((score / totalQuestions) * 100) : 0;
            const isPassed = percentage >= PASSING_PERCENTAGE;

            console.log(`Score: ${score}/${totalQuestions}, Percentage: ${percentage}%, Passed: ${isPassed}`);


            // --- 3. Prepare Supabase Payloads ---
            const assessmentsPayloadArray = [];
            const userProgressPayloadArray = [];

             results.forEach(result => {
                 // **Payload for 'assessments' table**
                 assessmentsPayloadArray.push({
                     // id: generated by default
                     name: userName,
                     question_id: result.question_id,
                     answer: result.user_answer, // User's submitted answer
                     is_correct: result.is_correct ? 'true' : 'false', // Store as TEXT 'true'/'false' based on schema
                     score: result.is_correct ? 1 : 0, // Store as float8 (or adjust points as needed)
                     submitted_at: submissionTime.toISOString().slice(0, 10), // Store as DATE (YYYY-MM-DD) based on schema
                     goal_answer: null, // Not applicable for quiz assessment
                     section_id: QUIZ_ID, // Overall quiz section ID
                     completion_status: 'completed',
                     question_text: result.question_text, // The actual question text
                     // created_at: handled by Supabase default
                     user_id: currentUser.id,
                     page: PAGE_NAME,
                     type: SECTION_TYPE, // 'quiz'
                     user_email: currentUser.email
                 });

                 // **Payload for 'user_progress' table**
                 userProgressPayloadArray.push({
                     // id: generated by default
                     user_id: currentUser.id,
                     section_type: SECTION_TYPE,
                     section_id: QUIZ_ID, // Use quiz ID as section ID
                     section_title: SECTION_TITLE,
                     question_id: result.question_id, // Specific question ID
                     question_text: result.question_text, // The actual question text
                     page: PAGE_NAME,
                     progress_percentage: 100, // 100% for this question attempt upon submission
                     score: result.is_correct ? 1 : 0, // Score for this specific question (numeric type)
                     status: 'completed', // Status for this question attempt
                     submitted_at: submissionTime.toISOString(), // Store as timestampz
                     updated_at: submissionTime.toISOString(), // Store as timestampz
                     is_passed: result.is_correct, // Boolean for this specific question
                     email: currentUser.email
                 });
             });


            // --- 4. Send Data to Supabase ---
            try {
                console.log("Submitting to 'assessments':", assessmentsPayloadArray);
                const { data: assessmentData, error: assessmentError } = await supabase
                    .from('assessments')
                    .insert(assessmentsPayloadArray)
                    .select(); // Optional: Select to confirm

                if (assessmentError) {
                    console.error('%cSupabase Insert Error (assessments):', 'color: red;', assessmentError);
                    throw new Error(`Database error (assessments): ${assessmentError.message}`);
                }
                console.log('%cSupabase Insert Success (assessments):', 'color: green;', assessmentData);

                console.log("Submitting to 'user_progress':", userProgressPayloadArray);
                 // Using upsert for user_progress
                 const { data: progressData, error: progressError } = await supabase
                    .from('user_progress')
                    .upsert(userProgressPayloadArray, { onConflict: 'user_id, question_id' }) // Upsert based on user and question
                    .select();

                if (progressError) {
                     console.error('%cSupabase Upsert Error (user_progress):', 'color: red;', progressError);
                     // Decide if this is critical. Maybe log warning but continue?
                     // For now, treat it as an error that stops the success flow.
                     throw new Error(`Database error (user progress): ${progressError.message}`);
                }
                console.log('%cSupabase Upsert Success (user_progress):', 'color: green;', progressData);


                // --- 5. Update UI on Success ---
                displayResults(score, totalQuestions, percentage, isPassed, results);
                disableQuizForm(); // Disable form inputs after successful submission

            } catch (error) {
                console.error("Error during Supabase submission:", error);
                showError(`Submission failed: ${error.message}. Please try again.`);
                setButtonLoading(false); // Re-enable button on failure
            }
        }

        // --- UI Update Functions ---

        function displayResults(finalScore, total, perc, passed, detailedResults) {
            if (!resultsContainer || !scoreDisplay || !resultsMessage || !scorePercentage) return;

             // Show feedback for each question
             detailedResults.forEach(result => {
                 const feedbackEl = document.getElementById(`feedback_${result.question_id.split('_').pop()}`); // e.g., feedback_q1
                 const questionBlockEl = document.querySelector(`.question-block[data-question-id="${result.question_id}"]`);
                 if (feedbackEl && questionBlockEl) {
                    if (result.is_correct) {
                         feedbackEl.innerHTML = `✅ Correct!`;
                         feedbackEl.className = 'feedback correct'; // Use class for styling
                         questionBlockEl.classList.add('correct'); // Add class to block
                    } else {
                         feedbackEl.innerHTML = `❌ Incorrect. The correct answer was: <span>${result.correct_answer.replace(/_/g, ' ')}</span>`; // Show correct answer
                         feedbackEl.className = 'feedback incorrect';
                         questionBlockEl.classList.add('incorrect'); // Add class to block
                    }
                 }
             });

            // Update summary results area
            scoreDisplay.textContent = `Your Score: ${finalScore} / ${total}`;
             scorePercentage.textContent = `(${perc}%)`;
            resultsMessage.textContent = passed
                ? "Congratulations! You passed the assessment."
                : "You did not pass this time. Review the answers and consider retaking.";

            resultsContainer.style.display = 'block'; // Show the results section
            resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'center' }); // Scroll to results
            if(submitQuizButton) submitQuizButton.style.display = 'none'; // Hide submit button
        }

        function disableQuizForm() {
            if (!quizForm) return;
            const inputs = quizForm.querySelectorAll('input, button');
            inputs.forEach(input => {
                input.disabled = true;
            });
            console.log("Quiz form disabled.");
        }


        function setButtonLoading(isLoading, text = 'Submit Answers') {
            if (!submitQuizButton) return;
            submitQuizButton.disabled = isLoading;
            submitQuizButton.textContent = isLoading ? 'Submitting...' : text;
            // Optional: Add a visual loading indicator like a spinner
        }

        function showError(message, contextElement) {
            if (quizErrorMessage) {
                quizErrorMessage.textContent = message;
                quizErrorMessage.style.display = "block";
            }
            // Optional: scroll to the error message or context element
            if (contextElement) {
                 contextElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else if (quizErrorMessage) {
                 quizErrorMessage.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            console.error("Displayed error to user:", message);
        }

        function hideError() {
            if (quizErrorMessage) {
                quizErrorMessage.style.display = "none";
                quizErrorMessage.textContent = ""; // Clear previous message
            }
        }

    </script>
</body>
</html>
