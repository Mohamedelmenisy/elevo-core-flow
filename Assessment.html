<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leadership & Coaching Quiz | Enhanced</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- Styles (Keep the previous enhanced styles) --- */
        :root { /* ... Variables remain the same ... */ --primary-color: #3b82f6; --primary-darker: #2563eb; --secondary-color: #10b981; --secondary-darker: #059669; --text-dark: #1f2937; --text-medium: #4b5563; --text-light: #6b7280; --bg-light: #f9fafb; --bg-white: #ffffff; --border-color: #e5e7eb; --error-red: #ef4444; --success-green: #22c55e; --success-bg-light: #f0fdf4; --success-border: #bbf7d0; --warn-yellow: #f59e0b; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html { scroll-behavior: smooth; }
        body { background-color: #f8fafc; margin: 0; padding: 0; line-height: 1.6; color: var(--text-medium); display: flex; flex-direction: column; min-height: 100vh; font-size: 16px; }
        main { flex-grow: 1; }
        .header { background-color: var(--text-dark); color: white; padding: 1.125rem 0; text-align: center; font-size: 1.625rem; font-weight: 600; box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1); }
        .user-bar { background-color: #374151; padding: 0.625rem 1.875rem; display: flex; justify-content: space-between; align-items: center; color: #e5e7eb; font-size: 0.9375rem; position: sticky; top: 0; z-index: 1010; /* Ensure it's above progress bar */ }
        .user-info { display: flex; align-items: center; gap: 0.9375rem; }
        .user-info svg { opacity: 0.8; margin-right: 0.5rem; color: #9ca3af; }
        .user-details { display: flex; flex-direction: column; text-align: left; }
        .user-name { font-weight: 600; font-size: 0.9375rem; color: #f9fafb; }
        .user-email { font-size: 0.8125rem; opacity: 0.8; }
        .logout-button { background-color: var(--error-red); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; font-weight: 500; transition: all 0.3s; display: flex; align-items: center; gap: 0.375rem; font-size: 0.9375rem; }
        .logout-button svg { margin-right: 0.375rem; }
        .logout-button:hover { background-color: #dc2626; transform: translateY(-1px); }
        .logout-button:active { transform: translateY(0); }
        .container { max-width: 56rem; margin: 2.5rem auto; background: var(--bg-white); padding: 2.5rem 3rem; box-shadow: 0 6px 30px rgba(0, 0, 0, 0.08); border-radius: 0.75rem; }
        h2 { color: var(--text-dark); font-weight: 700; margin-bottom: 1rem; font-size: 1.8rem; text-align: center; }
        h3 { margin: 1.25rem 0 0.9375rem; font-size: 1.375rem; color: var(--text-dark); }
        p { margin-bottom: 0.9375rem; color: var(--text-medium); line-height: 1.7; font-size: 1rem; }
        .footer { text-align: center; padding: 1.5625rem 1.875rem; background: var(--text-dark); color: rgba(229, 231, 235, 0.8); margin-top: 3.125rem; font-size: 0.875rem; display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 1.5625rem; border-top: 1px solid #374151; }
        .footer-text { text-align: center; }
        .social-icons { display: flex; gap: 1.25rem; align-items: center; }
        .social-icons a { color: rgba(229, 231, 235, 0.8); text-decoration: none; display: inline-block; transition: transform 0.3s ease, color 0.3s ease; }
        .social-icons a:hover { color: #ffffff; transform: translateY(-2px); }
        .social-icons svg { width: 1.5rem; height: 1.5rem; fill: currentColor; vertical-align: middle; }

        /* Quiz Specific Styles */
        .quiz-intro { text-align: center; margin-bottom: 2rem; color: var(--text-light); font-size: 1.05rem; }
        /* Progress Bar */
        #progressBarContainer { width: 100%; background-color: #e5e7eb; border-radius: 0.5rem; margin-bottom: 2.5rem; overflow: hidden; height: 1.5rem; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); position: sticky; top: 61px; /* Adjusted for user bar height */ z-index: 1000; /* Below user bar */ }
        #progressBar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--secondary-color), var(--secondary-darker)); border-radius: 0.5rem; transition: width 0.6s ease-out; display: flex; align-items: center; justify-content: center; position: relative; }
        #progressText { font-size: 0.8rem; font-weight: bold; color: white; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4); white-space: nowrap; z-index: 1; }

        /* Question Block Styling */
        .question-block { background-color: var(--bg-light); padding: 1.8rem 2rem; margin-bottom: 1.8rem; border-radius: 0.6rem; border: 1px solid var(--border-color); border-left: 5px solid var(--primary-color); transition: opacity 0.3s ease, border-left-color 0.3s ease, border 0.3s ease, background-color 0.3s ease; }
        .question-block.saved { border-left-color: var(--success-green); background-color: var(--success-bg-light); /* Light green background when saved */ }
        .question-block.submitted { border-left-color: var(--warn-yellow); opacity: 0.9; background-color: #fefce8; /* Light yellow for submitted */ } /* Different style for submitted */

        .question-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.8rem; }
        .question-text { font-weight: 600; color: var(--text-dark); font-size: 1.15rem; margin-bottom: 0; /* Remove bottom margin */ flex-grow: 1; /* Allow text to take space */ }
        .save-status { font-size: 0.8rem; font-weight: 500; color: var(--text-light); visibility: hidden; opacity: 0; transition: opacity 0.5s, color 0.3s; white-space: nowrap; margin-left: 1rem; }
        .save-status.show { visibility: visible; opacity: 1; }
        .save-status.saving { color: var(--text-medium); }
        .save-status.saved { color: var(--success-green); }
        .save-status.error { color: var(--error-red); }

        .single-attempt-notice { font-size: 0.85rem; color: var(--text-light); margin-top: 0.5rem; /* Adjusted margin */ margin-bottom: 1rem; padding: 0.4rem 0.8rem; background-color: #fffbeb; border: 1px solid #fef3c7; border-radius: 0.3rem; display: inline-block; }
        .single-attempt-notice::before { content: "⚠️"; margin-right: 0.4rem; }

        /* Options Container (MCQ) */
        .options-container { display: flex; flex-direction: column; gap: 0.8rem; }
        .options-container label { display: block; background-color: var(--bg-white); padding: 0.85rem 1.1rem; border-radius: 0.4rem; border: 1px solid #d1d5db; cursor: pointer; transition: all 0.2s ease-in-out; position: relative; }
        .options-container label:hover:not(:has(input:disabled)) { background-color: #eff6ff; border-color: #93c5fd; }
        .options-container input[type="radio"] { margin-right: 0.8rem; accent-color: var(--primary-color); vertical-align: middle; transform: scale(1.1); cursor: pointer; }
        .options-container input[type="radio"]:disabled { cursor: not-allowed; }
        .options-container input[type="radio"]:disabled + span { color: var(--text-light); cursor: not-allowed; }
        .options-container label:has(input[type="radio"]:disabled) { background-color: #f3f4f6; cursor: not-allowed; border-color: #e5e7eb; }
        .options-container label span::after { content: ''; }

        /* Text Area (Essay) */
        .essay-container { }
        .essay-container textarea { width: 100%; padding: 0.9rem 1rem; font-size: 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; transition: all 0.3s; background-color: var(--bg-white); min-height: 100px; resize: vertical; line-height: 1.5; }
        .essay-container textarea:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        .essay-container textarea:disabled { background-color: #f3f4f6 !important; cursor: not-allowed !important; color: var(--text-light) !important; border-color: #e5e7eb !important; }

        /* REMOVED: Save Button (Per Question) Styles */
        .save-question-button { display: none !important; } /* Hide the button */

        /* Question Specific Error Message */
        .question-error-message { color: var(--error-red); font-size: 0.8rem; margin-top: 0.5rem; display: none; font-weight: 500; }

        /* --- Results Area Styles (Keep as is) --- */
        #resultsContainer { margin-top: 2.5rem; padding: 2.5rem; background-color: var(--success-bg-light); border: 1px solid var(--success-border); border-radius: 0.75rem; text-align: center; display: none; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #resultsContainer h3 { color: #166534; margin-bottom: 1rem; font-size: 1.6rem; }
        #scoreDisplay { display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 1.5rem; }
        #resultEmoji { font-size: 2.5rem; }
        #scoreText { font-size: 1.3rem; font-weight: 600; color: #15803d; }
        #resultsMessage { font-size: 1.15rem; color: #14532d; margin-bottom: 2rem; }
        .results-link { display: inline-block; background-color: var(--success-green); color: white; padding: 0.8rem 1.6rem; text-decoration: none; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.3s, transform 0.2s; font-size: 1rem; }
        .results-link:hover { background-color: #16a34a; transform: translateY(-1px); }

        /* Responsive Adjustments (Keep as is) */
        @media (max-width: 768px) { .container { padding: 2rem 1.5rem; } h2 { font-size: 1.6rem; } .question-block { padding: 1.5rem 1.2rem; } .question-text { font-size: 1.1rem; } #progressBarContainer { height: 1.3rem; top: 55px; /* Adjust for potentially smaller user bar */ } #progressText { font-size: 0.75rem; } }
        @media (max-width: 480px) { body { font-size: 15px; } .container { padding: 1.5rem 1rem; margin: 1.5rem auto; } .header { font-size: 1.4rem; } h2 { font-size: 1.5rem; } .user-bar { padding: 0.5rem 1rem; font-size: 0.85rem; } .user-info { gap: 0.5rem; } .user-name { font-size: 0.85rem;} .user-email { font-size: 0.75rem; } .logout-button { padding: 0.4rem 0.8rem; font-size: 0.85rem;} .quiz-intro { font-size: 1rem; } .question-block { padding: 1.2rem 1rem; } .question-text { font-size: 1.05rem; } .options-container label { padding: 0.7rem 0.9rem;} /* Save button already hidden */ #resultsContainer { padding: 1.5rem; } #resultsContainer h3 { font-size: 1.4rem; } #resultEmoji { font-size: 2rem; } #scoreText { font-size: 1.1rem; } #resultsMessage { font-size: 1rem; margin-bottom: 1.5rem;} .results-link { padding: 0.7rem 1.4rem; font-size: 0.9rem; } .footer { flex-direction: column; gap: 1rem; padding: 1rem; font-size: 0.8rem; } #progressBarContainer { top: 50px; /* Further adjust if needed */ } }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">Coaching & Leadership Course</header>
    <!-- User Bar -->
    <div class="user-bar">
        <div class="user-info">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path> <circle cx="12" cy="7" r="4"></circle> </svg>
            <div class="user-details">
                <span class="user-name" id="userName">Loading...</span>
                <span class="user-email" id="userEmail"></span>
            </div>
        </div>
        <button class="logout-button" onclick="logout()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path> <polyline points="16 17 21 12 16 7"></polyline> <line x1="21" y1="12" x2="9" y2="12"></line> </svg>
            Logout
        </button>
    </div>

    <!-- Main Content -->
    <main class="container" id="mainContainer" style="display: none;">
        <h2>Quiz: Leadership & Coaching 🏆</h2>
        <p class="quiz-intro">Assess your knowledge of key leadership and coaching principles. Your answers will be saved automatically.</p>

        <!-- Progress Bar -->
        <div id="progressBarContainer">
            <div id="progressBar">
                <span id="progressText">0% Completed</span>
            </div>
        </div>

        <form id="quizForm" novalidate>

            <!-- Question 1 (MCQ) -->
            <div class="question-block" data-question-id="quiz_lc_q1" data-question-type="mcq">
                <div class="question-header">
                     <p class="question-text" data-question-text="1. What is the most important characteristic of effective coaching? 🤔">1. What is the most important characteristic of effective coaching? 🤔</p>
                     <span class="save-status" id="status_quiz_lc_q1"></span>
                </div>
                 <p class="single-attempt-notice">Your answer is final once selected.</p>
                <div class="options-container">
                    <label> <input type="radio" name="q1" value="direct_orders" required> <span>Giving direct orders and instructions</span> </label>
                    <label> <input type="radio" name="q1" value="active_listening" required> <span>Active listening and asking powerful questions</span> </label>
                    <label> <input type="radio" name="q1" value="focus_weakness" required> <span>Focusing only on the coachee's weaknesses</span> </label>
                    <label> <input type="radio" name="q1" value="solve_problems" required> <span>Solving all problems for the coachee</span> </label>
                </div>
                <p class="question-error-message" id="error_q1"></p>
                <!-- Save button removed -->
            </div>

            <!-- Question 2 (MCQ) -->
            <div class="question-block" data-question-id="quiz_lc_q2" data-question-type="mcq">
                 <div class="question-header">
                     <p class="question-text" data-question-text="2. What does 'Leading by Example' mean? ✨">2. What does 'Leading by Example' mean? ✨</p>
                     <span class="save-status" id="status_quiz_lc_q2"></span>
                </div>
                 <p class="single-attempt-notice">Your answer is final once selected.</p>
                <div class="options-container">
                    <label> <input type="radio" name="q2" value="loudest_voice" required> <span>Always being the loudest voice in the room</span> </label>
                    <label> <input type="radio" name="q2" value="micromanaging" required> <span>Micromanaging every task the team performs</span> </label>
                    <label> <input type="radio" name="q2" value="demonstrating_behaviors" required> <span>Demonstrating desired behaviors and values consistently</span> </label>
                    <label> <input type="radio" name="q2" value="taking_credit" required> <span>Taking all the credit for team successes</span> </label>
                </div>
                <p class="question-error-message" id="error_q2"></p>
                 <!-- Save button removed -->
            </div>

             <!-- Question 3 (Essay) -->
            <div class="question-block" data-question-id="quiz_lc_q3" data-question-type="text">
                  <div class="question-header">
                    <p class="question-text" data-question-text="3. Define the concept of successful leadership in your own words. (Min 20 chars) ✍️">3. Define the concept of successful leadership in your own words. (Min 20 chars) ✍️</p>
                     <span class="save-status" id="status_quiz_lc_q3"></span>
                 </div>
                 <p class="single-attempt-notice">Your answer is saved when you move away from the text area.</p>
                 <div class="essay-container">
                      <textarea name="q3" rows="5" placeholder="Explain what successful leadership means to you..." required minlength="20"></textarea>
                 </div>
                  <p class="question-error-message" id="error_q3"></p>
                   <!-- Save button removed -->
            </div>

            <!-- Question 4 (Essay) -->
            <div class="question-block" data-question-id="quiz_lc_q4" data-question-type="text">
                 <div class="question-header">
                    <p class="question-text" data-question-text="4. Describe a practical situation requiring a leader to adapt their style. (Min 20 chars) 🔄">4. Describe a practical situation requiring a leader to adapt their style. (Min 20 chars) 🔄</p>
                    <span class="save-status" id="status_quiz_lc_q4"></span>
                 </div>
                 <p class="single-attempt-notice">Your answer is saved when you move away from the text area.</p>
                 <div class="essay-container">
                      <textarea name="q4" rows="5" placeholder="Think of a scenario (e.g., crisis, new team, complex project)..." required minlength="20"></textarea>
                 </div>
                  <p class="question-error-message" id="error_q4"></p>
                  <!-- Save button removed -->
            </div>

            <!-- Question 5 (Essay) -->
            <div class="question-block" data-question-id="quiz_lc_q5" data-question-type="text">
                  <div class="question-header">
                     <p class="question-text" data-question-text="5. Provide a personal analysis of the qualities you believe are most essential for an effective leader. (Min 20 chars) 🌟">5. Provide a personal analysis of the qualities you believe are most essential for an effective leader. (Min 20 chars) 🌟</p>
                     <span class="save-status" id="status_quiz_lc_q5"></span>
                  </div>
                 <p class="single-attempt-notice">Your answer is saved when you move away from the text area.</p>
                 <div class="essay-container">
                      <textarea name="q5" rows="5" placeholder="List and explain the key leadership qualities..." required minlength="20"></textarea>
                 </div>
                  <p class="question-error-message" id="error_q5"></p>
                  <!-- Save button removed -->
            </div>

            <!-- Final Submit Button Removed -->
             <p id="quizErrorMessage" class="error-message" aria-live="polite"></p>
             <!-- <button type="submit" class="submit-button" id="submitQuizButton">Submit Assessment</button> -->
             <!-- Display message or link when all are answered -->
             <div id="completionMessage" style="text-align:center; margin-top: 2rem; display: none;">
                 <p style="font-weight: 600; color: var(--success-green);">All answers saved! Proceed to the next step.</p>
                 <a href="dashboard.html" class="results-link" id="nextStepsLink" style="margin-top: 1rem; background-color: var(--primary-color);">Go to Dashboard</a>
             </div>


        </form>

        <!-- Results Area (Can be repurposed or removed if scoring isn't done here) -->
        <div id="resultsContainer" style="display: none;">
              <h3>Assessment Responses Recorded</h3>
              <p>Your responses have been saved.</p>
              <a href="dashboard.html" class="results-link">Return to Dashboard</a>
        </div>

    </main>

    <!-- Footer -->
    <footer class="footer">
        <span class="footer-text">© 2025 Elmenisy Leadership Coaching - All Rights Reserved</span>
         <div class="social-icons">
            <a href="https://www.linkedin.com/in/mohamedmenisy17/" target="_blank" rel="noopener noreferrer" aria-label="LinkedIn Profile"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg> </a>
            <a href="https://wa.me/201014527321" target="_blank" rel="noopener noreferrer" aria-label="WhatsApp Chat"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01s-.521.074-.792.372c-.272.296-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg> </a>
            <a href="https://www.instagram.com/mohamed_menisyy/profilecard/?igsh=d3ZwZDM4czRqMzB2" target="_blank" rel="noopener noreferrer" aria-label="Instagram Profile"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 1.172.053 1.905.33 2.46.538.7.268 1.192.64 1.64 1.092.45.447.83 1.004 1.093 1.64.208.555.485 1.288.538 2.46.058 1.265.07 1.646.07 4.85s-.012 3.584-.07 4.85c-.053 1.172-.33 1.905-.538 2.46-.268.7-.64 1.192-1.092 1.64-.447.45-.997.827-1.64 1.093-.555.208-1.288.485-2.46.538-1.265.058-1.646.07-4.85.07s-3.584-.012-4.85-.07c-1.172-.053-1.905-.33-2.46-.538-.697-.268-1.19-.64-1.64-1.093-.45-.447-.827-.997-1.093-1.64-.208-.555-.485-1.288-.538-2.46-.058-1.265-.07-1.646-.07-4.85s.012-3.584.07-4.85c.053-1.172.33-1.905.538-2.46.268-.697.64-1.19 1.093-1.64.45-.45.997-.827 1.64-1.093.555-.208 1.288.485 2.46.538 1.265-.058 1.646-.07 4.85-.07zm0-2.163c-3.259 0-3.667.014-4.947.072-1.356.06-2.31.344-3.174.732-.884.396-1.627.96-2.377 1.71-.755.752-1.318 1.494-1.716 2.378-.386.863-.67 1.818-.73 3.172C.014 8.333 0 8.741 0 12s.014 3.667.072 4.947c.06 1.356.344 2.31.73 3.174.396.884.96 1.627 1.716 2.377.752.755 1.494 1.318 2.378 1.716.863.386 1.818.67 3.172.73 1.28.058 1.688.072 4.947.072s3.667-.014 4.947-.072c1.356-.06 2.31-.344 3.174-.73.884-.396 1.627-.96 2.377-1.716.755-.752 1.318-1.494 1.716-2.378.386.863.67-1.818.73-3.172.058-1.28.072-1.688.072-4.947s-.014-3.667-.072-4.947c-.06-1.356-.344-2.31-.73-3.174-.396-.884-.96-1.627-1.716-2.377-.752-.755-1.494-1.318-2.378-1.716-.863-.386-1.818-.67-3.172-.73C15.667.014 15.259 0 12 0zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.162 6.162 6.162 6.162-2.759 6.162-6.162S15.403 5.838 12 5.838zm0 10.333c-2.306 0-4.171-1.865-4.171-4.171s1.865-4.171 4.171-4.171 4.171 1.865 4.171 4.171-1.865 4.171-4.171 4.171zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg> </a>
        </div>
    </footer>

    <script>
        // --- Supabase Configuration ---
        const SUPABASE_URL = 'https://lgcutmuspcaralydycmg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnY3V0bXVzcGNhcmFseWR5Y21nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0NDY3MDEsImV4cCI6MjA2MTAyMjcwMX0.3u5Y7pkH2NNnnoGLMWVfAa5b8fq88o1itRYnG1K38tE';
        let supabase = null;

        // --- Unified Keys & Configuration ---
        const LOGGED_IN_KEY = 'isUserLoggedIn';
        const CURRENT_USER_KEY = 'currentUser';
        const SIGNUP_FLAG_KEY = 'hasSignedUpBefore'; // Keep if used elsewhere

        // --- Quiz Specific Configuration ---
        const QUIZ_ID = 'pre_assessment_quiz'; // Unique ID for this specific quiz/section
        const SECTION_TITLE = 'Pre-Quiz: Leadership & Coaching';
        const SECTION_TYPE = 'quiz';
        const PAGE_NAME = 'pre.html'; // Assuming this file is named pre.html
        const MIN_ESSAY_LENGTH = 20;
        const DEBOUNCE_DELAY = 1000; // 1 second delay for saving textarea

        // --- DOM Element References ---
        let userNameDisplay, userEmailDisplay, mainContainer, quizForm,
            resultsContainer, // Keep results container if needed for other flows
            progressBarContainer, progressBar, progressText, questionBlocks, completionMessageDiv;

        // --- State Management ---
        let savedAnswers = {}; // Stores locally confirmed saved answers { questionId: answer }
        let totalQuestions = 0;
        let currentUser = null;
        let isSubmitted = false; // Flag to track if the overall assessment record exists
        let debounceTimer; // For textarea saving


        // Initialize Supabase Client
        try {
            if (window.supabase && window.supabase.createClient) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log("Supabase client initialized successfully on Pre-Assessment page.");
            } else { throw new Error("Supabase library not found."); }
        } catch (error) { console.error("CRITICAL ERROR initializing Supabase:", error); }

        // ***** ---> IMMEDIATE REDIRECTION LOGIC <--- *****
         console.log("%cPre-Assessment Page: Running IMMEDIATE redirection check...", "color: purple; font-weight: bold;");
         function quickCheckCurrentUser_pre() { try { const data = localStorage.getItem(CURRENT_USER_KEY); return data && JSON.parse(data).id; } catch { return false; } }
         const isLoggedIn_immediate_pre = localStorage.getItem(LOGGED_IN_KEY) === 'true' && quickCheckCurrentUser_pre();
         const currentPage_immediate_pre = window.location.pathname.split('/').pop() || PAGE_NAME;
         console.log(`Pre-Assessment Page IMMEDIATE Check: isLoggedIn=${isLoggedIn_immediate_pre}, currentPage=${currentPage_immediate_pre}`);
         if (!isLoggedIn_immediate_pre) {
             const targetUrl_pre = localStorage.getItem(SIGNUP_FLAG_KEY) === 'true' ? 'login.html' : 'signup.html'; // Determine target based on signup flag
             console.error(`%cPre-Assessment Page IMMEDIATE Redirect: Not logged in. Redirecting to ${targetUrl_pre}...`, "color: orange;");
             window.location.replace(targetUrl_pre);
             throw new Error("Redirecting user: Not logged in.");
         } else {
             console.log("%cPre-Assessment Page IMMEDIATE Check: User IS logged in. Proceeding.", "color: green;");
         }
         // ***** ---> END IMMEDIATE REDIRECTION LOGIC <--- *****


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async function() {
            console.log("%cPre-Assessment page: DOMContentLoaded event fired.", "color: green;");
            mainContainer = document.getElementById('mainContainer');

            if (!supabase) { /* ... (Keep Supabase init error handling) ... */ console.error("Supabase client failed to initialize. Stopping page load."); if (mainContainer) mainContainer.innerHTML = '<p class="error-message" style="display: block; text-align:center;">Connection Error. Cannot load assessment.</p>'; if(mainContainer) mainContainer.style.display = 'block'; return; }

            try {
                // Assign elements
                userNameDisplay = document.getElementById('userName');
                userEmailDisplay = document.getElementById('userEmail');
                quizForm = document.getElementById('quizForm');
                resultsContainer = document.getElementById('resultsContainer'); // Used to hide it
                progressBarContainer = document.getElementById('progressBarContainer');
                progressBar = document.getElementById('progressBar');
                progressText = document.getElementById('progressText');
                questionBlocks = quizForm.querySelectorAll('.question-block');
                completionMessageDiv = document.getElementById('completionMessage'); // Added

                if (!mainContainer || !quizForm /* ... other checks ... */ || !questionBlocks || questionBlocks.length === 0 || !completionMessageDiv) { throw new Error("Essential DOM elements for pre-assessment page not found!"); }

                totalQuestions = questionBlocks.length;
                console.log(`Total questions: ${totalQuestions}`);

                currentUser = getCurrentUser(); // Get user data
                if (!currentUser || !currentUser.id || !currentUser.email) { throw new Error("User data invalid or missing after DOM load."); }
                console.log(`%cPre-Assessment DOMContentLoaded: User verified (${currentUser.email}, ID: ${currentUser.id}). Initializing.`, "color: green;");

                await initializePageContent(currentUser); // Load data, check status, add listeners

                if(mainContainer) mainContainer.style.display = 'block';
                console.log("Pre-Assessment page initialized and displayed.");

            } catch (error) { /* ... (Keep critical error handling) ... */ console.error("CRITICAL ERROR during Pre-Assessment DOMContentLoaded or Initialization:", error); if(mainContainer){ mainContainer.innerHTML = `<p class="error-message" style="display: block; text-align:center;">An error occurred loading the assessment. Please refresh. Details: ${error.message}</p>`; mainContainer.style.display = 'block'; } else { document.body.innerHTML = `<p style="color: red; padding: 20px;">Critical Error: Page structure incomplete. (${error.message})</p>`; } }
        });

        // --- Initialize Page Content (Checks Submission Status) ---
        async function initializePageContent(user) {
            console.log("%cPre-Assessment page: Running initializePageContent()...", "color: blue;");
            displayUserInfo(user);

            // Check if this specific QUIZ_ID has been submitted in 'assessments' table
            console.log(`Checking Supabase if user ${user.id} submitted quiz ${QUIZ_ID} in assessments...`);
            try {
                const { data: assessmentRecord, error } = await supabase
                    .from('assessments') // Check the summary table first
                    .select('submitted_at')
                    .eq('user_id', user.id)
                    .eq('question_id', QUIZ_ID) // Use question_id as the unique ID for the assessment itself
                    .limit(1)
                    .maybeSingle();

                if (error) { console.error("Error checking assessments table:", error.message); /* Proceed assuming not submitted */ }

                isSubmitted = !!assessmentRecord; // Set global flag

                await loadAnswersFromSupabase(user.id); // Load individual answers regardless

                if (isSubmitted) {
                    console.log(`%cUser HAS already submitted this assessment (${QUIZ_ID}) on ${assessmentRecord?.submitted_at}. Disabling form.`, "color: purple; font-weight: bold;");
                    disableAllInputs();
                    if(completionMessageDiv) completionMessageDiv.style.display = 'block'; // Show completion message
                    if(progressBarContainer) progressBarContainer.style.display = 'none'; // Hide progress bar
                } else {
                    console.log("%cUser has not submitted this assessment yet. Enabling form interactions.", "color: green;");
                    addInputListeners(); // Add listeners for auto-save
                    if(completionMessageDiv) completionMessageDiv.style.display = 'none'; // Hide completion message
                }

                updateProgressBar(); // Update progress based on loaded answers

            } catch (dbError) {
                console.error("Database error during initialization:", dbError);
                showGlobalError("Error loading assessment status. Please refresh.");
                // Fallback: Assume not submitted, load local (though local isn't used now)
                addInputListeners();
                updateProgressBar();
            }
            console.log("initializePageContent() finished.");
        }

        // --- Load Answers from Supabase (user_progress) ---
        async function loadAnswersFromSupabase(userId) {
             console.log(`Fetching answers for user ${userId} and section ${QUIZ_ID} from user_progress...`);
             savedAnswers = {}; // Reset local state
             try {
                const { data, error } = await supabase
                    .from('user_progress')
                    .select('question_id, answer')
                    .eq('user_id', userId)
                    .eq('section_id', QUIZ_ID);

                if (error) throw error;

                if (data && data.length > 0) {
                    data.forEach(item => {
                        if (item.question_id && item.answer !== null) {
                            savedAnswers[item.question_id] = item.answer;
                            // Apply saved style immediately
                            const groupElement = getQuestionGroupElement(item.question_id);
                            if (groupElement) {
                                 groupElement.classList.add('saved');
                                 // Update status indicator if needed
                                 const statusEl = document.getElementById(`status_${item.question_id}`);
                                 if (statusEl) {
                                      statusEl.textContent = '✓ Saved';
                                      statusEl.className = 'save-status show saved';
                                 }
                            }
                        }
                    });
                    console.log("Answers loaded from Supabase:", savedAnswers);
                } else {
                    console.log("No answers found in user_progress for this quiz.");
                }

                // Populate form fields AFTER fetching
                populateFormFields();

             } catch (error) {
                  console.error("Error fetching answers from user_progress:", error.message);
                  showGlobalError("Error loading your previous answers.");
                  // Attempt to populate form even if fetch failed (might be empty)
                  populateFormFields();
             }
        }

        // --- Populate Form Fields from savedAnswers ---
        function populateFormFields() {
            questionBlocks.forEach(block => {
                const questionId = block.dataset.questionId;
                const questionType = block.dataset.questionType;
                const answer = savedAnswers[questionId]; // Get answer from global state

                if (answer !== undefined && answer !== null) {
                    if (questionType === 'mcq') {
                        const radioToCheck = block.querySelector(`input[value="${answer}"]`);
                        if (radioToCheck) radioToCheck.checked = true;
                    } else if (questionType === 'text') {
                        const textArea = block.querySelector('textarea');
                        if (textArea) textArea.value = answer;
                    }
                } else {
                     // Ensure fields are clear if no answer exists
                     if (questionType === 'mcq') { block.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false); }
                     else if (questionType === 'text') { block.querySelector('textarea').value = ''; }
                }
            });
            console.log("Form fields populated from savedAnswers state.");
        }

        // --- Disable All Inputs ---
        function disableAllInputs() {
            if (!quizForm) return;
            quizForm.querySelectorAll('input, textarea').forEach(input => {
                input.disabled = true;
            });
             questionBlocks.forEach(block => {
                 block.classList.add('submitted'); // Add submitted class
                 block.classList.remove('saved'); // Ensure saved class is removed
                 const statusEl = block.querySelector('.save-status');
                 if (statusEl) statusEl.style.display = 'none'; // Hide status indicator
             });
             console.log("All quiz inputs disabled.");
        }


        // --- Core User Functions (Keep as is) ---
        function getCurrentUser() { try { const userData = localStorage.getItem(CURRENT_USER_KEY); if (!userData) return null; const user = JSON.parse(userData); if (user && typeof user === 'object' && user.email && user.id) { if (!user.name) user.name = user.email.split('@')[0]; return user; } else { console.warn("Stored user data is invalid or missing ID. Clearing."); localStorage.removeItem(CURRENT_USER_KEY); localStorage.removeItem(LOGGED_IN_KEY); return null; } } catch (e) { console.error("Error parsing current user data:", e); localStorage.removeItem(CURRENT_USER_KEY); localStorage.removeItem(LOGGED_IN_KEY); return null; } }
        function displayUserInfo(currentUser) { try { let uN = 'User'; let uE = ''; if (currentUser) { uN = currentUser.name || currentUser.email.split('@')[0]; uE = currentUser.email || ''; } if (userNameDisplay) userNameDisplay.textContent = `Welcome, ${uN}`; if (userEmailDisplay) userEmailDisplay.textContent = uE; } catch (err) { console.error("Error in displayUserInfo:", err); if (userNameDisplay) userNameDisplay.textContent = 'Welcome'; if (userEmailDisplay) userEmailDisplay.textContent = ''; } }
        function logout() { try { localStorage.removeItem(LOGGED_IN_KEY); localStorage.removeItem(CURRENT_USER_KEY); console.log("User logged out, keys cleared."); window.location.href = 'login.html'; } catch (e) { console.error("Logout error:", e); window.location.href = 'login.html'; } }

        // --- Add Input Event Listeners for Auto-Save ---
        function addInputListeners() {
             console.log("Adding input listeners for auto-save...");
             questionBlocks.forEach(block => {
                 const questionId = block.dataset.questionId;
                 const questionType = block.dataset.questionType;
                 const inputs = block.querySelectorAll('input[type="radio"], textarea');

                 inputs.forEach(input => {
                      // Clear 'saved' visual style on input/change
                      input.addEventListener('input', () => {
                           const groupElement = getQuestionGroupElement(questionId);
                           if (groupElement) groupElement.classList.remove('saved');
                           const statusEl = document.getElementById(`status_${questionId}`);
                            if (statusEl) statusEl.className = 'save-status'; // Reset status text
                      });

                     if (input.type === 'radio') {
                         input.addEventListener('change', (e) => {
                             if (e.target.checked) {
                                 saveSingleAnswerToSupabase(questionId); // Save immediately on change
                             }
                         });
                     } else if (input.tagName === 'TEXTAREA') {
                         input.addEventListener('input', () => {
                             clearTimeout(debounceTimer); // Clear previous timer
                             const statusEl = document.getElementById(`status_${questionId}`);
                             if (statusEl) { // Show typing/pending status optionally
                                // statusEl.textContent = 'Typing...';
                                // statusEl.className = 'save-status show saving';
                             }
                             debounceTimer = setTimeout(() => {
                                 saveSingleAnswerToSupabase(questionId);
                             }, DEBOUNCE_DELAY);
                         });
                         // Also save on blur (leaving the textarea)
                         input.addEventListener('blur', () => {
                              clearTimeout(debounceTimer); // Clear timer if blur happens quickly
                              saveSingleAnswerToSupabase(questionId);
                         });
                     }
                 });
             });
        }

        // --- Save Single Answer to Supabase (user_progress) ---
        async function saveSingleAnswerToSupabase(questionId) {
             if (isSubmitted) return; // Don't save if already submitted overall
             if (!supabase || !currentUser || !currentUser.id) { console.error("Missing Supabase or user data for save."); showSaveStatus(questionId, 'Error!', 'error'); return; }

             const inputElement = document.querySelector(`[data-question-id="${questionId}"]`); // Could be textarea or fieldset
             const groupElement = getQuestionGroupElement(questionId);
             const labelElement = document.querySelector(`label[for="${questionId}"], fieldset[data-question-id="${questionId}"] legend`);
             const questionText = labelElement ? labelElement.textContent.trim().replace(/\(Min \d+ chars\)/gi, '').trim() : 'Unknown Question Text';

             let answerValue = null;
             let isValid = true;
             const errorMsgElement = document.getElementById(`error_${questionId}`);
             if(errorMsgElement) errorMsgElement.style.display = 'none'; // Hide previous error

             // Get value and validate
            const actualInputElement = inputElement.tagName === 'FIELDSET' ? inputElement.querySelector('input[type="radio"]:checked') : inputElement;
            if (!actualInputElement && inputElement.tagName === 'FIELDSET') {
                // Radio but none checked - this might be ok unless required, handle validation later if needed
                 answerValue = null;
                 //isValid = !inputElement.querySelector('input[required]'); // Check if required
                 isValid = true; // Allow saving null for radio if not required / just changed
             } else if (inputElement.tagName === 'FIELDSET') {
                 answerValue = actualInputElement.value;
                 isValid = true; // Radio is valid if selected
             } else if (inputElement.tagName === 'TEXTAREA') {
                 answerValue = inputElement.value; // Save potentially untrimmed for now
                 const trimmedValue = answerValue.trim();
                 const minLength = parseInt(inputElement.getAttribute('minlength') || '0', 10);
                 if (inputElement.hasAttribute('required') && !trimmedValue) {
                     showQuestionError("Please enter your answer.", errorMsgElement); isValid = false;
                 } else if (trimmedValue && minLength > 0 && trimmedValue.length < minLength) {
                     showQuestionError(`Answer must be at least ${minLength} characters long.`, errorMsgElement); isValid = false;
                 } else {
                      isValid = true; // Valid if not required or meets length
                 }
             } else {
                 console.warn("Unsupported input type for auto-save:", inputElement.tagName);
                 return; // Don't save for other types
             }

             if (!isValid) {
                 showSaveStatus(questionId, 'Invalid', 'error'); // Show validation error status
                 if(groupElement) groupElement.classList.remove('saved'); // Ensure saved style is removed
                 return; // Don't save invalid input
             }

             showSaveStatus(questionId, 'Saving...', 'saving');

             const recordData = {
                 user_id: currentUser.id,
                 question_id: questionId,
                 answer: answerValue, // Save the value
                 email: currentUser.email,
                 section_id: QUIZ_ID,
                 page: PAGE_NAME,
                 question_text: questionText,
                 section_type: SECTION_TYPE,
                 status: 'in_progress', // Mark as in_progress until final submit (if any)
                 updated_at: new Date()
             };

             try {
                 const { data, error } = await supabase
                    .from('user_progress')
                    .upsert(recordData, { onConflict: 'user_id, question_id' })
                    .select();

                 if (error) throw error;

                 console.log(`Auto-saved answer for ${questionId}`);
                 // Update local cache
                 savedAnswers[questionId] = answerValue;
                 // Don't save to localStorage anymore, rely on Supabase
                 // localStorage.setItem(LOCAL_ANSWERS_KEY, JSON.stringify(savedAnswers));

                 if(groupElement) groupElement.classList.add('saved');
                 showSaveStatus(questionId, '✓ Saved', 'saved');
                 updateProgressBar();
                 checkCompletion(); // Check if all questions are now answered

             } catch (error) {
                 console.error(`Error auto-saving answer for ${questionId}:`, error.message);
                 showSaveStatus(questionId, 'Error!', 'error');
                 if(groupElement) groupElement.classList.remove('saved'); // Remove style on error
             }
        }

        // --- Show Save Status ---
        function showSaveStatus(questionId, text, statusClass = 'saving') { // 'saving', 'saved', 'error'
             const statusEl = document.getElementById(`status_${questionId}`);
             if (statusEl) {
                 statusEl.textContent = text;
                 statusEl.className = `save-status show ${statusClass}`; // Apply class
                 // Don't auto-hide 'saving'
                 if (statusClass !== 'saving') {
                     setTimeout(() => {
                          // Only remove if it hasn't changed state again
                          if (statusEl.classList.contains(statusClass)) {
                              statusEl.classList.remove('show');
                          }
                     }, 3000); // Hide after 3 seconds
                 }
             }
        }

        // --- Update Progress Bar (Based on savedAnswers state) ---
        function updateProgressBar() {
            const answeredCount = Object.keys(savedAnswers).filter(qid => savedAnswers[qid] !== null && savedAnswers[qid] !== '').length; // Count non-empty answers
            const percentage = totalQuestions > 0 ? Math.round((answeredCount / totalQuestions) * 100) : 0;
            if (progressBar && progressText) {
                progressBar.style.width = `${percentage}%`;
                progressText.textContent = `${percentage}% Completed (${answeredCount}/${totalQuestions})`;
            }
        }

         // --- Check if all questions are answered ---
         function checkCompletion() {
             const answeredCount = Object.keys(savedAnswers).filter(qid => savedAnswers[qid] !== null && savedAnswers[qid] !== '').length;
             if (answeredCount === totalQuestions && completionMessageDiv) {
                 console.log("All questions answered!");
                 completionMessageDiv.style.display = 'block';
                 // Optionally, you could automatically trigger the final submission logic here
                 // handleFinalQuizSummarySubmission(); // If you want to auto-submit a summary record
             } else if (completionMessageDiv) {
                 completionMessageDiv.style.display = 'none';
             }
         }

         // --- OPTIONAL: Function to submit a final summary record to 'assessments' if needed ---
         // This would be called automatically by checkCompletion or manually via a (now hidden) button
         async function handleFinalQuizSummarySubmission() {
             if (isSubmitted) return; // Don't resubmit summary
             if (!supabase || !currentUser) return;

             console.log("Submitting final assessment summary record...");
             setButtonLoading(true, "Finalizing..."); // Use general loading state if needed

             // You might calculate a score here if needed, otherwise just mark as completed
             const submissionTime = new Date();
             const summaryPayload = {
                 user_id: currentUser.id,
                 question_id: QUIZ_ID, // The ID representing this entire quiz
                 type: SECTION_TYPE,
                 user_email: currentUser.email,
                 name: currentUser.name || currentUser.email.split('@')[0],
                 submitted_at: submissionTime.toISOString(),
                 completion_status: 'completed',
                 is_correct: 'n/a', // Or calculate pass/fail if scoring exists
                 score: null // Or calculated score
                 // Add other relevant summary fields if your 'assessments' table has them
             };

             try {
                 const { error } = await supabase
                     .from('assessments')
                     .upsert([summaryPayload], { onConflict: ['user_id', 'question_id', 'type'] }); // Adjust onConflict as needed

                 if (error) throw error;

                 console.log("Assessment summary submitted successfully.");
                 isSubmitted = true; // Mark as submitted locally
                 // Maybe update user table completion flag here too if needed for other parts of the app
                 // await supabase.from('users').update({ pre_assessment_completed: true }).eq('id', currentUser.id);

                 // Optional: Display final confirmation/results if not already done
                 // disableAllInputs();
                 // displayFinalConfirmation(); // A simpler confirmation message

             } catch (error) {
                 console.error("Error submitting assessment summary:", error);
                 showGlobalError(`Failed to finalize assessment: ${error.message}`);
             } finally {
                 setButtonLoading(false);
             }
         }


        // --- Utility Functions ---
        function showQuestionError(message, element) { if(element){element.textContent=message;element.style.display="block";} }
        function showGlobalError(message) { const errorElement = document.getElementById('quizErrorMessage'); if(errorElement){errorElement.innerHTML=message;errorElement.style.display="block";} console.error("Displayed Global Error:",message); }
        function hideGlobalError() { const errorElement = document.getElementById('quizErrorMessage'); if(errorElement)errorElement.style.display="none"; }
        function setButtonLoading(isLoading, text = 'Submit') { /* ... (Can be repurposed for other loading states if needed) ... */ }
        // Note: Removed displayFinalResults as scoring isn't done here anymore.
        // Note: Removed handleQuizSubmit as the final submit button is removed.

    </script>
</body>
</html>
