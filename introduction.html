<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Introduction to Coaching & Leadership</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- Global Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html { scroll-behavior: smooth; }
        body { margin: 0; padding: 0; line-height: 1.7; background-color: #f9f9f9; color: #333; }

        /* --- User Bar Styles --- */
        .user-bar { background-color: #34495e; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; color: white; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-info svg { opacity: 0.8; }
        .user-details { display: flex; flex-direction: column; }
        .user-name { font-weight: 600; font-size: 14px; }
        .user-email { font-size: 12px; opacity: 0.8; }
        .logout-button { background-color: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 6px; font-size: 13px; }
        .logout-button:hover { background-color: #c0392b; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .logout-button:active { transform: translateY(0); }

        /* --- Navigation Tabs --- */
        .nav-tab { background-color: #2c3e50; padding: 12px 10px; text-align: center; position: sticky; top: 0; z-index: 100; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; scrollbar-width: thin; scrollbar-color: #556a80 #2c3e50; }
        .nav-tab::-webkit-scrollbar { height: 6px; }
        .nav-tab::-webkit-scrollbar-track { background: #2c3e50; }
        .nav-tab::-webkit-scrollbar-thumb { background-color: #556a80; border-radius: 10px; border: 1px solid #2c3e50; }
        /* Adjusted padding for nav links */
        .nav-tab a { color: white; text-decoration: none; margin: 0 8px; padding: 8px 12px; /* Original */ border-radius: 6px; transition: background-color 0.3s, color 0.3s; font-size: 14px; display: inline-block; }
        .nav-tab a:hover, .nav-tab a.active { background-color: #34495e; color: #fff; }

        /* --- Main Content Styles --- */
        h1 { color: #fff; background-color: #e67e22; padding: 20px; border-radius: 8px; text-align: center; margin: 25px auto; max-width: 800px; font-size: 26px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .container {
            max-width: 800px;
            margin: 25px auto;
            background: white;
            padding: 30px; /* Original padding */
            padding-top: 40px; /* Increased top padding */
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        .quote { font-style: italic; border-left: 5px solid #e67e22; padding: 15px 20px; background-color: #fdfaf6; margin: 25px 0; color: #555; font-size: 15px; border-radius: 0 6px 6px 0; }
        .image-container { text-align: center; margin: 30px 0; }
        .image-container img { max-width: 100%; height: auto; border-radius: 8px; border: 1px solid #eee; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .image-container p { font-size: 14px; color: #555; margin-top: 10px; font-style: normal; }
        .tip-box, .action-box { padding: 20px; border-radius: 6px; margin: 25px 0; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left-width: 5px; border-left-style: solid; }
        .tip-box strong, .action-box strong { display: block; margin-bottom: 8px; font-size: 16px; }
        .tip-box { background-color: #3498db; border-left-color: #2980b9; }
        .action-box { background-color: #e67e22; border-left-color: #d35400; }
        .question-box { background-color: rgba(230, 126, 34, 0.07); padding: 25px; border-radius: 6px; margin: 25px 0; border: 1px solid rgba(230, 126, 34, 0.2); }
        .question-box h3 { margin-bottom: 15px; color: #34495e; font-size: 18px; }
        .question-box h3 .highlight { color: #e74c3c; font-weight: bold; font-size: 1em; margin-left: 2px; }
        textarea, input[type="text"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; margin-top: 8px; margin-bottom: 10px; resize: vertical; min-height: 100px; font-size: 15px; transition: border-color 0.3s, box-shadow 0.3s; }
        textarea:focus, input[type="text"]:focus { border-color: #e67e22; outline: 0; box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.2); }
        /* Added style for disabled textarea */
        textarea:disabled { background-color: #f8f9fa; cursor: not-allowed; color: #6c757d; }
        table { width: 100%; border-collapse: collapse; margin: 25px 0; font-size: 14px; background-color: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        table th, table td { border: 1px solid #dee2e6; padding: 12px; text-align: left; }
        table th { background-color: #f8f9fa; font-weight: 600; color: #495057; }
        table tr:nth-child(even) { background-color: #f8f9fa; }
        .highlight-section, .skills-list, .ei-elements, .trust-methods { padding: 20px; border-radius: 6px; margin: 25px 0; font-size: 15px; border-left-width: 5px; border-left-style: solid; }
        .highlight-section { background-color: rgba(52, 152, 219, 0.1); border-left-color: #3498db;}
        .skills-list { background-color: rgba(46, 204, 113, 0.1); border-left-color: #2ecc71; }
        .skills-list ul { margin-top: 10px; margin-left: 25px; list-style: disc; }
        .skills-list li { margin-bottom: 8px; }
        .ei-elements { background-color: rgba(155, 89, 182, 0.1); border-left-color: #9b59b6; }
        .trust-methods { background-color: rgba(41, 128, 185, 0.1); border-left-color: #2980b9; }
        .save-button, .delete-button { color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-top: 8px; transition: all 0.3s ease; font-size: 14px; font-weight: 500; box-shadow: none; }
        .save-button { background-color: #27ae60; }
        .delete-button { background-color: #e74c3c; margin-left: 10px;}
        .save-button:hover:not(:disabled) { background-color: #2ecc71; transform: translateY(-1px); }
        .delete-button:hover:not(:disabled) { background-color: #c0392b; transform: translateY(-1px); }
        .save-button:active, .delete-button:active { transform: translateY(0); }
        /* Added styles for disabled buttons */
        .save-button:disabled, .delete-button:disabled { background-color: #bdc3c7; cursor: not-allowed; transform: none; box-shadow: none; }
        .button-group { display: flex; align-items: center; gap: 8px; margin-top: 10px; }
        .save-status { font-size: 13px; color: #27ae60; margin-left: 5px; font-weight: 500; display: none; }
        .save-status.deleted { color: #6c757d; }
        .error-message { color: #e74c3c; font-size: 13px; margin-left: 5px; font-weight: 500; display: none; }
        .required-field { border: 2px solid #e74c3c !important; background-color: #fff2f1 !important; box-shadow: none !important; }
        .navigation-buttons { display: flex; justify-content: space-between; margin-top: 40px; gap: 15px; border-top: 1px solid #eee; padding-top: 25px; }
        .navigation-buttons a { text-decoration: none; padding: 12px 20px; color: white; border-radius: 4px; font-weight: 600; flex: 1; text-align: center; transition: all 0.3s ease; box-shadow: none; font-size: 15px; }
        .navigation-buttons a:first-child { background-color: #6c757d; }
        .navigation-buttons a#nextButton { background-color: #e67e22; }
        .navigation-buttons a:hover { transform: translateY(-1px); filter: brightness(110%); }
        .navigation-buttons a:active { transform: translateY(0); filter: brightness(100%); }
        .floating-warning { background-color: #fff8e1; border-left: 5px solid #ffc107; padding: 15px 25px; color: #333; display: none; position: fixed; top: 75px; left: 50%; transform: translateX(-50%); z-index: 1001; border-radius: 6px; box-shadow: 0 3px 10px rgba(0,0,0,0.2); animation: slideDownFadeIn 0.4s ease-out; font-weight: 500; max-width: 90%; width: auto; min-width: 300px; text-align: center; }
        @keyframes slideDownFadeIn { from { opacity: 0; top: 50px; } to { opacity: 1; top: 75px; } }
        @keyframes fadeOutUp { from { opacity: 1; top: 75px;} to { opacity: 0; top: 50px;} }
        .highlight { color: #e67e22; font-weight: 600; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }

        /* --- Progress Bar Styles (Per Question) --- */
        .question-progress-container {
            margin-top: 15px;
            background-color: #ecf0f1;
            border-radius: 5px;
            overflow: hidden;
            height: 12px;
            width: 100%;
            display: none; /* Hidden by default */
        }
        .question-progress-bar {
            height: 100%;
            width: 0%; /* Will be set to 100% on save */
            background: linear-gradient(90deg, #2ecc71, #27ae60); /* Green gradient for completion */
            border-radius: 5px;
            transition: width 0.6s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .question-progress-text {
            font-size: 9px;
            font-weight: 600;
            color: white;
            text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.2);
            white-space: nowrap;
            overflow: hidden;
            padding: 0 4px;
        }
        .required-star { color: #e74c3c; font-weight: bold; margin-left: 2px; }

        /* --- Responsive Adjustments --- */
        @media (max-width: 768px) {
            h1 { font-size: 22px; padding: 15px; margin: 20px 15px; }
            .container { padding: 20px; padding-top: 30px; /* Adjust mobile top padding */ margin: 20px 15px; }
            .user-bar { padding: 10px 15px; font-size: 13px; }
            .user-name { font-size: 13px; }
            .user-email { font-size: 11px; }
            .logout-button { padding: 7px 12px; font-size: 12px; }
            .nav-tab { padding: 10px 5px; }
            .nav-tab a { margin: 0 5px; padding: 7px 10px; font-size: 13px;}
            .quote, .tip-box, .action-box, .question-box, .highlight-section, .skills-list { padding: 15px; margin: 20px 0; }
            .question-box h3 { font-size: 16px;}
            textarea, input[type="text"] { font-size: 14px; min-height: 80px;}
            .navigation-buttons { flex-direction: column; padding-top: 20px; margin-top: 30px; }
            .navigation-buttons a { font-size: 14px; padding: 12px 15px;}
            .floating-warning { padding: 12px 20px; font-size: 14px; top: 65px; width: calc(100% - 30px); max-width: 400px; }
            @keyframes slideDownFadeIn { from { opacity: 0; top: 45px; } to { opacity: 1; top: 65px; } }
            @keyframes fadeOutUp { from { opacity: 1; top: 65px;} to { opacity: 0; top: 45px;} }
        }
    </style>
</head>
<body>
    <!-- User Info Bar -->
    <header class="user-bar">
        <div class="user-info">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <div class="user-details">
                <span class="user-name" id="userName">Welcome back</span>
                <span class="user-email" id="userEmail">user@example.com</span>
            </div>
        </div>
        <button class="logout-button" onclick="logout()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            Logout
        </button>
    </header>

    <!-- Navigation Tabs (Reordered) -->
    <nav class="nav-tab">
        <a href="dashboard.html">Dashboard</a>
        <a href="index.html">Home</a>
        <a href="introduction.html" class="active">Introduction</a> <!-- Mark as active -->
        <a href="coaching-skills.html">Coaching Skills</a>
        <a href="coaching-individuals.html">Coaching Individuals</a>
        <a href="coaching-team.html">Team Coaching</a>
        <a href="coaching-yourself.html">Self Coaching</a>
        <a href="action-plan.html">Action Plan</a>
        <a href="ass.html">Assessment</a>
    </nav>

    <main>
        <h1>Introduction to Coaching & Leadership</h1>

        <div class="floating-warning" id="warningMessage">
            <strong>Action Required:</strong> Please complete all required questions before proceeding.
        </div>

        <div class="container">
            <div class="highlight-section"> <!-- Using style from Skills page -->
                <p>Coaching skills are a valuable asset for any manager. A study by Deloitte found that leaders who frequently coached their teams improved their business results by <span class="highlight">21 percent</span>. So, it's no surprise that an increasing number of workplaces consider coaching to be a worthwhile investment. In a survey by the Conference Board Council, 61 percent of the participating organizations used some form of internal coaching.</p>
            </div>

            <div class="quote">
                <p>"I haven't got time for coaching! And who needs it, anyway?"</p>
                <p>If this is your first reaction to what might feel like just another burdensome task, read on. Coaching is an investment that pays dividends.</p>
            </div>

            <div class="image-container">
                 <img src="https://images.unsplash.com/photo-1556761175-5973dc0f32e7?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1032&q=80"
                      alt="Diverse team members collaborating around a laptop in a modern office setting, representing coaching and teamwork."
                      onerror="this.onerror=null; this.src='https://via.placeholder.com/800x450/ffa726/ffffff?text=Coaching+Illustration';">
                 <p>Effective coaching fosters collaboration, improves performance, and supports individual growth.</p>
            </div>

            <h2>The Impact of Coaching</h2>
            <p>One reason for this increase is that people who receive coaching can reap considerable benefits. Research by PwC found that, of the participants who had received coaching:</p>

            <ul style="list-style: disc; margin-left: 25px; margin-bottom: 15px;"> <!-- Added list styling -->
                <li><strong>80%</strong> had increased self-confidence.</li>
                <li><strong>73%</strong> had improved relationships.</li>
                <li><strong>72%</strong> had improved communication skills.</li>
                <li><strong>67%</strong> reported a better work-life balance.</li>
            </ul>

            <p>Numbers like these will likely appeal to any leader, in any industry! But, despite the evidence that effective coaching can make a difference, most managers have very little training in how to do it. The good news is that <span class="highlight">coaching is a skill that you can learn</span>.</p>

            <h2 style="color:#e67e22;">What Will Coaching Do for Me and My Team?</h2> <!-- Added highlight color to heading -->

            <p>We'll tell you right now, coaching isn't always easy – at least, not if you want to do it well. However, it can be a rewarding and inspiring experience, especially when you see your team members develop and succeed. When you coach effectively, you may find that your job satisfaction increases, too, and you have a deeper sense of purpose and meaning at work. What's more, you'll likely strengthen your relationship with your team, building trust and rapport.</p>

            <div class="skills-list"> <!-- Using style from Skills page -->
                <p><strong>This course will guide you through the essential coaching skills. You will learn:</strong></p>
                <ul>
                    <li>How to develop core coaching competencies like active listening, powerful questioning, emotional intelligence, and building trust.</li>
                    <li>Effective frameworks and techniques for coaching individual team members towards their goals.</li>
                    <li>Strategies for fostering a coaching culture and coaching your team collectively.</li>
                    <li>Techniques for applying coaching principles to your own development (self-coaching).</li>
                    <li>How to create a practical action plan to implement your learnings.</li>
                </ul>
            </div>

            <p>By working through the exercises in each section, you'll gain a deeper understanding of the topic and reinforce what you've learned. But first, let's address those time pressures. Consider how a small investment now in effective, targeted coaching can save you and your team large amounts of time and effort in the future. Purpose and enthusiasm will grow, errors will decrease, and loyalty and collaboration will build. And you'll likely find yourself dealing with less conflict, and delegating more effectively.</p>

            <div class="tip-box"> <!-- Using style from Skills page -->
                <strong>TIP: Assess Your Skills</strong><br>
                For more insight into your current coaching skills, and for advice and guidance on how to develop your people effectively, consider taking an online assessment or reflecting on past experiences where you've guided others. (Placeholder for potential link/quiz)
            </div>

            <div class="action-box"> <!-- Using style from Skills page -->
                <strong>ACTION: Prioritize Your Time</strong><br>
                Effective coaching requires dedicated time. Explore time management techniques (like time blocking or prioritization matrices) to carve out space for these important conversations. Protect this time to focus on developing your team.
            </div>

            <!-- Interactive Questions -->
            <h2 style="margin-top: 40px;">Reflection Questions</h2>

            <!-- Question 1 -->
            <div class="question-box" id="question-container-intro_q1"> <!-- Unique ID including page -->
                <h3>1. In your opinion, what are the top 3 qualities or behaviors of a great coach?<span class="required-star">*</span></h3>
                <label for="intro_q1" class="sr-only">Answer for question 1</label>
                <textarea id="intro_q1" placeholder="e.g., Active listening, empathy, providing constructive feedback..." class="required-answer" data-question="intro_q1" aria-describedby="error-intro_q1"></textarea>
                <div class="button-group">
                    <button class="save-button" onclick="saveAnswer('intro_q1')">Save</button>
                    <button class="delete-button" onclick="deleteAnswer('intro_q1')">Delete</button>
                    <!-- Removed save-status span -->
                    <span class="error-message" id="error-intro_q1"></span>
                </div>
                 <!-- Progress Bar HTML (Uncommented) -->
                 <div class="question-progress-container" id="progress-container-intro_q1">
                    <div class="question-progress-bar" id="progress-bar-intro_q1">
                         <span class="question-progress-text" id="progress-text-intro_q1">✔️ Completed</span> <!-- Static text -->
                     </div>
                </div>
            </div>

            <!-- Question 2 -->
            <div class="question-box" id="question-container-intro_q2"> <!-- Unique ID including page -->
                <h3>2. Reflecting on the qualities above, which coaching skills do you believe you already possess or use effectively?<span class="required-star">*</span></h3>
                 <label for="intro_q2" class="sr-only">Answer for question 2</label>
                <textarea id="intro_q2" placeholder="Be specific, e.g., 'I am good at giving clear instructions' or 'I try to listen without interrupting'..." class="required-answer" data-question="intro_q2" aria-describedby="error-intro_q2"></textarea>
                <div class="button-group">
                    <button class="save-button" onclick="saveAnswer('intro_q2')">Save</button>
                    <button class="delete-button" onclick="deleteAnswer('intro_q2')">Delete</button>
                     <!-- Removed save-status span -->
                    <span class="error-message" id="error-intro_q2"></span>
                </div>
                 <!-- Progress Bar HTML (Uncommented) -->
                 <div class="question-progress-container" id="progress-container-intro_q2">
                    <div class="question-progress-bar" id="progress-bar-intro_q2">
                         <span class="question-progress-text" id="progress-text-intro_q2">✔️ Completed</span> <!-- Static text -->
                     </div>
                </div>
            </div>

            <!-- Question 3 -->
            <div class="question-box" id="question-container-intro_q3"> <!-- Unique ID including page -->
                <h3>3. Which 1-2 coaching skills mentioned in the course outline (or from your list in Q1) would you most like to develop further?<span class="required-star">*</span></h3>
                 <label for="intro_q3" class="sr-only">Answer for question 3</label>
                <textarea id="intro_q3" placeholder="e.g., Asking more open-ended questions, building trust faster..." class="required-answer" data-question="intro_q3" aria-describedby="error-intro_q3"></textarea>
                <div class="button-group">
                    <button class="save-button" onclick="saveAnswer('intro_q3')">Save</button>
                    <button class="delete-button" onclick="deleteAnswer('intro_q3')">Delete</button>
                     <!-- Removed save-status span -->
                    <span class="error-message" id="error-intro_q3"></span>
                </div>
                 <!-- Progress Bar HTML (Uncommented) -->
                 <div class="question-progress-container" id="progress-container-intro_q3">
                    <div class="question-progress-bar" id="progress-bar-intro_q3">
                         <span class="question-progress-text" id="progress-text-intro_q3">✔️ Completed</span> <!-- Static text -->
                     </div>
                </div>
            </div>
            <p style="font-size: 13px; color: #6c757d; margin-top: 5px;"><span class="highlight" style="color:#e74c3c">*</span> Required field to proceed</p>


            <!-- Navigation Buttons -->
            <div class="navigation-buttons">
                <a href="index.html" class="nav-button">← Back to Home</a>
                <a href="coaching-skills.html" class="nav-button" id="nextButton">Next: Core Coaching Skills →</a>
            </div>
        </div><!-- /.container -->
    </main>

    <script>
        // --- Supabase Configuration ---
        const SUPABASE_URL = 'https://lgcutmuspcaralydycmg.supabase.co'; // Replace with your Supabase URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnY3V0bXVzcGNhcmFseWR5Y21nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0NDY3MDEsImV4cCI6MjA2MTAyMjcwMX0.3u5Y7pkH2NNnnoGLMWVfAa5b8fq88o1itRYnG1K38tE'; // Replace with your Anon Key
        let supabase = null;

        // --- Configuration ---
        // REMOVED: const formspreeEndpoint = '...';
        const localStorageKeyPrefix = 'courseAnswers_'; // Prefix for local storage keys
        const currentPageKey = 'introduction'; // Specific key part for this page (matches SECTION_ID)
        const localStorageKey = `${localStorageKeyPrefix}${currentPageKey}`; // Full key: courseAnswers_introduction
        const SECTION_ID = 'introduction'; // Unique ID for progress tracking
        const PAGE_NAME = 'introduction.html'; // Page name for Supabase

        // --- Unified Keys ---
        const LOGGED_IN_KEY = 'isUserLoggedIn';
        const CURRENT_USER_KEY = 'currentUser';

        // Initialize Supabase Client
        try {
            if (window.supabase && window.supabase.createClient) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log("Supabase client initialized successfully on Introduction page.");
            } else { throw new Error("Supabase library not found."); }
        } catch (error) { console.error("CRITICAL ERROR initializing Supabase:", error); }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            if (!supabase) {
                console.error("Supabase client failed to initialize. Some features might not work.");
                // Optionally display an error to the user
            }

            const currentUser = getCurrentUser();
            if (!currentUser || !currentUser.email || !currentUser.id) { // Check for ID as well
                console.error("User not logged in or essential data missing. Redirecting...");
                 // Redirect Loop Prevention
                 if (!window.location.search.includes('redir_attempt')) {
                     window.location.href = `login.html?redirect=${encodeURIComponent(window.location.pathname + window.location.search)}&redir_attempt=1`;
                 } else {
                     console.error("REDIRECTION LOOP DETECTED. Stopping redirect.");
                     document.body.innerHTML = '<p style="color: red; padding: 20px;">Login check failed repeatedly. Please clear cache/cookies and try again.</p>';
                 }
                return;
            }
            console.log("Current User:", currentUser); // Log user data for debugging
            displayUserInfo(currentUser);
            loadUserAnswers(currentUser); // Pass full user object
            setupEventListeners(currentUser); // Pass full user object
            highlightActiveNav();
        });

        // --- User Info & Authentication ---
        function getCurrentUser() {
             try {
                const data = localStorage.getItem(CURRENT_USER_KEY);
                if (!data) { console.warn("getCurrentUser: No user data found."); return null; }
                const parsedData = JSON.parse(data);
                // Ensure critical fields exist
                if (parsedData && typeof parsedData === 'object' && parsedData.email && parsedData.id) {
                    // Ensure name exists, default if not
                    if (!parsedData.name) parsedData.name = parsedData.email.split('@')[0];
                    // Ensure progress object exists
                    if (typeof parsedData.progress !== 'object' || parsedData.progress === null) { parsedData.progress = {}; }
                    return parsedData;
                } else {
                    console.warn("getCurrentUser: Invalid or incomplete user data found (missing email or id), clearing.");
                    localStorage.removeItem(CURRENT_USER_KEY); localStorage.removeItem(LOGGED_IN_KEY); return null;
                }
            } catch (e) {
                console.error("getCurrentUser: Error parsing user data:", e);
                localStorage.removeItem(CURRENT_USER_KEY); localStorage.removeItem(LOGGED_IN_KEY); return null;
            }
        }

        function saveCurrentUser(userObject) {
             try {
                 if (!userObject || typeof userObject !== 'object') throw new Error("Invalid user object for saving.");
                 localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(userObject));
                 console.log("Saved updated currentUser data to localStorage.");
             } catch (error) { console.error("Error saving current user data:", error); }
         }

        function displayUserInfo(user) {
            if (!user) return;
            document.getElementById('userName').textContent = `Welcome, ${user.name || 'User'}`;
            document.getElementById('userEmail').textContent = user.email || 'No email';
        }

        function logout() {
            localStorage.removeItem(LOGGED_IN_KEY);
            localStorage.removeItem(CURRENT_USER_KEY);
            window.location.href = 'login.html';
        }

        function highlightActiveNav() {
             const currentPath = window.location.pathname.split('/').pop() || PAGE_NAME; // Use PAGE_NAME
             document.querySelectorAll('.nav-tab a').forEach(link => {
                 const linkPath = link.getAttribute('href');
                 const linkFilename = linkPath.split('/').pop();
                 link.classList.toggle('active', linkFilename === currentPath);
             });
         }

        // --- Answer Handling (Local Storage & UI Locking) ---
        function loadUserAnswers(currentUser) {
             if (!currentUser || !currentUser.email) return;
             let allAnswers = {};
             try {
                 const storedData = localStorage.getItem(localStorageKey);
                 if (storedData) { allAnswers = JSON.parse(storedData) || {}; }
             } catch(e) { console.error("Error parsing stored answers:", e); }

             const userAnswers = allAnswers[currentUser.email] || {};
             let answeredCount = 0;
             const requiredFields = document.querySelectorAll('.required-answer');

             requiredFields.forEach(field => {
                 const questionId = field.getAttribute('data-question');
                 const questionContainer = document.getElementById(`question-container-${questionId}`);
                 const saveButton = questionContainer?.querySelector('.save-button');
                 const deleteButton = questionContainer?.querySelector('.delete-button');
                 const savedAnswer = userAnswers[questionId]; // Check local storage first

                 if (savedAnswer !== undefined && savedAnswer.trim() !== '') {
                     field.value = savedAnswer;
                     field.disabled = true; // Disable field
                     field.classList.remove('required-field');
                     hideError(`error-${questionId}`);
                     if (saveButton) {
                         saveButton.disabled = true;
                         saveButton.textContent = 'Saved ✔️';
                     }
                     if (deleteButton) {
                         deleteButton.disabled = true;
                         deleteButton.style.display = 'none'; // Hide delete button
                     }
                     showQuestionProgressBar(questionContainer); // Show progress bar (always 100%)
                     answeredCount++;
                 } else {
                     // Ensure fields are enabled if no answer is found
                     field.value = '';
                     field.disabled = false;
                     if (saveButton) {
                         saveButton.disabled = false;
                         saveButton.textContent = 'Save';
                     }
                     if (deleteButton) {
                         deleteButton.disabled = false;
                         deleteButton.style.display = 'inline-block'; // Show delete button
                     }
                     hideQuestionProgressBar(questionContainer); // Hide progress bar
                     hideError(`error-${questionId}`);
                 }
             });

              updateSectionProgress(SECTION_ID); // Calculate initial progress based on loaded state
        }

        function saveAnswerToStorage(userEmail, questionId, answer) {
            // Keep this function to maintain local state consistency for navigation checks
            if (!userEmail) return false;
             let allAnswers = {};
             try {
                 const storedData = localStorage.getItem(localStorageKey);
                 if (storedData) { allAnswers = JSON.parse(storedData) || {}; }
             } catch(e) { console.error("Error parsing stored answers before saving:", e); allAnswers = {}; }
            if (!allAnswers[userEmail]) { allAnswers[userEmail] = {}; }
            allAnswers[userEmail][questionId] = answer;
            try { localStorage.setItem(localStorageKey, JSON.stringify(allAnswers)); return true; }
            catch (error) { console.error("Error saving to localStorage:", error); return false; }
        }

        function deleteAnswerFromStorage(userEmail, questionId) {
            // Keep this function to allow clearing before the *first* save
            if (!userEmail) return false;
             let allAnswers = {};
             try {
                 const storedData = localStorage.getItem(localStorageKey);
                 if (storedData) { allAnswers = JSON.parse(storedData) || {}; } else { return false; }
             } catch(e) { console.error("Error parsing stored answers before deleting:", e); return false; }
             let updated = false;
             if (allAnswers[userEmail]?.[questionId] !== undefined) {
                 delete allAnswers[userEmail][questionId]; updated = true;
                 if (Object.keys(allAnswers[userEmail]).length === 0) { delete allAnswers[userEmail]; }
             }
             if(updated) {
                try { localStorage.setItem(localStorageKey, JSON.stringify(allAnswers)); return true; }
                catch (error) { console.error("Error saving to localStorage after delete:", error); return false; }
             }
             return false;
        }

        // --- Event Listeners Setup ---
        function setupEventListeners(currentUser) {
             const nextButton = document.getElementById('nextButton');
             if(nextButton) {
                 nextButton.addEventListener('click', function(e) {
                    if (!validateAllAnswers(true)) {
                        e.preventDefault();
                        showWarningMessage();
                    }
                 });
             }
             document.querySelectorAll('.required-answer').forEach(field => {
                 field.addEventListener('input', () => {
                     // Only remove red border on input, don't affect save status
                     if (field.value.trim() !== '') {
                          field.classList.remove('required-field');
                          hideError(`error-${field.getAttribute('data-question')}`);
                     }
                 });
             });
        }

        // --- UI Feedback & Validation ---
        function validateAllAnswers(showErrors = false) {
            let allAnswered = true;
            let firstEmptyField = null;
            document.querySelectorAll('.required-answer').forEach(field => {
                const questionId = field.getAttribute('data-question');
                const errorId = `error-${questionId}`;
                 // Check if the field is enabled AND empty
                if (!field.disabled && field.value.trim() === '') {
                    allAnswered = false;
                    if (!firstEmptyField) firstEmptyField = field;
                    if (showErrors) {
                        field.classList.add('required-field');
                        showError(errorId, field); // Show error next to the field
                    }
                } else if (!field.disabled) { // If enabled and not empty, clear error
                     field.classList.remove('required-field');
                     hideError(errorId);
                } else { // If disabled (already saved), ensure no error is shown
                     field.classList.remove('required-field');
                     hideError(errorId);
                }
            });
            if (!allAnswered && showErrors && firstEmptyField) {
                 firstEmptyField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                 setTimeout(() => firstEmptyField.focus({ preventScroll: true }), 400);
            }
             console.log("Validation result:", allAnswered);
            return allAnswered;
        }

        function showWarningMessage() { /* ... (remains same) ... */
            const warningElement = document.getElementById('warningMessage'); if (!warningElement) return; warningElement.style.animation = 'none'; void warningElement.offsetWidth; warningElement.style.display = 'block'; warningElement.style.animation = 'slideDownFadeIn 0.4s ease-out'; clearTimeout(warningElement.timer); warningElement.timer = setTimeout(() => { warningElement.style.animation = 'fadeOutUp 0.5s ease-out forwards'; setTimeout(() => { if (warningElement.style.animationName === 'fadeOutUp') { warningElement.style.display = 'none'; warningElement.style.animation = ''; } }, 500); }, 4000);
        }
        // Removed showSaveStatus function as it's replaced by button state
        // Removed hideSaveStatus function
        function showError(errorId, field, message = 'This field is required.') { /* ... (remains same) ... */
             const errorElement = document.getElementById(errorId); if (!errorElement) return; errorElement.textContent = message; errorElement.style.color = '#e74c3c'; errorElement.style.display = 'inline-block';
        }
        function hideError(errorId) { /* ... (remains same) ... */
             const errorElement = document.getElementById(errorId); if (!errorElement) return; errorElement.style.display = 'none';
         }
         function hideMessages(errorId, field) { // Simplified helper
             hideError(errorId);
             if (field) field.classList.remove('required-field');
         }

        // --- Actions (Save, Delete) triggered by buttons ---
        // Make saveAnswer and deleteAnswer globally accessible
        window.saveAnswer = async function(questionId) { // Made async
            if (!supabase) { alert('Database connection error. Cannot save.'); return; }

            const currentUser = getCurrentUser();
            if (!currentUser || !currentUser.email || !currentUser.id) { alert('Session expired. Please login again.'); window.location.href = 'login.html'; return; }

            const questionContainer = document.getElementById(`question-container-${questionId}`);
            const field = questionContainer?.querySelector(`.required-answer[data-question="${questionId}"]`);
            const errorId = `error-${questionId}`;
            const saveButton = questionContainer?.querySelector('.save-button');
            const deleteButton = questionContainer?.querySelector('.delete-button');

            if (!field || !questionContainer || !saveButton || !deleteButton) {
                console.error("Required elements not found for", questionId);
                return;
            }

            // Prevent saving if already disabled
            if (field.disabled) {
                console.warn("Attempted to save an already saved/disabled question:", questionId);
                return;
            }

            const answer = field.value;
            const trimmedAnswer = answer.trim();

            hideMessages(errorId, field); // Clear previous errors

            if (!trimmedAnswer) { // Required field validation
                field.classList.add('required-field');
                showError(errorId, field);
                hideQuestionProgressBar(questionContainer); // Hide bar if validation fails
                return; // Stop if validation fails
            }

            // Disable buttons immediately for feedback
            saveButton.disabled = true;
            saveButton.textContent = 'Saving...';
            deleteButton.disabled = true;

            // --- Supabase Interaction ---
            try {
                const h3 = questionContainer.querySelector('h3');
                const questionText = h3 ? h3.textContent.replace('*','').trim() : 'Unknown Question Text';
                const submissionTime = new Date().toISOString();

                const userProgressPayload = {
                    user_id: currentUser.id,
                    email: currentUser.email,
                    question_id: questionId, // e.g., intro_q1
                    question_text: questionText,
                    answer: answer, // Save the full answer, not just trimmed
                    page: PAGE_NAME,
                    status: 'completed',
                    submitted_at: submissionTime,
                    updated_at: submissionTime,
                    section_type: 'article', // Specific type for articles
                    section_id: SECTION_ID, // e.g., 'introduction'
                    section_title: document.title || 'Introduction to Coaching & Leadership',
                    progress_percentage: 100, // Mark question as complete
                    score: null, // Not applicable for reflection questions
                    is_passed: null // Not applicable
                };

                console.log("Attempting to upsert to user_progress:", userProgressPayload);

                const { data, error } = await supabase
                    .from('user_progress')
                    .upsert([userProgressPayload], { onConflict: ['user_id', 'question_id'] }) // Assumes this is the unique constraint
                    .select();

                if (error) {
                    throw new Error(`Supabase error: ${error.message}`);
                }

                console.log("Supabase upsert successful:", data);

                // --- Update UI on SUCCESS ---
                field.disabled = true; // Lock the textarea
                saveButton.textContent = 'Saved ✔️'; // Confirm save on button
                // Keep save button disabled
                deleteButton.style.display = 'none'; // Hide delete button permanently

                saveAnswerToStorage(currentUser.email, questionId, answer); // Update local storage
                updateSectionProgress(SECTION_ID); // Update overall progress
                showQuestionProgressBar(questionContainer); // Show the 100% progress bar

                // REMOVED: Formspree call
                // submitToFormspree(currentUser.email, questionId, answer);

            } catch (error) {
                console.error(`Failed to save answer for ${questionId}:`, error);
                showError(errorId, field, `Save failed: ${error.message}`);
                // Re-enable buttons on failure
                saveButton.disabled = false;
                saveButton.textContent = 'Save';
                deleteButton.disabled = false;
            }
        };

        window.deleteAnswer = function(questionId) {
            // This function now only clears the field *before* the first save attempt.
            const currentUser = getCurrentUser();
             if (!currentUser || !currentUser.email) { alert('Session expired. Please login again.'); window.location.href = 'login.html'; return; }

            const questionContainer = document.getElementById(`question-container-${questionId}`);
            const field = questionContainer?.querySelector(`.required-answer[data-question="${questionId}"]`);
            const errorId = `error-${questionId}`;
            const saveButton = questionContainer?.querySelector('.save-button');
            const deleteButton = questionContainer?.querySelector('.delete-button');

            if (!field || field.disabled) { // Do nothing if field doesn't exist or is already saved/disabled
                 console.warn("Cannot delete: Field not found or already saved", questionId);
                 return;
            }

            hideMessages(errorId, field);
            field.value = '';

            // Remove from local storage if it existed there
            deleteAnswerFromStorage(currentUser.email, questionId);
             updateSectionProgress(SECTION_ID); // Update progress
             hideQuestionProgressBar(questionContainer); // Hide progress bar

             console.log("Cleared answer locally for", questionId);
             // No Supabase interaction needed for delete, as it only happens before save.
        };

        // --- Formspree Submission ---
        // REMOVED: function submitToFormspree(...)

         // ***** ---> Progress Functions <--- *****
         function updateSectionProgress(sectionId) {
             const currentUser = getCurrentUser();
             if (!currentUser) { console.error("updateSectionProgress: Cannot update, user not found."); return 0; }

             let allAnswers = {};
             try {
                 const storedData = localStorage.getItem(localStorageKey); // Get answers for THIS page
                 if (storedData) { allAnswers = JSON.parse(storedData) || {}; }
             } catch(e) { console.error("Error parsing stored answers for progress:", e); }
             const userPageAnswers = allAnswers[currentUser.email] || {};

             const requiredFields = document.querySelectorAll('.required-answer[data-question]');
             const totalQuestions = requiredFields.length;
             if (totalQuestions === 0) return 0; // Avoid division by zero

             let answeredCount = 0;
             requiredFields.forEach(field => {
                 const questionId = field.dataset.question;
                 // Count based on local storage OR if the field is disabled (meaning it was saved)
                 if ((userPageAnswers[questionId] !== undefined && userPageAnswers[questionId].trim() !== '') || field.disabled) {
                     answeredCount++;
                 }
             });

             const progressPercentage = totalQuestions > 0 ? Math.round((answeredCount / totalQuestions) * 100) : 0;

             // Ensure progress object exists
             if (!currentUser.progress) currentUser.progress = {};
             currentUser.progress[sectionId] = progressPercentage; // Update the specific section

             saveCurrentUser(currentUser); // Save updated progress back to localStorage

             console.log(`Section '${sectionId}' progress updated to ${progressPercentage}% (${answeredCount}/${totalQuestions})`);
             return progressPercentage;
        }

        // Updated to always show 100% when called
        function showQuestionProgressBar(containerElement) {
             if (!containerElement) { console.warn("showQuestionProgressBar: containerElement is null"); return; }
             const barContainer = containerElement.querySelector('.question-progress-container');
             const bar = containerElement.querySelector('.question-progress-bar');
             const text = containerElement.querySelector('.question-progress-text');

             if (barContainer && bar && text) {
                 bar.style.width = `100%`; // Always 100%
                 text.textContent = `✔️ Completed`; // Use text for confirmation
                 barContainer.style.display = 'block';
                 // console.log(`Showing 100% progress bar for ${containerElement.id}.`);
             } else {
                  // console.warn("Progress bar elements not found within:", containerElement); // Quieter log
             }
        }

        function hideQuestionProgressBar(containerElement) {
             if (!containerElement) { console.warn("hideQuestionProgressBar: containerElement is null"); return; }
             const barContainer = containerElement.querySelector('.question-progress-container');
             if (barContainer) {
                 barContainer.style.display = 'none';
                 // console.log("Hiding progress bar for", containerElement.id);
             }
         }

    </script>

</body>
</html>
