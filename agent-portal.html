<!doctype html>
<html lang=en class=dark>
<head>
<meta charset=UTF-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Agent Portal - Elevo Core</title>
<link rel=icon href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234e8cff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M12 22V12M9 19l3-3 3 3M12 2a4 4 0 0 0-4 4v0a4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4z'/></svg>">
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel=stylesheet>
<script src=https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2></script>
<script src=https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js></script>
<script src=role-check.js></script>
<style>:root{--primary-color:#4e8cff;--primary-color-rgb:78,140,255;--accent-color:#8b5cf6;--success-color:#10b981;--warning-color:#f59e0b;--danger-color:#ef4444;--danger-color-rgb:239,68,68;--bg-color:#111827;--card-bg-color:#1f2937;--sidebar-card-bg-color:#1f2937;--input-bg-color:#374151;--border-color:#4b5563;--text-color:#f9fafb;--text-color-light:#d1d5db;--text-color-subtle:#9ca3af;--border-radius-sm:4px;--border-radius-md:8px;--border-radius-lg:12px;--border-radius-xl:16px;--border-radius-full:9999px;--transition-speed-fast:0.15s;--transition-speed-normal:0.3s;--transition-speed-slow:0.5s;--shadow-sm:0 1px 2px 0 rgba(0, 0, 0, 0.05);--shadow-md:0 4px 6px -1px rgba(0, 0, 0, 0.1),0 2px 4px -1px rgba(0, 0, 0, 0.06);--shadow-lg:0 10px 15px -3px rgba(0, 0, 0, 0.1),0 4px 6px -2px rgba(0, 0, 0, 0.05);--shadow-xl:0 20px 25px -5px rgba(0, 0, 0, 0.1),0 10px 10px -5px rgba(0, 0, 0, 0.04)}*{margin:0;padding:0;box-sizing:border-box}body{font-family:Poppins,sans-serif;background-color:var(--bg-color);color:var(--text-color);line-height:1.6;overflow-x:hidden}.app-container{min-height:100vh;display:flex;flex-direction:column}.app-header{background-color:rgba(17,24,39,.95);padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;box-shadow:var(--shadow-lg);position:sticky;top:0;z-index:100;backdrop-filter:blur(10px);border-bottom:1px solid var(--border-color)}.logo-container{display:flex;align-items:center;gap:.75rem}.app-title{font-weight:600;font-size:1.4rem;background:linear-gradient(135deg,var(--primary-color),var(--accent-color));-webkit-background-clip:text;-webkit-text-fill-color:transparent}.header-controls{display:flex;align-items:center;gap:1.5rem}.nav-link{color:var(--text-color-light);text-decoration:none;padding:.5rem 1rem;border-radius:var(--border-radius-md);transition:all var(--transition-speed-fast) ease;display:inline-flex;align-items:center;gap:.5rem;font-weight:500}.nav-link:hover{background-color:var(--input-bg-color);color:var(--text-color);transform:translateY(-1px)}.nav-link.active{background-color:var(--primary-color);color:#fff}.user-info{display:flex;align-items:center;gap:1rem}.user-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--primary-color),var(--accent-color));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:.9rem}.user-name-display{color:var(--text-color);font-weight:500}.logout-btn{background:0 0;border:none;color:var(--text-color-light);cursor:pointer;padding:.5rem 1rem;border-radius:var(--border-radius-md);display:flex;align-items:center;gap:.5rem;transition:all var(--transition-speed-fast) ease;font-weight:500}.logout-btn:hover{background-color:var(--danger-color);color:#fff;transform:translateY(-1px)}.app-main{flex-grow:1}.dashboard-main{width:100%;max-width:100%;margin:0;margin:0 auto;padding:1.5rem 2rem}.dashboard-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;margin-bottom:2rem}.dashboard-header h1{font-size:2rem;font-weight:700;background:linear-gradient(135deg,var(--text-color),var(--primary-color));-webkit-background-clip:text;-webkit-text-fill-color:transparent}.text-color-light{color:var(--text-color-light)}.text-color-subtle{color:var(--text-color-subtle)}.action-button{padding:.75rem 1.5rem;border:none;border-radius:var(--border-radius-md);cursor:pointer;font-weight:500;display:inline-flex;align-items:center;gap:.5rem;transition:all var(--transition-speed-fast) ease;text-decoration:none;font-size:.9rem;font-family:inherit}.action-button:disabled{opacity:.6;cursor:not-allowed;transform:none!important}.primary-button{background-color:var(--primary-color);color:#fff;box-shadow:var(--shadow-md)}.primary-button:hover:not(:disabled){background-color:#3b78e7;transform:translateY(-2px);box-shadow:var(--shadow-lg)}.secondary-button{background-color:var(--input-bg-color);color:var(--text-color)}.secondary-button:hover:not(:disabled){background-color:#4b5563;transform:translateY(-1px)}.danger-button{background-color:var(--danger-color);color:#fff}.danger-button:hover:not(:disabled){background-color:#dc2626;transform:translateY(-1px)}.success-button{background-color:var(--success-color);color:#fff}.success-button:hover:not(:disabled){background-color:#0da271;transform:translateY(-1px)}.scorecard{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1.5rem;margin-bottom:2rem}.kpi-card{background-color:var(--card-bg-color);padding:1.5rem;border-radius:var(--border-radius-lg);border-left:4px solid var(--primary-color);box-shadow:var(--shadow-md);transition:all var(--transition-speed-normal) ease;position:relative;overflow:hidden}.kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--primary-color),transparent)}.kpi-card:hover{transform:translateY(-5px);box-shadow:var(--shadow-xl)}.kpi-card h4{font-size:.9em;color:var(--text-color-light);margin-bottom:.5rem;font-weight:500;display:flex;align-items:center;gap:.5rem}.kpi-value{font-size:1.75em;font-weight:700;color:var(--text-color);display:flex;align-items:center;gap:.5rem}.kpi-trend{font-size:.8em;padding:.2rem .5rem;border-radius:var(--border-radius-full);margin-left:.5rem}.trend-up{background-color:rgba(16,185,129,.2);color:var(--success-color)}.trend-down{background-color:rgba(239,68,68,.2);color:var(--danger-color)}.progress-card{background-color:var(--card-bg-color);padding:1.5rem;border-radius:var(--border-radius-lg);box-shadow:var(--shadow-md)}.progress-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem;font-size:.9em;font-weight:500;color:var(--text-color-light)}.progress-bar-container{width:100%;height:12px;background-color:var(--input-bg-color);border-radius:6px;overflow:hidden}.progress-bar{height:100%;width:0%;background:linear-gradient(90deg,var(--primary-color),var(--accent-color));border-radius:6px;transition:width .8s cubic-bezier(.22, .61, .36, 1);position:relative}.progress-bar::after{content:'';position:absolute;top:0;left:0;bottom:0;right:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.4),transparent);animation:shimmer 2s infinite}@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}.portal-layout-grid{display:grid;grid-template-columns:minmax(0,1fr);gap:2rem;margin-top:1.5rem}@media (min-width:1024px){.portal-layout-grid{grid-template-columns:minmax(0,2.5fr) minmax(0,1.5fr)}}.main-content-column,.sidebar-column{display:flex;flex-direction:column;gap:2rem}.card{background-color:var(--card-bg-color);border-radius:var(--border-radius-lg);padding:1.5rem;box-shadow:var(--shadow-md);transition:all var(--transition-speed-normal) ease}.card:hover{box-shadow:var(--shadow-lg);transform:translateY(-2px)}.card h2,.card h3{margin-top:0;margin-bottom:1rem;font-weight:600;display:flex;align-items:center;gap:.5rem}.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}.table-responsive{overflow-x:auto;border-radius:var(--border-radius-md);border:1px solid var(--border-color)}table{width:100%;border-collapse:collapse;min-width:600px}td,th{padding:1rem 1.25rem;text-align:left;border-bottom:1px solid var(--border-color)}th{font-weight:600;color:var(--text-color-light);font-size:.85em;background-color:rgba(0,0,0,.2);text-transform:uppercase;letter-spacing:.5px}tr:hover{background-color:rgba(255,255,255,.05)}.status-badge{padding:.35rem .75rem;border-radius:var(--border-radius-full);font-size:.8em;font-weight:600;text-transform:capitalize}.status-completed{background-color:rgba(16,185,129,.2);color:var(--success-color)}.status-in-progress{background-color:rgba(78,140,255,.2);color:var(--primary-color)}.status-not-started{background-color:rgba(156,163,175,.2);color:var(--text-color-light)}.status-good{background-color:rgba(16,185,129,.2);color:var(--success-color)}.status-bad{background-color:rgba(239,68,68,.2);color:var(--danger-color)}.status-na{background-color:rgba(156,163,175,.2);color:var(--text-color-light)}.filter-controls{margin-bottom:1.5rem}.filter-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1rem;align-items:end}.filter-grid label{display:block;margin-bottom:.5rem;font-size:.9em;color:var(--text-color-light);font-weight:500}.filter-grid input,.filter-grid select{width:100%;padding:.75rem;background-color:var(--input-bg-color);border:1px solid var(--border-color);border-radius:var(--border-radius-md);color:var(--text-color);font-family:inherit;transition:all var(--transition-speed-fast) ease}.filter-grid input:focus,.filter-grid select:focus{outline:0;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(var(--primary-color-rgb),.1)}#agentScratchpad,#editNoteTextarea,#editTrainingDescription,#newTrainingDescription{width:100%;min-height:150px;background-color:var(--input-bg-color);border:1px solid var(--border-color);border-radius:var(--border-radius-md);color:var(--text-color);padding:1rem;font-family:inherit;font-size:.95em;resize:vertical;transition:all var(--transition-speed-fast) ease;line-height:1.5}#agentScratchpad:focus,#editNoteTextarea:focus,#editTrainingDescription:focus,#newTrainingDescription:focus{outline:0;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(var(--primary-color-rgb),.1)}.form-group{margin-bottom:1rem}.form-group label{display:block;margin-bottom:.5rem;font-weight:500;color:var(--text-color-light)}.form-group input,.form-group textarea{width:100%;padding:.75rem;background-color:var(--input-bg-color);border:1px solid var(--border-color);border-radius:var(--border-radius-md);color:var(--text-color)}.scratchpad-actions{display:flex;justify-content:flex-end;gap:.75rem;margin-top:1rem}.saved-notes-list,.training-programs-list{display:flex;flex-direction:column;gap:1rem;max-height:400px;overflow-y:auto;padding-right:.5rem}.saved-notes-list::-webkit-scrollbar,.training-programs-list::-webkit-scrollbar{width:6px}.saved-notes-list::-webkit-scrollbar-track,.training-programs-list::-webkit-scrollbar-track{background:var(--input-bg-color);border-radius:3px}.saved-notes-list::-webkit-scrollbar-thumb,.training-programs-list::-webkit-scrollbar-thumb{background-color:var(--border-color);border-radius:3px}.saved-notes-list::-webkit-scrollbar-thumb:hover,.training-programs-list::-webkit-scrollbar-thumb:hover{background-color:var(--primary-color)}.note-card{background-color:var(--input-bg-color);border-radius:var(--border-radius-lg);border-left:4px solid var(--accent-color);padding:1.25rem;transition:all var(--transition-speed-normal) ease}.note-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-md)}.note-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.75rem;font-size:.85em}.note-author{color:var(--text-color-light);font-weight:600;font-size:1.1em}.note-timestamp{color:var(--text-color-subtle);font-size:.9em}.note-email{color:var(--text-color-subtle);font-size:.9em;margin-bottom:.75rem}.note-content{color:var(--text-color);line-height:1.6;white-space:pre-wrap;word-break:break-word;font-family:Poppins,sans-serif;font-weight:400}.note-actions{display:flex;justify-content:flex-end;align-items:center;gap:.5rem;margin-top:1rem}.icon-button{background:0 0;border:none;cursor:pointer;padding:.5rem;border-radius:var(--border-radius-md);display:flex;align-items:center;justify-content:center;transition:all var(--transition-speed-fast) ease;color:var(--text-color-light)}.icon-button:hover{background-color:rgba(255,255,255,.1);transform:scale(1.1)}.icon-button.view{color:var(--primary-color)}.icon-button.edit{color:var(--warning-color)}.icon-button.delete{color:var(--danger-color)}.training-card{background-color:var(--input-bg-color);border-radius:var(--border-radius-lg);padding:1.5rem;border-left:4px solid var(--primary-color);transition:all var(--transition-speed-normal) ease;position:relative}.training-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-md)}.training-card.completed{border-left-color:var(--success-color)}.training-card-header{display:flex;justify-content:space-between;align-items:flex-start;gap:1rem;margin-bottom:1rem}.training-card-header h4{margin:0;font-size:1.1em;font-weight:600;flex:1}.training-card-body{color:var(--text-color-light);line-height:1.6;margin-bottom:1rem}.training-card-footer{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;font-size:.9em}.training-card-actions{display:flex;gap:.5rem}.training-date{color:var(--text-color-subtle);font-weight:500}.performance-summary-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:1.25rem}.performance-summary-item{display:flex;justify-content:space-between;align-items:center;padding:.75rem 0;border-bottom:1px solid var(--border-color)}.performance-summary-item:last-child{border-bottom:none}.performance-summary-item span{color:var(--text-color-light);font-weight:500}.performance-summary-item strong{font-weight:700;font-size:1.1em;color:var(--text-color)}.charts-container{display:flex;flex-direction:column;gap:2rem}.chart-wrapper{position:relative;height:250px}.comparison-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin:1.5rem 0}.comparison-metric{text-align:center;padding:1rem;background-color:var(--input-bg-color);border-radius:var(--border-radius-lg)}.comparison-metric h5{margin:0 0 .5rem 0;font-size:.9em;color:var(--text-color-light);font-weight:500}.comparison-metric p{margin:0;font-size:1.5em;font-weight:700}.comparison-result{text-align:center;padding-top:1rem;border-top:1px solid var(--border-color)}.comparison-result p{margin:0;font-size:1.1em;font-weight:600;display:flex;align-items:center;justify-content:center;gap:.5rem}.improvement{color:var(--success-color)}.decline{color:var(--danger-color)}.achievements-list{list-style:none;padding:0}.achievement-item{display:flex;align-items:center;gap:1rem;padding:1rem 0;border-bottom:1px solid var(--border-color)}.achievement-item:last-child{border-bottom:none}.achievement-icon{font-size:1.75em;width:50px;height:50px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--primary-color),var(--accent-color));border-radius:50%;flex-shrink:0}.achievement-content{flex:1}.achievement-content strong{display:block;margin-bottom:.25rem;font-weight:600}.achievement-content p{margin:0;color:var(--text-color-light);font-size:.9em}.pagination-container{margin-top:1.5rem;padding-top:1rem;border-top:1px solid var(--border-color)}.pagination{display:flex;justify-content:center;align-items:center;gap:.5rem;flex-wrap:wrap}.pagination-btn,.pagination-current{padding:.5rem 1rem;border-radius:var(--border-radius-md);font-size:.9em;font-weight:500;min-width:40px;text-align:center}.pagination-btn{background-color:var(--input-bg-color);color:var(--text-color);border:none;cursor:pointer;transition:all var(--transition-speed-fast) ease}.pagination-btn:hover:not(:disabled){background-color:var(--primary-color);color:#fff;transform:translateY(-1px)}.pagination-btn:disabled{opacity:.5;cursor:not-allowed}.pagination-current{background-color:var(--primary-color);color:#fff}.loading-container{display:flex;flex-direction:column;align-items:center;justify-content:center;height:60vh;text-align:center}.spinner{width:50px;height:50px;border:4px solid rgba(255,255,255,.1);border-left-color:var(--primary-color);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:1rem}@keyframes spin{to{transform:rotate(360deg)}}.skeleton{background:linear-gradient(90deg,var(--input-bg-color) 25%,rgba(255,255,255,.1) 50%,var(--input-bg-color) 75%);background-size:200% 100%;animation:loading 1.5s infinite;border-radius:var(--border-radius-md)}@keyframes loading{0%{background-position:200% 0}100%{background-position:-200% 0}}.empty-state{text-align:center;padding:3rem 2rem;color:var(--text-color-subtle)}.empty-state i{font-size:3rem;margin-bottom:1rem;opacity:.5}.empty-state h3{margin-bottom:.5rem;color:var(--text-color-light)}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.7);align-items:center;justify-content:center;opacity:0;transition:opacity var(--transition-speed-normal) ease}.modal-content{background-color:var(--card-bg-color);padding:2rem;border-radius:var(--border-radius-lg);width:90%;max-width:500px;box-shadow:var(--shadow-xl);transform:scale(.95);transition:transform var(--transition-speed-normal) ease}.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}.modal-header h3{margin:0}.modal-footer{display:flex;justify-content:flex-end;gap:.75rem;margin-top:1.5rem}#toast-container{position:fixed;top:20px;right:20px;z-index:2000;display:flex;flex-direction:column;gap:.75rem}.toast{padding:1rem 1.5rem;border-radius:var(--border-radius-md);color:#fff;font-weight:500;box-shadow:var(--shadow-lg);display:flex;align-items:center;gap:.75rem;opacity:0;transform:translateX(100%);animation:slideIn .3s forwards}.toast.show{opacity:1;transform:translateX(0)}.toast.hide{animation:slideOut .3s forwards}.toast-success{background-color:var(--success-color)}.toast-error{background-color:var(--danger-color)}@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}@keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(120%);opacity:0}}.app-footer{background-color:var(--card-bg-color);padding:1.5rem 2rem;text-align:center;color:var(--text-color-light);font-size:.9em;border-top:1px solid var(--border-color);margin-top:auto}@media (max-width:768px){.app-header{padding:1rem;flex-direction:column;gap:1rem}.dashboard-main{padding:1rem}.dashboard-header{flex-direction:column;align-items:flex-start}.scorecard{grid-template-columns:1fr}.portal-layout-grid{grid-template-columns:1fr}.filter-grid{grid-template-columns:1fr}.comparison-grid{grid-template-columns:1fr}td,th{padding:.75rem .5rem}}.text-center{text-align:center}.text-right{text-align:right}.mb-1{margin-bottom:.5rem}.mb-2{margin-bottom:1rem}.mb-3{margin-bottom:1.5rem}.mt-1{margin-top:.5rem}.mt-2{margin-top:1rem}.mt-3{margin-top:1.5rem}.flex{display:flex}.flex-between{display:flex;justify-content:space-between;align-items:center}.flex-center{display:flex;justify-content:center;align-items:center}.hidden{display:none}</style>

    <style>
    /* Unified modal styles to match Access Restricted look */
    .access-denied-content button { transition: transform .12s ease, box-shadow .12s ease; }
    .access-denied-content button:active { transform: translateY(1px) scale(.995); }
    .access-denied-content { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    </style>
    
</head>
<body>
<div class=app-container>
<header class=app-header>
<div class=logo-container>
<svg class=company-logo viewBox="0 0 24 24" fill=none xmlns=http://www.w3.org/2000/svg style=color:var(--primary-color);width:32px;height:32px>
<path d="M12 22V12M9 19l3-3 3 3M12 2a4 4 0 0 0-4 4v0a4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4z" stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round />
</svg>
<span class=app-title>Elevo Core - Agent Portal</span>
</div>
<div class=header-controls>
<a href=core-flow.html class=nav-link>
<i class="fas fa-phone"></i>
Call App
</a>
<a href=admin-dashboard.html class=nav-link id=dashboardLink style=display:none>
<i class="fas fa-tachometer-alt"></i>
Admin Dashboard
</a>
<div class=user-info id=userInfo style=display:none>
<div class=user-avatar id=userAvatar>A</div>
<span id=userName class=user-name-display></span>
<button id=logoutButton class=logout-btn>
<i class="fas fa-sign-out-alt"></i>
Logout
</button>
</div>
</div>
</header>
<main class=app-main>
<div class=dashboard-main>
<div id=auth-loading class=loading-container>
<div class=spinner></div>
<h2>Loading Agent Portal</h2>
<p class=text-color-light>Please wait while we load your data...</p>
</div>
<div id=portalContent style=display:none>
<div class=dashboard-header>
<div>
<h1 id=agentGreeting>Welcome back!</h1>
<p class=text-color-light id=agentSubtext>Here's your performance overview and recent activity</p>
</div>
<button id=exportDataBtn class="action-button primary-button">
<i class="fas fa-download"></i>
Export Data
</button>
</div>
<div class=scorecard>
<div class=kpi-card>
<h4><i class="fas fa-clock"></i> Avg. Handling Time</h4>
<div class=kpi-value id=kpiAvgTime>
<span class=skeleton style=width:80px;height:32px></span>
</div>
</div>
<div class=kpi-card style=border-left-color:var(--success-color)>
<h4><i class="fas fa-star"></i> Customer Rating</h4>
<div class=kpi-value id=kpiAvgRating>
<span class=skeleton style=width:80px;height:32px></span>
</div>
</div>
<div class=kpi-card style=border-left-color:var(--warning-color)>
<h4><i class="fas fa-phone"></i> Calls Completed</h4>
<div class=kpi-value id=kpiTotalCalls>
<span class=skeleton style=width:60px;height:32px></span>
</div>
</div>
<div class=kpi-card style=border-left-color:var(--accent-color)>
<h4><i class="fas fa-bullseye"></i> Daily Target</h4>
<div class=progress-card style="padding:0;background:0 0;box-shadow:none">
<div class=progress-title>
<span>Progress</span>
<span id=dailyTargetPercentage>0%</span>
</div>
<div class=progress-bar-container>
<div id=dailyTargetProgressBar class=progress-bar style=width:0%></div>
</div>
</div>
</div>
</div>
<div class=portal-layout-grid>
<div class=main-content-column>
<div class=card>
<div class=card-header>
<h2><i class="fas fa-history"></i> Call History</h2>
<div class=flex style=gap:.5rem>
<button id=refreshCallsBtn class=icon-button title=Refresh>
<i class="fas fa-sync-alt"></i>
</button>
</div>
</div>
<div class=filter-controls>
<div class=filter-grid>
<div>
<label for=searchInput><i class="fas fa-search"></i> Search</label>
<input id=searchInput placeholder="Search scenarios...">
</div>
<div>
<label for=qualityFilter><i class="fas fa-filter"></i> Quality</label>
<select id=qualityFilter>
<option value="">All Quality</option>
<option value=Good>Good</option>
<option value=Bad>Bad</option>
<option value=N/A>N/A</option>
</select>
</div>
<div>
<label for=startDateFilter><i class="fas fa-calendar"></i> From Date</label>
<input type=date id=startDateFilter>
</div>
<div>
<label for=endDateFilter><i class="fas fa-calendar"></i> To Date</label>
<input type=date id=endDateFilter>
</div>
<div>
<label>&nbsp;</label>
<button id=resetFiltersBtn class="action-button secondary-button" style=width:100%>
<i class="fas fa-undo"></i>
Reset
</button>
</div>
</div>
</div>
<div class=table-responsive>
<table id=callsTable>
<thead>
<tr>
<th>Date</th>
<th>Start Time</th>
<th>Scenario</th>
<th>Duration</th>
<th>Status</th>
<th>Quality</th>
<th>Reason</th>
</tr>
</thead>
<tbody id=callsTableBody>
</tbody>
</table>
</div>
<div id=noCallsMessage class=empty-state style=display:none>
<i class="fas fa-phone-slash"></i>
<h3>No Calls Found</h3>
<p>No call records match your current filters.</p>
</div>
<div id=paginationControls class=pagination-container></div>
</div>
<div class=card>
<h2><i class="fas fa-sticky-note"></i> My Notes</h2>
<textarea id=agentScratchpad placeholder="Write your notes here... This is your personal scratchpad for quick notes and reminders."></textarea>
<div class=scratchpad-actions>
<button id=cancelNoteBtn class="action-button secondary-button">
<i class="fas fa-times"></i>
Cancel
</button>
<button id=saveNoteBtn class="action-button primary-button">
<i class="fas fa-save"></i>
Save Note
</button>
</div>
<div style=margin-top:2rem>
<h3><i class="fas fa-bookmark"></i> Saved Notes</h3>
<div id=savedNotesList class=saved-notes-list>
</div>
<div id=noNotesMessage class=empty-state style=display:none>
<i class="fas fa-clipboard"></i>
<h3>No Notes Yet</h3>
<p>You haven't saved any notes yet. Start by writing something above!</p>
</div>
<div id=notesPaginationControls class=pagination-container></div>
</div>
</div>
<div class=card>
<div class=card-header>
<h2><i class="fas fa-graduation-cap"></i> Training Programs</h2>
<button id=addTrainingBtn class="action-button primary-button">
<i class="fas fa-plus"></i>
Add Training
</button>
</div>
<div id=trainingProgramsList class=training-programs-list>
</div>
<div id=noTrainingMessage class=empty-state style=display:none>
<i class="fas fa-book-open"></i>
<h3>No Training Programs</h3>
<p>You don't have any training programs assigned yet.</p>
</div>
<div id=trainingPaginationControls class=pagination-container></div>
</div>
</div>
<div class=sidebar-column>
<div class=card>
<h3><i class="fas fa-chart-line"></i> Performance Summary</h3>
<ul class=performance-summary-list>
<li class=performance-summary-item>
<span>Total Calls</span>
<strong id=ins-total>0</strong>
</li>
<li class=performance-summary-item>
<span>Avg. Handling Time</span>
<strong id=ins-avg-time>--:--</strong>
</li>
<li class=performance-summary-item>
<span>Avg. Customer Rating</span>
<strong id=ins-avg-rating>-.--</strong>
</li>
<li class=performance-summary-item>
<span>Completion Rate</span>
<strong id=ins-completion>0%</strong>
</li>
<li class=performance-summary-item>
<span>Good Quality Rate</span>
<strong id=ins-good-quality>0%</strong>
</li>
</ul>
</div>
<div class=card>
<h3><i class="fas fa-chart-pie"></i> Performance Charts</h3>
<div class=charts-container>
<div class=chart-wrapper>
<canvas id=qualityChart></canvas>
</div>
<div class=chart-wrapper>
<canvas id=durationChart></canvas>
</div>
</div>
</div>
<div class=card>
<h3><i class="fas fa-users"></i> Performance vs. Team</h3>
<div class=comparison-grid>
<div class=comparison-metric>
<h5>Your AHT</h5>
<p id=yourAHT>--:--</p>
</div>
<div class=comparison-metric>
<h5>Team Avg. AHT</h5>
<p id=teamAHT>--:--</p>
</div>
</div>
<div class=comparison-result>
<p id=comparisonResult>
<i class="fas fa-info-circle"></i>
<span>Loading comparison data...</span>
</p>
</div>
</div>
<div class=card>
<h3><i class="fas fa-trophy"></i> Recent Achievements</h3>
<ul class=achievements-list id=achievementsList>
<li class=achievement-item>
<div class=achievement-icon>
<i class="fas fa-star"></i>
</div>
<div class=achievement-content>
<strong>First Perfect Call</strong>
<p>Completed your first call with 100% quality score</p>
</div>
</li>
<li class=achievement-item>
<div class=achievement-icon>
<i class="fas fa-bolt"></i>
</div>
<div class=achievement-content>
<strong>Speed Demon</strong>
<p>Handled 50 calls with below average handling time</p>
</div>
</li>
<li class=achievement-item>
<div class=achievement-icon>
<i class="fas fa-medal"></i>
</div>
<div class=achievement-content>
<strong>Consistency Master</strong>
<p>Maintained 90%+ quality rating for 5 consecutive days</p>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</main>
<footer class=app-footer>
<div class=text-center>
<p>Elevo Core Agent Portal &copy; 2023 - <span id=currentYear></span> | All rights reserved</p>
</div>
</footer>
</div>
<div id=accessRestrictedModal class=modal>
<div class=modal-content>
<div class=modal-header>
<h3><i class="fas fa-exclamation-triangle"></i> Access Restricted</h3>
</div>
<p>This page is for admins only.</p>
<div class=modal-footer>
<button id=backToDashboardBtn class="action-button primary-button">
<i class="fas fa-arrow-left"></i>
Back to Dashboard
</button>
</div>
</div>
</div>
<div id=toast-container></div>
<script>
document.addEventListener('DOMContentLoaded', async function() {
    // Initialize Supabase
    const supabaseUrl = 'https://aefiigottnlcmjzilqnh.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlZmlpZ290dG5sY21qemlscW5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNzY2MDQsImV4cCI6MjA2Mjc1MjYwNH0.FypB02v3tGMnxXV9ZmZMdMC0oQpREKOJWgHMPxUzwX4';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    
    // Check user role and permissions
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
        window.location.href = 'index.html';
        return;
    }
    
    const { data: userData, error } = await supabase
        .from('users')
        .select('id, name, email, role')
        .eq('id', user.id)
        .single();
    
    if (error || !userData) {
        console.error('Error fetching user data:', error);
        window.location.href = 'index.html';
        return;
    }
    
    // Check if user has access to this page (Agent, Admin, or Manager)
    if (userData.role !== 'agent' && userData.role !== 'admin' && userData.role !== 'manager') {
        document.getElementById('accessRestrictedModal').style.display = 'flex';
        document.getElementById('accessRestrictedModal').style.opacity = '1';
        document.getElementById('portalContent').style.display = 'none';
        document.getElementById('auth-loading').style.display = 'none';
        
        document.getElementById('backToDashboardBtn').addEventListener('click', function() {
            window.location.href = 'core-flow.html';
        });
        return;
    }
    
    // Show admin dashboard link for admins and managers
    if (userData.role === 'admin' || userData.role === 'manager') {
        document.getElementById('dashboardLink').style.display = 'inline-flex';
    }
    
    // Display user info
    document.getElementById('userInfo').style.display = 'flex';
    document.getElementById('userName').textContent = userData.name || userData.email;
    document.getElementById('userAvatar').textContent = (userData.name ? userData.name.charAt(0).toUpperCase() : userData.email.charAt(0).toUpperCase());
    
    // Update greeting
    const hour = new Date().getHours();
    let greeting = 'Good evening';
    if (hour < 12) greeting = 'Good morning';
    else if (hour < 18) greeting = 'Good afternoon';
    
    document.getElementById('agentGreeting').textContent = `${greeting}, ${userData.name ? userData.name.split(' ')[0] : 'Agent'}!`;
    
    // Show portal content
    document.getElementById('auth-loading').style.display = 'none';
    document.getElementById('portalContent').style.display = 'block';
    
    // Set current year in footer
    document.getElementById('currentYear').textContent = new Date().getFullYear();
    
    // Initialize charts
    const qualityChart = new Chart(document.getElementById('qualityChart'), {
        type: 'doughnut',
        data: {
            labels: ['Good', 'Bad', 'N/A'],
            datasets: [{
                data: [0, 0, 0],
                backgroundColor: [
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(239, 68, 68, 0.8)',
                    'rgba(156, 163, 175, 0.8)'
                ],
                borderColor: [
                    'rgba(16, 185, 129, 1)',
                    'rgba(239, 68, 68, 1)',
                    'rgba(156, 163, 175, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: 'var(--text-color)',
                        font: {
                            family: 'Poppins'
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'var(--card-bg-color)',
                    titleColor: 'var(--text-color)',
                    bodyColor: 'var(--text-color)',
                    borderColor: 'var(--border-color)',
                    borderWidth: 1
                }
            }
        }
    });
    
    const durationChart = new Chart(document.getElementById('durationChart'), {
        type: 'bar',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
                label: 'Avg. Handling Time (min)',
                data: [0, 0, 0, 0, 0, 0, 0],
                backgroundColor: 'rgba(78, 140, 255, 0.7)',
                borderColor: 'rgba(78, 140, 255, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'var(--text-color-light)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'var(--text-color-light)'
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: 'var(--text-color)',
                        font: {
                            family: 'Poppins'
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'var(--card-bg-color)',
                    titleColor: 'var(--text-color)',
                    bodyColor: 'var(--text-color)',
                    borderColor: 'var(--border-color)',
                    borderWidth: 1
                }
            }
        }
    });
    
    // Load real data from Supabase
    async function loadCallsData() {
        try {
            const { data: calls, error } = await supabase
                .from('call_sessions_egypt')
                .select('*')
                .eq('agent_email', userData.email)
                .order('start_time_egypt', { ascending: false });
            
            if (error) throw error;
            return calls || [];
        } catch (error) {
            console.error('Error loading calls data:', error);
            showToast('Failed to load call history', 'error');
            return [];
        }
    }
    
    async function loadNotesData() {
        try {
            const { data: notes, error } = await supabase
                .from('agent_notes')
                .select('*')
                .eq('user_id', user.id)
                .order('created_at', { ascending: false });
            
            if (error) throw error;
            return notes || [];
        } catch (error) {
            console.error('Error loading notes data:', error);
            showToast('Failed to load notes', 'error');
            return [];
        }
    }
    
    async function loadTrainingData() {
        try {
            const { data: training, error } = await supabase
                .from('training_programs')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (error) throw error;
            return training || [];
        } catch (error) {
            console.error('Error loading training data:', error);
            showToast('Failed to load training programs', 'error');
            return [];
        }
    }
    
    // Populate calls table
    function populateCallsTable(calls) {
        const tableBody = document.getElementById('callsTableBody');
        tableBody.innerHTML = '';
        
        if (calls.length === 0) {
            document.getElementById('noCallsMessage').style.display = 'block';
            return;
        }
        
        document.getElementById('noCallsMessage').style.display = 'none';
        
        calls.forEach(call => {
            const startTime = new Date(call.start_time_egypt);
            const date = startTime.toLocaleDateString('en-GB');
            const time = startTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${date}</td>
                <td>${time}</td>
                <td>${call.scenario_title || 'N/A'}</td>
                <td>${call.duration || 'N/A'}</td>
                <td><span class="status-badge ${call.completed ? 'status-completed' : 'status-not-started'}">${call.completed ? 'Completed' : 'Not Started'}</span></td>
                <td><span class="status-badge status-${(call.call_quality || 'N/A').toLowerCase().replace('/', '-')}">${call.call_quality || 'N/A'}</span></td>
                <td>${call.quality_reason || 'N/A'}</td>
            `;
            tableBody.appendChild(row);
        });
    }
    
    // Populate notes list
    function populateNotesList(notes) {
        const notesList = document.getElementById('savedNotesList');
        notesList.innerHTML = '';
        
        if (notes.length === 0) {
            document.getElementById('noNotesMessage').style.display = 'block';
            return;
        }
        
        document.getElementById('noNotesMessage').style.display = 'none';
        
        notes.forEach(note => {
            const timestamp = new Date(note.created_at).toLocaleString('en-US', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const noteCard = document.createElement('div');
            noteCard.className = 'note-card';
            noteCard.innerHTML = `
                <div class=note-header>
                    <div class=note-author>${note.user_name || 'You'}</div>
                    <div class=note-timestamp>${timestamp}</div>
                </div>
                <div class=note-email>${note.user_email || 'No email provided'}</div>
                <div class=note-content>${note.content}</div>
                <div class=note-actions>
                    <button class="icon-button view" data-id="${note.id}" title="View Note">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="icon-button edit" data-id="${note.id}" title="Edit Note">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="icon-button delete" data-id="${note.id}" title="Delete Note">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            notesList.appendChild(noteCard);
        });
    }
    
    // Populate training list
    function populateTrainingList(trainings) {
        const trainingList = document.getElementById('trainingProgramsList');
        trainingList.innerHTML = '';
        
        if (trainings.length === 0) {
            document.getElementById('noTrainingMessage').style.display = 'block';
            return;
        }
        
        document.getElementById('noTrainingMessage').style.display = 'none';
        
        trainings.forEach(training => {
            const date = new Date(training.created_at).toLocaleDateString('en-US', { dateStyle: 'medium' });
            
            const trainingCard = document.createElement('div');
            trainingCard.className = `training-card ${training.completed ? 'completed' : ''}`;
            trainingCard.innerHTML = `
                <div class=training-card-header>
                    <h4>${training.title}</h4>
                    <span class="status-badge ${training.completed ? 'status-completed' : 'status-in-progress'}">${training.completed ? 'Completed' : 'In Progress'}</span>
                </div>
                <div class=training-card-body>
                    ${training.description}
                </div>
                <div class=training-card-footer>
                    <div class=training-date>
                        <i class="fas fa-calendar"></i> ${date}
                    </div>
                    <div class=training-card-actions>
                        <button class="icon-button view" data-id="${training.id}" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${userData.role === 'admin' || userData.role === 'manager' ? `
                            <button class="icon-button edit" data-id="${training.id}" title="Edit Training">
                                <i class="fas fa-edit"></i>
                            </button>
                        ` : ''}
                        ${!training.completed ? 
                            `<button class="icon-button complete" data-id="${training.id}" title="Mark as Complete">
                                <i class="fas fa-check"></i>
                            </button>` : ''}
                    </div>
                </div>
            `;
            trainingList.appendChild(trainingCard);
        });
    }
    
    // Update performance metrics
    function updatePerformanceMetrics(calls) {
        const totalCalls = calls.length;
        const completedCalls = calls.filter(call => call.completed).length;
        const goodCalls = calls.filter(call => call.call_quality === 'Good').length;
        const badCalls = calls.filter(call => call.call_quality === 'Bad').length;
        const naCalls = calls.filter(call => !call.call_quality || call.call_quality === 'N/A').length;
        
        // Calculate completion rate
        const completionRate = totalCalls > 0 ? Math.round((completedCalls / totalCalls) * 100) : 0;
        
        // Calculate good quality rate
        const goodQualityRate = totalCalls > 0 ? Math.round((goodCalls / totalCalls) * 100) : 0;
        
        // Update KPI cards
        document.getElementById('kpiAvgTime').innerHTML = `10:25 <span class="kpi-trend trend-down">-5%</span>`;
        document.getElementById('kpiAvgRating').innerHTML = `4.8 <span class="kpi-trend trend-up">+0.2</span>`;
        document.getElementById('kpiTotalCalls').innerHTML = `${totalCalls} <span class="kpi-trend trend-up">+12%</span>`;
        
        // Update daily target progress
        const dailyTarget = 25; // Example target
        const progressPercentage = Math.min(Math.round((totalCalls / dailyTarget) * 100), 100);
        document.getElementById('dailyTargetPercentage').textContent = `${progressPercentage}%`;
        document.getElementById('dailyTargetProgressBar').style.width = `${progressPercentage}%`;
        
        // Update performance summary
        document.getElementById('ins-total').textContent = totalCalls;
        document.getElementById('ins-avg-time').textContent = '10:25';
        document.getElementById('ins-avg-rating').textContent = '4.8';
        document.getElementById('ins-completion').textContent = `${completionRate}%`;
        document.getElementById('ins-good-quality').textContent = `${goodQualityRate}%`;
        
        // Update charts
        qualityChart.data.datasets[0].data = [goodCalls, badCalls, naCalls];
        qualityChart.update();
        
        // Update duration chart with mock weekly data
        durationChart.data.datasets[0].data = [12, 10, 14, 11, 13, 8, 7];
        durationChart.update();
        
        // Update comparison data
        document.getElementById('yourAHT').textContent = '10:25';
        document.getElementById('teamAHT').textContent = '10:45';
        
        document.getElementById('comparisonResult').innerHTML = '<i class="fas fa-arrow-up improvement"></i> <span>You\'re faster than the team average!</span>';
        document.getElementById('comparisonResult').className = 'improvement';
    }
    
    // Load and initialize data
    async function initializeData() {
        const [calls, notes, training] = await Promise.all([
            loadCallsData(),
            loadNotesData(),
            loadTrainingData()
        ]);
        
        populateCallsTable(calls);
        populateNotesList(notes);
        populateTrainingList(training);
        updatePerformanceMetrics(calls);
        
        // Remove skeleton loaders
        setTimeout(() => {
            document.querySelectorAll('.skeleton').forEach(skeleton => {
                skeleton.style.background = 'transparent';
                skeleton.textContent = skeleton.parentElement.id === 'kpiAvgTime' ? '10:25' : 
                                     skeleton.parentElement.id === 'kpiAvgRating' ? '4.8' : calls.length.toString();
            });
        }, 500);
    }
    
    // Initialize data
    initializeData();
    
    // Event listeners
    document.getElementById('logoutButton').addEventListener('click', async function() {
        await supabase.auth.signOut();
        window.location.href = 'index.html';
    });
    
    document.getElementById('saveNoteBtn').addEventListener('click', async function() {
        const noteContent = document.getElementById('agentScratchpad').value.trim();
        if (noteContent) {
            const { data, error } = await supabase
                .from('agent_notes')
                .insert({
                    user_id: user.id,
                    content: noteContent,
                    user_name: userData.name,
                    user_email: userData.email
                })
                .select()
                .single();
            
            if (error) {
                showToast('Failed to save note', 'error');
                console.error('Save note error:', error);
            } else {
                // Reload notes to include the new one
                const notes = await loadNotesData();
                populateNotesList(notes);
                document.getElementById('agentScratchpad').value = '';
                showToast('Note saved successfully!', 'success');
            }
        } else {
            showToast('Please write something before saving.', 'error');
        }
    });
    
    document.getElementById('cancelNoteBtn').addEventListener('click', function() {
        document.getElementById('agentScratchpad').value = '';
    });
    
    document.getElementById('addTrainingBtn').addEventListener('click', function() {
        if (userData.role === 'admin' || userData.role === 'manager') {
            showToast('Training program creation feature coming soon!', 'success');
        } else {
            showToast('Only admins and managers can add training programs', 'error');
        }
    });
    
    document.getElementById('exportDataBtn').addEventListener('click', function() {
        showToast('Exporting your data...', 'success');
        // In a real app, this would trigger a data export process
        setTimeout(() => {
            showToast('Data exported successfully!', 'success');
        }, 1500);
    });
    
    document.getElementById('refreshCallsBtn').addEventListener('click', async function() {
        showToast('Refreshing call data...', 'success');
        const calls = await loadCallsData();
        populateCallsTable(calls);
        updatePerformanceMetrics(calls);
        showToast('Call data updated!', 'success');
    });
    
    document.getElementById('resetFiltersBtn').addEventListener('click', async function() {
        document.getElementById('searchInput').value = '';
        document.getElementById('qualityFilter').value = '';
        document.getElementById('startDateFilter').value = '';
        document.getElementById('endDateFilter').value = '';
        const calls = await loadCallsData();
        populateCallsTable(calls);
        showToast('Filters reset', 'success');
    });
    
    // Filter functionality
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('qualityFilter').addEventListener('change', applyFilters);
    document.getElementById('startDateFilter').addEventListener('change', applyFilters);
    document.getElementById('endDateFilter').addEventListener('change', applyFilters);
    
    async function applyFilters() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const qualityFilter = document.getElementById('qualityFilter').value;
        const startDate = document.getElementById('startDateFilter').value;
        const endDate = document.getElementById('endDateFilter').value;
        
        let calls = await loadCallsData();
        
        let filteredCalls = calls.filter(call => {
            // Search filter
            const matchesSearch = !searchTerm || 
                (call.scenario_title && call.scenario_title.toLowerCase().includes(searchTerm)) ||
                (call.quality_reason && call.quality_reason.toLowerCase().includes(searchTerm));
            
            // Quality filter
            const matchesQuality = !qualityFilter || call.call_quality === qualityFilter;
            
            // Date filter
            const callDate = new Date(call.start_time_egypt).toISOString().split('T')[0];
            const matchesStartDate = !startDate || callDate >= startDate;
            const matchesEndDate = !endDate || callDate <= endDate;
            
            return matchesSearch && matchesQuality && matchesStartDate && matchesEndDate;
        });
        
        populateCallsTable(filteredCalls);
    }
    
    // Toast notification function
    function showToast(message, type) {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        
        const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        toast.innerHTML = `
            <i class="fas ${icon}"></i>
            <span>${message}</span>
        `;
        
        toastContainer.appendChild(toast);
        
        // Animate in
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);
        
        // Remove after 3 seconds
        setTimeout(() => {
            toast.classList.remove('show');
            toast.classList.add('hide');
            setTimeout(() => {
                toastContainer.removeChild(toast);
            }, 300);
        }, 3000);
    }
});
</script>

    <script src="role-check.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', async function () {
      // Attempt role check using role-check.js
      try {
        if (window.RoleCheck && typeof window.RoleCheck.checkAccess === 'function') {
          await window.RoleCheck.checkAccess(['agent','admin','manager']);
        }
      } catch (e) {
        console.warn('Role check failed', e);
      }

      // Ensure user name element exists in header: prefer #userName
      try {
        let userNameEl = document.getElementById('userName') || document.querySelector('.user-name-display');
        if (!userNameEl) {
          // try to find header and append
          const header = document.querySelector('header') || document.querySelector('.topbar') || document.body;
          if (header) {
            const span = document.createElement('span');
            span.id = 'userName';
            span.style.marginLeft = '12px';
            span.className = 'user-name-display';
            header.prepend(span);
            userNameEl = span;
          }
        }
        // RoleCheck will populate #userName automatically
      } catch (e) { console.warn(e); }

      // Format durations in elements with class 'duration-seconds' or 'duration'
      try {
        const durEls = document.querySelectorAll('.duration-seconds, .duration');
        durEls.forEach(el => {
          const txt = el.textContent.trim();
          // if it's a number of seconds
          const sec = parseInt(txt,10);
          if (!isNaN(sec)) {
            const m = Math.floor(sec/60);
            const s = sec % 60;
            el.textContent = (m>0?m+'m ':'') + s + 's';
          } else {
            // try to parse mm:ss already
            if (/^\d+:\d{2}$/.test(txt)) {
              // keep as-is
            } else {
              // attempt to parse data-duration attribute (seconds)
              const d = el.getAttribute('data-duration');
              if (d) {
                const ds = parseInt(d,10);
                if (!isNaN(ds)) {
                  const m = Math.floor(ds/60);
                  const s = ds % 60;
                  el.textContent = (m>0?m+'m ':'') + s + 's';
                }
              }
            }
          }
        });
      } catch(e){console.warn(e);}

      // Improve pie charts if Chart.js is present
      try {
        if (window.Chart && document.querySelectorAll('canvas.pie-chart').length) {
          document.querySelectorAll('canvas.pie-chart').forEach(canvas => {
            try {
              const chart = Chart.getChart(canvas);
              if (chart && chart.config.type === 'pie') {
                chart.options.plugins.legend.position = 'bottom';
                chart.options.plugins.legend.labels = chart.options.plugins.legend.labels || {};
                chart.options.plugins.legend.labels.boxWidth = 12;
                chart.options.plugins.tooltip = chart.options.plugins.tooltip || {};
                chart.update();
              }
            } catch(err){console.warn('pie update err',err);}
          });
        }
      } catch(e){console.warn(e);}

      // Export CSV buttons: add click handler to elements with class export-csv
      try {
        document.querySelectorAll('.export-csv, .btn-export-csv').forEach(btn => {
          btn.addEventListener('click', function (ev) {
            ev.preventDefault();
            let table = document.querySelector('#dataTable') || document.querySelector('table');
            if (!table) {
              alert('No table found to export.');
              return;
            }
            const rows = Array.from(table.querySelectorAll('tr'));
            const csv = rows.map(r => {
              const cols = Array.from(r.querySelectorAll('th,td'));
              return cols.map(c => '"' + c.innerText.replace(/"/g,'""') + '"').join(',');
            }).join('\n');
            const blob = new Blob([csv], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = (table.getAttribute('data-export-name') || 'export') + '.csv';
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(()=>URL.revokeObjectURL(url),10000);
          });
        });
      } catch(e){console.warn(e);}

      // Simple prefetch on hover for internal links to speed navigation
      try {
        document.querySelectorAll('a[href^="/"]').forEach(a => {
          a.addEventListener('mouseover', () => {
            const href = a.getAttribute('href');
            if (!href) return;
            const link = document.createElement('link');
            link.rel = 'prefetch';
            link.href = href;
            document.head.appendChild(link);
            setTimeout(()=>link.remove(), 5000);
          });
        });
      } catch(e){console.warn(e);}

    });
    </script>
    <!-- Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  //       
  const SUPABASE_URL = "https://aefightgio1tnlcjzilqhn.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlZmlpZ290dG5sY21qemlscW5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNzY2MDQsImV4cCI6MjA2Mjc1MjYwNH0.FypB02v3tGMnxXV9ZmZMdMC0oQpREKOJWgHMPxUzwX4";
  window.supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>

<!--   -->
<script src="role-check.js"></script>
</body>
</html>
