<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Portal - Elevo Core</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234e8cff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M12 22V12M9 19l3-3 3 3M12 2a4 4 0 0 0-4 4v0a4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4z'/></svg>">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        .dashboard-main {
            width: 100%;
            max-width: none; 
            padding: 1.5rem 2rem; 
            text-align: left;
        }
code
Code
.portal-layout-grid {
        display: grid;
        grid-template-columns: minmax(0, 1fr);
        gap: 2rem;
        margin-top: 1.5rem;
    }

    .main-content-column, .sidebar-column {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    @media (min-width: 1024px) {
        .portal-layout-grid {
            grid-template-columns: minmax(0, 2.5fr) minmax(0, 1.5fr);
        }
    }
    
    .call-history-container.card {
        max-width: none;
    }
    
    #agentScratchpad, #editNoteTextarea {
        width: 100%;
        min-height: 150px;
        background-color: var(--input-bg-color);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-md);
        color: var(--text-color);
        padding: 0.75rem;
        font-family: inherit;
        font-size: 0.9em;
        resize: vertical;
        transition: border-color var(--transition-speed-fast) ease, box-shadow var(--transition-speed-fast) ease;
    }
    #agentScratchpad:focus, #editNoteTextarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(var(--primary-color-rgb), 0.25);
    }

    .scratchpad-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        margin-top: 0.75rem;
    }

    .saved-notes-list {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
    }
    
    .note-card {
        background-color: var(--input-bg-color);
        border-radius: var(--border-radius-lg);
        border-left: 4px solid var(--accent-color);
        padding: 1rem 1.25rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .note-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        font-size: 0.85em;
        color: var(--text-color-light);
    }

    .note-author, .note-timestamp {
        display: flex;
        flex-direction: column;
    }
    
    .note-author span:first-child, .note-timestamp span:first-child {
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 2px;
    }

    .note-content p {
        margin: 0.5rem 0;
        color: var(--text-color);
        word-break: break-word;
        white-space: pre-wrap;
        font-size: 0.95em;
        line-height: 1.6;
    }

    .note-actions {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 0.5rem;
    }
    
    .note-action-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0.35rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s ease;
    }
    
    .view-note-btn { color: var(--text-color-light); }
    .view-note-btn:hover { background-color: rgba(156, 163, 175, 0.1); }

    .edit-note-btn { color: var(--primary-color); }
    .edit-note-btn:hover { background-color: rgba(var(--primary-color-rgb), 0.1); }
    
    .delete-note-btn { color: var(--danger-color); }
    .delete-note-btn:hover { background-color: rgba(var(--danger-color-rgb), 0.1); }
    
    #notesPaginationControls, #trainingPaginationControls {
         margin-top: 1.5rem;
         padding-top: 1rem;
         border-top: 1px solid var(--border-color);
    }

    .modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: none; align-items: center; justify-content: center;
        z-index: 1000; opacity: 0; visibility: hidden;
        transition: opacity 0.3s ease, visibility 0s 0.3s;
    }
    .modal.visible {
        display: flex;
        opacity: 1;
        visibility: visible;
        transition-delay: 0s;
    }
    
    .modal-content {
        background-color: var(--card-bg-color); padding: 2rem;
        border-radius: var(--border-radius-lg); width: 90%;
        max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        transform: scale(0.95); transition: transform 0.3s ease;
    }
    .modal.visible .modal-content { transform: scale(1); }

    .modal-content h3 { margin-top: 0; margin-bottom: 1rem; font-size: 1.4em; }
    .modal-content p { margin-bottom: 1.5rem; color: var(--text-color-light); line-height: 1.6; }
    
    .modal-actions { display: flex; justify-content: flex-end; gap: 0.75rem; }

    .card h2 {
        display: flex; justify-content: space-between; align-items: center;
    }

    .scorecard {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;
    }
    .kpi-card {
        background-color: var(--card-bg-color); padding: 1.25rem;
        border-radius: var(--border-radius-lg); border-left: 4px solid var(--primary-color);
    }
    .kpi-card h4 {
        font-size: 0.9em; color: var(--text-color-light);
        margin-bottom: 0.5rem; font-weight: 500;
    }
    .kpi-value {
        font-size: 1.75em; font-weight: 600; color: var(--text-color);
        display: flex; align-items: center; gap: 0.5rem;
    }
    
    .progress-card {
        background-color: var(--card-bg-color); padding: 1.25rem;
        border-radius: var(--border-radius-lg);
    }
    .progress-title {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 0.75rem; font-size: 0.9em; font-weight: 500;
        color: var(--text-color-light);
    }
    .progress-bar-container {
        width: 100%; height: 12px; background-color: var(--input-bg-color);
        border-radius: 6px; overflow: hidden;
    }
    .progress-bar {
        height: 100%; width: 0%; background-color: var(--accent-color);
        border-radius: 6px; transition: width 0.5s ease-in-out;
    }

    .widget-card {
        background-color: var(--card-bg-color); padding: 1.5rem;
        border-radius: var(--border-radius-lg);
    }
    .widget-card h3 { margin-top: 0; font-size: 1.1em; margin-bottom: 1rem; }
    .achievements-list { list-style: none; padding: 0; }
    .achievement-item {
        display: flex; align-items: center; gap: 1rem;
        padding: 0.75rem 0; font-size: 0.95em;
        border-bottom: 1px solid var(--border-color);
    }
    .achievement-item:last-child { border-bottom: none; }
    .achievement-icon { font-size: 1.5em; }
    
    .performance-summary-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    .performance-summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.95em;
    }
    .performance-summary-item span {
        color: var(--text-color-light);
    }
     .performance-summary-item strong {
        font-weight: 600;
        font-size: 1.1em;
        color: var(--text-color);
    }
    .training-programs-list {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }
    .training-card {
        background-color: var(--input-bg-color);
        border-radius: var(--border-radius-lg);
        padding: 1.25rem;
        border-left: 4px solid var(--primary-color);
        position: relative;
    }
     .training-card.completed { border-left-color: var(--success-color); }
    .training-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
    }
    .training-card-header h4 {
        margin: 0;
        font-size: 1.1em;
        font-weight: 600;
    }
    .training-status {
        font-size: 0.8em;
        font-weight: 600;
        padding: 0.25rem 0.6rem;
        border-radius: var(--border-radius-full);
        color: #fff;
    }
    .training-status.completed { background-color: var(--success-color); }
    .training-status.in-progress { background-color: var(--primary-color); }

    .training-card-body {
        margin-top: 1rem;
        font-size: 0.95em; /* Increased font size */
        color: var(--text-color-light);
    }
    .training-card-body p { margin: 0.25rem 0; }
    .training-card-body strong { color: var(--text-color); }
    
    .training-card-footer {
        margin-top: 1.25rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .training-card-date {
        font-size: 0.9em; /* Increased size */
        font-weight: 500;   /* Increased weight */
        color: var(--text-color-subtle);
    }
    .training-card-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    /* NEW: Monthly Performance Comparison */
    .perf-comparison-card { text-align: center; }
    .comparison-grid {
        display: grid; grid-template-columns: 1fr 1fr;
        gap: 1.5rem; margin: 1rem 0;
    }
    .comparison-metric h5 {
        margin: 0 0 0.25rem 0; font-size: 0.9em;
        color: var(--text-color-light); font-weight: 500;
    }
    .comparison-metric p {
        margin: 0; font-size: 1.8em; font-weight: 700;
    }
    .comparison-result {
        margin-top: 1rem; padding-top: 1rem;
        border-top: 1px solid var(--border-color);
    }
    .comparison-result p {
        margin: 0; font-size: 1.1em; font-weight: 600;
        display: flex; align-items: center; justify-content: center; gap: 0.5rem;
    }
    .comparison-result .improvement { color: var(--success-color); }
    .comparison-result .decline { color: var(--danger-color); }
    
    /* NEW: Class for bordered widget-card */
    .widget-card-bordered {
        border-left: 4px solid var(--accent-color);
    }
</style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="logo-container">
                <svg class="company-logo" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: var(--primary-color); width: 28px; height: 28px;">
                     <path d="M12 22V12M9 19l3-3 3 3M12 2a4 4 0 0 0-4 4v0a4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span class="app-title" style="font-size: 1.4rem;">Elevo Core - Agent Portal</span>
            </div>
            <div class="header-controls">
                 <a href="core-flow.html" class="nav-link">Go to Call App</a>
                 <a href="dashboard.html" class="nav-link" id="dashboardLink" style="display: none;">Admin Dashboard</a>
                 <a href="rtm-dashboard.html" class="nav-link" id="rtmDashboardLink" style="display: none;">RTM Dashboard</a>
                 <div class="user-info" id="userInfo" style="display: none;">
                    <span id="userName" class="user-name-display"></span>
                    <button id="logoutButton" class="logout-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                        Logout
                    </button>
                 </div>
            </div>
        </header>
code
Code
<main class="app-main dashboard-main">
        <div id="auth-loading" class="loading-container" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 70vh;">
            <div class="spinner"></div>
            <p>Loading Your Performance Data...</p>
        </div>

        <div id="portalContent" style="display: none;">
            <div class="dashboard-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                 <div>
                    <h1 id="agentGreeting">Welcome!</h1>
                    <p id="agentSubtext" class="text-color-light">Historical performance data and agent analytics.</p>
                 </div>
                 <button id="exportDataBtn" class="action-button primary-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    Export My Data
                </button>
            </div>

            <div class="scorecard" style="margin-top: 1.5rem;">
                <div class="kpi-card">
                    <h4>Avg. Handling Time</h4>
                    <div class="kpi-value" id="kpiAvgTime">--:--</div>
                </div>
                <div class="kpi-card" style="border-left-color: var(--success-color);">
                    <h4>Customer Rating</h4>
                    <div class="kpi-value" id="kpiAvgRating">⭐ -.--</div>
                </div>
                <div class="kpi-card" style="border-left-color: var(--warning-color);">
                     <h4>Calls Completed</h4>
                    <div class="kpi-value" id="kpiTotalCalls">0</div>
                </div>
                <div class="kpi-card" style="border-left-color: var(--accent-color);">
                    <div class="progress-card" style="padding: 0; background: none;">
                        <div class="progress-title">
                            <span>Daily Target</span>
                            <span id="dailyTargetPercentage">0%</span>
                        </div>
                        <div class="progress-bar-container">
                            <div id="dailyTargetProgressBar" class="progress-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="portal-layout-grid">
                <div class="main-content-column">
                    <div class="call-history-container card">
                        <h2>Your Call History</h2>
                        <div class="filter-controls">
                            <div class="filter-grid">
                                <div><label for="searchInput">Search Scenario:</label><input type="text" id="searchInput" placeholder="Enter scenario name..."></div>
                                <div><label for="qualityFilter">Filter by Quality:</label><select id="qualityFilter"><option value="">All</option><option value="Good">Good</option><option value="Bad">Bad</option><option value="N/A">N/A</option></select></div>
                                <div><label for="startDateFilter">From Date:</label><input type="date" id="startDateFilter"></div>
                                <div><label for="endDateFilter">To Date:</label><input type="date" id="endDateFilter"></div>
                                <button id="resetFiltersBtn" class="action-button secondary-button">Reset Filters</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table id="callsTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Scenario</th>
                                        <th>Duration</th>
                                        <th>Completed</th>
                                        <th>Quality</th>
                                        <th>Reason</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                            <div id="noDataMessage" style="text-align: center; padding: 2rem; display:none; color: var(--text-color-subtle);"></div>
                        </div>
                        <div id="paginationControls" class="pagination-container"></div>
                    </div>
                    
                    <div class="widget-card widget-card-bordered">
                        <h3>My Saved Notes</h3>
                        <div id="savedNotesList" class="saved-notes-list"></div>
                        <p id="noNotesMessage" style="text-align: center; padding: 1rem; display:none; color: var(--text-color-subtle);">No notes saved yet.</p>
                        <div id="notesPaginationControls" class="pagination-container"></div>
                    </div>

                    <div class="widget-card">
                        <h3>My Training Programs</h3>
                        <div id="trainingProgramsList" class="training-programs-list"></div>
                        <p id="noTrainingMessage" style="text-align: center; padding: 1rem; display:none; color: var(--text-color-subtle);">You have no assigned training programs.</p>
                        <div id="trainingPaginationControls" class="pagination-container"></div>
                    </div>
                </div>

                <div class="sidebar-column">
                    <div class="widget-card">
                        <h3>Performance Summary</h3>
                        <ul class="performance-summary-list">
                            <li class="performance-summary-item">
                                <span>Total Calls (in view)</span>
                                <strong id="ins-total">0</strong>
                            </li>
                            <li class="performance-summary-item">
                                <span>Avg. Handling Time</span>
                                <strong id="ins-avg">0m 0s</strong>
                            </li>
                            <li class="performance-summary-item">
                                <span>Completion Rate</span>
                                <strong id="ins-completion">0%</strong>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="charts-container" style="display: flex; flex-direction: column; gap: 2rem;">
                        <div class="chart-container"><canvas id="qualityChart"></canvas></div>
                        
                        <div id="monthlyPerfComparison" class="widget-card perf-comparison-card" style="display: none;">
                            <h3>Monthly Performance Comparison</h3>
                            <p class="text-color-light" style="font-size: 0.9em; margin-top: -0.5rem; margin-bottom: 1rem;">'Bad' Quality Tickets</p>
                            <div class="comparison-grid">
                                <div class="comparison-metric">
                                    <h5>Last Month</h5>
                                    <p id="lastMonthBadCalls">0</p>
                                </div>
                                <div class="comparison-metric">
                                    <h5>This Month</h5>
                                    <p id="thisMonthBadCalls">0</p>
                                </div>
                            </div>
                            <div class="comparison-result">
                                <p id="perfChangeIndicator">--</p>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <canvas id="badReasonsChart"></canvas>
                            <p id="noBadCallsMessage" class="text-color-light" style="text-align: center; padding: 2rem; display: none;">No 'Bad' quality tickets recorded. Keep up the great work! ✨</p>
                        </div>
                    </div>
                    
                    <div class="widget-card">
                         <h3>Quick Scratchpad</h3>
                         <textarea id="agentScratchpad" placeholder="Jot down temporary notes here..."></textarea>
                         <div class="scratchpad-actions">
                             <button id="cancelNoteBtn" class="action-button secondary-button">Cancel</button>
                             <button id="saveNoteBtn" class="action-button primary-button">Save Note</button>
                         </div>
                    </div>
                    
                    <div class="widget-card">
                         <h3>Your Achievements</h3>
                         <ul class="achievements-list">
                             <li class="achievement-item"><span class="achievement-icon">🏆</span> Fastest Call Today: <strong id="achFastestCall">--:--</strong></li>
                             <li class="achievement-item"><span class="achievement-icon">✅</span> Tickets Completed: <strong id="achTicketsCompleted">0</strong></li>
                             <li class="achievement-item"><span class="achievement-icon">⭐</span> Top Quality Score</li>
                         </ul>
                    </div>
                    <div class="widget-card">
                         <h3>Resources</h3>
                         <a href="#" class="action-button primary-button" style="width: 100%;">Open Learning Hub</a>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="app-footer">
        <p>© <span id="currentYear"></span> Mohamed Elmenisy - Elevo Core. All rights reserved.</p>
    </footer>
</div>

<!-- Notes Modals -->
<div id="editNoteModal" class="modal">
    <div class="modal-content">
        <h3>Edit Note</h3>
        <textarea id="editNoteTextarea" placeholder="Edit your note..."></textarea>
        <div class="modal-actions">
            <button id="cancelEditBtn" class="action-button secondary-button">Cancel</button>
            <button id="saveChangesBtn" class="action-button primary-button">Save Changes</button>
        </div>
    </div>
</div>

<div id="deleteConfirmModal" class="modal">
    <div class="modal-content">
        <h3>Confirm Deletion</h3>
        <p>Are you sure you want to permanently delete this note? This action cannot be undone.</p>
        <div class="modal-actions">
            <button id="cancelDeleteBtn" class="action-button secondary-button">Cancel</button>
            <button id="confirmDeleteBtn" class="action-button danger-button">Delete</button>
        </div>
    </div>
</div>

<!-- Training Modals -->
<div id="deleteTrainingConfirmModal" class="modal">
    <div class="modal-content">
        <h3>Confirm Deletion</h3>
        <p>Are you sure you want to delete this training program? This action cannot be undone.</p>
        <div class="modal-actions">
            <button id="cancelTrainingDeleteBtn" class="action-button secondary-button">Cancel</button>
            <button id="confirmTrainingDeleteBtn" class="action-button danger-button">Delete</button>
        </div>
    </div>
</div>


<script type="module">
    const SUPABASE_URL = 'https://aefiigottnlcmjzilqnh.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlZmlpZ290dG5sY21qemlscW5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNzY2MDQsImV4cCI6MjA2Mjc1MjYwNH0.FypB02v3tGMnxXV9ZmZMdMC0oQpREKOJWgHMPxUzwX4';
    
    let supabase;
    try { supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); } 
    catch(e) { document.getElementById('auth-loading').innerHTML = `<p style="color:red">Error connecting to services.</p>`; }

    // DOM Elements
    const authLoadingDiv = document.getElementById('auth-loading');
    const portalContentDiv = document.getElementById('portalContent');
    const userNameSpan = document.getElementById('userName');
    const logoutButton = document.getElementById('logoutButton');
    const agentGreeting = document.getElementById('agentGreeting');
    const agentSubtext = document.getElementById('agentSubtext');
    const kpiTotalCalls = document.getElementById('kpiTotalCalls');
    const kpiAvgTime = document.getElementById('kpiAvgTime');
    const dailyTargetPercentage = document.getElementById('dailyTargetPercentage');
    const dailyTargetProgressBar = document.getElementById('dailyTargetProgressBar');
    const searchInput = document.getElementById('searchInput'), qualityFilter = document.getElementById('qualityFilter'),
          startDateFilter = document.getElementById('startDateFilter'), endDateFilter = document.getElementById('endDateFilter'),
          resetFiltersBtn = document.getElementById('resetFiltersBtn');
    const tableBody = document.querySelector('#callsTable tbody'), noDataMessage = document.getElementById('noDataMessage');
    const qualityChartCanvas = document.getElementById('qualityChart'), badReasonsChartCanvas = document.getElementById('badReasonsChart');
    const noBadCallsMessage = document.getElementById('noBadCallsMessage');
    const paginationControls = document.getElementById('paginationControls');
    const exportDataBtn = document.getElementById('exportDataBtn');
    const dashboardLink = document.getElementById('dashboardLink');
    const rtmDashboardLink = document.getElementById('rtmDashboardLink');
    document.getElementById('currentYear').textContent = new Date().getFullYear();
    
    const agentScratchpad = document.getElementById('agentScratchpad');
    const saveNoteBtn = document.getElementById('saveNoteBtn');
    const cancelNoteBtn = document.getElementById('cancelNoteBtn');
    const savedNotesList = document.getElementById('savedNotesList');
    const noNotesMessage = document.getElementById('noNotesMessage');
    const notesPaginationControls = document.getElementById('notesPaginationControls');
    
    const trainingProgramsList = document.getElementById('trainingProgramsList');
    const noTrainingMessage = document.getElementById('noTrainingMessage');
    const trainingPaginationControls = document.getElementById('trainingPaginationControls');
    
    const editNoteModal = document.getElementById('editNoteModal');
    const deleteConfirmModal = document.getElementById('deleteConfirmModal');
    const editNoteTextarea = document.getElementById('editNoteTextarea');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const saveChangesBtn = document.getElementById('saveChangesBtn');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

    const deleteTrainingConfirmModal = document.getElementById('deleteTrainingConfirmModal');
    const cancelTrainingDeleteBtn = document.getElementById('cancelTrainingDeleteBtn');
    const confirmTrainingDeleteBtn = document.getElementById('confirmTrainingDeleteBtn');

    let qualityChartInstance, badReasonsChartInstance;

    // State
    let currentUser = null, allUserCalls = [], filteredCalls = [], filterTimeout;
    let currentPage = 1, ROWS_PER_PAGE = 6;
    let currentNotesPage = 1, NOTES_PER_PAGE = 5;
    let currentTrainingPage = 1, TRAININGS_PER_PAGE = 3;
    let noteToEditTimestamp = null, noteToDeleteTimestamp = null;
    let trainingToDeleteIndex = null;
    const DAILY_TICKET_TARGET = 20;
    const NOTES_STORAGE_KEY_PREFIX = 'agentSavedNotes_';
    let NOTES_STORAGE_KEY = '';
    const EGYPT_TIMEZONE = 'Africa/Cairo';
    
    // Mock data for training programs
    let mockTrainingPrograms = [
         { id: 1, title: 'Advanced Conflict Resolution', status: 'Completed', reason: 'Repeated "Bad" quality calls related to customer complaints.', assignedBy: 'Admin Supervisor', date: 'Oct 01, 2025' },
         { id: 2, title: 'Product Knowledge Update Q4', status: 'In Progress', reason: 'Mandatory quarterly update for all agents.', assignedBy: 'System', date: 'Oct 15, 2025' },
         { id: 3, title: 'Effective Communication Strategies', status: 'Completed', reason: 'Agent self-enrollment for skill improvement.', assignedBy: 'Self', date: 'Sep 20, 2025' },
         { id: 4, title: 'CRM Software Update v3.2', status: 'Completed', reason: 'System-wide software update training.', assignedBy: 'System', date: 'Aug 15, 2025' },
         { id: 5, title: 'Handling Difficult Customers', status: 'In Progress', reason: 'Assigned based on low customer satisfaction scores.', assignedBy: 'QA Team', date: 'Oct 25, 2025' },
         { id: 6, title: 'Data Privacy & Security Protocols', status: 'Completed', reason: 'Annual compliance training.', assignedBy: 'System', date: 'Jul 01, 2025' },
         { id: 7, title: 'Advanced Sales Techniques', status: 'Not Started', reason: 'Optional course for high-performing agents.', assignedBy: 'System', date: 'Nov 01, 2025' },
    ];


    function formatDateTimeEgypt(dateString, options = {}) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        const defaultOptions = { timeZone: EGYPT_TIMEZONE, year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute:'2-digit', hour12: true };
        return date.toLocaleString('en-US', { ...defaultOptions, ...options });
    }
    
    // --- Notes Functions ---
    function renderNotesPagination(totalNotes) {
        notesPaginationControls.innerHTML = '';
        const totalPages = Math.ceil(totalNotes / NOTES_PER_PAGE);
        if (totalPages <= 1) return;
        const paginationHTML = `
            <button ${currentNotesPage === 1 ? 'disabled' : ''} data-page="${currentNotesPage - 1}">&laquo; Prev</button>
            <span>Page ${currentNotesPage} of ${totalPages}</span>
            <button ${currentNotesPage === totalPages ? 'disabled' : ''} data-page="${currentNotesPage + 1}">Next &raquo;</button>
        `;
        notesPaginationControls.innerHTML = paginationHTML;
    }

    function renderSavedNotes() {
        const notes = JSON.parse(localStorage.getItem(NOTES_STORAGE_KEY) || '[]');
        savedNotesList.innerHTML = '';

        noNotesMessage.style.display = notes.length === 0 ? 'block' : 'none';
        if(notes.length === 0) { notesPaginationControls.innerHTML = ''; return; }
        
        notes.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        const startIndex = (currentNotesPage - 1) * NOTES_PER_PAGE;
        const paginatedNotes = notes.slice(startIndex, startIndex + NOTES_PER_PAGE);

        paginatedNotes.forEach(note => {
            const formattedDateTime = formatDateTimeEgypt(note.timestamp);
            const sanitizedText = document.createElement('div');
            sanitizedText.innerText = note.text;
            
            savedNotesList.innerHTML += `
                <div class="note-card">
                    <div class="note-header">
                         <div class="note-timestamp"><span>${formattedDateTime}</span></div>
                        <div class="note-actions">
                             <button class="note-action-btn edit-note-btn" title="Edit Note" data-timestamp="${note.timestamp}"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                            <button class="note-action-btn delete-note-btn" title="Delete Note" data-timestamp="${note.timestamp}"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>
                        </div>
                    </div>
                    <div class="note-content"><p>${sanitizedText.innerHTML.replace(/\n/g, '<br>')}</p></div>
                </div>`;
        });
        renderNotesPagination(notes.length);
    }

    function saveCurrentNote() {
        const noteText = agentScratchpad.value.trim();
        if (!noteText) return;
        const notes = JSON.parse(localStorage.getItem(NOTES_STORAGE_KEY) || '[]');
        notes.push({ text: noteText, timestamp: new Date().toISOString() });
        localStorage.setItem(NOTES_STORAGE_KEY, JSON.stringify(notes));
        agentScratchpad.value = '';
        currentNotesPage = 1;
        renderSavedNotes(); 
    }

    function updateNote(timestamp, newText) {
        let notes = JSON.parse(localStorage.getItem(NOTES_STORAGE_KEY) || '[]');
        const noteIndex = notes.findIndex(note => note.timestamp === timestamp);
        if (noteIndex > -1) {
            notes[noteIndex].text = newText;
            localStorage.setItem(NOTES_STORAGE_KEY, JSON.stringify(notes));
            renderSavedNotes();
        }
    }

    function deleteNote(timestamp) {
        let notes = JSON.parse(localStorage.getItem(NOTES_STORAGE_KEY) || '[]');
        notes = notes.filter(note => note.timestamp !== timestamp);
        const totalPages = Math.ceil(notes.length / NOTES_PER_PAGE);
        if(currentNotesPage > totalPages) currentNotesPage = totalPages || 1;
        localStorage.setItem(NOTES_STORAGE_KEY, JSON.stringify(notes));
        renderSavedNotes();
    }
    
    function openEditModal(timestamp) {
        const note = JSON.parse(localStorage.getItem(NOTES_STORAGE_KEY) || '[]').find(n => n.timestamp === timestamp);
        if(note) { noteToEditTimestamp = timestamp; editNoteTextarea.value = note.text; editNoteModal.classList.add('visible'); }
    }
    function closeEditModal() { editNoteModal.classList.remove('visible'); noteToEditTimestamp = null; }
    function openDeleteConfirmModal(timestamp) { noteToDeleteTimestamp = timestamp; deleteConfirmModal.classList.add('visible'); }
    function closeDeleteConfirmModal() { deleteConfirmModal.classList.remove('visible'); noteToDeleteTimestamp = null; }
    
    
    // --- Training Functions ---
    function renderTrainingPagination(totalTrainings) {
        trainingPaginationControls.innerHTML = '';
        const totalPages = Math.ceil(totalTrainings / TRAININGS_PER_PAGE);
        if (totalPages <= 1) return;
        const paginationHTML = `
            <button ${currentTrainingPage === 1 ? 'disabled' : ''} data-page="${currentTrainingPage - 1}">&laquo; Prev</button>
            <span>Page ${currentTrainingPage} of ${totalPages}</span>
            <button ${currentTrainingPage === totalPages ? 'disabled' : ''} data-page="${currentTrainingPage + 1}">Next &raquo;</button>
        `;
        trainingPaginationControls.innerHTML = paginationHTML;
    }
    
    function openDeleteTrainingModal(trainingId) {
        trainingToDeleteIndex = mockTrainingPrograms.findIndex(p => p.id === trainingId);
        if (trainingToDeleteIndex > -1) {
            deleteTrainingConfirmModal.classList.add('visible');
        }
    }
    function closeDeleteTrainingModal() {
        deleteTrainingConfirmModal.classList.remove('visible');
        trainingToDeleteIndex = null;
    }
    function deleteTrainingProgram() {
        if (trainingToDeleteIndex > -1) {
            mockTrainingPrograms.splice(trainingToDeleteIndex, 1);
            const totalPages = Math.ceil(mockTrainingPrograms.length / TRAININGS_PER_PAGE);
            if(currentTrainingPage > totalPages) currentTrainingPage = totalPages || 1;
            renderTrainingPrograms();
        }
        closeDeleteTrainingModal();
    }

    function renderTrainingPrograms() {
        const programs = mockTrainingPrograms;
        trainingProgramsList.innerHTML = '';
        noTrainingMessage.style.display = programs.length === 0 ? 'block' : 'none';
        if(programs.length === 0) { trainingPaginationControls.innerHTML = ''; return; }
        
        const startIndex = (currentTrainingPage - 1) * TRAININGS_PER_PAGE;
        const paginatedPrograms = programs.slice(startIndex, startIndex + TRAININGS_PER_PAGE);

        paginatedPrograms.forEach(p => {
            const isCompleted = p.status === 'Completed';
            const statusClass = p.status.toLowerCase().replace(' ', '-');
            trainingProgramsList.innerHTML += `
                <div class="training-card ${isCompleted ? 'completed' : ''}">
                    <div class="training-card-header">
                        <h4>${p.title}</h4>
                        <span class="training-status ${statusClass}">${p.status}</span>
                    </div>
                    <div class="training-card-body">
                        <p><strong>Reason:</strong> ${p.reason}</p>
                        <p><strong>Assigned by:</strong> ${p.assignedBy}</p>
                    </div>
                    <div class="training-card-footer">
                        <span class="training-card-date">
                            ${isCompleted ? 'Completed on' : 'Due by'}: ${p.date}
                        </span>
                        <div class="training-card-actions">
                            <button class="note-action-btn view-note-btn" title="View Details" data-training-id="${p.id}" data-action="view">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                            </button>
                            <button class="note-action-btn edit-note-btn" title="Edit Training" data-training-id="${p.id}" data-action="edit">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                            </button>
                            <button class="note-action-btn delete-note-btn" title="Delete Training" data-training-id="${p.id}" data-action="delete">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>`;
        });
        renderTrainingPagination(programs.length);
    }
    

    // --- Main Portal Logic ---
    async function initializePortal() {
        if (!supabase) return;
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) { window.location.replace('login.html'); return; }

        const storedUserData = JSON.parse(localStorage.getItem('elevoCoreUserData'));
         if (storedUserData && storedUserData.id === session.user.id) {
            currentUser = storedUserData;
        } else {
            const { data: profile } = await supabase.from('users').select('name, is_admin').eq('id', session.user.id).single();
            currentUser = { id: session.user.id, email: session.user.email, name: profile?.name || session.user.email, isAdmin: profile?.is_admin || false };
            localStorage.setItem('elevoCoreUserData', JSON.stringify(currentUser));
        }
        NOTES_STORAGE_KEY = `${NOTES_STORAGE_KEY_PREFIX}${currentUser.id}`;

        setupUI();
        await loadAgentData();
        setupEventListeners();
        authLoadingDiv.style.display = 'none';
        portalContentDiv.style.display = 'block';
    }

    function setupUI() {
        userNameSpan.textContent = currentUser.name;
        agentGreeting.innerHTML = `👋 Welcome back, <span style="color: var(--success-color);">${currentUser.name}</span>!`;
        agentSubtext.textContent = `Historical performance data and agent analytics.`;
        document.getElementById('userInfo').style.display = 'flex';
        
        if (currentUser.isAdmin) {
            if(dashboardLink) dashboardLink.style.display = 'inline-block';
            if(rtmDashboardLink) rtmDashboardLink.style.display = 'inline-block';
        }
        renderSavedNotes();
        renderTrainingPrograms();
    }

    async function loadAgentData() {
        try {
            const { data, error } = await supabase.from('call_sessions').select('*, scenario:call_scenarios(title)').eq('user_id', currentUser.id).order('start_time_egypt', { ascending: false });
            if (error) throw error;
            allUserCalls = data;
            applyFiltersAndRender();
        } catch (err) {
            console.error('Failed to load agent call data:', err);
            noDataMessage.textContent = 'Could not load your call history. Please try again later.';
            noDataMessage.style.display = 'block';
            tableBody.innerHTML = '';
        }
    }

    function applyFiltersAndRender() {
        const searchTerm = searchInput.value.toLowerCase();
        const quality = qualityFilter.value;
        const startDate = startDateFilter.value;
        const endDate = endDateFilter.value;

        filteredCalls = allUserCalls.filter(call => {
            const callDate = new Date(call.start_time_egypt);
            const matchesSearch = !searchTerm || (call.scenario?.title || '').toLowerCase().includes(searchTerm);
            const matchesQuality = !quality || call.call_quality === quality;
            const matchesStartDate = !startDate || callDate >= new Date(startDate + "T00:00:00.000Z");
            const matchesEndDate = !endDate || callDate <= new Date(endDate + "T23:59:59.999Z");
            return matchesSearch && matchesQuality && matchesStartDate && matchesEndDate;
        });

        currentPage = 1;
        updateStats(filteredCalls);
        updateMonthlyComparison(allUserCalls);
        renderTable();
        renderPagination();
        renderCharts(filteredCalls);
    }
    
    function resetFilters() {
        searchInput.value = ''; qualityFilter.value = '';
        startDateFilter.value = ''; endDateFilter.value = '';
        applyFiltersAndRender();
    }
    
    function updateStats(calls) {
        const today = new Date();
        const startOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate()).toISOString();
        const todaysCalls = allUserCalls.filter(c => c.start_time_egypt >= startOfToday);

        kpiTotalCalls.textContent = allUserCalls.length;
        document.getElementById('ins-total').textContent = calls.length;

        const callsWithDuration = calls.filter(call => typeof call.duration === 'number');
        const totalDuration = callsWithDuration.reduce((acc, call) => acc + call.duration, 0);
        
        let avgTimeText = '0m 00s';
        if (callsWithDuration.length > 0) {
            const avgDuration = Math.round(totalDuration / callsWithDuration.length);
            avgTimeText = `${Math.floor(avgDuration / 60)}m ${String(avgDuration % 60).padStart(2, '0')}s`;
        }
        kpiAvgTime.textContent = avgTimeText;
        document.getElementById('ins-avg').textContent = avgTimeText;

        const completedCalls = calls.filter(c => c.completed).length;
        const completionRate = calls.length > 0 ? Math.round((completedCalls / calls.length) * 100) : 0;
        document.getElementById('ins-completion').textContent = `${completionRate}%`;
        
        const targetPercent = Math.min(100, Math.round((todaysCalls.length / DAILY_TICKET_TARGET) * 100));
        dailyTargetPercentage.textContent = `${targetPercent}%`;
        dailyTargetProgressBar.style.width = `${targetPercent}%`;
        document.getElementById('achTicketsCompleted').textContent = allUserCalls.filter(c => c.completed).length;
    }

    function updateMonthlyComparison(allCalls) {
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth();

        const thisMonthBadCalls = allCalls.filter(call => {
            const callDate = new Date(call.start_time_egypt);
            return call.call_quality === 'Bad' && callDate.getFullYear() === currentYear && callDate.getMonth() === currentMonth;
        }).length;

        const lastMonthDate = new Date();
        lastMonthDate.setMonth(currentMonth - 1);
        const lastMonthYear = lastMonthDate.getFullYear();
        const lastMonth = lastMonthDate.getMonth();
        
        const lastMonthBadCalls = allCalls.filter(call => {
            const callDate = new Date(call.start_time_egypt);
            return call.call_quality === 'Bad' && callDate.getFullYear() === lastMonthYear && callDate.getMonth() === lastMonth;
        }).length;
        
        document.getElementById('thisMonthBadCalls').textContent = thisMonthBadCalls;
        document.getElementById('lastMonthBadCalls').textContent = lastMonthBadCalls;

        const indicator = document.getElementById('perfChangeIndicator');
        if (lastMonthBadCalls > 0) {
            const change = ((thisMonthBadCalls - lastMonthBadCalls) / lastMonthBadCalls) * 100;
            if (change < 0) {
                indicator.className = 'improvement';
                indicator.innerHTML = `📈 <span>${Math.abs(change).toFixed(0)}% Improvement</span><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>`;
            } else if (change > 0) {
                indicator.className = 'decline';
                indicator.innerHTML = `📉 <span>${change.toFixed(0)}% Decline</span><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>`;
            } else {
                 indicator.className = '';
                 indicator.textContent = 'No change from last month';
            }
        } else if (thisMonthBadCalls > 0) {
            indicator.className = 'decline';
            indicator.textContent = '😟 Increase from zero';
        } else {
            indicator.className = 'improvement';
            indicator.textContent = '✅ Excellent! No "Bad" calls.';
        }
        document.getElementById('monthlyPerfComparison').style.display = 'block';
    }

    function renderTable() {
        tableBody.innerHTML = '';
        noDataMessage.style.display = filteredCalls.length === 0 ? 'block' : 'none';
        noDataMessage.textContent = allUserCalls.length > 0 ? 'No calls match the current filters.' : 'You have no call history yet.';
        
        const paginatedCalls = filteredCalls.slice((currentPage - 1) * ROWS_PER_PAGE, currentPage * ROWS_PER_PAGE);
        paginatedCalls.forEach(call => {
            const dur = call.duration || 0;
            tableBody.innerHTML += `<tr>
                <td>${new Date(call.start_time_egypt).toLocaleDateString('en-GB', { timeZone: EGYPT_TIMEZONE })}</td>
                <td>${call.scenario?.title || 'N/A'}</td>
                <td>${Math.floor(dur / 60)}m ${String(dur % 60).padStart(2, '0')}s</td>
                <td>${call.completed ? '✅ Yes' : '❌ No'}</td>
                <td><span class="quality-text quality-${(call.call_quality || 'na').toLowerCase()}">${call.call_quality || 'N/A'}</span></td>
                <td>${call.quality_reason || '-'}</td>
            </tr>`;
        });
    }
    
    function renderPagination() {
        paginationControls.innerHTML = '';
        const totalPages = Math.ceil(filteredCalls.length / ROWS_PER_PAGE);
        if (totalPages <= 1) return;
        paginationControls.innerHTML = `
            <button ${currentPage === 1 ? 'disabled' : ''}>&laquo; Previous</button>
            <span>Page ${currentPage} of ${totalPages}</span>
            <button ${currentPage === totalPages ? 'disabled' : ''}>Next &raquo;</button>
        `;
    }
    
    function renderCharts(calls) {
        const FONT_COLOR = '#D1D5DB'; // Using a light gray for better visibility
        const FONT_SIZE_TITLE = 16, FONT_SIZE_LEGEND = 13;
        const CHART_COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#6366f1', '#8b5cf6'];
        
        if (qualityChartInstance) qualityChartInstance.destroy();
        const qualityCounts = calls.reduce((acc, call) => {
            const quality = call.call_quality || 'N/A';
            acc[quality] = (acc[quality] || 0) + 1;
            return acc;
        }, {});

        qualityChartInstance = new Chart(qualityChartCanvas, {
            type: 'pie', data: { 
                labels: ['Good', 'Bad', 'N/A'],
                datasets: [{ 
                    data: [qualityCounts['Good'] || 0, qualityCounts['Bad'] || 0, qualityCounts['N/A'] || 0],
                    backgroundColor: ['#10b981', '#ef4444', '#6b7280'],
                    borderColor: '#4A5568', borderWidth: 2, hoverOffset: 8
                }] 
            }, options: { responsive: true, maintainAspectRatio: false,
                plugins: { 
                    legend: { position: 'bottom', labels: { color: FONT_COLOR, font: { size: FONT_SIZE_LEGEND } } }, 
                    title: { display: true, text: 'Your Call Quality Breakdown', color: FONT_COLOR, font: { size: FONT_SIZE_TITLE } } 
                }
            }
        });

        const badCalls = calls.filter(c => c.call_quality === 'Bad' && c.quality_reason);
        const showBadChartWithData = badCalls.length > 0;
        badReasonsChartCanvas.style.display = 'block';
        noBadCallsMessage.style.display = 'none';

        if(badReasonsChartInstance) badReasonsChartInstance.destroy();
        
        let badChartLabels, badChartData, badChartColors;

        if(showBadChartWithData) {
            const reasonCounts = badCalls.reduce((acc, c) => { acc[c.quality_reason] = (acc[c.quality_reason] || 0) + 1; return acc; }, {});
            badChartLabels = Object.keys(reasonCounts);
            badChartData = Object.values(reasonCounts);
            badChartColors = CHART_COLORS;
        } else {
            badChartLabels = ["No 'Bad' Quality Calls Recorded"];
            badChartData = [1];
            badChartColors = ['#4B5563'];
        }
        
        badReasonsChartInstance = new Chart(badReasonsChartCanvas, {
            type: 'doughnut', data: { 
                labels: badChartLabels, 
                datasets: [{ data: badChartData, backgroundColor: badChartColors, 
                    hoverOffset: 4, borderColor: '#4A5568', borderWidth: 2 }] 
            }, options: { responsive: true, maintainAspectRatio: false, 
                plugins: { 
                    legend: { position: 'bottom', labels: { color: FONT_COLOR, font: { size: FONT_SIZE_LEGEND },
                      // Hide legend if there is no data
                      filter: (legendItem, chartData) => showBadChartWithData
                    } }, 
                    title: { display: true, text: "Reasons for 'Bad' Calls", color: FONT_COLOR, font: { size: FONT_SIZE_TITLE } }
                } 
            }
        });
    }

    function setupEventListeners() {
        logoutButton.addEventListener('click', async () => { await supabase.auth.signOut(); localStorage.clear(); window.location.replace("login.html"); });
        [searchInput, qualityFilter, startDateFilter, endDateFilter].forEach(el => { el.addEventListener('input', () => { clearTimeout(filterTimeout); filterTimeout = setTimeout(applyFiltersAndRender, 400); }); });
        resetFiltersBtn.addEventListener('click', resetFilters);
        exportDataBtn.addEventListener('click', () => exportTableToCSV('my_call_history.csv'));
        
        saveNoteBtn.addEventListener('click', saveCurrentNote);
        cancelNoteBtn.addEventListener('click', () => { agentScratchpad.value = ''; });
        
        savedNotesList.addEventListener('click', (e) => {
            const editButton = e.target.closest('.edit-note-btn');
            const deleteButton = e.target.closest('.delete-note-btn');
            if (editButton) openEditModal(editButton.dataset.timestamp);
            if (deleteButton) openDeleteConfirmModal(deleteButton.dataset.timestamp);
        });

        trainingProgramsList.addEventListener('click', (e) => {
            const actionButton = e.target.closest('.note-action-btn');
            if (!actionButton) return;
            
            const trainingId = parseInt(actionButton.dataset.trainingId);
            const action = actionButton.dataset.action;

            if (action === 'delete') {
                openDeleteTrainingModal(trainingId);
            } else if (action === 'edit') {
                // Placeholder for edit functionality - NO ALERT
                console.log(`Edit action for training ID ${trainingId}`);
            } else if (action === 'view') {
                // Placeholder for view functionality - NO ALERT
                console.log(`View action for training ID ${trainingId}`);
            }
        });
        
        paginationControls.addEventListener('click', e => {
            if(e.target.tagName === 'BUTTON' && !e.target.disabled) {
                currentPage = e.target.textContent.includes('Next') ? currentPage + 1 : currentPage - 1;
                renderTable();
                renderPagination();
            }
        });

        notesPaginationControls.addEventListener('click', e => {
             if(e.target.tagName === 'BUTTON' && !e.target.disabled) {
                currentNotesPage = parseInt(e.target.dataset.page);
                renderSavedNotes();
            }
        });

        trainingPaginationControls.addEventListener('click', e => {
             if(e.target.tagName === 'BUTTON' && !e.target.disabled) {
                currentTrainingPage = parseInt(e.target.dataset.page);
                renderTrainingPrograms();
            }
        });
        
        cancelEditBtn.addEventListener('click', closeEditModal);
        saveChangesBtn.addEventListener('click', () => {
            const newText = editNoteTextarea.value.trim();
            if(noteToEditTimestamp && newText) updateNote(noteToEditTimestamp, newText);
            closeEditModal();
        });
        
        cancelDeleteBtn.addEventListener('click', closeDeleteConfirmModal);
        confirmDeleteBtn.addEventListener('click', () => {
            if(noteToDeleteTimestamp) deleteNote(noteToDeleteTimestamp);
            closeDeleteConfirmModal();
        });

        cancelTrainingDeleteBtn.addEventListener('click', closeDeleteTrainingModal);
        confirmTrainingDeleteBtn.addEventListener('click', deleteTrainingProgram);
        
        [editNoteModal, deleteConfirmModal, deleteTrainingConfirmModal].forEach(modal => {
            modal.addEventListener('click', (e) => { if(e.target === modal) e.target.classList.remove('visible'); });
        });
    }

    if (supabase) initializePortal();
</script>
<script>
(function(){
  try{
    const sel = document.querySelector('select[name="scenario"]') || document.querySelector('select');
    function markScenario(){ 
      if(!sel) return;
      const opt = sel.options[sel.selectedIndex];
      const el = document.querySelector('.scenario-name') || document.getElementById('selectedScenarioName') || document.querySelector('.scenario-selected');
      if(opt && el){ el.textContent = opt.text; el.classList.add('scenario-selected'); }
    }
    if(sel){ sel.addEventListener('change', markScenario); markScenario(); }
  }catch(e){ console.warn(e); }
})();

function exportTableToCSV(filename = 'report.csv') {
  const table = document.querySelector('#callsTable') || document.querySelector('table');
  if(!table) return alert('No table found to export');
  const header = Array.from(table.querySelectorAll('thead th')).map(th => '"' + th.innerText.replace(/"/g,'""') + '"').join(',');
  const rows = Array.from(table.querySelectorAll('tbody tr')).map(tr => 
    Array.from(tr.querySelectorAll('td')).map(td => '"' + td.innerText.replace(/"/g,'""') + '"').join(',')
  );
  const csvContent = [header, ...rows].join('\n');
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.style.display='none';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
document.getElementById('exportDataBtn')?.addEventListener('click', () => exportTableToCSV('my_call_history.csv'));
</script>
</body>
</html>
