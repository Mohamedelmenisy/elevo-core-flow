<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Portal - Elevo Core</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234e8cff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M12 22V12M9 19l3-3 3 3M12 2a4 4 0 0 0-4 4v0a4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4z'/></svg>">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .portal-main {
            width: 100%;
            max-width: none;
            padding: 1.5rem 2rem;
            text-align: left;
        }
        
        .agent-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .stat-card {
            background-color: var(--card-bg-color);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border-left: 4px solid var(--primary-color);
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.15);
        }
        
        .stat-card h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.1em;
            color: var(--text-color-light);
            font-weight: 500;
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            margin: 0.5rem 0;
            color: var(--text-color);
        }
        
        .stat-trend {
            display: flex;
            align-items: center;
            font-size: 0.9em;
            margin-top: 0.5rem;
            color: var(--text-color-light);
        }
        
        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .scenario-card {
            background-color: var(--card-bg-color);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }
        
        .scenario-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-color: var(--primary-color);
        }
        
        .scenario-card h4 {
            margin: 0 0 0.75rem 0;
            font-size: 1.1em;
            color: var(--text-color);
            font-weight: 600;
        }
        
        .scenario-description {
            color: var(--text-color-light);
            font-size: 0.9em;
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }
        
        .scenario-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            font-size: 0.85em;
        }
        
        .stat-badge {
            background: var(--input-bg-color);
            padding: 0.4rem 0.8rem;
            border-radius: 2rem;
            font-weight: 500;
        }
        
        .start-scenario-btn {
            width: 100%;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .start-scenario-btn:hover {
            background: var(--primary-color-dark);
            transform: translateY(-1px);
        }
        
        .performance-section {
            margin-top: 3rem;
        }
        
        .performance-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .performance-card {
            background: var(--card-bg-color);
            padding: 1.5rem;
            border-radius: 1rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .performance-value {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }
        
        .performance-label {
            font-size: 0.9em;
            color: var(--text-color-light);
        }

        /* Access Restricted Styling - Enhanced */
        .access-denied-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 70vh;
            padding: 2rem;
        }

        .access-card {
            text-align: center;
            background: var(--card-bg-color);
            padding: 3rem 2.5rem;
            border-radius: 1rem;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                0 2px 8px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 450px;
            width: 100%;
        }

        .access-icon {
            font-size: 3rem;
            margin-bottom: 1.5rem;
            filter: grayscale(0.3);
        }

        .access-card h2 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            color: var(--text-color);
            font-weight: 600;
        }

        .access-card p {
            font-size: 1rem;
            color: var(--text-color-light);
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }

        .access-card .subtext {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 2rem;
        }

        .primary-cta {
            background: var(--primary-color);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 500;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            min-width: 200px;
            margin-top: 0.5rem;
        }

        .primary-cta:hover {
            background: var(--primary-color-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .primary-cta:active {
            transform: translateY(0);
        }

        /* Dark mode enhancements */
        .dark .access-card {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.3);
        }

        @media (max-width: 768px) {
            .portal-main {
                padding: 1rem;
            }
            
            .agent-stats-grid,
            .scenario-grid {
                grid-template-columns: 1fr;
            }
            
            .access-denied-container {
                padding: 1rem;
            }
            
            .access-card {
                padding: 2rem 1.5rem;
            }
            
            .access-icon {
                font-size: 2.5rem;
            }
            
            .access-card h2 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="logo-container">
                <svg class="company-logo" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: var(--primary-color); width: 28px; height: 28px;">
                    <path d="M12 22V12M9 19l3-3 3 3M12 2a4 4 0 0 0-4 4v0a4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span class="app-title" style="font-size: 1.4rem;">Elevo Core - Agent Portal</span>
            </div>
            <div class="header-controls">
                <a href="core-flow.html" class="nav-link">Call App</a>
                <a href="admin-dashboard.html" class="nav-link">Admin Dashboard</a>
                <a href="rtm-dashboard.html" class="nav-link">RTM Dashboard</a>
                <div class="user-info" id="userInfo" style="display: none;">
                    <span id="userName" class="user-name-display"></span>
                    <button id="logoutButton" class="logout-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <main class="app-main portal-main">
            <div id="auth-loading" class="loading-container" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 70vh;">
                <div class="spinner"></div>
                <p style="font-size: 1.1rem; color: var(--text-color-light); margin-top: 1rem;">Loading your agent portal...</p>
            </div>

            <div id="portalContent" style="display: none;">
                <!-- Welcome Section -->
                <div class="welcome-section" style="margin-bottom: 2rem;">
                    <h1>Welcome, <span id="agentName">Agent</span>! 👋</h1>
                    <p class="text-color-light">Manage your calls, track performance, and access scenarios</p>
                </div>

                <!-- Quick Stats -->
                <div class="agent-stats-grid">
                    <div class="stat-card">
                        <h3>Today's Calls</h3>
                        <div class="stat-value" id="todayCallsCount">0</div>
                        <div class="stat-trend">
                            <span class="trend-icon">📞</span>
                            <span>Total calls handled today</span>
                        </div>
                    </div>
                    
                    <div class="stat-card" style="border-left-color: var(--success-color);">
                        <h3>Completion Rate</h3>
                        <div class="stat-value" id="completionRate">0%</div>
                        <div class="stat-trend">
                            <span class="trend-icon">✅</span>
                            <span>Successful call completion</span>
                        </div>
                    </div>
                    
                    <div class="stat-card" style="border-left-color: var(--warning-color);">
                        <h3>Avg Handle Time</h3>
                        <div class="stat-value" id="avgHandleTime">0m</div>
                        <div class="stat-trend">
                            <span class="trend-icon">⏱️</span>
                            <span>Average call duration</span>
                        </div>
                    </div>
                    
                    <div class="stat-card" style="border-left-color: var(--accent-color);">
                        <h3>Quality Score</h3>
                        <div class="stat-value" id="qualityScore">0%</div>
                        <div class="stat-trend">
                            <span class="trend-icon">⭐</span>
                            <span>Call quality assessment</span>
                        </div>
                    </div>
                </div>

                <!-- Available Scenarios -->
                <div class="scenarios-section" style="margin-top: 3rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2>Available Scenarios</h2>
                        <button id="refreshScenariosBtn" class="action-button secondary-button" style="font-size: 0.9rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M23 4v6h-6"></path>
                                <path d="M1 20v-6h6"></path>
                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                            </svg>
                            Refresh
                        </button>
                    </div>
                    
                    <div class="scenario-grid" id="scenariosContainer">
                        <!-- Scenarios will be loaded here -->
                    </div>
                </div>

                <!-- Performance Overview -->
                <div class="performance-section">
                    <h2>Your Performance Overview</h2>
                    <div class="performance-cards">
                        <div class="performance-card">
                            <div class="performance-value" id="totalCalls">0</div>
                            <div class="performance-label">Total Calls</div>
                        </div>
                        <div class="performance-card">
                            <div class="performance-value" id="goodCalls">0</div>
                            <div class="performance-label">Good Quality</div>
                        </div>
                        <div class="performance-card">
                            <div class="performance-value" id="badCalls">0</div>
                            <div class="performance-label">Needs Improvement</div>
                        </div>
                        <div class="performance-card">
                            <div class="performance-value" id="successRate">0%</div>
                            <div class="performance-label">Success Rate</div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="recent-activity" style="margin-top: 3rem;">
                    <h2>Recent Activity</h2>
                    <div id="recentActivityContainer" style="margin-top: 1rem;">
                        <!-- Recent calls will be loaded here -->
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="app-footer">
            <p>© <span id="currentYear"></span> Mohamed Elmenisy - Elevo Core. All rights reserved.</p>
        </footer>
    </div>
        <script type="module">
        const SUPABASE_URL = 'https://aefiigottnlcmjzilqnh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlZmlpZ290dG5sY21qemlscW5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNzY2MDQsImV4cCI6MjA2Mjc1MjYwNH0.FypB02v3tGMnxXV9ZmZMdMC0oQpREKOJWgHMPxUzwX4';
        
        let supabase;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (error) {
            console.error("Supabase client initialization failed:", error);
            document.getElementById('auth-loading').innerHTML = '<p style="color:var(--danger-color); text-align:center;">Error connecting to services. Please try again later.</p>';
        }

        // Global variables
        let currentUser = null;
        let currentAgentId = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            await checkAuth();
            setupEventListeners();
        });

        // Authentication and Role Check - FIXED VERSION
        async function checkAuth() {
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                if (error || !user) {
                    window.location.href = 'index.html';
                    return;
                }
                
                currentUser = user;

                // إضافة معالجة أفضل للأخطاء
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('role, name, id')
                    .eq('id', user.id)
                    .single();

                // معالجة الحالات المختلفة بشكل أكثر دقة
                if (userError) {
                    console.error('Error fetching user data:', userError);
                    document.getElementById('auth-loading').style.display = 'none';
                    document.querySelector('.app-main').innerHTML = `
                        <div class="access-denied-container">
                            <div class="access-card">
                                <div class="access-icon">⚠️</div>
                                <h2>Service Temporarily Unavailable</h2>
                                <p>Unable to verify user permissions. Please try again later.</p>
                                <button class="back-btn primary-cta" onclick="window.location.href='index.html'">
                                    Back to Login
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }

                if (!userData) {
                    document.getElementById('auth-loading').style.display = 'none';
                    document.querySelector('.app-main').innerHTML = `
                        <div class="access-denied-container">
                            <div class="access-card">
                                <div class="access-icon">🚫</div>
                                <h2>Access Restricted</h2>
                                <p>Your account is not properly configured.</p>
                                <p class="subtext">Please contact your administrator for assistance.</p>
                                <button class="back-btn primary-cta" onclick="window.location.href='index.html'">
                                    Back to Login
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // إذا كل شيء سليم
                currentAgentId = userData.id;
                document.getElementById('userInfo').style.display = 'flex';
                document.getElementById('userName').textContent = userData.name || currentUser.email;
                document.getElementById('agentName').textContent = userData.name || 'Agent';
                document.getElementById('auth-loading').style.display = 'none';
                document.getElementById('portalContent').style.display = 'block';
                await loadAgentData();
                
            } catch (error) {
                console.error('Authentication error:', error);
                document.getElementById('auth-loading').innerHTML = `
                    <p style="color:var(--danger-color); text-align:center;">
                        Authentication error occurred. Please <a href="index.html" style="color:var(--primary-color);">login again</a>.
                    </p>
                `;
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('logoutButton').addEventListener('click', async () => {
                await supabase.auth.signOut();
                window.location.href = 'index.html';
            });
            
            document.getElementById('refreshScenariosBtn')?.addEventListener('click', loadScenarios);
        }

        // Load all agent data
        async function loadAgentData() {
            try {
                await Promise.all([
                    loadAgentStats(),
                    loadScenarios(),
                    loadPerformanceOverview(),
                    loadRecentActivity()
                ]);
            } catch (error) {
                console.error('Error loading agent data:', error);
            }
        }

        // Load agent statistics
        async function loadAgentStats() {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                // Get today's calls for this agent
                const { data: todayCalls, error } = await supabase
                    .from('call_sessions_egypt')
                    .select('*')
                    .eq('agent_id', currentAgentId)
                    .gte('start_time_egypt', `${today}T00:00:00`)
                    .lt('start_time_egypt', `${today}T23:59:59`);

                if (error) throw error;

                const completedCalls = todayCalls.filter(call => call.completed);
                const goodQualityCalls = todayCalls.filter(call => call.call_quality === 'good').length;
                
                // Calculate average handle time
                const totalSeconds = completedCalls.reduce((sum, call) => {
                    if (!call.duration_interval) return sum;
                    const [h, m, s] = call.duration_interval.split(':').map(Number);
                    return sum + (h * 3600) + (m * 60) + s;
                }, 0);
                
                const avgHandleTime = completedCalls.length > 0 ? Math.floor(totalSeconds / completedCalls.length / 60) : 0;
                const completionRate = todayCalls.length > 0 ? Math.round((completedCalls.length / todayCalls.length) * 100) : 0;
                const qualityScore = todayCalls.length > 0 ? Math.round((goodQualityCalls / todayCalls.length) * 100) : 0;

                // Update UI
                document.getElementById('todayCallsCount').textContent = todayCalls.length;
                document.getElementById('completionRate').textContent = `${completionRate}%`;
                document.getElementById('avgHandleTime').textContent = `${avgHandleTime}m`;
                document.getElementById('qualityScore').textContent = `${qualityScore}%`;

            } catch (error) {
                console.error('Error loading agent stats:', error);
            }
        }

        // Load available scenarios
        async function loadScenarios() {
            try {
                const { data: scenarios, error } = await supabase
                    .from('scenarios')
                    .select('*')
                    .eq('is_active', true)
                    .order('title');

                if (error) throw error;

                const container = document.getElementById('scenariosContainer');
                
                if (!scenarios || scenarios.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: var(--text-color-light);">
                            <p>No scenarios available at the moment.</p>
                            <p>Please check back later or contact your administrator.</p>
                        </div>
                    `;
                    return;
                }

                // Get agent's performance for each scenario
                const scenarioStats = await Promise.all(
                    scenarios.map(async (scenario) => {
                        const { data: calls, error } = await supabase
                            .from('call_sessions_egypt')
                            .select('call_quality, completed')
                            .eq('agent_id', currentAgentId)
                            .eq('scenario_id', scenario.id);

                        if (error) return { scenario, stats: null };

                        const completed = calls.filter(c => c.completed).length;
                        const goodQuality = calls.filter(c => c.call_quality === 'good').length;
                        const successRate = calls.length > 0 ? Math.round((completed / calls.length) * 100) : 0;

                        return { scenario, stats: { total: calls.length, completed, goodQuality, successRate } };
                    })
                );

                container.innerHTML = scenarioStats.map(({ scenario, stats }) => `
                    <div class="scenario-card">
                        <h4>${scenario.title}</h4>
                        <div class="scenario-description">
                            ${scenario.description || 'No description available.'}
                        </div>
                        
                        ${stats ? `
                            <div class="scenario-stats">
                                <div class="stat-badge">${stats.total} calls</div>
                                <div class="stat-badge">${stats.successRate}% success</div>
                                <div class="stat-badge">${stats.goodQuality} good</div>
                            </div>
                        ` : ''}
                        
                        <button class="start-scenario-btn" onclick="startScenario('${scenario.id}')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                            Start Scenario
                        </button>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading scenarios:', error);
                document.getElementById('scenariosContainer').innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--danger-color);">
                        <p>Error loading scenarios. Please try again.</p>
                    </div>
                `;
            }
        }

        // Load performance overview
        async function loadPerformanceOverview() {
            try {
                const { data: allCalls, error } = await supabase
                    .from('call_sessions_egypt')
                    .select('call_quality, completed')
                    .eq('agent_id', currentAgentId);

                if (error) throw error;

                const totalCalls = allCalls.length;
                const goodCalls = allCalls.filter(call => call.call_quality === 'good').length;
                const badCalls = allCalls.filter(call => call.call_quality === 'bad').length;
                const completedCalls = allCalls.filter(call => call.completed).length;
                const successRate = totalCalls > 0 ? Math.round((completedCalls / totalCalls) * 100) : 0;

                document.getElementById('totalCalls').textContent = totalCalls;
                document.getElementById('goodCalls').textContent = goodCalls;
                document.getElementById('badCalls').textContent = badCalls;
                document.getElementById('successRate').textContent = `${successRate}%`;

            } catch (error) {
                console.error('Error loading performance overview:', error);
            }
        }

        // Load recent activity
        async function loadRecentActivity() {
            try {
                const { data: recentCalls, error } = await supabase
                    .from('call_sessions_egypt')
                    .select('scenario_title, call_quality, start_time_egypt, end_time_egypt, duration_interval, completed')
                    .eq('agent_id', currentAgentId)
                    .order('start_time_egypt', { ascending: false })
                    .limit(5);

                if (error) throw error;

                const container = document.getElementById('recentActivityContainer');
                
                if (!recentCalls || recentCalls.length === 0) {
                    container.innerHTML = `
                        <div style="background: var(--card-bg-color); padding: 2rem; border-radius: 1rem; text-align: center; color: var(--text-color-light);">
                            <p>No recent activity found.</p>
                            <p>Start your first call to see activity here.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div style="background: var(--card-bg-color); padding: 1.5rem; border-radius: 1rem;">
                        <div style="display: grid; gap: 1rem;">
                            ${recentCalls.map(call => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--input-bg-color); border-radius: 0.75rem;">
                                    <div>
                                        <div style="font-weight: 500; color: var(--text-color);">${call.scenario_title || 'Unknown Scenario'}</div>
                                        <div style="font-size: 0.85em; color: var(--text-color-light); margin-top: 0.25rem;">
                                            ${new Date(call.start_time_egypt).toLocaleTimeString()} • 
                                            ${formatDuration(call.duration_interval)}
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="
                                            padding: 0.25rem 0.75rem; 
                                            border-radius: 1rem; 
                                            font-size: 0.8em; 
                                            font-weight: 500;
                                            background: ${call.completed ? (call.call_quality === 'good' ? 'var(--success-color)' : 'var(--warning-color)') : 'var(--danger-color)'};
                                            color: white;
                                        ">
                                            ${call.completed ? (call.call_quality === 'good' ? 'Good' : 'Needs Work') : 'Incomplete'}
                                        </span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('Error loading recent activity:', error);
            }
        }

        // Start a scenario
        function startScenario(scenarioId) {
            // Store the selected scenario ID and redirect to core flow
            localStorage.setItem('selectedScenarioId', scenarioId);
            localStorage.setItem('agentId', currentAgentId);
            window.location.href = 'core-flow.html';
        }

        // Format duration helper function
        function formatDuration(duration) {
            if (!duration) return 'N/A';
            if (typeof duration !== 'string' || !duration.includes(':')) return duration;
            const parts = duration.split(':');
            const m = parseInt(parts[1], 10);
            const s = parseInt(parts[2], 10);
            return `${m}m ${s}s`;
        }

        // Export functions to global scope for onclick handlers
        window.startScenario = startScenario;
    </script>
</body>
</html>
