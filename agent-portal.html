<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Portal - Elevo Core</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234e8cff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M12 22V12M9 19l3-3 3 3M12 2a4 4 0 0 0-4 4v0a4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4z'/></svg>">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        /* Hide scrollbar but keep scrolling */
        ::-webkit-scrollbar { display: none; }
        html, body { scrollbar-width: none; -ms-overflow-style: none; }

        /* --- UI/Layout Fixes (Reduced Gap/Spacing) --- */
        .dashboard-main { width: 100%; max-width: none; padding: 1.5rem 2rem; text-align: left; }
        
        /* FIX: Reduced gap for the main layout grid */
        .portal-layout-grid { display: grid; grid-template-columns: minmax(0, 1fr); gap: 1.5rem; margin-top: 1.5rem; }
        
        /* FIX: Reduced gap for columns */
        .main-content-column, .sidebar-column { display: flex; flex-direction: column; gap: 1.5rem; }

        @media (min-width: 1024px) {
            .portal-layout-grid { grid-template-columns: minmax(0, 2.5fr) minmax(0, 1.5fr); }
        }

        .scorecard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }
        .kpi-card { background-color: var(--card-bg-color); padding: 1.25rem; border-radius: var(--border-radius-lg); border-left: 4px solid var(--primary-color); }
        .kpi-card h4 { font-size: 0.9em; color: var(--text-color-light); margin-bottom: 0.5rem; font-weight: 500; }
        .kpi-value { font-size: 1.75em; font-weight: 600; color: var(--text-color); }

        .widget-card { background-color: var(--card-bg-color); padding: 1.5rem; border-radius: var(--border-radius-lg); }
        .chart-container { min-height: 350px; display: flex; flex-direction: column; }
        .chart-container canvas { flex-grow: 1; width: 100% !important; height: 100% !important; }
        
        /* Agent-specific styles for notes/training omitted for brevity but assumed to exist */
    </style>
</head>
<body>
    <div class="app-container" id="appContainerContent" style="display: none;">
        <header class="app-header">
            </header>

        <main class="app-main dashboard-main">
            <div id="authLoadingMessage">
                </div>
            
            <div id="portalContent" style="display:none; flex-direction: column; gap: 2rem;">

                <div class="dashboard-header">
                    <h1 id="agentGreeting">Welcome, Agent!</h1>
                    <p id="agentInfo">Review your performance, call history, and training programs.</p>
                </div>

                <div class="portal-layout-grid">
                    
                    <div class="main-content-column">
                        
                        <section class="performance-section widget-card">
                            <h2>Your Performance (Last 30 Days)</h2>
                            <div class="scorecard" id="performanceScorecard">
                                <div class="kpi-card">
                                    <h4>Tickets Handled</h4>
                                    <p class="kpi-value" id="kpiTotalTickets">0</p>
                                </div>
                                <div class="kpi-card">
                                    <h4>Avg. Duration</h4>
                                    <p class="kpi-value" id="kpiAvgDuration">0m 0s</p>
                                </div>
                                <div class="kpi-card" style="border-left-color: var(--success-color);">
                                    <h4>Avg. Quality Score</h4>
                                    <p class="kpi-value" id="kpiQualityScore">N/A</p>
                                </div>
                                <div class="kpi-card">
                                    <h4>FCR Rate</h4>
                                    <p class="kpi-value" id="kpiFCR">0%</p>
                                </div>
                            </div>
                            
                            <div style="margin-top: 2rem;">
                                <h3>Summary Details</h3>
                                <ul class="performance-summary-list" id="performanceSummaryList">
                                    <li><span>Total Call Time</span><strong id="summaryTotalTime">0m 0s</strong></li>
                                    <li><span>Tickets Completed</span><strong id="summaryCompleted">0</strong></li>
                                    <li><span>Tickets Delayed</span><strong id="summaryDelayed">0</strong></li>
                                </ul>
                            </div>
                        </section>

                        <section class="charts-section" style="display: flex; gap: 1.5rem; flex-wrap: wrap;">
                            
                            <div class="widget-card chart-container" id="qualityChartContainer" style="flex: 1 1 45%; min-width: 300px;">
                                <h3>Quality Scores Distribution (Last 30 Days)</h3>
                                <canvas id="qualityChart"></canvas>
                            </div>

                            <div class="widget-card chart-container" id="volumeChartContainer" style="flex: 1 1 45%; min-width: 300px;">
                                <h3>Ticket Volume Trend (Last 7 Days)</h3>
                                <canvas id="volumeChart"></canvas>
                            </div>
                        </section>

                        <section class="call-history-container card">
                            <h2>Recent Call History</h2>
                            <div class="table-responsive">
                                <table id="callsTable">
                                    <thead>
                                        <tr>
                                            <th>Date/Time</th>
                                            <th>Scenario</th>
                                            <th>Duration</th>
                                            <th>Quality Score</th>
                                        </tr>
                                    </thead>
                                    <tbody id="callsTableBody">
                                        <tr><td colspan="4" style="text-align: center;">No call history found for the last 30 days.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <button id="exportCallsBtn" class="action-button primary-button" style="margin-top: 1rem;">Export to CSV</button>
                        </section>
                    </div>

                    <div class="sidebar-column">
                        
                        <section class="widget-card widget-card-bordered">
                            <h2>Scratchpad</h2>
                            </section>
                        
                        <section class="widget-card training-programs">
                            <h2>Training Programs</h2>
                            </section>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    </body>
<script>
    // --- Configuration and Utility Functions ---
    const SUPABASE_URL = 'https://aefiigottnlcmjzilqnh.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlZmlpZ290dG5sY21qemlscW5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNzY2MDQsImV4cCI6MjA2Mjc1MjYwNH0.FypB02v3tGMnxXV9ZmZMdMC0oQpREKOJWgHMPxUzwX4'; 
    const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const EGYPT_TIMEZONE = 'Africa/Cairo';

    let currentUserId = null;
    let qualityChartInstance = null;
    let volumeChartInstance = null;

    function formatDuration(seconds) {
        if (typeof seconds !== 'number' || isNaN(seconds) || seconds < 0) return 'N/A';
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.floor(seconds % 60);
        return `${minutes}m ${remainingSeconds}s`;
    }
    
    function formatDateTime(timestamp) {
        if (!timestamp) return 'N/A';
        const date = new Date(timestamp);
        return date.toLocaleString('en-US', {
            timeZone: EGYPT_TIMEZONE,
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });
    }

    // Assumed function for theme colors
    function getThemeColors() {
        return { primary: '#4e8cff', success: '#10b981', danger: '#ef4444', warning: '#f59e0b', text: '#e5e7eb', border: '#4b5563' };
    }

    // --- Chart Initialization (Included for full copy-paste) ---
    function initCharts(labels = [], qualityData = [], volumeData = []) {
        const colors = getThemeColors();

        // 1. Quality Distribution Chart (Pie/Doughnut)
        if (qualityChartInstance) qualityChartInstance.destroy();
        const qualityCtx = document.getElementById('qualityChart').getContext('2d');
        
        qualityChartInstance = new Chart(qualityCtx, {
            type: 'doughnut',
            data: {
                labels: ['Good (80-100%)', 'Normal (60-80%)', 'Bad (<60%)'], // Assuming three bands
                datasets: [{
                    data: qualityData, 
                    backgroundColor: [colors.success, colors.warning, colors.danger],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'right', labels: { color: colors.text } } }
            }
        });

        // 2. Ticket Volume Chart (Bar/Line)
        if (volumeChartInstance) volumeChartInstance.destroy();
        const volumeCtx = document.getElementById('volumeChart').getContext('2d');
        
        volumeChartInstance = new Chart(volumeCtx, {
            type: 'bar',
            data: {
                labels: labels, 
                datasets: [{
                    label: 'Tickets',
                    data: volumeData,
                    backgroundColor: colors.primary,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { ticks: { color: colors.text, beginAtZero: true, precision: 0 }, grid: { color: colors.border } },
                    x: { ticks: { color: colors.text }, grid: { display: false } }
                },
                plugins: { legend: { display: false } }
            }
        });
    }


    // --- Authentication and Initialization ---

    async function checkAuth() {
        const { data: { user } } = await supabase.auth.getUser();
        
        if (!user) {
            window.location.replace("login.html");
            return null;
        }
        
        // Fetch Agent Profile
        const { data: profile, error } = await supabase
            .from('profiles')
            .select('user_role, agent_name')
            .eq('user_id', user.id)
            .single();

        if (error || !profile) {
            console.error("Error fetching profile:", error.message);
            // Optionally redirect to login or show error
            return null;
        }

        currentUserId = user.id;
        const agentName = profile.agent_name || user.email.split('@')[0];
        
        document.getElementById('agentGreeting').textContent = `Welcome, ${agentName}!`;
        document.getElementById('authLoadingMessage').style.display = 'none';
        document.getElementById('portalContent').style.display = 'flex';
        
        // Update header user info (assuming header elements exist)
        // document.getElementById('userNameDisplay').textContent = agentName;
        // document.getElementById('userInfo').style.display = 'flex';

        return user;
    }

    async function initializePortal() {
        const user = await checkAuth();
        if (!user) return;
        
        await fetchInitialData();
        // Placeholder for Notes/Training logic initialization
    }
    
    // --- Data Fetching Functions with Correct Views ---

    async function fetchInitialData() {
        if (!currentUserId) return;

        const dateFrom = new Date();
        dateFrom.setDate(dateFrom.getDate() - 30); // Last 30 days
        const isoDateFrom = dateFrom.toISOString();

        // FIX: Using the correct view: v_agent_call_sessions_egypt
        const { data: sessions, error } = await supabase
            .from('v_agent_call_sessions_egypt')
            .select('*') 
            .eq('agent_id', currentUserId)
            .gte('session_start_time', isoDateFrom)
            .order('session_start_time', { ascending: false });

        if (error) {
            console.error('Error fetching agent call sessions:', error.message);
            // Fallback UI update
            document.getElementById('callsTableBody').innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--danger-color);">Error loading data.</td></tr>';
            return;
        }

        // Process data
        updatePerformanceSummary(sessions);
        renderCallHistoryTable(sessions);
    }
    
    function updatePerformanceSummary(sessions) {
        if (!sessions || sessions.length === 0) {
            // Set all KPI cards and summaries to 0/N/A
            document.getElementById('kpiTotalTickets').textContent = '0';
            document.getElementById('kpiAvgDuration').textContent = '0m 0s';
            document.getElementById('kpiQualityScore').textContent = 'N/A';
            document.getElementById('kpiFCR').textContent = '0%';
            document.getElementById('summaryTotalTime').textContent = '0m 0s';
            document.getElementById('summaryCompleted').textContent = '0';
            document.getElementById('summaryDelayed').textContent = '0';
            
            // Charts initialization with empty data
            initCharts(['Week 1', 'Week 2', 'Week 3', 'Week 4'], [0, 0, 0], [0, 0, 0, 0]);
            return;
        }

        let totalDurationSeconds = 0;
        let totalQualityScore = 0;
        let validScoresCount = 0;
        let fcrCount = 0;
        let delayedTicketsCount = 0;
        
        // For Quality Distribution Chart
        let qualityBuckets = { good: 0, normal: 0, bad: 0 }; 
        
        // For Volume Chart
        const volumeTrend = new Array(7).fill(0); // Last 7 days volume
        const labels = [];
        for(let i=6; i>=0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
        }

        sessions.forEach(session => {
            // Summary calculations
            totalDurationSeconds += session.duration_seconds || 0;
            
            if (session.fcr_flag === true) {
                fcrCount++;
            }
            if (session.status === 'delayed') { // Assuming a 'status' field for delayed tickets
                delayedTicketsCount++;
            }
            
            // Quality Score and Distribution
            if (session.quality_score != null) {
                const score = session.quality_score;
                totalQualityScore += score;
                validScoresCount++;

                if (score >= 0.8) { // Good: 80-100%
                    qualityBuckets.good++;
                } else if (score >= 0.6) { // Normal: 60-80%
                    qualityBuckets.normal++;
                } else { // Bad: <60%
                    qualityBuckets.bad++;
                }
            }
            
            // Volume Trend calculation (basic grouping by day of the week)
            const sessionDate = new Date(session.session_start_time);
            const dayDiff = Math.floor((new Date() - sessionDate) / (1000 * 60 * 60 * 24));
            // Only count sessions from the last 7 full days (0-6 days ago)
            if (dayDiff >= 0 && dayDiff < 7) { 
                 const index = 6 - dayDiff; // 0 for 6 days ago, 6 for today
                 volumeTrend[index]++;
            }
        });
        
        const totalTickets = sessions.length;
        const avgDuration = totalTickets > 0 ? totalDurationSeconds / totalTickets : 0;
        const avgQuality = validScoresCount > 0 ? totalQualityScore / validScoresCount : null;
        const fcrRate = totalTickets > 0 ? (fcrCount / totalTickets) * 100 : 0;

        // Update KPI Cards
        document.getElementById('kpiTotalTickets').textContent = totalTickets.toLocaleString();
        document.getElementById('kpiAvgDuration').textContent = formatDuration(avgDuration);
        document.getElementById('kpiQualityScore').textContent = avgQuality != null ? `${(avgQuality * 100).toFixed(1)}%` : 'N/A';
        document.getElementById('kpiFCR').textContent = `${fcrRate.toFixed(1)}%`;
        
        // Update Summary List
        document.getElementById('summaryTotalTime').textContent = formatDuration(totalDurationSeconds);
        document.getElementById('summaryCompleted').textContent = (totalTickets - delayedTicketsCount).toLocaleString();
        document.getElementById('summaryDelayed').textContent = delayedTicketsCount.toLocaleString();

        // Update Charts
        const qualityChartData = [
            qualityBuckets.good, 
            qualityBuckets.normal, 
            qualityBuckets.bad
        ];
        initCharts(labels, qualityChartData, volumeTrend);
    }
    
    function renderCallHistoryTable(sessions) {
        const tableBody = document.getElementById('callsTableBody');
        if (sessions.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No call history found for the last 30 days.</td></tr>';
            return;
        }
        
        tableBody.innerHTML = sessions.map(session => `
            <tr>
                <td>${formatDateTime(session.session_start_time)}</td>
                <td>${session.scenario_title || 'N/A'}</td>
                <td>${formatDuration(session.duration_seconds || 0)}</td>
                <td style="font-weight: 600; color: ${session.quality_score >= 0.8 ? 'var(--success-color)' : session.quality_score >= 0.6 ? 'var(--warning-color)' : 'var(--danger-color)'};">
                    ${session.quality_score != null ? (session.quality_score * 100).toFixed(0) + '%' : '—'}
                </td>
            </tr>
        `).join('');
    }

    // --- Export Function (Kept for completeness) ---
    function exportTableToCSV(filename = 'agent_report.csv') {
      const table = document.querySelector('#callsTable');
      if(!table) return alert('No table found to export');
      
      const header = Array.from(table.querySelectorAll('thead th')).map(th => '"' + th.innerText.replace(/"/g,'""') + '"').join(',');
      const rows = Array.from(table.querySelectorAll('tbody tr')).map(tr => 
        Array.from(tr.querySelectorAll('td')).map(td => '"' + td.innerText.replace(/"/g,'""') + '"').join(',')
      );
      const csvContent = [header, ...rows].join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.style.display='none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    document.addEventListener('DOMContentLoaded', initializePortal);
    document.getElementById('exportCallsBtn').addEventListener('click', exportTableToCSV);

    document.getElementById('logoutButton').addEventListener('click', async () => {
        await supabase.auth.signOut();
        window.location.replace("login.html");
    });
</script>
</html>

