<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coaching Action Plan | Leadership Coaching</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
     <!-- Supabase JS Library -->
     <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- Global Styles (Consistent) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html { scroll-behavior: smooth; }
        body { margin: 0; padding: 0; line-height: 1.7; background-color: #f9f9f9; color: #333; }
        /* User Bar Styles (Consistent) */
        .user-bar { background-color: #34495e; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; color: white; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-info svg { opacity: 0.8; }
        .user-details { display: flex; flex-direction: column; }
        .user-name { font-weight: 600; font-size: 14px; }
        .user-email { font-size: 12px; opacity: 0.8; }
        .logout-button { background-color: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 6px; font-size: 13px; }
        .logout-button:hover { background-color: #c0392b; transform: translateY(-1px); }
        .logout-button:active { transform: translateY(0); }
        /* Navigation Tabs (Consistent) */
        .nav-tab { background-color: #2c3e50; padding: 12px 10px; text-align: center; position: sticky; top: 0; z-index: 100; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; scrollbar-width: thin; scrollbar-color: #556a80 #2c3e50; }
        .nav-tab::-webkit-scrollbar { height: 6px; }
        .nav-tab::-webkit-scrollbar-track { background: #2c3e50; }
        .nav-tab::-webkit-scrollbar-thumb { background-color: #556a80; border-radius: 10px; border: 1px solid #2c3e50; }
        .nav-tab a { color: white; text-decoration: none; margin: 0 8px; padding: 8px 12px; border-radius: 6px; transition: background-color 0.3s, color 0.3s; font-size: 14px; display: inline-block; }
        .nav-tab a:hover, .nav-tab a.active { background-color: #34495e; color: #fff; }
        /* Main Content Styles (Consistent) */
        h1 { color: #fff; background-color: #e67e22; padding: 20px; border-radius: 8px; text-align: center; margin: 25px auto; max-width: 800px; font-size: 26px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { color: white; background-color: #34495e; padding: 12px 15px; border-radius: 6px; text-align: left; margin: 30px 0 20px; font-size: 1.4em; }
        h3 { color: #e67e22; margin: 20px 0 15px; text-align: left; font-size: 1.2em; }
        .container {
            max-width: 800px;
            margin: 0 auto 30px;
            background: white;
            padding: 30px;
            padding-top: 80px; /* <<< Adjusted Padding Top */
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 8px;
            position: relative; /* Needed for absolute positioning of warning */
        }
        .highlight-section { background-color: rgba(230, 126, 34, 0.07); padding: 20px; border-left: 5px solid #e67e22; border-radius: 6px; margin: 25px 0; }
        .image-container { text-align: center; margin: 30px 0; }
        .image-container img { max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .caption { color: #555; margin-top: 10px; font-size: 14px; }
        .question-box { background-color: rgba(52, 152, 219, 0.08); padding: 25px; border-radius: 6px; margin: 25px 0; border: 1px solid rgba(52, 152, 219, 0.2); border-left: 5px solid #3498db; }
        .question-box h4 { margin-top: 0; margin-bottom: 10px; color: #34495e; font-weight: 600; font-size: 1.1em; }
        .question-box h4 .required-star { color: #e74c3c; font-weight: bold; margin-left: 3px; }
        textarea, input[type="text"], input[type="date"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; margin-top: 8px; margin-bottom: 5px; /* Reduced bottom margin */ background-color: white; min-height: 45px; line-height: 1.6; display: block; color: #333; font-size: 15px; transition: border-color 0.3s, box-shadow 0.3s; }
        textarea { min-height: 80px; resize: vertical; }
        textarea:focus, input[type="text"]:focus, input[type="date"]:focus { outline: none; border-color: #e67e22; box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.2); }
        textarea::placeholder, input::placeholder { color: #aaa; opacity: 1; }
        textarea:disabled, input:disabled { background-color: #f0f0f0; cursor: not-allowed; color: #6c757d; border-color: #ddd; box-shadow: none;} /* Slightly darker disabled bg */
        ol { list-style: decimal; margin-left: 25px; margin-bottom: 15px; padding-left: 0; /* Remove default padding */ }
        ul { list-style: disc; margin-left: 25px; margin-bottom: 15px; }
        li { margin-bottom: 15px; /* Increased space between list items */ list-style-position: outside; padding-left: 5px; }
        ol textarea, ul textarea { min-height: 50px; margin-top: 5px; margin-bottom: 5px; /* Adjust margins */ }
        .save-button, .delete-button { color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; transition: all 0.3s ease; font-size: 14px; font-weight: 500; }
        .save-button { background-color: #27ae60; }
        .delete-button { background-color: #e74c3c; margin-left: 8px; }
        .save-button:hover:not(:disabled) { background-color: #2ecc71; transform: translateY(-1px); }
        .delete-button:hover:not(:disabled) { background-color: #c0392b; transform: translateY(-1px); }
        .save-button:active, .delete-button:active { transform: translateY(0); }
        .save-button:disabled, .delete-button:disabled { background-color: #bdc3c7; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.7; }
        .answer-buttons { display: flex; align-items: center; margin-top: 8px; /* Space above buttons */ flex-wrap: wrap; gap: 10px; margin-bottom: 15px; /* Space below buttons before next item */ min-height: 35px; /* Ensure space even when buttons hide */ }
        .table-container .answer-buttons { margin-top: 5px; margin-bottom: 5px; } /* Less margin in tables */
        .save-status { font-size: 13px; color: #27ae60; margin-left: 10px; display: none; font-weight: 500; }
        .save-status.deleted { color: #6c757d; }
        .inline-error-message { color: #e74c3c; font-size: 13px; display: block; /* Make it block */ margin-top: -5px; /* Pull closer to input */ margin-bottom: 10px; font-weight: 500; min-height: 1.2em; /* Reserve space */ display: none; } /* Hide initially */
        /* Tables */
        table { width: 100%; border-collapse: collapse; margin: 25px 0; font-size: 14px; }
        table, th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f2f2f2; font-weight: 600; color: #333; }
        .swot-table th:nth-child(1) { background-color: #27ae60 !important; color: white !important; }
        .swot-table th:nth-child(2) { background-color: #e74c3c !important; color: white !important; }
        .options-table th { color: white !important; text-align: center !important; }
        .options-table th:nth-child(1) { background-color: #3498db !important; }
        .options-table th:nth-child(2) { background-color: #2ecc71 !important; }
        .options-table th:nth-child(3) { background-color: #e74c3c !important; }
        .will-table th { color: white !important; text-align: center !important; }
        .will-table th:nth-child(1) { background-color: #3498db !important; }
        .will-table th:nth-child(2) { background-color: #9b59b6 !important; }
        .will-table th:nth-child(3) { background-color: #e67e22 !important; }
        /* Navigation Buttons */
        .navigation-buttons { display: flex; justify-content: space-between; margin-top: 40px; gap: 20px; border-top: 1px solid #eee; padding-top: 25px; }
        .navigation-buttons a, .navigation-buttons button { text-decoration: none; padding: 12px 20px; color: white; border-radius: 4px; font-weight: 600; flex: 1; text-align: center; transition: all 0.3s ease; font-size: 15px; border: none; cursor: pointer; }
        .navigation-buttons .back { background-color: #6c757d; }
        .navigation-buttons #completeButton { background-color: #e67e22; }
        .navigation-buttons a:hover, .navigation-buttons button:hover:not(:disabled) { transform: translateY(-1px); filter: brightness(110%); }
        .navigation-buttons a:active, .navigation-buttons button:active:not(:disabled) { transform: translateY(0); filter: brightness(100%); }
        .navigation-buttons #completeButton:disabled { background-color: #bdc3c7; cursor: not-allowed; transform: none; box-shadow: none; filter: none; opacity: 0.7; }
        .floating-warning { background-color: #fff8e1; border-left: 4px solid #ffc107; padding: 15px 25px; color: #333; display: none; position: fixed; top: 75px; /* Adjust if user bar height changes */ left: 50%; transform: translateX(-50%); z-index: 1001; border-radius: 6px; box-shadow: 0 3px 10px rgba(0,0,0,0.2); animation: slideDownFadeIn 0.4s ease-out; font-weight: 500; max-width: 90%; width: auto; min-width: 300px; text-align: center; }
        @keyframes slideDownFadeIn { from { opacity: 0; top: 50px; } to { opacity: 1; top: 75px; } }
        @keyframes fadeOutUp { from { opacity: 1; top: 75px;} to { opacity: 0; top: 50px;} }
        .completion-message { background-color: rgba(39, 174, 96, 0.1); padding: 25px; border-left: 5px solid #27ae60; border-radius: 8px; margin: 30px 0; text-align: center; display: none; border: 1px solid rgba(39, 174, 96, 0.2); }
        .completion-message h3 { color: #27ae60; margin-bottom: 15px; font-size: 1.3em;}
        .completion-message p { color: #333; margin-bottom: 10px; }
        .required-field { border: 2px solid #e74c3c !important; background-color: #fff2f1 !important; box-shadow: none !important; }
        .required-star { color: #e74c3c; font-weight: bold; margin-left: 2px; }

         /* --- Progress Bar Styles (Overall Page) --- */
        #overall-progress-container { margin-bottom: 30px; background-color: #ecf0f1; border-radius: 8px; overflow: hidden; height: 20px; width: 100%; }
        #overall-progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #3498db, #2980b9); /* Blue gradient */ border-radius: 8px; transition: width 0.6s ease-in-out; display: flex; align-items: center; justify-content: center; }
        #overall-progress-text { font-size: 11px; font-weight: 600; color: white; text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.3); white-space: nowrap; overflow: hidden; padding: 0 8px; }
        /* Remove individual section progress bars */
        .question-progress-container { display: none !important; }


        @media (max-width: 768px) {
            h1 { font-size: 22px; padding: 15px; margin: 20px 15px; }
            h2 { font-size: 1.2em; padding: 10px 15px; }
            .container { padding: 20px; padding-top: 40px; margin: 0 15px 20px; }
            .user-bar { padding: 10px 15px; font-size: 13px; }
            .user-name { font-size: 13px; }
            .user-email { font-size: 11px; }
            .logout-button { padding: 7px 12px; font-size: 12px; }
            .nav-tab { padding: 10px 5px; }
            .nav-tab a { margin: 0 5px; padding: 7px 10px; font-size: 13px;}
            .highlight-section, .question-box { padding: 15px; margin: 20px 0; }
            textarea { min-height: 80px; }
            ol textarea { min-height: 50px; }
            .save-button, .delete-button { padding: 7px 13px; font-size: 13px; }
            .navigation-buttons { flex-direction: column; }
            .navigation-buttons a, .navigation-buttons button { font-size: 14px; padding: 12px 15px;}
            .floating-warning { padding: 12px 20px; font-size: 14px; top: 65px; width: calc(100% - 30px); max-width: 400px; }
            @keyframes slideDownFadeIn { from { opacity: 0; top: 45px; } to { opacity: 1; top: 65px; } }
            @keyframes fadeOutUp { from { opacity: 1; top: 65px;} to { opacity: 0; top: 45px;} }
            .completion-message { padding: 20px; }
            .completion-message h3 { font-size: 1.2em; }
            /* Responsive Tables */
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { border: 1px solid #ccc; margin-bottom: 10px; border-radius: 4px; background: #fff; } /* Added background for clarity */
            /* Specific table styling removed as no tables require this special handling now */
            td { border: none; border-bottom: 1px solid #eee; position: relative; padding-left: 40% !important; /* Ensure padding for label */ text-align: right !important; min-height: 40px; display: flex; align-items: center; /* Align items vertically */ }
            td:before { position: absolute; top: 50%; transform: translateY(-50%); left: 10px; width: 35%; padding-right: 10px; white-space: normal; /* Allow wrap */ content: attr(data-label); font-weight: bold; text-align: left; font-size: 13px; color: #555;}
             td textarea, td input { margin-top: 0; margin-bottom: 0; } /* Remove extra margin inside cells */
             .answer-buttons { justify-content: flex-end; /* Align buttons right on mobile table cells */ }
              /* Keep action table headers if needed later - remove if no action tables used */
              /* .action-table thead, .action-table tr, .action-table th, .action-table td { display: revert; } */
             /* .action-table th { text-align: center;} */
             /* .action-table td { padding-left: 10px !important; text-align: left !important;} */
             /* .action-table td:before { display: none; } */
        }
    </style>
</head>
<body>
    <!-- User Info Bar -->
    <div class="user-bar"> <div class="user-info"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.8;"> <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path> <circle cx="12" cy="7" r="4"></circle> </svg> <div class="user-details"> <span class="user-name" id="userName">Loading...</span> <span class="user-email" id="userEmail"></span> </div> </div> <button class="logout-button" onclick="logout()"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path> <polyline points="16 17 21 12 16 7"></polyline> <line x1="21" y1="12" x2="9" y2="12"></line> </svg> Logout </button> </div>

    <!-- Navigation Tabs (Reordered) -->
    <nav class="nav-tab">
        <a href="dashboard.html">Dashboard</a>
        <a href="index.html">Home</a>
        <a href="introduction.html">Introduction</a>
        <a href="coaching-skills.html">Coaching Skills</a>
        <a href="coaching-individuals.html">Coaching Individuals</a>
        <a href="coaching-team.html">Team Coaching</a>
        <a href="coaching-yourself.html">Self Coaching</a>
        <a href="action-plan.html" class="active">Action Plan</a>
        <a href="ass.html">Assessment</a>
    </nav>

    <h1>Your Coaching Action Plan</h1>
    <div class="floating-warning" id="generalWarningMessage"></div> <!-- General warning moved outside container -->

    <div class="container">
        <!-- Overall Progress Bar -->
        <div id="overall-progress-container">
            <div id="overall-progress-bar">
                <span id="overall-progress-text">0% Complete</span>
            </div>
        </div>

        <div class="highlight-section"> <p>You've covered a lot of ground in this toolkit â€“ well done! Now it's time to consolidate your learning and create a practical plan to implement these coaching skills.</p> <p>Coaching effectively requires commitment. This plan helps you define your motivations, allocate time, develop specific skills, choose appropriate models, and plan for both formal and informal coaching opportunities.</p> </div>
        <div class="image-container"> <img src="https://images.unsplash.com/photo-1573164713988-8665fc963095?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80" alt="Team creating action plan on whiteboard" onerror="this.onerror=null; this.src='https://via.placeholder.com/800x450/ffa726/ffffff?text=Team+Planning';" loading="lazy"> <p class="caption">Translate your learning into a concrete coaching action plan</p> </div>

        <!-- Section 5.1 -->
        <h2>5.1 Your Coaching Motivation</h2>
        <div class="question-box" data-section="motivation" id="section-container-motivation">
            <h4>Coaching excites me because<span class="required-star">*</span></h4>
            <textarea placeholder="What aspects of helping others grow and develop energize you?" class="editable-answer required-answer" data-question="excitement"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('excitement')">Save</button> <button class="delete-button" onclick="deleteAnswer('excitement')">Delete</button> <span class="save-status" id="save-status-excitement"></span> </div>
            <span class="inline-error-message" id="error-excitement"></span>

            <h4>Through coaching, I could personally gain<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., better delegation skills, stronger relationships, improved team performance..." class="editable-answer required-answer" data-question="personal-gain"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('personal-gain')">Save</button> <button class="delete-button" onclick="deleteAnswer('personal-gain')">Delete</button> <span class="save-status" id="save-status-personal-gain"></span></div>
             <span class="inline-error-message" id="error-personal-gain"></span>

            <h4>It's worthwhile investing time and energy in coaching my team, because<span class="required-star">*</span></h4>
            <textarea placeholder="Connect coaching to specific team or organizational benefits." class="editable-answer required-answer" data-question="team-benefits"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('team-benefits')">Save</button> <button class="delete-button" onclick="deleteAnswer('team-benefits')">Delete</button> <span class="save-status" id="save-status-team-benefits"></span></div>
             <span class="inline-error-message" id="error-team-benefits"></span>
        </div>

        <!-- Section 5.2 -->
        <div class="image-container"> <img src="https://images.unsplash.com/photo-1521791055366-0d553872125f?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80" alt="Manager planning their schedule for coaching time" onerror="this.onerror=null; this.src='https://via.placeholder.com/800x450/3498db/ffffff?text=Time+Management';" loading="lazy"> <p class="caption">Making dedicated time is essential for effective coaching</p> </div>
        <h2>5.2 Making Time for Coaching</h2>
        <div class="question-box" data-section="time" id="section-container-time">
            <h4>To make time for coaching, the habit/process I need to stop or change first is<span class="required-star">*</span></h4>
            <textarea placeholder="Identify one specific time-consuming activity you can adjust." class="editable-answer required-answer" data-question="habits-to-change"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('habits-to-change')">Save</button> <button class="delete-button" onclick="deleteAnswer('habits-to-change')">Delete</button> <span class="save-status" id="save-status-habits-to-change"></span></div>
            <span class="inline-error-message" id="error-habits-to-change"></span>

            <h4>Potential blockers to making this change are<span class="required-star">*</span></h4>
            <textarea placeholder="Anticipate obstacles (e.g., urgent tasks, existing commitments)." class="editable-answer required-answer" data-question="blockers"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('blockers')">Save</button> <button class="delete-button" onclick="deleteAnswer('blockers')">Delete</button> <span class="save-status" id="save-status-blockers"></span></div>
            <span class="inline-error-message" id="error-blockers"></span>

            <h4>My first step to tackling these blockers is<span class="required-star">*</span></h4>
            <textarea placeholder="Define a concrete, actionable first step." class="editable-answer required-answer" data-question="first-step"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('first-step')">Save</button> <button class="delete-button" onclick="deleteAnswer('first-step')">Delete</button> <span class="save-status" id="save-status-first-step"></span></div>
             <span class="inline-error-message" id="error-first-step"></span>

            <h4>To make and sustain these changes, I need the support of<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., My manager, my team, specific colleagues..." class="editable-answer required-answer" data-question="support-needed"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('support-needed')">Save</button> <button class="delete-button" onclick="deleteAnswer('support-needed')">Delete</button> <span class="save-status" id="save-status-support-needed"></span></div>
             <span class="inline-error-message" id="error-support-needed"></span>

            <h4>I will discuss this with them by (date/method)<span class="required-star">*</span></h4>
            <textarea placeholder="Plan how and when you'll have this conversation." class="editable-answer required-answer" data-question="discussion-plan"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('discussion-plan')">Save</button> <button class="delete-button" onclick="deleteAnswer('discussion-plan')">Delete</button> <span class="save-status" id="save-status-discussion-plan"></span></div>
             <span class="inline-error-message" id="error-discussion-plan"></span>

            <h4>A Time Management resource that might help me is<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., Eisenhower Matrix, Time Blocking article, specific app..." class="editable-answer required-answer" data-question="resources"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('resources')">Save</button> <button class="delete-button" onclick="deleteAnswer('resources')">Delete</button> <span class="save-status" id="save-status-resources"></span></div>
             <span class="inline-error-message" id="error-resources"></span>
        </div>

        <!-- Section 5.3 -->
        <h2>5.3 Developing Your Coaching Skills</h2>
        <div class="question-box" data-section="skills" id="section-container-skills">
            <h4>My strongest listening skill currently is<span class="required-star">*</span></h4>
            <textarea placeholder="Identify your best listening trait (e.g., patience, summarizing)." class="editable-answer required-answer" data-question="listening-strength"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('listening-strength')">Save</button> <button class="delete-button" onclick="deleteAnswer('listening-strength')">Delete</button> <span class="save-status" id="save-status-listening-strength"></span></div>
             <span class="inline-error-message" id="error-listening-strength"></span>

            <h4>I'll develop my listening further by applying these two techniques:<span class="required-star">*</span></h4>
            <ol>
                <li><textarea placeholder="First technique (e.g., paraphrase more, notice body language)." class="editable-answer required-answer" data-question="listening-tip1"></textarea>
                    <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('listening-tip1')">Save</button> <button class="delete-button" onclick="deleteAnswer('listening-tip1')">Delete</button> <span class="save-status" id="save-status-listening-tip1"></span></div>
                     <span class="inline-error-message" id="error-listening-tip1"></span>
                </li>
                <li><textarea placeholder="Second technique (e.g., ask clarifying questions, minimize distractions)." class="editable-answer required-answer" data-question="listening-tip2"></textarea>
                     <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('listening-tip2')">Save</button> <button class="delete-button" onclick="deleteAnswer('listening-tip2')">Delete</button> <span class="save-status" id="save-status-listening-tip2"></span></div>
                      <span class="inline-error-message" id="error-listening-tip2"></span>
                </li>
            </ol>

            <h4>When I notice myself making an assumption, I will<span class="required-star">*</span></h4>
            <textarea placeholder="Define your strategy (e.g., ask 'What makes you say that?', state the assumption)." class="editable-answer required-answer" data-question="assumption-plan"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('assumption-plan')">Save</button> <button class="delete-button" onclick="deleteAnswer('assumption-plan')">Delete</button> <span class="save-status" id="save-status-assumption-plan"></span></div>
             <span class="inline-error-message" id="error-assumption-plan"></span>

            <h4>Two new non-leading questions I will practice asking are:<span class="required-star">*</span></h4>
            <ol>
                <li><textarea placeholder="e.g., 'What options have you considered?', 'How does that align with X?'" class="editable-answer required-answer" data-question="question1"></textarea>
                     <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('question1')">Save</button> <button class="delete-button" onclick="deleteAnswer('question1')">Delete</button> <span class="save-status" id="save-status-question1"></span></div>
                      <span class="inline-error-message" id="error-question1"></span>
                </li>
                <li><textarea placeholder="e.g., 'What would success look like?', 'What support do you need?'" class="editable-answer required-answer" data-question="question2"></textarea>
                     <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('question2')">Save</button> <button class="delete-button" onclick="deleteAnswer('question2')">Delete</button> <span class="save-status" id="save-status-question2"></span></div>
                     <span class="inline-error-message" id="error-question2"></span>
                </li>
            </ol>

            <h4>The coachee emotions I find most challenging are... and when they arise, I feel...<span class="required-star">*</span></h4>
            <textarea placeholder="Identify 1-2 challenging emotions (e.g., frustration, apathy) and your reaction." class="editable-answer required-answer" data-question="emotion-challenge"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('emotion-challenge')">Save</button> <button class="delete-button" onclick="deleteAnswer('emotion-challenge')">Delete</button> <span class="save-status" id="save-status-emotion-challenge"></span></div>
             <span class="inline-error-message" id="error-emotion-challenge"></span>

            <h4>My own preoccupations/mood (e.g., feeling stressed, thinking about deadlines) can sometimes hinder open conversation.<span class="required-star">*</span></h4>
            <textarea placeholder="Acknowledge your internal distractions." class="editable-answer required-answer" data-question="own-mood"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('own-mood')">Save</button> <button class="delete-button" onclick="deleteAnswer('own-mood')">Delete</button> <span class="save-status" id="save-status-own-mood"></span></div>
              <span class="inline-error-message" id="error-own-mood"></span>

            <h4>I'll manage these emotional challenges (mine and theirs) better by<span class="required-star">*</span></h4>
            <textarea placeholder="Outline strategies (e.g., deep breaths, acknowledge feelings, refocus)." class="editable-answer required-answer" data-question="improvement-plan"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('improvement-plan')">Save</button> <button class="delete-button" onclick="deleteAnswer('improvement-plan')">Delete</button> <span class="save-status" id="save-status-improvement-plan"></span></div>
              <span class="inline-error-message" id="error-improvement-plan"></span>

            <h4>I can build trust more effectively by<span class="required-star">*</span></h4>
            <textarea placeholder="List 1-2 specific trust-building actions (e.g., maintain confidentiality, follow through)." class="editable-answer required-answer" data-question="trust-building"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('trust-building')">Save</button> <button class="delete-button" onclick="deleteAnswer('trust-building')">Delete</button> <span class="save-status" id="save-status-trust-building"></span></div>
             <span class="inline-error-message" id="error-trust-building"></span>

            <h4>My key professional strengths are... and I can apply these to coaching by<span class="required-star">*</span></h4>
            <textarea placeholder="Connect your existing strengths to coaching behaviors." class="editable-answer required-answer" data-question="strengths-application"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('strengths-application')">Save</button> <button class="delete-button" onclick="deleteAnswer('strengths-application')">Delete</button> <span class="save-status" id="save-status-strengths-application"></span></div>
             <span class="inline-error-message" id="error-strengths-application"></span>
        </div>

        <!-- Section 5.4 -->
        <h2>5.4 Implementing Coaching Models</h2>
        <div class="question-box" data-section="model" id="section-container-model">
            <h4>The first model I plan to use is... with...<span class="required-star">*</span></h4>
            <textarea placeholder="Choose a model (GROW, Skill/Will, Solution-Focused) and a specific person/situation." class="editable-answer required-answer" data-question="model-choice"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('model-choice')">Save</button> <button class="delete-button" onclick="deleteAnswer('model-choice')">Delete</button> <span class="save-status" id="save-status-model-choice"></span></div>
             <span class="inline-error-message" id="error-model-choice"></span>

            <h4>Because...<span class="required-star">*</span></h4>
            <textarea placeholder="Explain why this model fits this coachee or situation." class="editable-answer required-answer" data-question="model-reason"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('model-reason')">Save</button> <button class="delete-button" onclick="deleteAnswer('model-reason')">Delete</button> <span class="save-status" id="save-status-model-reason"></span></div>
             <span class="inline-error-message" id="error-model-reason"></span>

            <h4>I'll need to prepare for this session by<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., Reviewing the model steps, drafting opening questions, clearing my schedule." class="editable-answer required-answer" data-question="preparation"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('preparation')">Save</button> <button class="delete-button" onclick="deleteAnswer('preparation')">Delete</button> <span class="save-status" id="save-status-preparation"></span></div>
             <span class="inline-error-message" id="error-preparation"></span>

            <div class="image-container"> <img src="https://images.unsplash.com/photo-1552664730-d307ca884978?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80" alt="Manager evaluating different coaching approaches" onerror="this.onerror=null; this.src='https://via.placeholder.com/800x450/9b59b6/ffffff?text=Coaching+Models';" loading="lazy"> <p class="caption">Choosing the right coaching model for each situation</p> </div>

            <h4>I can show my coachee I have their best interests in mind by<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., Focusing fully on them, celebrating small wins, linking goals to their aspirations." class="editable-answer required-answer" data-question="best-interests"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('best-interests')">Save</button> <button class="delete-button" onclick="deleteAnswer('best-interests')">Delete</button> <span class="save-status" id="save-status-best-interests"></span></div>
             <span class="inline-error-message" id="error-best-interests"></span>

            <h4>I will demonstrate coaching integrity and humility by<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., Admitting I don't have all answers, respecting their views, maintaining confidentiality." class="editable-answer required-answer" data-question="integrity"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('integrity')">Save</button> <button class="delete-button" onclick="deleteAnswer('integrity')">Delete</button> <span class="save-status" id="save-status-integrity"></span></div>
             <span class="inline-error-message" id="error-integrity"></span>

            <h4>Two tips from successful coaches I'd feel comfortable applying are:<span class="required-star">*</span></h4>
            <ol>
                <li><textarea placeholder="e.g., Start session by asking 'What's on your mind?', Use silence effectively." class="editable-answer required-answer" data-question="tip1"></textarea>
                     <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('tip1')">Save</button> <button class="delete-button" onclick="deleteAnswer('tip1')">Delete</button> <span class="save-status" id="save-status-tip1"></span></div>
                      <span class="inline-error-message" id="error-tip1"></span>
                </li>
                <li><textarea placeholder="e.g., End session by asking 'What was most useful?', Follow up on actions." class="editable-answer required-answer" data-question="tip2"></textarea>
                     <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('tip2')">Save</button> <button class="delete-button" onclick="deleteAnswer('tip2')">Delete</button> <span class="save-status" id="save-status-tip2"></span></div>
                      <span class="inline-error-message" id="error-tip2"></span>
                </li>
            </ol>
        </div>

        <!-- Section 5.5 -->
        <h2>5.5 Informal and Team Coaching</h2>
        <div class="question-box" data-section="team" id="section-container-team">
            <h4>I'll avoid being isolated from the team's daily work by<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., Regular check-ins, being present, participating in informal chats." class="editable-answer required-answer" data-question="shop-floor"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('shop-floor')">Save</button> <button class="delete-button" onclick="deleteAnswer('shop-floor')">Delete</button> <span class="save-status" id="save-status-shop-floor"></span></div>
             <span class="inline-error-message" id="error-shop-floor"></span>

            <div class="image-container"> <img src="https://images.unsplash.com/photo-1521791136064-7986c2920216?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80" alt="Manager having informal discussion with team members" onerror="this.onerror=null; this.src='https://via.placeholder.com/800x450/3498db/ffffff?text=Informal+Coaching';" loading="lazy"> <p class="caption">Staying connected enables effective informal coaching</p> </div>

            <h4>I can improve my judgment about when to intervene informally by<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., Paying closer attention to cues, asking clarifying questions first." class="editable-answer required-answer" data-question="intervention"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('intervention')">Save</button> <button class="delete-button" onclick="deleteAnswer('intervention')">Delete</button> <span class="save-status" id="save-status-intervention"></span></div>
             <span class="inline-error-message" id="error-intervention"></span>

            <h4>I plan to use team coaching with this team/group<span class="required-star">*</span></h4>
            <textarea placeholder="Identify the specific team or group." class="editable-answer required-answer" data-question="team-group"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('team-group')">Save</button> <button class="delete-button" onclick="deleteAnswer('team-group')">Delete</button> <span class="save-status" id="save-status-team-group"></span></div>
              <span class="inline-error-message" id="error-team-group"></span>

            <h4>...to help them work on this topic or issue<span class="required-star">*</span></h4>
            <textarea placeholder="Define the specific focus for team coaching (e.g., conflict resolution, goal alignment)." class="editable-answer required-answer" data-question="team-issue"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('team-issue')">Save</button> <button class="delete-button" onclick="deleteAnswer('team-issue')">Delete</button> <span class="save-status" id="save-status-team-issue"></span></div>
             <span class="inline-error-message" id="error-team-issue"></span>

            <h4>I'll prepare for team coaching by exploring personality/working styles using<span class="required-star">*</span></h4>
            <textarea placeholder="Name a model/tool (e.g., DiSC, Belbin - even informally) or describe your approach." class="editable-answer required-answer" data-question="personality-test"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('personality-test')">Save</button> <button class="delete-button" onclick="deleteAnswer('personality-test')">Delete</button> <span class="save-status" id="save-status-personality-test"></span></div>
             <span class="inline-error-message" id="error-personality-test"></span>

            <h4>...and by facilitating appreciation of diverse strengths/preferences through<span class="required-star">*</span></h4>
            <textarea placeholder="Describe the activity or discussion you will lead." class="editable-answer required-answer" data-question="strengths-appreciation"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('strengths-appreciation')">Save</button> <button class="delete-button" onclick="deleteAnswer('strengths-appreciation')">Delete</button> <span class="save-status" id="save-status-strengths-appreciation"></span></div>
             <span class="inline-error-message" id="error-strengths-appreciation"></span>

            <h4>Together, we'll develop a team charter following these steps<span class="required-star">*</span></h4>
            <textarea placeholder="Outline your collaborative process (e.g., brainstorm session, draft, review)." class="editable-answer required-answer" data-question="charter-steps"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('charter-steps')">Save</button> <button class="delete-button" onclick="deleteAnswer('charter-steps')">Delete</button> <span class="save-status" id="save-status-charter-steps"></span></div>
             <span class="inline-error-message" id="error-charter-steps"></span>

            <h4>I will address potential conflicting priorities by discussing them with<span class="required-star">*</span></h4>
            <textarea placeholder="Identify who needs to be involved (e.g., team, specific individuals, other managers)." class="editable-answer required-answer" data-question="conflict-resolution"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('conflict-resolution')">Save</button> <button class="delete-button" onclick="deleteAnswer('conflict-resolution')">Delete</button> <span class="save-status" id="save-status-conflict-resolution"></span></div>
             <span class="inline-error-message" id="error-conflict-resolution"></span>

            <h4>I plan to try the POSITIVE model at this upcoming meeting/situation<span class="required-star">*</span></h4>
            <textarea placeholder="Identify a specific opportunity to use the POSITIVE model." class="editable-answer required-answer" data-question="positive-model"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('positive-model')">Save</button> <button class="delete-button" onclick="deleteAnswer('positive-model')">Delete</button> <span class="save-status" id="save-status-positive-model"></span></div>
              <span class="inline-error-message" id="error-positive-model"></span>

            <h4>...and the PRACTICE model in this session/situation<span class="required-star">*</span></h4>
            <textarea placeholder="Identify a specific opportunity to use the PRACTICE model." class="editable-answer required-answer" data-question="practice-model"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('practice-model')">Save</button> <button class="delete-button" onclick="deleteAnswer('practice-model')">Delete</button> <span class="save-status" id="save-status-practice-model"></span></div>
             <span class="inline-error-message" id="error-practice-model"></span>
        </div>

        <!-- Section 5.6 -->
        <h2>5.6 Self-Reflection and Review</h2>
        <div class="question-box" data-section="reflection" id="section-container-reflection">
            <h4>My personal SWOT analysis highlighted<span class="required-star">*</span></h4>
            <textarea placeholder="Summarize your key strengths and weaknesses identified earlier." class="editable-answer required-answer" data-question="swot-highlights"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('swot-highlights')">Save</button> <button class="delete-button" onclick="deleteAnswer('swot-highlights')">Delete</button> <span class="save-status" id="save-status-swot-highlights"></span></div>
              <span class="inline-error-message" id="error-swot-highlights"></span>

            <h4>As a result, a key action I will take is<span class="required-star">*</span></h4>
            <textarea placeholder="Define one specific action based on your SWOT (leverage strength or address weakness)." class="editable-answer required-answer" data-question="swot-actions"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('swot-actions')">Save</button> <button class="delete-button" onclick="deleteAnswer('swot-actions')">Delete</button> <span class="save-status" id="save-status-swot-actions"></span></div>
            <span class="inline-error-message" id="error-swot-actions"></span>

            <h4>The personal goal I'm working on using the GROW model is<span class="required-star">*</span></h4>
            <textarea placeholder="Restate your SMART goal from the GROW exercise." class="editable-answer required-answer" data-question="grow-goal"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('grow-goal')">Save</button> <button class="delete-button" onclick="deleteAnswer('grow-goal')">Delete</button> <span class="save-status" id="save-status-grow-goal"></span></div>
              <span class="inline-error-message" id="error-grow-goal"></span>

            <h4>My first action step towards this goal is<span class="required-star">*</span></h4>
            <textarea placeholder="Restate your first action step from the GROW 'Will' section." class="editable-answer required-answer" data-question="first-grow-action"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('first-grow-action')">Save</button> <button class="delete-button" onclick="deleteAnswer('first-grow-action')">Delete</button> <span class="save-status" id="save-status-first-grow-action"></span></div>
             <span class="inline-error-message" id="error-first-grow-action"></span>

            <h4>I've scheduled my first self-review for this toolkit on<span class="required-star">*</span></h4>
            <input type="date" class="editable-answer required-answer" data-question="review-date">
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('review-date')">Save</button> <button class="delete-button" onclick="deleteAnswer('review-date')">Delete</button> <span class="save-status" id="save-status-review-date"></span></div>
             <span class="inline-error-message" id="error-review-date"></span>

            <h4>Since starting this toolkit, changes I've observed in myself/my work include<span class="required-star">*</span></h4>
            <textarea placeholder="Reflect on any shifts in your perspective or behavior so far." class="editable-answer required-answer" data-question="self-changes"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('self-changes')">Save</button> <button class="delete-button" onclick="deleteAnswer('self-changes')">Delete</button> <span class="save-status" id="save-status-self-changes"></span></div>
             <span class="inline-error-message" id="error-self-changes"></span>

            <h4>Changes I've observed in my team's behavior/performance include<span class="required-star">*</span></h4>
            <textarea placeholder="Reflect on any impacts on your team, even small ones." class="editable-answer required-answer" data-question="team-changes"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('team-changes')">Save</button> <button class="delete-button" onclick="deleteAnswer('team-changes')">Delete</button> <span class="save-status" id="save-status-team-changes"></span></div>
             <span class="inline-error-message" id="error-team-changes"></span>

            <div class="image-container"> <img src="https://images.unsplash.com/photo-1542744173-8e7e53415bb0?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80" alt="Team reviewing progress and celebrating success" onerror="this.onerror=null; this.src='https://via.placeholder.com/800x450/2ecc71/ffffff?text=Team+Review';" loading="lazy"> <p class="caption">Regular review helps sustain coaching benefits</p> </div>
        </div>

        <!-- Completion Message -->
        <div class="completion-message" id="completionMessage"> <h3>Congratulations on Completing Your Coaching Action Plan!</h3> <p>Thank you for taking the time to thoughtfully complete this action plan. You've taken important steps toward becoming a more effective coach for your team and yourself.</p> <p>Remember to review your plan regularly (starting on the date you set above!) and adjust as needed. Consistent application of these strategies will help you see the best results.</p> <p>Good luck with your coaching journey!</p> </div>

         <!-- General Warning Placeholder - Content added by JS -->
         <div class="warning-message" id="generalInlineWarningMessage" style="color: #e74c3c; font-weight: 500; margin-top: 15px; text-align: center; display: none;"></div>

        <!-- Navigation Buttons -->
        <div class="navigation-buttons"> <a href="coaching-yourself.html" class="button back" id="backButton">â† Back to Self Coaching</a> <button type="button" class="button" id="completeButton">Mark Action Plan as Complete</button> </div>
    </div><!-- /.container -->

    <script>
        // --- Supabase Configuration ---
        const SUPABASE_URL = 'https://lgcutmuspcaralydycmg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnY3V0bXVzcGNhcmFseWR5Y21nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0NDY3MDEsImV4cCI6MjA2MTAyMjcwMX0.3u5Y7pkH2NNnnoGLMWVfAa5b8fq88o1itRYnG1K38tE';
        let supabase = null;

        // --- Configuration ---
        const localStorageKey = 'allUserAnswers_actionPlan';
        const SECTION_ID = 'action'; // Unique ID for overall Action Plan progress
        const PAGE_NAME = 'action-plan.html';

        // --- Unified Keys ---
        const LOGGED_IN_KEY = 'isUserLoggedIn';
        const CURRENT_USER_KEY = 'currentUser';

        // Array of all REQUIRED question IDs on this page
        const requiredQuestionIds = [
            'excitement', 'personal-gain', 'team-benefits',
            'habits-to-change', 'blockers', 'first-step', 'support-needed', 'discussion-plan', 'resources',
            'listening-strength', 'listening-tip1', 'listening-tip2', 'assumption-plan', 'question1', 'question2', 'emotion-challenge', 'own-mood', 'improvement-plan', 'trust-building', 'strengths-application',
            'model-choice', 'model-reason', 'preparation', 'best-interests', 'integrity', 'tip1', 'tip2',
            'shop-floor', 'intervention', 'team-group', 'team-issue', 'personality-test', 'strengths-appreciation', 'charter-steps', 'conflict-resolution', 'positive-model', 'practice-model',
            'swot-highlights', 'swot-actions', 'grow-goal', 'first-grow-action', 'review-date', 'self-changes', 'team-changes'
            // Removed table question IDs as they are not present in this HTML structure
            // 'strength1', 'weakness1', // SWOT table required - REMOVED
            // 'option1', // Options table required - REMOVED
            // 'action1', 'date1', 'measure1' // Will table required - REMOVED
        ];

        // Initialize Supabase Client
        try {
            if (window.supabase && window.supabase.createClient) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log(`Supabase client initialized successfully on ${PAGE_NAME}.`);
            } else { throw new Error("Supabase library not found."); }
        } catch (error) { console.error("CRITICAL ERROR initializing Supabase:", error); }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
             console.log(`%c${PAGE_NAME}: DOMContentLoaded event fired.`, "color: green;");
             if (!supabase) {
                 console.error(`Supabase client failed to initialize on ${PAGE_NAME}. Some features might not work.`);
                 // Maybe display a user-facing error here
                 showGeneralWarningMessage('Database connection failed. Progress might not save correctly.', true); // Make sticky
             }

             const currentUser = getCurrentUser();
             if (!currentUser || !currentUser.id || !currentUser.email) {
                 console.error(`%c${PAGE_NAME}: User not logged in or essential data missing. Redirecting...`, "color: red;");
                  if (!window.location.search.includes('redir_attempt')) { window.location.href = `login.html?redirect=${encodeURIComponent(window.location.pathname + window.location.search)}&redir_attempt=1`; }
                  else { console.error("REDIRECTION LOOP DETECTED."); document.body.innerHTML = '<p style="color: red; padding: 20px;">Login check failed repeatedly.</p>'; }
                 return;
             }
             console.log(`%c${PAGE_NAME}: User validated (${currentUser.email}, ID: ${currentUser.id}). Initializing.`, "color: green;");
             displayUserInfo();
             loadUserAnswers(currentUser);
             setupEventListeners(currentUser);
             highlightActiveNav();
             checkCompletionState(currentUser.email); // Pass email
             setupMobileTableLabels(); // Keep for potential future tables
             console.log(`%c${PAGE_NAME}: Initialization complete.`, "color: blue;");
        });

        // --- User Info & Auth ---
        function getCurrentUser() { try { const d = localStorage.getItem(CURRENT_USER_KEY); if (!d) return null; const p = JSON.parse(d); if (p && typeof p === 'object' && p.email && p.name && p.id) { if (typeof p.progress !== 'object' || p.progress === null) p.progress = {}; return p; } else { localStorage.removeItem(CURRENT_USER_KEY); localStorage.removeItem(LOGGED_IN_KEY); return null; } } catch (e) { console.error("GUC Error:", e); localStorage.removeItem(CURRENT_USER_KEY); localStorage.removeItem(LOGGED_IN_KEY); return null; } }
        function saveCurrentUser(userObject) { try { if (!userObject || typeof userObject !== 'object') throw new Error("Invalid user object"); localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(userObject)); console.log("Saved user data."); } catch (error) { console.error("SCU Error:", error); } }
        function displayUserInfo() { const u=getCurrentUser(); if(u){document.getElementById('userName').textContent=`Welcome, ${u.name || u.email.split('@')[0]}`; document.getElementById('userEmail').textContent=u.email;}else{console.warn("DIU: No user");}}
        function logout() { const u=getCurrentUser(); const e=u?u.email:null; localStorage.removeItem(LOGGED_IN_KEY); localStorage.removeItem(CURRENT_USER_KEY); if(e){const k=`${localStorageKey}_completed_${e}`; localStorage.removeItem(k); console.log(`Removed completion key: ${k}`);} window.location.href = 'login.html';}
        function highlightActiveNav() { const cP=window.location.pathname.split('/').pop()||PAGE_NAME; document.querySelectorAll('.nav-tab a').forEach(l=>{const lP=(l.getAttribute('href')||'').split('/').pop(); l.classList.toggle('active',lP===cP);}); }
        function setupMobileTableLabels() { document.querySelectorAll('table tbody tr').forEach(r=>{try{const h=Array.from(r.closest('table').querySelectorAll('thead th')).map(th=>th.textContent.replace('*','').trim()); r.querySelectorAll('td').forEach((t,i)=>{if(h[i])t.setAttribute('data-label',h[i]);});}catch(e){console.warn("Error setting mobile labels:",e)}});}


        // --- Answer Handling (Local Storage & UI Locking) ---
        function loadUserAnswers(currentUser) {
            if (!currentUser || !currentUser.email) return;
            let allAnswers = {};
            try { const d = localStorage.getItem(localStorageKey); if (d) allAnswers = JSON.parse(d) || {}; }
            catch(e) { console.error("Load Answers Error:", e); }
            const userPageAnswers = allAnswers[currentUser.email] || {};

            document.querySelectorAll('.editable-answer[data-question]').forEach(field => {
                loadFieldState(field, field.dataset.question, userPageAnswers);
            });

             updateOverallProgress();
        }

        function loadFieldState(field, questionId, userAnswers) {
            if (!field) return;
            const errorId = `error-${questionId}`;
            const statusId = `save-status-${questionId}`;
            // Robust button finding
            const buttonContainer = field.closest('li, .question-box');
            const buttonGroup = buttonContainer ? buttonContainer.querySelector('.answer-buttons') : null;
            const saveButton = buttonGroup?.querySelector('.save-button');
            const deleteButton = buttonGroup?.querySelector('.delete-button');

            hideMessages(statusId, errorId, field); // Clear status and error

            if (userAnswers[questionId] !== undefined && userAnswers[questionId] !== null && String(userAnswers[questionId]).trim() !== '') {
                field.value = userAnswers[questionId];
                field.disabled = true;
                field.classList.remove('required-field');
                if (saveButton) {
                    saveButton.disabled = true;
                    saveButton.textContent = 'Saved âœ”ï¸';
                }
                if (deleteButton) {
                    deleteButton.disabled = true;
                    deleteButton.style.display = 'none';
                }
            } else {
                 field.value = (field.type === 'date') ? '' : '';
                 field.disabled = false;
                 field.classList.remove('required-field'); // Ensure not marked as error
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.textContent = 'Save';
                }
                if (deleteButton) {
                    deleteButton.disabled = false;
                    deleteButton.style.display = 'inline-block';
                }
            }
        }


        function saveAnswerToStorage(userEmail, questionId, answer) { if (!userEmail) return false; let a={}; try{const d=localStorage.getItem(localStorageKey); if(d)a=JSON.parse(d)||{};}catch(e){a={};} if(!a[userEmail])a[userEmail]={}; a[userEmail][questionId]=answer; try{localStorage.setItem(localStorageKey,JSON.stringify(a)); return true;}catch(e){console.error("AP Save Err:",e);return false;} }
        function deleteAnswerFromStorage(userEmail, questionId) { if (!userEmail) return false; let a={}; try{const d=localStorage.getItem(localStorageKey); if(d)a=JSON.parse(d)||{}; else return false;}catch(e){return false;} let u=false; if(a[userEmail]?.[questionId]!==undefined){delete a[userEmail][questionId]; u=true; if(Object.keys(a[userEmail]).length===0)delete a[userEmail];} if(u){try{localStorage.setItem(localStorageKey,JSON.stringify(a)); return true;}catch(e){return false;}} return false;}

        // --- Progress Calculation & Display ---
        function updateOverallProgress(forcePercentage = null) {
            const currentUser = getCurrentUser(); if (!currentUser || !currentUser.email) return 0;
            let allAnswers = {}; try { const d = localStorage.getItem(localStorageKey); if (d) allAnswers = JSON.parse(d) || {}; } catch (e) {}
            const userAnswers = allAnswers[currentUser.email] || {};

            let progressPercentage = 0;

             if (forcePercentage !== null && !isNaN(forcePercentage)) {
                 progressPercentage = Math.max(0, Math.min(100, Math.round(forcePercentage)));
                 console.log(`Forcing OVERALL progress to ${progressPercentage}%`);
             } else {
                  const totalRequired = requiredQuestionIds.length;
                  if(totalRequired === 0) return 0;
                  let answeredRequiredCount = 0;
                  requiredQuestionIds.forEach(qId => {
                       if(userAnswers[qId] !== undefined && userAnswers[qId] !== null && String(userAnswers[qId]).trim() !== '') {
                           answeredRequiredCount++;
                       }
                  });
                  progressPercentage = Math.round((answeredRequiredCount / totalRequired) * 100);
             }


            if (!currentUser.progress) currentUser.progress = {};
            currentUser.progress[SECTION_ID] = progressPercentage;
            saveCurrentUser(currentUser);
            console.log(`Section '${SECTION_ID}' overall progress updated to ${progressPercentage}%`);

             const progressBar = document.getElementById('overall-progress-bar');
             const progressText = document.getElementById('overall-progress-text');
             if (progressBar && progressText) {
                  progressBar.style.width = `${progressPercentage}%`;
                  progressText.textContent = `${progressPercentage}% Complete`;
             } else {
                 console.warn("Overall progress bar elements not found.");
             }

            return progressPercentage;
        }

        // --- Event Listeners Setup ---
        function setupEventListeners(currentUser) {
            if (!currentUser?.email) return;
            document.querySelectorAll('.editable-answer').forEach(f=>{
                const eT=(f.tagName==='TEXTAREA' || f.type==='text')?'input':'change'; // Use input for text/textarea, change for others
                f.addEventListener(eT, function(){
                    const qId=this.dataset.question;
                    if(qId){
                        const eId=`error-${qId}`;
                        this.classList.remove('required-field');
                        hideError(eId);
                        // Optionally re-enable save button if user starts typing again (and it's not disabled due to being saved)
                        if (!this.disabled) {
                            const buttonContainer = this.closest('li, .question-box');
                            const saveButton = buttonContainer?.querySelector('.save-button');
                            if (saveButton && !saveButton.textContent.includes('âœ”ï¸')) { // Only enable if not already 'Saved'
                                saveButton.disabled = false;
                            }
                        }
                    }
                });
            });
            const cB=document.getElementById('completeButton');
            if(cB) {
                 cB.addEventListener('click',()=>handleCompleteButtonClick(currentUser.email));
            } else {
                 console.warn("Complete button not found.");
            }
         }

        function handleCompleteButtonClick(userEmail) {
             if (!userEmail) { alert("Session error. Please log in again."); logout(); return; }
             if (!validateAllAnswers(true)) { // Pass true to show errors
                 showGeneralWarningMessage('Please complete all required fields marked with *');
                 console.log("Validation failed.");
             } else {
                 console.log("Validation passed.");
                 markPlanAsComplete(userEmail);
             }
         }

        // --- UI Feedback & Validation ---
        function validateAllAnswers(showErrors = false) {
            let allValid=true;
            let firstInvalidField=null;
            console.log("AP: Validating all answers...");
            const generalWarningDiv = document.getElementById('generalInlineWarningMessage'); // Inline warning
            if (generalWarningDiv) generalWarningDiv.style.display = 'none'; // Hide previous general inline warning

            requiredQuestionIds.forEach(qId => {
                const field = document.querySelector(`[data-question="${qId}"]`);
                if (field) {
                    const eId=`error-${qId}`;
                    hideError(eId); // Clear previous error
                    field.classList.remove('required-field');

                     // Only validate if the field is *not* disabled (i.e., not already saved)
                     if (!field.disabled && String(field.value).trim() === '') {
                         allValid = false;
                         if (!firstInvalidField) firstInvalidField = field;
                         if (showErrors) {
                             field.classList.add('required-field');
                             showError(eId, null, 'Required.'); // Show only field error message
                         }
                     }
                } else {
                     console.warn(`Required field with data-question="${qId}" not found!`);
                     allValid = false; // Cannot be valid if required field is missing
                }
            });

            if(!allValid && showErrors && firstInvalidField){
                 firstInvalidField.scrollIntoView({behavior:'smooth',block:'center'});
                 // Add slight delay for focus after scroll finishes
                 setTimeout(()=>{ try{ firstInvalidField.focus({preventScroll:true}); } catch(e){console.warn("Focus failed:",e)} }, 400);
            } else if (!allValid && showErrors) {
                 // Show general warning if focusing on specific field failed or wasn't possible
                 showGeneralWarningMessage('Please complete all required fields marked with *');
                 if (generalWarningDiv) { // Show inline warning as well
                     generalWarningDiv.textContent = 'Please scroll up and complete all required fields marked with *.';
                     generalWarningDiv.style.display = 'block';
                 }
            }
            console.log("AP Validation result:", allValid);
            return allValid;
        }

        function showGeneralWarningMessage(message = 'Action Required: Please complete all required fields marked with *', sticky = false) {
            const w=document.getElementById('generalWarningMessage'); if(!w) return;
            w.innerHTML = `<strong>${message.includes(':') ? message.split(':')[0] : 'Warning'}:</strong> ${message.includes(':') ? message.split(':')[1].trim() : message}`;
            w.style.animation='none'; void w.offsetWidth; // Reflow trick
            w.style.display='block';
            w.style.animation='slideDownFadeIn 0.4s ease-out';
            clearTimeout(w.timer);
            if (!sticky) {
                 w.timer=setTimeout(()=>{
                     w.style.animation='fadeOutUp 0.5s ease-out forwards';
                     setTimeout(()=>{ if(w.style.animationName === 'fadeOutUp'){w.style.display='none';w.style.animation='';} }, 500); // Wait for fade out animation
                 }, 4000); // Hide after 4 seconds if not sticky
            }
        }
        function hideGeneralWarningMessage() {
             const w=document.getElementById('generalWarningMessage'); if(w && w.style.display !== 'none'){
                 w.style.animation='fadeOutUp 0.5s ease-out forwards';
                 setTimeout(()=>{ if(w.style.animationName === 'fadeOutUp'){w.style.display='none';w.style.animation='';} }, 500);
             }
        }

        function showSaveStatus(statusId, message = 'âœ“ Saved') { const s=document.getElementById(statusId); if(!s) return; s.textContent=message; s.classList.remove('deleted'); s.style.color='#27ae60'; if(message.includes('Cleared')||message.includes('Deleted')){s.classList.add('deleted'); s.style.color='#6c757d';} s.style.display='inline-block'; clearTimeout(s.timer); s.timer=setTimeout(()=>s.style.display='none',3000); }
        function showError(errorId, fieldToMark, message = 'Required.') { const e=document.getElementById(errorId); if(!e) return; e.textContent=message; e.style.color='#e74c3c'; e.style.display='block'; if(fieldToMark) fieldToMark.classList.add('required-field');}
        function hideError(errorId) { const e=document.getElementById(errorId); if(e){e.style.display='none'; e.textContent='';}}
        function hideMessages(statusId, errorId, field) { // Simplified helper
             hideError(errorId);
             const s = statusId ? document.getElementById(statusId) : null; if(s)s.style.display='none';
             if (field) field.classList.remove('required-field');
         }

        // --- Actions (Save/Delete Single Fields/Cells) ---
        window.saveAnswer = async function(questionId) {
            if (!supabase) { alert('Database connection error. Cannot save.'); return; }
            const currentUser = getCurrentUser(); if (!currentUser?.email || !currentUser.id) { alert('Session expired. Please log in again.'); logout(); return; }

            const field = document.querySelector(`[data-question="${questionId}"]`); if (!field) { console.error("Save Error: Field missing for", questionId); return; }

            const errorId = `error-${questionId}`;
            const statusId = `save-status-${questionId}`;
            // Find buttons relative to the field's parent (works for direct children and list items)
            const buttonContainer = field.closest('li, .question-box'); // Find the closest container (li or the main box)
            let buttonGroup = buttonContainer ? buttonContainer.querySelector('.answer-buttons') : null;
             // Fallback for cases where buttons are direct sibling (unlikely with current structure but safe)
             if (!buttonGroup) buttonGroup = field.parentElement?.querySelector('.answer-buttons');

            let saveButton = buttonGroup?.querySelector('.save-button');
            let deleteButton = buttonGroup?.querySelector('.delete-button');

            if (!saveButton || !deleteButton) {
                 console.error(`Save Error: Buttons missing for question ${questionId}. Button Group found: ${!!buttonGroup}`);
                 // Fallback search within immediate parent (more direct)
                 const directParentButtons = field.parentElement?.querySelector('.answer-buttons');
                 if (!saveButton && directParentButtons) saveButton = directParentButtons.querySelector('.save-button');
                 if (!deleteButton && directParentButtons) deleteButton = directParentButtons.querySelector('.delete-button');

                 if (!saveButton || !deleteButton) {
                     console.error(`CRITICAL: Still cannot find Save/Delete buttons for ${questionId} after fallback search.`);
                     // Show error and stop
                     showError(errorId, field, 'Internal Error: UI component missing.');
                     return;
                 }
            }

            if (field.disabled) { console.warn("Attempted to save already saved question:", questionId); return; } // Prevent re-saving disabled fields

            const answer = field.value;
            const trimmedAnswer = String(answer).trim(); // Ensure string conversion
            const isRequired = field.classList.contains('required-answer');

            hideMessages(statusId, errorId, field); // Clear previous feedback

            if (isRequired && trimmedAnswer === '') {
                showError(errorId, field); // Show specific error message
                updateOverallProgress(); // Reflect potential change in completion status
                return; // Stop saving if required and empty
            }

            // Disable buttons immediately to prevent double clicks
            saveButton.disabled = true; saveButton.textContent = 'Saving...';
            deleteButton.disabled = true; // Disable delete while saving

            try {
                let questionText = `Answer for ${questionId}`; // Default
                const qTextElement = field.closest('li')?.previousElementSibling || field.closest('.question-box')?.querySelector('h4') || field.previousElementSibling;

                if (qTextElement && (qTextElement.tagName === 'H4' || qTextElement.tagName === 'P' || qTextElement.tagName === 'LABEL')) {
                    questionText = qTextElement.textContent.replace(/\*/g,'').replace(/\s+/g, ' ').trim(); // Clean up text
                } else {
                    // Fallback if H4/Label isn't found easily
                    const parentBox = field.closest('.question-box');
                    const boxH4 = parentBox?.querySelector('h4');
                    if(boxH4) {
                       questionText = boxH4.textContent.replace(/\*/g,'').replace(/\s+/g, ' ').trim() + ` (${questionId})`; // Add ID for context if needed
                    }
                }

                const submissionTime = new Date().toISOString();
                const userProgressPayload = {
                    user_id: currentUser.id, email: currentUser.email, question_id: questionId,
                    question_text: questionText.substring(0, 250), // Limit length if needed
                    answer: answer, page: PAGE_NAME, status: 'completed',
                    submitted_at: submissionTime, updated_at: submissionTime, section_type: 'action_plan',
                    section_id: SECTION_ID, section_title: document.title || 'Coaching Action Plan',
                    progress_percentage: 100, // Individual answer always 100%
                    score: null, is_passed: null
                };

                console.log(`[${questionId}] Attempting to upsert to user_progress...`);
                const { data, error } = await supabase.from('user_progress').upsert([userProgressPayload], { onConflict: ['user_id', 'question_id'] }).select();

                if (error) {
                    console.error(`[${questionId}] Supabase upsert error BEFORE throwing:`, error);
                    throw new Error(`Supabase error: ${error.message} (Code: ${error.code})`);
                }
                console.log(`[${questionId}] Supabase upsert successful.`);

                // --- Update UI on SUCCESS (Refined & Ensured) ---
                console.log(`[${questionId}] Starting UI updates...`);
                try {
                    field.disabled = true; // Disable the input field
                    field.classList.remove('required-field'); // Remove error styling if present
                    console.log(`[${questionId}] Field disabled.`);

                    // Ensure buttons are correctly updated
                    if (saveButton) {
                        saveButton.disabled = true; // Keep it disabled
                        saveButton.textContent = 'Saved âœ”ï¸';
                        console.log(`[${questionId}] Save button updated and disabled.`);
                    } else {
                        console.warn(`[${questionId}] Save button NOT FOUND for UI update post-save.`);
                    }

                    if (deleteButton) {
                        deleteButton.disabled = true; // Keep it disabled
                        deleteButton.style.display = 'none'; // Hide the delete button
                        console.log(`[${questionId}] Delete button hidden and disabled.`);
                    } else {
                        console.warn(`[${questionId}] Delete button NOT FOUND for UI update post-save.`);
                    }

                    console.log(`[${questionId}] Saving to local storage...`);
                    saveAnswerToStorage(currentUser.email, questionId, answer); // Update local storage

                    console.log(`[${questionId}] Updating overall progress bar...`);
                    updateOverallProgress(); // Update the overall progress bar
                    console.log(`[${questionId}] UI updates complete.`);
                    showSaveStatus(statusId, 'âœ“ Saved'); // Show save status message

                } catch (uiError) {
                     console.error(`[${questionId}] ERROR during UI update AFTER successful save:`, uiError);
                     // Attempt to recover UI state might be complex, maybe notify user
                     showError(errorId, field, 'Save OK, but UI update failed. Refresh might be needed.');
                }

            } catch (error) { // Catch errors from Supabase or UI update block
                 console.error(`[${questionId}] CAUGHT ERROR during save process:`, error);
                 showError(errorId, field, `Save failed: ${error.message.split('(Code')[0].trim()}. Try again.`); // Show cleaner error

                 // Re-enable buttons and field ONLY IF THEY EXIST (re-query just in case)
                 const currentField = document.querySelector(`[data-question="${questionId}"]`);
                 const currentButtonContainer = currentField?.closest('li, .question-box') || currentField?.parentElement;
                 const currentSaveButton = currentButtonContainer?.querySelector('.save-button');
                 const currentDeleteButton = currentButtonContainer?.querySelector('.delete-button');


                 if (currentField) currentField.disabled = false; // Re-enable field
                 if (currentSaveButton) {
                     currentSaveButton.disabled = false;
                     currentSaveButton.textContent = 'Save'; // Reset text
                 }
                  // Only re-enable delete button if save failed and field is re-enabled
                 if (currentDeleteButton && currentField && !currentField.disabled) {
                      currentDeleteButton.disabled = false;
                      // Keep delete button hidden or show it? Let's keep it hidden until explicitly deleted.
                      // currentDeleteButton.style.display = 'inline-block';
                 }
                 updateOverallProgress(); // Update progress in case validation state changed
            }
        }


        window.deleteAnswer = async function(questionId) {
            const currentUser = getCurrentUser(); if (!currentUser?.email || !currentUser.id) { alert('Session expired. Please log in again.'); logout(); return; }

            const field = document.querySelector(`[data-question="${questionId}"]`); if (!field) { console.error("Delete Error: Field missing for", questionId); return; }

            const errorId = `error-${questionId}`;
            const statusId = `save-status-${questionId}`;
            // Use same refined button finding logic as saveAnswer
            const buttonContainer = field.closest('li, .question-box') || field.parentElement;
            const buttonGroup = buttonContainer?.querySelector('.answer-buttons');
            const saveButton = buttonGroup?.querySelector('.save-button');
            const deleteButton = buttonGroup?.querySelector('.delete-button');

             // Allow deleting even if field is currently disabled (i.e., clearing a saved answer)
             // if (field.disabled) {
             //     console.warn("Attempting to delete a saved/disabled answer:", questionId);
             // }

             if (!confirm('Are you sure you want to clear this answer? This cannot be undone.')) return;

             hideMessages(statusId, errorId, field); // Clear previous messages
             field.value = (field.type === 'date') ? '' : ''; // Clear field value

             // Re-enable the field immediately for user interaction
             field.disabled = false;
             field.style.backgroundColor=''; // Reset styles if needed
             field.style.cursor='';
             field.classList.remove('required-field'); // Ensure error style is removed

             // Disable buttons during the async operation
              if (saveButton) saveButton.disabled = true;
              if (deleteButton) deleteButton.disabled = true;

             // --- Delete from Supabase ---
             try {
                  console.log(`[${questionId}] Attempting to delete from user_progress...`);
                  const { error } = await supabase
                       .from('user_progress')
                       .delete()
                       .match({ user_id: currentUser.id, question_id: questionId });

                   if (error) {
                       // Log the error but proceed with local/UI updates as the primary source of truth is local storage for immediate UX
                       console.error(`[${questionId}] Supabase delete error (proceeding with local/UI):`, error);
                       // Show a non-blocking warning to the user?
                       // showGeneralWarningMessage(`Could not clear '${questionId}' from server records. Local data cleared.`);
                   } else {
                       console.log(`[${questionId}] Supabase delete successful.`);
                   }

                   // --- Update Local Storage & UI (Always execute after attempt) ---
                   deleteAnswerFromStorage(currentUser.email, questionId); console.log("Cleared answer locally for", questionId);

                   updateOverallProgress(); // Update overall progress as an item is removed
                   showSaveStatus(statusId, 'âœ“ Cleared'); // Show cleared status message

                   // --- Re-enable Buttons Correctly Post-Delete ---
                   if (saveButton) {
                       saveButton.disabled = false; // Enable Save button
                       saveButton.textContent = 'Save'; // Reset text
                       console.log(`[${questionId}] Save button re-enabled.`);
                   } else {
                       console.warn(`[${questionId}] Save button NOT FOUND for UI update post-delete.`);
                   }

                   if (deleteButton) {
                       deleteButton.disabled = false; // Enable Delete button
                       deleteButton.style.display = 'inline-block'; // Make visible again
                       console.log(`[${questionId}] Delete button re-enabled and shown.`);
                   } else {
                       console.warn(`[${questionId}] Delete button NOT FOUND for UI update post-delete.`);
                   }

             } catch (error) { // Catch errors during the entire process (DB or local/UI)
                  console.error(`[${questionId}] Failed to process delete action:`, error);
                  showError(errorId, field, 'Clear failed. Please refresh.');
                  // Attempt to restore button state if possible, though state might be inconsistent
                  // Ensure field remains enabled as user intended to clear it
                  field.disabled = false;
                  if (saveButton) { saveButton.disabled = false; saveButton.textContent = 'Save'; }
                  if (deleteButton) { deleteButton.disabled = false; deleteButton.style.display = 'inline-block'; }
             }
        }


        // --- Completion Handling ---
        function markPlanAsComplete(userEmail) {
            if (!userEmail) return;
            // Final validation check just before marking complete
             if (!validateAllAnswers(false)) { // Don't show errors again, just check
                 showGeneralWarningMessage('Cannot complete: Missing required answers.');
                 return;
             }

            const k=`${localStorageKey}_completed_${userEmail}`;
            console.log('AP: Marking complete with key:',k);
            try {
                localStorage.setItem(k,'true');
                updateOverallProgress(100); // Force progress to 100%
                displayCompletionState();
                const cM=document.getElementById('completionMessage');
                if(cM) {
                    cM.style.display='block'; // Ensure message is visible
                    cM.scrollIntoView({behavior:'smooth', block: 'center'});
                }
                hideGeneralWarningMessage(); // Hide any lingering warnings
                 const generalWarningDiv = document.getElementById('generalInlineWarningMessage');
                 if(generalWarningDiv) generalWarningDiv.style.display = 'none';

                 // Optionally: Send a 'completion' event to Supabase
                  logCompletionEvent(userEmail);

            } catch(e) {
                console.error("AP: Error saving completion status:", e);
                alert("Could not save completion status due to storage error.");
            }
        }

        async function logCompletionEvent(userEmail) {
            if (!supabase || !userEmail) return;
            const currentUser = getCurrentUser();
            if (!currentUser || !currentUser.id) return;

            console.log(`Logging completion event for ${userEmail} on ${PAGE_NAME}`);
            try {
                const { error } = await supabase.from('user_progress').insert([{
                    user_id: currentUser.id,
                    email: userEmail,
                    question_id: `${SECTION_ID}_completion_marker`, // Unique ID for completion
                    question_text: `Action Plan Marked Complete`,
                    answer: 'Completed',
                    page: PAGE_NAME,
                    status: 'completed',
                    submitted_at: new Date().toISOString(),
                    updated_at: new Date().toISOString(),
                    section_type: 'completion_status',
                    section_id: SECTION_ID,
                    section_title: document.title || 'Coaching Action Plan',
                    progress_percentage: 100,
                    score: null,
                    is_passed: true // Mark as passed/completed
                }]);
                if (error) {
                    console.error("Error logging completion event to Supabase:", error);
                } else {
                    console.log("Completion event logged successfully.");
                }
            } catch (e) {
                console.error("Exception while logging completion event:", e);
            }
        }


        function checkCompletionState(userEmail) {
             if (!userEmail) return;
             const completionKey = `${localStorageKey}_completed_${userEmail}`;
             const isComplete = localStorage.getItem(completionKey) === 'true';
             const allAnswers = JSON.parse(localStorage.getItem(localStorageKey) || '{}');
             const userPageAnswers = allAnswers[userEmail] || {};

              const cM=document.getElementById('completionMessage');
              const cB=document.getElementById('completeButton');
              const bB=document.getElementById('backButton');
              const generalWarningDiv = document.getElementById('generalInlineWarningMessage'); // Inline warning
              if (generalWarningDiv) generalWarningDiv.style.display = 'none'; // Hide inline warning initially

             if (isComplete) {
                 console.log("AP: Plan is already marked complete for", userEmail);
                 displayCompletionState(); // Locks fields, hides button, shows message
             } else {
                 console.log("AP: Plan not complete for", userEmail);
                 if(cM) cM.style.display='none';
                 if(cB) { cB.style.display='block'; cB.disabled = false; } // Ensure button visible and enabled
                 if(bB) { bB.textContent='â† Back to Self Coaching'; bB.href='coaching-yourself.html'; }

                 // Re-evaluate field states based on loaded answers, NOT just enabling all
                 document.querySelectorAll('.editable-answer[data-question]').forEach(field => {
                    loadFieldState(field, field.dataset.question, userPageAnswers); // Reload state to ensure consistency
                 });
                 updateOverallProgress(); // Recalculate progress based on loaded state
             }
        }

        function displayCompletionState() {
             console.log('AP: Displaying completion state UI');
             const cM=document.getElementById('completionMessage');
             const cB=document.getElementById('completeButton');
             const bB=document.getElementById('backButton');
             const generalWarningDiv = document.getElementById('generalInlineWarningMessage'); // Inline warning
             if (generalWarningDiv) generalWarningDiv.style.display = 'none'; // Hide inline warning

             if(cM) cM.style.display='block';
             if(cB) { cB.style.display='none'; cB.disabled = true; } // Hide and disable complete button

             const cont=document.querySelector('.container');
             if(cont){
                 cont.querySelectorAll('textarea, input, select').forEach(el=>{
                     el.disabled=true;
                     el.style.backgroundColor='#f0f0f0'; // Match disabled style
                     el.style.cursor='not-allowed';
                 });
                 cont.querySelectorAll('.save-button, .delete-button').forEach(el=>{
                     el.disabled=true;
                     el.style.cursor='not-allowed';
                      // Optionally hide delete buttons completely in completed state
                      if (el.classList.contains('delete-button')) {
                           el.style.display = 'none';
                      }
                      // Ensure save buttons show 'Saved'
                      if (el.classList.contains('save-button')) {
                           el.textContent = 'Saved âœ”ï¸';
                      }
                 });
             }
             if(bB){bB.textContent='â† Back to Dashboard'; bB.href='dashboard.html';} // Change back button destination
             updateOverallProgress(100); // Ensure progress shows 100%
             hideGeneralWarningMessage(); // Hide floating warning
        }

    </script>

</body>
</html>
