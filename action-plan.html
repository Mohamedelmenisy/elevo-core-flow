<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coaching Action Plan | Leadership Coaching</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- Global Styles (Consistent) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html { scroll-behavior: smooth; }
        body { margin: 0; padding: 0; line-height: 1.7; background-color: #f9f9f9; color: #333; }
        /* User Bar Styles (Consistent) */
        .user-bar { background-color: #34495e; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; color: white; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-info svg { opacity: 0.8; }
        .user-details { display: flex; flex-direction: column; }
        .user-name { font-weight: 600; font-size: 14px; }
        .user-email { font-size: 12px; opacity: 0.8; }
        .logout-button { background-color: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 6px; font-size: 13px; }
        .logout-button:hover { background-color: #c0392b; transform: translateY(-1px); }
        .logout-button:active { transform: translateY(0); }
        /* Navigation Tabs (Consistent) */
        .nav-tab { background-color: #2c3e50; padding: 12px 10px; text-align: center; position: sticky; top: 0; z-index: 100; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; scrollbar-width: thin; scrollbar-color: #556a80 #2c3e50; }
        .nav-tab::-webkit-scrollbar { height: 6px; }
        .nav-tab::-webkit-scrollbar-track { background: #2c3e50; }
        .nav-tab::-webkit-scrollbar-thumb { background-color: #556a80; border-radius: 10px; border: 1px solid #2c3e50; }
        .nav-tab a { color: white; text-decoration: none; margin: 0 8px; padding: 8px 12px; border-radius: 6px; transition: background-color 0.3s, color 0.3s; font-size: 14px; display: inline-block; }
        .nav-tab a:hover, .nav-tab a.active { background-color: #34495e; color: #fff; }
        /* Main Content Styles (Consistent) */
        h1 { color: #fff; background-color: #e67e22; padding: 20px; border-radius: 8px; text-align: center; margin: 25px auto; max-width: 800px; font-size: 26px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { color: white; background-color: #34495e; padding: 12px 15px; border-radius: 6px; text-align: left; margin: 30px 0 20px; font-size: 1.4em; }
        h3 { color: #e67e22; margin: 20px 0 15px; text-align: left; font-size: 1.2em; }
        .container {
            max-width: 800px;
            margin: 0 auto 30px;
            background: white;
            padding: 30px;
            padding-top: 80px; /* <<< Adjusted Padding Top */
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        .highlight-section { background-color: rgba(230, 126, 34, 0.07); padding: 20px; border-left: 5px solid #e67e22; border-radius: 6px; margin: 25px 0; }
        .image-container { text-align: center; margin: 30px 0; }
        .image-container img { max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .caption { color: #555; margin-top: 10px; font-size: 14px; }
        .question-box { background-color: rgba(52, 152, 219, 0.08); padding: 25px; border-radius: 6px; margin: 25px 0; border: 1px solid rgba(52, 152, 219, 0.2); border-left: 5px solid #3498db; }
        .question-box h4 { margin-top: 0; margin-bottom: 10px; color: #34495e; font-weight: 600; font-size: 1.1em; }
        .question-box h4 .required-star { color: #e74c3c; font-weight: bold; margin-left: 3px; }
        textarea, input[type="text"], input[type="date"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; margin-top: 8px; margin-bottom: 5px; /* Reduced bottom margin */ background-color: white; min-height: 45px; line-height: 1.6; display: block; color: #333; font-size: 15px; transition: border-color 0.3s, box-shadow 0.3s; }
        textarea { min-height: 80px; resize: vertical; }
        textarea:focus, input[type="text"]:focus, input[type="date"]:focus { outline: none; border-color: #e67e22; box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.2); }
        textarea::placeholder, input::placeholder { color: #aaa; opacity: 1; }
        textarea:disabled, input:disabled { background-color: #f8f9fa; cursor: not-allowed; color: #6c757d; } /* Disabled */
        ol { list-style: decimal; margin-left: 25px; margin-bottom: 15px; padding-left: 0; /* Remove default padding */ }
        ul { list-style: disc; margin-left: 25px; margin-bottom: 15px; }
        li { margin-bottom: 15px; /* Increased space between list items */ list-style-position: outside; padding-left: 5px; }
        ol textarea, ul textarea { min-height: 50px; margin-top: 5px; margin-bottom: 5px; /* Adjust margins */ }
        .save-button, .delete-button { color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; transition: all 0.3s ease; font-size: 14px; font-weight: 500; }
        .save-button { background-color: #27ae60; }
        .delete-button { background-color: #e74c3c; margin-left: 8px; }
        .save-button:hover:not(:disabled) { background-color: #2ecc71; transform: translateY(-1px); }
        .delete-button:hover:not(:disabled) { background-color: #c0392b; transform: translateY(-1px); }
        .save-button:active, .delete-button:active { transform: translateY(0); }
        .save-button:disabled, .delete-button:disabled { background-color: #bdc3c7; cursor: not-allowed; transform: none; box-shadow: none; }
        .answer-buttons { display: flex; align-items: center; margin-top: 8px; /* Space above buttons */ flex-wrap: wrap; gap: 10px; margin-bottom: 15px; /* Space below buttons before next item */ }
        .table-container .answer-buttons { margin-top: 5px; margin-bottom: 5px; } /* Less margin in tables */
        .save-status { font-size: 13px; color: #27ae60; margin-left: 10px; display: none; font-weight: 500; }
        .save-status.deleted { color: #6c757d; }
        .inline-error-message { color: #e74c3c; font-size: 13px; display: block; /* Make it block */ margin-top: -5px; /* Pull closer to input */ margin-bottom: 10px; font-weight: 500; min-height: 1.2em; /* Reserve space */ display: none; } /* Hide initially */
        /* Tables */
        table { width: 100%; border-collapse: collapse; margin: 25px 0; font-size: 14px; }
        table, th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f2f2f2; font-weight: 600; color: #333; }
        .swot-table th:nth-child(1) { background-color: #27ae60 !important; color: white !important; }
        .swot-table th:nth-child(2) { background-color: #e74c3c !important; color: white !important; }
        .options-table th { color: white !important; text-align: center !important; }
        .options-table th:nth-child(1) { background-color: #3498db !important; }
        .options-table th:nth-child(2) { background-color: #2ecc71 !important; }
        .options-table th:nth-child(3) { background-color: #e74c3c !important; }
        .will-table th { color: white !important; text-align: center !important; }
        .will-table th:nth-child(1) { background-color: #3498db !important; }
        .will-table th:nth-child(2) { background-color: #9b59b6 !important; }
        .will-table th:nth-child(3) { background-color: #e67e22 !important; }
        /* Navigation Buttons */
        .navigation-buttons { display: flex; justify-content: space-between; margin-top: 40px; gap: 20px; border-top: 1px solid #eee; padding-top: 25px; }
        .navigation-buttons a, .navigation-buttons button { text-decoration: none; padding: 12px 20px; color: white; border-radius: 4px; font-weight: 600; flex: 1; text-align: center; transition: all 0.3s ease; font-size: 15px; border: none; cursor: pointer; }
        .navigation-buttons .back { background-color: #6c757d; }
        .navigation-buttons #completeButton { background-color: #e67e22; }
        .navigation-buttons a:hover, .navigation-buttons button:hover:not(:disabled) { transform: translateY(-1px); filter: brightness(110%); }
        .navigation-buttons a:active, .navigation-buttons button:active:not(:disabled) { transform: translateY(0); filter: brightness(100%); }
        .navigation-buttons #completeButton:disabled { background-color: #bdc3c7; cursor: not-allowed; transform: none; box-shadow: none; filter: none; }
        .floating-warning { background-color: #fff8e1; border-left: 4px solid #ffc107; padding: 15px 25px; color: #333; display: none; position: fixed; top: 75px; left: 50%; transform: translateX(-50%); z-index: 1001; border-radius: 6px; box-shadow: 0 3px 10px rgba(0,0,0,0.2); animation: slideDownFadeIn 0.4s ease-out; font-weight: 500; max-width: 90%; width: auto; min-width: 300px; text-align: center; }
        @keyframes slideDownFadeIn { from { opacity: 0; top: 50px; } to { opacity: 1; top: 75px; } }
        @keyframes fadeOutUp { from { opacity: 1; top: 75px;} to { opacity: 0; top: 50px;} }
        .completion-message { background-color: rgba(39, 174, 96, 0.1); padding: 25px; border-left: 5px solid #27ae60; border-radius: 8px; margin: 30px 0; text-align: center; display: none; border: 1px solid rgba(39, 174, 96, 0.2); }
        .completion-message h3 { color: #27ae60; margin-bottom: 15px; font-size: 1.3em;}
        .completion-message p { color: #333; margin-bottom: 10px; }
        .required-field { border: 2px solid #e74c3c !important; background-color: #fff2f1 !important; box-shadow: none !important; }
        .required-star { color: #e74c3c; font-weight: bold; margin-left: 2px; }

         /* --- Progress Bar Styles --- */
        .question-progress-container { margin-top: 15px; background-color: #ecf0f1; border-radius: 5px; overflow: hidden; height: 12px; width: 100%; display: none; /* Hidden by default */ }
        .question-progress-bar { height: 100%; width: 100%; background: linear-gradient(90deg, #2ecc71, #27ae60); /* Green gradient */ border-radius: 5px; transition: opacity 0.5s ease-in-out; display: flex; align-items: center; justify-content: center; }
        .question-progress-text { font-size: 9px; font-weight: 600; color: white; text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.2); white-space: nowrap; overflow: hidden; padding: 0 4px; }
        .table-container + .question-progress-container { margin-top: 10px; margin-bottom: 15px;} /* Space below table, above bar */

        /* Responsive Adjustments */
        @media (max-width: 768px) { h1 { font-size: 22px; padding: 15px; margin: 20px 15px; } h2 { font-size: 1.2em; padding: 10px 15px; } .container { padding: 20px; padding-top: 40px; margin: 0 15px 20px; } .user-bar { padding: 10px 15px; font-size: 13px; } .user-name { font-size: 13px; } .user-email { font-size: 11px; } .logout-button { padding: 7px 12px; font-size: 12px; } .nav-tab { padding: 10px 5px; } .nav-tab a { margin: 0 5px; padding: 7px 10px; font-size: 13px;} .highlight-section, .question-box { padding: 15px; margin: 20px 0; } textarea { min-height: 80px; } ol textarea { min-height: 50px; } .save-button, .delete-button { padding: 7px 13px; font-size: 13px; } .navigation-buttons { flex-direction: column; } .navigation-buttons a, .navigation-buttons button { font-size: 14px; padding: 12px 15px;} .floating-warning { padding: 12px 20px; font-size: 14px; top: 65px; width: calc(100% - 30px); max-width: 400px; } @keyframes slideDownFadeIn { from { opacity: 0; top: 45px; } to { opacity: 1; top: 65px; } } @keyframes fadeOutUp { from { opacity: 1; top: 65px;} to { opacity: 0; top: 45px;} } .completion-message { padding: 20px; } .completion-message h3 { font-size: 1.2em; }
             /* Responsive Tables */
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { border: 1px solid #ccc; margin-bottom: 10px; border-radius: 4px; }
            .action-card tr { border: 1px solid rgba(255,255,255,0.3); }
            td { border: none; border-bottom: 1px solid #eee; position: relative; padding-left: 40% !important; text-align: right !important; min-height: 40px; }
             .action-card td { border-bottom: 1px solid rgba(255,255,255,0.2); padding-left: 6px !important; text-align: left !important;}
            td:before { position: absolute; top: 6px; left: 6px; width: 35%; padding-right: 10px; white-space: nowrap; content: attr(data-label); font-weight: bold; text-align: left;}
             .action-card td:before { color: #eee; }
             .action-card .orange-row td:before { display: none; }
             .action-card .editable-answer { width: 100%; }
              /* Keep action table headers */
              .action-table thead, .action-table tr, .action-table th, .action-table td { display: revert; }
             .action-table th { text-align: center;}
             .action-table td { padding-left: 10px !important; text-align: left !important;}
             .action-table td:before { display: none; }
             .answer-buttons { justify-content: flex-start; margin-top: 8px; } /* Adjust button alignment */
        }
    </style>
</head>
<body>
    <!-- User Info Bar -->
    <div class="user-bar"> <div class="user-info"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.8;"> <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path> <circle cx="12" cy="7" r="4"></circle> </svg> <div class="user-details"> <span class="user-name" id="userName">Loading...</span> <span class="user-email" id="userEmail"></span> </div> </div> <button class="logout-button" onclick="logout()"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path> <polyline points="16 17 21 12 16 7"></polyline> <line x1="21" y1="12" x2="9" y2="12"></line> </svg> Logout </button> </div>

    <!-- Navigation Tabs (Reordered) -->
    <nav class="nav-tab">
        <a href="dashboard.html">Dashboard</a>
        <a href="index.html">Home</a>
        <a href="introduction.html">Introduction</a>
        <a href="coaching-skills.html">Coaching Skills</a>
        <a href="coaching-individuals.html">Coaching Individuals</a>
        <a href="coaching-team.html">Team Coaching</a>
        <a href="coaching-yourself.html">Self Coaching</a>
        <a href="action-plan.html" class="active">Action Plan</a>
        <a href="ass.html">Assessment</a>
    </nav>

    <h1>Your Coaching Action Plan</h1>
    <div class="floating-warning" id="generalWarningMessage"></div>

    <div class="container">
        <div class="highlight-section"> <p>You've covered a lot of ground in this toolkit – well done! Now it's time to consolidate your learning and create a practical plan to implement these coaching skills.</p> <p>Coaching effectively requires commitment. This plan helps you define your motivations, allocate time, develop specific skills, choose appropriate models, and plan for both formal and informal coaching opportunities.</p> </div>
        <div class="image-container"> <img src="https://images.unsplash.com/photo-1573164713988-8665fc963095?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80" alt="Team creating action plan on whiteboard" onerror="this.onerror=null; this.src='https://via.placeholder.com/800x450/ffa726/ffffff?text=Team+Planning';" loading="lazy"> <p class="caption">Translate your learning into a concrete coaching action plan</p> </div>

        <!-- Section 5.1 -->
        <h2>5.1 Your Coaching Motivation</h2>
        <div class="question-box" data-section="motivation" id="section-container-motivation">
            <h4>Coaching excites me because<span class="required-star">*</span></h4>
            <textarea placeholder="What aspects of helping others grow and develop energize you?" class="editable-answer required-answer" data-question="excitement"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('excitement')">Save</button> <button class="delete-button" onclick="deleteAnswer('excitement')">Delete</button> <span class="inline-error-message" id="error-excitement"></span></div>
             <span class="save-status" id="save-status-excitement"></span> <!-- Moved status here -->


            <h4>Through coaching, I could personally gain<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., better delegation skills, stronger relationships, improved team performance..." class="editable-answer required-answer" data-question="personal-gain"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('personal-gain')">Save</button> <button class="delete-button" onclick="deleteAnswer('personal-gain')">Delete</button> <span class="inline-error-message" id="error-personal-gain"></span></div>
             <span class="save-status" id="save-status-personal-gain"></span> <!-- Moved status here -->

            <h4>It's worthwhile investing time and energy in coaching my team, because<span class="required-star">*</span></h4>
            <textarea placeholder="Connect coaching to specific team or organizational benefits." class="editable-answer required-answer" data-question="team-benefits"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('team-benefits')">Save</button> <button class="delete-button" onclick="deleteAnswer('team-benefits')">Delete</button> <span class="inline-error-message" id="error-team-benefits"></span></div>
              <span class="save-status" id="save-status-team-benefits"></span> <!-- Moved status here -->

             <!-- Removed Section Save/Delete Buttons & Warning Div -->
             <!-- Progress Bar (Now indicates section completion) -->
             <div class="question-progress-container" id="progress-container-motivation"> <div class="question-progress-bar" id="progress-bar-motivation"><span class="question-progress-text" id="progress-text-motivation">✔️ Completed</span></div> </div>
        </div>

        <!-- Section 5.2 -->
        <div class="image-container"> <img src="https://images.unsplash.com/photo-1521791055366-0d553872125f?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80" alt="Manager planning their schedule for coaching time" onerror="this.onerror=null; this.src='https://via.placeholder.com/800x450/3498db/ffffff?text=Time+Management';" loading="lazy"> <p class="caption">Making dedicated time is essential for effective coaching</p> </div>
        <h2>5.2 Making Time for Coaching</h2>
        <div class="question-box" data-section="time" id="section-container-time">
            <h4>To make time for coaching, the habit/process I need to stop or change first is<span class="required-star">*</span></h4>
            <textarea placeholder="Identify one specific time-consuming activity you can adjust." class="editable-answer required-answer" data-question="habits-to-change"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('habits-to-change')">Save</button> <button class="delete-button" onclick="deleteAnswer('habits-to-change')">Delete</button> <span class="inline-error-message" id="error-habits-to-change"></span></div>
            <span class="save-status" id="save-status-habits-to-change"></span>

            <h4>Potential blockers to making this change are<span class="required-star">*</span></h4>
            <textarea placeholder="Anticipate obstacles (e.g., urgent tasks, existing commitments)." class="editable-answer required-answer" data-question="blockers"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('blockers')">Save</button> <button class="delete-button" onclick="deleteAnswer('blockers')">Delete</button> <span class="inline-error-message" id="error-blockers"></span></div>
            <span class="save-status" id="save-status-blockers"></span>

            <h4>My first step to tackling these blockers is<span class="required-star">*</span></h4>
            <textarea placeholder="Define a concrete, actionable first step." class="editable-answer required-answer" data-question="first-step"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('first-step')">Save</button> <button class="delete-button" onclick="deleteAnswer('first-step')">Delete</button> <span class="inline-error-message" id="error-first-step"></span></div>
             <span class="save-status" id="save-status-first-step"></span>

            <h4>To make and sustain these changes, I need the support of<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., My manager, my team, specific colleagues..." class="editable-answer required-answer" data-question="support-needed"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('support-needed')">Save</button> <button class="delete-button" onclick="deleteAnswer('support-needed')">Delete</button> <span class="inline-error-message" id="error-support-needed"></span></div>
             <span class="save-status" id="save-status-support-needed"></span>

            <h4>I will discuss this with them by (date/method)<span class="required-star">*</span></h4>
            <textarea placeholder="Plan how and when you'll have this conversation." class="editable-answer required-answer" data-question="discussion-plan"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('discussion-plan')">Save</button> <button class="delete-button" onclick="deleteAnswer('discussion-plan')">Delete</button> <span class="inline-error-message" id="error-discussion-plan"></span></div>
             <span class="save-status" id="save-status-discussion-plan"></span>

            <h4>A Time Management resource that might help me is<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., Eisenhower Matrix, Time Blocking article, specific app..." class="editable-answer required-answer" data-question="resources"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('resources')">Save</button> <button class="delete-button" onclick="deleteAnswer('resources')">Delete</button> <span class="inline-error-message" id="error-resources"></span></div>
             <span class="save-status" id="save-status-resources"></span>

             <!-- Removed Section Save/Delete Buttons & Warning Div -->
             <!-- Progress Bar -->
             <div class="question-progress-container" id="progress-container-time"> <div class="question-progress-bar" id="progress-bar-time"><span class="question-progress-text" id="progress-text-time">✔️ Completed</span></div> </div>
        </div>

        <!-- Section 5.3 -->
        <h2>5.3 Developing Your Coaching Skills</h2>
        <div class="question-box" data-section="skills" id="section-container-skills">
            <h4>My strongest listening skill currently is<span class="required-star">*</span></h4>
            <textarea placeholder="Identify your best listening trait (e.g., patience, summarizing)." class="editable-answer required-answer" data-question="listening-strength"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('listening-strength')">Save</button> <button class="delete-button" onclick="deleteAnswer('listening-strength')">Delete</button> <span class="inline-error-message" id="error-listening-strength"></span></div>
             <span class="save-status" id="save-status-listening-strength"></span>

            <h4>I'll develop my listening further by applying these two techniques:<span class="required-star">*</span></h4>
            <ol>
                <li><textarea placeholder="First technique (e.g., paraphrase more, notice body language)." class="editable-answer required-answer" data-question="listening-tip1"></textarea>
                    <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('listening-tip1')">Save</button> <button class="delete-button" onclick="deleteAnswer('listening-tip1')">Delete</button> <span class="inline-error-message" id="error-listening-tip1"></span></div>
                     <span class="save-status" id="save-status-listening-tip1"></span>
                </li>
                <li><textarea placeholder="Second technique (e.g., ask clarifying questions, minimize distractions)." class="editable-answer required-answer" data-question="listening-tip2"></textarea>
                     <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('listening-tip2')">Save</button> <button class="delete-button" onclick="deleteAnswer('listening-tip2')">Delete</button> <span class="inline-error-message" id="error-listening-tip2"></span></div>
                      <span class="save-status" id="save-status-listening-tip2"></span>
                </li>
            </ol>

            <h4>When I notice myself making an assumption, I will<span class="required-star">*</span></h4>
            <textarea placeholder="Define your strategy (e.g., ask 'What makes you say that?', state the assumption)." class="editable-answer required-answer" data-question="assumption-plan"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('assumption-plan')">Save</button> <button class="delete-button" onclick="deleteAnswer('assumption-plan')">Delete</button> <span class="inline-error-message" id="error-assumption-plan"></span></div>
             <span class="save-status" id="save-status-assumption-plan"></span>

            <h4>Two new non-leading questions I will practice asking are:<span class="required-star">*</span></h4>
            <ol>
                <li><textarea placeholder="e.g., 'What options have you considered?', 'How does that align with X?'" class="editable-answer required-answer" data-question="question1"></textarea>
                     <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('question1')">Save</button> <button class="delete-button" onclick="deleteAnswer('question1')">Delete</button> <span class="inline-error-message" id="error-question1"></span></div>
                      <span class="save-status" id="save-status-question1"></span>
                </li>
                <li><textarea placeholder="e.g., 'What would success look like?', 'What support do you need?'" class="editable-answer required-answer" data-question="question2"></textarea>
                     <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('question2')">Save</button> <button class="delete-button" onclick="deleteAnswer('question2')">Delete</button> <span class="inline-error-message" id="error-question2"></span></div>
                     <span class="save-status" id="save-status-question2"></span>
                </li>
            </ol>

            <h4>The coachee emotions I find most challenging are... and when they arise, I feel...<span class="required-star">*</span></h4>
            <textarea placeholder="Identify 1-2 challenging emotions (e.g., frustration, apathy) and your reaction." class="editable-answer required-answer" data-question="emotion-challenge"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('emotion-challenge')">Save</button> <button class="delete-button" onclick="deleteAnswer('emotion-challenge')">Delete</button> <span class="inline-error-message" id="error-emotion-challenge"></span></div>
             <span class="save-status" id="save-status-emotion-challenge"></span>

            <h4>My own preoccupations/mood (e.g., feeling stressed, thinking about deadlines) can sometimes hinder open conversation.<span class="required-star">*</span></h4>
            <textarea placeholder="Acknowledge your internal distractions." class="editable-answer required-answer" data-question="own-mood"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('own-mood')">Save</button> <button class="delete-button" onclick="deleteAnswer('own-mood')">Delete</button> <span class="inline-error-message" id="error-own-mood"></span></div>
              <span class="save-status" id="save-status-own-mood"></span>

            <h4>I'll manage these emotional challenges (mine and theirs) better by<span class="required-star">*</span></h4>
            <textarea placeholder="Outline strategies (e.g., deep breaths, acknowledge feelings, refocus)." class="editable-answer required-answer" data-question="improvement-plan"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('improvement-plan')">Save</button> <button class="delete-button" onclick="deleteAnswer('improvement-plan')">Delete</button> <span class="inline-error-message" id="error-improvement-plan"></span></div>
              <span class="save-status" id="save-status-improvement-plan"></span>

            <h4>I can build trust more effectively by<span class="required-star">*</span></h4>
            <textarea placeholder="List 1-2 specific trust-building actions (e.g., maintain confidentiality, follow through)." class="editable-answer required-answer" data-question="trust-building"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('trust-building')">Save</button> <button class="delete-button" onclick="deleteAnswer('trust-building')">Delete</button> <span class="inline-error-message" id="error-trust-building"></span></div>
             <span class="save-status" id="save-status-trust-building"></span>

            <h4>My key professional strengths are... and I can apply these to coaching by<span class="required-star">*</span></h4>
            <textarea placeholder="Connect your existing strengths to coaching behaviors." class="editable-answer required-answer" data-question="strengths-application"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('strengths-application')">Save</button> <button class="delete-button" onclick="deleteAnswer('strengths-application')">Delete</button> <span class="inline-error-message" id="error-strengths-application"></span></div>
             <span class="save-status" id="save-status-strengths-application"></span>

             <!-- Removed Section Save/Delete Buttons & Warning Div -->
             <!-- Progress Bar -->
             <div class="question-progress-container" id="progress-container-skills"> <div class="question-progress-bar" id="progress-bar-skills"><span class="question-progress-text" id="progress-text-skills">✔️ Completed</span></div> </div>
        </div>

        <!-- Section 5.4 -->
        <h2>5.4 Implementing Coaching Models</h2>
        <div class="question-box" data-section="model" id="section-container-model">
            <h4>The first model I plan to use is... with...<span class="required-star">*</span></h4>
            <textarea placeholder="Choose a model (GROW, Skill/Will, Solution-Focused) and a specific person/situation." class="editable-answer required-answer" data-question="model-choice"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('model-choice')">Save</button> <button class="delete-button" onclick="deleteAnswer('model-choice')">Delete</button> <span class="inline-error-message" id="error-model-choice"></span></div>
             <span class="save-status" id="save-status-model-choice"></span>

            <h4>Because...<span class="required-star">*</span></h4>
            <textarea placeholder="Explain why this model fits this coachee or situation." class="editable-answer required-answer" data-question="model-reason"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('model-reason')">Save</button> <button class="delete-button" onclick="deleteAnswer('model-reason')">Delete</button> <span class="inline-error-message" id="error-model-reason"></span></div>
             <span class="save-status" id="save-status-model-reason"></span>

            <h4>I'll need to prepare for this session by<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., Reviewing the model steps, drafting opening questions, clearing my schedule." class="editable-answer required-answer" data-question="preparation"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('preparation')">Save</button> <button class="delete-button" onclick="deleteAnswer('preparation')">Delete</button> <span class="inline-error-message" id="error-preparation"></span></div>
             <span class="save-status" id="save-status-preparation"></span>

            <div class="image-container"> <img src="https://images.unsplash.com/photo-1552664730-d307ca884978?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80" alt="Manager evaluating different coaching approaches" onerror="this.onerror=null; this.src='https://via.placeholder.com/800x450/9b59b6/ffffff?text=Coaching+Models';" loading="lazy"> <p class="caption">Choosing the right coaching model for each situation</p> </div>

            <h4>I can show my coachee I have their best interests in mind by<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., Focusing fully on them, celebrating small wins, linking goals to their aspirations." class="editable-answer required-answer" data-question="best-interests"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('best-interests')">Save</button> <button class="delete-button" onclick="deleteAnswer('best-interests')">Delete</button> <span class="inline-error-message" id="error-best-interests"></span></div>
             <span class="save-status" id="save-status-best-interests"></span>

            <h4>I will demonstrate coaching integrity and humility by<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., Admitting I don't have all answers, respecting their views, maintaining confidentiality." class="editable-answer required-answer" data-question="integrity"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('integrity')">Save</button> <button class="delete-button" onclick="deleteAnswer('integrity')">Delete</button> <span class="inline-error-message" id="error-integrity"></span></div>
             <span class="save-status" id="save-status-integrity"></span>

            <h4>Two tips from successful coaches I'd feel comfortable applying are:<span class="required-star">*</span></h4>
            <ol>
                <li><textarea placeholder="e.g., Start session by asking 'What's on your mind?', Use silence effectively." class="editable-answer required-answer" data-question="tip1"></textarea>
                     <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('tip1')">Save</button> <button class="delete-button" onclick="deleteAnswer('tip1')">Delete</button> <span class="inline-error-message" id="error-tip1"></span></div>
                      <span class="save-status" id="save-status-tip1"></span>
                </li>
                <li><textarea placeholder="e.g., End session by asking 'What was most useful?', Follow up on actions." class="editable-answer required-answer" data-question="tip2"></textarea>
                     <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('tip2')">Save</button> <button class="delete-button" onclick="deleteAnswer('tip2')">Delete</button> <span class="inline-error-message" id="error-tip2"></span></div>
                      <span class="save-status" id="save-status-tip2"></span>
                </li>
            </ol>

             <!-- Removed Section Save/Delete Buttons & Warning Div -->
             <!-- Progress Bar -->
             <div class="question-progress-container" id="progress-container-model"> <div class="question-progress-bar" id="progress-bar-model"><span class="question-progress-text" id="progress-text-model">✔️ Completed</span></div> </div>
        </div>

        <!-- Section 5.5 -->
        <h2>5.5 Informal and Team Coaching</h2>
        <div class="question-box" data-section="team" id="section-container-team">
            <h4>I'll avoid being isolated from the team's daily work by<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., Regular check-ins, being present, participating in informal chats." class="editable-answer required-answer" data-question="shop-floor"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('shop-floor')">Save</button> <button class="delete-button" onclick="deleteAnswer('shop-floor')">Delete</button> <span class="inline-error-message" id="error-shop-floor"></span></div>
             <span class="save-status" id="save-status-shop-floor"></span>

            <div class="image-container"> <img src="https://images.unsplash.com/photo-1521791136064-7986c2920216?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80" alt="Manager having informal discussion with team members" onerror="this.onerror=null; this.src='https://via.placeholder.com/800x450/3498db/ffffff?text=Informal+Coaching';" loading="lazy"> <p class="caption">Staying connected enables effective informal coaching</p> </div>

            <h4>I can improve my judgment about when to intervene informally by<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., Paying closer attention to cues, asking clarifying questions first." class="editable-answer required-answer" data-question="intervention"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('intervention')">Save</button> <button class="delete-button" onclick="deleteAnswer('intervention')">Delete</button> <span class="inline-error-message" id="error-intervention"></span></div>
             <span class="save-status" id="save-status-intervention"></span>

            <h4>I plan to use team coaching with this team/group<span class="required-star">*</span></h4>
            <textarea placeholder="Identify the specific team or group." class="editable-answer required-answer" data-question="team-group"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('team-group')">Save</button> <button class="delete-button" onclick="deleteAnswer('team-group')">Delete</button> <span class="inline-error-message" id="error-team-group"></span></div>
              <span class="save-status" id="save-status-team-group"></span>

            <h4>...to help them work on this topic or issue<span class="required-star">*</span></h4>
            <textarea placeholder="Define the specific focus for team coaching (e.g., conflict resolution, goal alignment)." class="editable-answer required-answer" data-question="team-issue"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('team-issue')">Save</button> <button class="delete-button" onclick="deleteAnswer('team-issue')">Delete</button> <span class="inline-error-message" id="error-team-issue"></span></div>
             <span class="save-status" id="save-status-team-issue"></span>

            <h4>I'll prepare for team coaching by exploring personality/working styles using<span class="required-star">*</span></h4>
            <textarea placeholder="Name a model/tool (e.g., DiSC, Belbin - even informally) or describe your approach." class="editable-answer required-answer" data-question="personality-test"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('personality-test')">Save</button> <button class="delete-button" onclick="deleteAnswer('personality-test')">Delete</button> <span class="inline-error-message" id="error-personality-test"></span></div>
             <span class="save-status" id="save-status-personality-test"></span>

            <h4>...and by facilitating appreciation of diverse strengths/preferences through<span class="required-star">*</span></h4>
            <textarea placeholder="Describe the activity or discussion you will lead." class="editable-answer required-answer" data-question="strengths-appreciation"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('strengths-appreciation')">Save</button> <button class="delete-button" onclick="deleteAnswer('strengths-appreciation')">Delete</button> <span class="inline-error-message" id="error-strengths-appreciation"></span></div>
             <span class="save-status" id="save-status-strengths-appreciation"></span>

            <h4>Together, we'll develop a team charter following these steps<span class="required-star">*</span></h4>
            <textarea placeholder="Outline your collaborative process (e.g., brainstorm session, draft, review)." class="editable-answer required-answer" data-question="charter-steps"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('charter-steps')">Save</button> <button class="delete-button" onclick="deleteAnswer('charter-steps')">Delete</button> <span class="inline-error-message" id="error-charter-steps"></span></div>
             <span class="save-status" id="save-status-charter-steps"></span>

            <h4>I will address potential conflicting priorities by discussing them with<span class="required-star">*</span></h4>
            <textarea placeholder="Identify who needs to be involved (e.g., team, specific individuals, other managers)." class="editable-answer required-answer" data-question="conflict-resolution"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('conflict-resolution')">Save</button> <button class="delete-button" onclick="deleteAnswer('conflict-resolution')">Delete</button> <span class="inline-error-message" id="error-conflict-resolution"></span></div>
             <span class="save-status" id="save-status-conflict-resolution"></span>

            <h4>I plan to try the POSITIVE model at this upcoming meeting/situation<span class="required-star">*</span></h4>
            <textarea placeholder="Identify a specific opportunity to use the POSITIVE model." class="editable-answer required-answer" data-question="positive-model"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('positive-model')">Save</button> <button class="delete-button" onclick="deleteAnswer('positive-model')">Delete</button> <span class="inline-error-message" id="error-positive-model"></span></div>
              <span class="save-status" id="save-status-positive-model"></span>

            <h4>...and the PRACTICE model in this session/situation<span class="required-star">*</span></h4>
            <textarea placeholder="Identify a specific opportunity to use the PRACTICE model." class="editable-answer required-answer" data-question="practice-model"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('practice-model')">Save</button> <button class="delete-button" onclick="deleteAnswer('practice-model')">Delete</button> <span class="inline-error-message" id="error-practice-model"></span></div>
             <span class="save-status" id="save-status-practice-model"></span>

             <!-- Removed Section Save/Delete Buttons & Warning Div -->
             <!-- Progress Bar -->
             <div class="question-progress-container" id="progress-container-team"> <div class="question-progress-bar" id="progress-bar-team"><span class="question-progress-text" id="progress-text-team">✔️ Completed</span></div> </div>
        </div>

        <!-- Section 5.6 -->
        <h2>5.6 Self-Reflection and Review</h2>
        <div class="question-box" data-section="reflection" id="section-container-reflection">
            <h4>My personal SWOT analysis highlighted<span class="required-star">*</span></h4>
            <textarea placeholder="Summarize your key strengths and weaknesses identified earlier." class="editable-answer required-answer" data-question="swot-highlights"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('swot-highlights')">Save</button> <button class="delete-button" onclick="deleteAnswer('swot-highlights')">Delete</button> <span class="inline-error-message" id="error-swot-highlights"></span></div>
              <span class="save-status" id="save-status-swot-highlights"></span>

            <h4>As a result, a key action I will take is<span class="required-star">*</span></h4>
            <textarea placeholder="Define one specific action based on your SWOT (leverage strength or address weakness)." class="editable-answer required-answer" data-question="swot-actions"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('swot-actions')">Save</button> <button class="delete-button" onclick="deleteAnswer('swot-actions')">Delete</button> <span class="inline-error-message" id="error-swot-actions"></span></div>
            <span class="save-status" id="save-status-swot-actions"></span>

            <h4>The personal goal I'm working on using the GROW model is<span class="required-star">*</span></h4>
            <textarea placeholder="Restate your SMART goal from the GROW exercise." class="editable-answer required-answer" data-question="grow-goal"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('grow-goal')">Save</button> <button class="delete-button" onclick="deleteAnswer('grow-goal')">Delete</button> <span class="inline-error-message" id="error-grow-goal"></span></div>
              <span class="save-status" id="save-status-grow-goal"></span>

            <h4>My first action step towards this goal is<span class="required-star">*</span></h4>
            <textarea placeholder="Restate your first action step from the GROW 'Will' section." class="editable-answer required-answer" data-question="first-grow-action"></textarea>
             <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('first-grow-action')">Save</button> <button class="delete-button" onclick="deleteAnswer('first-grow-action')">Delete</button> <span class="inline-error-message" id="error-first-grow-action"></span></div>
             <span class="save-status" id="save-status-first-grow-action"></span>

            <h4>I've scheduled my first self-review for this toolkit on<span class="required-star">*</span></h4>
            <input type="date" class="editable-answer required-answer" data-question="review-date">
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('review-date')">Save</button> <button class="delete-button" onclick="deleteAnswer('review-date')">Delete</button> <span class="inline-error-message" id="error-review-date"></span></div>
             <span class="save-status" id="save-status-review-date"></span>

            <h4>Since starting this toolkit, changes I've observed in myself/my work include<span class="required-star">*</span></h4>
            <textarea placeholder="Reflect on any shifts in your perspective or behavior so far." class="editable-answer required-answer" data-question="self-changes"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('self-changes')">Save</button> <button class="delete-button" onclick="deleteAnswer('self-changes')">Delete</button> <span class="inline-error-message" id="error-self-changes"></span></div>
             <span class="save-status" id="save-status-self-changes"></span>

            <h4>Changes I've observed in my team's behavior/performance include<span class="required-star">*</span></h4>
            <textarea placeholder="Reflect on any impacts on your team, even small ones." class="editable-answer required-answer" data-question="team-changes"></textarea>
            <div class="answer-buttons"> <button class="save-button" onclick="saveAnswer('team-changes')">Save</button> <button class="delete-button" onclick="deleteAnswer('team-changes')">Delete</button> <span class="inline-error-message" id="error-team-changes"></span></div>
             <span class="save-status" id="save-status-team-changes"></span>

            <div class="image-container"> <img src="https://images.unsplash.com/photo-1542744173-8e7e53415bb0?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80" alt="Team reviewing progress and celebrating success" onerror="this.onerror=null; this.src='https://via.placeholder.com/800x450/2ecc71/ffffff?text=Team+Review';" loading="lazy"> <p class="caption">Regular review helps sustain coaching benefits</p> </div>

             <!-- Removed Section Save/Delete Buttons & Warning Div -->
             <!-- Progress Bar -->
             <div class="question-progress-container" id="progress-container-reflection"> <div class="question-progress-bar" id="progress-bar-reflection"><span class="question-progress-text" id="progress-text-reflection">✔️ Completed</span></div> </div>
        </div>

        <!-- Completion Message -->
        <div class="completion-message" id="completionMessage"> <h3>Congratulations on Completing Your Coaching Action Plan!</h3> <p>Thank you for taking the time to thoughtfully complete this action plan. You've taken important steps toward becoming a more effective coach for your team and yourself.</p> <p>Remember to review your plan regularly (starting on the date you set above!) and adjust as needed. Consistent application of these strategies will help you see the best results.</p> <p>Good luck with your coaching journey!</p> </div>

         <!-- General Warning Message -->
         <div class="warning-message" id="generalWarningMessage"> <strong>Action Required:</strong> Please complete all required fields (marked with <span class="required-star">*</span>) before completing the plan. </div>

        <!-- Navigation Buttons -->
        <div class="navigation-buttons"> <a href="coaching-yourself.html" class="button back" id="backButton">← Back to Self Coaching</a> <button type="button" class="button" id="completeButton">Mark Action Plan as Complete</button> </div>
    </div><!-- /.container -->

    <script>
        // --- Supabase Configuration ---
        const SUPABASE_URL = 'https://lgcutmuspcaralydycmg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnY3V0bXVzcGNhcmFseWR5Y21nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0NDY3MDEsImV4cCI6MjA2MTAyMjcwMX0.3u5Y7pkH2NNnnoGLMWVfAa5b8fq88o1itRYnG1K38tE';
        let supabase = null;

        // --- Configuration ---
        // REMOVED: Formspree Endpoint
        const localStorageKey = 'allUserAnswers_actionPlan';
        const SECTION_ID = 'action'; // Unique ID for overall Action Plan progress
        const PAGE_NAME = 'action-plan.html';

        // --- Unified Keys ---
        const LOGGED_IN_KEY = 'isUserLoggedIn';
        const CURRENT_USER_KEY = 'currentUser';

        // List of all section IDs on this page
        const pageSections = ['motivation', 'time', 'skills', 'model', 'team', 'reflection'];

        // Initialize Supabase Client
        try {
            if (window.supabase && window.supabase.createClient) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log(`Supabase client initialized successfully on ${PAGE_NAME}.`);
            } else { throw new Error("Supabase library not found."); }
        } catch (error) { console.error("CRITICAL ERROR initializing Supabase:", error); }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
             console.log(`%c${PAGE_NAME}: DOMContentLoaded event fired.`, "color: green;");
             if (!supabase) {
                 console.error(`Supabase client failed to initialize on ${PAGE_NAME}. Some features might not work.`);
             }

             const currentUser = getCurrentUser();
             if (!currentUser || !currentUser.id || !currentUser.email) { // Added ID check
                 console.error(`%c${PAGE_NAME}: User not logged in or essential data missing. Redirecting...`, "color: red;");
                  if (!window.location.search.includes('redir_attempt')) { window.location.href = `login.html?redirect=${encodeURIComponent(window.location.pathname + window.location.search)}&redir_attempt=1`; }
                  else { console.error("REDIRECTION LOOP DETECTED."); document.body.innerHTML = '<p style="color: red; padding: 20px;">Login check failed repeatedly.</p>'; }
                 return;
             }
             console.log(`%c${PAGE_NAME}: User validated (${currentUser.email}, ID: ${currentUser.id}). Initializing.`, "color: green;");
             displayUserInfo();
             loadUserAnswers(currentUser); // Pass full user object
             setupEventListeners(currentUser); // Pass full user object
             highlightActiveNav();
             checkCompletionState(currentUser.email); // Check if plan already marked complete
             // addRequiredStars(); // Stars are hardcoded
             setupMobileTableLabels();
             console.log(`%c${PAGE_NAME}: Initialization complete.`, "color: blue;");
        });

        // --- User Info & Auth ---
        function getCurrentUser() { /* ... consistent ... */ try { const d = localStorage.getItem(CURRENT_USER_KEY); if (!d) return null; const p = JSON.parse(d); if (p && typeof p === 'object' && p.email && p.name && p.id) { if (typeof p.progress !== 'object' || p.progress === null) p.progress = {}; return p; } else { localStorage.removeItem(CURRENT_USER_KEY); localStorage.removeItem(LOGGED_IN_KEY); return null; } } catch (e) { console.error("GUC Error:", e); localStorage.removeItem(CURRENT_USER_KEY); localStorage.removeItem(LOGGED_IN_KEY); return null; } }
        function saveCurrentUser(userObject) { /* ... consistent ... */ try { if (!userObject || typeof userObject !== 'object') throw new Error("Invalid user object"); localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(userObject)); console.log("Saved user data."); } catch (error) { console.error("SCU Error:", error); } }
        function displayUserInfo() { /* ... consistent ... */ const u=getCurrentUser(); if(u){document.getElementById('userName').textContent=`Welcome, ${u.name || u.email.split('@')[0]}`; document.getElementById('userEmail').textContent=u.email;}else{console.warn("DIU: No user");}}
        function logout() { /* ... consistent ... */ const u=getCurrentUser(); const e=u?u.email:null; localStorage.removeItem(LOGGED_IN_KEY); localStorage.removeItem(CURRENT_USER_KEY); if(e){const k=`${localStorageKey}_completed_${e}`; localStorage.removeItem(k); console.log(`Removed completion key: ${k}`);} window.location.href = 'login.html';}
        function highlightActiveNav() { /* ... consistent ... */ const cP=window.location.pathname.split('/').pop()||PAGE_NAME; document.querySelectorAll('.nav-tab a').forEach(l=>{const lP=(l.getAttribute('href')||'').split('/').pop(); l.classList.toggle('active',lP===cP);}); }
        function setupMobileTableLabels() { /* ... consistent ... */ document.querySelectorAll('table tbody tr').forEach(r=>{const h=Array.from(r.closest('table').querySelectorAll('thead th')).map(th=>th.textContent.replace('*','').trim()); r.querySelectorAll('td').forEach((t,i)=>t.setAttribute('data-label',h[i]||''));});}


        // --- Answer Handling (Local Storage & UI Locking) ---
        function loadUserAnswers(currentUser) {
            if (!currentUser || !currentUser.email) return;
            let allAnswers = {};
            try { const d = localStorage.getItem(localStorageKey); if (d) allAnswers = JSON.parse(d) || {}; }
            catch(e) { console.error("Load Answers Error:", e); }
            const userPageAnswers = allAnswers[currentUser.email] || {};

            // Load field values for all editable answers using data-question
            document.querySelectorAll('.editable-answer[data-question]').forEach(field => {
                loadFieldState(field, field.dataset.question, userPageAnswers);
            });

             // Show progress bar for COMPLETED sections only
            pageSections.forEach(secId => {
                 const sectionContainer = document.getElementById(`section-container-${secId}`);
                 if (sectionContainer && isSectionComplete(secId, userPageAnswers)) {
                      showQuestionProgressBar(sectionContainer); // Show 100% bar
                 } else if (sectionContainer) {
                      hideQuestionProgressBar(sectionContainer);
                 }
            });
            updateSectionProgress(SECTION_ID); // Update overall progress display based on loaded sections
        }

        // Helper to load state for ANY field
        function loadFieldState(field, questionId, userAnswers) {
            if (!field) return;
             const errorId = `error-${questionId}`;
             const buttonGroup = field.parentElement?.querySelector('.answer-buttons');
             const saveButton = buttonGroup?.querySelector('.save-button');
             const deleteButton = buttonGroup?.querySelector('.delete-button');
             const questionContainer = field.closest('.question-box'); // Container for section progress check

            hideMessages(statusId, errorId, field); // Clear status and error for this field

            // Check if an answer exists AND it's not just whitespace
            if (userAnswers[questionId] !== undefined && userAnswers[questionId] !== null && userAnswers[questionId].trim() !== '') {
                field.value = userAnswers[questionId];
                field.disabled = true; // Disable field
                field.classList.remove('required-field');
                if (saveButton) {
                    saveButton.disabled = true;
                    saveButton.textContent = 'Saved ✔️';
                }
                if (deleteButton) {
                    deleteButton.disabled = true;
                    deleteButton.style.display = 'none'; // Hide delete button
                }
            } else {
                // Ensure fields are enabled if no answer is found or answer is empty/whitespace
                 field.value = (field.type === 'date') ? '' : ''; // Reset field value (handle date type)
                field.disabled = false;
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.textContent = 'Save';
                }
                if (deleteButton) {
                    deleteButton.disabled = false;
                    deleteButton.style.display = 'inline-block'; // Show delete button
                }
            }
             // Note: Individual progress bars are removed, section bars handled in loadUserAnswers
        }

        function saveAnswerToStorage(userEmail, questionId, answer) { /* ... consistent ... */ if (!userEmail) return false; let a={}; try{const d=localStorage.getItem(localStorageKey); if(d)a=JSON.parse(d)||{};}catch(e){a={};} if(!a[userEmail])a[userEmail]={}; a[userEmail][questionId]=answer; try{localStorage.setItem(localStorageKey,JSON.stringify(a)); return true;}catch(e){console.error("AP Save Err:",e);return false;} }
        function deleteAnswerFromStorage(userEmail, questionId) { /* ... consistent ... */ if (!userEmail) return false; let a={}; try{const d=localStorage.getItem(localStorageKey); if(d)a=JSON.parse(d)||{}; else return false;}catch(e){return false;} let u=false; if(a[userEmail]?.[questionId]!==undefined){delete a[userEmail][questionId]; u=true; if(Object.keys(a[userEmail]).length===0)delete a[userEmail];} if(u){try{localStorage.setItem(localStorageKey,JSON.stringify(a)); return true;}catch(e){return false;}} return false;}

        // --- Section Progress Calculation & Display ---
        function isSectionComplete(sectionId, userAnswers) {
             const sectionBox = document.querySelector(`.question-box[data-section="${sectionId}"]`);
             if (!sectionBox) return false;
             const requiredFields = sectionBox.querySelectorAll('.required-answer');
             if (requiredFields.length === 0) return true; // No required fields = complete

             for (const field of requiredFields) {
                 const qId = field.dataset.question;
                 // Check userAnswers directly from passed argument
                 if (userAnswers[qId] === undefined || userAnswers[qId] === null || userAnswers[qId].trim() === '') {
                     return false; // Found an empty required field
                 }
             }
             return true; // All required fields have answers
        }

        function updateSectionProgress(sectionId, forcePercentage = null) {
            const currentUser = getCurrentUser(); if (!currentUser) return 0;
            let allAnswers = {}; try { const d = localStorage.getItem(localStorageKey); if (d) allAnswers = JSON.parse(d) || {}; } catch (e) {}
            const userAnswers = allAnswers[currentUser.email] || {};

            let progressPercentage = 0;

             if (forcePercentage !== null && !isNaN(forcePercentage)) {
                 progressPercentage = Math.max(0, Math.min(100, Math.round(forcePercentage)));
                 console.log(`Forcing ${sectionId} progress to ${progressPercentage}%`);
             } else {
                 const totalSections = pageSections.length;
                 if (totalSections === 0) return 0;
                 let completedSections = 0;
                 pageSections.forEach(secId => {
                     if (isSectionComplete(secId, userAnswers)) { // Pass userAnswers
                         completedSections++;
                     }
                 });
                 progressPercentage = Math.round((completedSections / totalSections) * 100);
             }


            if (!currentUser.progress) currentUser.progress = {};
            currentUser.progress[sectionId] = progressPercentage; // Update overall 'action' progress
            saveCurrentUser(currentUser);
            console.log(`Section '${sectionId}' progress updated to ${progressPercentage}%`);
            return progressPercentage;
        }

        function showQuestionProgressBar(containerElement) { // Simplified: shows 100% green bar
            if(!containerElement) return;
            const pC = containerElement.querySelector('.question-progress-container');
            if(pC) {
                 const bar = pC.querySelector('.question-progress-bar');
                 const text = pC.querySelector('.question-progress-text');
                 if(bar && text) {
                      bar.style.width = '100%';
                      text.textContent = '✔️ Completed'; // Changed text
                      pC.style.display = 'block';
                 }
            }
        }
        function hideQuestionProgressBar(containerElement) { /* ... consistent ... */ if(!containerElement)return; const pC=containerElement.querySelector('.question-progress-container')||containerElement; if(pC) pC.style.display='none'; }

        // --- Event Listeners Setup ---
        function setupEventListeners(userEmail) { /* ... consistent ... */ if (!userEmail) return; document.querySelectorAll('.editable-answer').forEach(f=>{const eT=(f.type==='date'||f.tagName==='SELECT')?'change':'input'; f.addEventListener(eT, function(){const qId=this.dataset.question; if(qId){const eId=`error-${qId}`; this.classList.remove('required-field'); hideError(eId); }});}); const cB=document.getElementById('completeButton'); if(cB)cB.addEventListener('click',()=>handleCompleteButtonClick(userEmail)); else console.warn("Complete button not found."); }
        function handleCompleteButtonClick(userEmail) { /* ... consistent ... */ if (!userEmail) { alert("Session error."); logout(); return; } if (!validateAllAnswers(true)) { showGeneralWarningMessage(); console.log("Validation failed."); } else { console.log("Validation passed."); markPlanAsComplete(userEmail); } }

        // --- UI Feedback & Validation ---
        function validateAllAnswers(showErrors = false) { /* ... consistent ... */
            let allValid=true; let firstInvalidField=null; console.log("AP: Validating all answers...");
            document.querySelectorAll('.required-answer').forEach(f=>{
                const qId=f.dataset.question;
                const eId=`error-${qId}`;
                const sectionContainer = f.closest('.question-box');
                const sectionWarningId = sectionContainer ? `warning-${sectionContainer.dataset.section}` : null; // This might not exist anymore

                hideError(eId); // Clear individual error first
                f.classList.remove('required-field');

                if(f.offsetParent!==null && f.value.trim()===''){
                    allValid=false;
                    if(!firstInvalidField)firstInvalidField=f;
                    if(showErrors){
                        f.classList.add('required-field');
                        showError(eId,null,'Required.'); // Show only field error
                        // No section warning needed here as errors are per field
                    }
                }
            });
            // Check if all sections are logically complete based on required fields
             const currentUser = getCurrentUser();
             const userAnswers = currentUser ? (JSON.parse(localStorage.getItem(localStorageKey) || '{}')[currentUser.email] || {}) : {};
             pageSections.forEach(secId => {
                  if (!isSectionComplete(secId, userAnswers)) {
                       allValid = false; // If any section is incomplete, overall validation fails
                       // Errors for specific fields already shown above
                  }
             });

            if(!allValid&&showErrors&&firstInvalidField){firstInvalidField.scrollIntoView({behavior:'smooth',block:'center'}); setTimeout(()=>{try{firstInvalidField.focus({preventScroll:true});}catch(e){}},400);}
            else if (!allValid && showErrors) { showGeneralWarningMessage(); } // Show general if specific field focus failed
            console.log("AP Validation result:", allValid);
            return allValid;
        }

        function showGeneralWarningMessage() { /* ... consistent ... */ const w=document.getElementById('generalWarningMessage'); if(!w) return; w.innerHTML='<strong>Action Required:</strong> Please complete all required fields marked with <span class="required-star">*</span> before completing the plan.'; w.style.animation='none'; void w.offsetWidth; w.style.display='block'; w.style.animation='slideDownFadeIn 0.4s ease-out'; clearTimeout(w.timer); w.timer=setTimeout(()=>{w.style.animation='fadeOutUp 0.5s ease-out forwards'; setTimeout(()=>{if(w.style.animationName==='fadeOutUp'){w.style.display='none';w.style.animation='';}},500);},4000);}
        function showSaveStatus(statusId, message = '✓ Saved') { /* ... consistent ... */ const s=document.getElementById(statusId); if(!s) return; s.textContent=message; s.classList.remove('deleted'); s.style.color='#27ae60'; if(message.includes('Cleared')||message.includes('Deleted')){s.classList.add('deleted'); s.style.color='#6c757d';} s.style.display='inline-block'; clearTimeout(s.timer); s.timer=setTimeout(()=>s.style.display='none',3000); }
        function showError(errorId, fieldToMark, message = 'Required.') { /* ... consistent ... */ const e=document.getElementById(errorId); if(!e) return; e.textContent=message; e.style.color='#e74c3c'; e.style.display='block'; if(fieldToMark) fieldToMark.classList.add('required-field');}
        function hideError(errorId) { /* ... consistent ... */ const e=document.getElementById(errorId); if(e){e.style.display='none'; e.textContent='';}}
        function hideMessages(statusId, errorId, field) { // Simplified helper
             hideError(errorId);
             const s = statusId ? document.getElementById(statusId) : null; if(s)s.style.display='none';
             if (field) field.classList.remove('required-field');
         }

        // --- Actions (Save/Delete Single Fields/Cells) ---
        window.saveAnswer = async function(questionId) {
            if (!supabase) { alert('Database connection error. Cannot save.'); return; }
            const currentUser = getCurrentUser(); if (!currentUser?.email || !currentUser.id) { alert('Session expired.'); return; }

            const field = document.querySelector(`[data-question="${questionId}"]`); if (!field) { console.error("Save Error: Field missing for", questionId); return; }

            const errorId = `error-${questionId}`;
            const statusId = `save-status-${questionId}`; // Added statusId definition
            const buttonGroup = field.parentElement?.querySelector('.answer-buttons');
            const saveButton = buttonGroup?.querySelector('.save-button');
            const deleteButton = buttonGroup?.querySelector('.delete-button');

             if (!saveButton || !deleteButton) { console.error("Save Error: Buttons missing for", questionId); return; }
             if (field.disabled) { console.warn("Attempted to save already saved question:", questionId); return; }

            const answer = field.value;
            const trimmedAnswer = answer.trim();
            const isRequired = field.classList.contains('required-answer');

            hideMessages(statusId, errorId, field); // Clear status and error for this field

            if (isRequired && trimmedAnswer === '') {
                showError(errorId, field);
                updateRelevantProgressBar(questionId); // Update progress bar state based on current completion
                return;
            }

            saveButton.disabled = true; saveButton.textContent = 'Saving...'; deleteButton.disabled = true;

            try {
                let questionText = `Answer for ${questionId}`; // Default
                const questionContainer = field.closest('.question-box'); // Container for section info
                const qTextElement = field.closest('li')?.previousElementSibling || field.previousElementSibling; // Try to find H4 or previous P/label
                const tableCell = field.closest('td'); // For table questions
                const tableHeader = tableCell?.closest('table')?.querySelector(`thead th:nth-child(${tableCell.cellIndex + 1})`);

                 if (qTextElement && (qTextElement.tagName === 'H4' || qTextElement.tagName === 'P')) {
                    questionText = qTextElement.textContent.replace('*','').trim();
                 } else if (tableHeader) {
                      // Construct text for table cells, assuming data-label exists for mobile view consistency
                     const labelText = tableCell.dataset.label || tableHeader.textContent.trim(); // Use data-label if available
                     questionText = `${labelText} (Row ${questionId.match(/(\d+)$/)[1]})`;
                 } else if (questionContainer) { // Fallback to section header if possible
                     const sectionH4 = questionContainer.querySelector('h4');
                     if (sectionH4) questionText = sectionH4.textContent.replace('*','').trim() + ` (${questionId})`;
                 }


                const submissionTime = new Date().toISOString();
                const userProgressPayload = {
                    user_id: currentUser.id, email: currentUser.email, question_id: questionId,
                    question_text: questionText, answer: answer, page: PAGE_NAME, status: 'completed',
                    submitted_at: submissionTime, updated_at: submissionTime, section_type: 'action_plan', // Specific type
                    section_id: SECTION_ID, section_title: document.title || 'Coaching Action Plan', // Updated Title
                    progress_percentage: 100, score: null, is_passed: null
                };

                console.log(`[${questionId}] Attempting to upsert to user_progress...`);
                const { data, error } = await supabase.from('user_progress').upsert([userProgressPayload], { onConflict: ['user_id', 'question_id'] }).select();

                 // --- Check Supabase Error ---
                if (error) {
                    console.error(`[${questionId}] Supabase upsert error BEFORE throwing:`, error);
                    throw new Error(`Supabase error: ${error.message}`);
                }
                console.log(`[${questionId}] Supabase upsert successful.`); // Simplified log

                // --- Update UI on SUCCESS ---
                console.log(`[${questionId}] Starting UI updates...`);
                try {
                    field.disabled = true;
                    console.log(`[${questionId}] Field disabled.`);
                    if(saveButton) saveButton.textContent = 'Saved ✔️'; else console.warn(`[${questionId}] Save button not found for UI update`);
                    console.log(`[${questionId}] Save button text updated.`);
                    if(deleteButton) deleteButton.style.display = 'none'; else console.warn(`[${questionId}] Delete button not found for UI update`);
                    console.log(`[${questionId}] Delete button hidden.`);

                    console.log(`[${questionId}] Saving to local storage...`);
                    saveAnswerToStorage(currentUser.email, questionId, answer); // Update local storage

                    console.log(`[${questionId}] Updating progress bars...`);
                     // Update relevant progress bar
                    updateRelevantProgressBar(questionId); // Pass only questionId
                    console.log(`[${questionId}] UI updates complete.`);
                     showSaveStatus(statusId, '✓ Saved'); // Show save status message
                } catch (uiError) {
                     console.error(`[${questionId}] ERROR during UI update AFTER successful save:`, uiError);
                     // Log the error but don't show it to the user as the data *is* saved.
                }

                 // REMOVED Formspree call

            } catch (error) {
                 // --- More Detailed Error Logging in Catch ---
                 console.error(`[${questionId}] CAUGHT ERROR during save process:`, error);
                 showError(errorId, field, `Save failed. Try again.`); // Keep showing UI error

                 // Re-enable buttons and field only if they still exist
                 const currentField = document.querySelector(`[data-question="${questionId}"]`);
                 const currentButtonGroup = currentField?.parentElement?.querySelector('.answer-buttons');
                 const currentSaveButton = currentButtonGroup?.querySelector('.save-button');
                 const currentDeleteButton = currentButtonGroup?.querySelector('.delete-button');

                 if (currentField) currentField.disabled = false;
                 if (currentSaveButton) { currentSaveButton.disabled = false; currentSaveButton.textContent = 'Save'; }
                 if (currentDeleteButton && currentField && !currentField.disabled) { // Only re-enable delete if field is enabled
                     currentDeleteButton.disabled = false;
                     currentDeleteButton.style.display = 'inline-block'; // Ensure it's visible
                 }
            }
        }

        window.deleteAnswer = function(questionId) {
             const currentUser = getCurrentUser(); if (!currentUser?.email) return;
             const field = document.querySelector(`[data-question="${questionId}"]`); if (!field) return;
             const errorId = `error-${questionId}`;
             const statusId = `save-status-${questionId}`; // Added statusId definition

             if (field.disabled) { console.warn("Cannot delete saved answer:", questionId); return; }

             hideMessages(statusId, errorId, field); // Use statusId here
             field.value = (field.type === 'date') ? '' : '';
             deleteAnswerFromStorage(currentUser.email, questionId); console.log("Cleared answer locally for", questionId);
             field.classList.remove('required-field');
             updateRelevantProgressBar(questionId); // Update progress bar state
             showSaveStatus(statusId, '✓ Cleared'); // Show cleared status message
        }

        // ADDED: Function definition for updateRelevantProgressBar
        function updateRelevantProgressBar(questionId) {
             const sectionId = getSectionIdFromQuestionId(questionId);
             if (!sectionId) { console.warn("Could not find section for", questionId); return; }

             const sectionContainer = document.getElementById(`section-container-${sectionId}`);
             const sectionProgressBarContainer = document.getElementById(`progress-container-${sectionId}`);
             const currentUser = getCurrentUser();
             const userAnswers = currentUser ? (JSON.parse(localStorage.getItem(localStorageKey) || '{}')[currentUser.email] || {}) : {};

             if (sectionProgressBarContainer) {
                 if (isSectionComplete(sectionId, userAnswers)) {
                     showQuestionProgressBar(sectionProgressBarContainer); // Show section bar if section is now complete
                 } else {
                     hideQuestionProgressBar(sectionProgressBarContainer); // Hide section bar if section is now incomplete
                 }
             } else {
                 console.warn("Could not find progress container for section", sectionId);
             }
             updateSectionProgress(SECTION_ID); // Always update the overall progress percentage
        }


        // REMOVED Formspree Function

        // --- Progress Functions ---
        function updateSectionProgress(sectionId, forcePercentage = null) { /* ... consistent ... */ const u=getCurrentUser();if(!u)return 0;let a={};try{const d=localStorage.getItem(localStorageKey);if(d)a=JSON.parse(d)||{};}catch(e){}const ua=a[u.email]||{};let p=0;if(forcePercentage!==null&&!isNaN(forcePercentage)){p=Math.max(0,Math.min(100,Math.round(forcePercentage)));console.log(`Forcing ${sectionId} progress to ${p}%`);}else{const tS=pageSections.length;if(tS===0)return 0;let cS=0;pageSections.forEach(sId=>{if(isSectionComplete(sId,ua))cS++;});p=Math.round((cS/tS)*100);}if(!u.progress)u.progress={};u.progress[sectionId]=p;saveCurrentUser(u);console.log(`Section '${sectionId}' progress updated to ${p}%`);return p; }

        function checkTableCompletion(tableType, userAnswers, showErrors = false) { /* ... consistent ... */
            let tableIsValid = false;
            const errorId = `error-${tableType}-table`; // Potential ID for table-level error message
            if(errorId && !showErrors) hideError(errorId); // Hide if just checking silently

            if (tableType === 'swot') {
                 const s1 = userAnswers['strength1']?.trim();
                 const w1 = userAnswers['weakness1']?.trim();
                 tableIsValid = !!(s1 && w1);
                 if(!tableIsValid && showErrors) {
                      const s1Field = document.querySelector('[data-question="strength1"]');
                      const w1Field = document.querySelector('[data-question="weakness1"]');
                      if(s1Field && !s1) showError(`error-strength1`, s1Field); else hideError(`error-strength1`);
                      if(w1Field && !w1) showError(`error-weakness1`, w1Field); else hideError(`error-weakness1`);
                      showError(errorId, null, "First Strength and Weakness required."); // Table level error
                 } else if (tableIsValid) {
                     hideError(errorId); hideError(`error-strength1`); hideError(`error-weakness1`);
                     document.querySelector('[data-question="strength1"]')?.classList.remove('required-field');
                     document.querySelector('[data-question="weakness1"]')?.classList.remove('required-field');
                 }
            } else if (tableType === 'options') {
                 const o1 = userAnswers['option1']?.trim();
                 tableIsValid = !!o1;
                 if(!tableIsValid && showErrors) {
                    const o1Field = document.querySelector('[data-question="option1"]');
                    showError(`error-option1`, o1Field);
                    showError(errorId, null, "First Option required.");
                 } else if (tableIsValid) {
                     hideError(errorId); hideError(`error-option1`);
                     document.querySelector('[data-question="option1"]')?.classList.remove('required-field');
                 }
            } else if (tableType === 'will') {
                const a1 = userAnswers['action1']?.trim();
                const d1 = userAnswers['date1']?.trim();
                const m1 = userAnswers['measure1']?.trim();
                tableIsValid = !!(a1 && d1 && m1);
                 if(!tableIsValid && showErrors) {
                      const a1Field = document.querySelector('[data-question="action1"]');
                      const d1Field = document.querySelector('[data-question="date1"]');
                      const m1Field = document.querySelector('[data-question="measure1"]');
                      if(!a1) showError(`error-action1`, a1Field); else hideError(`error-action1`);
                      if(!d1) showError(`error-date1`, d1Field); else hideError(`error-date1`);
                      if(!m1) showError(`error-measure1`, m1Field); else hideError(`error-measure1`);
                       showError(errorId, null, "First Action, Date, and Measure required.");
                 } else if (tableIsValid) {
                      hideError(errorId); hideError(`error-action1`); hideError(`error-date1`); hideError(`error-measure1`);
                      document.querySelector('[data-question="action1"]')?.classList.remove('required-field');
                      document.querySelector('[data-question="date1"]')?.classList.remove('required-field');
                      document.querySelector('[data-question="measure1"]')?.classList.remove('required-field');
                 }
            }
            return tableIsValid;
        }


        function showQuestionProgressBar(containerElement) { /* ... consistent ... */ if(!containerElement)return; const pC=containerElement.querySelector('.question-progress-container')||containerElement; const b=pC.querySelector('.question-progress-bar'); const t=pC.querySelector('.question-progress-text'); if(pC&&b&&t){bar.style.width=`100%`; text.textContent=`✔️ Completed`; pC.style.display='block';}}
        function hideQuestionProgressBar(containerElement) { /* ... consistent ... */ if(!containerElement)return; const pC=containerElement.querySelector('.question-progress-container')||containerElement; if(pC) pC.style.display='none'; }

        // --- Completion Handling ---
        function markPlanAsComplete(userEmail) { /* ... consistent ... */ if (!userEmail) return; const k=`${localStorageKey}_completed_${userEmail}`; console.log('AP: Marking complete with key:',k); try{localStorage.setItem(k,'true'); updateSectionProgress(SECTION_ID,100); displayCompletionState(); const cM=document.getElementById('completionMessage'); if(cM)cM.scrollIntoView({behavior:'smooth'});}catch(e){console.error("AP: Error saving completion:",e);alert("Could not save completion status.");}}
        function checkCompletionState(userEmail) {
             if (!userEmail) return;
             const completionKey = `${localStorageKey}_completed_${userEmail}`;
             const isComplete = localStorage.getItem(completionKey) === 'true';
             const allAnswers = JSON.parse(localStorage.getItem(localStorageKey) || '{}'); // Get current answers

             if (isComplete) {
                 console.log("AP: Plan is complete for", userEmail);
                 displayCompletionState();
             } else {
                 console.log("AP: Plan not complete for", userEmail);
                 const cM=document.getElementById('completionMessage'); const cB=document.getElementById('completeButton'); if(cM)cM.style.display='none'; if(cB)cB.style.display='block';
                 // Re-enable ONLY if not saved in local storage
                 document.querySelectorAll('.editable-answer').forEach(el=>{
                     const qId = el.dataset.question;
                     // Check if data exists for this question for THIS user
                      const answerExists = allAnswers[userEmail]?.[qId] !== undefined && allAnswers[userEmail]?.[qId] !== null && allAnswers[userEmail]?.[qId].trim() !== '';
                     if (!answerExists) { // Only enable if no saved answer
                         el.disabled=false;
                         el.style.backgroundColor=''; el.style.cursor='';
                         const btnGroup = el.parentElement?.querySelector('.answer-buttons');
                         if(btnGroup) {
                             btnGroup.querySelector('.save-button')?.removeAttribute('disabled');
                             const delBtn = btnGroup.querySelector('.delete-button');
                             if(delBtn) {
                                 delBtn.removeAttribute('disabled');
                                 delBtn.style.display = 'inline-block';
                             }
                         }
                     } else {
                          // If answer exists, ensure it's still disabled (loadUserAnswers should handle this, but double check)
                         el.disabled = true;
                         el.style.backgroundColor='#e9ecef'; el.style.cursor='not-allowed';
                         const btnGroup = el.parentElement?.querySelector('.answer-buttons');
                           if(btnGroup) {
                             btnGroup.querySelector('.save-button')?.setAttribute('disabled', true);
                              btnGroup.querySelector('.save-button').textContent = 'Saved ✔️';
                             const delBtn = btnGroup.querySelector('.delete-button');
                             if(delBtn) {
                                 delBtn.setAttribute('disabled', true);
                                 delBtn.style.display = 'none';
                             }
                         }
                     }
                 });
                 if(cB) cB.disabled=false; // Always enable complete button if not marked complete
                 const bB=document.getElementById('backButton'); if(bB){bB.textContent='← Back to Self Coaching'; bB.href='coaching-yourself.html';}
             }
        }

        function displayCompletionState() { /* ... consistent ... */ console.log('AP: Displaying completion state UI'); const cM=document.getElementById('completionMessage'); const cB=document.getElementById('completeButton'); const bB=document.getElementById('backButton'); if(cM)cM.style.display='block'; if(cB)cB.style.display='none'; const cont=document.querySelector('.container'); if(cont){cont.querySelectorAll('textarea, input, select, .save-button, .delete-button').forEach(el=>{el.disabled=true; if(el.tagName!=='BUTTON'){el.style.backgroundColor='#e9ecef'; el.style.cursor='not-allowed';}else{el.style.cursor='not-allowed';}}); } if(bB){bB.textContent='← Back to Home'; bB.href='index.html';} pageSections.forEach(sId=>{const sC=document.getElementById(`section-container-${sId}`); if(sC)showQuestionProgressBar(sC);}); updateSectionProgress(SECTION_ID,100);}

    </script>

</body>
</html>
