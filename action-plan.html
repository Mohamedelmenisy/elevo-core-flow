<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coaching Action Plan | Leadership Coaching</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <style>
        /* --- Global Styles (Consistent) --- */
        * {
            margin: 0; padding: 0; box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        html { scroll-behavior: smooth; }
        body {
            margin: 0; padding: 0; line-height: 1.7; /* Adjusted */
            background-color: #f9f9f9; color: #333;
        }

        /* --- User Bar Styles (Consistent) --- */
        .user-bar {
            background-color: #34495e; padding: 10px 20px; display: flex;
            justify-content: space-between; align-items: center; color: white;
            font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-info svg { opacity: 0.8; }
        .user-details { display: flex; flex-direction: column; }
        .user-name { font-weight: 600; font-size: 14px; }
        .user-email { font-size: 12px; opacity: 0.8; }
        .logout-button {
            background-color: #e74c3c; color: white; border: none; padding: 8px 15px;
            border-radius: 6px; cursor: pointer; font-weight: 500;
            transition: all 0.3s ease; display: flex; align-items: center;
            gap: 6px; font-size: 13px;
        }
        .logout-button:hover { background-color: #c0392b; transform: translateY(-1px); }
        .logout-button:active { transform: translateY(0); }

        /* --- Navigation Tabs (Consistent) --- */
        .nav-tab {
            background-color: #2c3e50; padding: 12px 10px; text-align: center;
            position: sticky; top: 0; z-index: 100; overflow-x: auto;
            white-space: nowrap; -webkit-overflow-scrolling: touch;
            scrollbar-width: thin; scrollbar-color: #556a80 #2c3e50;
        }
        .nav-tab::-webkit-scrollbar { height: 6px; }
        .nav-tab::-webkit-scrollbar-track { background: #2c3e50; }
        .nav-tab::-webkit-scrollbar-thumb { background-color: #556a80; border-radius: 10px; border: 1px solid #2c3e50; }
        .nav-tab a {
            color: white; text-decoration: none; margin: 0 8px; padding: 8px 12px;
            border-radius: 6px; transition: background-color 0.3s, color 0.3s;
            font-size: 14px; display: inline-block;
        }
        .nav-tab a:hover, .nav-tab a.active { background-color: #34495e; color: #fff; }

        /* --- Main Content Styles (Consistent) --- */
        h1 {
            color: #fff; background-color: #e67e22; padding: 20px;
            border-radius: 8px; text-align: center; margin: 25px auto;
            max-width: 800px; font-size: 26px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
         h2 { /* Section Titles */
            color: white; background-color: #34495e; /* Darker Blue/Grey */
            padding: 12px 15px; border-radius: 6px; text-align: left; /* Align Left */
            margin: 30px 0 20px; font-size: 1.4em; /* Slightly Smaller */
        }
        h3 { /* Sub-headings if needed */
            color: #e67e22; margin: 20px 0 15px; text-align: left; /* Align Left */
            font-size: 1.2em;
        }
        .container {
            max-width: 800px; margin: 20px auto 30px; background: white;
            padding: 30px; box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 8px;
        }
        .highlight-section { /* Orange Highlight */
            background-color: rgba(230, 126, 34, 0.07); padding: 20px;
            border-left: 5px solid #e67e22; border-radius: 6px; margin: 25px 0;
        }
        .image-container { text-align: center; margin: 30px 0; }
        .image-container img {
            max-width: 100%; height: auto; border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .caption { color: #555; margin-top: 10px; font-size: 14px; }

        /* Question Box Style (Consistent) */
        .question-box {
            background-color: rgba(52, 152, 219, 0.08); /* Light Blue BG */
            padding: 25px; border-radius: 6px; margin: 25px 0;
            border: 1px solid rgba(52, 152, 219, 0.2); /* Subtle Blue Border */
            border-left: 5px solid #3498db; /* Blue Accent */
        }
        .question-box h4 { /* Question Text */
             margin-top: 0; margin-bottom: 10px; color: #34495e;
             font-weight: 600; font-size: 1.1em;
        }
         .question-box h4 .required-star { color: #e74c3c; font-weight: bold; margin-left: 3px; }

        /* Unified class for all answer fields (Consistent) */
        textarea, input[type="text"], input[type="date"] {
            width: 100%; padding: 12px; border: 1px solid #ddd;
            border-radius: 4px; margin-top: 8px; margin-bottom: 10px;
            background-color: white; min-height: 45px; line-height: 1.6;
            display: block; color: #333; font-size: 15px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        textarea { min-height: 80px; resize: vertical; }
        textarea:focus, input[type="text"]:focus, input[type="date"]:focus {
            outline: none; border-color: #e67e22; /* Orange focus */
            box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.2);
        }
        textarea::placeholder, input::placeholder { color: #aaa; opacity: 1; }

        ol { list-style: decimal; margin-left: 25px; margin-bottom: 15px; }
        ul { list-style: disc; margin-left: 25px; margin-bottom: 15px; }
        li { margin-bottom: 10px; }
        /* Textareas within lists */
        ol textarea, ul textarea { min-height: 50px; margin-top: 5px; }


        /* Save/Delete Buttons (Consistent) */
        .save-button, .delete-button {
            color: white; border: none; padding: 8px 15px; border-radius: 4px;
            cursor: pointer; transition: all 0.3s ease; font-size: 14px; font-weight: 500;
        }
        .save-button { background-color: #27ae60; } /* Green */
        .delete-button { background-color: #e74c3c; margin-left: 8px; } /* Red */
        .save-button:hover { background-color: #2ecc71; transform: translateY(-1px); }
        .delete-button:hover { background-color: #c0392b; transform: translateY(-1px); }
        .save-button:active, .delete-button:active { transform: translateY(0); }
         /* Disabled State */
         .save-button:disabled, .delete-button:disabled {
             background-color: #bdc3c7; cursor: not-allowed; transform: none; box-shadow: none;
         }


        .button-group { /* Container for section buttons */
            display: flex; align-items: center; margin-top: 20px; flex-wrap: wrap; gap: 10px;
        }

        .save-status { /* Section save status */
            font-size: 13px; color: #27ae60; margin-left: 10px; display: none; font-weight: 500;
        }
         .save-status.deleted { color: #6c757d; }

        .section-warning { /* Section validation error */
            background-color: #f8d7da; /* Light red */
            border-left: 4px solid #e74c3c; /* Red border */
            padding: 12px 15px; margin: 15px 0 15px 0;
            color: #721c24; /* Dark red text */ display: none;
            border-radius: 4px; font-size: 14px; font-weight: 500;
        }

        .required-field { /* Consistent */
            border: 2px solid #e74c3c !important; background-color: #fff2f1 !important;
            box-shadow: none !important;
        }

        /* Navigation Buttons (Bottom) (Consistent) */
        .navigation-buttons {
            display: flex; justify-content: space-between; margin-top: 40px;
            gap: 20px; border-top: 1px solid #eee; padding-top: 25px;
        }
        .navigation-buttons a, .navigation-buttons button {
            text-decoration: none; padding: 12px 20px; color: white; border-radius: 4px;
            font-weight: 600; flex: 1; text-align: center; transition: all 0.3s ease;
            font-size: 15px; border: none; cursor: pointer;
        }
        .navigation-buttons .back { background-color: #6c757d; } /* Grey back */
        .navigation-buttons #completeButton { background-color: #e67e22; } /* Orange complete */
        .navigation-buttons a:hover, .navigation-buttons button:hover:not(:disabled) { transform: translateY(-1px); filter: brightness(110%); }
        .navigation-buttons a:active, .navigation-buttons button:active:not(:disabled) { transform: translateY(0); filter: brightness(100%); }
        /* Disabled Complete Button */
         .navigation-buttons #completeButton:disabled {
             background-color: #bdc3c7; cursor: not-allowed; transform: none; box-shadow: none; filter: none;
         }


        /* Floating Warning (General Page Validation) (Consistent) */
        .floating-warning {
            background-color: #fff8e1; border-left: 4px solid #ffc107; padding: 15px 25px;
            color: #333; display: none; position: fixed; top: 75px; left: 50%;
            transform: translateX(-50%); z-index: 1001; border-radius: 6px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2); animation: slideDownFadeIn 0.4s ease-out;
            font-weight: 500; max-width: 90%; width: auto; min-width: 300px; text-align: center;
        }
        @keyframes slideDownFadeIn { from { opacity: 0; top: 50px; } to { opacity: 1; top: 75px; } }
        @keyframes fadeOutUp { from { opacity: 1; top: 75px;} to { opacity: 0; top: 50px;} }


        .completion-message { /* Consistent Green Highlight */
            background-color: rgba(39, 174, 96, 0.1); padding: 25px;
            border-left: 5px solid #27ae60; border-radius: 8px;
            margin: 30px 0; text-align: center; display: none;
            border: 1px solid rgba(39, 174, 96, 0.2);
        }
        .completion-message h3 { color: #27ae60; margin-bottom: 15px; font-size: 1.3em;}
         .completion-message p { color: #333; margin-bottom: 10px; }


        /* Inline error for required fields (Consistent) */
         .inline-error-message {
             color: #e74c3c; font-size: 13px; margin-left: 5px;
             display: none; font-weight: 500;
        }

         /* Required Star Helper */
         .required-star { color: #e74c3c; font-weight: bold; margin-left: 2px; }

         /* Responsive Adjustments */
         @media (max-width: 768px) {
             h1 { font-size: 22px; padding: 15px; margin: 20px 15px; }
             h2 { font-size: 1.2em; padding: 10px 15px; }
             .container { padding: 20px; margin: 0 15px 20px; }
             .user-bar { padding: 10px 15px; font-size: 13px; }
             .user-name { font-size: 13px; }
             .user-email { font-size: 11px; }
             .logout-button { padding: 7px 12px; font-size: 12px; }
             .nav-tab { padding: 10px 5px; }
             .nav-tab a { margin: 0 5px; padding: 7px 10px; font-size: 13px;}
              .highlight-section, .question-box { padding: 15px; margin: 20px 0; }
             /* .editable-answer { font-size: 14px; padding: 10px; } */ /* Removed this line as the base style is good */
             textarea { min-height: 80px; }
             ol textarea { min-height: 50px; }
             .save-button, .delete-button { padding: 7px 13px; font-size: 13px; }
             .button-group { /* Adjust button group layout on small screens */
                 /* No change needed currently, 'wrap' handles it */
             }
             .navigation-buttons { flex-direction: column; } /* Stack buttons vertically */
             .navigation-buttons a, .navigation-buttons button { font-size: 14px; padding: 12px 15px;}
             .floating-warning { padding: 12px 20px; font-size: 14px; top: 65px; width: calc(100% - 30px); max-width: 400px; }
             @keyframes slideDownFadeIn { from { opacity: 0; top: 45px; } to { opacity: 1; top: 65px; } }
             @keyframes fadeOutUp { from { opacity: 1; top: 65px;} to { opacity: 0; top: 45px;} }
             .completion-message { padding: 20px; }
             .completion-message h3 { font-size: 1.2em; }
        }

    </style>
</head>
<body>
    <!-- User Info Bar -->
    <div class="user-bar">
        <div class="user-info">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.8;"> <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path> <circle cx="12" cy="7" r="4"></circle> </svg>
            <div class="user-details">
                <span class="user-name" id="userName">Welcome back</span> <!-- Default Text -->
                <span class="user-email" id="userEmail">user@example.com</span> <!-- Default Text -->
            </div>
        </div>
        <button class="logout-button" onclick="logout()"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path> <polyline points="16 17 21 12 16 7"></polyline> <line x1="21" y1="12" x2="9" y2="12"></line> </svg> Logout </button>
    </div>

    <!-- Navigation Tabs -->
    <nav class="nav-tab">
        <a href="index.html">Home</a>
        <a href="article1.html">Article 1</a>
        <a href="coaching-skills.html">Coaching Skills</a>
        <a href="coaching-individuals.html">Coaching Individuals</a>
        <a href="coaching-team.html">Team Coaching</a>
        <a href="coaching-yourself.html">Self Coaching</a>
        <a href="action-plan.html" class="active">Action Plan</a> <!-- Active Tab -->
    </nav>

    <!-- Page Title -->
    <h1>Your Coaching Action Plan</h1>

     <!-- Floating Warning Message -->
    <div class="floating-warning" id="generalWarningMessage">
        <!-- Content set by JS -->
    </div>

    <div class="container">
        <div class="highlight-section"> <!-- Orange Highlight -->
            <p>You've covered a lot of ground in this toolkit – well done! Now it's time to consolidate your learning and create a practical plan to implement these coaching skills.</p>
            <p>Coaching effectively requires commitment. This plan helps you define your motivations, allocate time, develop specific skills, choose appropriate models, and plan for both formal and informal coaching opportunities.</p>
        </div>

        <div class="image-container">
            <img src="https://images.unsplash.com/photo-1573164713988-8665fc963095?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80"
                 alt="Team creating action plan on whiteboard"
                 onerror="this.onerror=null; this.src='https://via.placeholder.com/800x450/ffa726/ffffff?text=Team+Planning';"
                 loading="lazy">
            <p class="caption">Translate your learning into a concrete coaching action plan</p>
        </div>

        <!-- Section 5.1 -->
        <h2>5.1 Your Coaching Motivation</h2>
        <p>Clarify your personal drive and the expected benefits of adopting a coaching approach.</p>
        <div class="question-box" data-section="motivation"> <!-- Blue Bordered Box -->
            <h4>Coaching excites me because<span class="required-star">*</span></h4>
            <textarea placeholder="What aspects of helping others grow and develop energize you?" class="editable-answer required-answer" data-question="excitement"></textarea>
            <span class="inline-error-message" id="error-excitement"></span>

            <h4>Through coaching, I could personally gain<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., better delegation skills, stronger relationships, improved team performance..." class="editable-answer required-answer" data-question="personal-gain"></textarea>
            <span class="inline-error-message" id="error-personal-gain"></span>

            <h4>It's worthwhile investing time and energy in coaching my team, because<span class="required-star">*</span></h4>
            <textarea placeholder="Connect coaching to specific team or organizational benefits." class="editable-answer required-answer" data-question="team-benefits"></textarea>
             <span class="inline-error-message" id="error-team-benefits"></span>

            <div class="button-group">
                <button class="save-button" onclick="saveSection(['excitement', 'personal-gain', 'team-benefits'], 'motivation')">Save Motivation</button>
                <button class="delete-button" onclick="deleteSection(['excitement', 'personal-gain', 'team-benefits'], 'motivation')">Clear Motivation</button>
                <span class="save-status" id="save-status-motivation"></span>
            </div>
             <div class="section-warning" id="warning-motivation"> Please complete all questions in this section. </div>
        </div>

        <!-- Section 5.2 -->
        <div class="image-container">
            <img src="https://images.unsplash.com/photo-1521791055366-0d553872125f?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80"
                 alt="Manager planning their schedule for coaching time"
                 onerror="this.onerror=null; this.src='https://via.placeholder.com/800x450/3498db/ffffff?text=Time+Management';"
                 loading="lazy">
            <p class="caption">Making dedicated time is essential for effective coaching</p>
        </div>
        <h2>5.2 Making Time for Coaching</h2>
        <p>Coaching requires dedicated time. Honestly assess how you can integrate it into your schedule.</p>
        <div class="question-box" data-section="time"> <!-- Blue Bordered Box -->
            <h4>To make time for coaching, the habit/process I need to stop or change first is<span class="required-star">*</span></h4>
            <textarea placeholder="Identify one specific time-consuming activity you can adjust." class="editable-answer required-answer" data-question="habits-to-change"></textarea>
             <span class="inline-error-message" id="error-habits-to-change"></span>

            <h4>Potential blockers to making this change are<span class="required-star">*</span></h4>
            <textarea placeholder="Anticipate obstacles (e.g., urgent tasks, existing commitments)." class="editable-answer required-answer" data-question="blockers"></textarea>
             <span class="inline-error-message" id="error-blockers"></span>

            <h4>My first step to tackling these blockers is<span class="required-star">*</span></h4>
            <textarea placeholder="Define a concrete, actionable first step." class="editable-answer required-answer" data-question="first-step"></textarea>
             <span class="inline-error-message" id="error-first-step"></span>

            <h4>To make and sustain these changes, I need the support of<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., My manager, my team, specific colleagues..." class="editable-answer required-answer" data-question="support-needed"></textarea>
             <span class="inline-error-message" id="error-support-needed"></span>

            <h4>I will discuss this with them by (date/method)<span class="required-star">*</span></h4>
            <textarea placeholder="Plan how and when you'll have this conversation." class="editable-answer required-answer" data-question="discussion-plan"></textarea>
             <span class="inline-error-message" id="error-discussion-plan"></span>

            <h4>A Time Management resource that might help me is<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., Eisenhower Matrix, Time Blocking article, specific app..." class="editable-answer required-answer" data-question="resources"></textarea>
             <span class="inline-error-message" id="error-resources"></span>

            <div class="button-group">
                <button class="save-button" onclick="saveSection(['habits-to-change', 'blockers', 'first-step', 'support-needed', 'discussion-plan', 'resources'], 'time')">Save Time Plan</button>
                <button class="delete-button" onclick="deleteSection(['habits-to-change', 'blockers', 'first-step', 'support-needed', 'discussion-plan', 'resources'], 'time')">Clear Time Plan</button>
                <span class="save-status" id="save-status-time"></span>
            </div>
             <div class="section-warning" id="warning-time"> Please complete all questions in this section. </div>
        </div>

        <!-- Section 5.3 -->
        <h2>5.3 Developing Your Coaching Skills</h2>
        <p>Reflect on the core coaching skills from Chapter 1 and plan your development.</p>
        <div class="question-box" data-section="skills"> <!-- Blue Bordered Box -->
            <h4>My strongest listening skill currently is<span class="required-star">*</span></h4>
            <textarea placeholder="Identify your best listening trait (e.g., patience, summarizing)." class="editable-answer required-answer" data-question="listening-strength"></textarea>
             <span class="inline-error-message" id="error-listening-strength"></span>

            <h4>I'll develop my listening further by applying these two techniques:<span class="required-star">*</span></h4>
            <ol>
                <li><textarea placeholder="First technique (e.g., paraphrase more, notice body language)." class="editable-answer required-answer" data-question="listening-tip1"></textarea> <span class="inline-error-message" id="error-listening-tip1"></span></li>
                <li><textarea placeholder="Second technique (e.g., ask clarifying questions, minimize distractions)." class="editable-answer required-answer" data-question="listening-tip2"></textarea> <span class="inline-error-message" id="error-listening-tip2"></span></li>
            </ol>

            <h4>When I notice myself making an assumption, I will<span class="required-star">*</span></h4>
            <textarea placeholder="Define your strategy (e.g., ask 'What makes you say that?', state the assumption)." class="editable-answer required-answer" data-question="assumption-plan"></textarea>
            <span class="inline-error-message" id="error-assumption-plan"></span>

            <h4>Two new non-leading questions I will practice asking are:<span class="required-star">*</span></h4>
            <ol>
                <li><textarea placeholder="e.g., 'What options have you considered?', 'How does that align with X?'" class="editable-answer required-answer" data-question="question1"></textarea> <span class="inline-error-message" id="error-question1"></span></li>
                <li><textarea placeholder="e.g., 'What would success look like?', 'What support do you need?'" class="editable-answer required-answer" data-question="question2"></textarea> <span class="inline-error-message" id="error-question2"></span></li>
            </ol>

            <h4>The coachee emotions I find most challenging are... and when they arise, I feel...<span class="required-star">*</span></h4>
            <textarea placeholder="Identify 1-2 challenging emotions (e.g., frustration, apathy) and your reaction." class="editable-answer required-answer" data-question="emotion-challenge"></textarea>
             <span class="inline-error-message" id="error-emotion-challenge"></span>

            <h4>My own preoccupations/mood (e.g., feeling stressed, thinking about deadlines) can sometimes hinder open conversation.<span class="required-star">*</span></h4>
            <textarea placeholder="Acknowledge your internal distractions." class="editable-answer required-answer" data-question="own-mood"></textarea>
            <span class="inline-error-message" id="error-own-mood"></span>

            <h4>I'll manage these emotional challenges (mine and theirs) better by<span class="required-star">*</span></h4>
            <textarea placeholder="Outline strategies (e.g., deep breaths, acknowledge feelings, refocus)." class="editable-answer required-answer" data-question="improvement-plan"></textarea>
             <span class="inline-error-message" id="error-improvement-plan"></span>

            <h4>I can build trust more effectively by<span class="required-star">*</span></h4>
            <textarea placeholder="List 1-2 specific trust-building actions (e.g., maintain confidentiality, follow through)." class="editable-answer required-answer" data-question="trust-building"></textarea>
             <span class="inline-error-message" id="error-trust-building"></span>

            <h4>My key professional strengths are... and I can apply these to coaching by<span class="required-star">*</span></h4>
            <textarea placeholder="Connect your existing strengths to coaching behaviors." class="editable-answer required-answer" data-question="strengths-application"></textarea>
             <span class="inline-error-message" id="error-strengths-application"></span>

            <div class="button-group">
                <button class="save-button" onclick="saveSection(['listening-strength', 'listening-tip1', 'listening-tip2', 'assumption-plan', 'question1', 'question2', 'emotion-challenge', 'own-mood', 'improvement-plan', 'trust-building', 'strengths-application'], 'skills')">Save Skills Plan</button>
                <button class="delete-button" onclick="deleteSection(['listening-strength', 'listening-tip1', 'listening-tip2', 'assumption-plan', 'question1', 'question2', 'emotion-challenge', 'own-mood', 'improvement-plan', 'trust-building', 'strengths-application'], 'skills')">Clear Skills Plan</button>
                <span class="save-status" id="save-status-skills"></span>
            </div>
             <div class="section-warning" id="warning-skills"> Please complete all questions in this section. </div>
        </div>

        <!-- Section 5.4 -->
        <h2>5.4 Implementing Coaching Models</h2>
        <p>Plan how you will use the coaching models from Chapter 2 (GROW, Skill/Will, Solution-Focused) in your one-on-one sessions.</p>
        <div class="question-box" data-section="model"> <!-- Blue Bordered Box -->
            <h4>The first model I plan to use is... with...<span class="required-star">*</span></h4>
            <textarea placeholder="Choose a model (GROW, Skill/Will, Solution-Focused) and a specific person/situation." class="editable-answer required-answer" data-question="model-choice"></textarea>
            <span class="inline-error-message" id="error-model-choice"></span>

            <h4>Because...<span class="required-star">*</span></h4>
            <textarea placeholder="Explain why this model fits this coachee or situation." class="editable-answer required-answer" data-question="model-reason"></textarea>
             <span class="inline-error-message" id="error-model-reason"></span>

            <h4>I'll need to prepare for this session by<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., Reviewing the model steps, drafting opening questions, clearing my schedule." class="editable-answer required-answer" data-question="preparation"></textarea>
             <span class="inline-error-message" id="error-preparation"></span>

            <div class="image-container">
                <img src="https://images.unsplash.com/photo-1552664730-d307ca884978?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80"
                     alt="Manager evaluating different coaching approaches"
                     onerror="this.onerror=null; this.src='https://via.placeholder.com/800x450/9b59b6/ffffff?text=Coaching+Models';"
                     loading="lazy">
                <p class="caption">Choosing the right coaching model for each situation</p>
            </div>

            <h4>I can show my coachee I have their best interests in mind by<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., Focusing fully on them, celebrating small wins, linking goals to their aspirations." class="editable-answer required-answer" data-question="best-interests"></textarea>
             <span class="inline-error-message" id="error-best-interests"></span>

            <h4>I will demonstrate coaching integrity and humility by<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., Admitting I don't have all answers, respecting their views, maintaining confidentiality." class="editable-answer required-answer" data-question="integrity"></textarea>
             <span class="inline-error-message" id="error-integrity"></span>

            <h4>Two tips from successful coaches I'd feel comfortable applying are:<span class="required-star">*</span></h4>
            <ol>
                <li><textarea placeholder="e.g., Start session by asking 'What's on your mind?', Use silence effectively." class="editable-answer required-answer" data-question="tip1"></textarea> <span class="inline-error-message" id="error-tip1"></span></li>
                <li><textarea placeholder="e.g., End session by asking 'What was most useful?', Follow up on actions." class="editable-answer required-answer" data-question="tip2"></textarea> <span class="inline-error-message" id="error-tip2"></span></li>
            </ol>

            <div class="button-group">
                <button class="save-button" onclick="saveSection(['model-choice', 'model-reason', 'preparation', 'best-interests', 'integrity', 'tip1', 'tip2'], 'model')">Save Models Plan</button>
                <button class="delete-button" onclick="deleteSection(['model-choice', 'model-reason', 'preparation', 'best-interests', 'integrity', 'tip1', 'tip2'], 'model')">Clear Models Plan</button>
                <span class="save-status" id="save-status-model"></span>
            </div>
             <div class="section-warning" id="warning-model"> Please complete all questions in this section. </div>
        </div>

        <!-- Section 5.5 -->
        <h2>5.5 Informal and Team Coaching</h2>
        <p>Plan how you will integrate informal coaching and apply team coaching principles from Chapter 3.</p>
        <div class="question-box" data-section="team"> <!-- Blue Bordered Box -->
            <h4>I'll avoid being isolated from the team's daily work by<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., Regular check-ins, being present, participating in informal chats." class="editable-answer required-answer" data-question="shop-floor"></textarea>
             <span class="inline-error-message" id="error-shop-floor"></span>

            <div class="image-container">
                <img src="https://images.unsplash.com/photo-1521791136064-7986c2920216?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80"
                     alt="Manager having informal discussion with team members"
                     onerror="this.onerror=null; this.src='https://via.placeholder.com/800x450/3498db/ffffff?text=Informal+Coaching';"
                     loading="lazy">
                <p class="caption">Staying connected enables effective informal coaching</p>
            </div>

            <h4>I can improve my judgment about when to intervene informally by<span class="required-star">*</span></h4>
            <textarea placeholder="e.g., Paying closer attention to cues, asking clarifying questions first." class="editable-answer required-answer" data-question="intervention"></textarea>
            <span class="inline-error-message" id="error-intervention"></span>

            <h4>I plan to use team coaching with this team/group<span class="required-star">*</span></h4>
            <textarea placeholder="Identify the specific team or group." class="editable-answer required-answer" data-question="team-group"></textarea>
             <span class="inline-error-message" id="error-team-group"></span>

            <h4>...to help them work on this topic or issue<span class="required-star">*</span></h4>
            <textarea placeholder="Define the specific focus for team coaching (e.g., conflict resolution, goal alignment)." class="editable-answer required-answer" data-question="team-issue"></textarea>
            <span class="inline-error-message" id="error-team-issue"></span>

            <h4>I'll prepare for team coaching by exploring personality/working styles using<span class="required-star">*</span></h4>
            <textarea placeholder="Name a model/tool (e.g., DiSC, Belbin - even informally) or describe your approach." class="editable-answer required-answer" data-question="personality-test"></textarea>
            <span class="inline-error-message" id="error-personality-test"></span>

            <h4>...and by facilitating appreciation of diverse strengths/preferences through<span class="required-star">*</span></h4>
            <textarea placeholder="Describe the activity or discussion you will lead." class="editable-answer required-answer" data-question="strengths-appreciation"></textarea>
            <span class="inline-error-message" id="error-strengths-appreciation"></span>

            <h4>Together, we'll develop a team charter following these steps<span class="required-star">*</span></h4>
            <textarea placeholder="Outline your collaborative process (e.g., brainstorm session, draft, review)." class="editable-answer required-answer" data-question="charter-steps"></textarea>
             <span class="inline-error-message" id="error-charter-steps"></span>

            <h4>I will address potential conflicting priorities by discussing them with<span class="required-star">*</span></h4>
            <textarea placeholder="Identify who needs to be involved (e.g., team, specific individuals, other managers)." class="editable-answer required-answer" data-question="conflict-resolution"></textarea>
             <span class="inline-error-message" id="error-conflict-resolution"></span>

            <h4>I plan to try the POSITIVE model at this upcoming meeting/situation<span class="required-star">*</span></h4>
            <textarea placeholder="Identify a specific opportunity to use the POSITIVE model." class="editable-answer required-answer" data-question="positive-model"></textarea>
             <span class="inline-error-message" id="error-positive-model"></span>

            <h4>...and the PRACTICE model in this session/situation<span class="required-star">*</span></h4>
            <textarea placeholder="Identify a specific opportunity to use the PRACTICE model." class="editable-answer required-answer" data-question="practice-model"></textarea>
             <span class="inline-error-message" id="error-practice-model"></span>

            <div class="button-group">
                <button class="save-button" onclick="saveSection(['shop-floor', 'intervention', 'team-group', 'team-issue', 'personality-test', 'strengths-appreciation', 'charter-steps', 'conflict-resolution', 'positive-model', 'practice-model'], 'team')">Save Team Plan</button>
                <button class="delete-button" onclick="deleteSection(['shop-floor', 'intervention', 'team-group', 'team-issue', 'personality-test', 'strengths-appreciation', 'charter-steps', 'conflict-resolution', 'positive-model', 'practice-model'], 'team')">Clear Team Plan</button>
                <span class="save-status" id="save-status-team"></span>
            </div>
             <div class="section-warning" id="warning-team"> Please complete all questions in this section. </div>
        </div>

        <!-- Section 5.6 -->
        <h2>5.6 Self-Reflection and Review</h2>
        <p>Continuously apply coaching principles to your own development and reflect on your progress as a coach.</p>
        <div class="question-box" data-section="reflection"> <!-- Blue Bordered Box -->
            <h4>My personal SWOT analysis highlighted<span class="required-star">*</span></h4>
            <textarea placeholder="Summarize your key strengths and weaknesses identified earlier." class="editable-answer required-answer" data-question="swot-highlights"></textarea>
            <span class="inline-error-message" id="error-swot-highlights"></span>

            <h4>As a result, a key action I will take is<span class="required-star">*</span></h4>
            <textarea placeholder="Define one specific action based on your SWOT (leverage strength or address weakness)." class="editable-answer required-answer" data-question="swot-actions"></textarea>
            <span class="inline-error-message" id="error-swot-actions"></span>

            <h4>The personal goal I'm working on using the GROW model is<span class="required-star">*</span></h4>
            <textarea placeholder="Restate your SMART goal from the GROW exercise." class="editable-answer required-answer" data-question="grow-goal"></textarea>
             <span class="inline-error-message" id="error-grow-goal"></span>

            <h4>My first action step towards this goal is<span class="required-star">*</span></h4>
            <textarea placeholder="Restate your first action step from the GROW 'Will' section." class="editable-answer required-answer" data-question="first-grow-action"></textarea>
            <span class="inline-error-message" id="error-first-grow-action"></span>

            <h4>I've scheduled my first self-review for this toolkit on<span class="required-star">*</span></h4>
            <input type="date" class="editable-answer required-answer" data-question="review-date">
            <span class="inline-error-message" id="error-review-date"></span>

            <h4>Since starting this toolkit, changes I've observed in myself/my work include<span class="required-star">*</span></h4>
            <textarea placeholder="Reflect on any shifts in your perspective or behavior so far." class="editable-answer required-answer" data-question="self-changes"></textarea>
             <span class="inline-error-message" id="error-self-changes"></span>

            <h4>Changes I've observed in my team's behavior/performance include<span class="required-star">*</span></h4>
            <textarea placeholder="Reflect on any impacts on your team, even small ones." class="editable-answer required-answer" data-question="team-changes"></textarea>
             <span class="inline-error-message" id="error-team-changes"></span>

            <div class="image-container">
                <img src="https://images.unsplash.com/photo-1542744173-8e7e53415bb0?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80"
                     alt="Team reviewing progress and celebrating success"
                     onerror="this.onerror=null; this.src='https://via.placeholder.com/800x450/2ecc71/ffffff?text=Team+Review';"
                     loading="lazy">
                <p class="caption">Regular review helps sustain coaching benefits</p>
            </div>

            <div class="button-group">
                <button class="save-button" onclick="saveSection(['swot-highlights', 'swot-actions', 'grow-goal', 'first-grow-action', 'review-date', 'self-changes', 'team-changes'], 'reflection')">Save Reflection</button>
                <button class="delete-button" onclick="deleteSection(['swot-highlights', 'swot-actions', 'grow-goal', 'first-grow-action', 'review-date', 'self-changes', 'team-changes'], 'reflection')">Clear Reflection</button>
                <span class="save-status" id="save-status-reflection"></span>
            </div>
            <div class="section-warning" id="warning-reflection"> Please complete all questions in this section. </div>
        </div>

        <!-- Completion Message -->
        <div class="completion-message" id="completionMessage">
            <h3>Congratulations on Completing Your Coaching Action Plan!</h3>
            <p>Thank you for taking the time to thoughtfully complete this action plan. You've taken important steps toward becoming a more effective coach for your team and yourself.</p>
            <p>Remember to review your plan regularly (starting on the date you set above!) and adjust as needed. Consistent application of these strategies will help you see the best results.</p>
             <p>Good luck with your coaching journey!</p>
        </div>

        <!-- Navigation Buttons -->
        <div class="navigation-buttons">
            <a href="coaching-yourself.html" class="button back" id="backButton">← Back to Self Coaching</a>
            <button type="button" class="button" id="completeButton">Mark Action Plan as Complete</button>
        </div>
    </div>

    <!-- MODAL REMOVED -->

    <script>
        // --- Configuration ---
        const formspreeEndpoint = 'https://formspree.io/f/xzzeqvea'; // YOUR Formspree Endpoint
        const localStorageKey = 'allUserAnswers_actionPlan'; // Specific key for THIS page
        const currentUserKey = 'currentUser'; // Consistent key for storing the whole user object

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
             // --- أولاً: تحقق من تسجيل الدخول الأساسي ---
             if (localStorage.getItem('loggedIn') !== 'true') { // More explicit check
                 console.log("Not logged in, redirecting...");
                 window.location.href = `login.html?redirect=${encodeURIComponent(window.location.pathname)}`;
                 return; // أوقف التنفيذ هنا إذا لم يتم تسجيل الدخول
             }

             // --- ثانياً: حاول الحصول على بيانات المستخدم التفصيلية ---
             const currentUser = getCurrentUser(); // احصل على بيانات المستخدم

             // --- ثالثاً: عرض معلومات المستخدم (ستقرأ الآن من localStorage بنفسها) ---
             displayUserInfo(); // <-- استدعاء بدون مُدخل currentUser. ستقوم بتحديث الشريط العلوي

             // --- رابعاً: تحقق إضافي من صلاحية المستخدم قبل تحميل الإجابات أو إعداد المستمعين ---
             // هذا التحقق مهم لمنع تحميل/حفظ إجابات لمستخدم غير صالح أو بيانات تالفة
             if (!currentUser || !currentUser.email) {
                 console.error("User session invalid or email missing after initial check. Redirecting to login...");
                 // قد ترغب في تسجيل الخروج هنا قبل إعادة التوجيه لتنظيف الحالة
                 logout(); // قم بتسجيل الخروج لتنظيف الحالة (سيقوم بإعادة التوجيه)
                 // window.location.href = `login.html?error=session_invalid`; // يمكنك إضافة سبب في الرابط
                 return; // أوقف التنفيذ
             }

             // --- خامساً: استمر في الإعداد إذا كان المستخدم صالحاً ---
             console.log("User valid, proceeding with setup for:", currentUser.email); // سجل للتأكيد
             loadUserAnswers(currentUser.email);
             setupEventListeners(currentUser.email);
             highlightActiveNav();
             // addRequiredStars(); // Call addRequiredStars after DOM is ready
             checkCompletionState(currentUser.email);
        });

        // --- User Info & Authentication ---
        function getCurrentUser() {
             try {
                 const data = localStorage.getItem(currentUserKey);
                 if (data) {
                     const parsedData = JSON.parse(data);
                     // Ensure essential properties exist (at least email for validation later)
                     if (parsedData && parsedData.email) {
                         return parsedData;
                     } else {
                         console.warn("currentUser data found but missing essential properties (e.g., email). Removing invalid data.");
                         localStorage.removeItem(currentUserKey); // Remove invalid data
                         localStorage.removeItem('loggedIn'); // Also log out if data is corrupt
                         return null;
                     }
                 }
                 return null;
             } catch (e) {
                 console.error("Error parsing currentUser data:", e);
                  localStorage.removeItem(currentUserKey); // Remove potentially corrupted data
                  localStorage.removeItem('loggedIn'); // Also log out if data is corrupt
                 return null;
             }
        }

        // *** تعديل رئيسي هنا: الدالة تقرأ من localStorage بنفسها ***
        function displayUserInfo() {
            // Get the elements first
            const userNameElement = document.getElementById('userName');
            const userEmailElement = document.getElementById('userEmail');

            try {
                const userDataString = localStorage.getItem(currentUserKey); // اقرأ مباشرة
                const userData = userDataString ? JSON.parse(userDataString) : {}; // حلل البيانات وضع كائن فارغ كاحتياط

                // استخدم القيم من userData أو القيم الافتراضية
                const userName = userData.name || 'User'; // قيمة احتياطية للاسم
                const userEmail = userData.email || 'user@example.com'; // قيمة احتياطية للإيميل

                // اعرض البيانات فقط إذا وجدت العناصر
                if (userNameElement) {
                    userNameElement.textContent = `Welcome, ${userName}`;
                } else {
                    console.warn("User name element not found");
                }
                if (userEmailElement) {
                    userEmailElement.textContent = userEmail;
                } else {
                    console.warn("User email element not found");
                }

            } catch (error) {
                console.error("Error displaying user info:", error);
                // في حالة الخطأ، اعرض قيم افتراضية
                if (userNameElement) userNameElement.textContent = 'Welcome, User';
                if (userEmailElement) userEmailElement.textContent = 'email.error@example.com';
            }
        }
        // *** نهاية التعديل الرئيسي ***

        function logout() {
            console.log("Logout function called"); // DEBUG LOG
            localStorage.removeItem('loggedIn');
            localStorage.removeItem(currentUserKey); // Remove the user object

            // Try to get email from the displayed element BEFORE redirecting
            // This is a fallback, ideally, state management would handle this better
            const displayedEmailElement = document.getElementById('userEmail');
            const displayedEmail = displayedEmailElement ? displayedEmailElement.textContent : null;

            if (displayedEmail && displayedEmail !== 'user@example.com' && displayedEmail !== 'email.error@example.com') {
                 console.log("Attempting to remove completion status for:", displayedEmail); // DEBUG LOG
                 // Make sure the key format matches exactly where it's set
                 localStorage.removeItem(`${localStorageKey}_completed_${displayedEmail}`);
            } else {
                 console.warn("Could not determine valid user email from display to remove completion status, or it was default/error.");
            }

            console.log("Redirecting to login.html"); // DEBUG LOG
            window.location.href = 'login.html';
        }

        function highlightActiveNav() {
             const currentPath = window.location.pathname.split('/').pop() || 'index.html'; // Default to index if path is '/'
             document.querySelectorAll('.nav-tab a').forEach(link => {
                 // Make comparison more robust: compare filename only
                 const linkPath = link.getAttribute('href').split('/').pop();
                 link.classList.toggle('active', linkPath === currentPath);
             });
         }

         // Moved addRequiredStars outside DOMContentLoaded for clarity, but it needs DOM ready
         // Let's keep it simple and call it from DOMContentLoaded after elements are surely there
         function addRequiredStars() {
             // console.log("Adding required stars..."); // Debug log
             document.querySelectorAll('.required-answer').forEach(field => {
                 const questionId = field.dataset.question;
                 // Find the H4 or LI ancestor within the same question-box
                 const questionBox = field.closest('.question-box');
                 let labelElement = null;
                 if(questionBox) {
                     // Prefer H4 directly associated with the field if structure is simple
                     const directH4 = field.previousElementSibling;
                     if (directH4 && directH4.tagName === 'H4') {
                         labelElement = directH4;
                     } else {
                          // Fallback to finding the first H4 in the box (less precise)
                          // Or check if it's inside an OL/UL
                         const listItem = field.closest('li');
                         if (listItem) {
                             labelElement = listItem; // Target the LI itself
                         } else {
                             labelElement = questionBox.querySelector('h4'); // General fallback
                         }
                     }
                 }

                  if (labelElement && !labelElement.querySelector('.required-star')) { // Check if star exists
                      // console.log("Adding star to:", labelElement.textContent.substring(0, 30)); // Debug log
                      labelElement.insertAdjacentHTML('beforeend', '<span class="required-star">*</span>');
                  } else if (!labelElement) {
                       // console.warn("Could not find label element for field:", questionId); // Debug log
                  }
              });
              // This hiding logic might be too broad, commented out for now
              // document.querySelectorAll('p:has(.required-star)').forEach(note => note.style.display = 'none');
         }

        // --- Answer Handling (Local Storage) ---
        function loadUserAnswers(userEmail) {
             if (!userEmail) { console.warn("loadUserAnswers called without userEmail"); return; }
             console.log("Loading answers for:", userEmail); // Debug log
             let allAnswers = {};
             try { const storedData = localStorage.getItem(localStorageKey); if (storedData) { allAnswers = JSON.parse(storedData) || {}; } } catch(e) { console.error("Error parsing stored answers:", e); allAnswers = {}; }

             const userPageAnswers = allAnswers[userEmail] || {};
             // console.log("User-specific answers found:", userPageAnswers); // Debug log

             document.querySelectorAll('.required-answer[data-question]').forEach(field => {
                 const questionId = field.dataset.question;
                 loadFieldState(field, questionId, userPageAnswers);
             });
             // Add required stars AFTER loading answers, ensuring elements are present
             addRequiredStars();
        }

        function loadFieldState(field, questionId, userAnswers) {
             if (userAnswers[questionId] !== undefined && userAnswers[questionId] !== null) {
                 field.value = userAnswers[questionId];
                 field.classList.remove('required-field'); // Remove error state if loaded
                 const errorId = `error-${questionId}`;
                 hideError(errorId); // Hide specific error message if loaded
                 // console.log(`Loaded value for ${questionId}:`, userAnswers[questionId]); // Debug
             } else {
                 field.value = ''; // Clear field if no answer stored
                 // console.log(`No value found for ${questionId}`); // Debug
             }
             // Reset save status on load
             const sectionId = getSectionIdFromQuestionId(questionId);
             if (sectionId) {
                 const statusId = `save-status-${sectionId}`;
                 const statusElement = document.getElementById(statusId);
                 if (statusElement) statusElement.style.display = 'none';
             }
        }
        function saveAnswerToStorage(userEmail, questionId, answer) {
            if (!userEmail) { console.warn("saveAnswerToStorage: No userEmail provided."); return false; }
            let allAnswers = {};
            try { const storedData = localStorage.getItem(localStorageKey); if (storedData) { allAnswers = JSON.parse(storedData) || {}; } } catch(e) { console.error("Error parsing answers before save:", e); allAnswers = {}; }

            if (!allAnswers[userEmail]) { allAnswers[userEmail] = {}; }
            allAnswers[userEmail][questionId] = answer; // Store the answer

            try { localStorage.setItem(localStorageKey, JSON.stringify(allAnswers)); console.log(`Saved locally: ${userEmail} -> ${questionId}`); return true; }
            catch (error) { console.error("Error saving to localStorage:", error); alert("Could not save answer. Browser storage might be full."); return false; }
        }
        function deleteAnswerFromStorage(userEmail, questionIds) {
             if (!userEmail) { console.warn("deleteAnswerFromStorage: No userEmail provided."); return false; }
             let allAnswers = {};
              try { const storedData = localStorage.getItem(localStorageKey); if (storedData) { allAnswers = JSON.parse(storedData) || {}; } else { return false; } } catch(e) { console.error("Error parsing answers before delete:", e); return false; }

             let updated = false;
             if (allAnswers[userEmail]) {
                 const idsToDelete = Array.isArray(questionIds) ? questionIds : [questionIds];
                 idsToDelete.forEach(id => {
                     if (allAnswers[userEmail]?.[id] !== undefined) {
                         delete allAnswers[userEmail][id];
                         updated = true;
                         console.log(`Deleting locally: ${userEmail} -> ${id}`);
                     }
                 });
                 // If the user has no answers left on this page, remove their entry
                 if (Object.keys(allAnswers[userEmail]).length === 0) {
                     delete allAnswers[userEmail];
                     console.log(`Removed empty entry for ${userEmail} from ${localStorageKey}`);
                 }
             }

             if(updated) {
                 try {
                     localStorage.setItem(localStorageKey, JSON.stringify(allAnswers));
                     console.log(`Finished deleting for ${userEmail}.`);
                     return true;
                 } catch (error) {
                     console.error("Error saving after delete:", error);
                     return false;
                 }
             }
             return false; // Nothing was deleted
        }

        // --- Event Listeners Setup ---
        function setupEventListeners(userEmail) {
             if (!userEmail) { console.warn("setupEventListeners: No userEmail provided."); return; }
             // Add listeners to input fields to clear errors on input
             document.querySelectorAll('.required-answer').forEach(field => {
                 const eventType = (field.type === 'date' || field.tagName === 'SELECT') ? 'change' : 'input'; // Handle different input types
                 field.addEventListener(eventType, function() {
                     const questionId = this.dataset.question;
                     const errorId = `error-${questionId}`;
                     this.classList.remove('required-field');
                     hideError(errorId);

                     // Also hide the general section warning if all fields in that section are now filled
                     const sectionBox = this.closest('.question-box');
                     if (sectionBox) {
                         const sectionId = sectionBox.dataset.section;
                         const sectionWarning = document.getElementById(`warning-${sectionId}`);
                         if (sectionWarning && sectionWarning.style.display !== 'none') {
                             let sectionStillInvalid = false;
                             sectionBox.querySelectorAll('.required-answer').forEach(f => {
                                 if (f.value.trim() === '') {
                                     sectionStillInvalid = true;
                                 }
                             });
                             if (!sectionStillInvalid) {
                                 sectionWarning.style.display = 'none';
                             }
                         }
                     }
                 });
             });

             // Add listener for the "Complete" button
             const completeButton = document.getElementById('completeButton');
             if (completeButton) {
                 completeButton.addEventListener('click', () => handleCompleteButtonClick(userEmail)); // Pass userEmail
             } else {
                 console.warn("Complete button not found.");
             }

             // Assign section IDs dynamically if needed (though hardcoding in HTML is fine too)
             // document.querySelectorAll('.question-box').forEach(qb => {
             //     const firstField = qb.querySelector('[data-question]');
             //     if (firstField) {
             //         const sectionId = getSectionIdFromQuestionId(firstField.dataset.question);
             //         if (sectionId) qb.dataset.section = sectionId;
             //     }
             // });
        }

         function handleCompleteButtonClick(userEmail) { // Receive userEmail
              if (!userEmail) {
                  alert("Session error. Please log in again.");
                  logout(); // Force logout if email is missing
                  return;
              }
              console.log("Complete button clicked for user:", userEmail);
              if (!validateAllAnswers(true)) { // Pass true to show errors
                  showGeneralWarningMessage();
                  console.log("Validation failed.");
              } else {
                  console.log("Validation passed. Marking plan as complete.");
                  markPlanAsComplete(userEmail);
              }
         }

        // Helper to map question ID to section ID (Seems correct)
        function getSectionIdFromQuestionId(questionId) {
            const sectionMap = { motivation: ['excitement', 'personal-gain', 'team-benefits'], time: ['habits-to-change', 'blockers', 'first-step', 'support-needed', 'discussion-plan', 'resources'], skills: ['listening-strength', 'listening-tip1', 'listening-tip2', 'assumption-plan', 'question1', 'question2', 'emotion-challenge', 'own-mood', 'improvement-plan', 'trust-building', 'strengths-application'], model: ['model-choice', 'model-reason', 'preparation', 'best-interests', 'integrity', 'tip1', 'tip2'], team: ['shop-floor', 'intervention', 'team-group', 'team-issue', 'personality-test', 'strengths-appreciation', 'charter-steps', 'conflict-resolution', 'positive-model', 'practice-model'], reflection: ['swot-highlights', 'swot-actions', 'grow-goal', 'first-grow-action', 'review-date', 'self-changes', 'team-changes'] };
            for (const section in sectionMap) { if (sectionMap[section].includes(questionId)) return section; }
            console.warn(`Could not find section for question ID: ${questionId}`);
            return null; // Return null if not found
        }

        // --- UI Feedback & Validation ---
        function validateAllAnswers(showErrors = false) {
            let allValid = true;
            let firstInvalidField = null;
            console.log("Starting validation. Show errors:", showErrors);

            document.querySelectorAll('.required-answer').forEach(field => {
                const questionId = field.dataset.question;
                const errorId = `error-${questionId}`;
                const isVisible = field.offsetParent !== null; // Check if field is visible

                // Reset errors first
                hideError(errorId);
                field.classList.remove('required-field');

                // Validate only visible fields
                if (isVisible && field.value.trim() === '') {
                    allValid = false;
                    console.log(`Validation failed for: ${questionId}`);
                    if (!firstInvalidField) {
                        firstInvalidField = field;
                    }
                    if (showErrors) {
                        field.classList.add('required-field');
                        showError(errorId, field, 'This field is required.'); // More specific message
                    }
                }
            });

            if (!allValid && showErrors && firstInvalidField) {
                 console.log("Scrolling to first invalid field:", firstInvalidField.dataset.question);
                 firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                 // Use try-catch for focus as it can fail in some scenarios
                 setTimeout(() => {
                     try {
                         firstInvalidField.focus({ preventScroll: true });
                     } catch (e) {
                         console.warn("Could not focus on invalid field:", e);
                     }
                 }, 400); // Delay to allow scroll to finish
            }
            console.log("Validation result:", allValid);
            return allValid;
        }
        function showGeneralWarningMessage() {
             const warningElement = document.getElementById('generalWarningMessage');
             if (!warningElement) return;
             warningElement.innerHTML = '<strong>Action Required:</strong> Please complete all required fields marked with <span class="required-star">*</span> before completing the plan.';
             warningElement.style.animation = 'none'; // Reset animation
             void warningElement.offsetWidth; // Trigger reflow
             warningElement.style.display = 'block';
             warningElement.style.animation = 'slideDownFadeIn 0.4s ease-out';

             // Clear previous timer if exists
             clearTimeout(warningElement.timer);

             // Set new timer to hide the message
             warningElement.timer = setTimeout(() => {
                 warningElement.style.animation = 'fadeOutUp 0.5s ease-out forwards';
                 // Use a callback or another timeout to actually hide after animation
                 setTimeout(() => {
                     // Check if it's still supposed to be fading out before hiding
                     if (warningElement.style.animationName === 'fadeOutUp') {
                         warningElement.style.display = 'none';
                         warningElement.style.animation = ''; // Reset animation property
                     }
                 }, 500); // Matches fadeOutUp duration
             }, 4000); // Duration to display warning
        }
        function showSaveStatus(statusId, message = '✓ Saved') {
             const statusElement = document.getElementById(statusId);
             if (!statusElement) return;
             statusElement.textContent = message;
             statusElement.classList.remove('deleted');
             statusElement.style.color = '#27ae60'; // Default green

             if (message.includes('Cleared')) {
                 statusElement.classList.add('deleted');
                 statusElement.style.color = '#6c757d'; // Grey for cleared
             }

             statusElement.style.display = 'inline-block';
             // Clear previous timer if any
             clearTimeout(statusElement.timer);
             // Set new timer to hide
             statusElement.timer = setTimeout(() => {
                 statusElement.style.display = 'none';
             }, 3000); // Hide after 3 seconds
        }
        function showError(errorId, fieldToMark, message = 'Required.') { // Added fieldToMark param
             const errorElement = document.getElementById(errorId);
             if (!errorElement) return;
             errorElement.textContent = message;
             errorElement.style.color = '#e74c3c'; // Red
             errorElement.style.display = 'inline-block'; // Show the message

             // Optionally mark the field itself (redundant if .required-field is used by validation)
             // if (fieldToMark) {
             //     fieldToMark.classList.add('required-field');
             // }
        }
        function hideError(errorId) {
             const errorElement = document.getElementById(errorId);
             if (errorElement) {
                 errorElement.style.display = 'none';
                 errorElement.textContent = ''; // Clear text too
             }
        }
        function hideMessages(statusId, sectionWarningId, sectionBox) { // Modified to hide section warning too
             const statusElement = statusId ? document.getElementById(statusId) : null;
             if (statusElement) statusElement.style.display = 'none';

             const warningElement = sectionWarningId ? document.getElementById(sectionWarningId) : null;
             if (warningElement) warningElement.style.display = 'none';

             // Clear individual field errors within the section
             if (sectionBox) {
                 sectionBox.querySelectorAll('.inline-error-message').forEach(el => el.style.display = 'none');
                 sectionBox.querySelectorAll('.required-field').forEach(el => el.classList.remove('required-field'));
             }
        }

        // --- Section-Based Save/Delete ---
        // Global scope functions for onclick handlers
        window.saveSection = function(questionIds, sectionId) {
             const currentUser = getCurrentUser(); // Get current user info again
             if (!currentUser || !currentUser.email) {
                 alert("Session error. Please log in again.");
                 logout();
                 return;
             }
             const userEmail = currentUser.email;

             const statusId = `save-status-${sectionId}`;
             const warningId = `warning-${sectionId}`;
             const sectionBox = document.querySelector(`.question-box[data-section="${sectionId}"]`);

             // Hide previous messages for this section
             hideMessages(statusId, warningId, sectionBox);

             let allSectionFieldsValid = true;
             let firstInvalidInSection = null;
             const dataToSave = {};

             questionIds.forEach(id => {
                 const field = document.querySelector(`.required-answer[data-question="${id}"]`);
                 if (field) {
                     const errorId = `error-${id}`;
                     // We only validate required fields here, assuming non-required are optional
                     if (field.classList.contains('required-answer') && field.value.trim() === '') {
                         allSectionFieldsValid = false;
                         showError(errorId, field, 'This field is required.'); // Show specific error
                         field.classList.add('required-field');
                         if (!firstInvalidInSection) firstInvalidInSection = field;
                     } else {
                         dataToSave[id] = field.value; // Collect data even if optional and empty (can be filtered later if needed)
                     }
                 } else {
                      console.warn(`Field not found for question ID: ${id} in section ${sectionId}`);
                 }
             });

             if (!allSectionFieldsValid) {
                 const warningElement = document.getElementById(warningId);
                 if (warningElement) warningElement.style.display = 'block'; // Show section warning
                 if(firstInvalidInSection) {
                     console.log(`Scrolling to first invalid field in section ${sectionId}: ${firstInvalidInSection.dataset.question}`);
                     firstInvalidInSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                     setTimeout(() => { try {firstInvalidInSection.focus({preventScroll: true});} catch(e){} }, 100);
                 }
                 return; // Stop if validation failed
             }

             // If validation passed, save and submit
             console.log(`Saving section ${sectionId} for ${userEmail}. Data:`, dataToSave);
             let savedOk = true;
             for (const id in dataToSave) {
                 if (!saveAnswerToStorage(userEmail, id, dataToSave[id])) {
                     savedOk = false; // Track if any save failed
                 }
                 // Submit each answer individually to Formspree
                 submitToFormspree(userEmail, id, dataToSave[id]);
             }

             if (savedOk) {
                 showSaveStatus(statusId, '✓ Saved');
             } else {
                  // Optionally show a different status if saving failed
                  showSaveStatus(statusId, '✗ Save Error');
             }

             // Re-check overall completion state after saving a section successfully
             checkCompletionState(userEmail);
        }

        window.deleteSection = function(questionIds, sectionId) {
            const currentUser = getCurrentUser(); // Get current user info again
             if (!currentUser || !currentUser.email) {
                 alert("Session error. Please log in again.");
                 logout();
                 return;
             }
             const userEmail = currentUser.email;

             // Use a more descriptive confirmation message
             const sectionTitle = document.querySelector(`.question-box[data-section="${sectionId}"]`)?.previousElementSibling?.textContent || sectionId;
             if (!confirm(`Are you sure you want to clear all answers for the "${sectionTitle}" section? This cannot be undone.`)) {
                 return; // Abort if user cancels
             }

             const statusId = `save-status-${sectionId}`;
             const warningId = `warning-${sectionId}`;
             const sectionBox = document.querySelector(`.question-box[data-section="${sectionId}"]`);

             // Hide previous messages for this section
             hideMessages(statusId, warningId, sectionBox);

             let deletedSomething = false;
             questionIds.forEach(id => {
                 const field = document.querySelector(`.required-answer[data-question="${id}"]`);
                 if (field) {
                     field.value = ''; // Clear the input field
                     // hideError(`error-${id}`); // Already handled by hideMessages
                     // field.classList.remove('required-field'); // Already handled by hideMessages
                 }
                 // Attempt to delete from storage regardless of field presence
                 if (deleteAnswerFromStorage(userEmail, id)) {
                     deletedSomething = true; // Track if deletion occurred
                 }
             });

             if (deletedSomething) {
                 showSaveStatus(statusId, '✓ Cleared');
             }

             // Re-check completion state after clearing (it might become incomplete)
             checkCompletionState(userEmail);
        }

        // --- Formspree Submission ---
        function submitToFormspree(userEmail, questionId, answer) {
             // Don't submit empty answers (unless specifically required)
             if (!answer?.trim()) {
                  // console.log(`Formspree: Skipping empty answer for ${questionId}`);
                  return;
             }
             if (!formspreeEndpoint) { console.warn("Formspree endpoint not configured."); return; }
             if (!userEmail) { console.warn("Formspree: No userEmail provided."); return; }

            const formData = new FormData();
            formData.append('email', userEmail);
            formData.append('page_title', document.title); // Use page title
            formData.append('page_key', 'actionPlan'); // Specific key for this page
            formData.append('question_id', questionId);
            formData.append('answer_text', answer);

            // Add user name if available
            const currentUser = getCurrentUser();
            if (currentUser?.name) {
                formData.append('user_name', currentUser.name);
            }

            // Try to add context (Question Text)
             let context = `Q-ID: ${questionId}`; // Default context
             const fieldElement = document.querySelector(`[data-question="${questionId}"]`);
             if(fieldElement) {
                 const qBox = fieldElement.closest('.question-box');
                 let headingElement = null;
                 // Find the most relevant heading (H4 or preceding H4 for lists)
                 if (fieldElement.closest('li')) { // Inside a list item
                     headingElement = fieldElement.closest('ol, ul')?.previousElementSibling;
                 } else { // Directly in the question box
                     headingElement = fieldElement.previousElementSibling;
                 }
                 // Check if the found element is H4 and extract text
                 if (headingElement && headingElement.tagName === 'H4') {
                      context = headingElement.textContent.replace(/<span class="required-star">\*<\/span>/g, '').trim(); // Remove star span
                 } else if (qBox?.querySelector('h4')) { // Fallback to first H4 in box
                      context = qBox.querySelector('h4').textContent.replace(/<span class="required-star">\*<\/span>/g, '').trim();
                 }
             }
             formData.append('question_context', context);

             // Send the data
            fetch(formspreeEndpoint, {
                method: 'POST',
                body: formData,
                headers: { 'Accept': 'application/json' }
            })
            .then(response => {
                if (response.ok) {
                    console.log(`Formspree: ${questionId} submitted successfully.`);
                } else {
                    response.json().then(data => {
                        console.error(`Formspree error (${questionId}):`, data.errors?.map(e=>e.message).join(', ') || `Status ${response.status}`);
                    }).catch(() => {
                        console.error(`Formspree non-JSON error (${questionId}). Status: ${response.status}`);
                    });
                }
            })
            .catch(error => console.error(`Network error submitting (${questionId}) to Formspree:`, error));
        }

        // --- Completion Handling ---
        function markPlanAsComplete(userEmail) {
             if (!userEmail) { console.error("Cannot mark complete without userEmail"); return; }
             const completionKey = `${localStorageKey}_completed_${userEmail}`;
             console.log('Marking plan as complete with key:', completionKey);
             try {
                 localStorage.setItem(completionKey, 'true');
                 displayCompletionState(); // Update UI immediately
                 const completionMessage = document.getElementById('completionMessage');
                 if (completionMessage) {
                      completionMessage.scrollIntoView({ behavior: 'smooth' });
                 }
             } catch (error) {
                  console.error("Error saving completion state to localStorage:", error);
                  alert("Could not save completion status. Storage might be full.");
             }
        }
        function checkCompletionState(userEmail) {
            if (!userEmail) { /* console.warn("checkCompletionState: No userEmail."); */ return; }
            const completionKey = `${localStorageKey}_completed_${userEmail}`;
            if (localStorage.getItem(completionKey) === 'true') {
                 console.log("Completion state is true for", userEmail);
                 displayCompletionState();
            } else {
                 console.log("Completion state is false or null for", userEmail);
                 // Ensure the completion message is hidden and buttons are enabled if not complete
                 const completionMessage = document.getElementById('completionMessage');
                 const completeButton = document.getElementById('completeButton');
                 if(completionMessage) completionMessage.style.display = 'none';
                 if(completeButton) completeButton.style.display = 'block'; // Or 'inline-block'/'flex' depending on style

                 // Re-enable fields and buttons
                 document.querySelectorAll('.save-button, .delete-button, .editable-answer, #completeButton').forEach(el => {
                    el.disabled = false;
                    if(el.tagName !== 'BUTTON') {
                        el.style.backgroundColor = ''; // Reset background
                        el.style.cursor = ''; // Reset cursor
                    }
                 });
                 // Reset back button text/link if needed
                 const backBtn = document.getElementById('backButton');
                 if(backBtn) {
                     backBtn.textContent = '← Back to Self Coaching';
                     backBtn.href = 'coaching-yourself.html';
                 }
            }
        }
        function displayCompletionState() {
             console.log('Displaying completion state UI changes');
             const completionMessage = document.getElementById('completionMessage');
             const completeButton = document.getElementById('completeButton');
             const backButton = document.getElementById('backButton'); // Get back button

             if(completionMessage) completionMessage.style.display = 'block';
             if(completeButton) completeButton.style.display = 'none'; // Hide complete button

             // Disable all interactive elements within the container
             const container = document.querySelector('.container');
             if (container) {
                 container.querySelectorAll('textarea, input, select, .save-button, .delete-button').forEach(el => {
                     el.disabled = true;
                     if(el.tagName !== 'BUTTON') {
                         el.style.backgroundColor = '#e9ecef'; // Grey out inputs/textareas
                         el.style.cursor = 'not-allowed';
                     } else {
                         el.style.cursor = 'not-allowed'; // Ensure buttons are not clickable
                         // Optional: Add a specific disabled style for buttons if not covered by :disabled
                     }
                 });
             }

             // Change the back button's text and link
             if(backButton) {
                 backButton.textContent = '← Back to Home'; // Or maybe "View Summary"?
                 backButton.href = 'index.html'; // Change link to home page
             }
        }

        // --- Modal Functions Removed ---

        // This function seems unused now, can be removed or repurposed if needed later.
        // function redirectToNextPage() {
        //      alert('Congratulations! You have completed the Leadership Coaching Toolkit Action Plan.');
        //      window.location.href = 'index.html';
        // }

    </script>

</body>
</html>
