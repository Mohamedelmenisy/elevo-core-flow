<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elevo Core Assistant</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234e8cff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M3 12h18M3 6h12M3 18h15'/><path d='M17 9l4 3l-4 3'/></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --background-color: #12121c;
            --card-background-color: rgba(43, 43, 61, 0.75);
            --text-color: #f0f0f0;
            --text-color-secondary: #a0a0b0;
            --primary-color: #5891ff;
            --primary-color-rgb: 88, 145, 255;
            --primary-color-dark: #4e8cff;
            --secondary-color: #3a3a50;
            --border-color: rgba(255, 255, 255, 0.1);
            --input-background-color: #242436;
            --input-border-color: #444444;
            --button-text-color: #ffffff;
            --success-color: #4CAF50;
            --danger-color: #F44336;
            --warning-color: #FFC107;
            --border-radius: 16px; /* Increased for a softer look */
            --font-family-main: 'Poppins', 'Roboto', sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: var(--font-family-main);
            margin: 0; padding: 0; line-height: 1.6;
            /* --- UI UPGRADE: Aurora Background --- */
            background-image: radial-gradient(at 20% 10%, hsla(212, 85%, 55%, 0.2) 0px, transparent 50%),
                              radial-gradient(at 80% 20%, hsla(267, 85%, 60%, 0.15) 0px, transparent 50%),
                              radial-gradient(at 70% 80%, hsla(330, 85%, 55%, 0.1) 0px, transparent 50%);
            overflow-x: hidden;
        }

        .app-container {
            display: flex; flex-direction: column; min-height: 100vh;
        }

        .app-main {
            padding: 2rem; flex-grow: 1; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
        }

        .app-header {
            background-color: rgba(28, 28, 40, 0.6);
            backdrop-filter: blur(10px);
            color: var(--text-color);
            padding: 1rem 2rem; display: flex; justify-content: space-between;
            align-items: center; border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 100%;
            position: sticky; top: 0; z-index: 100;
        }
        .app-title { font-weight: 600; color: var(--primary-color); }
        .nav-link:hover { color: var(--primary-color); }

        .logout-btn {
            background-color: transparent; color: var(--primary-color);
            border: 1px solid var(--primary-color); border-radius: 12px; padding: 0.6rem 1.2rem;
            display: inline-flex; align-items: center; gap: 0.5em; cursor: pointer;
            transition: all 0.2s ease-in-out; font-size: 0.9rem;
        }
        .logout-btn:hover {
            background-color: rgba(var(--primary-color-rgb), 0.1);
            color: var(--primary-color-dark); transform: translateY(-1px);
        }

        .card {
            background-color: var(--card-background-color);
            backdrop-filter: blur(15px);
            padding: 2.5rem;
            border-radius: var(--border-radius);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            margin-bottom: 1.5rem; width: 100%;
            max-width: 650px;
            transition: all 0.3s ease-in-out;
        }
        
        /* --- UI UPGRADE: Wide, Two-Column Initial Card --- */
        .initial-card {
            max-width: 1100px; /* Wider card */
            padding: 0;
            display: grid;
            grid-template-columns: 1fr 1.1fr; /* Two columns */
            overflow: hidden;
        }
        
        .welcome-panel {
            padding: 3rem;
            background: linear-gradient(135deg, rgba(var(--primary-color-rgb), 0.1), rgba(var(--primary-color-rgb), 0));
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .welcome-panel .card-icon {
            background-color: rgba(var(--primary-color-rgb), 0.1);
            width: 64px; height: 64px;
            border-radius: 50%;
            display: grid; place-items: center;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(var(--primary-color-rgb), 0.2);
        }

        .welcome-panel h2 {
            font-size: 2.25rem;
            color: #fff;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
         .welcome-panel p {
            font-size: 1rem;
            color: var(--text-color-secondary);
            max-width: 400px;
        }

        .scenario-panel {
            padding: 3rem;
        }
        /* --- End of Initial Card Upgrade --- */

        .call-flow-card {
            max-width: 750px;
            background: linear-gradient(145deg, var(--card-background-color), #242436);
            position: relative;
        }

        @keyframes cardDecisionPulse {
            0% { box-shadow: 0 8px 32px rgba(0,0,0,0.3), 0 0 0 0px rgba(var(--primary-color-rgb), 0.5); }
            50% { box-shadow: 0 8px 32px rgba(0,0,0,0.3), 0 0 0 10px rgba(var(--primary-color-rgb), 0); }
            100% { box-shadow: 0 8px 32px rgba(0,0,0,0.3), 0 0 0 0px rgba(var(--primary-color-rgb), 0); }
        }
        .decision-made-animation { animation: cardDecisionPulse 0.7s ease-out; }

        .card-title {
          color: #f0f0f0; font-size: 1.5rem; font-weight: 600; 
        }

        .action-button, .nav-button, .decision-button {
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: none;
            font-size: 1rem;
            display: inline-flex; align-items: center; justify-content: center;
            gap: 0.75em;
        }
        .action-button:active, .nav-button:active, .decision-button:active { 
            transform: translateY(1px) scale(0.98); 
        }

        .primary-button {
          background: linear-gradient(90deg, var(--primary-color), var(--primary-color-dark));
          color: white;
          box-shadow: 0 4px 15px rgba(var(--primary-color-rgb), 0.2);
        }
        .primary-button:hover {
          background-color: var(--primary-color-dark); transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(var(--primary-color-rgb), 0.3);
        }

        /* --- UI UPGRADE: Scenario List & Filter Styles --- */
        .scenario-selector-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .scenario-filter-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--input-border-color);
            border-radius: 12px;
            background-color: var(--input-background-color);
            color: var(--text-color);
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .scenario-filter-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 8px rgba(var(--primary-color-rgb), 0.3);
        }

        .custom-scenario-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 280px;
            overflow-y: auto;
            padding: 0.5rem;
            border-radius: 12px;
        }

        .scenario-item {
            padding: 1rem 1.25rem;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-weight: 500;
            border: 1px solid transparent;
            background-color: rgba(255,255,255,0.03);
        }

        .scenario-item:hover {
            background-color: rgba(var(--primary-color-rgb), 0.1);
            border-color: var(--primary-color);
            transform: translateX(5px);
        }

        .scenario-item.selected, .scenario-item:focus-visible {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            border-color: var(--primary-color-dark);
            box-shadow: 0 4px 12px rgba(var(--primary-color-rgb), 0.25);
            transform: translateX(5px) scale(1.02);
            outline: none;
        }
        
        .scenario-item .icon {
            font-size: 1.5em;
            width: 28px;
            text-align: center;
            transition: transform 0.2s ease-out;
        }
        .scenario-item:hover .icon, .scenario-item:focus-visible .icon {
            transform: scale(1.2) rotate(-5deg);
        }

        .scenario-item.compensation {
            border-left: 4px solid var(--success-color);
        }
         /* --- End of UI UPGRADE --- */

        .status-bar {
            background-color: transparent; padding: 0.75rem 2rem;
            font-size: 0.9rem; width: 100%; text-align: center;
        }
        
        #callTimer {
            font-size: 1.25em; font-weight: 500; color: var(--primary-color);
            background-color: var(--card-background-color); padding: 0.5rem 1.25rem;
            border-radius: 12px; display: inline-block; min-width: 80px;
            border: 1px solid var(--border-color);
        }

        .fade-in { animation: fadeInAnimation 0.6s ease-in-out forwards; }
        @keyframes fadeInAnimation {
            from { opacity: 0; transform: translateY(20px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .app-footer {
            text-align: center; padding: 1.5rem; font-size: 0.85rem;
            color: var(--text-color-secondary); background-color: transparent;
            margin-top: auto; width: 100%;
        }

        /* Other minor adjustments */
        #steps-container {
            font-size: 1.1rem;
            line-height: 1.75;
        }
        .decision-button .icon {
            display: inline-block;
            width: 1em;
            height: 1em;
        }

        /* Responsive adjustments for the new layout */
        @media (max-width: 900px) {
            .initial-card {
                grid-template-columns: 1fr; /* Stack columns on smaller screens */
                max-width: 600px;
                padding: 1.5rem;
            }
            .welcome-panel {
                padding: 1.5rem;
                text-align: center;
                align-items: center;
            }
            .scenario-panel {
                padding: 1rem 0 0 0;
            }
            .app-main { padding: 1.5rem; }
            .app-header { padding: 1rem; }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <header class="app-header">
            <div class="logo-container" style="display: flex; align-items: center; gap: 0.75rem;">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: var(--primary-color); width: 28px; height: 28px;">
                    <path d="M6 17L10 17M6 12L12 12M6 7L14 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M15 6L19 10L15 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <rect x="3" y="3" width="18" height="18" rx="3" stroke="currentColor" stroke-width="1.5" fill="transparent" opacity="0.6"/>
                </svg>
                <span class="app-title" style="font-size: 1.3rem;">Elevo Core</span>
            </div>
            <div class="header-controls">
                 <a href="dashboard.html" class="nav-link" id="dashboardLink" style="display: none; color: var(--primary-color); margin-right: 1rem; font-weight: 500;">Dashboard</a>
                <div class="user-info" id="userInfo" style="display: none;">
                    <span id="userName" class="user-name-display"></span>
                    <button id="logoutButton" class="logout-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
        </header>

         <div id="timer-container" style="padding-top: 1rem;">
             <div id="callTimer" style="display: none;">00:00</div>
         </div>

        <main class="app-main">
            <div id="auth-loading" class="loading-container" style="display: none; flex-direction: column; align-items: center; justify-content: center; height: 50vh;">
                <div class="spinner" style="width: 40px; height: 40px; border-top-color: var(--primary-color);"></div>
                <p style="color: var(--text-color-secondary); margin-top: 1rem;">Initializing Assistant...</p>
            </div>

            <!-- UI UPGRADE: New Initial View Layout -->
            <div id="initial-view" class="card initial-card fade-in" style="display: none;">
                <div class="welcome-panel">
                    <div class="card-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="var(--primary-color)" width="32" height="32"><path d="M12 2C6.486 2 2 6.486 2 12C2 17.514 6.486 22 12 22C17.514 22 22 17.514 22 12C22 6.486 17.514 2 12 2ZM12 20C7.589 20 4 16.411 4 12C4 7.589 7.589 4 12 4C16.411 4 20 7.589 20 12C20 16.411 16.411 20 12 20Z"/><path d="M16.002 16.246C15.483 15.219 14.544 14.5 13.333 14.5H10.667C9.456 14.5 8.517 15.219 7.998 16.246C7.933 16.386 7.996 16.553 8.114 16.641C8.657 17.053 9.737 17.5 12 17.5C14.263 17.5 15.343 17.053 15.886 16.641C16.004 16.553 16.067 16.386 16.002 16.246Z"/></svg>
                    </div>
                    <h2 class="card-title">Core Flow Assistant</h2>
                    <p class="card-subtitle">Your dedicated assistant for streamlined ticket resolution. Please select a scenario to begin.</p>
                </div>

                <div class="scenario-panel">
                    <div class="scenario-selector-container" style="margin-bottom: 2rem;">
                        <label for="scenarioFilter" style="font-weight: 500; color: var(--text-color-secondary); margin-bottom: 0.5rem; display: block;">Select Scenario:</label>
                        <input type="text" id="scenarioFilter" class="scenario-filter-input" placeholder="üîç Search scenarios...">
                        
                        <div id="customScenarioList" role="listbox" aria-label="Select a scenario" class="custom-scenario-list">
                            <!-- Scenarios loaded here -->
                        </div>
                        <input type="hidden" id="scenarioDropdownValue" name="scenarioId">
                    </div>
                    
                    <div style="display: flex; justify-content: center;">
                        <button id="receive-call-btn" class="action-button primary-button" disabled>
                            <span class="btn-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M6.05828 11.0452L4.00001 9.00002C4.00001 9.00002 3.58101 8.99902 3.51201 9.00002C2.04801 9.02602 1.00001 10.318 1.00001 11.785V12.214C1.00001 13.682 2.04801 14.973 3.51201 15H4.00001L6.05828 12.9548C6.12828 12.8848 6.16728 12.7948 6.16728 12C6.16728 11.2052 6.12828 11.1152 6.05828 11.0452ZM20.488 15H21C22.464 14.974 23.512 13.682 23.512 12.215V11.785C23.512 10.318 22.464 9.02602 21 9.00002C20.998 8.99902 20 9.00002 20 9.00002L17.9417 11.0452C17.8717 11.1152 17.8327 11.2052 17.8327 12C17.8327 12.7948 17.8717 12.8848 17.9417 12.9548L20.488 15Z"/><path d="M19.6623 5.08431C19.8803 5.08431 20.0943 5.17031 20.2503 5.32631L21.6743 6.74931C21.9863 7.06231 21.9863 7.56731 21.6743 7.87931C19.4003 10.1523 19.4003 13.8473 21.6743 16.1203C21.9863 16.4323 21.9863 16.9373 21.6743 17.2503L20.2503 18.6733C20.0943 18.8293 19.8803 18.9153 19.6623 18.9153C19.4443 18.9153 19.2303 18.8293 19.0743 18.6733C16.2573 15.8563 16.2573 8.14331 19.0743 5.32631C19.2303 5.17031 19.4443 5.08431 19.6623 5.08431ZM4.92575 5.32631C5.52575 4.72631 6.45075 4.72631 7.05075 5.32631C9.86775 8.14331 9.86775 15.8563 7.05075 18.6733C6.89475 18.8293 6.68075 18.9153 6.46275 18.9153C6.24475 18.9153 6.03075 18.8293 5.87475 18.6733L4.45075 17.2503C4.13875 16.9373 4.13875 16.4323 4.45075 16.1203C6.72375 13.8473 6.72375 10.1523 4.45075 7.87931C4.13875 7.56731 4.13875 7.06231 4.45075 6.74931L5.87475 5.32631C5.71875 5.17031 4.76975 5.17031 4.92575 5.32631Z"/></svg>
                            </span>
                            <span class="btn-text">Start Ticket</span>
                        </button>
                    </div>
                </div>

                <audio id="callStartSound" src="call_sound.mp3" preload="auto"></audio>
                <audio id="compensationScenarioSound" src="compensation_alert.mp3" preload="auto"></audio>
            </div>

            <div id="call-flow-view" class="card call-flow-card fade-in" style="display: none;">
                <h3 id="scenario-title" class="card-title scenario-title-dynamic"><span id="step-type-icon" class="step-type-icon"></span>Ticket Scenario</h3>
                 <div class="status-bar">
                    <div id="systemStatus" class="status-indicator status-waiting">üî¥ Waiting for Ticket</div>
                </div>
                <div id="steps-container" class="steps-area" style="margin: 2rem 0; font-size: 1.1rem; line-height: 1.75; color: var(--text-color-secondary);">
                    <p class="placeholder-text">Loading ticket steps...</p>
                </div>
                <div id="decision-buttons-container" class="step-actions"></div>

                <div class="navigation-buttons">
                    <button id="prev-step-btn" class="nav-button secondary-button" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 0.5em;"><polyline points="15 18 9 12 15 6"></polyline></svg>
                        <span>Previous</span>
                    </button>
                    <button id="next-step-btn" class="nav-button primary-button">
                        <span class="btn-text">Next Step</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </button>
                </div>
                 <div style="display: flex; justify-content: center; margin-top: 1rem;">
                    <button id="end-call-btn" class="nav-button danger-button" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        <span>End Ticket</span>
                    </button>
                 </div>
            </div>

            <div id="postCallSummary" class="card post-call-summary-card fade-in" style="display: none;">
                <h3 class="card-title">Ticket Summary</h3>
                <div id="callSummaryContent">
                </div>
                <div style="display: flex; justify-content: center; margin-top: 1.5rem;">
                    <button id="returnToInitialViewBtn" class="action-button primary-button">
                        <span class="btn-text">New Ticket</span>
                    </button>
                </div>
            </div>

            <div id="assistantBox" class="assistant-box" style="position: fixed; bottom: 2rem; right: 2rem; z-index: 1000; display: none; background-color: var(--card-background-color); backdrop-filter: blur(10px); padding: 1rem 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid var(--border-color); box-shadow: 0 4px 20px rgba(0,0,0,0.3); opacity: 0; transform: translateY(20px); transition: opacity 0.4s cubic-bezier(0.25, 1, 0.5, 1), transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); max-width: 400px; display: flex; align-items: center; gap: 1rem;">
                <span id="assistantMessageElement" style="margin: 0; color: var(--text-color);"></span>
            </div>

        </main>

        <footer class="app-footer">
            <p>¬© <span id="currentYear"></span> Mohamed Elmenisy - Elevo Core. All rights reserved.</p>
        </footer>
    </div>

    <script type="module">
        // --- Supabase Client Setup ---
        const SUPABASE_URL = 'https://aefiigottnlcmjzilqnh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlZmlpZ290dG5sY21qemlscW5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNzY2MDQsImV4cCI6MjA2Mjc1MjYwNH0.FypB02v3tGMnxXV9ZmZMdMC0oQpREKOJWgHMPxUzwX4';
        
        let supabase;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (error) {
            console.error("Supabase client initialization failed:", error);
            document.getElementById('auth-loading')?.remove();
            document.querySelector('.app-main').innerHTML = '<p style="color:var(--danger-color); text-align:center; font-size: 1.2rem;">Error connecting to services. Core Flow is unavailable.</p>';
        }

        // --- DOM Elements ---
        // Most elements are the same, just keeping the script clean
        const authLoadingDiv = document.getElementById('auth-loading');
        const initialViewDiv = document.getElementById('initial-view');
        const callFlowViewDiv = document.getElementById('call-flow-view');
        const postCallSummaryDiv = document.getElementById('postCallSummary');
        const receiveCallBtn = document.getElementById('receive-call-btn');
        const scenarioTitleElement = document.getElementById('scenario-title');
        const stepTypeIconElement = document.getElementById('step-type-icon'); 
        const stepsContainer = document.getElementById('steps-container'); 
        const decisionButtonsContainer = document.getElementById('decision-buttons-container'); 
        const prevStepBtn = document.getElementById('prev-step-btn');
        const nextStepBtn = document.getElementById('next-step-btn'); 
        const endCallBtn = document.getElementById('end-call-btn');
        const userInfoDiv = document.getElementById('userInfo');
        const userNameSpan = document.getElementById('userName');
        const logoutButton = document.getElementById('logoutButton');
        const dashboardLink = document.getElementById('dashboardLink');
        const systemStatusDiv = document.getElementById('systemStatus');
        const callTimerDiv = document.getElementById('callTimer');
        const assistantBox = document.getElementById('assistantBox');
        const assistantMessageElement = document.getElementById('assistantMessageElement');
        const callSummaryContentDiv = document.getElementById('callSummaryContent');
        const returnToInitialViewBtn = document.getElementById('returnToInitialViewBtn');
        const callStartSound = document.getElementById('callStartSound'); 
        const compensationScenarioSound = document.getElementById('compensationScenarioSound');
        const scenarioFilterInput = document.getElementById('scenarioFilter');
        const customScenarioList = document.getElementById('customScenarioList');
        const scenarioDropdownValue = document.getElementById('scenarioDropdownValue');

        document.getElementById('currentYear').textContent = new Date().getFullYear();

        // --- State Variables ---
        let currentUser = null; 
        let currentScenario = null; 
        let currentStepId = null;   
        let stepHistory = [];       
        let callSessionId = null;    
        let callStartTimeISO = null; 
        let stepTimerInterval = null;
        let stepStartTime = 0;      
        let accumulatedStepDurations = {}; 
        let stepVisitCount = {}; 
        const MAX_STEP_VISITS = 5;
        let allScenarios = [];

        const SESSION_STATE_KEY = 'elevoCoreActiveCallState_v5';

        // --- UI Helper Functions ---
        // (setButtonLoadingState, updateSystemStatus, etc. are kept from previous version)
        function setButtonLoadingState(buttonElement, isLoading, defaultText = "Submit", loadingText = "Loading...") {
            const btnTextElement = buttonElement.querySelector('.btn-text');
            let spinner = buttonElement.querySelector('.btn-spinner');

            if (isLoading) {
                buttonElement.disabled = true;
                if (btnTextElement) btnTextElement.style.display = 'none';
                if (!spinner) {
                    spinner = document.createElement('span');
                    spinner.className = 'btn-spinner';
                    buttonElement.prepend(spinner);
                }
                spinner.style.display = 'inline-block';
            } else {
                buttonElement.disabled = false;
                if (btnTextElement) btnTextElement.style.display = 'inline-block';
                if (spinner) spinner.style.display = 'none';
            }
        }
        function updateSystemStatus(statusText, statusClass = 'status-waiting') {
            if (systemStatusDiv) {
                systemStatusDiv.textContent = statusText;
                systemStatusDiv.className = `status-indicator ${statusClass}`;
            }
        }
        function animateView(viewElement) {
            if (viewElement) {
                viewElement.classList.remove('fade-in');
                void viewElement.offsetWidth; 
                viewElement.classList.add('fade-in');
                viewElement.style.display = 'grid'; // Use grid for the new initial card
                if(viewElement.id !== 'initial-view') viewElement.style.display = 'block';
            }
        }
        
        let assistantTimeout = null;
        function showAssistantMessage(message, isSticky = false, duration = 5000) {
            if (!assistantBox || !assistantMessageElement) return;
            clearTimeout(assistantTimeout);
            assistantMessageElement.textContent = message;
            assistantBox.style.display = 'flex';
            setTimeout(() => {
                assistantBox.style.opacity = '1';
                assistantBox.style.transform = 'translateY(0)';
            }, 10);
            if (!isSticky) {
                assistantTimeout = setTimeout(hideAssistant, duration);
            }
        }

        function hideAssistant() {
             if (!assistantBox) return;
             assistantBox.style.opacity = '0';
             assistantBox.style.transform = 'translateY(20px)';
             setTimeout(() => { 
                if (assistantBox.style.opacity === '0') {
                    assistantBox.style.display = 'none';
                }
             }, 400);
        }

        // --- Authentication and Initialization ---
        async function initializeApp() {
            if (!supabase) return;
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.replace('login.html'); 
                return;
            }

            // Simplified user profile fetching from previous step
            try {
                let { data: profile, error } = await supabase.from('users').select('name, is_admin, role').eq('id', session.user.id).single();
                if (error && error.code !== 'PGRST116') throw error;
                if (!profile) { // Create profile if not exists
                    profile = { name: session.user.user_metadata?.full_name || session.user.email.split('@')[0], role: 'agent', is_admin: false };
                    await supabase.from('users').insert({ ...profile, id: session.user.id, email: session.user.email });
                }
                currentUser = { id: session.user.id, email: session.user.email, name: profile.name, isAdmin: profile.is_admin, role: profile.role };
            } catch (error) {
                console.error("CRITICAL: Failed to fetch/create user profile.", error);
                currentUser = { id: session.user.id, email: session.user.email, name: "Profile Error", isAdmin: false, role: 'agent', profileError: true };
            }
            
            userNameSpan.textContent = currentUser.name;
            userInfoDiv.style.display = 'flex';
            dashboardLink.style.display = currentUser.isAdmin ? 'inline-block' : 'none';
            
            if (restoreCallState()) { 
                switchToCallFlowView(false); 
                renderStep(); 
                updateSystemStatus("üü¢ In Ticket (Restored)", "status-in-call");
                authLoadingDiv.style.display = 'none';
            } else {
                switchToInitialView();
                await loadActiveScenarios();
                authLoadingDiv.style.display = 'none';
                showAssistantMessage("Welcome! Ready for the next ticket.", false, 6000);
            }
        }
        
        function switchToInitialView() {
            callFlowViewDiv.style.display = 'none';
            postCallSummaryDiv.style.display = 'none';
            callTimerDiv.style.display = 'none';
            animateView(initialViewDiv);
            hideAssistant(); 
        }

        function switchToCallFlowView(animate = true) {
            initialViewDiv.style.display = 'none';
            postCallSummaryDiv.style.display = 'none';
            if (animate) animateView(callFlowViewDiv);
            else callFlowViewDiv.style.display = 'block';
            hideAssistant();
        }

        function switchToSummaryView() {
            initialViewDiv.style.display = 'none';
            callFlowViewDiv.style.display = 'none';
            callTimerDiv.style.display = 'none';
            animateView(postCallSummaryDiv);
            hideAssistant(); 
        }

        // --- UI UPGRADE: Professional SVG Icons ---
        const ICONS = {
            compensation: `<svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>`,
            inquiry: `<svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.89 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>`,
            complaint: `<svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>`,
            default: `<svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V6h5.17l2 2H20v10z"/></svg>`
        };

        async function loadActiveScenarios() {
            setButtonLoadingState(receiveCallBtn, true);
            customScenarioList.innerHTML = '<div class="scenario-item" role="option">Loading...</div>';
            scenarioDropdownValue.value = '';

            try {
                const { data: scenarios, error } = await supabase.from('call_scenarios_with_creator')
                    .select('id, title').eq('is_active', true).order('created_at', { ascending: false });
                if (error) throw error;
                
                allScenarios = scenarios || [];
                renderScenarioList(allScenarios);

            } catch (err) {
                console.error("Error loading scenarios:", err);
                customScenarioList.innerHTML = `<div class="scenario-item" role="option">‚ö†Ô∏è Failed to load scenarios.</div>`;
            } finally {
                setButtonLoadingState(receiveCallBtn, false, "Start Ticket");
                receiveCallBtn.disabled = true;
            }
        }
        
        function renderScenarioList(scenarios) {
            customScenarioList.innerHTML = '';
            if (scenarios.length > 0) {
                scenarios.forEach((s, index) => {
                    const item = document.createElement('div');
                    item.className = 'scenario-item';
                    item.dataset.value = s.id;
                    item.setAttribute('role', 'option');
                    item.setAttribute('tabindex', '0');
                    item.id = `scenario-option-${index}`;

                    let iconSvg = ICONS.default;
                    const titleLower = s.title.toLowerCase();
                    if (titleLower.includes('compensation')) {
                        iconSvg = ICONS.compensation;
                        item.classList.add('compensation');
                    } else if (titleLower.includes('inquiry')) {
                        iconSvg = ICONS.inquiry;
                    } else if (titleLower.includes('complaint')) {
                        iconSvg = ICONS.complaint;
                    }

                    const titleSpan = document.createElement('span');
                    titleSpan.textContent = s.title;
                    
                    item.innerHTML = iconSvg; // Add icon first
                    item.appendChild(titleSpan);
                    
                    item.addEventListener('click', () => selectScenario(item));
                    customScenarioList.appendChild(item);
                });
            } else {
                customScenarioList.innerHTML = '<div class="scenario-item" role="option">No matching scenarios found.</div>';
            }
        }
        
        function selectScenario(itemElement) {
             // (Same logic as before, works perfectly)
            if (!itemElement) return;
            const currentlySelected = customScenarioList.querySelector('.selected');
            if (currentlySelected) {
                currentlySelected.classList.remove('selected');
                currentlySelected.setAttribute('aria-selected', 'false');
            }
            itemElement.classList.add('selected');
            itemElement.setAttribute('aria-selected', 'true');
            scenarioDropdownValue.value = itemElement.dataset.value;
            receiveCallBtn.disabled = false;
        }
        
        // (Event listeners for filter and keyboard navigation are unchanged)
        scenarioFilterInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredScenarios = allScenarios.filter(s => s.title.toLowerCase().includes(searchTerm));
            renderScenarioList(filteredScenarios);
        });
        customScenarioList.addEventListener('keydown', (e) => {
            const items = Array.from(customScenarioList.querySelectorAll('.scenario-item'));
            if(items.length === 0) return;
            const currentIndex = items.findIndex(item => item === document.activeElement);
            if(e.key === 'ArrowDown') { e.preventDefault(); items[(currentIndex + 1) % items.length].focus(); }
            else if(e.key === 'ArrowUp') { e.preventDefault(); items[(currentIndex - 1 + items.length) % items.length].focus(); }
            else if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); if(currentIndex > -1) { selectScenario(items[currentIndex]); receiveCallBtn.focus(); }}
        });

        receiveCallBtn.addEventListener('click', async () => {
            const selectedScenarioId = scenarioDropdownValue.value;
            if (!selectedScenarioId) {
                showAssistantMessage("‚ö†Ô∏è Please select a scenario first.", false, 5000);
                return;
            }
            setButtonLoadingState(receiveCallBtn, true, "Start Ticket", "Starting...");
            if(callStartSound) callStartSound.play().catch(e => console.warn("Audio play failed:", e.message));

            resetCallState(); 
            switchToCallFlowView();
            updateSystemStatus("üü° Loading Scenario...", "status-loading");
            // (Same logic for starting a call from previous version)
            try {
                const { data: scenarioData, error: scenarioError } = await supabase.from('call_scenarios').select('id, title, steps').eq('id', selectedScenarioId).single();
                if (scenarioError) throw scenarioError;
                if (!scenarioData || !Array.isArray(scenarioData.steps) || scenarioData.steps.length === 0) {
                    throw new Error("Scenario data is invalid or has no valid steps.");
                }

                currentScenario = scenarioData; 
                currentStepId = currentScenario.steps[0].id; 
                accumulatedStepDurations = {}; 
                stepVisitCount = {};
                currentScenario.steps.forEach(step => { if(step?.id) accumulatedStepDurations[step.id] = 0; });

                callStartTimeISO = new Date().toISOString(); 
                const { data: newSession, error: sessionInsertError } = await supabase.from('call_sessions').insert({ user_id: currentUser.id, scenario_id: currentScenario.id, start_time: callStartTimeISO, agent_name: currentUser.name, agent_email: currentUser.email }).select('id').single();
                if (sessionInsertError) throw sessionInsertError;
                callSessionId = newSession.id;
                
                const selectedItem = document.querySelector(`.scenario-item[data-value="${selectedScenarioId}"]`);
                if (selectedItem && selectedItem.classList.contains('compensation')) {
                    if (compensationScenarioSound) compensationScenarioSound.play().catch(e => console.warn("Compensation sound failed:", e));
                    scenarioTitleElement.classList.add('highlight-scenario-title-animation');
                    setTimeout(() => scenarioTitleElement.classList.remove('highlight-scenario-title-animation'), 1200);
                }
                updateSystemStatus("üü¢ In Ticket", "status-in-call");
                renderStep(); 
                setButtonLoadingState(receiveCallBtn, false, "Start Ticket");
                receiveCallBtn.disabled = true;
            } catch (err) {
                console.error("Error starting ticket:", err);
                resetCallState(); 
                switchToInitialView();
                showAssistantMessage(`‚ö†Ô∏è Error: ${err.message}.`, false, 7000);
                await loadActiveScenarios();
            }
        });

        function renderStep() {
            // (Core logic is the same)
            const stepObject = currentScenario.steps.find(s => s?.id === currentStepId);
            if (!stepObject) {
                finishCall(false, `Error: Step ${currentStepId} not found`);
                return;
            }
            scenarioTitleElement.innerHTML = `<span id="step-type-icon" class="step-type-icon">${(stepObject.type === 'decision' || stepObject.options?.length > 0) ? 'ü§î' : 'üó£Ô∏è'}</span> ${currentScenario.title}`;
            stepsContainer.textContent = stepObject.text; // Safer than innerHTML
            decisionButtonsContainer.innerHTML = '';
            prevStepBtn.style.display = stepHistory.length > 0 ? 'inline-flex' : 'none';
            endCallBtn.style.display = 'inline-flex';

            if (stepObject.type === 'decision' && Array.isArray(stepObject.options)) {
                nextStepBtn.style.display = 'none'; 
                stepObject.options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'decision-button';
                    const labelLower = option.label.toLowerCase();
                    let iconHtml = '';
                    if (labelLower.includes('yes') || labelLower.includes('confirm')) {
                        button.classList.add('positive');
                        iconHtml = `<svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>`;
                    } else if (labelLower.includes('no') || labelLower.includes('cancel')) {
                        button.classList.add('negative');
                        iconHtml = `<svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>`;
                    } else { button.classList.add('neutral'); }
                    button.innerHTML = `${iconHtml}<span>${option.label}</span>`;
                    button.addEventListener('click', () => navigateToStep(option.next_id));
                    decisionButtonsContainer.appendChild(button);
                });
            } else {
                 // (Same logic as before)
                nextStepBtn.style.display = 'inline-flex';
                nextStepBtn.querySelector('.btn-text').textContent = stepObject.next_id ? "Next Step" : "Finish Scenario";
            }
            startStepTimer();
            saveCallState();
        }

        // --- All other functions (navigateToStep, startStepTimer, finishCall, saveCallState, etc.)
        // --- are identical to the previous robust version and are omitted here for brevity.
        // --- They are assumed to be present and unchanged below this point.
        function navigateToStep(nextId) {
            stepVisitCount[currentStepId] = (stepVisitCount[currentStepId] || 0) + 1;
            if (stepVisitCount[currentStepId] > MAX_STEP_VISITS) {
                finishCall(false, `Ticket ended: Repetitive loop detected.`);
                return;
            }
            document.getElementById('call-flow-view').classList.add('decision-made-animation');
            setTimeout(() => document.getElementById('call-flow-view').classList.remove('decision-made-animation'), 700);

            stopAndRecordStepTimer();
            if (nextId === null || typeof nextId === 'undefined' || nextId === "") { 
                finishCall(true, "Reached end of scenario path."); 
                return;
            }
            const targetStep = currentScenario.steps.find(s => s?.id === nextId); 
            if (!targetStep) {
                finishCall(false, `Error: Path broken, step ${nextId} not found.`);
                return;
            }
            stepHistory.push(currentStepId); 
            currentStepId = nextId;
            renderStep();
        }
        nextStepBtn.addEventListener('click', () => {
            const stepObject = currentScenario.steps.find(s => s?.id === currentStepId); 
            if (stepObject) navigateToStep(stepObject.next_id);
        });
        prevStepBtn.addEventListener('click', () => {
            stopAndRecordStepTimer(); 
            if (stepHistory.length > 0) { currentStepId = stepHistory.pop(); renderStep(); }
        });
        endCallBtn.addEventListener('click', () => { stopAndRecordStepTimer(); finishCall(false, "Ticket ended by agent"); });

        function startStepTimer() {
            callTimerDiv.style.display = 'inline-block'; 
            if (stepTimerInterval) clearInterval(stepTimerInterval);
            stepStartTime = Date.now();
            const updateTimerDisplay = () => {
                const totalSeconds = callStartTimeISO ? Math.floor((Date.now() - new Date(callStartTimeISO)) / 1000) : 0;
                const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
                const seconds = String(totalSeconds % 60).padStart(2, '0');
                callTimerDiv.textContent = `${minutes}:${seconds}`;
            };
            updateTimerDisplay(); 
            stepTimerInterval = setInterval(updateTimerDisplay, 1000);
        }

        function stopAndRecordStepTimer() {
            if (stepTimerInterval) clearInterval(stepTimerInterval);
            stepTimerInterval = null;
            if (stepStartTime > 0 && currentStepId && accumulatedStepDurations.hasOwnProperty(currentStepId)) {
                accumulatedStepDurations[currentStepId] += Math.floor((Date.now() - stepStartTime) / 1000);
            }
            stepStartTime = 0; 
        }

        async function finishCall(completed, reasonText) { 
            stopAndRecordStepTimer(); 
            hideAssistant();
            const endTimeISO = new Date().toISOString();
            const durationInSeconds = callStartTimeISO ? Math.floor((new Date(endTimeISO) - new Date(callStartTimeISO)) / 1000) : 0;
            const quality = completed ? 'Good' : (durationInSeconds > 0 ? 'Bad' : 'N/A'); 
            const reason = reasonText || (completed ? 'Scenario completed.' : 'Ticket ended prematurely.');
            updateSystemStatus(completed ? "‚úÖ Completed" : "‚ö™ Ended", completed ? "status-completed" : "status-ended");
            if (callSessionId) {
                await supabase.from('call_sessions').update({ end_time: endTimeISO, duration: durationInSeconds, completed: completed, call_quality: quality, quality_reason: reason }).eq('id', callSessionId);
            }
            displayPostCallSummary(quality, reason, durationInSeconds);
            clearCallState(); 
        }
        function displayPostCallSummary(quality, reason, totalDurationSeconds) {
            let summaryHTML = `<p><strong>Ticket Quality:</strong> <span class="quality-text quality-${quality?.toLowerCase() || 'na'}">${quality || 'N/A'}</span></p> <p><strong>Reason:</strong> ${reason || "N/A"}</p> <p><strong>Total Handle Time:</strong> ${Math.floor(totalDurationSeconds / 60)}m ${totalDurationSeconds % 60}s</p><hr style="margin: 1rem 0; border-color: var(--border-color);"><p><strong>Time Spent on Steps:</strong></p><ul style="list-style: none; padding-left: 0;">`;
            if (currentScenario?.steps) {
                let visitedSteps = [...new Set([...stepHistory, currentStepId])].filter(id => id != null);
                visitedSteps.forEach(stepId => {
                    const stepObject = currentScenario.steps.find(s => s?.id === stepId); 
                    const duration = accumulatedStepDurations[stepId] || 0;
                    if (stepObject && duration > 0) {
                        summaryHTML += `<li style="margin-bottom: 0.3rem;">"${stepObject.text.substring(0,30)}...": <strong>${Math.floor(duration / 60)}m ${duration % 60}s</strong></li>`;
                    }
                });
            } else { summaryHTML += `<li>No step data available.</li>`; }
            summaryHTML += `</ul>`;
            callSummaryContentDiv.innerHTML = summaryHTML;
            switchToSummaryView();
        }
        returnToInitialViewBtn.addEventListener('click', async () => {
            resetCallState(true); 
            await loadActiveScenarios();
            showAssistantMessage("üí° Ready for the next ticket!", false, 7000);
        });

        function saveCallState() {
            if (!callSessionId) return;
            const state = { callSessionId, currentScenario, currentStepId, stepHistory, accumulatedStepDurations, callStartTimeISO, stepVisitCount, timestamp: Date.now() };
            try { sessionStorage.setItem(SESSION_STATE_KEY, JSON.stringify(state)); } catch (e) { console.error("Error saving state:", e); }
        }
        function restoreCallState() {
            try {
                const savedState = JSON.parse(sessionStorage.getItem(SESSION_STATE_KEY));
                if (!savedState || !savedState.callSessionId) return false;
                callSessionId = savedState.callSessionId;
                currentScenario = savedState.currentScenario; 
                currentStepId = savedState.currentStepId;
                stepHistory = savedState.stepHistory;
                accumulatedStepDurations = savedState.accumulatedStepDurations;
                callStartTimeISO = savedState.callStartTimeISO; 
                stepVisitCount = savedState.stepVisitCount || {};
                startStepTimer(); // Resume timer
                return true;
            } catch (e) { clearCallState(); return false; }
        }
        function clearCallState() { sessionStorage.removeItem(SESSION_STATE_KEY); callSessionId = null; }
        function resetCallState(switchToInitial = false) {
            stopAndRecordStepTimer(); clearCallState(); currentScenario = null; stepHistory = []; accumulatedStepDurations = {}; stepVisitCount = {}; callStartTimeISO = null;
            if (switchToInitial) switchToInitialView();
        }
        logoutButton.addEventListener('click', async () => {
            resetCallState(); localStorage.removeItem('elevoCoreUserData'); if (supabase) await supabase.auth.signOut(); window.location.replace("login.html");
        });
        window.addEventListener('beforeunload', () => { if (callSessionId) saveCallState(); });
        
        if (supabase) initializeApp();

    </script>
</body>
</html>
