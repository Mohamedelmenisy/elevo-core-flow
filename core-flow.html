<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Core Flow — Audit / Live Steps</title>
  <style>
    :root{--bg:#0f1724;--card:#111827;--muted:#9ca3af;--accent:#7c3aed;--success:#16a34a}
    body{font-family:Inter, system-ui, sans-serif;background:#0b1220;color:#e6eef8;margin:0;padding:24px}
    .container{max-width:1100px;margin:0 auto}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .meta{color:var(--muted)}
    .card{background:var(--card);padding:16px;border-radius:12px;margin-bottom:12px}
    #steps-container .step{padding:12px;border-radius:8px;margin-bottom:10px;background:transparent}
    .step.highlight{background:rgba(124,58,237,0.06);box-shadow:0 4px 18px rgba(2,6,23,0.4)}
    .small{font-size:13px;color:var(--muted)}
    button{background:var(--accent);color:white;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Core Flow — Live Scenario</h1>
        <div class="meta">التحديثات اللحظية للـ Knowledge Base مفعلة</div>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <div id="connection-status" class="small">status: <span id="status-dot">disconnected</span></div>
        <button id="btn-refresh">Refresh</button>
      </div>
    </header>

    <div id="case-card" class="card">
      <h2 id="case-title">—</h2>
      <div id="case-description" class="small">—</div>
    </div>

    <div id="steps-card" class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>الخطوات (Steps)</strong>
        <div class="small">data-case-slug: <span id="current-slug">-</span></div>
      </div>
      <div id="steps-container" data-case-slug="">
        <!-- سيتم إدراج محتوى الحالة هنا سواء كان HTML نصي أو عناصر الخطوات -->
      </div>
    </div>

    <div class="card">
      <div class="small">Console & debug:</div>
      <pre id="debug" style="height:140px;overflow:auto;background:#071023;padding:10px;border-radius:8px;margin-top:6px;color:#9fd2ff;font-size:12px"></pre>
    </div>
  </div>

  <script type="module">
    // ------------------------------------------------------------------
    // IMPORTANT: Replace these with your Supabase project's values
    // ------------------------------------------------------------------
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const SUPABASE_URL = 'https://aefiigottnlcmjzilqnh.supabase.co' // replace if needed
    const SUPABASE_ANON_KEY = 'REPLACE_WITH_YOUR_ANON_KEY' // replace with your anon key (or set via build/ENV)

    // If you prefer using the anon key you showed earlier, place it here.
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    // ------------------------------------------------------------------
    // Utility & UI helpers
    // ------------------------------------------------------------------
    const debugEl = document.getElementById('debug')
    function logDebug(...args){
      console.log(...args)
      const line = args.map(a=> typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ')
      debugEl.textContent = (debugEl.textContent ? debugEl.textContent + '\n' : '') + line
      debugEl.scrollTop = debugEl.scrollHeight
    }

    function setStatus(txt){
      document.getElementById('status-dot').textContent = txt
    }

    function quoteStringForFilter(s){
      if(s===null||s===undefined) return "''"
      return `'${String(s).replace(/'/g, "''")}'`
    }

    // ------------------------------------------------------------------
    // Realtime subscription management
    // ------------------------------------------------------------------
    let realtimeSubscription = null

    function unsubscribeFromCaseUpdates(){
      if(realtimeSubscription){
        try{ supabase.removeChannel(realtimeSubscription); logDebug('Unsubscribed channel') }catch(e){ console.warn('removeChannel failed', e); }
        realtimeSubscription = null
        setStatus('disconnected')
      }
    }

    function fallbackSubscribeAllCases(caseSlug){
      logDebug('Fallback: subscribing to broad updates and filtering client-side for', caseSlug)
      try{
        realtimeSubscription = supabase.channel('realtime-cases-flow-broad')
          .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'cases' }, (payload) => {
            const updated = payload.new
            if(!updated || !updated.slug) return
            if(updated.slug !== caseSlug) return // client-side guard
            handleIncomingCaseUpdate(updated, 'fallback')
          })
          .subscribe(status => {
            logDebug('fallback subscription status', status)
            setStatus(status === 'SUBSCRIBED' ? 'subscribed (fallback)' : status)
          })
      }catch(e){ logDebug('fallback subscribe error', e) }
    }

    function subscribeToCaseUpdates(caseSlug){
      if(!caseSlug){ logDebug('No caseSlug provided — cannot subscribe'); return }
      unsubscribeFromCaseUpdates()

      let safeFilter = `slug=eq.${caseSlug}`
      if(/[^a-zA-Z0-9_\-]/.test(caseSlug)){
        safeFilter = `slug=eq.${quoteStringForFilter(caseSlug)}`
      }

      try{
        realtimeSubscription = supabase.channel('realtime-cases-flow')
          .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'cases', filter: safeFilter }, (payload) => {
            const updatedCase = payload.new
            handleIncomingCaseUpdate(updatedCase, 'filtered')
          })
          .subscribe(status => {
            logDebug('filtered subscription status', status)
            setStatus(status === 'SUBSCRIBED' ? 'subscribed' : status)
            // fallback if server rejects our filter subscription
            if(status === 'CHANNEL_ERROR' || status === 'TIMED_OUT'){
              logDebug('Filtered subscription failed, falling back.')
              fallbackSubscribeAllCases(caseSlug)
            }
          })
      }catch(e){
        logDebug('Error creating filtered subscription', e)
        fallbackSubscribeAllCases(caseSlug)
      }
    }

    // ------------------------------------------------------------------
    // Handle incoming updates from Supabase
    // ------------------------------------------------------------------
    function handleIncomingCaseUpdate(updatedCase, source){
      if(!updatedCase) return
      logDebug(`[${source}] Detected update for case:`, updatedCase.slug)

      const slug = updatedCase.slug
      if(!slug) return

      // update title & description if present
      if(updatedCase.title_en) document.getElementById('case-title').textContent = updatedCase.title_en
      if(updatedCase.description_en) document.getElementById('case-description').textContent = updatedCase.description_en

      const stepsContainer = document.getElementById('steps-container')
      const wrapper = stepsContainer.querySelector('[data-case-slug="' + slug + '"]')
      if(wrapper){
        // If the case content is entire HTML snippet, replace innerHTML; otherwise put text
        if(updatedCase.content_en !== null && updatedCase.content_en !== undefined){
          try{
            wrapper.innerHTML = updatedCase.content_en
          }catch(e){
            wrapper.textContent = String(updatedCase.content_en || '')
          }
          // visual highlight
          wrapper.classList.add('highlight')
          setTimeout(()=> wrapper.classList.remove('highlight'), 1600)
          logDebug('Updated DOM for slug', slug)
        }
      } else {
        // If wrapper doesn't exist, create a simple container and append
        const el = document.createElement('div')
        el.className = 'step'
        el.setAttribute('data-case-slug', slug)
        el.innerHTML = updatedCase.content_en || '<div class="small">(No content)</div>'
        stepsContainer.prepend(el)
        el.classList.add('highlight')
        setTimeout(()=> el.classList.remove('highlight'), 1600)
        logDebug('Created new DOM entry for slug', slug)
      }
    }

    // ------------------------------------------------------------------
    // Helpers to detect current scenario / slug on page
    // ------------------------------------------------------------------
    function getCurrentCaseSlug(){
      // 1) dataset on steps container
      const sc = document.getElementById('steps-container')
      if(sc && sc.dataset && sc.dataset.caseSlug) return sc.dataset.caseSlug
      if(sc && sc.getAttribute('data-case-slug')) return sc.getAttribute('data-case-slug')

      // 2) global variable that might be set by your app
      if(window.currentScenario && window.currentScenario.case_slug) return window.currentScenario.case_slug

      // 3) localStorage fallback
      const ls = localStorage.getItem('currentCaseSlug')
      if(ls) return ls

      // 4) URL param fallback
      try{
        const qp = new URLSearchParams(window.location.search)
        if(qp.has('case_slug')) return qp.get('case_slug')
      }catch(e){}

      return null
    }

    async function fetchCaseAndRender(caseSlug){
      if(!caseSlug) return
      document.getElementById('current-slug').textContent = caseSlug
      // fetch from cases table to populate title/description/content
      try{
        const { data, error } = await supabase.from('cases').select('title_en,description_en,content_en,slug').eq('slug', caseSlug).limit(1).single()
        if(error){ logDebug('Error fetching case:', error); return }
        if(data){
          document.getElementById('case-title').textContent = data.title_en || '—'
          document.getElementById('case-description').textContent = data.description_en || ''

          // Put the content into steps-container inside a wrapper marked with data-case-slug
          const stepsContainer = document.getElementById('steps-container')
          stepsContainer.innerHTML = ''
          const wrap = document.createElement('div')
          wrap.className = 'step'
          wrap.setAttribute('data-case-slug', caseSlug)
          // content_en might be full HTML; insert as is
          wrap.innerHTML = data.content_en || '<div class="small">(No content)</div>'
          stepsContainer.appendChild(wrap)
          // ensure dataset is available on container
          stepsContainer.setAttribute('data-case-slug', caseSlug)
          logDebug('Rendered case from DB', caseSlug)
        }
      }catch(e){ logDebug('fetchCaseAndRender error', e) }
    }

    // ------------------------------------------------------------------
    // App initialization & events
    // ------------------------------------------------------------------
    async function initializeApp(){
      setStatus('initializing')
      const caseSlug = getCurrentCaseSlug()

      if(caseSlug){
        await fetchCaseAndRender(caseSlug)
        subscribeToCaseUpdates(caseSlug)
      } else {
        // Try to find an active scenario (you may want to change logic to match your app)
        try{
          const { data: scen, error } = await supabase.from('call_scenarios').select('case_slug,title,steps').not('case_slug','is',null).limit(1).single()
          if(error){ logDebug('No scenario found by default:', error); setStatus('no-case-found'); return }
          const slug = scen.case_slug
          if(slug){
            // set on container so subsequent loads use it
            document.getElementById('steps-container').setAttribute('data-case-slug', slug)
            document.getElementById('current-slug').textContent = slug
            await fetchCaseAndRender(slug)
            subscribeToCaseUpdates(slug)
          }
        }catch(e){ logDebug('initializeApp fallback error', e); setStatus('error') }
      }
    }

    // refresh button
    document.getElementById('btn-refresh').addEventListener('click', async ()=>{
      const slug = document.getElementById('steps-container').getAttribute('data-case-slug') || getCurrentCaseSlug()
      if(!slug) return logDebug('No slug available to refresh')
      unsubscribeFromCaseUpdates()
      await fetchCaseAndRender(slug)
      subscribeToCaseUpdates(slug)
      logDebug('Manual refresh complete for', slug)
    })

    // cleanup on unload
    window.addEventListener('beforeunload', ()=>{ unsubscribeFromCaseUpdates() })

    // start
    initializeApp()

  </script>
</body>
</html>
