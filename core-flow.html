<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elevo Core Assistant</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234e8cff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M3 12h18M3 6h12M3 18h15'/><path d='M17 9l4 3l-4 3'/></svg>">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
.card { max-width: 1100px; margin: 0 auto; }

        .card {
            max-width: 950px; /* MODIFIED: Increased width */
        }
    </style>
</head>
<body>

    <div class="app-container">
        <header class="app-header">
            <div class="logo-container">
                <svg class="company-logo" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: var(--primary-color); width: 28px; height: 28px;">
                    <path d="M6 17L10 17M6 12L12 12M6 7L14 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M15 6L19 10L15 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <rect x="3" y="3" width="18" height="18" rx="3" stroke="currentColor" stroke-width="1.5" fill="transparent" opacity="0.6"/>
                </svg>
                <span class="app-title" style="font-size: 1.2rem;">Elevo Core</span>
            </div>
            <div class="header-controls">
                 <!-- MODIFIED: Links will be shown/hidden based on user role by JS -->
                 <a href="dashboard.html" class="nav-link" id="dashboardLink" style="display: none;">Admin Dashboard</a>
                 <a href="rtm-dashboard.html" class="nav-link" id="rtmDashboardLink" style="display: none;">RTM Dashboard</a>
                 <a href="agent-portal.html" class="nav-link" id="agentPortalLink" style="display: none;">Agent Portal</a>
                <div class="user-info" id="userInfo" style="display: none;">
                    <span id="userName" class="user-name-display" style="margin-right: 1rem; color: var(--text-color-secondary);"></span>
                    <button id="logoutButton" class="logout-btn nav-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                        <span style="margin-left: 0.3em;">Logout</span>
                    </button>
                </div>
            </div>
        </header>

        <div class="status-bar">
            <div id="systemStatus" class="status-indicator status-waiting">🔴 Waiting for Ticket</div>
        </div>

        <div id="progressTracker" class="progress-tracker-container" style="display: none; max-width: 950px; width: 100%; margin-left: auto; margin-right: auto;">
             <div class="stepper-wrapper">
                 {/* Stepper will be dynamically generated here by JavaScript */}
            </div>
        </div>

         <div id="timer-container">
             <div id="callTimer" style="display: none;">00:00</div>
         </div>

        <main class="app-main">
            <div id="auth-loading" class="loading-container" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 50vh;">
                <div class="spinner" style="width: 40px; height: 40px; border-top-color: var(--primary-color);"></div>
                <p style="color: var(--text-color-secondary); margin-top: 1rem;">Initializing Assistant...</p>
            </div>

            <div id="initial-view" class="card initial-card fade-in" style="display: none;">
                <div class="card-icon" style="text-align: center; margin-bottom: 1rem;">
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="var(--primary-color)" width="48" height="48"><path d="M12 2C6.486 2 2 6.486 2 12C2 17.514 6.486 22 12 22C17.514 22 22 17.514 22 12C22 6.486 17.514 2 12 2ZM12 20C7.589 20 4 16.411 4 12C4 7.589 7.589 4 12 4C16.411 4 20 7.589 20 12C20 16.411 16.411 20 12 20Z"/><path d="M12 11C10.897 11 10 10.103 10 9C10 7.897 10.897 7 12 7C13.103 7 14 7.897 14 9C14 10.103 13.103 11 12 11ZM12 9C11.514 9 11.121 9.229 11.038 9.583L12.962 10.417C12.879 10.771 12.486 11 12 11C11.448 11 11 10.552 11 10C11 9.448 11.448 9 12 9Z"/><path d="M16.002 16.246C15.483 15.219 14.544 14.5 13.333 14.5H10.667C9.456 14.5 8.517 15.219 7.998 16.246C7.933 16.386 7.996 16.553 8.114 16.641C8.657 17.053 9.737 17.5 12 17.5C14.263 17.5 15.343 17.053 15.886 16.641C16.004 16.553 16.067 16.386 16.002 16.246Z"/></svg>
                </div>
                <h2 class="card-title" style="text-align: center;">Core Flow Assistant</h2>
                <p class="card-subtitle" style="text-align: center;">Select a scenario to start the ticket.</p>

                <div class="scenario-selector-container" style="margin-top: 1.5rem; margin-bottom: 1.5rem;">
                    <label for="scenarioDropdown" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-color-secondary);">Select Scenario:</label>
                    <select id="scenarioDropdown" class="scenario-dropdown">
                        <option value="">Loading scenarios...</option>
                    </select>
                </div>

                <div id="assistantBox" class="assistant-box" style="display: none; background-color: var(--input-bg-color); padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; border-left: 4px solid var(--primary-color);">
                    <span class="assistant-icon" style="margin-right: 0.5rem; font-size: 1.2rem;">💡</span>
                    <p id="assistantMessageElement" style="margin: 0; color: var(--text-color);">Welcome to Elevo Core!</p>
                </div>

                <button id="receive-call-btn" class="action-button primary-button" disabled style="width: 100%;">
                    <span class="btn-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M6.05828 11.0452L4.00001 9.00002C4.00001 9.00002 3.58101 8.99902 3.51201 9.00002C2.04801 9.02602 1.00001 10.318 1.00001 11.785V12.214C1.00001 13.682 2.04801 14.973 3.51201 15H4.00001L6.05828 12.9548C6.12828 12.8848 6.16728 12.7948 6.16728 12C6.16728 11.2052 6.12828 11.1152 6.05828 11.0452ZM20.488 15H21C22.464 14.974 23.512 13.682 23.512 12.215V11.785C23.512 10.318 22.464 9.02602 21 9.00002C20.998 8.99902 20 9.00002 20 9.00002L17.9417 11.0452C17.8717 11.1152 17.8327 11.2052 17.8327 12C17.8327 12.7948 17.8717 12.8848 17.9417 12.9548L20.488 15Z"/><path d="M19.6623 5.08431C19.8803 5.08431 20.0943 5.17031 20.2503 5.32631L21.6743 6.74931C21.9863 7.06231 21.9863 7.56731 21.6743 7.87931C19.4003 10.1523 19.4003 13.8473 21.6743 16.1203C21.9863 16.4323 21.9863 16.9373 21.6743 17.2503L20.2503 18.6733C20.0943 18.8293 19.8803 18.9153 19.6623 18.9153C19.4443 18.9153 19.2303 18.8293 19.0743 18.6733C16.2573 15.8563 16.2573 8.14331 19.0743 5.32631C19.2303 5.17031 19.4443 5.08431 19.6623 5.08431ZM4.92575 5.32631C5.52575 4.72631 6.45075 4.72631 7.05075 5.32631C9.86775 8.14331 9.86775 15.8563 7.05075 18.6733C6.89475 18.8293 6.68075 18.9153 6.46275 18.9153C6.24475 18.9153 6.03075 18.8293 5.87475 18.6733L4.45075 17.2503C4.13875 16.9373 4.13875 16.4323 4.45075 16.1203C6.72375 13.8473 6.72375 10.1523 4.45075 7.87931C4.13875 7.56731 4.13875 7.06231 4.45075 6.74931L5.87475 5.32631C5.71875 5.17031 4.76975 5.17031 4.92575 5.32631Z"/></svg>
                    </span>
                    <span class="btn-text">Receive Ticket</span>
                </button>
                <audio id="callStartSound" src="call_sound.mp3" preload="auto"></audio>
                <audio id="compensationScenarioSound" src="compensation_alert.mp3" preload="auto"></audio>
            </div>

            <div id="call-flow-view" class="card call-flow-card fade-in" style="display: none;">
                <h3 id="scenario-title" class="card-title scenario-title-dynamic"><span id="step-type-icon" class="step-type-icon"></span>Ticket Scenario</h3>
                <div id="steps-container" class="steps-area" style="margin-bottom: 1.5rem; font-size: 0.95rem; line-height: 1.7; color: var(--text-color-secondary);">
                    <p class="placeholder-text">Loading ticket steps...</p>
                </div>
                <div id="decision-buttons-container" class="step-actions"></div>

                <div class="navigation-buttons" style="margin-top: 1.5rem; display: flex; gap: 0.75rem;">
                    <button id="prev-step-btn" class="nav-button secondary-button" style="display: none; flex-grow: 1;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 0.5em;"><polyline points="15 18 9 12 15 6"></polyline></svg>
                        <span>Previous</span>
                    </button>
                    <button id="next-step-btn" class="nav-button primary-button" style="flex-grow: 1;">
                        <span class="btn-text">Next Step</span>
                        <span class="btn-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </span>
                    </button>
                </div>
                 <button id="end-call-btn" class="nav-button danger-button" style="display: none; width: 100%; margin-top: 0.75rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 0.5em;"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    <span>End Ticket</span>
                </button>
            </div>

            <div id="postCallSummary" class="card post-call-summary-card fade-in" style="display: none;">
                <h3 class="card-title">Ticket Summary</h3>
                <div id="callSummaryContent" style="color: var(--text-color-secondary);">
                    {/* Content will be injected by JS */}
                </div>
                <button id="returnToInitialViewBtn" class="action-button primary-button" style="margin-top: 1.5rem; width: 100%;">
                    <span class="btn-text">New Ticket</span>
                </button>
            </div>
        </main>

        <footer class="app-footer">
            <p>© <span id="currentYear"></span> Mohamed Elmenisy - Elevo Core. All rights reserved.</p>
        </footer>
    </div>

    <script type="module">
        // --- Supabase Client Setup ---
        const SUPABASE_URL = 'https://aefiigottnlcmjzilqnh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlZmlpZ290dG5sY21qemlscW5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNzY2MDQsImV4cCI6MjA2Mjc1MjYwNH0.FypB02v3tGMnxXV9ZmZMdMC0oQpREKOJWgHMPxUzwX4';
        
        let supabase;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (error) {
            console.error("Supabase client initialization failed:", error);
            document.getElementById('auth-loading').innerHTML = '<p style="color:var(--danger-color); text-align:center;">Error connecting to services.</p>';
        }

        // --- DOM Elements ---
        const authLoadingDiv = document.getElementById('auth-loading');
        const initialViewDiv = document.getElementById('initial-view');
        const callFlowViewDiv = document.getElementById('call-flow-view');
        const postCallSummaryDiv = document.getElementById('postCallSummary');
        
        const scenarioDropdown = document.getElementById('scenarioDropdown');
        const receiveCallBtn = document.getElementById('receive-call-btn');
        const scenarioTitleElement = document.getElementById('scenario-title');
        const stepTypeIconElement = document.getElementById('step-type-icon'); 
        const stepsContainer = document.getElementById('steps-container'); 
        const decisionButtonsContainer = document.getElementById('decision-buttons-container'); 
        const prevStepBtn = document.getElementById('prev-step-btn');
        const nextStepBtn = document.getElementById('next-step-btn'); 
        const endCallBtn = document.getElementById('end-call-btn');
        
        const userInfoDiv = document.getElementById('userInfo');
        const userNameSpan = document.getElementById('userName');
        const logoutButton = document.getElementById('logoutButton');
        const dashboardLink = document.getElementById('dashboardLink');
        const rtmDashboardLink = document.getElementById('rtmDashboardLink');
        const agentPortalLink = document.getElementById('agentPortalLink');
        
        const systemStatusDiv = document.getElementById('systemStatus');
        const callTimerDiv = document.getElementById('callTimer');
        const progressTrackerContainer = document.getElementById('progressTracker');
        
        const assistantBox = document.getElementById('assistantBox');
        const assistantMessageElement = document.getElementById('assistantMessageElement');
        
        const callSummaryContentDiv = document.getElementById('callSummaryContent');
        const returnToInitialViewBtn = document.getElementById('returnToInitialViewBtn');
        const callStartSound = document.getElementById('callStartSound'); 
        const compensationScenarioSound = document.getElementById('compensationScenarioSound');
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        // --- State Variables ---
        let currentUser = null; 
        let currentScenario = null; 
        let currentStepId = null;   
        let stepHistory = [];       
        let currentStepIndexForProgressBar = 0; 

        let callSessionId = null;    
        let callStartTimeISO = null; 
        let stepTimerInterval = null;
        let stepStartTime = 0;      
        let accumulatedStepDurations = {}; 

        const SESSION_STATE_KEY = 'elevoCoreActiveCallState_v3'; 

        // --- UI Helper Functions ---
        function setButtonLoadingState(buttonElement, isLoading, defaultText = "Submit", loadingText = "Loading...") {
            const btnTextElement = buttonElement.querySelector('.btn-text');
            const btnIconElement = buttonElement.querySelector('.btn-icon');
            let spinner = buttonElement.querySelector('.btn-spinner');

            if (isLoading) {
                buttonElement.disabled = true;
                if (btnTextElement) btnTextElement.textContent = loadingText;
                if (btnIconElement) btnIconElement.style.display = 'none';
                if (!spinner) {
                    spinner = document.createElement('span');
                    spinner.className = 'btn-spinner';
                    buttonElement.insertBefore(spinner, btnTextElement || btnIconElement);
                }
                spinner.style.display = 'inline-block';
            } else {
                buttonElement.disabled = false;
                if (btnTextElement) btnTextElement.textContent = defaultText;
                if (btnIconElement) btnIconElement.style.display = 'inline-flex';
                if (spinner) spinner.style.display = 'none';
            }
        }


        function updateSystemStatus(statusText, statusClass = 'status-waiting') {
            if (systemStatusDiv) {
                systemStatusDiv.textContent = statusText;
                systemStatusDiv.className = `status-indicator ${statusClass}`;
            }
        }

        function animateView(viewElement) {
            if (viewElement) {
                viewElement.classList.remove('fade-in');
                void viewElement.offsetWidth; 
                viewElement.classList.add('fade-in');
                viewElement.style.display = 'block';
            }
        }
        
        let assistantTimeout = null;
        let typingInterval = null;

        function typeWriterEffect(element, message, speed = 30, callback) {
            if (typingInterval) clearInterval(typingInterval);
            element.textContent = '';
            let i = 0;
            typingInterval = setInterval(() => {
                if (i < message.length) { element.textContent += message.charAt(i); i++; }
                else { clearInterval(typingInterval); typingInterval = null; if (callback) callback(); }
            }, speed);
        }
        
        function showAssistantMessage(message, isInitial = false, duration = 5000, onHideCallback = null) {
            if (!assistantBox || !assistantMessageElement) return;
            clearTimeout(assistantTimeout);
            if (typingInterval) clearInterval(typingInterval);
            assistantBox.classList.remove('show', 'assistant-initial-position'); 
            void assistantBox.offsetWidth; 
            if (isInitial) assistantBox.classList.add('assistant-initial-position');
            else assistantBox.classList.add('show'); 
            assistantBox.style.display = 'flex';
            typeWriterEffect(assistantMessageElement, message, 30, () => {
                if (duration > 0) {
                    assistantTimeout = setTimeout(() => {
                        hideAssistant(isInitial);
                        if (onHideCallback) onHideCallback();
                    }, duration);
                }
            });
        }

        function hideAssistant(wasInitial = false) {
             if (!assistantBox) return;
             if (wasInitial) assistantBox.classList.remove('assistant-initial-position');
             else assistantBox.classList.remove('show');
             setTimeout(() => { 
                if (!assistantBox.classList.contains('show') && !assistantBox.classList.contains('assistant-initial-position')) {
                    assistantBox.style.display = 'none';
                }
             }, wasInitial ? 0 : 400); 
        }

        async function initializeApp() {
            if (!supabase) { 
                 authLoadingDiv.innerHTML = '<p style="color:var(--danger-color); text-align:center;">Services unavailable.</p>';
                 return;
            }
            const { data: { session }, error: sessionError } = await supabase.auth.getSession();
            if (sessionError || !session) {
                window.location.replace('login.html'); 
                return;
            }

            const storedUserData = JSON.parse(localStorage.getItem('elevoCoreUserData'));
            if (storedUserData && storedUserData.id === session.user.id) {
                currentUser = storedUserData;
            } else {
                try {
                    const { data: profile, error } = await supabase.from('users').select('name, is_admin').eq('id', session.user.id).single();
                    if (error) throw error;
                    currentUser = { id: session.user.id, email: session.user.email, name: profile.name, isAdmin: profile.is_admin };
                    localStorage.setItem('elevoCoreUserData', JSON.stringify(currentUser));
                } catch (error) {
                    console.error("Failed to fetch user profile:", error);
                    currentUser = { id: session.user.id, email: session.user.email, name: session.user.email.split('@')[0], isAdmin: false, profileError: true };
                }
            }

            userNameSpan.textContent = currentUser.name;
            userInfoDiv.style.display = 'flex';
            
            // MODIFIED: User Permissions
            if (currentUser.isAdmin) {
                if (dashboardLink) dashboardLink.style.display = 'inline-block';
                if (rtmDashboardLink) rtmDashboardLink.style.display = 'inline-block';
            }
            agentPortalLink.style.display = 'inline-block'; // Visible for all users
            
            authLoadingDiv.style.display = 'none';
            
            if (restoreCallState()) { 
                switchToCallFlowView(false); 
                renderStep(); 
                updateSystemStatus("🟢 In Ticket (Restored)", "status-in-call");
            } else {
                switchToInitialView();
                await loadActiveScenarios();
                showAssistantMessage("Welcome! Select a scenario to begin.", true, 7000);
            }
        }

        function switchToInitialView() {
            callFlowViewDiv.style.display = 'none';
            postCallSummaryDiv.style.display = 'none';
            progressTrackerContainer.style.display = 'none';
            callTimerDiv.style.display = 'none';
            animateView(initialViewDiv);
            updateSystemStatus("🔴 Waiting for Ticket", "status-waiting");
            hideAssistant(false); 
        }

        function switchToCallFlowView(animate = true) {
            initialViewDiv.style.display = 'none';
            postCallSummaryDiv.style.display = 'none';
            if (animate) animateView(callFlowViewDiv);
            else callFlowViewDiv.style.display = 'block';
            progressTrackerContainer.style.display = 'flex'; 
            updateSystemStatus("🟢 In Ticket", "status-in-call");
            hideAssistant(true); 
        }

        function switchToSummaryView() {
            initialViewDiv.style.display = 'none';
            callFlowViewDiv.style.display = 'none';
            progressTrackerContainer.style.display = 'none';
            callTimerDiv.style.display = 'none';
            animateView(postCallSummaryDiv);
            updateSystemStatus("📊 Review Ticket Summary", "status-summary");
            hideAssistant(false); 
        }

        async function loadActiveScenarios() {
            setButtonLoadingState(receiveCallBtn, true, "Receive Ticket", "Loading...");
            scenarioDropdown.disabled = true;
            scenarioDropdown.innerHTML = '<option value="" disabled selected>Loading scenarios...</option>';
            try {
                const { data: scenarios, error } = await supabase
                    .from('call_scenarios') 
                    .select('id, title')                 
                    .eq('is_active', true) 
                    .order('created_at', { ascending: false }); 
                if (error) throw error;

                if (scenarios && scenarios.length > 0) {
                    scenarioDropdown.innerHTML = '<option value="">-- Select a Scenario --</option>'; 
                    scenarios.forEach(s => {
                        const option = document.createElement('option');
                        option.value = s.id;
                        option.textContent = s.title; 
                        scenarioDropdown.appendChild(option);
                    });
                    scenarioDropdown.disabled = false;
                    setButtonLoadingState(receiveCallBtn, false, "Receive Ticket");
                    receiveCallBtn.disabled = true;
                } else {
                    scenarioDropdown.innerHTML = '<option value="" disabled>No scenarios available.</option>';
                    showAssistantMessage("⚠️ No active scenarios available.", true, 0); 
                    setButtonLoadingState(receiveCallBtn, false, "Receive Ticket");
                    receiveCallBtn.disabled = true;
                }
            } catch (err) {
                console.error("Error loading scenarios:", err);
                scenarioDropdown.innerHTML = '<option value="" disabled>⚠️ Failed to load scenarios.</option>';
                showAssistantMessage(`⚠️ Error loading scenarios: ${err.message}`, true, 8000);
                setButtonLoadingState(receiveCallBtn, false, "Receive Ticket");
                receiveCallBtn.disabled = true;
            }
        }
        
        receiveCallBtn.addEventListener('click', async () => {
            const selectedScenarioId = scenarioDropdown.value;
            if (!selectedScenarioId) {
                showAssistantMessage("⚠️ Please select a scenario first.", true, 5000);
                return;
            }
            if (currentUser.profileError) {
                 showAssistantMessage("⚠️ Cannot start ticket due to profile loading error.", true, 7000);
                 return;
            }
            setButtonLoadingState(receiveCallBtn, true, "Receive Ticket", "Starting...");
            if(callStartSound) callStartSound.play().catch(e => console.warn("Audio play failed:", e));

            resetCallState(); 
            switchToCallFlowView();
            updateSystemStatus("🟡 Loading Scenario...", "status-loading");
            stepsContainer.innerHTML = '<p class="placeholder-text">Loading scenario details...</p>';
            decisionButtonsContainer.innerHTML = ''; 
            scenarioTitleElement.innerHTML = `<span id="step-type-icon" class="step-type-icon"></span>Loading...`; 

            try {
                const { data: scenarioData, error: scenarioError } = await supabase
                    .from('call_scenarios') 
                    .select('id, title, steps') 
                    .eq('id', selectedScenarioId)
                    .single();

                if (scenarioError) throw scenarioError;
                if (!scenarioData || !Array.isArray(scenarioData.steps) || scenarioData.steps.length === 0 || !scenarioData.steps[0].id) {
                    throw new Error("Scenario data is invalid or has no steps in the new format.");
                }

                currentScenario = scenarioData; 
                currentStepId = currentScenario.steps[0].id; 
                stepHistory = [];
                accumulatedStepDurations = {}; 
                currentScenario.steps.forEach(step => { if(step.id) { accumulatedStepDurations[step.id] = 0; } });

                callStartTimeISO = new Date().toISOString(); 
                const { data: newSession, error: sessionInsertError } = await supabase
                    .from('call_sessions')
                    .insert({ user_id: currentUser.id, scenario_id: currentScenario.id, start_time: callStartTimeISO, agent_name: currentUser.name, agent_email: currentUser.email })
                    .select('id') 
                    .single();
                if (sessionInsertError) {
                    callStartTimeISO = null; 
                    throw sessionInsertError;
                }
                callSessionId = newSession.id;
                
                updateSystemStatus("🟢 In Ticket", "status-in-call");
                renderStep(); 
                setButtonLoadingState(receiveCallBtn, false, "Receive Ticket");
                receiveCallBtn.disabled = true;
            } catch (err) {
                console.error("Error starting ticket:", err);
                resetCallState(); 
                switchToInitialView();
                showAssistantMessage(`⚠️ Error starting ticket: ${err.message}. Please try again.`, true, 7000);
                await loadActiveScenarios();
            }
        });

        function renderStep() {
            if (!currentScenario || !currentStepId) {
                stepsContainer.innerHTML = '<p class="placeholder-text">Error: Invalid scenario or step.</p>';
                return;
            }
            const stepObject = currentScenario.steps.find(s => s.id === currentStepId); 
            if (!stepObject) {
                finishCall(false, `Error: Step ${currentStepId} not found`);
                return;
            }
            
            scenarioTitleElement.textContent = ` ${currentScenario.title}`; 
            
            const stepTypeIcon = stepObject.type === 'decision' ? '🤔' : '🗣️';
            scenarioTitleElement.insertAdjacentHTML('afterbegin', `<span id="step-type-icon" class="step-type-icon">${stepTypeIcon}</span>`);

            stepsContainer.innerHTML = `<p>${stepObject.text.replace(/\n/g, '<br>')}</p>`; 
            decisionButtonsContainer.innerHTML = ''; 

            renderProgressTracker(); 

            prevStepBtn.style.display = stepHistory.length > 0 ? 'inline-flex' : 'none';
            endCallBtn.style.display = 'inline-flex';

            if (stepObject.type === 'decision' && Array.isArray(stepObject.options)) {
                nextStepBtn.style.display = 'none'; 
                stepObject.options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'decision-button'; 
                    button.textContent = option.label;
                    button.addEventListener('click', () => navigateToStep(option.next_id));
                    decisionButtonsContainer.appendChild(button);
                });
            } else { 
                nextStepBtn.style.display = 'inline-flex';
                nextStepBtn.querySelector('.btn-text').textContent = stepObject.next_id ? "Next Step" : "Finish Scenario";
            }
            startStepTimer(); 
            saveCallState();
        }
        
        function navigateToStep(nextId) {
            stopAndRecordStepTimer();
            if (nextId === null || typeof nextId === 'undefined') { 
                finishCall(true, "Reached end of scenario path."); 
                return;
            }
            const targetStep = currentScenario.steps.find(s => s.id === nextId); 
            if (!targetStep) {
                finishCall(false, `Error: Step ${nextId} not found.`);
                return;
            }
            stepHistory.push(currentStepId); 
            currentStepId = nextId;
            renderStep();
        }

        function renderProgressTracker() {
             if (!progressTrackerContainer || !currentScenario || !currentScenario.steps) return;
             const stepperWrapper = progressTrackerContainer.querySelector('.stepper-wrapper');
             stepperWrapper.innerHTML = ''; 
             const stepperUl = document.createElement('ul');
             stepperUl.className = 'stepper';
             const validSteps = currentScenario.steps.filter(step => step && step.id);
             validSteps.forEach((step, index) => {
                 const stepLi = document.createElement('li');
                 stepLi.className = 'step';
                 if (stepHistory.includes(step.id)) stepLi.classList.add('completed');
                 else if (step.id === currentStepId) stepLi.classList.add('active');
                 const stepNumber = document.createElement('span');
                 stepNumber.className = 'step-number';
                 stepNumber.textContent = stepHistory.includes(step.id) ? '✓' : index + 1;
                 stepLi.appendChild(stepNumber);
                 stepperUl.appendChild(stepLi);
                 if (index < validSteps.length - 1) {
                     const separator = document.createElement('li');
                     separator.className = 'step-separator';
                     stepperUl.appendChild(separator);
                 }
             });
             stepperWrapper.appendChild(stepperUl);
             progressTrackerContainer.style.display = 'flex';
        }

        nextStepBtn.addEventListener('click', () => {
            const stepObject = currentScenario.steps.find(s => s.id === currentStepId); 
            if (stepObject) navigateToStep(stepObject.next_id);
        });
        prevStepBtn.addEventListener('click', () => {
            stopAndRecordStepTimer(); 
            if (stepHistory.length > 0) { currentStepId = stepHistory.pop(); renderStep(); }
        });
        endCallBtn.addEventListener('click', () => {
            stopAndRecordStepTimer(); 
            finishCall(false, "Ticket ended by agent"); 
        });

        function startStepTimer() {
            callTimerDiv.style.display = 'inline-block'; 
            if (stepTimerInterval) clearInterval(stepTimerInterval);
            if (callStartTimeISO) stepStartTime = new Date(callStartTimeISO).getTime();
            else stepStartTime = Date.now();
            
            const timerUpdate = () => {
                const elapsed = Date.now() - stepStartTime;
                const totalSeconds = Math.floor(elapsed / 1000);
                const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
                const seconds = String(totalSeconds % 60).padStart(2, '0');
                callTimerDiv.textContent = `${minutes}:${seconds}`;
            };
            timerUpdate();
            stepTimerInterval = setInterval(timerUpdate, 1000);
        }

        function stopAndRecordStepTimer() {
            if (stepTimerInterval) clearInterval(stepTimerInterval);
            stepTimerInterval = null;
        }
        
        async function finishCall(completed, reason) { 
            stopAndRecordStepTimer(); 
            const endTimeISO = new Date().toISOString();
            let duration = 0;
            if (callStartTimeISO) duration = Math.floor((new Date(endTimeISO) - new Date(callStartTimeISO)) / 1000);
            
            const quality = completed ? 'Good' : (duration > 0 ? 'Bad' : 'N/A');
            
            if (callSessionId) {
                const { error } = await supabase.from('call_sessions').update({
                    end_time: endTimeISO, duration, completed, call_quality: quality, quality_reason: reason
                }).eq('id', callSessionId);
                if (error) console.error("Failed to update ticket session:", error);
            }
            
            displayPostCallSummary(quality, reason, duration);
            clearCallState(); 
        }

        function displayPostCallSummary(quality, reason, totalDuration) {
            let summaryHTML = `<p><strong>Ticket Quality:</strong> <span class="quality-text quality-${quality?.toLowerCase() || 'na'}">${quality || 'N/A'}</span></p>
                <p><strong>Reason:</strong> ${reason || "N/A"}</p>
                <p><strong>Total Handle Time:</strong> ${Math.floor(totalDuration / 60)}m ${totalDuration % 60}s</p>`;
            callSummaryContentDiv.innerHTML = summaryHTML;
            switchToSummaryView();
        }
        
        returnToInitialViewBtn.addEventListener('click', async () => {
            resetCallState(true); 
            await loadActiveScenarios();
        });

        function saveCallState() {
            if (!callSessionId) return;
            sessionStorage.setItem(SESSION_STATE_KEY, JSON.stringify({
                callSessionId, currentScenario, currentStepId, stepHistory, callStartTimeISO
            }));
        }

        function restoreCallState() {
            const stateJSON = sessionStorage.getItem(SESSION_STATE_KEY);
            if (!stateJSON) return false;
            const state = JSON.parse(stateJSON);
            if (!state.callSessionId || !state.currentStepId) { clearCallState(); return false; }
            Object.assign(this, state);
            return true;
        }

        function clearCallState() { sessionStorage.removeItem(SESSION_STATE_KEY); }

        function resetCallState(switchToInitial = false) {
            stopAndRecordStepTimer(); 
            clearCallState();         
            currentScenario = null; currentStepId = null; stepHistory = []; callSessionId = null; callStartTimeISO = null;
            if (switchToInitial) switchToInitialView();
        }

        logoutButton.addEventListener('click', async () => {
            resetCallState(); 
            localStorage.removeItem('elevoCoreUserData'); 
            if (supabase) await supabase.auth.signOut();
            window.location.replace("login.html");
        });

        scenarioDropdown.addEventListener('change', () => {
            receiveCallBtn.disabled = !scenarioDropdown.value;
        });
        
        window.addEventListener('beforeunload', () => { if (callSessionId) saveCallState(); });
        
        if (supabase) initializeApp();
    </script>

<script>
(function(){
  const safe = typeof supabase !== 'undefined';
  // Populate placeholders with safe defaults or from views if available
  async function fetchKpis() {
    try {
      if (!safe) {
        // default demo values when supabase missing
        document.getElementById('kpi-fastest')?.textContent = '0m 0s';
        document.getElementById('kpi-longest')?.textContent = '0m 0s';
        document.getElementById('kpi-top-scenario')?.textContent = '-';
        document.getElementById('topAgentsList')?.innerHTML = '<li>No data yet <span>—</span></li>';
        document.getElementById('delayedList')?.innerHTML = '<li>No delayed tickets.</li>';
        document.getElementById('ins-total')?.textContent = '0';
        document.getElementById('ins-avg')?.textContent = '0m 0s';
        document.getElementById('ins-completion')?.textContent = '0%';
        return;
      }
      // Attempt to call views if supabase exists
      const { data: kpi } = await supabase.from('kpi_today').select('*').limit(1).single();
      if (kpi) {
        document.getElementById('ins-total')?.textContent = kpi.tickets_started_today || 0;
        document.getElementById('ins-completion')?.textContent = (kpi.completion_rate || 0) + '%';
        document.getElementById('ins-avg')?.textContent = (kpi.avg_handling_time_minutes || 0) + 'm';
        document.getElementById('kpi-fastest')?.textContent = '—';
        document.getElementById('kpi-longest')?.textContent = '—';
      }
      // top agents
      const { data: top } = await supabase.rpc('top_agents_today'); // optional if exists
      if (top && top.length) {
        const html = top.slice(0,5).map(t => `<li>${t.agent_name}<span>${t.count}</span></li>`).join('');
        document.getElementById('topAgentsList').innerHTML = html;
      }
      // delayed
      const { data: delayed } = await supabase.from('delayed_tickets').select('*');
      if (delayed && delayed.length) {
        document.getElementById('delayedList').innerHTML = delayed.map(d=>`<li>${d.agent_name} — ${Math.floor(d.seconds_open/60)}m ${d.seconds_open%60}s</li>`).join('');
      }
    } catch(e){
      console.warn('KPI placeholders error', e);
    }
  }
  // call once
  fetchKpis();
})();
</script>

</body>
</html>
