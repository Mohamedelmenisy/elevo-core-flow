<!DOCTYPE html>
<html lang="en" class="dark" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elevo Core Assistant</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234e8cff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M3 12h18M3 6h12M3 18h15'/><path d='M17 9l4 3l-4 3'/></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÜŸÖÿßÿ∑ ÿßŸÑÿ≠ÿßŸÑŸäÿ© ÿ™ÿ®ŸÇŸâ ŸÉŸÖÿß ŸáŸä */
        :root {
            --background-color: #1c1c28;
            --card-background-color: #2b2b3d;
            --text-color: #f0f0f0;
            --text-color-secondary: #a0a0b0;
            --primary-color: #4e8cff;
            --primary-color-rgb: 78, 140, 255;
            --primary-color-dark: #3d7eff;
            --secondary-color: #3a3a50;
            --border-color: #444444;
            --input-background-color: #242436;
            --input-border-color: #444444;
            --button-text-color: #ffffff;
            --success-color: #4CAF50;
            --danger-color: #F44336;
            --warning-color: #FFC107;
            --border-radius: 16px;
            --font-family-main: 'Poppins', 'Roboto', sans-serif;
        }

        /* ÿ®ÿßŸÇŸä ÿßŸÑÿ£ŸÜŸÖÿßÿ∑ ÿ™ÿ®ŸÇŸâ ŸÉŸÖÿß ŸáŸä */
        /* ... */
        
        /* ÿ•ÿ∂ÿßŸÅÿ© ÿ£ŸÜŸÖÿßÿ∑ ÿ¨ÿØŸäÿØÿ© ŸÑŸÑÿ™ÿ≠ŸÉŸÖ ŸÅŸä ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ */
        .access-denied-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(8px);
        }
        
        .access-denied-content {
            background: linear-gradient(145deg, #2b2b3d, #242436);
            padding: 3rem;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            border: 1px solid #444444;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            color: #f0f0f0;
            position: relative;
            overflow: hidden;
        }
        
        .access-denied-content h3 {
            margin: 0 0 1rem 0;
            font-size: 1.8rem;
            font-weight: 700;
            color: #ff6b6b;
        }
        
        .access-denied-content p {
            margin: 0 0 2rem 0;
            line-height: 1.6;
            color: #a0a0b0;
            font-size: 1.1rem;
        }
    </style>
</head>
<body>

    <div class="app-container">
        
<header class="app-header" style="width: 100%; background: #111827; border-bottom: 1px solid #1f2937; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem;">
  <div class="logo-container" style="display: flex; align-items: center; gap: 0.75rem;">
    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: #4e8cff; width: 32px; height: 32px;">
      <path d="M6 17L10 17M6 12L12 12M6 7L14 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M15 6L19 10L15 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <rect x="3" y="3" width="18" height="18" rx="3" stroke="currentColor" stroke-width="1.5" fill="transparent" opacity="0.6"/>
    </svg>
    <span class="app-title" style="font-weight: 700; font-size: 1.3rem; color: #4e8cff;">Elevo Core</span>
  </div>
  <div class="header-controls" style="display: flex; align-items: center; gap: 1.25rem;">
    <a href="dashboard.html" class="nav-link" id="dashboardLink" style="color: #d1d5db; text-decoration: none; font-weight: 500; transition: 0.3s; display: none;">Dashboard</a>
    <div class="user-info" style="display: flex; align-items: center; gap: 0.75rem;">
      <span id="userName" style="color: #d1d5db; font-weight: 500;">User</span>
      <button id="logoutButton" class="logout-btn" style="background: linear-gradient(135deg, #4e8cff, #60a5fa); color: white; border: none; border-radius: 8px; padding: 0.6rem 1rem; font-weight: 600; cursor: pointer;">Logout</button>
    </div>
  </div>
</header>


        <div class="status-bar">
            <div id="systemStatus" class="status-indicator status-waiting">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                </svg>
                Waiting for Ticket
            </div>
        </div>

        <div id="timer-container">
             <div id="callTimer" style="display: none;">00:00</div>
        </div>

        <main class="app-main">
            <div id="auth-loading" class="loading-container" style="display: none; flex-direction: column; align-items: center; justify-content: center; height: 60vh;">
                <div class="spinner" style="width: 50px; height: 50px; border-top-color: var(--primary-color);"></div>
                <p style="color: var(--text-color-secondary); margin-top: 1.5rem; font-size: 1.1rem;">Initializing Assistant...</p>
            </div>

            <div id="initial-view" class="card initial-card fade-in" style="display: none;">
                <!-- ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑÿ£ŸàŸÑŸäÿ© Ÿäÿ®ŸÇŸâ ŸÉŸÖÿß ŸáŸà -->
                <div class="initial-card-left">
                    <div class="card-icon">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="var(--primary-color)" width="72" height="72">
                             <path d="M12 2C6.486 2 2 6.486 2 12C2 17.514 6.486 22 12 22C17.514 22 22 17.514 22 12C22 6.486 17.514 2 12 2ZM12 20C7.589 20 4 16.411 4 12C4 7.589 7.589 4 12 4C16.411 4 20 7.589 20 12C20 16.411 16.411 20 12 20Z"/>
                             <path d="M12 11C10.897 11 10 10.103 10 9C10 7.897 10.897 7 12 7C13.103 7 14 7.897 14 9C14 10.103 13.103 11 12 11Z"/>
                             <path d="M16.002 16.246C15.483 15.219 14.544 14.5 13.333 14.5H10.667C9.456 14.5 8.517 15.219 7.998 16.246C7.933 16.386 7.996 16.553 8.114 16.641C8.657 17.053 9.737 17.5 12 17.5C14.263 17.5 15.343 17.053 15.886 16.641C16.004 16.553 16.067 16.386 16.002 16.246Z"/>
                         </svg>
                    </div>
                    <h2 class="card-title">Core Flow Assistant</h2>
                    <p class="card-subtitle">Your dedicated assistant for streamlined ticket resolution. Select a scenario below to begin handling customer interactions with guided step-by-step support.</p>
                </div>
                
                <div class="initial-card-right">
                    <div class="scenario-selector-container">
                        <label for="searchScenarioInput" style="display: block; margin-bottom: 0.75rem; font-weight: 600; color: var(--text-color-secondary); font-size: 1.1rem;">Select Scenario:</label>
                        <input type="search" id="searchScenarioInput" class="search-scenario-input" placeholder="Search scenarios...">
                        <div id="customScenarioList" class="custom-scenario-list" role="listbox">
                            <!-- Scenarios will be loaded here by JS -->
                            <div class="scenario-item" style="justify-content: center;">
                                <div class="loading-skeleton" style="width: 100%; height: 1.5rem;"></div>
                            </div>
                        </div>
                        <input type="hidden" id="scenarioDropdownValue" name="scenarioId">
                    </div>
                    <div style="display: flex; justify-content: flex-start; margin-top: 2rem;">
                        <button id="receive-call-btn" class="action-button primary-button" disabled style="padding: 1.25rem 2.5rem; font-size: 1.1rem;">
                            <span class="btn-text">Start Ticket</span>
                        </button>
                    </div>
                </div>

                <!-- Audio Elements -->
                <audio id="callStartSound" src="call_sound.mp3" preload="auto"></audio>
                <audio id="compensationScenarioSound" src="compensation_alert.mp3" preload="auto"></audio>
            </div>

            <div id="call-flow-view" class="card call-flow-card fade-in" style="display: none;">
                <h3 id="scenario-title" class="card-title scenario-title-dynamic">
                    <span id="step-type-icon" class="step-type-icon"></span>
                    <span id="scenario-title-text">Ticket Scenario</span>
                </h3>
                <div id="steps-container" class="steps-area">
                    <p class="placeholder-text">Loading ticket steps...</p>
                </div>
                <div id="decision-buttons-container" class="step-actions"></div>

                <div class="navigation-buttons">
                    <button id="prev-step-btn" class="nav-button secondary-button" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 0.5em;">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                        <span>Previous</span>
                    </button>
                    <button id="next-step-btn" class="nav-button primary-button">
                        <span class="btn-text">Next Step</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-left: 0.5em;">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </button>
                </div>
                 <div style="display: flex; justify-content: center; margin-top: 2rem;">
                    <button id="end-call-btn" class="nav-button danger-button" style="display: none; padding: 1rem 2rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 0.5em;">
                            <path d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        <span>End Ticket</span>
                    </button>
                 </div>
            </div>

            <div id="postCallSummary" class="card post-call-summary-card fade-in" style="display: none;">
                <h3 class="card-title">Ticket Summary</h3>
                <div id="callSummaryContent"></div>
                <div style="display: flex; justify-content: center; margin-top: 2.5rem;">
                    <button id="returnToInitialViewBtn" class="action-button primary-button" style="padding: 1.25rem 2.5rem; font-size: 1.1rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 0.5em;">
                            <path d="M3 12h18M3 6h12M3 18h15"/>
                        </svg>
                        <span>New Ticket</span>
                    </button>
                </div>
            </div>
            
            <div id="scenario-preview-tooltip"></div>
        </main>

        <div id="custom-toast-notification" class="custom-toast">
            <span class="toast-icon">‚ö†Ô∏è</span>
            <span id="toast-message" class="toast-message"></span>
        </div>

        <footer class="app-footer">
            <p>¬© <span id="currentYear"></span> Mohamed Elmenisy - Elevo Core. All rights reserved.</p>
        </footer>
    </div>

    <!-- Access Denied Modal - ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´Ÿá -->
    <div id="accessDeniedModal" class="access-denied-modal" aria-hidden="true" style="display: none;">
      <div class="access-denied-content" role="dialog" aria-labelledby="accessDeniedTitle" aria-describedby="accessDeniedDesc">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        <h3 id="accessDeniedTitle">Access Restricted</h3>
        <p id="accessDeniedDesc">You don't have permission to view this page. This section is available for <strong>Admins and Managers</strong> only.</p>
        <button id="returnToAppBtn" class="action-button primary-button">üîô Back to My Dashboard</button>
      </div>
    </div>

    <!-- ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÑŸÅ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ -->
    <script src="role-check.js"></script>

    <script type="module">
        // --- Supabase Client Setup ---
        const SUPABASE_URL = 'https://aefiigottnlcmjzilqnh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlZmlpZ290dG5sY21qemlscW5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNzY2MDQsImV4cCI6MjA2Mjc1MjYwNH0.FypB02v3tGMnxXV9ZmZMdMC0oQpREKOJWgHMPxUzwX4';
        
        let supabase;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (error) {
            console.error("Supabase client initialization failed:", error);
            document.getElementById('auth-loading').innerHTML = '<p style="color:var(--danger-color); text-align:center; font-size: 1.2rem;">Error connecting to services. Core Flow is unavailable.</p>';
        }

        // --- ÿ™ŸáŸäÿ¶ÿ© ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ---
        const roleChecker = new RoleChecker(supabase);

        // --- DOM Elements ---
        const authLoadingDiv = document.getElementById('auth-loading');
        const initialViewDiv = document.getElementById('initial-view');
        const callFlowViewDiv = document.getElementById('call-flow-view');
        const postCallSummaryDiv = document.getElementById('postCallSummary');
        const receiveCallBtn = document.getElementById('receive-call-btn');
        const scenarioTitleElement = document.getElementById('scenario-title-text');
        const stepTypeIconElement = document.getElementById('step-type-icon'); 
        const stepsContainer = document.getElementById('steps-container'); 
        const decisionButtonsContainer = document.getElementById('decision-buttons-container'); 
        const prevStepBtn = document.getElementById('prev-step-btn');
        const nextStepBtn = document.getElementById('next-step-btn'); 
        const endCallBtn = document.getElementById('end-call-btn');
        const userInfoDiv = document.getElementById('userInfo');
        const userNameSpan = document.getElementById('userName');
        const logoutButton = document.getElementById('logoutButton');
        const dashboardLink = document.getElementById('dashboardLink');
        const systemStatusDiv = document.getElementById('systemStatus');
        const callTimerDiv = document.getElementById('callTimer');
        const callSummaryContentDiv = document.getElementById('callSummaryContent');
        const returnToInitialViewBtn = document.getElementById('returnToInitialViewBtn');
        const callStartSound = document.getElementById('callStartSound'); 
        const compensationScenarioSound = document.getElementById('compensationScenarioSound');
        const searchScenarioInput = document.getElementById('searchScenarioInput');
        const scenarioPreviewTooltip = document.getElementById('scenario-preview-tooltip');
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        // --- State Variables ---
        let currentUser = null; 
        let currentScenario = null; 
        let currentStepId = null;   
        let stepHistory = [];       
        let callSessionId = null;    
        let callStartTimeISO = null; 
        let stepTimerInterval = null;
        let stepStartTime = 0;      
        let accumulatedStepDurations = {}; 
        let stepVisitCount = {};
        const SESSION_STATE_KEY = 'elevoCoreActiveCallState_v4';

        // --- UI Helper Functions ---
        function setButtonLoadingState(button, isLoading, defaultText = "Submit") {
            const btnText = button.querySelector('.btn-text');
            button.disabled = isLoading;
            if (isLoading) {
                if(btnText) btnText.textContent = "Loading...";
                button.insertAdjacentHTML('afterbegin', '<span class="btn-spinner"></span>');
            } else {
                if(btnText) btnText.textContent = defaultText;
                const spinner = button.querySelector('.btn-spinner');
                if(spinner) spinner.remove();
            }
        }

        function updateSystemStatus(text, statusClass = 'status-waiting') {
            if (systemStatusDiv) {
                systemStatusDiv.textContent = text;
                systemStatusDiv.className = `status-indicator ${statusClass}`;
                
                // Update icon based on status
                let icon = '';
                switch(statusClass) {
                    case 'status-waiting': icon = 'üî¥'; break;
                    case 'status-loading': icon = 'üü°'; break;
                    case 'status-in-call': icon = 'üü¢'; break;
                    case 'status-completed': icon = '‚úÖ'; break;
                    case 'status-ended': icon = '‚ö™'; break;
                    case 'status-summary': icon = 'üìä'; break;
                }
                systemStatusDiv.innerHTML = `${icon} ${text}`;
            }
        }

        function animateView(viewElement) {
            if (viewElement) {
                viewElement.classList.remove('fade-in');
                void viewElement.offsetWidth; 
                viewElement.classList.add('fade-in');
                viewElement.style.display = viewElement.classList.contains('initial-card') ? 'grid' : 'block';
            }
        }

        let toastTimeout;
        function showCustomToast(message) {
            const toastElement = document.getElementById('custom-toast-notification');
            const toastMessage = document.getElementById('toast-message');

            if (toastElement && toastMessage) {
                clearTimeout(toastTimeout);
                
                toastMessage.textContent = message;
                toastElement.classList.remove('hide');
                toastElement.classList.add('show');
                
                toastTimeout = setTimeout(() => {
                    toastElement.classList.remove('show');
                    toastElement.classList.add('hide');
                }, 4000);
            }
        }

        // --- Authentication & Initialization ---
        async function initializeApp() {
            if (!supabase) { 
                 authLoadingDiv.style.display = 'flex';
                 authLoadingDiv.innerHTML = '<p style="color:var(--danger-color); text-align:center; font-size: 1.2rem;">Critical Error: Services unavailable.</p>';
                 return;
            }
            
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.replace('login.html'); 
                return;
            }

            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ¨ÿØŸäÿØ
            const userRole = await roleChecker.checkUserRole();
            if (!userRole) {
                console.error("Failed to get user role");
                window.location.replace('login.html');
                return;
            }

            // ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
            currentUser = roleChecker.currentUser;
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ© ŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ Core Flow
            if (!roleChecker.hasAgentAccess()) {
                roleChecker.createAccessDeniedModal("You don't have permission to access Core Flow. This section is available for Agents, Admins and Managers only.");
                authLoadingDiv.style.display = 'none';
                return;
            }

            // ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©
            if (userNameSpan) userNameSpan.textContent = currentUser.email.split('@')[0];
            if (userInfoDiv) userInfoDiv.style.display = 'flex';
            
            // ÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿßÿ®ÿ∑ Dashboard ŸÅŸÇÿ∑ ŸÑŸÑŸÖÿ≥ÿ§ŸàŸÑŸäŸÜ ŸàÿßŸÑŸÖÿØŸäÿ±ŸäŸÜ
            if (dashboardLink) {
                dashboardLink.style.display = roleChecker.hasAdminAccess() ? 'inline-block' : 'none';
            }
            
            if (restoreCallState()) { 
                switchToCallFlowView(false); 
                renderStep(); 
                updateSystemStatus("In Ticket (Restored)", "status-in-call");
            } else {
                switchToInitialView();
                await loadActiveScenarios();
            }
            authLoadingDiv.style.display = 'none';
        }

        function switchToInitialView() {
            callFlowViewDiv.style.display = 'none';
            postCallSummaryDiv.style.display = 'none';
            callTimerDiv.style.display = 'none';
            animateView(initialViewDiv);
            updateSystemStatus("Waiting for Ticket", "status-waiting");
        }

        function switchToCallFlowView(animate = true) {
            initialViewDiv.style.display = 'none';
            postCallSummaryDiv.style.display = 'none';
            if (animate) animateView(callFlowViewDiv);
            else callFlowViewDiv.style.display = 'block';
            updateSystemStatus("In Ticket", "status-in-call");
        }

        function switchToSummaryView() {
            initialViewDiv.style.display = 'none';
            callFlowViewDiv.style.display = 'none';
            callTimerDiv.style.display = 'none';
            animateView(postCallSummaryDiv);
            updateSystemStatus("Review Ticket Summary", "status-summary");
        }
        
        async function loadActiveScenarios() {
            setButtonLoadingState(receiveCallBtn, true, "Start Ticket");
            const customList = document.getElementById('customScenarioList');
            const scenarioValueInput = document.getElementById('scenarioDropdownValue');
            
            // Show loading skeleton
            customList.innerHTML = `
                <div class="scenario-item" style="justify-content: center;">
                    <div class="loading-skeleton" style="width: 100%; height: 1.5rem;"></div>
                </div>
                <div class="scenario-item" style="justify-content: center;">
                    <div class="loading-skeleton" style="width: 80%; height: 1.5rem;"></div>
                </div>
                <div class="scenario-item" style="justify-content: center;">
                    <div class="loading-skeleton" style="width: 90%; height: 1.5rem;"></div>
                </div>
            `;
            
            scenarioValueInput.value = '';

            try {
                const { data: scenarios, error } = await supabase
                    .from('call_scenarios')
                    .select('id, title, steps, description')
                    .eq('is_active', true)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;

                customList.innerHTML = '';
                if (scenarios && scenarios.length > 0) {
                    scenarios.forEach(s => {
                        const item = document.createElement('div');
                        item.className = 'scenario-item';
                        item.dataset.value = s.id;
                        item.setAttribute('role', 'option');
                        item.setAttribute('tabindex', '0');
                        item.setAttribute('aria-label', s.title);
                        item.dataset.stepCount = s.steps?.length || 0;
                        item.dataset.description = s.description || 'No description available';
                        item.dataset.avgTime = "2-3 min";

                        let icon = 'üìù';
                        const titleLower = s.title.toLowerCase();
                        if (titleLower.includes('compensation')) { 
                            icon = '‚≠ê'; 
                            item.classList.add('compensation'); 
                        } else if (titleLower.includes('inquiry')) { 
                            icon = '‚ùì'; 
                        } else if (titleLower.includes('complaint')) { 
                            icon = 'üò†'; 
                        } else if (titleLower.includes('technical')) { 
                            icon = 'üîß'; 
                        } else if (titleLower.includes('billing')) { 
                            icon = 'üí∞'; 
                        }

                        item.innerHTML = `
                            <span class="icon">${icon}</span> 
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">${s.title}</div>
                                <div style="font-size: 0.9rem; color: var(--text-color-secondary);">
                                    ${s.steps?.length || 0} steps ‚Ä¢ ${item.dataset.avgTime}
                                </div>
                            </div>
                        `;
                        
                        const selectScenario = () => {
                            const currentlySelected = customList.querySelector('.selected');
                            if (currentlySelected) currentlySelected.classList.remove('selected');
                            item.classList.add('selected');
                            scenarioValueInput.value = s.id;
                            receiveCallBtn.disabled = false;
                        };

                        item.addEventListener('click', selectScenario);
                        item.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter' || e.key === ' ') {
                                e.preventDefault();
                                selectScenario();
                            }
                        });

                        item.addEventListener('mousemove', (e) => {
                            scenarioPreviewTooltip.style.display = 'block';
                            scenarioPreviewTooltip.innerHTML = `
                                <strong>${s.title}</strong>
                                <div style="margin-top: 0.5rem;">${item.dataset.description}</div>
                                <div style="margin-top: 0.5rem; font-size: 0.8rem;">
                                    <span>Steps: ${item.dataset.stepCount}</span> ‚Ä¢ 
                                    <span>Avg. Time: ${item.dataset.avgTime}</span>
                                </div>
                            `;
                            scenarioPreviewTooltip.style.left = `${e.pageX + 15}px`;
                            scenarioPreviewTooltip.style.top = `${e.pageY + 15}px`;
                        });

                        item.addEventListener('mouseleave', () => {
                            scenarioPreviewTooltip.style.display = 'none';
                        });

                        customList.appendChild(item);
                    });
                    
                    // Add search functionality
                    searchScenarioInput.addEventListener('input', function() {
                        const searchTerm = this.value.toLowerCase();
                        const items = customList.querySelectorAll('.scenario-item');
                        
                        items.forEach(item => {
                            const title = item.querySelector('div > div:first-child').textContent.toLowerCase();
                            if (title.includes(searchTerm)) {
                                item.style.display = 'flex';
                            } else {
                                item.style.display = 'none';
                            }
                        });
                    });
                    
                } else {
                    customList.innerHTML = '<div class="scenario-item" style="justify-content: center; color: var(--text-color-secondary);">No active scenarios found</div>';
                }
            } catch (error) {
                console.error("Error loading scenarios:", error);
                customList.innerHTML = '<div class="scenario-item" style="justify-content: center; color: var(--danger-color);">Error loading scenarios</div>';
            } finally {
                setButtonLoadingState(receiveCallBtn, false, "Start Ticket");
            }
        }

        // --- Call Flow Logic ---
        receiveCallBtn.addEventListener('click', async function() {
            const selectedScenarioId = document.getElementById('scenarioDropdownValue').value;
            if (!selectedScenarioId) {
                showCustomToast("Please select a scenario first.");
                return;
            }

            setButtonLoadingState(this, true, "Starting...");
            updateSystemStatus("Loading Scenario...", "status-loading");

            try {
                const { data: scenario, error } = await supabase
                    .from('call_scenarios')
                    .select('*')
                    .eq('id', selectedScenarioId)
                    .single();

                if (error) throw error;
                if (!scenario) throw new Error("Scenario not found");

                currentScenario = scenario;
                currentStepId = scenario.entry_step_id || scenario.steps?.[0]?.id;
                stepHistory = [];
                callSessionId = generateSessionId();
                callStartTimeISO = new Date().toISOString();
                accumulatedStepDurations = {};
                stepVisitCount = {};

                if (scenario.title.toLowerCase().includes('compensation')) {
                    try { compensationScenarioSound.play(); } catch(e) { console.log("Audio play failed:", e); }
                } else {
                    try { callStartSound.play(); } catch(e) { console.log("Audio play failed:", e); }
                }

                await saveCallState();
                switchToCallFlowView();
                renderStep();

                // Start timer
                callTimerDiv.style.display = 'block';
                startCallTimer();

            } catch (error) {
                console.error("Error starting call flow:", error);
                showCustomToast("Failed to start scenario. Please try again.");
                updateSystemStatus("Error", "status-waiting");
            } finally {
                setButtonLoadingState(this, false, "Start Ticket");
            }
        });

        function renderStep() {
            if (!currentScenario || !currentStepId) return;

            const step = currentScenario.steps.find(s => s.id === currentStepId);
            if (!step) {
                console.error("Step not found:", currentStepId);
                return;
            }

            // Update step timer
            if (stepTimerInterval) clearInterval(stepTimerInterval);
            stepStartTime = Date.now();
            stepTimerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - stepStartTime) / 1000);
                if (nextStepBtn) {
                    nextStepBtn.querySelector('.btn-text').textContent = `Next Step (${elapsed}s)`;
                }
            }, 1000);

            // Update step visit count
            stepVisitCount[step.id] = (stepVisitCount[step.id] || 0) + 1;

            // Update UI
            scenarioTitleElement.textContent = currentScenario.title;
            stepsContainer.innerHTML = '';
            decisionButtonsContainer.innerHTML = '';
            prevStepBtn.style.display = stepHistory.length > 0 ? 'inline-flex' : 'none';
            nextStepBtn.style.display = 'inline-flex';
            endCallBtn.style.display = 'inline-flex';

            // Set step icon based on type
            let stepIcon = 'üìù';
            if (step.type === 'decision') stepIcon = 'ü§î';
            else if (step.type === 'information') stepIcon = '‚ÑπÔ∏è';
            else if (step.type === 'action') stepIcon = '‚ö°';
            else if (step.type === 'confirmation') stepIcon = '‚úÖ';
            else if (step.type === 'escalation') stepIcon = 'üö®';
            
            stepTypeIconElement.textContent = stepIcon;

            // Render step content
            const stepElement = document.createElement('div');
            stepElement.className = 'step-content';
            stepElement.innerHTML = `
                <h4 class="step-title">${step.title}</h4>
                <div class="step-description">${step.description || ''}</div>
                ${step.script ? `<div class="step-script">${step.script}</div>` : ''}
                ${step.notes ? `<div class="step-notes"><strong>Notes:</strong> ${step.notes}</div>` : ''}
            `;
            stepsContainer.appendChild(stepElement);

            // Render decision buttons if applicable
            if (step.type === 'decision' && step.options && step.options.length > 0) {
                step.options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'decision-button';
                    button.textContent = option.label;
                    button.addEventListener('click', () => {
                        // Record the decision
                        if (option.next_step_id) {
                            navigateToStep(option.next_step_id, option.label);
                        }
                    });
                    decisionButtonsContainer.appendChild(button);
                });
                nextStepBtn.style.display = 'none'; // Hide next button for decisions
            }

            // Handle special step types
            if (step.type === 'escalation') {
                nextStepBtn.style.display = 'none';
                const escalateBtn = document.createElement('button');
                escalateBtn.className = 'decision-button danger-button';
                escalateBtn.innerHTML = 'üö® Escalate to Supervisor';
                escalateBtn.addEventListener('click', () => {
                    showCustomToast("Ticket escalated to supervisor.");
                    // In a real app, you would trigger an escalation workflow
                    setTimeout(() => navigateToNextStep(), 2000);
                });
                decisionButtonsContainer.appendChild(escalateBtn);
            }
        }

        function navigateToStep(stepId, decisionLabel = null) {
            if (decisionLabel) {
                // Record the decision in history
                stepHistory.push({
                    stepId: currentStepId,
                    decision: decisionLabel,
                    timestamp: new Date().toISOString()
                });
            }

            // Record step duration before moving
            if (currentStepId) {
                const duration = Math.floor((Date.now() - stepStartTime) / 1000);
                accumulatedStepDurations[currentStepId] = (accumulatedStepDurations[currentStepId] || 0) + duration;
            }

            currentStepId = stepId;
            renderStep();
            saveCallState();
        }

        function navigateToNextStep() {
            if (!currentScenario || !currentStepId) return;

            const currentStep = currentScenario.steps.find(s => s.id === currentStepId);
            if (!currentStep) return;

            // Record step duration
            const duration = Math.floor((Date.now() - stepStartTime) / 1000);
            accumulatedStepDurations[currentStepId] = (accumulatedStepDurations[currentStepId] || 0) + duration;

            stepHistory.push({
                stepId: currentStepId,
                action: 'next',
                timestamp: new Date().toISOString()
            });

            // Determine next step
            let nextStepId = null;
            
            if (currentStep.next_step_id) {
                nextStepId = currentStep.next_step_id;
            } else {
                // Find the next step in sequence
                const currentIndex = currentScenario.steps.findIndex(s => s.id === currentStepId);
                if (currentIndex < currentScenario.steps.length - 1) {
                    nextStepId = currentScenario.steps[currentIndex + 1].id;
                }
            }

            if (nextStepId) {
                currentStepId = nextStepId;
                renderStep();
            } else {
                // No more steps - end the call
                endCallFlow();
            }
            
            saveCallState();
        }

        function navigateToPreviousStep() {
            if (stepHistory.length === 0) return;

            // Record current step duration before going back
            if (currentStepId) {
                const duration = Math.floor((Date.now() - stepStartTime) / 1000);
                accumulatedStepDurations[currentStepId] = (accumulatedStepDurations[currentStepId] || 0) + duration;
            }

            const lastStep = stepHistory.pop();
            currentStepId = lastStep.stepId;
            renderStep();
            saveCallState();
        }

        async function endCallFlow() {
            if (stepTimerInterval) {
                clearInterval(stepTimerInterval);
                stepTimerInterval = null;
            }

            // Record final step duration
            if (currentStepId) {
                const duration = Math.floor((Date.now() - stepStartTime) / 1000);
                accumulatedStepDurations[currentStepId] = (accumulatedStepDurations[currentStepId] || 0) + duration;
            }

            // Calculate total call duration
            const callEndTime = new Date();
            const callDurationMs = callEndTime - new Date(callStartTimeISO);
            const callDurationSec = Math.floor(callDurationMs / 1000);

            // Save call session to database
            try {
                const { error } = await supabase
                    .from('call_sessions')
                    .insert({
                        id: callSessionId,
                        user_id: currentUser.id,
                        scenario_id: currentScenario.id,
                        start_time: callStartTimeISO,
                        end_time: callEndTime.toISOString(),
                        duration_seconds: callDurationSec,
                        steps_completed: stepHistory.length + 1, // +1 for current step
                        step_durations: accumulatedStepDurations,
                        step_visits: stepVisitCount,
                        navigation_path: stepHistory
                    });

                if (error) throw error;
            } catch (error) {
                console.error("Error saving call session:", error);
                // Continue even if save fails
            }

            // Show summary
            showCallSummary(callDurationSec);
            switchToSummaryView();
            clearCallState();
        }

        function showCallSummary(totalDurationSec) {
            const minutes = Math.floor(totalDurationSec / 60);
            const seconds = totalDurationSec % 60;
            const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            const totalSteps = currentScenario.steps.length;
            const completedSteps = Object.keys(accumulatedStepDurations).length;

            let summaryHTML = `
                <div class="summary-stats">
                    <div class="stat-item">
                        <div class="stat-value">${timeString}</div>
                        <div class="stat-label">Total Duration</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${completedSteps}/${totalSteps}</div>
                        <div class="stat-label">Steps Completed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stepHistory.filter(s => s.decision).length}</div>
                        <div class="stat-label">Decisions Made</div>
                    </div>
                </div>
                <div class="summary-details">
                    <h4>Scenario: ${currentScenario.title}</h4>
                    <p>Completed on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
                </div>
            `;

            callSummaryContentDiv.innerHTML = summaryHTML;
        }

        function startCallTimer() {
            const startTime = new Date(callStartTimeISO).getTime();
            
            function updateTimer() {
                const now = new Date().getTime();
                const elapsed = Math.floor((now - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                callTimerDiv.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            updateTimer();
            setInterval(updateTimer, 1000);
        }

        // --- Session Persistence ---
        function generateSessionId() {
            return 'session_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now().toString(36);
        }

        function saveCallState() {
            if (!currentScenario || !callSessionId) return;
            
            const state = {
                sessionId: callSessionId,
                scenario: currentScenario,
                currentStepId: currentStepId,
                stepHistory: stepHistory,
                startTime: callStartTimeISO,
                stepDurations: accumulatedStepDurations,
                stepVisits: stepVisitCount,
                timestamp: Date.now()
            };
            
            try {
                localStorage.setItem(SESSION_STATE_KEY, JSON.stringify(state));
            } catch (e) {
                console.warn("Could not save call state to localStorage:", e);
            }
        }

        function restoreCallState() {
            try {
                const saved = localStorage.getItem(SESSION_STATE_KEY);
                if (!saved) return false;
                
                const state = JSON.parse(saved);
                
                // Check if state is not too old (e.g., 2 hours)
                if (Date.now() - state.timestamp > 2 * 60 * 60 * 1000) {
                    clearCallState();
                    return false;
                }
                
                callSessionId = state.sessionId;
                currentScenario = state.scenario;
                currentStepId = state.currentStepId;
                stepHistory = state.stepHistory || [];
                callStartTimeISO = state.startTime;
                accumulatedStepDurations = state.stepDurations || {};
                stepVisitCount = state.stepVisits || {};
                
                return true;
            } catch (e) {
                console.warn("Could not restore call state:", e);
                clearCallState();
                return false;
            }
        }

        function clearCallState() {
            try {
                localStorage.removeItem(SESSION_STATE_KEY);
            } catch (e) {
                console.warn("Could not clear call state:", e);
            }
            
            callSessionId = null;
            currentScenario = null;
            currentStepId = null;
            stepHistory = [];
            callStartTimeISO = null;
            accumulatedStepDurations = {};
            stepVisitCount = {};
            
            if (stepTimerInterval) {
                clearInterval(stepTimerInterval);
                stepTimerInterval = null;
            }
        }

        // --- Event Listeners ---
        nextStepBtn.addEventListener('click', navigateToNextStep);
        prevStepBtn.addEventListener('click', navigateToPreviousStep);
        endCallBtn.addEventListener('click', endCallFlow);
        returnToInitialViewBtn.addEventListener('click', function() {
            switchToInitialView();
            loadActiveScenarios();
        });

        logoutButton.addEventListener('click', async function() {
            setButtonLoadingState(this, true, "Logging out...");
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                window.location.replace('login.html');
            } catch (error) {
                console.error('Logout error:', error);
                showCustomToast("Logout failed. Please try again.");
                setButtonLoadingState(this, false, "Logout");
            }
        });

        // --- Initialize App ---
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // Handle page visibility changes (tab switch)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && callSessionId) {
                // Page became visible, update timer if needed
                saveCallState();
            }
        });

        // Handle beforeunload to save state
        window.addEventListener('beforeunload', function() {
            if (callSessionId) {
                saveCallState();
            }
        });
    </script>
</body>
</html>
