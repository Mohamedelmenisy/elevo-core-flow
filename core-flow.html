ØªÙ…Ø§Ù…ØŒ Ù‚Ù…Øª Ø¨ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø­Ø±ÙÙŠØ§Ù‹.

ÙÙŠ Ø§Ù„Ù€ CSS: Ø£Ø¶ÙØª ÙƒÙˆØ¯ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ù‚Ø³Ù… Ø§Ù„Ù€ style Ù„ÙŠØ¬Ø¹Ù„ Ø§Ù„ÙÙˆØ±Ù… ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø±Ø¶ ÙƒØ§Ù…Ù„ ÙˆØ´Ø¨ÙƒØ© (Grid) Ù…Ù† Ø¹Ù…ÙˆØ¯ÙŠÙ†.

ÙÙŠ Ø§Ù„Ù€ JavaScript: Ù‚Ù…Øª Ø¨ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© renderStep Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„ØªØ´Ù…Ù„ Ù…Ù†Ø·Ù‚ ØªÙØ¹ÙŠÙ„ form-mode ÙˆØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¥Ù„Ù‰ "Final Documentation"ØŒ Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù (Ù…Ø«Ù„ Ø²Ø± Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªÙŠÙƒØª ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø®Ø±Ù‰) ÙƒÙ…Ø§ Ù‡ÙŠ.

Ø¥Ù„ÙŠÙƒ Ø§Ù„Ù…Ù„Ù Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¬Ø§Ù‡Ø² Ù„Ù„Ù†Ø³Ø®:

code
Html
play_circle
download
content_copy
expand_less
<!doctype html>
<html lang="ar" class="dark" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Elevo Core Assistant</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234e8cff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M3 12h18M3 6h12M3 18h15'/><path d='M17 9l4 3l-4 3'/></svg>">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
    --background-color: #1c1c28;
    --card-background-color: #2b2b3d;
    --text-color: #f0f0f0;
    --text-color-secondary: #a0a0b0;
    --primary-color: #4e8cff;
    --primary-color-rgb: 78, 140, 255;
    --primary-color-dark: #3d7eff;
    --secondary-color: #3a3a50;
    --border-color: #444444;
    --input-background-color: #242436;
    --input-border-color: #444444;
    --button-text-color: #ffffff;
    --success-color: #4CAF50;
    --danger-color: #F44336;
    --warning-color: #FFC107;
    --border-radius: 16px;
    --font-family-main: 'Cairo', sans-serif;
}


html.dark {
background-color: var(--background-color);
}

body {
background-color: var(--background-color);
color: var(--text-color);
font-family: var(--font-family-main);
margin: 0;
padding: 0;
line-height: 1.6;
overflow-x: hidden;
}

.app-container {
display: flex;
flex-direction: column;
min-height: 100vh;
max-width: 100%;
margin: 0 auto;
}

.app-main {
padding: 2rem;
flex-grow: 1;
display: flex;
flex-direction: column;
align-items: center;
justify-content: flex-start;
}

.app-header {
background: linear-gradient(135deg, var(--card-background-color), #242436);
color: var(--text-color);
padding: 1.25rem 2rem;
display: flex;
justify-content: space-between;
align-items: center;
border-bottom: 1px solid var(--border-color);
box-shadow: 0 4px 20px rgba(0, 0, 0, .25);
width: 100%;
box-sizing: border-box;
backdrop-filter: blur(10px);
position: sticky;
top: 0;
z-index: 1000;
}

.logo-container {
display: flex;
align-items: center;
gap: 1rem;
}

.app-title {
font-weight: 700;
color: var(--primary-color);
font-size: 1.4rem;
background: linear-gradient(135deg, var(--primary-color), #6ea8ff);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
}

.header-controls {
display: flex;
align-items: center;
gap: 1.5rem;
}

/* New styles for navigation */
.main-nav {
display: flex;
gap: .75rem;
}

.nav-link {
color: var(--text-color-secondary);
text-decoration: none;
transition: all .3s ease;
font-weight: 500;
padding: .5rem 1rem;
border-radius: 8px;
border: 1px solid transparent;
font-size: 0.95rem;
}

.nav-link:hover {
color: var(--primary-color);
background: rgba(var(--primary-color-rgb), .1);
}

.nav-link.active {
color: #ffffff;
background: rgba(var(--primary-color-rgb), .15);
border: 1px solid var(--primary-color);
font-weight: 600;
box-shadow: 0 0 8px rgba(var(--primary-color-rgb), 0.3), inset 0 0 5px rgba(var(--primary-color-rgb), 0.2);
text-shadow: 0 0 5px rgba(var(--primary-color-rgb), 0.5);
}

.user-info {
display: flex;
align-items: center;
gap: 1rem;
padding-left: 1.5rem;
border-left: 1px solid var(--border-color);
}

.user-name-display {
color: var(--text-color-secondary);
white-space: nowrap;
font-weight: 500;
}

.logout-btn {
background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark));
color: #fff;
border: none;
border-radius: 12px;
padding: .7rem 1.4rem;
display: inline-flex;
align-items: center;
gap: .5em;
cursor: pointer;
transition: all .3s ease-in-out;
font-size: .9rem;
font-weight: 600;
box-shadow: 0 4px 15px rgba(var(--primary-color-rgb), .3);
}

.logout-btn:hover {
transform: translateY(-2px);
box-shadow: 0 6px 20px rgba(var(--primary-color-rgb), .4);
}

.logout-btn svg {
margin-right: .3em;
}

/* Hamburger Menu Styles */
.menu-toggle {
display: none;
background: none;
border: none;
cursor: pointer;
padding: 0;
z-index: 1001;
}

.menu-toggle .hamburger-icon {
width: 28px;
height: 22px;
display: flex;
flex-direction: column;
justify-content: space-between;
}

.menu-toggle .hamburger-icon span {
display: block;
width: 100%;
height: 3px;
background-color: var(--text-color);
border-radius: 2px;
transition: all .3s ease-in-out;
}

.card {
background: radial-gradient(circle at 50% 0%, rgba(var(--primary-color-rgb), 0.05), transparent 40%), linear-gradient(145deg, var(--card-background-color), #242436);
padding: 3rem;
border-radius: var(--border-radius);
box-shadow: 0 8px 32px rgba(0, 0, 0, .3);
border: 1px solid var(--border-color);
margin-bottom: 2rem;
width: 100%;
max-width: 1100px;
box-sizing: border-box;
position: relative;
overflow: hidden;
}

.card::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
height: 3px;
background: linear-gradient(90deg, var(--primary-color), var(--primary-color-dark));
}
.initial-card {
display: grid;
grid-template-columns: 1fr 1.5fr;
gap: 4rem;
max-width: 1100px;
padding: 3.5rem;
align-items: center;
background: linear-gradient(135deg, var(--card-background-color), #1f2937);
}

.call-flow-card {
background: linear-gradient(145deg, var(--card-background-color), #242436);
position: relative;
border-radius: var(--border-radius);
min-height: 500px;
}

.post-call-summary-card {
    min-height: 500px; /* Ensure sufficient height */
}


@keyframes cardDecisionPulse {
0% {
box-shadow: 0 8px 32px rgba(0, 0, 0, .3), 0 0 0 0 rgba(var(--primary-color-rgb), .5)
}
50% {
box-shadow: 0 8px 32px rgba(0, 0, 0, .3), 0 0 0 12px rgba(var(--primary-color-rgb), 0)
}
100% {
box-shadow: 0 8px 32px rgba(0, 0, 0, .3), 0 0 0 0 rgba(var(--primary-color-rgb), 0)
}
}

.decision-made-animation {
animation: cardDecisionPulse .7s ease-out
}

.card-title {
color: var(--text-color);
font-size: 2rem;
font-weight: 700;
margin-bottom: 1rem;
background: linear-gradient(135deg, var(--text-color), var(--primary-color));
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
}

.scenario-title-dynamic {
margin-bottom: 1.5rem;
font-size: 1.8rem;
}

.scenario-title-dynamic .step-type-icon {
margin-right: .5em;
font-size: 1.3em;
display: inline-block;
transform: translateY(.1em);
}

.card-subtitle {
color: var(--text-color-secondary);
font-size: 1.2rem;
margin-top: .5rem;
line-height: 1.6;
}

.action-button,
.decision-button,
.nav-button {
padding: 0.5rem 0.9rem; /* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù… */
border-radius: 12px;
font-weight: 600;
cursor: pointer;
transition: all .3s ease-in-out;
border: none;
font-size: 0.85rem; /* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù… */
display: inline-flex;
align-items: center;
justify-content: center;
gap: .75em;
width: auto;
box-sizing: border-box;
position: relative;
overflow: hidden;
}

.action-button:active,
.decision-button:active,
.nav-button:active {
transform: translateY(1px) scale(.98);
}

.primary-button {
background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark));
color: #fff;
box-shadow: 0 4px 15px rgba(var(--primary-color-rgb), .3);
}

.primary-button:hover {
background: linear-gradient(135deg, var(--primary-color-dark), var(--primary-color));
transform: translateY(-3px);
box-shadow: 0 6px 20px rgba(var(--primary-color-rgb), .4);
}

.primary-button:disabled {
background: var(--secondary-color);
cursor: not-allowed;
transform: none;
box-shadow: none;
opacity: .6;
}

.primary-button .btn-spinner {
width: 1.2em;
height: 1.2em;
border: 2px solid rgba(255, 255, 255, .3);
border-top-color: #fff;
border-radius: 50%;
animation: spin .8s linear infinite;
margin-right: .5em;
}

@keyframes spin {
to {
transform: rotate(360deg)
}
}

.secondary-button {
background: var(--secondary-color);
color: var(--button-text-color);
border: 1px solid var(--border-color);
}

.secondary-button:hover {
background: #4a4a60;
border-color: var(--text-color-secondary);
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(0, 0, 0, .3);
}

.danger-button {
background: transparent;
color: var(--danger-color);
border: 2px solid var(--danger-color);
font-weight: 600;
}

.danger-button:hover {
background: var(--danger-color);
color: #fff;
transform: translateY(-2px);
box-shadow: 0 4px 15px rgba(244, 67, 54, .3);
}

.highlight-scenario-title-animation {
animation: pulse-title .6s 2 ease-in-out
}

@keyframes pulse-title {
0%,
100% {
transform: scale(1);
opacity: 1;
color: var(--warning-color)
}
50% {
transform: scale(1.03);
opacity: .8;
color: var(--warning-color)
}
}

.step-actions {
margin-top: 2.5rem;
display: flex;
flex-direction: column;
gap: 1rem;
align-items: stretch;
}

.decision-button {
border: 2px solid var(--border-color);
background: var(--input-background-color);
color: var(--text-color);
text-align: center;
width: 100%;
padding: 1.25rem 2rem;
font-size: 1.1rem;
border-radius: 12px;
transition: all .3s ease;
}

.decision-button:hover {
border-color: var(--primary-color);
background: rgba(var(--primary-color-rgb), .1);
box-shadow: 0 4px 15px rgba(var(--primary-color-rgb), .2);
transform: translateY(-3px);
}

.decision-button:focus {
outline: 0;
border-color: var(--primary-color-dark);
box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), .3);
}

.decision-button.positive:hover {
background: var(--success-color);
border-color: var(--success-color);
color: #fff;
box-shadow: 0 4px 15px rgba(76, 175, 80, .4);
}

.decision-button.negative:hover {
background: var(--danger-color);
border-color: var(--danger-color);
color: #fff;
box-shadow: 0 4px 15px rgba(244, 67, 54, .4);
}

.decision-button.neutral:hover {
background: var(--primary-color-dark);
border-color: var(--primary-color);
color: #fff;
box-shadow: 0 4px 15px rgba(var(--primary-color-rgb), .4);
}

.navigation-buttons {
margin-top: 2.5rem;
display: flex;
gap: 1rem;
justify-content: center;
}

.status-bar {
background: linear-gradient(135deg, #242436, #1a1a2e);
color: var(--text-color);
padding: 1rem 2rem;
font-size: 1rem;
border-bottom: 1px solid var(--border-color);
width: 100%;
box-sizing: border-box;
text-align: center;
font-weight: 600;
}

.status-indicator {
padding: .5rem 1rem;
border-radius: 8px;
display: inline-flex;
align-items: center;
gap: .5rem;
}

.status-indicator.status-waiting {
background: rgba(244, 67, 54, .15);
color: var(--danger-color);
border: 1px solid rgba(244, 67, 54, .3);
}

.status-indicator.status-loading {
background: rgba(255, 193, 7, .15);
color: var(--warning-color);
border: 1px solid rgba(255, 193, 7, .3);
}

.status-indicator.status-in-call {
background: rgba(76, 175, 80, .15);
color: var(--success-color);
border: 1px solid rgba(76, 175, 80, .3);
}

.status-indicator.status-completed {
background: rgba(76, 175, 80, .15);
color: var(--success-color);
border: 1px solid rgba(76, 175, 80, .3);
}

.status-indicator.status-ended {
background: rgba(160, 174, 192, .15);
color: #a0aec0;
border: 1px solid rgba(160, 174, 192, .3);
}

.status-indicator.status-summary {
background: rgba(78, 140, 255, .15);
color: var(--primary-color);
border: 1px solid rgba(78, 140, 255, .3);
}

#timer-container {
position: fixed;
top: 150px; /* Adjusted for sticky header */
left: 50%;
transform: translateX(-50%);
z-index: 999;
}

#callTimer {
font-size: 1.4em;
font-weight: 700;
color: var(--primary-color);
background: rgba(28, 28, 40, .9);
backdrop-filter: blur(10px);
padding: .75rem 1.5rem;
border-radius: 12px;
display: inline-block;
min-width: 100px;
text-align: center;
border: 2px solid var(--primary-color);
box-shadow: 0 8px 25px rgba(0, 0, 0, .4);
font-family: 'Roboto Mono', monospace;
}

.steps-area {
background: var(--input-background-color);
border: 2px solid var(--border-color);
border-radius: var(--border-radius);
padding: 2.5rem;
margin: 2rem 0;
min-height: 200px;
text-align: left;
font-size: 1.3rem;
line-height: 1.8;
color: var(--text-color);
box-shadow: inset 0 2px 10px rgba(0, 0, 0, .1);
}

.steps-area p {
margin: 0;
font-weight: 500;
}

.steps-area .placeholder-text {
color: var(--text-color-secondary);
font-style: italic;
text-align: center;
font-size: 1.2rem;
}

.fade-in {
animation: fadeInAnimation .4s ease-in-out forwards
}

@keyframes fadeInAnimation {
from {
opacity: 0;
transform: translateY(20px)
}
to {
opacity: 1;
transform: translateY(0)
}
}

.app-footer {
text-align: center;
padding: 2rem;
font-size: .9rem;
color: var(--text-color-secondary);
background: transparent;
margin-top: auto;
width: 100%;
box-sizing: border-box;
border-top: 1px solid var(--border-color);
}

#callSummaryContent p {
font-size: 1.3rem;
line-height: 1.7;
margin-bottom: 1.5rem;
}

#callSummaryContent strong {
color: var(--primary-color);
font-weight: 700;
}

#callSummaryContent .quality-text.quality-good {
color: var(--success-color);
font-weight: 700;
}

#callSummaryContent .quality-text.quality-bad {
color: var(--danger-color);
font-weight: 700;
}

#callSummaryContent .quality-text.quality-na {
color: var(--text-color-secondary);
font-style: italic;
}

#callSummaryContent ul {
list-style: none;
padding-left: 0;
display: grid;
grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
gap: 1rem;
max-height: none; /* Removed max-height to prevent internal scrollbar */
}

#callSummaryContent li {
margin-bottom: 0;
padding: 1rem;
background: var(--input-background-color);
border-radius: 8px;
}

.initial-card-left {
text-align: left;
}

.initial-card-left .card-icon {
margin-bottom: 2rem;
}

.initial-card-left .card-icon svg {
width: 64px;
height: 64px;
}

.scenario-selector-container {
margin: 2rem 0;
}

.search-scenario-input {
width: 100%;
padding: 1rem 1.25rem;
background: var(--input-background-color);
border: 2px solid var(--border-color);
border-radius: 12px;
color: var(--text-color);
font-size: 1rem;
margin-bottom: 1.5rem;
box-sizing: border-box;
transition: all .3s ease;
}

.search-scenario-input:focus {
outline: 0;
border-color: var(--primary-color);
box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), .2);
}

.search-scenario-input::placeholder {
color: var(--text-color-secondary);
}

.custom-scenario-list {
display: flex;
flex-direction: column;
gap: 1rem;
max-height: 350px;
overflow-y: auto;
padding-right: .75rem;
margin-bottom: 2rem;
-ms-overflow-style: none;
scrollbar-width: none;
}

.custom-scenario-list::-webkit-scrollbar {
display: none;
}

.scenario-item {
padding: 1.25rem 1.5rem;
border-radius: 12px;
cursor: pointer;
transition: all .3s ease;
display: flex;
align-items: center;
gap: 1rem;
font-weight: 600;
border: 2px solid var(--secondary-color);
background: var(--secondary-color);
position: relative;
font-size: 1.1rem;
}

.scenario-item:hover {
background: rgba(var(--primary-color-rgb), .1);
border-color: var(--primary-color);
transform: translateX(8px);
}

.scenario-item.selected:focus,
.scenario-item:focus {
outline: 0;
border-color: var(--primary-color-dark);
box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), .3);
}

.scenario-item.selected {
background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark));
color: #fff;
font-weight: 700;
border-color: var(--primary-color-dark);
transform: translateX(8px);
}

.scenario-item .icon {
font-size: 1.4em;
}

#scenario-preview-tooltip {
position: absolute;
background: var(--card-background-color);
border: 2px solid var(--primary-color);
border-radius: 12px;
padding: 1rem 1.25rem;
box-shadow: 0 8px 25px rgba(0, 0, 0, .4);
z-index: 100;
width: 250px;
font-size: .9rem;
color: var(--text-color-secondary);
display: none;
pointer-events: none;
backdrop-filter: blur(10px);
}

#scenario-preview-tooltip strong {
color: var(--text-color);
display: block;
margin-bottom: .5rem;
font-size: 1rem;
}

.form-step-container {
margin-top: 2rem;
}

.form-field {
margin-bottom: 1.5rem;
}

.form-field label {
display: block;
margin-bottom: .75rem;
font-weight: 600;
color: var(--text-color-secondary);
font-size: 1.1rem;
}

.form-field input,
.form-field textarea,
.form-field select {
width: 100%;
padding: 1rem 1.25rem;
background: var(--input-background-color);
border: 2px solid var(--border-color);
border-radius: 12px;
color: var(--text-color);
font-size: 1rem;
box-sizing: border-box;
transition: all .3s ease;
}

.form-field input:focus,
.form-field textarea:focus,
.form-field select:focus {
outline: 0;
border-color: var(--primary-color);
box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), .2);
}

.custom-toast {
position: fixed;
right: 2rem;
bottom: 2rem;
transform: translateY(100%);
background: rgba(var(--primary-color-rgb), .15);
backdrop-filter: blur(10px);
color: var(--text-color);
padding: 1.5rem 2.5rem;
border-radius: var(--border-radius);
border: 2px solid var(--primary-color);
box-shadow: 0 8px 30px rgba(0, 0, 0, .4);
z-index: 9999;
display: flex;
align-items: center;
gap: 1.25rem;
font-size: 1.2rem;
font-weight: 600;
opacity: 0;
visibility: hidden;
transition: all .4s ease;
}

.custom-toast.show {
opacity: 1;
visibility: visible;
transform: translateY(0);
}

.custom-toast.hide {
opacity: 0;
transform: translateY(100%);
}

.custom-toast .toast-icon {
font-size: 2rem;
}

.modal-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, .7);
display: flex;
justify-content: center;
align-items: center;
z-index: 10000;
opacity: 0;
visibility: hidden;
transition: opacity .3s ease, visibility .3s ease;
backdrop-filter: blur(5px);
}

.modal-overlay.show {
opacity: 1;
visibility: visible;
}

.modal-container {
background: var(--card-background-color);
padding: 2.5rem;
border-radius: var(--border-radius);
box-shadow: 0 10px 40px rgba(0, 0, 0, .5);
border: 1px solid var(--border-color);
width: 90%;
max-width: 450px;
text-align: center;
transform: scale(.9);
transition: transform .3s ease;
}

.modal-overlay.show .modal-container {
transform: scale(1);
}

.modal-title {
font-size: 1.6rem;
font-weight: 700;
margin-top: 0;
margin-bottom: 1rem;
color: var(--text-color);
display: flex;
align-items: center;
justify-content: center;
}

.modal-body {
font-size: 1.1rem;
color: var(--text-color-secondary);
margin-bottom: 2rem;
}

.modal-actions {
display: flex;
gap: 1rem;
justify-content: center;
}
@media (max-width: 1200px) {
.initial-card {
grid-template-columns: 1fr;
gap: 3rem;
padding: 2.5rem
}
.card {
padding: 2.5rem
}
}

@media (max-width: 992px) {
.app-header {
flex-wrap: wrap;
}
.main-nav {
display: none;
flex-direction: column;
width: 100%;
background: var(--card-background-color);
position: absolute;
top: 100%;
left: 0;
padding: 1rem;
border-bottom: 1px solid var(--border-color);
box-shadow: 0 10px 20px rgba(0,0,0,.2);
}
.main-nav.active {
display: flex;
}
.nav-link {
text-align: center;
padding: 1rem;
}
.menu-toggle {
display: block;
order: -1; /* Place it before other items in flex container */
}
.header-controls {
width: auto;
gap: 1rem;
}
.logo-container {
flex-grow: 1;
justify-content: center;
}
.user-info {
padding-left: 0;
border-left: none;
}
}

@media (max-width: 768px) {
.app-main {
padding: 1.5rem
}
.app-header {
padding: 1rem 1.5rem;
flex-wrap: wrap;
gap: 1rem;
}
.header-controls {
width: auto;
justify-content: space-between;
}
.card {
padding: 2rem 1.5rem
}
.initial-card {
padding: 2rem 1.5rem
}
.steps-area {
padding: 2rem 1.5rem;
font-size: 1.2rem
}
.decision-button {
padding: 1rem 1.5rem;
font-size: 1rem
}
.navigation-buttons {
flex-direction: column
}
.action-button,
.nav-button {
width: 100%
}
}

@media (max-width: 480px) {
.app-main {
padding: 1rem
}
.card {
padding: 1.5rem 1rem
}
.card-title {
font-size: 1.6rem
}
.steps-area {
padding: 1.5rem 1rem;
font-size: 1.1rem
}
.scenario-item {
padding: 1rem 1.25rem;
font-size: 1rem
}
}

.loading-skeleton {
background: linear-gradient(90deg, var(--input-background-color) 25%, var(--border-color) 50%, var(--input-background-color) 75%);
background-size: 200% 100%;
animation: loading 1.5s infinite;
border-radius: 8px;
height: 1.5rem;
margin: .75rem 0;
}

@keyframes loading {
0% {
background-position: 200% 0
}
100% {
background-position: -200% 0
}
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Øµ Ù„Ø®Ø·ÙˆØ© Ø§Ù„ÙÙˆØ±Ù… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„ØªØ¸Ù‡Ø± Ø¨Ø´ÙƒÙ„ Ù…Ù…ÙŠØ² ÙˆØ¹Ø±ÙŠØ¶ */
.steps-area.form-mode {
    background-color: #1e293b; /* Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø£ØºÙ…Ù‚ Ù‚Ù„ÙŠÙ„Ø§Ù‹ ÙˆÙ…Ù…ÙŠØ² */
    border: 1px solid var(--primary-color); /* Ø­Ø¯ÙˆØ¯ Ø²Ø±Ù‚Ø§Ø¡ Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„ØªÙˆØ«ÙŠÙ‚ */
    box-shadow: 0 0 20px rgba(78, 140, 255, 0.1);
    padding: 2rem;
    max-width: 100%; /* Ø§Ø³ØªØºÙ„Ø§Ù„ Ø§Ù„Ù…Ø³Ø§Ø­Ø© ÙƒØ§Ù…Ù„Ø© */
}

.steps-area.form-mode p {
    font-size: 1.1rem;
    color: var(--text-color-secondary);
    margin-bottom: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 1rem;
}

/* ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙÙˆØ±Ù… */
.form-step-container {
    display: grid;
    grid-template-columns: 1fr 1fr; /* ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„Ø¹Ù…ÙˆØ¯ÙŠÙ† */
    gap: 1.5rem;
}

/* Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ø²ÙŠ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªØ§Ø®Ø¯ Ø§Ù„Ø¹Ø±Ø¶ ÙƒÙ„Ù‡ */
.form-field:has(textarea), 
.form-field:has(select[id="escalation_action"]) {
    grid-column: span 2;
}

/* ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙŠØ±Ø¬Ø¹ Ø¹Ù…ÙˆØ¯ ÙˆØ§Ø­Ø¯ */
@media (max-width: 768px) {
    .form-step-container {
        grid-template-columns: 1fr;
    }
    .form-field:has(textarea), 
    .form-field:has(select[id="escalation_action"]) {
        grid-column: span 1;
    }
}
</style>

</head>
<body>
<div class="app-container">
    <header class="app-header">
        <div class="logo-container">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color:#4e8cff;width:32px;height:32px">
                <path d="M6 17L10 17M6 12L12 12M6 7L14 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                <path d="M15 6L19 10L15 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                <rect x="3" y="3" width="18" height="18" rx="3" stroke="currentColor" stroke-width="1.5" fill="transparent" opacity="0.6"></rect>
            </svg>
            <span class="app-title">Elevo Core</span>
        </div>

        <button class="menu-toggle" id="menu-toggle-btn" aria-label="Toggle menu">
                <div class="hamburger-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </button>

    <div class="header-controls" id="header-controls">
        <nav class="main-nav" id="main-nav">
            <a href="./dashboard.html" class="nav-link">Admin Dashboard</a>
            <a href="./rtm-dashboard.html" class="nav-link">RTM Dashboard</a>
            <a href="./agent-portal.html" class="nav-link">Agent Portal</a>
            <a href="./core-flow.html" class="nav-link active">Core Flow Assistant</a>
            <a href="approvals.html" class="nav-link">Approvals</a>
        </nav>
        <div class="user-info">
            <span id="userName" style="color:#d1d5db;font-weight:500;min-height:1.2em;display:inline-block"></span>
            <button id="logoutButton" class="logout-btn">Logout</button>
        </div>
    </div>
</header>
<div class=status-bar>
<div id=systemStatus class="status-indicator status-waiting">
<svg xmlns=http://www.w3.org/2000/svg width=16 height=16 viewBox="0 0 24 24" fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round>
<circle cx=12 cy=12 r=10></circle>
</svg>
Waiting for Ticket
</div>
</div>
<div id=timer-container>
<div id=callTimer style=display:none>00:00</div>
</div>
<main class=app-main>
<div id=auth-loading class=loading-container style=display:none;flex-direction:column;align-items:center;justify-content:center;height:60vh>
<div class=spinner style=width:50px;height:50px;border-top-color:var(--primary-color)></div>
<p style=color:var(--text-color-secondary);margin-top:1.5rem;font-size:1.1rem>Initializing Assistant...</p>
</div>
<div id=initial-view class="card initial-card fade-in" style=display:none>
<div class=initial-card-left>
<div class=card-icon>
<svg xmlns=http://www.w3.org/2000/svg viewBox="0 0 24 24" fill=var(--primary-color) width=72 height=72>
<path d="M12 2C6.486 2 2 6.486 2 12C2 17.514 6.486 22 12 22C17.514 22 22 17.514 22 12C22 6.486 17.514 2 12 2ZM12 20C7.589 20 4 16.411 4 12C4 7.589 7.589 4 12 4C16.411 4 20 7.589 20 12C20 16.411 16.411 20 12 20Z"/>
<path d="M12 11C10.897 11 10 10.103 10 9C10 7.897 10.897 7 12 7C13.103 7 14 7.897 14 9C14 10.103 13.103 11 12 11Z"/>
<path d="M16.002 16.246C15.483 15.219 14.544 14.5 13.333 14.5H10.667C9.456 14.5 8.517 15.219 7.998 16.246C7.933 16.386 7.996 16.553 8.114 16.641C8.657 17.053 9.737 17.5 12 17.5C14.263 17.5 15.343 17.053 15.886 16.641C16.004 16.553 16.067 16.386 16.002 16.246Z"/>
</svg>
</div>
<h2 class=card-title>Core Flow Assistant</h2>
<p class=card-subtitle>Your dedicated assistant for streamlined ticket resolution. Select a scenario below to begin handling customer interactions with guided step-by-step support.</p>
</div>
<div class=initial-card-right>
<div class=scenario-selector-container>
<label for=searchScenarioInput style=display:block;margin-bottom:.75rem;font-weight:600;color:var(--text-color-secondary);font-size:1.1rem>Select Scenario:</label>
<input type=search id=searchScenarioInput class=search-scenario-input placeholder="Search scenarios...">
<div id=customScenarioList class=custom-scenario-list role=listbox>
<div class=scenario-item style=justify-content:center>
<div class=loading-skeleton style=width:100%;height:1.5rem></div>
</div>
</div>
<input type=hidden id=scenarioDropdownValue name=scenarioId>
</div>
<div style=display:flex;justify-content:flex-start;margin-top:2rem>
<button id=receive-call-btn class="action-button primary-button" disabled style="padding:1.25rem 2.5rem;font-size:1.1rem">
<span class=btn-text>Start Ticket</span>
</button>
</div>
</div>
<!-- The two unnecessary audio elements have been removed from here -->
<audio id="updateNotificationSound" src="assets/notification.mp3" preload="auto"></audio>
</div>
<div id=call-flow-view class="card call-flow-card fade-in" style=display:none>
<h3 id=scenario-title class="card-title scenario-title-dynamic">
<span id=step-type-icon class=step-type-icon></span>
<span id=scenario-title-text>Ticket Scenario</span>
</h3>
<div id=steps-container class=steps-area>
<p class=placeholder-text>Loading ticket steps...</p>
</div>
<div id=decision-buttons-container class=step-actions></div>
<div class=navigation-buttons>
<button id=prev-step-btn class="nav-button secondary-button" style=display:none>
<svg xmlns=http://www.w3.org/2000/svg width=20 height=20 viewBox="0 0 24 24" fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round style=margin-right:.5em>
<polyline points="15 18 9 12 15 6"></polyline>
</svg>
<span>Previous</span>
</button>
<button id=next-step-btn class="nav-button primary-button">
<span class=btn-text>Next Step</span>
<svg xmlns=http://www.w3.org/2000/svg width=20 height=20 viewBox="0 0 24 24" fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round style=margin-left:.5em>
<polyline points="9 18 15 12 9 6"></polyline>
</svg>
</button>
</div>
<div style=display:flex;justify-content:center;margin-top:2rem>
<button id=end-call-btn class="nav-button danger-button" style="display:none;padding:1rem 2rem">
<svg xmlns=http://www.w3.org/2000/svg width=18 height=18 viewBox="0 0 24 24" fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round style=margin-right:.5em>
<path d="M6 18L18 6M6 6l12 12"/>
</svg>
<span>End Ticket</span>
</button>
</div>
</div>
<div id=postCallSummary class="card post-call-summary-card fade-in" style=display:none>
<h3 class=card-title>Ticket Summary</h3>
<div id=callSummaryContent></div>
<div style=display:flex;justify-content:center;margin-top:2.5rem>
<button id=returnToInitialViewBtn class="action-button primary-button" style="padding:1.25rem 2.5rem;font-size:1.1rem">
<svg xmlns=http://www.w3.org/2000/svg width=20 height=20 viewBox="0 0 24 24" fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round style=margin-right:.5em>
<path d="M3 12h18M3 6h12M3 18h15"/>
</svg>
<span>New Ticket</span>
</button>
</div>
</div>
<div id=scenario-preview-tooltip></div>
</main>
<div id=custom-toast-notification class=custom-toast>
<span class=toast-icon>âš ï¸</span>
<span id=toast-message class=toast-message></span>
</div>

<div id="custom-confirm-modal" class="modal-overlay">
    <div class="modal-container">
        <h3 class="modal-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 0.5em; color: var(--warning-color);">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            Confirm End Ticket
        </h3>
        <p class="modal-body">Are you sure you want to end this ticket?</p>
        <div class="modal-actions">
            <button id="modal-cancel-btn" class="nav-button secondary-button">Cancel</button>
            <button id="modal-confirm-btn" class="nav-button danger-button">Confirm End</button>
        </div>
    </div>
</div>

<footer class=app-footer>
<p>Â© <span id=currentYear></span> Mohamed Elmenisy - Elevo Core. All rights reserved.</p>
</footer>
</div>

<script type="module">
    // FINAL VERSION - Cleaned and with extra logging
    import { supabase } from './supabaseClient.js';
    import { protectPage } from './role-check.js';

    document.addEventListener('DOMContentLoaded', async () => {
        await protectPage([]);
        const authLoadingDiv = document.getElementById("auth-loading");
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
            initializeAppLogic(user);
            authLoadingDiv.style.display = "none";
        } else {
            authLoadingDiv.innerHTML = '<p style="color:var(--danger-color); text-align:center; font-size: 1.2rem;">Authentication failed. Redirecting...</p>';
        }
    });

    // The variables for the removed audio elements have been deleted from this line
    const initialViewDiv=document.getElementById("initial-view"),callFlowViewDiv=document.getElementById("call-flow-view"),postCallSummaryDiv=document.getElementById("postCallSummary"),receiveCallBtn=document.getElementById("receive-call-btn"),scenarioTitleElement=document.getElementById("scenario-title-text"),stepTypeIconElement=document.getElementById("step-type-icon"),stepsContainer=document.getElementById("steps-container"),decisionButtonsContainer=document.getElementById("decision-buttons-container"),prevStepBtn=document.getElementById("prev-step-btn"),nextStepBtn=document.getElementById("next-step-btn"),endCallBtn=document.getElementById("end-call-btn"),logoutButton=document.getElementById("logoutButton"),systemStatusDiv=document.getElementById("systemStatus"),callTimerDiv=document.getElementById("callTimer"),callSummaryContentDiv=document.getElementById("callSummaryContent"),returnToInitialViewBtn=document.getElementById("returnToInitialViewBtn"),searchScenarioInput=document.getElementById("searchScenarioInput"),scenarioPreviewTooltip=document.getElementById("scenario-preview-tooltip"),updateNotificationSound=document.getElementById("updateNotificationSound");
    
    document.getElementById("currentYear").textContent = new Date().getFullYear();
    
    let currentUser=null,currentScenario=null,currentStepId=null,stepHistory=[],callSessionId=null,callStartTimeISO=null,stepTimerInterval=null,stepStartTime=0,accumulatedStepDurations={},stepVisitCount={};
    const SESSION_STATE_KEY="elevoCoreActiveCallState_v4";
    let realtimeSubscription = null;

    function setButtonLoadingState(e,t,n="Submit"){const i=e.querySelector(".btn-text");if(e.disabled=t,t)i&&(i.textContent="Loading..."),e.insertAdjacentHTML("afterbegin",'<span class="btn-spinner"></span>');else{i&&(i.textContent=n);const t=e.querySelector(".btn-spinner");t&&t.remove()}}
    function updateSystemStatus(e,t="status-waiting"){if(systemStatusDiv){systemStatusDiv.textContent=e,systemStatusDiv.className=`status-indicator ${t}`;let n="";switch(t){case"status-waiting":n="ğŸ”´";break;case"status-loading":n="ğŸŸ¡";break;case"status-in-call":n="ğŸŸ¢";break;case"status-completed":n="âœ…";break;case"status-ended":n="âšª";break;case"status-summary":n="ğŸ“Š"}systemStatusDiv.innerHTML=`${n} ${e}`}}
    function animateView(e){e&&(e.classList.remove("fade-in"),e.offsetWidth,e.classList.add("fade-in"),e.style.display=e.classList.contains("initial-card")?"grid":"block")}
    let toastTimeout;
    function showCustomToast(e, isUpdate = false){const t=document.getElementById("custom-toast-notification"),n=document.getElementById("toast-message"), i=t.querySelector(".toast-icon");t&&n&&(clearTimeout(toastTimeout),n.textContent=e, i.textContent = isUpdate ? 'ğŸ”„' : 'âš ï¸', t.classList.remove("hide"),t.classList.add("show"),toastTimeout=setTimeout((()=>{t.classList.remove("show"),t.classList.add("hide")}),4e3))}
    
    async function initializeAppLogic(user) {
        const { data: profile } = await supabase.from('users').select('name').eq('id', user.id).single();
        currentUser = { id: user.id, email: user.email, name: profile?.name || user.email };
        
        if (restoreCallState()) {
            switchToCallFlowView(false);
            renderStep();
            updateSystemStatus("In Ticket (Restored)", "status-in-call");
            if (currentScenario) {
                console.log('Restored session, will subscribe to:', currentScenario.id);
                subscribeToScenarioUpdates(currentScenario.id);
            }
        } else {
            switchToInitialView();
            await loadActiveScenarios();
        }
        // Call the updateDailyTarget function as requested
        updateDailyTarget();
    }

    function subscribeToScenarioUpdates(scenarioId) {
        if (!scenarioId) {
            console.error("Cannot subscribe to updates without a scenarioId.");
            return;
        }
        if (realtimeSubscription) {
            supabase.removeChannel(realtimeSubscription);
        }

        realtimeSubscription = supabase
            .channel(`realtime-scenario-${scenarioId}`)
            .on(
                'postgres_changes',
                {
                    event: 'UPDATE',
                    schema: 'public',
                    table: 'call_scenarios',
                    filter: `id=eq.${scenarioId}`
                },
                (payload) => {
                    console.log('âœ… Real-time update received!', payload.new);
                    showCustomToast("A step in this ticket has been updated live.", true);
                    
                    // START: Play notification sound
                    if (updateNotificationSound) {
                        updateNotificationSound.currentTime = 0; // Rewind to start
                        updateNotificationSound.play().catch(error => {
                            console.warn("Update notification sound could not be played:", error);
                        });
                    }
                    // END: Play notification sound
                    
                    currentScenario = payload.new;
                    
                    renderStep();
                    saveCallState();
                }
            )
            .subscribe((status) => {
                if (status === 'SUBSCRIBED') {
                    console.log(`âœ… Successfully subscribed to real-time updates for scenario ${scenarioId}`);
                } else {
                    console.log(`Subscription status: ${status}`);
                }
            });
    }

    function switchToInitialView(){callFlowViewDiv.style.display="none",postCallSummaryDiv.style.display="none",callTimerDiv.style.display="none",animateView(initialViewDiv),updateSystemStatus("Waiting for Ticket","status-waiting"); if(realtimeSubscription) {console.log("Unsubscribing from channel."); supabase.removeChannel(realtimeSubscription); realtimeSubscription = null;}}
    function switchToCallFlowView(e=!0){initialViewDiv.style.display="none",postCallSummaryDiv.style.display="none",e?animateView(callFlowViewDiv):callFlowViewDiv.style.display="block",updateSystemStatus("In Ticket","status-in-call")}
    function switchToSummaryView(){initialViewDiv.style.display="none",callFlowViewDiv.style.display="none",callTimerDiv.style.display="none",animateView(postCallSummaryDiv),updateSystemStatus("Review Ticket Summary","status-summary"); if(realtimeSubscription) {console.log("Unsubscribing from channel."); supabase.removeChannel(realtimeSubscription); realtimeSubscription = null;}}
    
    // UPDATED: loadActiveScenarios with Department Filtering
    async function loadActiveScenarios() {
        setButtonLoadingState(receiveCallBtn, true, "Start Ticket");
        const listContainer = document.getElementById("customScenarioList");
        const hiddenInput = document.getElementById("scenarioDropdownValue");
        
        // Ø¹Ø±Ø¶ Skeleton Loading Ù„Ø­ÙŠÙ† Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        listContainer.innerHTML = `<div class="scenario-item" style="justify-content: center;"><div class="loading-skeleton" style="width: 100%; height: 1.5rem;"></div></div>`;
        hiddenInput.value = "";

        try {
            // 1. Ù…Ø¹Ø±ÙØ© Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
            // Ù†ÙØªØ±Ø¶ Ø£Ù†Ù†Ø§ Ø®Ø²Ù†Ø§ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ currentUser Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            // Ù„ÙƒÙ† Ù„Ù„Ø£Ù…Ø§Ù† Ø³Ù†Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø­Ø¯Ø« Ù…Ù† Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ² Ù…Ø¨Ø§Ø´Ø±Ø©
            const { data: userData, error: userError } = await supabase
                .from('users')
                .select('department')
                .eq('id', currentUser.id)
                .single();

            if (userError) throw userError;
            
            const userDept = userData.department || 'General'; 
            console.log("User Department:", userDept); // Ù„Ù„ØªØ£ÙƒØ¯ ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„

            // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø³Ù…
            // Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©: Ù‡Ø§Øª Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù„ÙŠ Ù‚Ø³Ù…Ù‡Ø§ ÙŠØ·Ø§Ø¨Ù‚ Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ø£Ùˆ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (General)
            // Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ Ù‚Ù…Øª Ø¨ØªØ­Ø¯ÙŠØ« Ø¹Ù…ÙˆØ¯ department ÙÙŠ Ø¬Ø¯ÙˆÙ„ call_scenarios Ù„Ø¨Ø¹Ø¶ Ø§Ù„ØµÙÙˆÙ Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„ÙÙ„ØªØ±
            let query = supabase
                .from("call_scenarios")
                .select("id, title, steps, description, department")
                .eq("status", 'approved')
                .order("created_at", { ascending: false });

            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "Admin" Ø£Ùˆ "Manager"ØŒ Ù†Ø·Ø¨Ù‚ Ø§Ù„ÙÙ„ØªØ±
            // (ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø±Ø· Ø­Ø³Ø¨ Ø§Ù„Ø±ÙˆÙ„Ø² Ø¹Ù†Ø¯Ùƒ)
        if (userDept !== 'Admin') {
                // Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± ÙŠØ¹Ù†ÙŠ: Ù‡Ø§Øª Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ù„Ùˆ Ø§Ù„Ù‚Ø³Ù… Ø¨ØªØ§Ø¹Ù‡ = Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ = General
            query = query.eq('department', userDept);
            }

            const { data: scenarios, error: scenariosError } = await query;

            if (scenariosError) throw scenariosError;

            listContainer.innerHTML = "";
            if (scenarios && scenarios.length > 0) {
                scenarios.forEach((scenario => {
                    const item = document.createElement("div");
                    item.className = "scenario-item";
                    item.dataset.value = scenario.id;
                    item.setAttribute("role", "option");
                    item.setAttribute("tabindex", "0");
                    
                    // Ø£ÙŠÙ‚ÙˆÙ†Ø© ØªØ¹Ø¨ÙŠØ±ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (ÙƒÙ…Ø§ ÙƒØ§Ù† ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚)
                    let icon = "ğŸ“";
                    const titleLower = scenario.title.toLowerCase();
                    if (titleLower.includes("device")) icon = "ğŸ“±";
                    else if (titleLower.includes("complaint")) icon = "ğŸ˜ ";
                    else if (titleLower.includes("billing")) icon = "ğŸ’°";

                    // Ø¥Ø¶Ø§ÙØ© ÙˆØ³Ù… Ø§Ù„Ù‚Ø³Ù… (Badge) Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
                    const deptBadge = `<span style="font-size: 0.7em; background: rgba(78,140,255,0.2); color: #4e8cff; padding: 2px 6px; border-radius: 4px; margin-left: 8px;">${scenario.department || 'General'}</span>`;

                    item.innerHTML = `
                        <span class="icon">${icon}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">${scenario.title} ${deptBadge}</div>
                            <div style="font-size: 0.9rem; color: var(--text-color-secondary);">
                                ${scenario.steps?.length || 0} steps
                            </div>
                        </div>
                    `;

                    // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·
                    const selectScenario = () => {
                        const prevSelected = listContainer.querySelector(".selected");
                        if (prevSelected) prevSelected.classList.remove("selected");
                        item.classList.add("selected");
                        hiddenInput.value = scenario.id;
                        receiveCallBtn.disabled = false;
                    };

                    item.addEventListener("click", selectScenario);
                    listContainer.appendChild(item);
                }));
                receiveCallBtn.disabled = true; // ÙŠØ¨Ø¯Ø£ Ù…Ø¹Ø·Ù„ Ø­ØªÙ‰ ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
            } else {
                listContainer.innerHTML = `<div class="scenario-item" style="justify-content: center; color: var(--text-color-secondary);">No scenarios found for ${userDept}</div>`;
                receiveCallBtn.disabled = true;
            }

        } catch (err) {
            console.error("Error loading scenarios:", err);
            listContainer.innerHTML = `<div class="scenario-item" style="color: var(--danger-color); justify-content: center;">Error loading data</div>`;
        } finally {
            setButtonLoadingState(receiveCallBtn, false, "Start Ticket");
        }
    }

    // UPDATED: renderStep (With Form Mode Logic + Fixes)
    function renderStep() {
        if (!currentScenario || !currentStepId) return;
        
        const step = currentScenario.steps.find(s => s.id === currentStepId);
        if (!step) return finishCall(false, `Error: Step ${currentStepId} not found`);

        // --- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§ (Form Mode) ---
        const stepsContainer = document.getElementById("steps-container");
        const decisionButtonsContainer = document.getElementById("decision-buttons-container");
        const nextBtn = document.getElementById("next-step-btn");
        const prevBtn = document.getElementById("prev-step-btn");
        const endBtn = document.getElementById("end-call-btn");

        if (step.type === "form") {
            stepsContainer.classList.add("form-mode"); // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø¹Ø±ÙŠØ¶
            document.getElementById("scenario-title-text").textContent = "Final Documentation"; // ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        } else {
            stepsContainer.classList.remove("form-mode"); // Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø´ÙƒÙ„ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
            document.getElementById("scenario-title-text").textContent = currentScenario.title;
        }
        // --------------------------------------

        // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
        let icon = "ğŸ—£ï¸"; 
        if (step.type === "decision") icon = "ğŸ¤”";
        if (step.type === "form") icon = "ğŸ“"; 
        document.getElementById("step-type-icon").textContent = icon;

        // 2. ØªÙØ±ÙŠØº Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø¯ÙŠÙ…
        stepsContainer.innerHTML = "";
        decisionButtonsContainer.innerHTML = "";

        // 3. Ø¹Ø±Ø¶ Ù†Øµ Ø§Ù„Ø®Ø·ÙˆØ©
        const textP = document.createElement("p");
        textP.innerHTML = step.text.replace(/\n/g, "<br>");
        stepsContainer.appendChild(textP);

        // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¸Ù‡ÙˆØ± Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        prevBtn.style.display = stepHistory.length > 0 ? "inline-flex" : "none";
        endBtn.style.display = "inline-flex"; // Ensure End Ticket is visible

        // 4. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ù†ÙˆØ§Ø¹
        if (step.type === "form" && Array.isArray(step.fields)) {
            // --- Form Logic ---
            const formContainer = document.createElement("div");
            formContainer.className = "form-step-container"; // Grid layout
            formContainer.id = "dynamic-step-form";

            step.fields.forEach(field => {
                const fieldWrapper = document.createElement("div");
                fieldWrapper.className = "form-field";

                const label = document.createElement("label");
                label.setAttribute("for", field.id);
                label.textContent = field.label + (field.required ? " *" : "");
                fieldWrapper.appendChild(label);

                let inputEl;
                if (field.type === "select") {
                    inputEl = document.createElement("select");
                    const defaultOpt = document.createElement("option");
                    defaultOpt.value = "";
                    defaultOpt.textContent = "-- Select --";
                    inputEl.appendChild(defaultOpt);
                    if (field.options) {
                        field.options.forEach(optVal => {
                            const opt = document.createElement("option");
                            opt.value = optVal;
                            opt.textContent = optVal;
                            inputEl.appendChild(opt);
                        });
                    }
                } else if (field.type === "textarea") {
                    inputEl = document.createElement("textarea");
                    inputEl.rows = 3;
                } else {
                    inputEl = document.createElement("input");
                    inputEl.type = field.type || "text";
                }

                inputEl.id = field.id;
                inputEl.name = field.id;
                if (field.required) inputEl.required = true;
                if (field.placeholder) inputEl.placeholder = field.placeholder;

                fieldWrapper.appendChild(inputEl);
                formContainer.appendChild(fieldWrapper);
            });
            stepsContainer.appendChild(formContainer);
            
            nextBtn.style.display = "inline-flex";
            const btnText = nextBtn.querySelector(".btn-text");
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø®Ø·ÙˆØ© ØªØ§Ù„ÙŠØ©ØŒ Ø§Ù„Ø²Ø± "Ø­ÙØ¸ ÙˆÙ…ØªØ§Ø¨Ø¹Ø©"ØŒ ÙˆØ¥Ù„Ø§ "Ø­ÙØ¸ ÙˆØ¥Ù†Ù‡Ø§Ø¡"
            if (btnText) btnText.textContent = step.next_id ? "Save & Continue" : "Save & Finish";

        } else if (step.type === "decision" && Array.isArray(step.options)) {
            // --- Decision Logic ---
             step.options.forEach(opt => {
                const btn = document.createElement("button");
                btn.className = "decision-button";
                btn.textContent = opt.label;
                if (opt.label.toLowerCase().includes("yes") || opt.label.toLowerCase().includes("solved")) btn.classList.add("positive");
                if (opt.label.toLowerCase().includes("no") || opt.label.toLowerCase().includes("persist")) btn.classList.add("negative");
                btn.addEventListener("click", () => navigateToStep(opt.next_id));
                decisionButtonsContainer.appendChild(btn);
            });
            nextBtn.style.display = "none";

        } else {
            // --- Normal Step Logic ---
            nextBtn.style.display = "inline-flex";
            const btnText = nextBtn.querySelector(".btn-text");
            if (btnText) {
                if (step.next_id) btnText.textContent = "Next Step";
                else btnText.textContent = "Finish Ticket";
            }
        }

        startStepTimer();
        saveCallState();
    }

    function navigateToStep(e){if(stepVisitCount[e]=(stepVisitCount[e]||0)+1,stepVisitCount[e]>5)return void finishCall(!1,"Error: Potential infinite loop detected. Ticket terminated.");if(document.getElementById("call-flow-view").classList.add("decision-made-animation"),setTimeout((()=>document.getElementById("call-flow-view").classList.remove("decision-made-animation")),700),stopAndRecordStepTimer(),null==e||""===e)return void finishCall(!0,"Reached end of scenario path.");currentScenario.steps.find((t=>t?.id===e))?(currentStepId&&stepHistory.push(currentStepId),currentStepId=e,renderStep()):finishCall(!1,`Error: Path broken, step ${e} not found.`)}
    
    // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ§Ø±Ø¬Øª Ø§Ù„ÙŠÙˆÙ…ÙŠ
    async function updateDailyTarget() {
        if (!currentUser || !currentUser.id) return;
        
        const today = new Date().toISOString().split('T')[0]; // ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… YYYY-MM-DD
        const startOfToday = new Date(today + 'T00:00:00Z').toISOString();

        try {
            const { count, error } = await supabase
                .from('call_sessions')
                .select('*', { count: 'exact', head: true })
                .eq('user_id', currentUser.id) // ØªØ°Ø§ÙƒØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø·
                .gte('start_time', startOfToday); // Ø§Ù„Ù„ÙŠ Ø¨Ø¯Ø£Øª Ø§Ù„Ù†Ù‡Ø§Ø±Ø¯Ø©

            if (error) throw error;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ù‚Ù… ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ù†ÙØªØ±Ø¶ Ø§Ù† Ø§Ù„ØªØ§Ø±Ø¬Øª Ø§Ù„Ø«Ø§Ø¨Øª Ù‡Ùˆ 40 Ù…Ø«Ù„Ø§Ù‹)
            const targetElement = document.querySelector('.daily-target-display'); // Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ø¹Ù†ØµØ± ÙƒØ¯Ø©
            // Ø£Ùˆ Ù„Ùˆ Ø¨ØªØ³ØªØ®Ø¯Ù… Ù…ÙƒØ§Ù† Ù…Ø¹ÙŠÙ† ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±ØŒ Ø¹Ø¯Ù„Ù‡ Ù‡Ù†Ø§.
            // Ø¨Ù…Ø§ Ø§Ù†ÙŠ Ù…Ø´ Ø´Ø§ÙŠÙ HTML Ø§Ù„Ù‡ÙŠØ¯Ø± Ø¨ØªØ§Ø¹ Ø§Ù„ØªØ§Ø±Ø¬Øª Ø¨Ø§Ù„Ø¸Ø¨Ø·ØŒ Ù‡ÙØªØ±Ø¶ Ø§Ù†Ùƒ Ø¹Ø§ÙŠØ² ØªØ¹Ø±Ø¶Ù‡ ÙÙŠ Ø§Ù„ console Ø­Ø§Ù„ÙŠØ§Ù‹ Ø§Ùˆ Ø§Ø¯ÙŠÙ†ÙŠ Ø§Ù„ ID Ø¨ØªØ§Ø¹Ù‡.
            // Ù„Ùˆ Ø§Ù„Ø¹Ù†ØµØ± Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù€ HTMLØŒ Ù…Ù…ÙƒÙ† Ù†Ø¶ÙŠÙÙ‡ Ø¬Ù†Ø¨ Ø§Ù„Ø§Ø³Ù….
            
            const statsElement = document.getElementById('userName'); 
            if(statsElement) {
               // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø¬Ù†Ø¨ Ø§Ù„Ø§Ø³Ù… Ù…Ø¤Ù‚ØªØ§Ù‹
               statsElement.innerHTML = `${currentUser.name} <span style="color: var(--success-color); margin-left: 10px; font-size: 0.9em;">(Today: ${count})</span>`;
            }

        } catch (err) {
            console.error("Error updating daily target:", err);
        }
    }
    
    function startStepTimer(){callTimerDiv.style.display="inline-block",stepTimerInterval&&clearInterval(stepTimerInterval),0===stepStartTime&&(stepStartTime=Date.now());const e=()=>{const e=callStartTimeISO?Math.floor((Date.now()-new Date(callStartTimeISO).getTime())/1e3):0,t=String(Math.floor(e/60)).padStart(2,"0"),n=String(e%60).padStart(2,"0");callTimerDiv.textContent=`${t}:${n}`};e(),stepTimerInterval=setInterval(e,1e3)}
    function stopAndRecordStepTimer(){stepTimerInterval&&clearInterval(stepTimerInterval),stepTimerInterval=null,stepStartTime>0&&currentStepId&&accumulatedStepDurations.hasOwnProperty(currentStepId)&&(accumulatedStepDurations[currentStepId]+=Math.floor((Date.now()-stepStartTime)/1e3)),stepStartTime=0}
    async function finishCall(e,t){stopAndRecordStepTimer();const n=(new Date).toISOString(),i=callStartTimeISO?Math.floor((new Date(n)-new Date(callStartTimeISO))/1e3):0,a=e?"Good":i>0?"Bad":"N/A",s=t||(e?"Scenario completed.":"Ticket ended prematurely.");updateSystemStatus(e?"Completed":"Ended",e?"status-completed":"status-ended"),callSessionId&&await supabase.from("call_sessions").update({end_time:n,duration:i,completed:e,call_quality:a,quality_reason:s}).eq("id",callSessionId),displayPostCallSummary(a,s,i),clearCallState()}
    function displayPostCallSummary(e,t,n){let i=`<p><strong>Ticket Quality:</strong> <span class="quality-text quality-${e?.toLowerCase()||"na"}">${e||"N/A"}</span></p><p><strong>Reason:</strong> ${t||"N/A"}</p><p><strong>Total Handle Time:</strong> ${Math.floor(n/60)}m ${n%60}s</p><hr style="margin: 2rem 0; border-color: var(--border-color);"><p><strong>Time Spent on Steps:</strong></p><ul>`;if(currentScenario?.steps){[...new Set([...stepHistory,currentStepId])].filter((e=>null!=e)).forEach((e=>{const t=currentScenario.steps.find((t=>t?.id===e)),n=accumulatedStepDurations[e]||0;t&&n>0&&(i+=`<li>"${t.text.substring(0,60)}..."<br><strong style="color: var(--primary-color);">${n}s</strong></li>`)}))}else i+='<li style="color: var(--text-color-secondary); font-style: italic;">No step data available.</li>';i+="</ul>",callSummaryContentDiv.innerHTML=i,switchToSummaryView()}
    function saveCallState(){if(!callSessionId)return;const e={callSessionId:callSessionId,currentScenario:currentScenario,currentStepId:currentStepId,stepHistory:stepHistory,accumulatedStepDurations:accumulatedStepDurations,stepStartTime:stepStartTime,callStartTimeISO:callStartTimeISO,stepVisitCount:stepVisitCount};sessionStorage.setItem(SESSION_STATE_KEY,JSON.stringify(e))}
    function restoreCallState(){const e=JSON.parse(sessionStorage.getItem(SESSION_STATE_KEY));return!(!e||!e.callSessionId)&&(callSessionId=e.callSessionId,currentScenario=e.currentScenario,currentStepId=e.currentStepId,stepHistory=e.stepHistory,accumulatedStepDurations=e.accumulatedStepDurations,stepStartTime=e.stepStartTime||Date.now(),callStartTimeISO=e.callStartTimeISO,stepVisitCount=e.stepVisitCount||{},!0)}
    function clearCallState(){sessionStorage.removeItem(SESSION_STATE_KEY)}
    function resetCallState(e=!1){stopAndRecordStepTimer(),clearCallState(),callSessionId=currentStepId=currentScenario=null,stepHistory=[],accumulatedStepDurations={},stepVisitCount={},stepStartTime=0,e&&switchToInitialView()}
    
    // This part has been simplified as we removed the unnecessary sounds
    receiveCallBtn.addEventListener("click",(async()=>{const e=document.getElementById("scenarioDropdownValue").value;if(e){setButtonLoadingState(receiveCallBtn,!0,"Start Ticket"),resetCallState(),switchToCallFlowView(),updateSystemStatus("Loading Scenario...","status-loading"),stepsContainer.innerHTML='<p class="placeholder-text">Loading scenario steps...</p>',decisionButtonsContainer.innerHTML="",scenarioTitleElement.textContent="Loading...";try{const{data:t,error:n}=await supabase.from("call_scenarios").select("id, title, steps").eq("id",e).single();if(n)throw n;if(!t||!Array.isArray(t.steps)||0===t.steps.length)throw new Error("Scenario data is invalid.");currentScenario=t,currentStepId=currentScenario.steps[0].id,accumulatedStepDurations={},currentScenario.steps.forEach((e=>{e?.id&&(accumulatedStepDurations[e.id]=0)})),callStartTimeISO=(new Date).toISOString();const{data:i,error:a}=await supabase.from("call_sessions").insert({user_id:currentUser.id,scenario_id:currentScenario.id,start_time:callStartTimeISO,agent_name:currentUser.name,agent_email:currentUser.email}).select("id").single();if(a)throw a;callSessionId=i.id;
    console.log('â–¶ï¸ Starting ticket, will subscribe to:', currentScenario.id); // EXTRA LOGGING
    subscribeToScenarioUpdates(currentScenario.id);
    const s=document.querySelector(`.scenario-item[data-value="${e}"]`);s&&s.classList.contains("compensation")&&(scenarioTitleElement.classList.add("highlight-scenario-title-animation"),setTimeout((()=>scenarioTitleElement.classList.remove("highlight-scenario-title-animation")),1200)),updateSystemStatus("In Ticket","status-in-call"),renderStep()}catch(e){console.error("Error starting ticket:",e),showCustomToast("Failed to start ticket. Please try again."),resetCallState(),switchToInitialView(),await loadActiveScenarios()}finally{setButtonLoadingState(receiveCallBtn,!1,"Start Ticket")}}else showCustomToast("Please select a scenario first.")}));

    // UPDATED: nextStepBtn Event Listener for Form Submission & Escalation Logic
    nextStepBtn.addEventListener("click", async () => {
        const currentStep = currentScenario.steps.find(s => s.id === currentStepId);
        
        if (!currentStep) return;

        // Ù…Ù†Ø·Ù‚ Ø®Ø§Øµ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø®Ø·ÙˆØ© ÙÙˆØ±Ù…
        if (currentStep.type === "form") {
            const formEl = document.getElementById("dynamic-step-form");
            if (formEl) {
                const inputs = formEl.querySelectorAll("input, textarea, select");
                let formData = {};
                let isValid = true;
                
                // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ØªØ­Ù‚Ù‚ (Validation)
                inputs.forEach(input => {
                    if (input.required && !input.value.trim()) {
                        isValid = false;
                        input.style.borderColor = "var(--danger-color)";
                    } else {
                        input.style.borderColor = "var(--border-color)";
                        formData[input.name] = input.value;
                    }
                });

                if (!isValid) {
                    showCustomToast("Please fill in all required fields.");
                    return; // ØªÙˆÙ‚Ù Ù‡Ù†Ø§ ÙˆÙ„Ø§ ØªÙƒÙ…Ù„
                }

                // --- Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„ØªØµØ¹ÙŠØ¯ ÙˆØ­Ø§Ù„Ø© Ø§Ù„ØªÙŠÙƒØª ---
                let escalationStatus = 'none';
                let ticketStatus = 'closed'; // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø£Ù†Ù‡Ø§ Ø§Ù†ØªÙ‡Øª

                // Ù†Ø¨Ø­Ø« Ø¹Ù† Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ (Action) Ø£Ùˆ Ø§Ù„ØªØµØ¹ÙŠØ¯
                // Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØ£ÙƒØ¯ Ø§Ù† ÙÙŠ Ø§Ù„ JSON Ø§Ø³Ù… Ø§Ù„Ø­Ù‚Ù„ escalation_action Ø§Ùˆ action
                const actionValue = formData['escalation_action'] || formData['Action'] || '';
                
                if (actionValue.includes("Follow-up") || actionValue.includes("Ù…ØªØ§Ø¨Ø¹Ø©")) {
                    escalationStatus = 'follow_up';
                    ticketStatus = 'open'; // ØªÙØ¶Ù„ Ù…ÙØªÙˆØ­Ø© Ø¹Ø´Ø§Ù† Ø±Ø§Ø­Øª Ù„ÙØ±ÙŠÙ‚ ØªØ§Ù†ÙŠ
                } else if (actionValue.includes("Level 2") || actionValue.includes("Ù„ÙŠÙÙ„ 2")) {
                    escalationStatus = 'level_2';
                    ticketStatus = 'open';
                }

                // --- Ø§Ù„Ø­ÙØ¸ ÙÙŠ Supabase ---
                setButtonLoadingState(nextStepBtn, true, "Saving...");
                try {
                    // Ù†Ø¬ÙŠØ¨ Ø§Ù„Ø¯Ø§ØªØ§ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ùˆ ÙÙŠÙ‡ ÙÙˆØ±Ù…Ø² Ø³Ø§Ø¨Ù‚Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© (Merge)
                    // Ù„ÙƒÙ† Ù„Ù„ØªØ¨Ø³ÙŠØ· Ù‡Ù†Ø¹Ù…Ù„ ØªØ­Ø¯ÙŠØ« Ù…Ø¨Ø§Ø´Ø± Ø§Ù„Ø¢Ù†
                    const { error } = await supabase
                        .from('call_sessions')
                        .update({
                            form_data: formData,          // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù€ JSON ÙƒØ§Ù…Ù„
                            escalation_status: escalationStatus,
                            ticket_status: ticketStatus
                        })
                        .eq('id', callSessionId);

                    if (error) throw error;
                    
                    showCustomToast("Data saved successfully.", true);

                } catch (err) {
                    console.error("Error saving form data:", err);
                    showCustomToast("Failed to save data. Please try again.");
                    setButtonLoadingState(nextStepBtn, false, "Save & Continue");
                    return; // Ù„Ø§ ØªÙ†ØªÙ‚Ù„ Ù„Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
                }
                setButtonLoadingState(nextStepBtn, false, "Save & Continue");
            }
        }

        // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ© (Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ)
        if (currentStep.next_id) {
            navigateToStep(currentStep.next_id);
        } else {
            // Ù„Ùˆ Ù…ÙÙŠØ´ Ø®Ø·ÙˆØ© ØªØ§Ù„ÙŠØ©ØŒ ÙŠØ¨Ù‚Ù‰ Ø¯ÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
            stopAndRecordStepTimer();
            finishCall(true, "Scenario completed successfully.");
        }
    });

    prevStepBtn.addEventListener("click",(()=>{stopAndRecordStepTimer(),stepHistory.length>0&&(currentStepId=stepHistory.pop(),stepVisitCount[currentStepId]&&(stepVisitCount[currentStepId]=0),renderStep())}));
    const customConfirmModal=document.getElementById("custom-confirm-modal"),modalConfirmBtn=document.getElementById("modal-confirm-btn"),modalCancelBtn=document.getElementById("modal-cancel-btn");function showConfirmModal(){customConfirmModal.classList.add("show")}function hideConfirmModal(){customConfirmModal.classList.remove("show")}endCallBtn.addEventListener("click",showConfirmModal),modalCancelBtn.addEventListener("click",hideConfirmModal),modalConfirmBtn.addEventListener("click",(()=>{hideConfirmModal(),stopAndRecordStepTimer(),finishCall(!1,"Ticket ended by agent")})),returnToInitialViewBtn.addEventListener("click",(async()=>{resetCallState(!0),await loadActiveScenarios()})),logoutButton.addEventListener("click",(async()=>{resetCallState(),localStorage.removeItem("elevoCoreUserData"),supabase&&await supabase.auth.signOut(),window.location.replace("login.html")}));
    
    searchScenarioInput.addEventListener("input", (e => {
        const searchTerm = e.target.value.toLowerCase();
        const scenarioItems = document.querySelectorAll(".scenario-item");
        const listContainer = document.getElementById("customScenarioList");
        const existingNotFound = listContainer.querySelector('.scenario-not-found');
        if (existingNotFound) existingNotFound.remove();
        let anyVisible = false;
        scenarioItems.forEach(item => {
            const isVisible = item.textContent.toLowerCase().includes(searchTerm);
            item.style.display = isVisible ? "flex" : "none";
            if (isVisible) anyVisible = true;
        });
        if (!anyVisible && searchTerm) {
            const notFoundEl = document.createElement("div");
            notFoundEl.className = "scenario-item scenario-not-found";
            notFoundEl.innerHTML = `<div style="text-align: center; width: 100%; color: var(--text-color-secondary);"><div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ”</div><div>No scenarios found for "${searchTerm}"</div></div>`;
            listContainer.appendChild(notFoundEl);
        }
    }));

    window.addEventListener("beforeunload",(()=>{callSessionId&&saveCallState()}));
</script>

<script>
    // This script is for client-side enhancements that are not module-based.
    document.addEventListener('DOMContentLoaded', function () {
      
      // Mobile Menu Toggle
      const menuToggleBtn = document.getElementById('menu-toggle-btn');
      const mainNav = document.getElementById('main-nav');
      if (menuToggleBtn && mainNav) {
          menuToggleBtn.addEventListener('click', () => {
              mainNav.classList.toggle('active');
          });
      }

      // Format durations in elements with class 'duration-seconds' or 'duration'
      try {
        const durEls = document.querySelectorAll('.duration-seconds, .duration');
        durEls.forEach(el => {
          const txt = el.textContent.trim();
          const sec = parseInt(txt,10);
          if (!isNaN(sec)) {
            const m = Math.floor(sec/60);
            const s = sec % 60;
            el.textContent = (m>0?m+'m ':'') + s + 's';
          }
        });
      } catch(e){console.warn('Could not format duration:', e);}

    });
</script>


<!-- START: Supabase Realtime + Live Update Injection -->
<script>
(async function(){
  // ---------- CONFIGURE: replace with your Supabase values ----------
  const SUPABASE_URL = 'https://aefiigottnlcmjzilqnh.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlZmlpZ290dG5sY21qemlscW5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNzY2MDQsImV4cCI6MjA2Mjc1MjYwNH0.FypB02v3tGMnxXV9ZmZMdMC0oQpREKOJWgHMPxUzwX4';
  // ------------------------------------------------------------------

  // Load supabase-js if not available
  async function ensureSupabase() {
    if (window.supabase) return window.supabase;
    if (window.createClient) {
      // supabase v2 loaded as createClient; wrap a tiny helper
      window.supabaseClient = window.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      return window.supabaseClient;
    }
    // try dynamic load
    await new Promise((res, rej) => {
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js';
      s.onload = res; s.onerror = rej;
      document.head.appendChild(s);
    });
    if (window.createClient) {
      window.supabaseClient = window.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      return window.supabaseClient;
    }
    console.warn('Supabase client not available after load attempt.');
    return null;
  }

  function showToast(title, message, type='info', timeout=4000) {
    try {
      const id = 'live-update-toast';
      let container = document.getElementById(id);
      if (!container) {
        container = document.createElement('div');
        container.id = id;
        Object.assign(container.style, {
          position: 'fixed',
          top: '18px',
          right: '18px',
          zIndex: 99999,
          minWidth: '260px',
          padding: '12px 16px',
          borderRadius: '10px',
          boxShadow: '0 8px 30px rgba(2,6,23,0.6)',
          fontFamily: 'system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial',
          color: '#fff',
          background: 'linear-gradient(90deg, rgba(14,165,233,1), rgba(79,70,229,1))',
        });
        document.body.appendChild(container);
      }
      const el = document.createElement('div');
      el.style.marginBottom = '8px';
      el.style.padding = '8px 10px';
      el.style.borderRadius = '8px';
      el.style.background = 'rgba(255,255,255,0.06)';
      el.style.fontSize = '13px';
      el.innerHTML = '<strong style="display:block;margin-bottom:4px;">' + title + '</strong>' + '<div style="opacity:0.95;">' + message + '</div>';
      container.appendChild(el);
      setTimeout(()=>{
        try { el.style.transition='opacity 0.35s, transform 0.35s'; el.style.opacity=0; el.style.transform='translateY(-6px)'; }catch(e){}
        setTimeout(()=> el.remove(), 400);
      }, timeout);
    } catch(e){ console.warn('toast failure', e); }
  }

  function detectCaseCode() {
    // Try multiple heuristics to detect current case_code
    // 1. element with id 'caseCode' or data-case-code on root elements
    const selectors = [
      '#caseCode', '#currentCaseCode', '[data-case-code]', '[data-case-id]',
      '.scenario-item.selected', '.scenario-item.active', '.scenario-selected'
    ];
    for (const sel of selectors) {
      const el = document.querySelector(sel);
      if (!el) continue;
      // check data attributes first
      if (el.dataset && (el.dataset.caseCode || el.dataset.case)) {
        return el.dataset.caseCode || el.dataset.case;
      }
      // id or text content
      const txt = (el.getAttribute('data-case-code') || el.getAttribute('data-case-id') || el.getAttribute('data-code') || el.textContent || '').trim();
      if (txt) return txt.split(/\s/)[0];
    }
    // 2. URL param ?case= or ?scenario=
    try {
      const url = new URL(window.location.href);
      for (const p of ['case','case_code','scenario','code']) {
        if (url.searchParams.get(p)) return url.searchParams.get(p);
      }
    } catch(e) {}
    // 3. hidden inputs
    const hidden = document.querySelector('input[type=hidden][name=case_code], input#case_code');
    if (hidden && hidden.value) return hidden.value;
    // not found
    return null;
  }

  function applyUpdateToUI(newRow) {
    if (!newRow) return;
    const title = newRow.title || newRow.case_code || 'Case updated';
    // If the KB content is a full HTML article (content_en / content_ar)
    const content = newRow.content_en || newRow.content_ar || newRow.content || '';
    // If steps JSON exists (array or string)
    let steps = newRow.steps || null;
    if (typeof steps === 'string') {
      try { steps = JSON.parse(steps); } catch(e){ /* ignore */ }
    }

    // 1) Update main content areas if present
    const contentSelectors = ['.steps-area', '.step-content', '#contentArea', '.kb-container', '.kb-article', '.call-flow-steps'];
    for (const sel of contentSelectors) {
      const el = document.querySelector(sel);
      if (!el) continue;
      if (steps && Array.isArray(steps)) {
        // render steps nicely (step text only)
        el.innerHTML = steps.map(s => `<div class="live-step" data-step-id="${s.id||''}" style="padding:10px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02)">${s.text || s}</div>`).join('');
      } else if (content) {
        // plain text or html
        // preserve basic formatting
        el.innerHTML = content;
      } else {
        // fallback: stringify row
        el.innerText = JSON.stringify(newRow, null, 2);
      }
    }

    // 2) If currently showing a single step element (like current step box) update it
    const stepSingle = document.querySelector('.current-step-text, .current-step, .active-step');
    if (stepSingle) {
      // find step id in DOM if exists
      if (steps && Array.isArray(steps)) {
        // attempt to preserve which step the user is on by matching id attribute on element
        const currId = stepSingle.dataset && stepSingle.dataset.stepId;
        if (currId) {
          const found = steps.find(s=> s.id === currId);
          if (found) stepSingle.innerHTML = found.text || (found.label || JSON.stringify(found));
          else stepSingle.innerHTML = steps[0].text || steps[0];
        } else {
          // no id, update to first step text
          stepSingle.innerHTML = (steps[0] && (steps[0].text || steps[0])) || stepSingle.innerHTML;
        }
      } else if (content) {
        stepSingle.innerHTML = content;
      }
    }

    // 3) Show a toast notification
    showToast('Live Update', title + ' â€” updated in Knowledge Base', 'info', 4000);
  }

  // Main startup
  try {
    const supabaseClient = await ensureSupabase();
    if (!supabaseClient) {
      console.warn('Supabase client is not available. Please add your Supabase URL and anon key to the top of this script.');
      return;
    }
    const caseCode = detectCaseCode();
    if (!caseCode) {
      console.warn('Live-update: could not auto-detect case_code on this page. The listener will not subscribe until a case_code is available.');
      // But we still listen to a generic channel for debugging if you want (commented out)
      return;
    }
    // Try subscribing to both kb_cases and call_scenarios tables (update events)
    const tablesToWatch = ['kb_cases','call_scenarios'];

    for (const tbl of tablesToWatch) {
      supabaseClient.channel(`realtime-${tbl}-${caseCode}`)
        .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: tbl, filter: `case_code=eq.${caseCode}` }, (payload) => {
          try {
            console.log('Realtime update received', tbl, payload);
            const newRow = payload.new || payload.record || payload;
            applyUpdateToUI(newRow);
          } catch(e) {
            console.error('Error handling realtime payload', e);
          }
        })
        .subscribe((status) => {
          console.log('Subscribed to realtime for', tbl, 'case', caseCode, status);
        });
    }

    // Optional: fetch latest once on load to ensure UI is up-to-date
    try {
      const { data } = await supabaseClient.from('kb_cases').select('*').eq('case_code', caseCode).limit(1).maybeSingle();
      if (data) applyUpdateToUI(data);
    } catch(e){ /* ignore */ }

  } catch (e) {
    console.error('Live update initialization error', e);
  }
})();
</script>
<!-- END: Supabase Realtime + Live Update Injection -->
</body>
</html>
