<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elevo Core Assistant</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%235891ff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M3 12h18M3 6h12M3 18h15'/><path d='M17 9l4 3l-4 3'/></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --background-color: #12121c;
            --card-background-color: #20202d;
            --text-color: #f0f0f0;
            --text-color-secondary: #a0a0b0;
            --primary-color: #5891ff;
            --primary-color-rgb: 88, 145, 255;
            --primary-color-dark: #4a81ff;
            --secondary-color: #3a3a50;
            --border-color: rgba(255, 255, 255, 0.1);
            --input-background-color: #1a1a26;
            --input-border-color: #444444;
            --success-color: #4CAF50;
            --danger-color: #F44336;
            --border-radius: 16px;
            --font-family-main: 'Poppins', 'Roboto', sans-serif;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #3a3a50; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background-color: #4a4a60; }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: var(--font-family-main);
            margin: 0; padding: 0; line-height: 1.6;
            background-image: radial-gradient(at 20% 10%, hsla(212, 85%, 55%, 0.15) 0px, transparent 50%),
                              radial-gradient(at 80% 20%, hsla(267, 85%, 60%, 0.1) 0px, transparent 50%),
                              radial-gradient(at 70% 80%, hsla(330, 85%, 55%, 0.08) 0px, transparent 50%);
            overflow-x: hidden;
        }

        .app-container { display: flex; flex-direction: column; min-height: 100vh; }
        .app-main { padding: 2rem; flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        .app-header {
            background-color: transparent;
            padding: 1.25rem 2.5rem;
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; position: absolute; top: 0; left: 0; z-index: 100;
        }
        .header-controls { display: flex; align-items: center; gap: 1.5rem; }
        .user-info { display: flex; align-items: center; gap: 1rem; }

        .card {
            background-color: var(--card-background-color);
            padding: 2.5rem;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border-color);
            width: 100%; transition: all 0.4s ease;
        }
        
        /* --- TARGET UI: Re-implementing the user's desired layout --- */
        .initial-card {
            max-width: 1000px;
            padding: 0; display: grid; grid-template-columns: 1fr 1.1fr; overflow: hidden;
        }
        .welcome-panel {
            padding: 3rem;
            display: flex; flex-direction: column; justify-content: center;
        }
        .welcome-icon-wrapper {
            width: 60px; height: 60px;
            border-radius: 50%; display: grid; place-items: center; margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            background: linear-gradient(145deg, rgba(var(--primary-color-rgb), 0.05), rgba(var(--primary-color-rgb), 0.15));
        }
        .welcome-panel h2 { font-size: 2.25rem; color: #fff; font-weight: 600; margin: 0 0 0.5rem 0; }
        .welcome-panel p { font-size: 1rem; color: var(--text-color-secondary); max-width: 350px; margin: 0; }
        .scenario-panel { padding: 3rem; background-color: rgba(0,0,0,0.1); }
        /* --- End of Target UI implementation --- */

        .call-flow-card { max-width: 700px; }

        .action-button, .nav-button, .decision-button {
            padding: 0.7rem 1.4rem; border-radius: 10px; font-weight: 500; cursor: pointer;
            transition: all 0.2s ease-in-out; border: none; font-size: 0.95rem;
            display: inline-flex; align-items: center; justify-content: center; gap: 0.75em;
        }
        .primary-button { background-color: var(--primary-color); color: white; }
        .primary-button:hover { background-color: var(--primary-color-dark); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(var(--primary-color-rgb), 0.2); }
        .primary-button:disabled { background-color: var(--secondary-color); cursor: not-allowed; transform: none; box-shadow: none; }
        .secondary-button { background-color: var(--secondary-color); color: var(--text-color); }
        .danger-button { background-color: var(--danger-color); color: white; }

        .scenario-selector-container { display: flex; flex-direction: column; gap: 1rem; }
        .scenario-filter-input {
            width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--input-border-color);
            border-radius: 8px; background-color: var(--input-background-color); color: var(--text-color); font-size: 0.9rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .scenario-filter-input:focus { outline: none; border-color: var(--primary-color); }

        .custom-scenario-list { display: flex; flex-direction: column; gap: 0.75rem; max-height: 240px; overflow-y: auto; padding-right: 0.5rem; }
        .scenario-item {
            padding: 0.9rem 1.2rem; border-radius: 10px; cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
            display: flex; align-items: center; gap: 1rem; font-weight: 500;
            border: 1px solid var(--input-border-color); background-color: var(--input-background-color);
        }
        .scenario-item:hover { border-color: var(--primary-color); background-color: #2a2a3a; transform: translateX(4px); }
        .scenario-item.selected, .scenario-item:focus-visible {
            border-color: var(--primary-color); background-color: var(--primary-color); color: white;
            transform: translateX(4px) scale(1.02); outline: none;
        }
        .scenario-item .icon { transition: transform 0.2s ease; }
        .scenario-item.selected .icon { color: white !important; }
        .scenario-item.compensation { border-left: 3px solid var(--success-color); }

        .session-info-container {
            width: 100%; display: flex; flex-direction: column; align-items: center;
            gap: 0.75rem; padding: 1rem 0; height: 80px;
        }
        #callTimer {
            font-size: 1.25em; font-weight: 500; color: var(--text-color); background-color: var(--card-background-color);
            padding: 0.5rem 1.25rem; border-radius: 12px; display: inline-block; min-width: 80px;
            border: 1px solid var(--border-color);
        }
        .status-bar { font-size: 0.9rem; }
        .status-indicator.status-in-call { color: var(--success-color); }

        .fade-in { animation: fadeInAnimation 0.6s ease-in-out forwards; }
        @keyframes fadeInAnimation { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .call-flow-actions {
            margin-top: 2rem; display: flex; flex-direction: column;
            align-items: center; gap: 1.5rem;
        }
        .step-actions, .navigation-buttons {
            display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 1rem; width: 100%;
        }
        .decision-button { width: 100%; max-width: 250px; }

        .app-footer { text-align: center; padding: 2rem; font-size: 0.85rem; color: var(--text-color-secondary); margin-top: auto; width: 100%; }

        @media (max-width: 900px) {
            .initial-card { grid-template-columns: 1fr; max-width: 500px; }
            .welcome-panel { padding: 2rem; text-align: center; align-items: center; }
            .scenario-panel { padding: 2rem; }
            .app-header { padding: 1rem 1.5rem; }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <header class="app-header">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: var(--primary-color); width: 28px; height: 28px;"><path d="M3 12h18M3 6h12M3 18h15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M17 9l4 3l-4 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <span style="font-size: 1.3rem; font-weight: 600;">Elevo Core</span>
            </div>
            <div class="header-controls">
                 <a href="dashboard.html" class="nav-link" id="dashboardLink" style="display: none; font-weight: 500;">Dashboard</a>
                <div class="user-info" id="userInfo" style="display: none;">
                    <span id="userName"></span>
                    <a id="logoutButton" href="#" style="color: var(--text-color-secondary); text-decoration: none;">Logout</a>
                </div>
            </div>
        </header>
        
        <div class="session-info-container">
            <div id="callTimer" style="display: none;">00:00</div>
            <div class="status-bar" style="display: none;">
                <div id="systemStatus" class="status-indicator"></div>
            </div>
        </div>

        <main class="app-main">
            <div id="auth-loading" style="display: none; text-align: center;">
                <p>Initializing Assistant...</p>
            </div>
            
            <div id="initial-view" class="card initial-card fade-in" style="display: none;">
                 <div class="welcome-panel">
                    <div class="welcome-icon-wrapper">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="var(--primary-color)" width="28" height="28"><path d="M19.14,12.94a1,1,0,0,0-1.41,0L16,14.66V10a1,1,0,0,0-2,0v4.66l-1.73-1.72a1,1,0,0,0-1.41,1.41l3.14,3.14a1,1,0,0,0,1.41,0l3.14-3.14A1,1,0,0,0,19.14,12.94ZM12,2A10,10,0,1,0,22,12,10,10,0,0,0,12,2Zm0,18a8,8,0,1,1,8-8A8,8,0,0,1,12,20ZM7.73,8.34,6,6.62V10a1,1,0,0,1-2,0V5.41a1,1,0,0,1,.29-.71A1,1,0,0,1,5,4.59H9.41a1,1,0,0,1,0,2H6.62l1.72,1.72a1,1,0,1,1-1.41,1.41Z"/></svg>
                    </div>
                    <h2>Core Flow Assistant</h2>
                    <p>Your dedicated assistant for streamlined ticket resolution. Please select a scenario to begin.</p>
                </div>
                <div class="scenario-panel">
                    <div class="scenario-selector-container">
                        <label for="scenarioFilter" style="font-weight: 500; color: var(--text-color-secondary); margin-bottom: 0.5rem; display: block;">Select Scenario:</label>
                        <input type="text" id="scenarioFilter" class="scenario-filter-input" placeholder="Search scenarios...">
                        <div id="customScenarioList" role="listbox" class="custom-scenario-list"></div>
                        <input type="hidden" id="scenarioDropdownValue" name="scenarioId">
                    </div>
                    <div style="display: flex; justify-content: flex-start; margin-top: 1.5rem;">
                        <button id="receive-call-btn" class="action-button primary-button" disabled>
                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11 10.5a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m-3 0a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m-3 0a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5"/></svg>
                            <span>Start Ticket</span>
                        </button>
                    </div>
                </div>
                <audio id="callStartSound" src="call_sound.mp3" preload="auto"></audio>
                <audio id="compensationScenarioSound" src="compensation_alert.mp3" preload="auto"></audio>
            </div>

            <div id="call-flow-view" class="card call-flow-card fade-in" style="display: none;">
                <h3 id="scenario-title" class="card-title scenario-title-dynamic">Ticket Scenario</h3>
                <div id="steps-container" style="margin: 2rem 0; font-size: 1.1rem; line-height: 1.75; color: var(--text-color);"></div>
                <div class="call-flow-actions">
                    <div id="decision-buttons-container" class="step-actions"></div>
                    <div class="navigation-buttons">
                        <button id="prev-step-btn" class="nav-button secondary-button" style="display: none;">Previous</button>
                        <button id="next-step-btn" class="nav-button primary-button">Next Step</button>
                    </div>
                    <div><button id="end-call-btn" class="nav-button danger-button" style="display: none;">End Ticket</button></div>
                </div>
            </div>

            <div id="postCallSummary" class="card post-call-summary-card fade-in" style="display: none;">
                <h3 class="card-title">Ticket Summary</h3>
                <div id="callSummaryContent"></div>
                <div style="display: flex; justify-content: center; margin-top: 1.5rem;"><button id="returnToInitialViewBtn" class="action-button primary-button">New Ticket</button></div>
            </div>
        </main>
        
        <footer class="app-footer">
            <p>© <span id="currentYear"></span> Mohamed Elmenisy - Elevo Core. All rights reserved.</p>
        </footer>
    </div>

    <script type="module">
        const SUPABASE_URL = 'https://aefiigottnlcmjzilqnh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlZmlpZ290dG5sY21qemlscW5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNzY2MDQsImV4cCI6MjA2Mjc1MjYwNH0.FypB02v3tGMnxXV9ZmZMdMC0oQpREKOJWgHMPxUzwX4';
        let supabase;
        try { supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); } catch (error) { console.error("Supabase client failed:", error); }

        const authLoadingDiv = document.getElementById('auth-loading');
        const initialViewDiv = document.getElementById('initial-view');
        const callFlowViewDiv = document.getElementById('call-flow-view');
        const postCallSummaryDiv = document.getElementById('postCallSummary');
        const receiveCallBtn = document.getElementById('receive-call-btn');
        const scenarioTitleElement = document.getElementById('scenario-title');
        const stepsContainer = document.getElementById('steps-container'); 
        const decisionButtonsContainer = document.getElementById('decision-buttons-container'); 
        const prevStepBtn = document.getElementById('prev-step-btn');
        const nextStepBtn = document.getElementById('next-step-btn'); 
        const endCallBtn = document.getElementById('end-call-btn');
        const userInfoDiv = document.getElementById('userInfo');
        const userNameSpan = document.getElementById('userName');
        const logoutButton = document.getElementById('logoutButton');
        const dashboardLink = document.getElementById('dashboardLink');
        const systemStatusDiv = document.getElementById('systemStatus');
        const statusBarDiv = document.querySelector('.status-bar');
        const callTimerDiv = document.getElementById('callTimer');
        const callSummaryContentDiv = document.getElementById('callSummaryContent');
        const returnToInitialViewBtn = document.getElementById('returnToInitialViewBtn');
        const scenarioFilterInput = document.getElementById('scenarioFilter');
        const customScenarioList = document.getElementById('customScenarioList');
        const scenarioDropdownValue = document.getElementById('scenarioDropdownValue');
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        let currentUser = null, currentScenario = null, currentStepId = null, callSessionId = null, callStartTimeISO = null;
        let stepHistory = [], accumulatedStepDurations = {}, stepVisitCount = {};
        let stepTimerInterval = null, stepStartTime = 0;
        let allScenarios = [];
        const MAX_STEP_VISITS = 5;
        const SESSION_STATE_KEY = 'elevoCoreActiveCallState_v7';

        function updateSystemStatus(statusText, statusClass) {
            if (systemStatusDiv) {
                systemStatusDiv.textContent = statusText;
                systemStatusDiv.className = `status-indicator ${statusClass}`;
            }
        }
        function animateView(viewElement) {
            document.querySelectorAll('.card').forEach(c => c.style.display = 'none');
            if (viewElement) {
                viewElement.classList.remove('fade-in');
                void viewElement.offsetWidth; 
                viewElement.classList.add('fade-in');
                viewElement.style.display = viewElement.id === 'initial-view' ? 'grid' : 'block';
            }
        }

        async function initializeApp() {
            if (!supabase) { authLoadingDiv.textContent = "Connection Error."; return; }
            authLoadingDiv.style.display = 'block';
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { window.location.replace('login.html'); return; }

            try {
                let { data: profile, error } = await supabase.from('users').select('name, is_admin').eq('id', session.user.id).single();
                if (error && error.code !== 'PGRST116') throw error;
                if (!profile) {
                    profile = { name: session.user.user_metadata?.full_name || session.user.email.split('@')[0], is_admin: false };
                    await supabase.from('users').insert({ ...profile, id: session.user.id, email: session.user.email });
                }
                currentUser = { id: session.user.id, email: session.user.email, name: profile.name, isAdmin: profile.is_admin };
            } catch (error) {
                currentUser = { name: "Profile Error", profileError: true };
            }
            
            userNameSpan.textContent = currentUser.name;
            userInfoDiv.style.display = 'flex';
            dashboardLink.style.display = currentUser.isAdmin ? 'inline-block' : 'none';
            
            authLoadingDiv.style.display = 'none';
            if (restoreCallState()) { 
                switchToCallFlowView(); renderStep(); 
            } else {
                switchToInitialView(); await loadActiveScenarios();
            }
        }

        function switchToInitialView() {
            animateView(initialViewDiv);
            callTimerDiv.style.display = 'none';
            statusBarDiv.style.display = 'none';
        }
        function switchToCallFlowView() {
            animateView(callFlowViewDiv);
            callTimerDiv.style.display = 'inline-block';
            statusBarDiv.style.display = 'block';
        }
        function switchToSummaryView() {
            animateView(postCallSummaryDiv);
            callTimerDiv.style.display = 'none';
            statusBarDiv.style.display = 'none';
        }

        async function loadActiveScenarios() {
            try {
                const { data, error } = await supabase.from('call_scenarios_with_creator').select('id, title').eq('is_active', true).order('created_at', { ascending: false });
                if (error) throw error;
                allScenarios = data || [];
                renderScenarioList(allScenarios);
            } catch (err) {
                customScenarioList.innerHTML = `<div class="scenario-item">⚠️ Failed to load scenarios.</div>`;
            }
        }

        function renderScenarioList(scenarios) {
            customScenarioList.innerHTML = '';
            const ICONS = {
                compensation: `<svg class="icon" style="color: var(--success-color);" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M10.478 1.647a.5.5 0 1 0-.956-.294l-4 13a.5.5 0 0 0 .956.294l4-13zM6.205 4.29a.5.5 0 0 0-.976.215L4.02 12.29a.5.5 0 0 0 .976.214l1.209-7.999z"/></svg>`,
                default: `<svg class="icon" style="color: var(--text-color-secondary);" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M14 0a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h12zM2 1a1 1 0 0 0-1 1v1h14V2a1 1 0 0 0-1-1H2z"/></svg>`
            };
            scenarios.forEach((s) => {
                const item = document.createElement('div');
                item.className = 'scenario-item'; item.dataset.value = s.id;
                item.setAttribute('role', 'option'); item.setAttribute('tabindex', '0');
                const titleLower = s.title.toLowerCase();
                let iconHtml = ICONS.default;
                if (titleLower.includes('compensation')) {
                    item.classList.add('compensation');
                    iconHtml = ICONS.compensation;
                }
                item.innerHTML = `${iconHtml}<span>${s.title}</span>`;
                item.addEventListener('click', () => selectScenario(item));
                customScenarioList.appendChild(item);
            });
        }
        
        function selectScenario(itemElement) {
            const current = customScenarioList.querySelector('.selected');
            if (current) current.classList.remove('selected');
            itemElement.classList.add('selected');
            scenarioDropdownValue.value = itemElement.dataset.value;
            receiveCallBtn.disabled = false;
        }

        scenarioFilterInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            renderScenarioList(allScenarios.filter(s => s.title.toLowerCase().includes(term)));
        });

        receiveCallBtn.addEventListener('click', async () => {
            const scenarioId = scenarioDropdownValue.value;
            if (!scenarioId) return;
            resetCallState();
            switchToCallFlowView();
            updateSystemStatus("Loading...", "status-loading");
            try {
                const { data, error } = await supabase.from('call_scenarios').select('id, title, steps').eq('id', scenarioId).single();
                if (error || !data?.steps?.length) throw new Error("Invalid scenario data.");
                currentScenario = data; currentStepId = data.steps[0].id;
                callStartTimeISO = new Date().toISOString();
                const { data: sessionData, error: sessionError } = await supabase.from('call_sessions').insert({ user_id: currentUser.id, scenario_id: currentScenario.id, start_time: callStartTimeISO, agent_name: currentUser.name, agent_email: currentUser.email }).select('id').single();
                if (sessionError) throw sessionError;
                callSessionId = sessionData.id;
                renderStep();
            } catch (err) {
                console.error("Error starting ticket:", err);
                resetCallState(true);
            }
        });
        
        function renderStep() {
            const step = currentScenario.steps.find(s => s.id === currentStepId);
            if (!step) { finishCall(false, `Error: Step with ID ${currentStepId} not found.`); return; }
            scenarioTitleElement.textContent = currentScenario.title;
            stepsContainer.textContent = step.text;
            decisionButtonsContainer.innerHTML = '';
            prevStepBtn.style.display = stepHistory.length > 0 ? 'inline-flex' : 'none';
            endCallBtn.style.display = 'inline-flex';
            updateSystemStatus("In Ticket", "status-in-call");
            if (step.type === 'decision' && Array.isArray(step.options)) {
                nextStepBtn.style.display = 'none';
                step.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'decision-button action-button'; // Combine classes for consistent styling
                    btn.textContent = opt.label;
                    btn.onclick = () => navigateToStep(opt.next_id);
                    decisionButtonsContainer.appendChild(btn);
                });
            } else {
                nextStepBtn.style.display = 'inline-flex';
                nextStepBtn.textContent = step.next_id ? "Next Step" : "Finish Scenario";
            }
            startStepTimer(); saveCallState();
        }

        function navigateToStep(nextId) {
            stepVisitCount[currentStepId] = (stepVisitCount[currentStepId] || 0) + 1;
            if (stepVisitCount[currentStepId] >= MAX_STEP_VISITS) { finishCall(false, `System detected a process loop.`); return; }
            stopAndRecordStepTimer();
            if (nextId === null || typeof nextId === 'undefined' || nextId === "") { finishCall(true, "Scenario completed successfully."); return; }
            stepHistory.push(currentStepId); currentStepId = nextId;
            renderStep();
        }

        function startStepTimer() {
            if (stepTimerInterval) clearInterval(stepTimerInterval);
            stepStartTime = Date.now();
            stepTimerInterval = setInterval(() => {
                const totalSeconds = callStartTimeISO ? Math.floor((Date.now() - new Date(callStartTimeISO)) / 1000) : 0;
                const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
                const seconds = String(totalSeconds % 60).padStart(2, '0');
                callTimerDiv.textContent = `${minutes}:${seconds}`;
            }, 1000);
        }
        function stopAndRecordStepTimer() {
             if (stepTimerInterval) clearInterval(stepTimerInterval);
             if (stepStartTime > 0 && currentStepId) {
                accumulatedStepDurations[currentStepId] = (accumulatedStepDurations[currentStepId] || 0) + Math.floor((Date.now() - stepStartTime) / 1000);
            }
        }
        
        async function finishCall(completed, reason) {
            stopAndRecordStepTimer();
            const endTimeISO = new Date().toISOString();
            const duration = callStartTimeISO ? Math.floor((new Date(endTimeISO) - new Date(callStartTimeISO)) / 1000) : 0;
            if (callSessionId) {
                await supabase.from('call_sessions').update({ end_time: endTimeISO, duration, completed, quality_reason: reason }).eq('id', callSessionId);
            }
            callSummaryContentDiv.innerHTML = `<p><strong>Outcome:</strong> ${reason}</p><p><strong>Total Duration:</strong> ${duration} seconds</p>`;
            switchToSummaryView();
            clearCallState();
        }

        nextStepBtn.addEventListener('click', () => { const step = currentScenario.steps.find(s => s.id === currentStepId); if(step) navigateToStep(step.next_id); });
        prevStepBtn.addEventListener('click', () => { if (stepHistory.length > 0) { stopAndRecordStepTimer(); currentStepId = stepHistory.pop(); renderStep(); } });
        endCallBtn.addEventListener('click', () => finishCall(false, "Ticket ended prematurely by agent."));
        returnToInitialViewBtn.addEventListener('click', () => { resetCallState(true); loadActiveScenarios(); });
        logoutButton.addEventListener('click', async (e) => { e.preventDefault(); resetCallState(); await supabase.auth.signOut(); window.location.replace("login.html"); });
        
        function saveCallState() { if(callSessionId) sessionStorage.setItem(SESSION_STATE_KEY, JSON.stringify({ callSessionId, currentScenario, currentStepId, stepHistory, accumulatedStepDurations, callStartTimeISO, stepVisitCount })); }
        function restoreCallState() {
            try {
                const savedStateJSON = sessionStorage.getItem(SESSION_STATE_KEY);
                if (!savedStateJSON) return false;
                const state = JSON.parse(savedStateJSON);
                callSessionId = state.callSessionId; currentScenario = state.currentScenario; currentStepId = state.currentStepId;
                stepHistory = state.stepHistory; accumulatedStepDurations = state.accumulatedStepDurations; callStartTimeISO = state.callStartTimeISO;
                stepVisitCount = state.stepVisitCount;
                return true;
            } catch (e) { return false; }
        }
        function clearCallState() { sessionStorage.removeItem(SESSION_STATE_KEY); callSessionId = null; }
        function resetCallState(switchToInitial = false) {
            stopAndRecordStepTimer(); clearCallState(); currentScenario = null; stepHistory = []; accumulatedStepDurations = {}; stepVisitCount = {}; callStartTimeISO = null;
            if (switchToInitial) switchToInitialView();
        }

        if (supabase) initializeApp();
    </script>
</body>
</html>
