<!DOCTYPE html>
<html lang="en" class="dark" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elevo Core Assistant</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234e8cff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M3 12h18M3 6h12M3 18h15'/><path d='M17 9l4 3l-4 3'/></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --background-color: #1c1c28;
            --card-background-color: #2b2b3d;
            --text-color: #f0f0f0;
            --text-color-secondary: #a0a0b0;
            --primary-color: #4e8cff;
            --primary-color-rgb: 78, 140, 255;
            --primary-color-dark: #3d7eff;
            --secondary-color: #3a3a50;
            --border-color: #444444;
            --input-background-color: #242436;
            --input-border-color: #444444;
            --button-text-color: #ffffff;
            --success-color: #4CAF50;
            --danger-color: #F44336;
            --warning-color: #FFC107;
            --border-radius: 16px;
            --font-family-main: 'Poppins', 'Roboto', sans-serif;
        }

        html.dark {
            background-color: var(--background-color);
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: var(--font-family-main);
            margin: 0; 
            padding: 0; 
            line-height: 1.6;
            overflow-x: hidden;
        }

        .app-container {
            display: flex; 
            flex-direction: column; 
            min-height: 100vh;
            max-width: 100%;
            margin: 0;
            margin: 0 auto;
        }

        .app-main {
            padding: 2rem; 
            flex-grow: 1; 
            display: flex;
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start;
        }

        /* Enhanced Header */
        .app-header {
            background: linear-gradient(135deg, var(--card-background-color), #242436); 
            color: var(--text-color);
            padding: 1.25rem 2rem; 
            display: flex; 
            justify-content: space-between;
            align-items: center; 
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0,0,0,0.25); 
            width: 100%;
            box-sizing: border-box;
            backdrop-filter: blur(10px);
        }

        .logo-container {
            display: flex; 
            align-items: center; 
            gap: 1rem;
        }

        .app-title { 
            font-weight: 700; 
            color: var(--primary-color);
            font-size: 1.4rem;
            background: linear-gradient(135deg, var(--primary-color), #6ea8ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-controls { 
            display: flex; 
            align-items: center; 
            gap: 1.5rem; 
        }

        .nav-link { 
            color: var(--text-color-secondary); 
            text-decoration: none; 
            transition: all 0.3s ease; 
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid transparent;
        }

        .nav-link:hover { 
            color: var(--primary-color); 
            background: rgba(var(--primary-color-rgb), 0.1);
            border-color: var(--primary-color);
        }

        .nav-link.active {
            color: var(--primary-color);
            background: rgba(var(--primary-color-rgb), 0.15);
            border-color: var(--primary-color);
        }

        .user-info { 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
        }
        
        .user-name-display { 
            color: var(--text-color-secondary);
            white-space: nowrap; 
            font-weight: 500;
        }
        
        .logout-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark));
            color: white;
            border: none;
            border-radius: 12px; 
            padding: 0.7rem 1.4rem;
            display: inline-flex; 
            align-items: center; 
            gap: 0.5em; 
            cursor: pointer;
            transition: all 0.3s ease-in-out; 
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(var(--primary-color-rgb), 0.3);
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(var(--primary-color-rgb), 0.4);
        }

        .logout-btn svg { 
            margin-right: 0.3em; 
        }

        /* Enhanced Cards */
        .card {
            background: linear-gradient(145deg, var(--card-background-color), #242436);
            padding: 3rem;
            border-radius: var(--border-radius);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
            width: 100%;
            max-width: 1200px;
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        }

        .initial-card {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 4rem;
            max-width: 1200px;
            padding: 3.5rem; 
            align-items: center;
            background: linear-gradient(135deg, var(--card-background-color), #1f2937);
        }

        .call-flow-card {
            background: linear-gradient(145deg, var(--card-background-color), #242436);
            position: relative; 
            border-radius: var(--border-radius);
            min-height: 500px;
        }

        @keyframes cardDecisionPulse {
            0% { box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 0 0px rgba(var(--primary-color-rgb), 0.5); }
            50% { box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 0 12px rgba(var(--primary-color-rgb), 0); }
            100% { box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 0 0px rgba(var(--primary-color-rgb), 0); }
        }

        .decision-made-animation { 
            animation: cardDecisionPulse 0.7s ease-out; 
        }

        .card-title {
            color: var(--text-color);
            font-size: 2rem;
            font-weight: 700; 
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--text-color), var(--primary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .scenario-title-dynamic {
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
        }

        .scenario-title-dynamic .step-type-icon {
            margin-right: 0.5em; 
            font-size: 1.3em; 
            display: inline-block; 
            transform: translateY(0.1em);
        }

        .card-subtitle { 
            color: var(--text-color-secondary); 
            font-size: 1.2rem; 
            margin-top: 0.5rem;
            line-height: 1.6;
        }

        /* Enhanced Buttons */
        .action-button, .nav-button, .decision-button {
            padding: 1rem 2rem; 
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            border: none;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.75em;
            width: auto;
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
        }

        .action-button:active, .nav-button:active, .decision-button:active { 
            transform: translateY(1px) scale(0.98); 
        }

        .primary-button {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark));
            color: white;
            box-shadow: 0 4px 15px rgba(var(--primary-color-rgb), 0.3);
        }

        .primary-button:hover {
            background: linear-gradient(135deg, var(--primary-color-dark), var(--primary-color));
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(var(--primary-color-rgb), 0.4);
        }

        .primary-button:disabled {
            background: var(--secondary-color); 
            cursor: not-allowed;
            transform: none; 
            box-shadow: none;
            opacity: 0.6;
        }

        .primary-button .btn-spinner {
            width: 1.2em; 
            height: 1.2em; 
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white; 
            border-radius: 50%;
            animation: spin 0.8s linear infinite; 
            margin-right: 0.5em;
        }

        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }

        .secondary-button {
            background: var(--secondary-color); 
            color: var(--button-text-color);
            border: 1px solid var(--border-color);
        }

        .secondary-button:hover {
            background: #4a4a60; 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0, 0.3);
        }
        
        .danger-button {
            background: transparent; 
            color: var(--danger-color);
            border: 2px solid var(--danger-color);
            font-weight: 600;
        }

        .danger-button:hover {
            background: var(--danger-color); 
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(244,67,54, 0.3);
        }

        .highlight-scenario-title-animation { 
            animation: pulse-title 0.6s 2 ease-in-out; 
        }

        @keyframes pulse-title {
            0%, 100% { transform: scale(1); opacity: 1; color: var(--warning-color); }
            50% { transform: scale(1.03); opacity: 0.8; color: var(--warning-color); }
        }

        /* Enhanced Step Actions */
        .step-actions {
            margin-top: 2.5rem; 
            display: flex; 
            flex-direction: column; 
            gap: 1rem;
            align-items: stretch; 
        }

        .decision-button {
            border: 2px solid var(--border-color); 
            background: var(--input-background-color);
            color: var(--text-color); 
            text-align: center;
            width: 100%;
            padding: 1.25rem 2rem;
            font-size: 1.1rem;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .decision-button:hover {
            border-color: var(--primary-color);
            background: rgba(var(--primary-color-rgb), 0.1);
            box-shadow: 0 4px 15px rgba(var(--primary-color-rgb), 0.2); 
            transform: translateY(-3px);
        }
        
        .decision-button:focus { 
            outline: none;
            border-color: var(--primary-color-dark);
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.3);
        }

        .decision-button.positive:hover { 
            background: var(--success-color); 
            border-color: var(--success-color); 
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4); 
        }

        .decision-button.negative:hover { 
            background: var(--danger-color); 
            border-color: var(--danger-color); 
            color: white;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4); 
        }

        .decision-button.neutral:hover { 
            background: var(--primary-color-dark); 
            border-color: var(--primary-color); 
            color: white;
            box-shadow: 0 4px 15px rgba(var(--primary-color-rgb), 0.4); 
        }
        
        .navigation-buttons {
            margin-top: 2.5rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        
        /* Enhanced Status Bar */
        .status-bar {
            background: linear-gradient(135deg, #242436, #1a1a2e); 
            color: var(--text-color); 
            padding: 1rem 2rem;
            font-size: 1rem; 
            border-bottom: 1px solid var(--border-color); 
            width: 100%;
            box-sizing: border-box; 
            text-align: center;
            font-weight: 600;
        }

        .status-indicator { 
            padding: 0.5rem 1rem;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-indicator.status-waiting { 
            background: rgba(244, 67, 54, 0.15); 
            color: var(--danger-color);
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .status-indicator.status-loading { 
            background: rgba(255, 193, 7, 0.15); 
            color: var(--warning-color);
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .status-indicator.status-in-call { 
            background: rgba(76, 175, 80, 0.15); 
            color: var(--success-color);
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .status-indicator.status-completed { 
            background: rgba(76, 175, 80, 0.15); 
            color: var(--success-color);
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .status-indicator.status-ended { 
            background: rgba(160, 174, 192, 0.15); 
            color: #a0aec0;
            border: 1px solid rgba(160, 174, 192, 0.3);
        }

        .status-indicator.status-summary { 
            background: rgba(78, 140, 255, 0.15); 
            color: var(--primary-color);
            border: 1px solid rgba(78, 140, 255, 0.3);
        }

        /* Enhanced Timer */
        #timer-container { 
            position: fixed; 
            top: 120px; 
            left: 50%; 
            transform: translateX(-50%); 
            z-index: 1000; 
        }

        #callTimer {
            font-size: 1.4em; 
            font-weight: 700; 
            color: var(--primary-color);
            background: rgba(28, 28, 40, 0.9);
            backdrop-filter: blur(10px);
            padding: 0.75rem 1.5rem;
            border-radius: 12px; 
            display: inline-block; 
            min-width: 100px;
            text-align: center; 
            border: 2px solid var(--primary-color);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            font-family: 'Roboto Mono', monospace;
        }

        /* Enhanced Steps Area */
        .steps-area {
            background: var(--input-background-color);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 2.5rem;
            margin: 2rem 0;
            min-height: 200px;
            text-align: left;
            font-size: 1.3rem;
            line-height: 1.8;
            color: var(--text-color);
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.1);
        }

        .steps-area p {
            margin: 0;
            font-weight: 500;
        }

        .steps-area .placeholder-text {
            color: var(--text-color-secondary);
            font-style: italic;
            text-align: center;
            font-size: 1.2rem;
        }

        .fade-in { 
            animation: fadeInAnimation 0.6s ease-in-out forwards; 
        }

        @keyframes fadeInAnimation {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        .app-footer {
            text-align: center; 
            padding: 2rem; 
            font-size: 0.9rem;
            color: var(--text-color-secondary); 
            background: transparent;
            margin-top: auto; 
            width: 100%; 
            box-sizing: border-box;
            border-top: 1px solid var(--border-color);
        }
        
        /* Enhanced Summary */
        #callSummaryContent p {
            font-size: 1.3rem;
            line-height: 1.7;
            margin-bottom: 1.5rem;
        }

        #callSummaryContent strong { 
            color: var(--primary-color); 
            font-weight: 700; 
        }

        #callSummaryContent .quality-text.quality-good { 
            color: var(--success-color); 
            font-weight: bold; 
        }

        #callSummaryContent .quality-text.quality-bad { 
            color: var(--danger-color); 
            font-weight: bold; 
        }

        #callSummaryContent .quality-text.quality-na { 
            color: var(--text-color-secondary); 
            font-style: italic; 
        }
        
        /* Enhanced Initial Card Layout */
        .initial-card-left { 
            text-align: left; 
        }

        .initial-card-left .card-icon {
            margin-bottom: 2rem;
        }

        .initial-card-left .card-icon svg {
            width: 64px;
            height: 64px;
        }
        
        /* Enhanced Scenario Selector */
        .scenario-selector-container {
            margin: 2rem 0;
        }

        .search-scenario-input {
            width: 100%;
            padding: 1rem 1.25rem;
            background: var(--input-background-color);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-color);
            font-size: 1rem;
            margin-bottom: 1.5rem;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        .search-scenario-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.2);
        }

        .search-scenario-input::placeholder {
            color: var(--text-color-secondary);
        }

        .custom-scenario-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-height: 350px;
            overflow-y: auto;
            padding-right: 0.75rem;
            margin-bottom: 2rem;
        }

        .scenario-item {
            padding: 1.25rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-weight: 600;
            border: 2px solid var(--secondary-color);
            background: var(--secondary-color);
            position: relative;
            font-size: 1.1rem;
        }

        .scenario-item:hover {
            background: rgba(var(--primary-color-rgb), 0.1);
            border-color: var(--primary-color);
            transform: translateX(8px);
        }
        
        .scenario-item:focus, .scenario-item.selected:focus {
             outline: none;
             border-color: var(--primary-color-dark);
             box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.3);
        }

        .scenario-item.selected {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark));
            color: white;
            font-weight: 700;
            border-color: var(--primary-color-dark);
            transform: translateX(8px);
        }

        .scenario-item .icon { 
            font-size: 1.4em; 
        }

        .scenario-item.compensation { 
            border-left: 4px solid var(--warning-color);
            background: rgba(255, 193, 7, 0.05);
        }

        .scenario-item.compensation.selected {
            background: linear-gradient(135deg, var(--warning-color), #ffb300);
        }

        #scenario-preview-tooltip {
            position: absolute;
            background: var(--card-background-color);
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            z-index: 100;
            width: 250px;
            font-size: 0.9rem;
            color: var(--text-color-secondary);
            display: none;
            pointer-events: none;
            backdrop-filter: blur(10px);
        }

        #scenario-preview-tooltip strong { 
            color: var(--text-color); 
            display: block;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        
        /* Enhanced Form Styles */
        .form-step-container { 
            margin-top: 2rem; 
        }

        .form-field { 
            margin-bottom: 1.5rem; 
        }

        .form-field label { 
            display: block; 
            margin-bottom: 0.75rem; 
            font-weight: 600; 
            color: var(--text-color-secondary); 
            font-size: 1.1rem;
        }

        .form-field input, .form-field textarea {
            width: 100%;
            padding: 1rem 1.25rem;
            background: var(--input-background-color);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-color);
            font-size: 1rem;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        .form-field input:focus, .form-field textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.2);
        }

        /* Enhanced Toast */
        .custom-toast {
            position: fixed;
            right: 2rem;
            bottom: 2rem;
            transform: translateY(100%);
            background: rgba(var(--primary-color-rgb), 0.15);
            backdrop-filter: blur(10px);
            color: var(--text-color);
            padding: 1.5rem 2.5rem;
            border-radius: var(--border-radius);
            border: 2px solid var(--primary-color);
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 1.25rem;
            font-size: 1.2rem;
            font-weight: 600;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s ease;
        }

        .custom-toast.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .custom-toast.hide {
             opacity: 0;
             transform: translateY(100%);
        }

        .custom-toast .toast-icon {
            font-size: 2rem;
        }

        /* Access Denied Modal */
        .access-denied-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(8px);
        }

        .access-denied-content {
            background: var(--card-background-color);
            border-radius: var(--border-radius);
            padding: 3rem;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
            animation: fadeInAnimation 0.5s ease-out;
        }

        .access-denied-content svg {
            color: var(--warning-color);
            margin-bottom: 1.5rem;
        }

        .access-denied-content h3 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            color: var(--text-color);
        }

        .access-denied-content p {
            color: var(--text-color-secondary);
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 2rem;
        }

        .access-denied-content strong {
            color: var(--primary-color);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .initial-card {
                grid-template-columns: 1fr;
                gap: 3rem;
                padding: 2.5rem;
            }
            
            .card {
                padding: 2.5rem;
            }
        }

        @media (max-width: 768px) {
            .app-main {
                padding: 1.5rem;
            }
            
            .app-header {
                padding: 1rem 1.5rem;
                flex-wrap: wrap;
                gap: 1rem;
            }
            
            .header-controls {
                width: 100%;
                justify-content: space-between;
            }
            
            .card {
                padding: 2rem 1.5rem;
            }
            
            .initial-card {
                padding: 2rem 1.5rem;
            }
            
            .steps-area {
                padding: 2rem 1.5rem;
                font-size: 1.2rem;
            }
            
            .decision-button {
                padding: 1rem 1.5rem;
                font-size: 1rem;
            }
            
            .navigation-buttons {
                flex-direction: column;
            }
            
            .action-button, .nav-button {
                width: 100%;
            }
            
            .access-denied-content {
                padding: 2rem;
                margin: 1rem;
            }
        }

        @media (max-width: 480px) {
            .app-main {
                padding: 1rem;
            }
            
            .card {
                padding: 1.5rem 1rem;
            }
            
            .card-title {
                font-size: 1.6rem;
            }
            
            .steps-area {
                padding: 1.5rem 1rem;
                font-size: 1.1rem;
            }
            
            .scenario-item {
                padding: 1rem 1.25rem;
                font-size: 1rem;
            }
            
            .access-denied-content {
                padding: 1.5rem;
            }
        }

        /* Loading States */
        .loading-skeleton {
            background: linear-gradient(90deg, var(--input-background-color) 25%, var(--border-color) 50%, var(--input-background-color) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
            height: 1.5rem;
            margin: 0.75rem 0;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body>

    <div class="app-container">
        
<header class="app-header" style="width: 100%; background: #111827; border-bottom: 1px solid #1f2937; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem;">
  <div class="logo-container" style="display: flex; align-items: center; gap: 0.75rem;">
    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: #4e8cff; width: 32px; height: 32px;">
      <path d="M6 17L10 17M6 12L12 12M6 7L14 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M15 6L19 10L15 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <rect x="3" y="3" width="18" height="18" rx="3" stroke="currentColor" stroke-width="1.5" fill="transparent" opacity="0.6"/>
    </svg>
    <span class="app-title" style="font-weight: 700; font-size: 1.3rem; color: #4e8cff;">Elevo Core</span>
  </div>
  <div class="header-controls" style="display: flex; align-items: center; gap: 1.25rem;">
    <a href="dashboard.html" class="nav-link" id="dashboardLink" style="color: #d1d5db; text-decoration: none; font-weight: 500; transition: 0.3s; display: none;">Dashboard</a>
    <div class="user-info" style="display: flex; align-items: center; gap: 0.75rem;">
      <span id="userName" style="color: #d1d5db; font-weight: 500;">User</span>
      <button id="logoutButton" class="logout-btn" style="background: linear-gradient(135deg, #4e8cff, #60a5fa); color: white; border: none; border-radius: 8px; padding: 0.6rem 1rem; font-weight: 600; cursor: pointer;">Logout</button>
    </div>
  </div>
</header>


        <div class="status-bar">
            <div id="systemStatus" class="status-indicator status-waiting">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                </svg>
                Waiting for Ticket
            </div>
        </div>

        <div id="timer-container">
             <div id="callTimer" style="display: none;">00:00</div>
        </div>

        <main class="app-main">
            <div id="auth-loading" class="loading-container" style="display: none; flex-direction: column; align-items: center; justify-content: center; height: 60vh;">
                <div class="spinner" style="width: 50px; height: 50px; border-top-color: var(--primary-color);"></div>
                <p style="color: var(--text-color-secondary); margin-top: 1.5rem; font-size: 1.1rem;">Initializing Assistant...</p>
            </div>

            <div id="initial-view" class="card initial-card fade-in" style="display: none;">
                <div class="initial-card-left">
                    <div class="card-icon">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="var(--primary-color)" width="72" height="72">
                             <path d="M12 2C6.486 2 2 6.486 2 12C2 17.514 6.486 22 12 22C17.514 22 22 17.514 22 12C22 6.486 17.514 2 12 2ZM12 20C7.589 20 4 16.411 4 12C4 7.589 7.589 4 12 4C16.411 4 20 7.589 20 12C20 16.411 16.411 20 12 20Z"/>
                             <path d="M12 11C10.897 11 10 10.103 10 9C10 7.897 10.897 7 12 7C13.103 7 14 7.897 14 9C14 10.103 13.103 11 12 11Z"/>
                             <path d="M16.002 16.246C15.483 15.219 14.544 14.5 13.333 14.5H10.667C9.456 14.5 8.517 15.219 7.998 16.246C7.933 16.386 7.996 16.553 8.114 16.622C8.232 16.691 8.399 16.628 8.464 16.488C8.883 15.614 9.7 15 10.667 15H13.333C14.3 15 15.117 15.614 15.536 16.488C15.601 16.628 15.768 16.691 15.886 16.622C16.004 16.553 16.067 16.386 16.002 16.246Z"/>
                         </svg>
                    </div>
                    <h1 class="card-title">Welcome to Elevo Core Assistant</h1>
                    <p class="card-subtitle">Select a scenario to begin your call flow. This assistant will guide you through the process step by step.</p>
                </div>
                <div class="initial-card-right">
                    <div class="scenario-selector-container">
                        <input type="text" id="searchScenario" class="search-scenario-input" placeholder="Search for a scenario...">
                        <div id="customScenarioList" class="custom-scenario-list">
                            <!-- Scenarios will be loaded here -->
                        </div>
                        <div class="navigation-buttons">
                            <button id="startScenarioBtn" class="action-button primary-button" disabled>Start Scenario</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="call-flow-view" class="card call-flow-card fade-in" style="display: none;">
                <h1 id="scenarioTitle" class="card-title scenario-title-dynamic">
                    <span class="step-type-icon">📞</span>
                    <span id="scenarioTitleText">Scenario Title</span>
                </h1>
                <div id="stepsArea" class="steps-area">
                    <p class="placeholder-text">Select a scenario to begin...</p>
                </div>
                <div id="stepActions" class="step-actions">
                    <!-- Decision buttons will be loaded here -->
                </div>
                <div class="navigation-buttons">
                    <button id="backToStartBtn" class="nav-button secondary-button">Back to Start</button>
                </div>
            </div>

            <div id="summary-view" class="card fade-in" style="display: none;">
                <h1 class="card-title">Call Summary</h1>
                <div id="callSummaryContent" class="steps-area">
                    <!-- Summary content will be loaded here -->
                </div>
                <div class="navigation-buttons">
                    <button id="newCallBtn" class="nav-button primary-button">Start New Call</button>
                    <button id="backToDashboardBtn" class="nav-button secondary-button">Back to Dashboard</button>
                </div>
            </div>
        </main>

        <footer class="app-footer">
            <p>Elevo Core Assistant v1.0</p>
        </footer>
    </div>

    <div id="scenario-preview-tooltip"></div>

    <div class="custom-toast" id="customToast">
        <div class="toast-icon">✅</div>
        <div class="toast-message">Action completed successfully!</div>
    </div>

    <div id="accessDeniedModal" class="access-denied-modal" style="display: none;">
        <div class="access-denied-content">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
            <h3>Access Restricted</h3>
            <p>This page is for <strong>admins</strong> and <strong>managers</strong> only.</p>
            <button id="backToDashboardBtnModal" class="action-button primary-button" style="margin-top: 1.5rem;">Back to Dashboard</button>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://your-project.supabase.co';
        const SUPABASE_ANON_KEY = 'your-anon-key';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Global variables
        let currentUser = null;
        let userRole = null;
        let currentScenario = null;
        let currentStepIndex = 0;
        let callStartTime = null;
        let timerInterval = null;
        let callDecisions = [];
        
        // DOM Elements
        const authLoadingEl = document.getElementById('auth-loading');
        const initialViewEl = document.getElementById('initial-view');
        const callFlowViewEl = document.getElementById('call-flow-view');
        const summaryViewEl = document.getElementById('summary-view');
        const systemStatusEl = document.getElementById('systemStatus');
        const callTimerEl = document.getElementById('callTimer');
        const scenarioTitleEl = document.getElementById('scenarioTitleText');
        const stepsAreaEl = document.getElementById('stepsArea');
        const stepActionsEl = document.getElementById('stepActions');
        const customScenarioListEl = document.getElementById('customScenarioList');
        const searchScenarioEl = document.getElementById('searchScenario');
        const startScenarioBtn = document.getElementById('startScenarioBtn');
        const backToStartBtn = document.getElementById('backToStartBtn');
        const newCallBtn = document.getElementById('newCallBtn');
        const backToDashboardBtn = document.getElementById('backToDashboardBtn');
        const backToDashboardBtnModal = document.getElementById('backToDashboardBtnModal');
        const userNameEl = document.getElementById('userName');
        const logoutBtn = document.getElementById('logoutButton');
        const accessDeniedModal = document.getElementById('accessDeniedModal');
        const dashboardLink = document.getElementById('dashboardLink');
        
        // Sample scenarios data
        const scenarios = [
            {
                id: 'scenario-1',
                title: 'Customer Complaint',
                description: 'Handle customer complaints and dissatisfaction',
                steps: [
                    {
                        type: 'greeting',
                        text: 'Start by greeting the customer and asking how you can help them today.',
                        decisions: [
                            { text: 'Customer is angry', nextStep: 1, type: 'negative' },
                            { text: 'Customer is calm', nextStep: 2, type: 'neutral' }
                        ]
                    },
                    {
                        type: 'apology',
                        text: 'The customer is clearly upset. Apologize sincerely for their inconvenience.',
                        decisions: [
                            { text: 'Apologize and offer solution', nextStep: 3, type: 'positive' },
                            { text: 'Customer wants escalation', nextStep: 4, type: 'negative' }
                        ]
                    },
                    {
                        type: 'information',
                        text: 'The customer is calm. Ask for more details about their issue.',
                        decisions: [
                            { text: 'Gather information', nextStep: 5, type: 'neutral' }
                        ]
                    },
                    {
                        type: 'solution',
                        text: 'Offer a solution based on the information gathered.',
                        decisions: [
                            { text: 'Customer accepts solution', nextStep: 6, type: 'positive' },
                            { text: 'Customer rejects solution', nextStep: 4, type: 'negative' }
                        ]
                    },
                    {
                        type: 'escalation',
                        text: 'The customer wants to speak with a supervisor. Explain the escalation process.',
                        decisions: [
                            { text: 'Schedule callback', nextStep: 7, type: 'neutral' }
                        ]
                    },
                    {
                        type: 'investigation',
                        text: 'Ask specific questions to understand the root cause of the issue.',
                        decisions: [
                            { text: 'Identify problem', nextStep: 3, type: 'positive' }
                        ]
                    },
                    {
                        type: 'resolution',
                        text: 'The customer has accepted your solution. Confirm the resolution and thank them.',
                        decisions: [
                            { text: 'End call', nextStep: 8, type: 'positive' }
                        ]
                    },
                    {
                        type: 'followup',
                        text: 'Schedule a follow-up call to ensure the issue is resolved.',
                        decisions: [
                            { text: 'Confirm follow-up', nextStep: 8, type: 'positive' }
                        ]
                    },
                    {
                        type: 'summary',
                        text: 'Call completed successfully. Document the interaction.',
                        decisions: []
                    }
                ]
            },
            {
                id: 'scenario-2',
                title: 'Product Inquiry',
                description: 'Handle product information requests',
                steps: [
                    {
                        type: 'greeting',
                        text: 'Welcome the customer and ask about the product they\'re interested in.',
                        decisions: [
                            { text: 'Customer knows product', nextStep: 1, type: 'neutral' },
                            { text: 'Customer needs guidance', nextStep: 2, type: 'neutral' }
                        ]
                    },
                    {
                        type: 'information',
                        text: 'Provide detailed information about the specific product.',
                        decisions: [
                            { text: 'Customer is interested', nextStep: 3, type: 'positive' },
                            { text: 'Customer has questions', nextStep: 4, type: 'neutral' }
                        ]
                    },
                    {
                        type: 'guidance',
                        text: 'Ask about the customer\'s needs to recommend suitable products.',
                        decisions: [
                            { text: 'Make recommendation', nextStep: 5, type: 'positive' }
                        ]
                    },
                    {
                        type: 'closing',
                        text: 'The customer is interested. Provide purchasing information.',
                        decisions: [
                            { text: 'Complete inquiry', nextStep: 6, type: 'positive' }
                        ]
                    },
                    {
                        type: 'qa',
                        text: 'Answer any additional questions the customer may have.',
                        decisions: [
                            { text: 'All questions answered', nextStep: 3, type: 'positive' }
                        ]
                    },
                    {
                        type: 'recommendation',
                        text: 'Recommend the most suitable product based on customer needs.',
                        decisions: [
                            { text: 'Customer accepts', nextStep: 3, type: 'positive' }
                        ]
                    },
                    {
                        type: 'summary',
                        text: 'Inquiry completed. Thank the customer for their interest.',
                        decisions: []
                    }
                ]
            },
            {
                id: 'scenario-3',
                title: 'Technical Support',
                description: 'Provide technical assistance and troubleshooting',
                steps: [
                    {
                        type: 'greeting',
                        text: 'Welcome the customer and ask them to describe the technical issue.',
                        decisions: [
                            { text: 'Simple issue', nextStep: 1, type: 'neutral' },
                            { text: 'Complex issue', nextStep: 2, type: 'negative' }
                        ]
                    },
                    {
                        type: 'basic-troubleshooting',
                        text: 'Guide the customer through basic troubleshooting steps.',
                        decisions: [
                            { text: 'Issue resolved', nextStep: 5, type: 'positive' },
                            { text: 'Issue persists', nextStep: 3, type: 'negative' }
                        ]
                    },
                    {
                        type: 'advanced-troubleshooting',
                        text: 'The issue is complex. Ask for more specific details.',
                        decisions: [
                            { text: 'Gather details', nextStep: 4, type: 'neutral' }
                        ]
                    },
                    {
                        type: 'diagnosis',
                        text: 'Based on the information, diagnose the root cause.',
                        decisions: [
                            { text: 'Identify cause', nextStep: 6, type: 'positive' },
                            { text: 'Need more info', nextStep: 2, type: 'neutral' }
                        ]
                    },
                    {
                        type: 'resolution',
                        text: 'The issue has been resolved. Confirm with the customer.',
                        decisions: [
                            { text: 'Confirm resolution', nextStep: 7, type: 'positive' }
                        ]
                    },
                    {
                        type: 'solution',
                        text: 'Provide the solution based on your diagnosis.',
                        decisions: [
                            { text: 'Apply solution', nextStep: 5, type: 'positive' }
                        ]
                    },
                    {
                        type: 'summary',
                        text: 'Technical support completed. Document the solution.',
                        decisions: []
                    }
                ]
            },
            {
                id: 'scenario-4',
                title: 'Billing Inquiry',
                description: 'Handle billing questions and payment issues',
                steps: [
                    {
                        type: 'greeting',
                        text: 'Welcome the customer and ask about their billing concern.',
                        decisions: [
                            { text: 'Question about charge', nextStep: 1, type: 'neutral' },
                            { text: 'Payment issue', nextStep: 2, type: 'negative' }
                        ]
                    },
                    {
                        type: 'explanation',
                        text: 'Explain the specific charge the customer is asking about.',
                        decisions: [
                            { text: 'Customer understands', nextStep: 5, type: 'positive' },
                            { text: 'Customer disputes', nextStep: 3, type: 'negative' }
                        ]
                    },
                    {
                        type: 'payment-assistance',
                        text: 'Assist the customer with their payment issue.',
                        decisions: [
                            { text: 'Payment processed', nextStep: 5, type: 'positive' },
                            { text: 'Payment failed', nextStep: 4, type: 'negative' }
                        ]
                    },
                    {
                        type: 'dispute-resolution',
                        text: 'Handle the customer\'s dispute about the charge.',
                        decisions: [
                            { text: 'Resolve dispute', nextStep: 5, type: 'positive' },
                            { text: 'Escalate dispute', nextStep: 6, type: 'negative' }
                        ]
                    },
                    {
                        type: 'alternative-payment',
                        text: 'Suggest alternative payment methods.',
                        decisions: [
                            { text: 'Customer agrees', nextStep: 5, type: 'positive' }
                        ]
                    },
                    {
                        type: 'confirmation',
                        text: 'Confirm the resolution with the customer.',
                        decisions: [
                            { text: 'End call', nextStep: 7, type: 'positive' }
                        ]
                    },
                    {
                        type: 'escalation',
                        text: 'Escalate the dispute to the billing department.',
                        decisions: [
                            { text: 'Schedule callback', nextStep: 7, type: 'neutral' }
                        ]
                    },
                    {
                        type: 'summary',
                        text: 'Billing inquiry completed. Document the resolution.',
                        decisions: []
                    }
                ]
            },
            {
                id: 'scenario-5',
                title: 'Account Management',
                description: 'Handle account updates and management requests',
                steps: [
                    {
                        type: 'greeting',
                        text: 'Welcome the customer and verify their identity.',
                        decisions: [
                            { text: 'Identity verified', nextStep: 1, type: 'neutral' }
                        ]
                    },
                    {
                        type: 'request',
                        text: 'Ask what changes the customer wants to make to their account.',
                        decisions: [
                            { text: 'Update information', nextStep: 2, type: 'neutral' },
                            { text: 'Close account', nextStep: 3, type: 'negative' }
                        ]
                    },
                    {
                        type: 'update',
                        text: 'Process the information update request.',
                        decisions: [
                            { text: 'Update successful', nextStep: 6, type: 'positive' },
                            { text: 'Update failed', nextStep: 4, type: 'negative' }
                        ]
                    },
                    {
                        type: 'retention',
                        text: 'The customer wants to close their account. Attempt to retain them.',
                        decisions: [
                            { text: 'Customer stays', nextStep: 1, type: 'positive' },
                            { text: 'Customer insists', nextStep: 5, type: 'negative' }
                        ]
                    },
                    {
                        type: 'troubleshooting',
                        text: 'Troubleshoot the issue with the update.',
                        decisions: [
                            { text: 'Issue resolved', nextStep: 2, type: 'positive' }
                        ]
                    },
                    {
                        type: 'closure',
                        text: 'Process the account closure request.',
                        decisions: [
                            { text: 'Closure complete', nextStep: 6, type: 'neutral' }
                        ]
                    },
                    {
                        type: 'summary',
                        text: 'Account management completed. Confirm changes with customer.',
                        decisions: []
                    }
                ]
            }
        ];

       // Initialize the application
document.addEventListener('DOMContentLoaded', async function () {
  await initializeApp();
});

// 🔒 التحقق من تسجيل الدخول باستخدام Supabase مع إعادة المحاولة
async function getCurrentUserWithRetry(retries = 5, delay = 500) {
  for (let i = 0; i < retries; i++) {
    const { data: { user } } = await supabase.auth.getUser();
    if (user) return user;
    await new Promise(res => setTimeout(res, delay));
  }
  return null;
}

// 🚀 تشغيل التطبيق
async function initializeApp() {
  try {
    // Show loading state
    if (typeof authLoadingEl !== 'undefined') {
      authLoadingEl.style.display = 'flex';
      authLoadingEl.querySelector('p').textContent = 'Checking your session...';
    }

    const user = await getCurrentUserWithRetry();

    if (!user) {
      console.error("No authenticated user found, redirecting to login.");
      window.location.href = 'index.html';
      return;
    }

    console.log('✅ Authenticated user:', user.email);

    // ✅ بعد التحقق من المستخدم نبدأ تحميل محتوى الصفحة
    if (typeof initializeAssistant === 'function') {
      initializeAssistant(user);
    } else {
      console.log('ℹ️ initializeAssistant function not found, skipping initialization.');
    }

  } catch (error) {
    console.error('Error initializing app:', error);
    if (typeof showErrorMessage === 'function') {
      showErrorMessage('Error initializing application');
    }
  }
}

                currentUser = user;
                
                // Get user role from database
                const { data, error } = await supabase
                    .from('users')
                    .select('id, name, email, role')
                    .eq('id', user.id)
                    .single();
                    
                if (error) {
                    console.error('Error fetching user data:', error);
                    showToast('Error loading user data', 'error');
                    return;
                }
                
                userRole = data.role;
                
                // Update UI with user info
                userNameEl.textContent = data.name || data.email;
                
                // Show dashboard link for all roles
                dashboardLink.style.display = 'inline-block';
                
                // Hide loading and show initial view
                authLoadingEl.style.display = 'none';
                initialViewEl.style.display = 'grid';
                
                // Load scenarios
                loadScenarios();
                
                // Set up event listeners
                setupEventListeners();
                
            } catch (error) {
                console.error('Error initializing app:', error);
                showToast('Error initializing application', 'error');
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            // Scenario selection
            startScenarioBtn.addEventListener('click', startSelectedScenario);
            backToStartBtn.addEventListener('click', showInitialView);
            newCallBtn.addEventListener('click', showInitialView);
            backToDashboardBtn.addEventListener('click', () => {
                window.location.href = 'dashboard.html';
            });
            backToDashboardBtnModal.addEventListener('click', () => {
                window.location.href = 'dashboard.html';
            });
            
            // Logout
            logoutBtn.addEventListener('click', handleLogout);
            
            // Scenario search
            searchScenarioEl.addEventListener('input', filterScenarios);
            
            // Scenario hover for preview
            document.addEventListener('mouseover', handleScenarioHover);
            document.addEventListener('mouseout', hideScenarioPreview);
        }

        // Load scenarios into the UI
        function loadScenarios() {
            customScenarioListEl.innerHTML = '';
            
            scenarios.forEach((scenario, index) => {
                const scenarioItem = document.createElement('div');
                scenarioItem.className = 'scenario-item';
                scenarioItem.dataset.id = scenario.id;
                scenarioItem.dataset.index = index;
                
                // Add icon based on scenario type
                let icon = '📞';
                if (scenario.title.includes('Complaint')) icon = '😠';
                if (scenario.title.includes('Inquiry')) icon = '❓';
                if (scenario.title.includes('Technical')) icon = '🔧';
                if (scenario.title.includes('Billing')) icon = '💰';
                if (scenario.title.includes('Account')) icon = '👤';
                
                scenarioItem.innerHTML = `
                    <span class="icon">${icon}</span>
                    <span class="scenario-title">${scenario.title}</span>
                `;
                
                scenarioItem.addEventListener('click', () => selectScenario(scenario.id));
                
                customScenarioListEl.appendChild(scenarioItem);
            });
        }

        // Filter scenarios based on search input
        function filterScenarios() {
            const searchTerm = searchScenarioEl.value.toLowerCase();
            const scenarioItems = document.querySelectorAll('.scenario-item');
            
            scenarioItems.forEach(item => {
                const title = item.querySelector('.scenario-title').textContent.toLowerCase();
                if (title.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Handle scenario hover for preview
        function handleScenarioHover(e) {
            if (e.target.closest('.scenario-item')) {
                const scenarioItem = e.target.closest('.scenario-item');
                const scenarioIndex = scenarioItem.dataset.index;
                const scenario = scenarios[scenarioIndex];
                
                if (scenario) {
                    showScenarioPreview(scenario, e.clientX, e.clientY);
                }
            }
        }

        // Show scenario preview tooltip
        function showScenarioPreview(scenario, x, y) {
            const tooltip = document.getElementById('scenario-preview-tooltip');
            tooltip.innerHTML = `
                <strong>${scenario.title}</strong>
                <div>${scenario.description}</div>
                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--primary-color);">
                    ${scenario.steps.length} steps
                </div>
            `;
            tooltip.style.display = 'block';
            tooltip.style.left = (x + 15) + 'px';
            tooltip.style.top = (y + 15) + 'px';
        }

        // Hide scenario preview tooltip
        function hideScenarioPreview() {
            const tooltip = document.getElementById('scenario-preview-tooltip');
            tooltip.style.display = 'none';
        }

        // Select a scenario
        function selectScenario(scenarioId) {
            // Remove selected class from all items
            document.querySelectorAll('.scenario-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Add selected class to clicked item
            const selectedItem = document.querySelector(`.scenario-item[data-id="${scenarioId}"]`);
            selectedItem.classList.add('selected');
            
            // Enable start button
            startScenarioBtn.disabled = false;
            
            // Store selected scenario
            currentScenario = scenarios.find(s => s.id === scenarioId);
        }

        // Start the selected scenario
        function startSelectedScenario() {
            if (!currentScenario) {
                showToast('Please select a scenario first', 'warning');
                return;
            }
            
            // Reset call state
            currentStepIndex = 0;
            callDecisions = [];
            callStartTime = new Date();
            
            // Start timer
            startTimer();
            
            // Update status
            updateSystemStatus('in-call');
            
            // Show call flow view
            showCallFlowView();
            
            // Load first step
            loadStep(currentStepIndex);
        }

        // Show initial view
        function showInitialView() {
            initialViewEl.style.display = 'grid';
            callFlowViewEl.style.display = 'none';
            summaryViewEl.style.display = 'none';
            
            // Reset timer
            stopTimer();
            callTimerEl.style.display = 'none';
            
            // Update status
            updateSystemStatus('waiting');
        }

        // Show call flow view
        function showCallFlowView() {
            initialViewEl.style.display = 'none';
            callFlowViewEl.style.display = 'block';
            summaryViewEl.style.display = 'none';
        }

        // Show summary view
        function showSummaryView() {
            initialViewEl.style.display = 'none';
            callFlowViewEl.style.display = 'none';
            summaryViewEl.style.display = 'block';
            
            // Stop timer
            stopTimer();
            
            // Update status
            updateSystemStatus('completed');
            
            // Generate summary
            generateCallSummary();
        }

        // Load a specific step
        function loadStep(stepIndex) {
            if (!currentScenario || !currentScenario.steps[stepIndex]) {
                console.error('Invalid step index or scenario');
                return;
            }
            
            const step = currentScenario.steps[stepIndex];
            
            // Update scenario title with step type icon
            let stepIcon = '📞';
            switch(step.type) {
                case 'greeting': stepIcon = '👋'; break;
                case 'apology': stepIcon = '🙏'; break;
                case 'information': stepIcon = 'ℹ️'; break;
                case 'solution': stepIcon = '💡'; break;
                case 'escalation': stepIcon = '⬆️'; break;
                case 'investigation': stepIcon = '🔍'; break;
                case 'resolution': stepIcon = '✅'; break;
                case 'followup': stepIcon = '📅'; break;
                case 'summary': stepIcon = '📋'; break;
                case 'guidance': stepIcon = '🧭'; break;
                case 'closing': stepIcon = '🔚'; break;
                case 'qa': stepIcon = '❓'; break;
                case 'recommendation': stepIcon = '⭐'; break;
                case 'basic-troubleshooting': stepIcon = '🔧'; break;
                case 'advanced-troubleshooting': stepIcon = '⚙️'; break;
                case 'diagnosis': stepIcon = '🎯'; break;
                case 'explanation': stepIcon = '📚'; break;
                case 'payment-assistance': stepIcon = '💳'; break;
                case 'dispute-resolution': stepIcon = '⚖️'; break;
                case 'alternative-payment': stepIcon = '🔄'; break;
                case 'confirmation': stepIcon = '✓'; break;
                case 'request': stepIcon = '📝'; break;
                case 'update': stepIcon = '✏️'; break;
                case 'retention': stepIcon = '💎'; break;
                case 'troubleshooting': stepIcon = '🛠️'; break;
                case 'closure': stepIcon = '🔒'; break;
            }
            
            document.querySelector('.step-type-icon').textContent = stepIcon;
            scenarioTitleEl.textContent = currentScenario.title;
            
            // Update steps area
            stepsAreaEl.innerHTML = `<p>${step.text}</p>`;
            
            // Update step actions
            stepActionsEl.innerHTML = '';
            
            if (step.decisions && step.decisions.length > 0) {
                step.decisions.forEach(decision => {
                    const button = document.createElement('button');
                    button.className = `decision-button ${decision.type || 'neutral'}`;
                    button.textContent = decision.text;
                    button.addEventListener('click', () => makeDecision(decision.nextStep, decision.text));
                    stepActionsEl.appendChild(button);
                });
            } else {
                // This is the final step (summary)
                const button = document.createElement('button');
                button.className = 'decision-button primary-button';
                button.textContent = 'View Call Summary';
                button.addEventListener('click', showSummaryView);
                stepActionsEl.appendChild(button);
            }
            
            // Add fade-in animation
            stepsAreaEl.classList.add('fade-in');
            setTimeout(() => stepsAreaEl.classList.remove('fade-in'), 600);
        }

        // Make a decision and proceed to next step
        function makeDecision(nextStepIndex, decisionText) {
            // Record decision
            callDecisions.push({
                step: currentStepIndex,
                decision: decisionText,
                timestamp: new Date()
            });
            
            // Update to next step
            currentStepIndex = nextStepIndex;
            
            // Add animation to card
            callFlowViewEl.classList.add('decision-made-animation');
            setTimeout(() => callFlowViewEl.classList.remove('decision-made-animation'), 700);
            
            // Load next step
            loadStep(currentStepIndex);
        }

        // Start the call timer
        function startTimer() {
            callTimerEl.style.display = 'block';
            callTimerEl.textContent = '00:00';
            
            let seconds = 0;
            timerInterval = setInterval(() => {
                seconds++;
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                callTimerEl.textContent = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // Stop the call timer
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        // Update system status
        function updateSystemStatus(status) {
            systemStatusEl.className = 'status-indicator';
            
            switch(status) {
                case 'waiting':
                    systemStatusEl.classList.add('status-waiting');
                    systemStatusEl.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                        </svg>
                        Waiting for Ticket
                    `;
                    break;
                case 'loading':
                    systemStatusEl.classList.add('status-loading');
                    systemStatusEl.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        Loading...
                    `;
                    break;
                case 'in-call':
                    systemStatusEl.classList.add('status-in-call');
                    systemStatusEl.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                        </svg>
                        In Call
                    `;
                    break;
                case 'completed':
                    systemStatusEl.classList.add('status-completed');
                    systemStatusEl.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                        Call Completed
                    `;
                    break;
                case 'ended':
                    systemStatusEl.classList.add('status-ended');
                    systemStatusEl.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                        Call Ended
                    `;
                    break;
                case 'summary':
                    systemStatusEl.classList.add('status-summary');
                    systemStatusEl.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        Summary Ready
                    `;
                    break;
            }
        }

        // Generate call summary
        function generateCallSummary() {
            const callDuration = callTimerEl.textContent;
            const summaryContent = document.getElementById('callSummaryContent');
            
            let summaryHTML = `
                <p><strong>Scenario:</strong> ${currentScenario.title}</p>
                <p><strong>Call Duration:</strong> ${callDuration}</p>
                <p><strong>Agent:</strong> ${userNameEl.textContent}</p>
                <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                <hr style="border: none; border-top: 1px solid var(--border-color); margin: 1.5rem 0;">
                <p><strong>Call Flow:</strong></p>
                <ul style="padding-left: 1.5rem; margin-bottom: 1.5rem;">
            `;
            
            // Add steps and decisions
            for (let i = 0; i <= currentStepIndex; i++) {
                const step = currentScenario.steps[i];
                if (step) {
                    summaryHTML += `<li style="margin-bottom: 0.75rem;">${step.text}</li>`;
                    
                    // Add decision if available
                    const decision = callDecisions.find(d => d.step === i);
                    if (decision) {
                        summaryHTML += `<li style="margin-bottom: 0.75rem; margin-left: 1rem; color: var(--primary-color);"><strong>Decision:</strong> ${decision.decision}</li>`;
                    }
                }
            }
            
            summaryHTML += `</ul>`;
            
            // Add call quality assessment
            const positiveDecisions = callDecisions.filter(d => 
                d.decision.toLowerCase().includes('accept') || 
                d.decision.toLowerCase().includes('resolve') || 
                d.decision.toLowerCase().includes('success')
            ).length;
            
            const totalDecisions = callDecisions.length;
            const positiveRatio = totalDecisions > 0 ? positiveDecisions / totalDecisions : 0;
            
            let qualityText = '';
            let qualityClass = '';
            
            if (positiveRatio >= 0.7) {
                qualityText = 'Good';
                qualityClass = 'quality-good';
            } else if (positiveRatio >= 0.4) {
                qualityText = 'Average';
                qualityClass = 'quality-na';
            } else {
                qualityText = 'Needs Improvement';
                qualityClass = 'quality-bad';
            }
            
            summaryHTML += `
                <p><strong>Call Quality:</strong> <span class="quality-text ${qualityClass}">${qualityText}</span></p>
            `;
            
            summaryContent.innerHTML = summaryHTML;
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('customToast');
            const toastMessage = toast.querySelector('.toast-message');
            const toastIcon = toast.querySelector('.toast-icon');
            
            // Set message and icon based on type
            toastMessage.textContent = message;
            
            switch(type) {
                case 'success':
                    toastIcon.textContent = '✅';
                    toast.style.background = 'rgba(76, 175, 80, 0.15)';
                    toast.style.borderColor = 'var(--success-color)';
                    break;
                case 'error':
                    toastIcon.textContent = '❌';
                    toast.style.background = 'rgba(244, 67, 54, 0.15)';
                    toast.style.borderColor = 'var(--danger-color)';
                    break;
                case 'warning':
                    toastIcon.textContent = '⚠️';
                    toast.style.background = 'rgba(255, 193, 7, 0.15)';
                    toast.style.borderColor = 'var(--warning-color)';
                    break;
            }
            
            // Show toast
            toast.classList.remove('hide');
            toast.classList.add('show');
            
            // Hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                toast.classList.add('hide');
            }, 3000);
        }

        // Handle logout
        async function handleLogout() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                // Redirect to login page
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Error signing out:', error);
                showToast('Error signing out', 'error');
            }
        }

        // Check user permissions for admin pages
        async function checkAdminPermissions() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    window.location.href = 'index.html';
                    return false;
                }
                
                const { data } = await supabase
                    .from('users')
                    .select('id, name, email, role')
                    .eq('id', user.id)
                    .single();
                    
                if (!data) {
                    console.error('User data not found');
                    return false;
                }
                
                // Check if user has admin or manager role
                if (data.role === 'admin' || data.role === 'manager') {
                    return true;
                } else {
                    // Show access denied modal
                    accessDeniedModal.style.display = 'flex';
                    return false;
                }
            } catch (error) {
                console.error('Error checking permissions:', error);
                return false;
            }
        }
    </script>
</body>
</html>
