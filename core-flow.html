<!doctype html>
<html lang="ar" class="dark" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Elevo Core Assistant</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234e8cff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M3 12h18M3 6h12M3 18h15'/><path d='M17 9l4 3l-4 3'/></svg>">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
    --background-color: #1c1c28;
    --card-background-color: #2b2b3d;
    --text-color: #f0f0f0;
    --text-color-secondary: #a0a0b0;
    --primary-color: #4e8cff;
    --primary-color-rgb: 78, 140, 255;
    --primary-color-dark: #3d7eff;
    --secondary-color: #3a3a50;
    --border-color: #444444;
    --input-background-color: #242436;
    --input-border-color: #444444;
    --button-text-color: #ffffff;
    --success-color: #4CAF50;
    --danger-color: #F44336;
    --warning-color: #FFC107;
    --border-radius: 16px;
    --font-family-main: 'Cairo', sans-serif;
}


html.dark {
background-color: var(--background-color);
}

body {
background-color: var(--background-color);
color: var(--text-color);
font-family: var(--font-family-main);
margin: 0;
padding: 0;
line-height: 1.6;
overflow-x: hidden;
}

.app-container {
display: flex;
flex-direction: column;
min-height: 100vh;
max-width: 100%;
margin: 0 auto;
}

.app-main {
padding: 2rem;
flex-grow: 1;
display: flex;
flex-direction: column;
align-items: center;
justify-content: flex-start;
}

.app-header {
background: linear-gradient(135deg, var(--card-background-color), #242436);
color: var(--text-color);
padding: 1.25rem 2rem;
display: flex;
justify-content: space-between;
align-items: center;
border-bottom: 1px solid var(--border-color);
box-shadow: 0 4px 20px rgba(0, 0, 0, .25);
width: 100%;
box-sizing: border-box;
backdrop-filter: blur(10px);
position: sticky;
top: 0;
z-index: 1000;
}

.logo-container {
display: flex;
align-items: center;
gap: 1rem;
}

.app-title {
font-weight: 700;
color: var(--primary-color);
font-size: 1.4rem;
background: linear-gradient(135deg, var(--primary-color), #6ea8ff);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
}

.header-controls {
display: flex;
align-items: center;
gap: 1.5rem;
}

/* New styles for navigation */
.main-nav {
display: flex;
gap: .75rem;
}

.nav-link {
color: var(--text-color-secondary);
text-decoration: none;
transition: all .3s ease;
font-weight: 500;
padding: .5rem 1rem;
border-radius: 8px;
border: 1px solid transparent;
font-size: 0.95rem;
}

.nav-link:hover {
color: var(--primary-color);
background: rgba(var(--primary-color-rgb), .1);
}

.nav-link.active {
color: #ffffff;
background: rgba(var(--primary-color-rgb), .15);
border: 1px solid var(--primary-color);
font-weight: 600;
box-shadow: 0 0 8px rgba(var(--primary-color-rgb), 0.3), inset 0 0 5px rgba(var(--primary-color-rgb), 0.2);
text-shadow: 0 0 5px rgba(var(--primary-color-rgb), 0.5);
}

.user-info {
display: flex;
align-items: center;
gap: 1rem;
padding-left: 1.5rem;
border-left: 1px solid var(--border-color);
}

.user-name-display {
color: var(--text-color-secondary);
white-space: nowrap;
font-weight: 500;
}

.logout-btn {
background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark));
color: #fff;
border: none;
border-radius: 12px;
padding: .7rem 1.4rem;
display: inline-flex;
align-items: center;
gap: .5em;
cursor: pointer;
transition: all .3s ease-in-out;
font-size: .9rem;
font-weight: 600;
box-shadow: 0 4px 15px rgba(var(--primary-color-rgb), .3);
}

.logout-btn:hover {
transform: translateY(-2px);
box-shadow: 0 6px 20px rgba(var(--primary-color-rgb), .4);
}

.logout-btn svg {
margin-right: .3em;
}

/* Hamburger Menu Styles */
.menu-toggle {
display: none;
background: none;
border: none;
cursor: pointer;
padding: 0;
z-index: 1001;
}

.menu-toggle .hamburger-icon {
width: 28px;
height: 22px;
display: flex;
flex-direction: column;
justify-content: space-between;
}

.menu-toggle .hamburger-icon span {
display: block;
width: 100%;
height: 3px;
background-color: var(--text-color);
border-radius: 2px;
transition: all .3s ease-in-out;
}

.card {
background: radial-gradient(circle at 50% 0%, rgba(var(--primary-color-rgb), 0.05), transparent 40%), linear-gradient(145deg, var(--card-background-color), #242436);
padding: 3rem;
border-radius: var(--border-radius);
box-shadow: 0 8px 32px rgba(0, 0, 0, .3);
border: 1px solid var(--border-color);
margin-bottom: 2rem;
width: 100%;
max-width: 1100px;
box-sizing: border-box;
position: relative;
overflow: hidden;
}

.card::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
height: 3px;
background: linear-gradient(90deg, var(--primary-color), var(--primary-color-dark));
}
.initial-card {
display: grid;
grid-template-columns: 1fr 1.5fr;
gap: 4rem;
max-width: 1100px;
padding: 3.5rem;
align-items: center;
background: linear-gradient(135deg, var(--card-background-color), #1f2937);
}

.call-flow-card {
background: linear-gradient(145deg, var(--card-background-color), #242436);
position: relative;
border-radius: var(--border-radius);
min-height: 500px;
}

.post-call-summary-card {
    min-height: 500px; /* Ensure sufficient height */
}


@keyframes cardDecisionPulse {
0% {
box-shadow: 0 8px 32px rgba(0, 0, 0, .3), 0 0 0 0 rgba(var(--primary-color-rgb), .5)
}
50% {
box-shadow: 0 8px 32px rgba(0, 0, 0, .3), 0 0 0 12px rgba(var(--primary-color-rgb), 0)
}
100% {
box-shadow: 0 8px 32px rgba(0, 0, 0, .3), 0 0 0 0 rgba(var(--primary-color-rgb), 0)
}
}

.decision-made-animation {
animation: cardDecisionPulse .7s ease-out
}

.card-title {
color: var(--text-color);
font-size: 2rem;
font-weight: 700;
margin-bottom: 1rem;
background: linear-gradient(135deg, var(--text-color), var(--primary-color));
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
}

.scenario-title-dynamic {
margin-bottom: 1.5rem;
font-size: 1.8rem;
}

.scenario-title-dynamic .step-type-icon {
margin-right: .5em;
font-size: 1.3em;
display: inline-block;
transform: translateY(.1em);
}

.card-subtitle {
color: var(--text-color-secondary);
font-size: 1.2rem;
margin-top: .5rem;
line-height: 1.6;
}

.action-button,
.decision-button,
.nav-button {
padding: 1rem 2rem;
border-radius: 12px;
font-weight: 600;
cursor: pointer;
transition: all .3s ease-in-out;
border: none;
font-size: 1rem;
display: inline-flex;
align-items: center;
justify-content: center;
gap: .75em;
width: auto;
box-sizing: border-box;
position: relative;
overflow: hidden;
}

.action-button:active,
.decision-button:active,
.nav-button:active {
transform: translateY(1px) scale(.98);
}

.primary-button {
background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark));
color: #fff;
box-shadow: 0 4px 15px rgba(var(--primary-color-rgb), .3);
}

.primary-button:hover {
background: linear-gradient(135deg, var(--primary-color-dark), var(--primary-color));
transform: translateY(-3px);
box-shadow: 0 6px 20px rgba(var(--primary-color-rgb), .4);
}

.primary-button:disabled {
background: var(--secondary-color);
cursor: not-allowed;
transform: none;
box-shadow: none;
opacity: .6;
}

.primary-button .btn-spinner {
width: 1.2em;
height: 1.2em;
border: 2px solid rgba(255, 255, 255, .3);
border-top-color: #fff;
border-radius: 50%;
animation: spin .8s linear infinite;
margin-right: .5em;
}

@keyframes spin {
to {
transform: rotate(360deg)
}
}

.secondary-button {
background: var(--secondary-color);
color: var(--button-text-color);
border: 1px solid var(--border-color);
}

.secondary-button:hover {
background: #4a4a60;
border-color: var(--text-color-secondary);
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(0, 0, 0, .3);
}

.danger-button {
background: transparent;
color: var(--danger-color);
border: 2px solid var(--danger-color);
font-weight: 600;
}

.danger-button:hover {
background: var(--danger-color);
color: #fff;
transform: translateY(-2px);
box-shadow: 0 4px 15px rgba(244, 67, 54, .3);
}

.highlight-scenario-title-animation {
animation: pulse-title .6s 2 ease-in-out
}

@keyframes pulse-title {
0%,
100% {
transform: scale(1);
opacity: 1;
color: var(--warning-color)
}
50% {
transform: scale(1.03);
opacity: .8;
color: var(--warning-color)
}
}

.step-actions {
margin-top: 2.5rem;
display: flex;
flex-direction: column;
gap: 1rem;
align-items: stretch;
}

.decision-button {
border: 2px solid var(--border-color);
background: var(--input-background-color);
color: var(--text-color);
text-align: center;
width: 100%;
padding: 1.25rem 2rem;
font-size: 1.1rem;
border-radius: 12px;
transition: all .3s ease;
}

.decision-button:hover {
border-color: var(--primary-color);
background: rgba(var(--primary-color-rgb), .1);
box-shadow: 0 4px 15px rgba(var(--primary-color-rgb), .2);
transform: translateY(-3px);
}

.decision-button:focus {
outline: 0;
border-color: var(--primary-color-dark);
box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), .3);
}

.decision-button.positive:hover {
background: var(--success-color);
border-color: var(--success-color);
color: #fff;
box-shadow: 0 4px 15px rgba(76, 175, 80, .4);
}

.decision-button.negative:hover {
background: var(--danger-color);
border-color: var(--danger-color);
color: #fff;
box-shadow: 0 4px 15px rgba(244, 67, 54, .4);
}

.decision-button.neutral:hover {
background: var(--primary-color-dark);
border-color: var(--primary-color);
color: #fff;
box-shadow: 0 4px 15px rgba(var(--primary-color-rgb), .4);
}

.navigation-buttons {
margin-top: 2.5rem;
display: flex;
gap: 1rem;
justify-content: center;
}

.status-bar {
background: linear-gradient(135deg, #242436, #1a1a2e);
color: var(--text-color);
padding: 1rem 2rem;
font-size: 1rem;
border-bottom: 1px solid var(--border-color);
width: 100%;
box-sizing: border-box;
text-align: center;
font-weight: 600;
}

.status-indicator {
padding: .5rem 1rem;
border-radius: 8px;
display: inline-flex;
align-items: center;
gap: .5rem;
}

.status-indicator.status-waiting {
background: rgba(244, 67, 54, .15);
color: var(--danger-color);
border: 1px solid rgba(244, 67, 54, .3);
}

.status-indicator.status-loading {
background: rgba(255, 193, 7, .15);
color: var(--warning-color);
border: 1px solid rgba(255, 193, 7, .3);
}

.status-indicator.status-in-call {
background: rgba(76, 175, 80, .15);
color: var(--success-color);
border: 1px solid rgba(76, 175, 80, .3);
}

.status-indicator.status-completed {
background: rgba(76, 175, 80, .15);
color: var(--success-color);
border: 1px solid rgba(76, 175, 80, .3);
}

.status-indicator.status-ended {
background: rgba(160, 174, 192, .15);
color: #a0aec0;
border: 1px solid rgba(160, 174, 192, .3);
}

.status-indicator.status-summary {
background: rgba(78, 140, 255, .15);
color: var(--primary-color);
border: 1px solid rgba(78, 140, 255, .3);
}

#timer-container {
position: fixed;
top: 150px; /* Adjusted for sticky header */
left: 50%;
transform: translateX(-50%);
z-index: 999;
}

#callTimer {
font-size: 1.4em;
font-weight: 700;
color: var(--primary-color);
background: rgba(28, 28, 40, .9);
backdrop-filter: blur(10px);
padding: .75rem 1.5rem;
border-radius: 12px;
display: inline-block;
min-width: 100px;
text-align: center;
border: 2px solid var(--primary-color);
box-shadow: 0 8px 25px rgba(0, 0, 0, .4);
font-family: 'Roboto Mono', monospace;
}

.steps-area {
background: var(--input-background-color);
border: 2px solid var(--border-color);
border-radius: var(--border-radius);
padding: 2.5rem;
margin: 2rem 0;
min-height: 200px;
text-align: left;
font-size: 1.3rem;
line-height: 1.8;
color: var(--text-color);
box-shadow: inset 0 2px 10px rgba(0, 0, 0, .1);
}

.steps-area p {
margin: 0;
font-weight: 500;
}

.steps-area .placeholder-text {
color: var(--text-color-secondary);
font-style: italic;
text-align: center;
font-size: 1.2rem;
}

.fade-in {
animation: fadeInAnimation .4s ease-in-out forwards
}

@keyframes fadeInAnimation {
from {
opacity: 0;
transform: translateY(20px)
}
to {
opacity: 1;
transform: translateY(0)
}
}

.app-footer {
text-align: center;
padding: 2rem;
font-size: .9rem;
color: var(--text-color-secondary);
background: transparent;
margin-top: auto;
width: 100%;
box-sizing: border-box;
border-top: 1px solid var(--border-color);
}

#callSummaryContent p {
font-size: 1.3rem;
line-height: 1.7;
margin-bottom: 1.5rem;
}

#callSummaryContent strong {
color: var(--primary-color);
font-weight: 700;
}

#callSummaryContent .quality-text.quality-good {
color: var(--success-color);
font-weight: 700;
}

#callSummaryContent .quality-text.quality-bad {
color: var(--danger-color);
font-weight: 700;
}

#callSummaryContent .quality-text.quality-na {
color: var(--text-color-secondary);
font-style: italic;
}

#callSummaryContent ul {
list-style: none;
padding-left: 0;
display: grid;
grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
gap: 1rem;
max-height: none; /* Removed max-height to prevent internal scrollbar */
}

#callSummaryContent li {
margin-bottom: 0;
padding: 1rem;
background: var(--input-background-color);
border-radius: 8px;
}

.initial-card-left {
text-align: left;
}

.initial-card-left .card-icon {
margin-bottom: 2rem;
}

.initial-card-left .card-icon svg {
width: 64px;
height: 64px;
}

.scenario-selector-container {
margin: 2rem 0;
}

.search-scenario-input {
width: 100%;
padding: 1rem 1.25rem;
background: var(--input-background-color);
border: 2px solid var(--border-color);
border-radius: 12px;
color: var(--text-color);
font-size: 1rem;
margin-bottom: 1.5rem;
box-sizing: border-box;
transition: all .3s ease;
}

.search-scenario-input:focus {
outline: 0;
border-color: var(--primary-color);
box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), .2);
}

.search-scenario-input::placeholder {
color: var(--text-color-secondary);
}

.custom-scenario-list {
display: flex;
flex-direction: column;
gap: 1rem;
max-height: 350px;
overflow-y: auto;
padding-right: .75rem;
margin-bottom: 2rem;
-ms-overflow-style: none;
scrollbar-width: none;
}

.custom-scenario-list::-webkit-scrollbar {
display: none;
}

.scenario-item {
padding: 1.25rem 1.5rem;
border-radius: 12px;
cursor: pointer;
transition: all .3s ease;
display: flex;
align-items: center;
gap: 1rem;
font-weight: 600;
border: 2px solid var(--secondary-color);
background: var(--secondary-color);
position: relative;
font-size: 1.1rem;
}

.scenario-item:hover {
background: rgba(var(--primary-color-rgb), .1);
border-color: var(--primary-color);
transform: translateX(8px);
}

.scenario-item.selected:focus,
.scenario-item:focus {
outline: 0;
border-color: var(--primary-color-dark);
box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), .3);
}

.scenario-item.selected {
background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark));
color: #fff;
font-weight: 700;
border-color: var(--primary-color-dark);
transform: translateX(8px);
}

.scenario-item .icon {
font-size: 1.4em;
}

#scenario-preview-tooltip {
position: absolute;
background: var(--card-background-color);
border: 2px solid var(--primary-color);
border-radius: 12px;
padding: 1rem 1.25rem;
box-shadow: 0 8px 25px rgba(0, 0, 0, .4);
z-index: 100;
width: 250px;
font-size: .9rem;
color: var(--text-color-secondary);
display: none;
pointer-events: none;
backdrop-filter: blur(10px);
}

#scenario-preview-tooltip strong {
color: var(--text-color);
display: block;
margin-bottom: .5rem;
font-size: 1rem;
}

.form-step-container {
margin-top: 2rem;
}

.form-field {
margin-bottom: 1.5rem;
}

.form-field label {
display: block;
margin-bottom: .75rem;
font-weight: 600;
color: var(--text-color-secondary);
font-size: 1.1rem;
}

.form-field input,
.form-field textarea {
width: 100%;
padding: 1rem 1.25rem;
background: var(--input-background-color);
border: 2px solid var(--border-color);
border-radius: 12px;
color: var(--text-color);
font-size: 1rem;
box-sizing: border-box;
transition: all .3s ease;
}

.form-field input:focus,
.form-field textarea:focus {
outline: 0;
border-color: var(--primary-color);
box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), .2);
}

.custom-toast {
position: fixed;
right: 2rem;
bottom: 2rem;
transform: translateY(100%);
background: rgba(var(--primary-color-rgb), .15);
backdrop-filter: blur(10px);
color: var(--text-color);
padding: 1.5rem 2.5rem;
border-radius: var(--border-radius);
border: 2px solid var(--primary-color);
box-shadow: 0 8px 30px rgba(0, 0, 0, .4);
z-index: 9999;
display: flex;
align-items: center;
gap: 1.25rem;
font-size: 1.2rem;
font-weight: 600;
opacity: 0;
visibility: hidden;
transition: all .4s ease;
}

.custom-toast.show {
opacity: 1;
visibility: visible;
transform: translateY(0);
}

.custom-toast.hide {
opacity: 0;
transform: translateY(100%);
}

.custom-toast .toast-icon {
font-size: 2rem;
}

.modal-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, .7);
display: flex;
justify-content: center;
align-items: center;
z-index: 10000;
opacity: 0;
visibility: hidden;
transition: opacity .3s ease, visibility .3s ease;
backdrop-filter: blur(5px);
}

.modal-overlay.show {
opacity: 1;
visibility: visible;
}

.modal-container {
background: var(--card-background-color);
padding: 2.5rem;
border-radius: var(--border-radius);
box-shadow: 0 10px 40px rgba(0, 0, 0, .5);
border: 1px solid var(--border-color);
width: 90%;
max-width: 450px;
text-align: center;
transform: scale(.9);
transition: transform .3s ease;
}

.modal-overlay.show .modal-container {
transform: scale(1);
}

.modal-title {
font-size: 1.6rem;
font-weight: 700;
margin-top: 0;
margin-bottom: 1rem;
color: var(--text-color);
display: flex;
align-items: center;
justify-content: center;
}

.modal-body {
font-size: 1.1rem;
color: var(--text-color-secondary);
margin-bottom: 2rem;
}

.modal-actions {
display: flex;
gap: 1rem;
justify-content: center;
}
@media (max-width: 1200px) {
.initial-card {
grid-template-columns: 1fr;
gap: 3rem;
padding: 2.5rem
}
.card {
padding: 2.5rem
}
}

@media (max-width: 992px) {
.app-header {
flex-wrap: wrap;
}
.main-nav {
display: none;
flex-direction: column;
width: 100%;
background: var(--card-background-color);
position: absolute;
top: 100%;
left: 0;
padding: 1rem;
border-bottom: 1px solid var(--border-color);
box-shadow: 0 10px 20px rgba(0,0,0,.2);
}
.main-nav.active {
display: flex;
}
.nav-link {
text-align: center;
padding: 1rem;
}
.menu-toggle {
display: block;
order: -1; /* Place it before other items in flex container */
}
.header-controls {
width: auto;
gap: 1rem;
}
.logo-container {
flex-grow: 1;
justify-content: center;
}
.user-info {
padding-left: 0;
border-left: none;
}
}

@media (max-width: 768px) {
.app-main {
padding: 1.5rem
}
.app-header {
padding: 1rem 1.5rem;
flex-wrap: wrap;
gap: 1rem;
}
.header-controls {
width: auto;
justify-content: space-between;
}
.card {
padding: 2rem 1.5rem
}
.initial-card {
padding: 2rem 1.5rem
}
.steps-area {
padding: 2rem 1.5rem;
font-size: 1.2rem
}
.decision-button {
padding: 1rem 1.5rem;
font-size: 1rem
}
.navigation-buttons {
flex-direction: column
}
.action-button,
.nav-button {
width: 100%
}
}

@media (max-width: 480px) {
.app-main {
padding: 1rem
}
.card {
padding: 1.5rem 1rem
}
.card-title {
font-size: 1.6rem
}
.steps-area {
padding: 1.5rem 1rem;
font-size: 1.1rem
}
.scenario-item {
padding: 1rem 1.25rem;
font-size: 1rem
}
}

.loading-skeleton {
background: linear-gradient(90deg, var(--input-background-color) 25%, var(--border-color) 50%, var(--input-background-color) 75%);
background-size: 200% 100%;
animation: loading 1.5s infinite;
border-radius: 8px;
height: 1.5rem;
margin: .75rem 0;
}

@keyframes loading {
0% {
background-position: 200% 0
}
100% {
background-position: -200% 0
}
}
</style>

</head>
<body>
<div class="app-container">
    <header class="app-header">
        <div class="logo-container">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color:#4e8cff;width:32px;height:32px">
                <path d="M6 17L10 17M6 12L12 12M6 7L14 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                <path d="M15 6L19 10L15 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                <rect x="3" y="3" width="18" height="18" rx="3" stroke="currentColor" stroke-width="1.5" fill="transparent" opacity="0.6"></rect>
            </svg>
            <span class="app-title">Elevo Core</span>
        </div>

        <button class="menu-toggle" id="menu-toggle-btn" aria-label="Toggle menu">
                <div class="hamburger-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </button>

    <div class="header-controls" id="header-controls">
        <nav class="main-nav" id="main-nav">
            <a href="./dashboard.html" class="nav-link" style="display: none;">Admin Dashboard</a>
            <a href="./rtm-dashboard.html" class="nav-link" style="display: none;">RTM Dashboard</a>
            <a href="./agent-portal.html" class="nav-link">Agent Portal</a>
            <a href="./core-flow.html" class="nav-link active">Core Flow Assistant</a>
        </nav>
        <div class="user-info">
            <span id="userName" style="color:#d1d5db;font-weight:500;min-height:1.2em;display:inline-block"></span>
            <button id="logoutButton" class="logout-btn">Logout</button>
        </div>
    </div>
</header>
<div class=status-bar>
<div id=systemStatus class="status-indicator status-waiting">
<svg xmlns=http://www.w3.org/2000/svg width=16 height=16 viewBox="0 0 24 24" fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round>
<circle cx=12 cy=12 r=10></circle>
</svg>
Waiting for Ticket
</div>
</div>
<div id=timer-container>
<div id=callTimer style=display:none>00:00</div>
</div>
<main class=app-main>
<div id=auth-loading class=loading-container style=display:none;flex-direction:column;align-items:center;justify-content:center;height:60vh>
<div class=spinner style=width:50px;height:50px;border-top-color:var(--primary-color)></div>
<p style=color:var(--text-color-secondary);margin-top:1.5rem;font-size:1.1rem>Initializing Assistant...</p>
</div>
<div id=initial-view class="card initial-card fade-in" style=display:none>
<div class=initial-card-left>
<div class=card-icon>
<svg xmlns=http://www.w3.org/2000/svg viewBox="0 0 24 24" fill=var(--primary-color) width=72 height=72>
<path d="M12 2C6.486 2 2 6.486 2 12C2 17.514 6.486 22 12 22C17.514 22 22 17.514 22 12C22 6.486 17.514 2 12 2ZM12 20C7.589 20 4 16.411 4 12C4 7.589 7.589 4 12 4C16.411 4 20 7.589 20 12C20 16.411 16.411 20 12 20Z"/>
<path d="M12 11C10.897 11 10 10.103 10 9C10 7.897 10.897 7 12 7C13.103 7 14 7.897 14 9C14 10.103 13.103 11 12 11Z"/>
<path d="M16.002 16.246C15.483 15.219 14.544 14.5 13.333 14.5H10.667C9.456 14.5 8.517 15.219 7.998 16.246C7.933 16.386 7.996 16.553 8.114 16.641C8.657 17.053 9.737 17.5 12 17.5C14.263 17.5 15.343 17.053 15.886 16.641C16.004 16.553 16.067 16.386 16.002 16.246Z"/>
</svg>
</div>
<h2 class=card-title>Core Flow Assistant</h2>
<p class=card-subtitle>Your dedicated assistant for streamlined ticket resolution. Select a scenario below to begin handling customer interactions with guided step-by-step support.</p>
</div>
<div class=initial-card-right>
<div class=scenario-selector-container>
<label for=searchScenarioInput style=display:block;margin-bottom:.75rem;font-weight:600;color:var(--text-color-secondary);font-size:1.1rem>Select Scenario:</label>
<input type=search id=searchScenarioInput class=search-scenario-input placeholder="Search scenarios...">
<div id=customScenarioList class=custom-scenario-list role=listbox>
<div class=scenario-item style=justify-content:center>
<div class=loading-skeleton style=width:100%;height:1.5rem></div>
</div>
</div>
<input type=hidden id=scenarioDropdownValue name=scenarioId>
</div>
<div style=display:flex;justify-content:flex-start;margin-top:2rem>
<button id=receive-call-btn class="action-button primary-button" disabled style="padding:1.25rem 2.5rem;font-size:1.1rem">
<span class=btn-text>Start Ticket</span>
</button>
</div>
</div>
<audio id=callStartSound src=call_sound.mp3 preload=auto></audio>
<audio id=compensationScenarioSound src=compensation_alert.mp3 preload=auto></audio>
</div>
<div id=call-flow-view class="card call-flow-card fade-in" style=display:none>
<h3 id=scenario-title class="card-title scenario-title-dynamic">
<span id=step-type-icon class=step-type-icon></span>
<span id=scenario-title-text>Ticket Scenario</span>
</h3>
<div id=steps-container class=steps-area>
<p class=placeholder-text>Loading ticket steps...</p>
</div>
<div id=decision-buttons-container class=step-actions></div>
<div class=navigation-buttons>
<button id=prev-step-btn class="nav-button secondary-button" style=display:none>
<svg xmlns=http://www.w3.org/2000/svg width=20 height=20 viewBox="0 0 24 24" fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round style=margin-right:.5em>
<polyline points="15 18 9 12 15 6"></polyline>
</svg>
<span>Previous</span>
</button>
<button id=next-step-btn class="nav-button primary-button">
<span class=btn-text>Next Step</span>
<svg xmlns=http://www.w3.org/2000/svg width=20 height=20 viewBox="0 0 24 24" fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round style=margin-left:.5em>
<polyline points="9 18 15 12 9 6"></polyline>
</svg>
</button>
</div>
<div style=display:flex;justify-content:center;margin-top:2rem>
<button id=end-call-btn class="nav-button danger-button" style="display:none;padding:1rem 2rem">
<svg xmlns=http://www.w3.org/2000/svg width=18 height=18 viewBox="0 0 24 24" fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round style=margin-right:.5em>
<path d="M6 18L18 6M6 6l12 12"/>
</svg>
<span>End Ticket</span>
</button>
</div>
</div>
<div id=postCallSummary class="card post-call-summary-card fade-in" style=display:none>
<h3 class=card-title>Ticket Summary</h3>
<div id=callSummaryContent></div>
<div style=display:flex;justify-content:center;margin-top:2.5rem>
<button id=returnToInitialViewBtn class="action-button primary-button" style="padding:1.25rem 2.5rem;font-size:1.1rem">
<svg xmlns=http://www.w3.org/2000/svg width=20 height=20 viewBox="0 0 24 24" fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round style=margin-right:.5em>
<path d="M3 12h18M3 6h12M3 18h15"/>
</svg>
<span>New Ticket</span>
</button>
</div>
</div>
<div id=scenario-preview-tooltip></div>
</main>
<div id=custom-toast-notification class=custom-toast>
<span class=toast-icon>‚ö†Ô∏è</span>
<span id=toast-message class=toast-message></span>
</div>

<div id="custom-confirm-modal" class="modal-overlay">
    <div class="modal-container">
        <h3 class="modal-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 0.5em; color: var(--warning-color);">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            Confirm End Ticket
        </h3>
        <p class="modal-body">Are you sure you want to end this ticket?</p>
        <div class="modal-actions">
            <button id="modal-cancel-btn" class="nav-button secondary-button">Cancel</button>
            <button id="modal-confirm-btn" class="nav-button danger-button">Confirm End</button>
        </div>
    </div>
</div>

<footer class=app-footer>
<p>¬© <span id=currentYear></span> Mohamed Elmenisy - Elevo Core. All rights reserved.</p>
</footer>
</div>

<script type="module">
    import { supabase } from './supabaseClient.js';
    import { protectPage } from './role-check.js';

    document.addEventListener('DOMContentLoaded', async () => {
        // Protect page for all authenticated users and set up header
        await protectPage([]);

        // The rest of the page initialization logic that was previously in initializeApp
        const authLoadingDiv = document.getElementById("auth-loading");
        
        // This check is now implicitly handled by protectPage, but we keep it for safety
        const { data: { user } } = await supabase.auth.getUser();
        
        if (user) {
            initializeAppLogic(user);
            authLoadingDiv.style.display = "none";
        } else {
            // This case should be handled by protectPage redirecting to login
            authLoadingDiv.innerHTML = '<p style="color:var(--danger-color); text-align:center; font-size: 1.2rem;">Authentication failed. Redirecting...</p>';
        }
    });

    const initialViewDiv=document.getElementById("initial-view"),callFlowViewDiv=document.getElementById("call-flow-view"),postCallSummaryDiv=document.getElementById("postCallSummary"),receiveCallBtn=document.getElementById("receive-call-btn"),scenarioTitleElement=document.getElementById("scenario-title-text"),stepTypeIconElement=document.getElementById("step-type-icon"),stepsContainer=document.getElementById("steps-container"),decisionButtonsContainer=document.getElementById("decision-buttons-container"),prevStepBtn=document.getElementById("prev-step-btn"),nextStepBtn=document.getElementById("next-step-btn"),endCallBtn=document.getElementById("end-call-btn"),logoutButton=document.getElementById("logoutButton"),systemStatusDiv=document.getElementById("systemStatus"),callTimerDiv=document.getElementById("callTimer"),callSummaryContentDiv=document.getElementById("callSummaryContent"),returnToInitialViewBtn=document.getElementById("returnToInitialViewBtn"),callStartSound=document.getElementById("callStartSound"),compensationScenarioSound=document.getElementById("compensationScenarioSound"),searchScenarioInput=document.getElementById("searchScenarioInput"),scenarioPreviewTooltip=document.getElementById("scenario-preview-tooltip");
    
    document.getElementById("currentYear").textContent = new Date().getFullYear();
    
    let currentUser=null,currentScenario=null,currentStepId=null,stepHistory=[],callSessionId=null,callStartTimeISO=null,stepTimerInterval=null,stepStartTime=0,accumulatedStepDurations={},stepVisitCount={};
    const SESSION_STATE_KEY="elevoCoreActiveCallState_v4";
    
    function setButtonLoadingState(e,t,n="Submit"){const i=e.querySelector(".btn-text");if(e.disabled=t,t)i&&(i.textContent="Loading..."),e.insertAdjacentHTML("afterbegin",'<span class="btn-spinner"></span>');else{i&&(i.textContent=n);const t=e.querySelector(".btn-spinner");t&&t.remove()}}
    function updateSystemStatus(e,t="status-waiting"){if(systemStatusDiv){systemStatusDiv.textContent=e,systemStatusDiv.className=`status-indicator ${t}`;let n="";switch(t){case"status-waiting":n="üî¥";break;case"status-loading":n="üü°";break;case"status-in-call":n="üü¢";break;case"status-completed":n="‚úÖ";break;case"status-ended":n="‚ö™";break;case"status-summary":n="üìä"}systemStatusDiv.innerHTML=`${n} ${e}`}}
    function animateView(e){e&&(e.classList.remove("fade-in"),e.offsetWidth,e.classList.add("fade-in"),e.style.display=e.classList.contains("initial-card")?"grid":"block")}
    let toastTimeout;
    function showCustomToast(e){const t=document.getElementById("custom-toast-notification"),n=document.getElementById("toast-message");t&&n&&(clearTimeout(toastTimeout),n.textContent=e,t.classList.remove("hide"),t.classList.add("show"),toastTimeout=setTimeout((()=>{t.classList.remove("show"),t.classList.add("hide")}),4e3))}
    
    async function initializeAppLogic(user) {
        // user object is passed from the DOMContentLoaded listener
        const { data: profile } = await supabase.from('users').select('name').eq('id', user.id).single();
        currentUser = { id: user.id, email: user.email, name: profile?.name || user.email };
        
        if (restoreCallState()) {
            switchToCallFlowView(!1);
            renderStep();
            updateSystemStatus("In Ticket (Restored)", "status-in-call");
        } else {
            switchToInitialView();
            await loadActiveScenarios();
        }
        
        // ŸÜŸÜÿ¥ÿ∑ ÿßŸÑŸÄ real-time sync
        setupKnowledgeBaseSync();
    }

    // =============================================
    // REAL-TIME KNOWLEDGE BASE SYNC
    // =============================================

    function setupKnowledgeBaseSync() {
        console.log("üîÑ Setting up Knowledge Base real-time sync...");
        
        const subscription = supabase
            .channel('kb-realtime-sync')
            .on('postgres_changes', 
                { 
                    event: 'UPDATE', 
                    schema: 'public', 
                    table: 'cases' 
                }, 
                async (payload) => {
                    console.log('üì¢ KB Update received:', payload);
                    await handleKnowledgeBaseUpdate(payload);
                }
            )
            .subscribe((status) => {
                if (status === 'SUBSCRIBED') {
                    console.log('‚úÖ Connected to Knowledge Base real-time updates');
                }
            });

        return subscription;
    }

    async function handleKnowledgeBaseUpdate(payload) {
        const updatedCase = payload.new;
        
        // ŸÑŸà ŸÅŸäŸá ÿ≥ŸäŸÜÿßÿ±ŸäŸà ÿ¥ÿ∫ÿßŸÑ ÿ≠ÿßŸÑŸäÿßŸã Ÿàÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´Ÿá
        if (currentScenario && currentScenario.id === updatedCase.id) {
            console.log('üîÑ Current scenario updated - refreshing...');
            
            // ŸÜÿ∏Ÿáÿ± ÿ•ÿ¥ÿπÿßÿ± ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
            showCustomToast('üì¢ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ Ÿáÿ∞ÿß ÿßŸÑŸÉŸäÿ≥! ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ÿØŸäÿ´...');
            
            // ŸÜÿπÿ∑Ÿä ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸàŸÇÿ™ ŸäŸÇÿ±ÿ£ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            setTimeout(async () => {
                try {
                    // ŸÜÿ¨Ÿäÿ® ÿ£ÿ≠ÿØÿ´ ŸÜÿ≥ÿÆÿ© ŸÖŸÜ ÿßŸÑÿ≥ŸäŸÜÿßÿ±ŸäŸà
                    const { data: freshScenario, error } = await supabase
                        .from('call_scenarios')
                        .select('*')
                        .eq('id', currentScenario.id)
                        .single();
                        
                    if (error) throw error;
                    
                    if (freshScenario) {
                        // ŸÜÿ≠ŸÅÿ∏ ÿßŸÑÿÆÿ∑Ÿàÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ÿπÿ¥ÿßŸÜ ŸÖÿß Ÿäÿ∂Ÿäÿπÿ¥ ÿ™ŸÇÿØŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
                        const currentStepBeforeUpdate = currentStepId;
                        
                        // ŸÜÿ≠ÿØÿ´ ÿßŸÑÿ≥ŸäŸÜÿßÿ±ŸäŸà
                        currentScenario = freshScenario;
                        
                        // ŸÑŸà ÿßŸÑÿÆÿ∑Ÿàÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ŸÑÿ≥ÿ© ŸÖŸàÿ¨ŸàÿØÿ©ÿå ŸÜÿ±ÿ¨ÿπŸáÿß
                        if (currentStepId && currentScenario.steps.find(s => s.id === currentStepId)) {
                            renderStep();
                        } else {
                            // ŸÑŸà ÿßŸÑÿÆÿ∑Ÿàÿ© ÿßÿ™ŸÖÿ≥ÿ≠ÿ™ÿå ŸÜÿ±ÿ¨ÿπ ŸÑÿ®ÿØÿßŸäÿ© ÿßŸÑÿ≥ŸäŸÜÿßÿ±ŸäŸà
                            currentStepId = currentScenario.steps[0]?.id;
                            stepHistory = [];
                            renderStep();
                        }
                        
                        showCustomToast('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿ®ŸÜÿ¨ÿßÿ≠!');
                        
                        // ŸÜÿ≠ÿ∑ ÿ™ÿ£ÿ´Ÿäÿ± ÿ®ÿµÿ±Ÿä ÿÆŸÅŸäŸÅ ÿπÿ¥ÿßŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ Ÿäÿ≠ÿ≥ ÿ®ÿßŸÑÿ™ÿ∫ŸäŸäÿ±
                        document.getElementById('call-flow-view').classList.add('decision-made-animation');
                        setTimeout(() => {
                            document.getElementById('call-flow-view').classList.remove('decision-made-animation');
                        }, 1000);
                    }
                } catch (error) {
                    console.error('Error updating scenario:', error);
                    showCustomToast('‚ùå ÿ≠ÿµŸÑ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ');
                }
            }, 1500);
        }
    }

    function switchToInitialView(){callFlowViewDiv.style.display="none",postCallSummaryDiv.style.display="none",callTimerDiv.style.display="none",animateView(initialViewDiv),updateSystemStatus("Waiting for Ticket","status-waiting")}
    function switchToCallFlowView(e=!0){initialViewDiv.style.display="none",postCallSummaryDiv.style.display="none",e?animateView(callFlowViewDiv):callFlowViewDiv.style.display="block",updateSystemStatus("In Ticket","status-in-call")}
    function switchToSummaryView(){initialViewDiv.style.display="none",callFlowViewDiv.style.display="none",callTimerDiv.style.display="none",animateView(postCallSummaryDiv),updateSystemStatus("Review Ticket Summary","status-summary")}
    
    async function loadActiveScenarios(){
        setButtonLoadingState(receiveCallBtn, true, "Start Ticket");
        const e = document.getElementById("customScenarioList"), t = document.getElementById("scenarioDropdownValue");
        e.innerHTML = `
            <div class="scenario-item" style="justify-content: center;"><div class="loading-skeleton" style="width: 100%; height: 1.5rem;"></div></div>
            <div class="scenario-item" style="justify-content: center;"><div class="loading-skeleton" style="width: 80%; height: 1.5rem;"></div></div>
            <div class="scenario-item" style="justify-content: center;"><div class="loading-skeleton" style="width: 90%; height: 1.5rem;"></div></div>`;
        t.value = "";
        try {
            const { data: n, error: i } = await supabase.from("call_scenarios").select("id, title, steps, description").eq("is_active", true).order("created_at", { ascending: false });
            if (i) throw i;
            e.innerHTML = "";
            if (n && n.length > 0) {
                n.forEach((n => {
                    const i = document.createElement("div");
                    i.className = "scenario-item", i.dataset.value = n.id, i.setAttribute("role", "option"), i.setAttribute("tabindex", "0"), i.setAttribute("aria-label", n.title), i.dataset.stepCount = n.steps?.length || 0, i.dataset.description = n.description || "No description available", i.dataset.avgTime = "2-3 min";
                    let a = "üìù";
                    const s = n.title.toLowerCase();
                    s.includes("compensation") ? a = "‚≠ê" : s.includes("inquiry") ? a = "‚ùì" : s.includes("complaint") ? a = "üò†" : s.includes("technical") ? a = "üîß" : s.includes("billing") && (a = "üí∞");
                    i.innerHTML = `<span class="icon">${a}</span><div style="flex: 1;"><div style="font-weight: 600; margin-bottom: 0.25rem;">${n.title}</div><div style="font-size: 0.9rem; color: var(--text-color-secondary);">${n.steps?.length || 0} steps ‚Ä¢ ${i.dataset.avgTime}</div></div>`;
                    const o = () => { const a = e.querySelector(".selected"); a && a.classList.remove("selected"), i.classList.add("selected"), t.value = n.id, receiveCallBtn.disabled = !1 };
                    i.addEventListener("click", o), i.addEventListener("keydown", (e => { "Enter" !== e.key && " " !== e.key || (e.preventDefault(), o()) })), i.addEventListener("mousemove", (e => { scenarioPreviewTooltip.style.display = "block", scenarioPreviewTooltip.innerHTML = `<strong>${n.title}</strong><div style="margin-top: 0.5rem;">${i.dataset.description}</div><div style="margin-top: 0.5rem; font-size: 0.8rem;"><span>Steps: ${i.dataset.stepCount}</span> ‚Ä¢ <span>Avg. Time: ${i.dataset.avgTime}</span></div>`, scenarioPreviewTooltip.style.left = `${e.pageX + 15}px`, scenarioPreviewTooltip.style.top = `${e.pageY + 15}px` })), i.addEventListener("mouseleave", (() => { scenarioPreviewTooltip.style.display = "none" })), e.appendChild(i)
                }));
                receiveCallBtn.disabled = true;
            } else {
                e.innerHTML = `<div class="scenario-item" role="option" style="justify-content: center; text-align: center; color: var(--text-color-secondary);"><div><div style="font-size: 2rem; margin-bottom: 0.5rem;">üì≠</div><div>No scenarios available</div></div></div>`;
                receiveCallBtn.disabled = true;
            }
        } catch (t) {
            console.error("Error loading scenarios:", t);
            e.innerHTML = `<div class="scenario-item" role="option" style="justify-content: center; text-align: center; color: var(--danger-color);"><div><div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ö†Ô∏è</div><div>Failed to load scenarios</div></div></div>`;
            receiveCallBtn.disabled = true;
        } finally {
            setButtonLoadingState(receiveCallBtn, false, "Start Ticket");
            if (document.getElementById("scenarioDropdownValue").value) {
                receiveCallBtn.disabled = false;
            }
        }
    }

    function renderStep(){if(!currentScenario||!currentStepId)return;const e=currentScenario.steps.find((e=>e?.id===currentStepId));if(!e)return void finishCall(!1,`Error: Step ${currentStepId} not found`);let t="üó£Ô∏è";"decision"===e.type&&(t="ü§î"),"form"===e.type&&(t="üìù"),stepTypeIconElement.textContent=t,scenarioTitleElement.textContent=currentScenario.title,stepsContainer.innerHTML="";const n=document.createElement("p");if(n.innerHTML=e.text.replace(/\n/g,"<br>"),n.style.fontSize="1.3rem",n.style.lineHeight="1.8",stepsContainer.appendChild(n),decisionButtonsContainer.innerHTML="",prevStepBtn.style.display=stepHistory.length>0?"inline-flex":"none",endCallBtn.style.display="inline-flex",nextStepBtn.style.display="none","decision"===e.type&&Array.isArray(e.options))e.options.forEach((e=>{const t=document.createElement("button");t.className="decision-button",t.textContent=e.label,t.addEventListener("click",(()=>navigateToStep(e.next_id))),decisionButtonsContainer.appendChild(t)}));else if("form"===e.type&&Array.isArray(e.fields)){const t=document.createElement("div");t.className="form-step-container",t.id="current-step-form",e.fields.forEach((e=>{const n=document.createElement("div");n.className="form-field";const i=document.createElement("label");i.setAttribute("for",`field-${e.id}`),i.textContent=e.label,n.appendChild(i);const a=document.createElement("textarea"===e.type?"textarea":"input");a.id=`field-${e.id}`,a.name=e.id,a.type=e.type||"text",e.required&&(a.required=!0),e.placeholder&&(a.placeholder=e.placeholder),a.rows="textarea"===e.type?4:void 0,n.appendChild(a),t.appendChild(n)})),stepsContainer.appendChild(t),nextStepBtn.style.display="inline-flex"}else{const t=nextStepBtn.querySelector(".btn-text");e.next_id?t&&(t.textContent="Next Step"):t&&(t.textContent="Finish Scenario"),nextStepBtn.style.display="inline-flex"}startStepTimer(),saveCallState()}
    function navigateToStep(e){if(stepVisitCount[e]=(stepVisitCount[e]||0)+1,stepVisitCount[e]>5)return void finishCall(!1,"Error: Potential infinite loop detected. Ticket terminated.");if(document.getElementById("call-flow-view").classList.add("decision-made-animation"),setTimeout((()=>document.getElementById("call-flow-view").classList.remove("decision-made-animation")),700),stopAndRecordStepTimer(),null==e||""===e)return void finishCall(!0,"Reached end of scenario path.");currentScenario.steps.find((t=>t?.id===e))?(currentStepId&&stepHistory.push(currentStepId),currentStepId=e,renderStep()):finishCall(!1,`Error: Path broken, step ${e} not found.`)}
    function startStepTimer(){callTimerDiv.style.display="inline-block",stepTimerInterval&&clearInterval(stepTimerInterval),0===stepStartTime&&(stepStartTime=Date.now());const e=()=>{const e=callStartTimeISO?Math.floor((Date.now()-new Date(callStartTimeISO).getTime())/1e3):0,t=String(Math.floor(e/60)).padStart(2,"0"),n=String(e%60).padStart(2,"0");callTimerDiv.textContent=`${t}:${n}`};e(),stepTimerInterval=setInterval(e,1e3)}
    function stopAndRecordStepTimer(){stepTimerInterval&&clearInterval(stepTimerInterval),stepTimerInterval=null,stepStartTime>0&&currentStepId&&accumulatedStepDurations.hasOwnProperty(currentStepId)&&(accumulatedStepDurations[currentStepId]+=Math.floor((Date.now()-stepStartTime)/1e3)),stepStartTime=0}
    async function finishCall(e,t){stopAndRecordStepTimer();const n=(new Date).toISOString(),i=callStartTimeISO?Math.floor((new Date(n)-new Date(callStartTimeISO))/1e3):0,a=e?"Good":i>0?"Bad":"N/A",s=t||(e?"Scenario completed.":"Ticket ended prematurely.");updateSystemStatus(e?"Completed":"Ended",e?"status-completed":"status-ended"),callSessionId&&await supabase.from("call_sessions").update({end_time:n,duration:i,completed:e,call_quality:a,quality_reason:s}).eq("id",callSessionId),displayPostCallSummary(a,s,i),clearCallState()}
    function displayPostCallSummary(e,t,n){let i=`\n                <p><strong>Ticket Quality:</strong> <span class="quality-text quality-${e?.toLowerCase()||"na"}">${e||"N/A"}</span></p>\n                <p><strong>Reason:</strong> ${t||"N/A"}</p>\n                <p><strong>Total Handle Time:</strong> ${Math.floor(n/60)}m ${n%60}s</p>\n                <hr style="margin: 2rem 0; border-color: var(--border-color);">\n                <p><strong>Time Spent on Steps:</strong></p>\n                <ul>\n            `;if(currentScenario?.steps){[...new Set([...stepHistory,currentStepId])].filter((e=>null!=e)).forEach((e=>{const t=currentScenario.steps.find((t=>t?.id===e)),n=accumulatedStepDurations[e]||0;t&&n>0&&(i+=`<li>\n                            "${t.text.substring(0,60)}..."<br>\n                            <strong style="color: var(--primary-color);">${n}s</strong>\n                        </li>`)}))}else i+='<li style="color: var(--text-color-secondary); font-style: italic;">No step data available.</li>';i+="</ul>",callSummaryContentDiv.innerHTML=i,switchToSummaryView()}
    function saveCallState(){if(!callSessionId)return;const e={callSessionId:callSessionId,currentScenario:currentScenario,currentStepId:currentStepId,stepHistory:stepHistory,accumulatedStepDurations:accumulatedStepDurations,stepStartTime:stepStartTime,callStartTimeISO:callStartTimeISO,stepVisitCount:stepVisitCount};sessionStorage.setItem(SESSION_STATE_KEY,JSON.stringify(e))}
    function restoreCallState(){const e=JSON.parse(sessionStorage.getItem(SESSION_STATE_KEY));return!(!e||!e.callSessionId)&&(callSessionId=e.callSessionId,currentScenario=e.currentScenario,currentStepId=e.currentStepId,stepHistory=e.stepHistory,accumulatedStepDurations=e.accumulatedStepDurations,stepStartTime=e.stepStartTime||Date.now(),callStartTimeISO=e.callStartTimeISO,stepVisitCount=e.stepVisitCount||{},!0)}
    function clearCallState(){sessionStorage.removeItem(SESSION_STATE_KEY)}
    function resetCallState(e=!1){stopAndRecordStepTimer(),clearCallState(),callSessionId=currentStepId=currentScenario=null,stepHistory=[],accumulatedStepDurations={},stepVisitCount={},stepStartTime=0,e&&switchToInitialView()}
    
    function setupRealtimeSubscriptions() {
        // ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä ŸÑŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ŸÖŸÜ Knowledge Base
        setupKnowledgeBaseSync();
        
        // ŸÜÿ≠ÿ™ŸÅÿ∏ ÿ®ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑŸÇÿØŸäŸÖ ÿπÿ¥ÿßŸÜ ÿßŸÑÿ≠ÿßÿ¨ÿßÿ™ ÿßŸÑÿ™ÿßŸÜŸäÿ©
        supabase.channel('public:cases')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'cases' }, () => {
                // ÿØŸá ŸÑŸÑŸÄ Knowledge Base ŸÜŸÅÿ≥Ÿá - ŸÖÿ¥ Ÿáÿ™ÿ£ÿ´ÿ± ÿπŸÑŸâ Core Flow
                console.log('KB general update - ignoring for Core Flow');
            })
            .subscribe();
    }

    receiveCallBtn.addEventListener("click",(async()=>{const e=document.getElementById("scenarioDropdownValue").value;if(e){setButtonLoadingState(receiveCallBtn,!0,"Start Ticket"),callStartSound.play().catch((e=>console.warn("Audio play failed. Make sure call_sound.mp3 is in the correct folder.",e))),resetCallState(),switchToCallFlowView(),updateSystemStatus("Loading Scenario...","status-loading"),stepsContainer.innerHTML='<p class="placeholder-text">Loading scenario steps...</p>',decisionButtonsContainer.innerHTML="",scenarioTitleElement.textContent="Loading...";try{const{data:t,error:n}=await supabase.from("call_scenarios").select("id, title, steps").eq("id",e).single();if(n)throw n;if(!t||!Array.isArray(t.steps)||0===t.steps.length)throw new Error("Scenario data is invalid.");currentScenario=t,currentStepId=currentScenario.steps[0].id,accumulatedStepDurations={},currentScenario.steps.forEach((e=>{e?.id&&(accumulatedStepDurations[e.id]=0)})),callStartTimeISO=(new Date).toISOString();const{data:i,error:a}=await supabase.from("call_sessions").insert({user_id:currentUser.id,scenario_id:currentScenario.id,start_time:callStartTimeISO,agent_name:currentUser.name,agent_email:currentUser.email}).select("id").single();if(a)throw a;callSessionId=i.id;const s=document.querySelector(`.scenario-item[data-value="${e}"]`);s&&s.classList.contains("compensation")&&(compensationScenarioSound.play().catch((e=>console.warn("Compensation sound failed. Make sure compensation_alert.mp3 is in the correct folder.",e))),scenarioTitleElement.classList.add("highlight-scenario-title-animation"),setTimeout((()=>scenarioTitleElement.classList.remove("highlight-scenario-title-animation")),1200)),updateSystemStatus("In Ticket","status-in-call"),renderStep()}catch(e){console.error("Error starting ticket:",e),showCustomToast("Failed to start ticket. Please try again."),resetCallState(),switchToInitialView(),await loadActiveScenarios()}finally{setButtonLoadingState(receiveCallBtn,!1,"Start Ticket")}}else showCustomToast("Please select a scenario first.")})),nextStepBtn.addEventListener("click",(()=>{const e=currentScenario.steps.find((e=>e?.id===currentStepId));if(e){if("form"===e.type){const e=document.getElementById("current-step-form").querySelectorAll("input, textarea");let t={},n=!0;if(e.forEach((e=>{e.required&&!e.value&&(n=!1),t[e.name]=e.value})),!n)return void showCustomToast("Please fill all required fields.");console.log("Form Data Collected:",t)}e.next_id?navigateToStep(e.next_id):(stopAndRecordStepTimer(),finishCall(!0,"Scenario finished via button."))}})),prevStepBtn.addEventListener("click",(()=>{stopAndRecordStepTimer(),stepHistory.length>0&&(currentStepId=stepHistory.pop(),stepVisitCount[currentStepId]&&(stepVisitCount[currentStepId]=0),renderStep())}));
    const customConfirmModal=document.getElementById("custom-confirm-modal"),modalConfirmBtn=document.getElementById("modal-confirm-btn"),modalCancelBtn=document.getElementById("modal-cancel-btn");function showConfirmModal(){customConfirmModal.classList.add("show")}function hideConfirmModal(){customConfirmModal.classList.remove("show")}endCallBtn.addEventListener("click",showConfirmModal),modalCancelBtn.addEventListener("click",hideConfirmModal),modalConfirmBtn.addEventListener("click",(()=>{hideConfirmModal(),stopAndRecordStepTimer(),finishCall(!1,"Ticket ended by agent")})),returnToInitialViewBtn.addEventListener("click",(async()=>{resetCallState(!0),await loadActiveScenarios()})),logoutButton.addEventListener("click",(async()=>{resetCallState(),localStorage.removeItem("elevoCoreUserData"),supabase&&await supabase.auth.signOut(),window.location.replace("login.html")}));
    
    searchScenarioInput.addEventListener("input", (e => {
        const searchTerm = e.target.value.toLowerCase();
        const scenarioItems = document.querySelectorAll(".scenario-item");
        const listContainer = document.getElementById("customScenarioList");
        
        // Remove previous "not found" message
        const existingNotFound = listContainer.querySelector('.scenario-not-found');
        if (existingNotFound) {
            existingNotFound.remove();
        }

        let anyVisible = false;
        scenarioItems.forEach(item => {
            const isVisible = item.textContent.toLowerCase().includes(searchTerm);
            item.style.display = isVisible ? "flex" : "none";
            if (isVisible) {
                anyVisible = true;
            }
        });

        if (!anyVisible && searchTerm) {
            const notFoundEl = document.createElement("div");
            notFoundEl.className = "scenario-item scenario-not-found"; // Add a class for easy removal
            notFoundEl.innerHTML = `
                <div style="text-align: center; width: 100%; color: var(--text-color-secondary);">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">üîç</div>
                    <div>No scenarios found for "${searchTerm}"</div>
                </div>`;
            listContainer.appendChild(notFoundEl);
        }
    }));

    window.addEventListener("beforeunload",(()=>{callSessionId&&saveCallState()}));
</script>

<script>
    // This script is for client-side enhancements that are not module-based.
    document.addEventListener('DOMContentLoaded', function () {
      
      // Mobile Menu Toggle
      const menuToggleBtn = document.getElementById('menu-toggle-btn');
      const mainNav = document.getElementById('main-nav');
      if (menuToggleBtn && mainNav) {
          menuToggleBtn.addEventListener('click', () => {
              mainNav.classList.toggle('active');
          });
      }

      // Format durations in elements with class 'duration-seconds' or 'duration'
      try {
        const durEls = document.querySelectorAll('.duration-seconds, .duration');
        durEls.forEach(el => {
          const txt = el.textContent.trim();
          const sec = parseInt(txt,10);
          if (!isNaN(sec)) {
            const m = Math.floor(sec/60);
            const s = sec % 60;
            el.textContent = (m>0?m+'m ':'') + s + 's';
          }
        });
      } catch(e){console.warn('Could not format duration:', e);}

    });
</script>

</body>
</html>
