<!DOCTYPE html>
<html lang="en" class="dark" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elevo Core Assistant</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234e8cff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M3 12h18M3 6h12M3 18h15'/><path d='M17 9l4 3l-4 3'/></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --background-color: #1c1c28;
            --card-background-color: #2b2b3d;
            --text-color: #f0f0f0;
            --text-color-secondary: #a0a0b0;
            --primary-color: #4e8cff;
            --primary-color-rgb: 78, 140, 255;
            --primary-color-dark: #3d7eff;
            --secondary-color: #3a3a50;
            --border-color: #444444;
            --input-background-color: #242436;
            --input-border-color: #444444;
            --button-text-color: #ffffff;
            --success-color: #4CAF50;
            --danger-color: #F44336;
            --warning-color: #FFC107;
            --border-radius: 16px;
            --font-family-main: 'Poppins', 'Roboto', sans-serif;
        }

        html.dark {
            background-color: var(--background-color);
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: var(--font-family-main);
            margin: 0; 
            padding: 0; 
            line-height: 1.6;
            overflow-x: hidden;
        }

        .app-container {
            display: flex; 
            flex-direction: column; 
            min-height: 100vh;
            max-width: 100%;
            margin: 0;
            margin: 0 auto;
        }

        .app-main {
            padding: 2rem; 
            flex-grow: 1; 
            display: flex;
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start;
        }

        /* Enhanced Header */
        .app-header {
            background: linear-gradient(135deg, var(--card-background-color), #242436); 
            color: var(--text-color);
            padding: 1.25rem 2rem; 
            display: flex; 
            justify-content: space-between;
            align-items: center; 
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0,0,0,0.25); 
            width: 100%;
            box-sizing: border-box;
            backdrop-filter: blur(10px);
        }

        .logo-container {
            display: flex; 
            align-items: center; 
            gap: 1rem;
        }

        .app-title { 
            font-weight: 700; 
            color: var(--primary-color);
            font-size: 1.4rem;
            background: linear-gradient(135deg, var(--primary-color), #6ea8ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-controls { 
            display: flex; 
            align-items: center; 
            gap: 1.5rem; 
        }

        .nav-link { 
            color: var(--text-color-secondary); 
            text-decoration: none; 
            transition: all 0.3s ease; 
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid transparent;
        }

        .nav-link:hover { 
            color: var(--primary-color); 
            background: rgba(var(--primary-color-rgb), 0.1);
            border-color: var(--primary-color);
        }

        .nav-link.active {
            color: var(--primary-color);
            background: rgba(var(--primary-color-rgb), 0.15);
            border-color: var(--primary-color);
        }

        .user-info { 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
        }
        
        .user-name-display { 
            color: var(--text-color-secondary);
            white-space: nowrap; 
            font-weight: 500;
        }
        
        .logout-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark));
            color: white;
            border: none;
            border-radius: 12px; 
            padding: 0.7rem 1.4rem;
            display: inline-flex; 
            align-items: center; 
            gap: 0.5em; 
            cursor: pointer;
            transition: all 0.3s ease-in-out; 
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(var(--primary-color-rgb), 0.3);
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(var(--primary-color-rgb), 0.4);
        }

        .logout-btn svg { 
            margin-right: 0.3em; 
        }

        /* Enhanced Cards */
        .card {
            background: linear-gradient(145deg, var(--card-background-color), #242436);
            padding: 3rem;
            border-radius: var(--border-radius);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
            width: 100%;
            max-width: 1200px;
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        }

        .initial-card {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 4rem;
            max-width: 1200px;
            padding: 3.5rem; 
            align-items: center;
            background: linear-gradient(135deg, var(--card-background-color), #1f2937);
        }

        .call-flow-card {
            background: linear-gradient(145deg, var(--card-background-color), #242436);
            position: relative; 
            border-radius: var(--border-radius);
            min-height: 500px;
        }

        @keyframes cardDecisionPulse {
            0% { box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 0 0px rgba(var(--primary-color-rgb), 0.5); }
            50% { box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 0 12px rgba(var(--primary-color-rgb), 0); }
            100% { box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 0 0px rgba(var(--primary-color-rgb), 0); }
        }

        .decision-made-animation { 
            animation: cardDecisionPulse 0.7s ease-out; 
        }

        .card-title {
            color: var(--text-color);
            font-size: 2rem;
            font-weight: 700; 
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--text-color), var(--primary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .scenario-title-dynamic {
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
        }

        .scenario-title-dynamic .step-type-icon {
            margin-right: 0.5em; 
            font-size: 1.3em; 
            display: inline-block; 
            transform: translateY(0.1em);
        }

        .card-subtitle { 
            color: var(--text-color-secondary); 
            font-size: 1.2rem; 
            margin-top: 0.5rem;
            line-height: 1.6;
        }

        /* Enhanced Buttons */
        .action-button, .nav-button, .decision-button {
            padding: 1rem 2rem; 
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            border: none;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.75em;
            width: auto;
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
        }

        .action-button:active, .nav-button:active, .decision-button:active { 
            transform: translateY(1px) scale(0.98); 
        }

        .primary-button {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark));
            color: white;
            box-shadow: 0 4px 15px rgba(var(--primary-color-rgb), 0.3);
        }

        .primary-button:hover {
            background: linear-gradient(135deg, var(--primary-color-dark), var(--primary-color));
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(var(--primary-color-rgb), 0.4);
        }

        .primary-button:disabled {
            background: var(--secondary-color); 
            cursor: not-allowed;
            transform: none; 
            box-shadow: none;
            opacity: 0.6;
        }

        .primary-button .btn-spinner {
            width: 1.2em; 
            height: 1.2em; 
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white; 
            border-radius: 50%;
            animation: spin 0.8s linear infinite; 
            margin-right: 0.5em;
        }

        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }

        .secondary-button {
            background: var(--secondary-color); 
            color: var(--button-text-color);
            border: 1px solid var(--border-color);
        }

        .secondary-button:hover {
            background: #4a4a60; 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0, 0.3);
        }
        
        .danger-button {
            background: transparent; 
            color: var(--danger-color);
            border: 2px solid var(--danger-color);
            font-weight: 600;
        }

        .danger-button:hover {
            background: var(--danger-color); 
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(244,67,54, 0.3);
        }

        .highlight-scenario-title-animation { 
            animation: pulse-title 0.6s 2 ease-in-out; 
        }

        @keyframes pulse-title {
            0%, 100% { transform: scale(1); opacity: 1; color: var(--warning-color); }
            50% { transform: scale(1.03); opacity: 0.8; color: var(--warning-color); }
        }

        /* Enhanced Step Actions */
        .step-actions {
            margin-top: 2.5rem; 
            display: flex; 
            flex-direction: column; 
            gap: 1rem;
            align-items: stretch; 
        }

        .decision-button {
            border: 2px solid var(--border-color); 
            background: var(--input-background-color);
            color: var(--text-color); 
            text-align: center;
            width: 100%;
            padding: 1.25rem 2rem;
            font-size: 1.1rem;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .decision-button:hover {
            border-color: var(--primary-color);
            background: rgba(var(--primary-color-rgb), 0.1);
            box-shadow: 0 4px 15px rgba(var(--primary-color-rgb), 0.2); 
            transform: translateY(-3px);
        }
        
        .decision-button:focus { 
            outline: none;
            border-color: var(--primary-color-dark);
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.3);
        }

        .decision-button.positive:hover { 
            background: var(--success-color); 
            border-color: var(--success-color); 
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4); 
        }

        .decision-button.negative:hover { 
            background: var(--danger-color); 
            border-color: var(--danger-color); 
            color: white;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4); 
        }

        .decision-button.neutral:hover { 
            background: var(--primary-color-dark); 
            border-color: var(--primary-color); 
            color: white;
            box-shadow: 0 4px 15px rgba(var(--primary-color-rgb), 0.4); 
        }
        
        .navigation-buttons {
            margin-top: 2.5rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        
        /* Enhanced Status Bar */
        .status-bar {
            background: linear-gradient(135deg, #242436, #1a1a2e); 
            color: var(--text-color); 
            padding: 1rem 2rem;
            font-size: 1rem; 
            border-bottom: 1px solid var(--border-color); 
            width: 100%;
            box-sizing: border-box; 
            text-align: center;
            font-weight: 600;
        }

        .status-indicator { 
            padding: 0.5rem 1rem;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-indicator.status-waiting { 
            background: rgba(244, 67, 54, 0.15); 
            color: var(--danger-color);
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .status-indicator.status-loading { 
            background: rgba(255, 193, 7, 0.15); 
            color: var(--warning-color);
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .status-indicator.status-in-call { 
            background: rgba(76, 175, 80, 0.15); 
            color: var(--success-color);
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .status-indicator.status-completed { 
            background: rgba(76, 175, 80, 0.15); 
            color: var(--success-color);
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .status-indicator.status-ended { 
            background: rgba(160, 174, 192, 0.15); 
            color: #a0aec0;
            border: 1px solid rgba(160, 174, 192, 0.3);
        }

        .status-indicator.status-summary { 
            background: rgba(78, 140, 255, 0.15); 
            color: var(--primary-color);
            border: 1px solid rgba(78, 140, 255, 0.3);
        }

        /* Enhanced Timer */
        #timer-container { 
            position: fixed; 
            top: 120px; 
            left: 50%; 
            transform: translateX(-50%); 
            z-index: 1000; 
        }

        #callTimer {
            font-size: 1.4em; 
            font-weight: 700; 
            color: var(--primary-color);
            background: rgba(28, 28, 40, 0.9);
            backdrop-filter: blur(10px);
            padding: 0.75rem 1.5rem;
            border-radius: 12px; 
            display: inline-block; 
            min-width: 100px;
            text-align: center; 
            border: 2px solid var(--primary-color);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            font-family: 'Roboto Mono', monospace;
        }

        /* Enhanced Steps Area */
        .steps-area {
            background: var(--input-background-color);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 2.5rem;
            margin: 2rem 0;
            min-height: 200px;
            text-align: left;
            font-size: 1.3rem;
            line-height: 1.8;
            color: var(--text-color);
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.1);
        }

        .steps-area p {
            margin: 0;
            font-weight: 500;
        }

        .steps-area .placeholder-text {
            color: var(--text-color-secondary);
            font-style: italic;
            text-align: center;
            font-size: 1.2rem;
        }

        .fade-in { 
            animation: fadeInAnimation 0.6s ease-in-out forwards; 
        }

        @keyframes fadeInAnimation {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        .app-footer {
            text-align: center; 
            padding: 2rem; 
            font-size: 0.9rem;
            color: var(--text-color-secondary); 
            background: transparent;
            margin-top: auto; 
            width: 100%; 
            box-sizing: border-box;
            border-top: 1px solid var(--border-color);
        }
        
        /* Enhanced Summary */
        #callSummaryContent p {
            font-size: 1.3rem;
            line-height: 1.7;
            margin-bottom: 1.5rem;
        }

        #callSummaryContent strong { 
            color: var(--primary-color); 
            font-weight: 700; 
        }

        #callSummaryContent .quality-text.quality-good { 
            color: var(--success-color); 
            font-weight: bold; 
        }

        #callSummaryContent .quality-text.quality-bad { 
            color: var(--danger-color); 
            font-weight: bold; 
        }

        #callSummaryContent .quality-text.quality-na { 
            color: var(--text-color-secondary); 
            font-style: italic; 
        }
        
        /* Enhanced Initial Card Layout */
        .initial-card-left { 
            text-align: left; 
        }

        .initial-card-left .card-icon {
            margin-bottom: 2rem;
        }

        .initial-card-left .card-icon svg {
            width: 64px;
            height: 64px;
        }
        
        /* Enhanced Scenario Selector */
        .scenario-selector-container {
            margin: 2rem 0;
        }

        .search-scenario-input {
            width: 100%;
            padding: 1rem 1.25rem;
            background: var(--input-background-color);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-color);
            font-size: 1rem;
            margin-bottom: 1.5rem;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        .search-scenario-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.2);
        }

        .search-scenario-input::placeholder {
            color: var(--text-color-secondary);
        }

        .custom-scenario-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-height: 350px;
            overflow-y: auto;
            padding-right: 0.75rem;
            margin-bottom: 2rem;
        }

        .scenario-item {
            padding: 1.25rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-weight: 600;
            border: 2px solid var(--secondary-color);
            background: var(--secondary-color);
            position: relative;
            font-size: 1.1rem;
        }

        .scenario-item:hover {
            background: rgba(var(--primary-color-rgb), 0.1);
            border-color: var(--primary-color);
            transform: translateX(8px);
        }
        
        .scenario-item:focus, .scenario-item.selected:focus {
             outline: none;
             border-color: var(--primary-color-dark);
             box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.3);
        }

        .scenario-item.selected {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark));
            color: white;
            font-weight: 700;
            border-color: var(--primary-color-dark);
            transform: translateX(8px);
        }

        .scenario-item .icon { 
            font-size: 1.4em; 
        }

        .scenario-item.compensation { 
            border-left: 4px solid var(--warning-color);
            background: rgba(255, 193, 7, 0.05);
        }

        .scenario-item.compensation.selected {
            background: linear-gradient(135deg, var(--warning-color), #ffb300);
        }

        #scenario-preview-tooltip {
            position: absolute;
            background: var(--card-background-color);
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            z-index: 100;
            width: 250px;
            font-size: 0.9rem;
            color: var(--text-color-secondary);
            display: none;
            pointer-events: none;
            backdrop-filter: blur(10px);
        }

        #scenario-preview-tooltip strong { 
            color: var(--text-color); 
            display: block;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        
        /* Enhanced Form Styles */
        .form-step-container { 
            margin-top: 2rem; 
        }

        .form-field { 
            margin-bottom: 1.5rem; 
        }

        .form-field label { 
            display: block; 
            margin-bottom: 0.75rem; 
            font-weight: 600; 
            color: var(--text-color-secondary); 
            font-size: 1.1rem;
        }

        .form-field input, .form-field textarea {
            width: 100%;
            padding: 1rem 1.25rem;
            background: var(--input-background-color);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-color);
            font-size: 1rem;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        .form-field input:focus, .form-field textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.2);
        }

        /* Enhanced Toast */
        .custom-toast {
            position: fixed;
            right: 2rem;
            bottom: 2rem;
            transform: translateY(100%);
            background: rgba(var(--primary-color-rgb), 0.15);
            backdrop-filter: blur(10px);
            color: var(--text-color);
            padding: 1.5rem 2.5rem;
            border-radius: var(--border-radius);
            border: 2px solid var(--primary-color);
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 1.25rem;
            font-size: 1.2rem;
            font-weight: 600;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s ease;
        }

        .custom-toast.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .custom-toast.hide {
             opacity: 0;
             transform: translateY(100%);
        }

        .custom-toast .toast-icon {
            font-size: 2rem;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .initial-card {
                grid-template-columns: 1fr;
                gap: 3rem;
                padding: 2.5rem;
            }
            
            .card {
                padding: 2.5rem;
            }
        }

        @media (max-width: 768px) {
            .app-main {
                padding: 1.5rem;
            }
            
            .app-header {
                padding: 1rem 1.5rem;
                flex-wrap: wrap;
                gap: 1rem;
            }
            
            .header-controls {
                width: 100%;
                justify-content: space-between;
            }
            
            .card {
                padding: 2rem 1.5rem;
            }
            
            .initial-card {
                padding: 2rem 1.5rem;
            }
            
            .steps-area {
                padding: 2rem 1.5rem;
                font-size: 1.2rem;
            }
            
            .decision-button {
                padding: 1rem 1.5rem;
                font-size: 1rem;
            }
            
            .navigation-buttons {
                flex-direction: column;
            }
            
            .action-button, .nav-button {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .app-main {
                padding: 1rem;
            }
            
            .card {
                padding: 1.5rem 1rem;
            }
            
            .card-title {
                font-size: 1.6rem;
            }
            
            .steps-area {
                padding: 1.5rem 1rem;
                font-size: 1.1rem;
            }
            
            .scenario-item {
                padding: 1rem 1.25rem;
                font-size: 1rem;
            }
        }

        /* Loading States */
        .loading-skeleton {
            background: linear-gradient(90deg, var(--input-background-color) 25%, var(--border-color) 50%, var(--input-background-color) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
            height: 1.5rem;
            margin: 0.75rem 0;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body>

    <div class="app-container">
        
<header class="app-header" style="width: 100%; background: #111827; border-bottom: 1px solid #1f2937; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem;">
  <div class="logo-container" style="display: flex; align-items: center; gap: 0.75rem;">
    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: #4e8cff; width: 32px; height: 32px;">
      <path d="M6 17L10 17M6 12L12 12M6 7L14 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M15 6L19 10L15 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <rect x="3" y="3" width="18" height="18" rx="3" stroke="currentColor" stroke-width="1.5" fill="transparent" opacity="0.6"/>
    </svg>
    <span class="app-title" style="font-weight: 700; font-size: 1.3rem; color: #4e8cff;">Elevo Core</span>
  </div>
  <div class="header-controls" style="display: flex; align-items: center; gap: 1.25rem;">
    <a href="dashboard.html" class="nav-link" style="color: #d1d5db; text-decoration: none; font-weight: 500; transition: 0.3s;">Dashboard</a>
    <div class="user-info" style="display: flex; align-items: center; gap: 0.75rem;">
      <span id="userName" style="color: #d1d5db; font-weight: 500;">User</span>
      <button id="logoutButton" class="logout-btn" style="background: linear-gradient(135deg, #4e8cff, #60a5fa); color: white; border: none; border-radius: 8px; padding: 0.6rem 1rem; font-weight: 600; cursor: pointer;">Logout</button>
    </div>
  </div>
</header>


        <div class="status-bar">
            <div id="systemStatus" class="status-indicator status-waiting">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                </svg>
                Waiting for Ticket
            </div>
        </div>

        <div id="timer-container">
             <div id="callTimer" style="display: none;">00:00</div>
        </div>

        <main class="app-main">
            <div id="auth-loading" class="loading-container" style="display: none; flex-direction: column; align-items: center; justify-content: center; height: 60vh;">
                <div class="spinner" style="width: 50px; height: 50px; border-top-color: var(--primary-color);"></div>
                <p style="color: var(--text-color-secondary); margin-top: 1.5rem; font-size: 1.1rem;">Initializing Assistant...</p>
            </div>

            <div id="initial-view" class="card initial-card fade-in" style="display: none;">
                <div class="initial-card-left">
                    <div class="card-icon">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="var(--primary-color)" width="72" height="72">
                             <path d="M12 2C6.486 2 2 6.486 2 12C2 17.514 6.486 22 12 22C17.514 22 22 17.514 22 12C22 6.486 17.514 2 12 2ZM12 20C7.589 20 4 16.411 4 12C4 7.589 7.589 4 12 4C16.411 4 20 7.589 20 12C20 16.411 16.411 20 12 20Z"/>
                             <path d="M12 11C10.897 11 10 10.103 10 9C10 7.897 10.897 7 12 7C13.103 7 14 7.897 14 9C14 10.103 13.103 11 12 11Z"/>
                             <path d="M16.002 16.246C15.483 15.219 14.544 14.5 13.333 14.5H10.667C9.456 14.5 8.517 15.219 7.998 16.246C7.933 16.386 7.996 16.553 8.114 16.641C8.657 17.053 9.737 17.5 12 17.5C14.263 17.5 15.343 17.053 15.886 16.641C16.004 16.553 16.067 16.386 16.002 16.246Z"/>
                         </svg>
                    </div>
                    <h2 class="card-title">Core Flow Assistant</h2>
                    <p class="card-subtitle">Your dedicated assistant for streamlined ticket resolution. Select a scenario below to begin handling customer interactions with guided step-by-step support.</p>
                </div>
                
                <div class="initial-card-right">
                    <div class="scenario-selector-container">
                        <label for="searchScenarioInput" style="display: block; margin-bottom: 0.75rem; font-weight: 600; color: var(--text-color-secondary); font-size: 1.1rem;">Select Scenario:</label>
                        <input type="search" id="searchScenarioInput" class="search-scenario-input" placeholder="Search scenarios...">
                        <div id="customScenarioList" class="custom-scenario-list" role="listbox">
                            <!-- Scenarios will be loaded here by JS -->
                            <div class="scenario-item" style="justify-content: center;">
                                <div class="loading-skeleton" style="width: 100%; height: 1.5rem;"></div>
                            </div>
                        </div>
                        <input type="hidden" id="scenarioDropdownValue" name="scenarioId">
                    </div>
                    <div style="display: flex; justify-content: flex-start; margin-top: 2rem;">
                        <button id="receive-call-btn" class="action-button primary-button" disabled style="padding: 1.25rem 2.5rem; font-size: 1.1rem;">
                            <span class="btn-text">Start Ticket</span>
                        </button>
                    </div>
                </div>

                <!-- Audio Elements -->
                <audio id="callStartSound" src="call_sound.mp3" preload="auto"></audio>
                <audio id="compensationScenarioSound" src="compensation_alert.mp3" preload="auto"></audio>
            </div>

            <div id="call-flow-view" class="card call-flow-card fade-in" style="display: none;">
                <h3 id="scenario-title" class="card-title scenario-title-dynamic">
                    <span id="step-type-icon" class="step-type-icon"></span>
                    <span id="scenario-title-text">Ticket Scenario</span>
                </h3>
                <div id="steps-container" class="steps-area">
                    <p class="placeholder-text">Loading ticket steps...</p>
                </div>
                <div id="decision-buttons-container" class="step-actions"></div>

                <div class="navigation-buttons">
                    <button id="prev-step-btn" class="nav-button secondary-button" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 0.5em;">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                        <span>Previous</span>
                    </button>
                    <button id="next-step-btn" class="nav-button primary-button">
                        <span class="btn-text">Next Step</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-left: 0.5em;">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </button>
                </div>
                 <div style="display: flex; justify-content: center; margin-top: 2rem;">
                    <button id="end-call-btn" class="nav-button danger-button" style="display: none; padding: 1rem 2rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 0.5em;">
                            <path d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        <span>End Ticket</span>
                    </button>
                 </div>
            </div>

            <div id="postCallSummary" class="card post-call-summary-card fade-in" style="display: none;">
                <h3 class="card-title">Ticket Summary</h3>
                <div id="callSummaryContent"></div>
                <div style="display: flex; justify-content: center; margin-top: 2.5rem;">
                    <button id="returnToInitialViewBtn" class="action-button primary-button" style="padding: 1.25rem 2.5rem; font-size: 1.1rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 0.5em;">
                            <path d="M3 12h18M3 6h12M3 18h15"/>
                        </svg>
                        <span>New Ticket</span>
                    </button>
                </div>
            </div>
            
            <div id="scenario-preview-tooltip"></div>
        </main>

        <div id="custom-toast-notification" class="custom-toast">
            <span class="toast-icon">⚠️</span>
            <span id="toast-message" class="toast-message"></span>
        </div>

        <footer class="app-footer">
            <p>© <span id="currentYear"></span> Mohamed Elmenisy - Elevo Core. All rights reserved.</p>
        </footer>
    </div>

    <!-- Access Denied Modal -->
    <div id="accessDeniedModal" class="access-denied-modal" aria-hidden="true" style="display: none;">
      <div class="access-denied-content" role="dialog" aria-labelledby="accessDeniedTitle" aria-describedby="accessDeniedDesc">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        <h3 id="accessDeniedTitle">Access Restricted</h3>
        <p id="accessDeniedDesc">You don't have permission to view this page. This section is available for <strong>Admins</strong> only.</p>
        <button id="returnToAppBtn" class="action-button primary-button">🔙 Back to My Dashboard</button>
      </div>
    </div>

    <script type="module">
        // --- Supabase Client Setup ---
        const SUPABASE_URL = 'https://aefiigottnlcmjzilqnh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlZmlpZ290dG5sY21qemlscW5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNzY2MDQsImV4cCI6MjA2Mjc1MjYwNH0.FypB02v3tGMnxXV9ZmZMdMC0oQpREKOJWgHMPxUzwX4';
        
        let supabase;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (error) {
            console.error("Supabase client initialization failed:", error);
            document.getElementById('auth-loading').innerHTML = '<p style="color:var(--danger-color); text-align:center; font-size: 1.2rem;">Error connecting to services. Core Flow is unavailable.</p>';
        }

        // --- DOM Elements ---
        const authLoadingDiv = document.getElementById('auth-loading');
        const initialViewDiv = document.getElementById('initial-view');
        const callFlowViewDiv = document.getElementById('call-flow-view');
        const postCallSummaryDiv = document.getElementById('postCallSummary');
        const receiveCallBtn = document.getElementById('receive-call-btn');
        const scenarioTitleElement = document.getElementById('scenario-title-text');
        const stepTypeIconElement = document.getElementById('step-type-icon'); 
        const stepsContainer = document.getElementById('steps-container'); 
        const decisionButtonsContainer = document.getElementById('decision-buttons-container'); 
        const prevStepBtn = document.getElementById('prev-step-btn');
        const nextStepBtn = document.getElementById('next-step-btn'); 
        const endCallBtn = document.getElementById('end-call-btn');
        const userInfoDiv = document.getElementById('userInfo');
        const userNameSpan = document.getElementById('userName');
        const logoutButton = document.getElementById('logoutButton');
        const dashboardLink = document.getElementById('dashboardLink');
        const systemStatusDiv = document.getElementById('systemStatus');
        const callTimerDiv = document.getElementById('callTimer');
        const callSummaryContentDiv = document.getElementById('callSummaryContent');
        const returnToInitialViewBtn = document.getElementById('returnToInitialViewBtn');
        const callStartSound = document.getElementById('callStartSound'); 
        const compensationScenarioSound = document.getElementById('compensationScenarioSound');
        const searchScenarioInput = document.getElementById('searchScenarioInput');
        const scenarioPreviewTooltip = document.getElementById('scenario-preview-tooltip');
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        // --- State Variables ---
        let currentUser = null; 
        let currentScenario = null; 
        let currentStepId = null;   
        let stepHistory = [];       
        let callSessionId = null;    
        let callStartTimeISO = null; 
        let stepTimerInterval = null;
        let stepStartTime = 0;      
        let accumulatedStepDurations = {}; 
        let stepVisitCount = {};
        const SESSION_STATE_KEY = 'elevoCoreActiveCallState_v4';

        // --- UI Helper Functions ---
        function setButtonLoadingState(button, isLoading, defaultText = "Submit") {
            const btnText = button.querySelector('.btn-text');
            button.disabled = isLoading;
            if (isLoading) {
                if(btnText) btnText.textContent = "Loading...";
                button.insertAdjacentHTML('afterbegin', '<span class="btn-spinner"></span>');
            } else {
                if(btnText) btnText.textContent = defaultText;
                const spinner = button.querySelector('.btn-spinner');
                if(spinner) spinner.remove();
            }
        }

        function updateSystemStatus(text, statusClass = 'status-waiting') {
            if (systemStatusDiv) {
                systemStatusDiv.textContent = text;
                systemStatusDiv.className = `status-indicator ${statusClass}`;
                
                // Update icon based on status
                let icon = '';
                switch(statusClass) {
                    case 'status-waiting': icon = '🔴'; break;
                    case 'status-loading': icon = '🟡'; break;
                    case 'status-in-call': icon = '🟢'; break;
                    case 'status-completed': icon = '✅'; break;
                    case 'status-ended': icon = '⚪'; break;
                    case 'status-summary': icon = '📊'; break;
                }
                systemStatusDiv.innerHTML = `${icon} ${text}`;
            }
        }

        function animateView(viewElement) {
            if (viewElement) {
                viewElement.classList.remove('fade-in');
                void viewElement.offsetWidth; 
                viewElement.classList.add('fade-in');
                viewElement.style.display = viewElement.classList.contains('initial-card') ? 'grid' : 'block';
            }
        }

        let toastTimeout;
        function showCustomToast(message) {
            const toastElement = document.getElementById('custom-toast-notification');
            const toastMessage = document.getElementById('toast-message');

            if (toastElement && toastMessage) {
                clearTimeout(toastTimeout);
                
                toastMessage.textContent = message;
                toastElement.classList.remove('hide');
                toastElement.classList.add('show');
                
                toastTimeout = setTimeout(() => {
                    toastElement.classList.remove('show');
                    toastElement.classList.add('hide');
                }, 4000);
            }
        }

        // --- Authentication & Initialization ---
        async function initializeApp() {
            if (!supabase) { 
                 authLoadingDiv.style.display = 'flex';
                 authLoadingDiv.innerHTML = '<p style="color:var(--danger-color); text-align:center; font-size: 1.2rem;">Critical Error: Services unavailable.</p>';
                 return;
            }
            
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.replace('login.html'); 
                return;
            }

            const storedUserData = JSON.parse(localStorage.getItem('elevoCoreUserData'));
            if (storedUserData && storedUserData.id === session.user.id) {
                currentUser = storedUserData;
            } else {
                let { data: profile, error } = await supabase.from('users').select('name, is_admin, role').eq('id', session.user.id).single();
                if (error && error.code !== 'PGRST116') { 
                    console.error("Error fetching user profile:", error);
                    await supabase.auth.signOut();
                    window.location.replace('login.html');
                    return;
                }
                
                if (!profile || (profile.role !== 'admin' && profile.role !== 'agent')) {
                    await supabase.auth.signOut();
                    window.location.replace('login.html');
                    return;
                }
                
                currentUser = { 
                    id: session.user.id, 
                    email: session.user.email, 
                    name: profile?.name || session.user.email.split('@')[0], 
                    isAdmin: profile?.role === 'admin', 
                    role: profile?.role || 'agent' 
                };
                localStorage.setItem('elevoCoreUserData', JSON.stringify(currentUser));
            }

            if (userNameSpan) userNameSpan.textContent = currentUser.name;
            if (userInfoDiv) userInfoDiv.style.display = 'flex';
            if (dashboardLink) dashboardLink.style.display = currentUser.isAdmin ? 'inline-block' : 'none';
            
            if (restoreCallState()) { 
                switchToCallFlowView(false); 
                renderStep(); 
                updateSystemStatus("In Ticket (Restored)", "status-in-call");
            } else {
                switchToInitialView();
                await loadActiveScenarios();
            }
            authLoadingDiv.style.display = 'none';
        }

        function switchToInitialView() {
            callFlowViewDiv.style.display = 'none';
            postCallSummaryDiv.style.display = 'none';
            callTimerDiv.style.display = 'none';
            animateView(initialViewDiv);
            updateSystemStatus("Waiting for Ticket", "status-waiting");
        }

        function switchToCallFlowView(animate = true) {
            initialViewDiv.style.display = 'none';
            postCallSummaryDiv.style.display = 'none';
            if (animate) animateView(callFlowViewDiv);
            else callFlowViewDiv.style.display = 'block';
            updateSystemStatus("In Ticket", "status-in-call");
        }

        function switchToSummaryView() {
            initialViewDiv.style.display = 'none';
            callFlowViewDiv.style.display = 'none';
            callTimerDiv.style.display = 'none';
            animateView(postCallSummaryDiv);
            updateSystemStatus("Review Ticket Summary", "status-summary");
        }
        
        async function loadActiveScenarios() {
            setButtonLoadingState(receiveCallBtn, true, "Start Ticket");
            const customList = document.getElementById('customScenarioList');
            const scenarioValueInput = document.getElementById('scenarioDropdownValue');
            
            // Show loading skeleton
            customList.innerHTML = `
                <div class="scenario-item" style="justify-content: center;">
                    <div class="loading-skeleton" style="width: 100%; height: 1.5rem;"></div>
                </div>
                <div class="scenario-item" style="justify-content: center;">
                    <div class="loading-skeleton" style="width: 80%; height: 1.5rem;"></div>
                </div>
                <div class="scenario-item" style="justify-content: center;">
                    <div class="loading-skeleton" style="width: 90%; height: 1.5rem;"></div>
                </div>
            `;
            
            scenarioValueInput.value = '';

            try {
                const { data: scenarios, error } = await supabase
                    .from('call_scenarios')
                    .select('id, title, steps, description')
                    .eq('is_active', true)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;

                customList.innerHTML = '';
                if (scenarios && scenarios.length > 0) {
                    scenarios.forEach(s => {
                        const item = document.createElement('div');
                        item.className = 'scenario-item';
                        item.dataset.value = s.id;
                        item.setAttribute('role', 'option');
                        item.setAttribute('tabindex', '0');
                        item.setAttribute('aria-label', s.title);
                        item.dataset.stepCount = s.steps?.length || 0;
                        item.dataset.description = s.description || 'No description available';
                        item.dataset.avgTime = "2-3 min";

                        let icon = '📝';
                        const titleLower = s.title.toLowerCase();
                        if (titleLower.includes('compensation')) { 
                            icon = '⭐'; 
                            item.classList.add('compensation'); 
                        } else if (titleLower.includes('inquiry')) { 
                            icon = '❓'; 
                        } else if (titleLower.includes('complaint')) { 
                            icon = '😠'; 
                        } else if (titleLower.includes('technical')) { 
                            icon = '🔧'; 
                        } else if (titleLower.includes('billing')) { 
                            icon = '💰'; 
                        }

                        item.innerHTML = `
                            <span class="icon">${icon}</span> 
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">${s.title}</div>
                                <div style="font-size: 0.9rem; color: var(--text-color-secondary);">
                                    ${s.steps?.length || 0} steps • ${item.dataset.avgTime}
                                </div>
                            </div>
                        `;
                        
                        const selectScenario = () => {
                            const currentlySelected = customList.querySelector('.selected');
                            if (currentlySelected) currentlySelected.classList.remove('selected');
                            item.classList.add('selected');
                            scenarioValueInput.value = s.id;
                            receiveCallBtn.disabled = false;
                        };

                        item.addEventListener('click', selectScenario);
                        item.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter' || e.key === ' ') {
                                e.preventDefault();
                                selectScenario();
                            }
                        });

                        item.addEventListener('mousemove', (e) => {
                            scenarioPreviewTooltip.style.display = 'block';
                            scenarioPreviewTooltip.innerHTML = `
                                <strong>${s.title}</strong>
                                <div style="margin-top: 0.5rem;">${item.dataset.description}</div>
                                <div style="margin-top: 0.5rem; font-size: 0.8rem;">
                                    <span>Steps: ${item.dataset.stepCount}</span> • 
                                    <span>Avg. Time: ${item.dataset.avgTime}</span>
                                </div>
                            `;
                            scenarioPreviewTooltip.style.left = `${e.pageX + 15}px`;
                            scenarioPreviewTooltip.style.top = `${e.pageY + 15}px`;
                        });
                        
                        item.addEventListener('mouseleave', () => {
                            scenarioPreviewTooltip.style.display = 'none';
                        });

                        customList.appendChild(item);
                    });
                    receiveCallBtn.disabled = true;
                } else {
                    customList.innerHTML = `
                        <div class="scenario-item" role="option" style="justify-content: center; text-align: center; color: var(--text-color-secondary);">
                            <div>
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">📭</div>
                                <div>No scenarios available</div>
                            </div>
                        </div>
                    `;
                    receiveCallBtn.disabled = true;
                }
            } catch (err) {
                console.error("Error loading scenarios:", err);
                customList.innerHTML = `
                    <div class="scenario-item" role="option" style="justify-content: center; text-align: center; color: var(--danger-color);">
                        <div>
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">⚠️</div>
                            <div>Failed to load scenarios</div>
                        </div>
                    </div>
                `;
                receiveCallBtn.disabled = true;
            } finally {
                setButtonLoadingState(receiveCallBtn, false, "Start Ticket");
            }
        }
        
        receiveCallBtn.addEventListener('click', async () => {
            const selectedScenarioId = document.getElementById('scenarioDropdownValue').value;
            if (!selectedScenarioId) {
                showCustomToast("Please select a scenario first.");
                return;
            }
            
            setButtonLoadingState(receiveCallBtn, true, "Start Ticket");
            
            // Play call start sound
            callStartSound.play().catch(e => console.warn("Audio play failed. Make sure call_sound.mp3 is in the correct folder.", e));

            resetCallState(); 
            switchToCallFlowView();
            updateSystemStatus("Loading Scenario...", "status-loading");
            
            stepsContainer.innerHTML = '<p class="placeholder-text">Loading scenario steps...</p>';
            decisionButtonsContainer.innerHTML = ''; 
            scenarioTitleElement.textContent = 'Loading...';

            try {
                const { data: scenarioData, error } = await supabase
                    .from('call_scenarios')
                    .select('id, title, steps')
                    .eq('id', selectedScenarioId)
                    .single();
                    
                if (error) throw error;
                if (!scenarioData || !Array.isArray(scenarioData.steps) || scenarioData.steps.length === 0) {
                    throw new Error("Scenario data is invalid.");
                }

                currentScenario = scenarioData; 
                currentStepId = currentScenario.steps[0].id; 
                accumulatedStepDurations = {}; 
                currentScenario.steps.forEach(step => { 
                    if(step?.id) accumulatedStepDurations[step.id] = 0; 
                });

                callStartTimeISO = new Date().toISOString(); 
                const { data: newSession, error: sessionError } = await supabase
                    .from('call_sessions')
                    .insert({ 
                        user_id: currentUser.id, 
                        scenario_id: currentScenario.id, 
                        start_time: callStartTimeISO, 
                        agent_name: currentUser.name, 
                        agent_email: currentUser.email 
                    })
                    .select('id')
                    .single();
                    
                if (sessionError) throw sessionError;
                callSessionId = newSession.id;
                
                const selectedItem = document.querySelector(`.scenario-item[data-value="${selectedScenarioId}"]`);
                if (selectedItem && selectedItem.classList.contains('compensation')) {
                    compensationScenarioSound.play().catch(e => console.warn("Compensation sound failed. Make sure compensation_alert.mp3 is in the correct folder.", e));
                    scenarioTitleElement.classList.add('highlight-scenario-title-animation');
                    setTimeout(() => scenarioTitleElement.classList.remove('highlight-scenario-title-animation'), 1200);
                }
                
                updateSystemStatus("In Ticket", "status-in-call");
                renderStep();
            } catch (err) {
                console.error("Error starting ticket:", err);
                showCustomToast("Failed to start ticket. Please try again.");
                resetCallState(); 
                switchToInitialView();
                await loadActiveScenarios();
            } finally {
                setButtonLoadingState(receiveCallBtn, false, "Start Ticket");
            }
        });

        function renderStep() {
            if (!currentScenario || !currentStepId) return;

            const stepObject = currentScenario.steps.find(s => s?.id === currentStepId); 
            if (!stepObject) {
                finishCall(false, `Error: Step ${currentStepId} not found`);
                return;
            }
            
            // Update step type icon
            let stepIcon = '🗣️';
            if (stepObject.type === 'decision') stepIcon = '🤔';
            if (stepObject.type === 'form') stepIcon = '📝';
            
            stepTypeIconElement.textContent = stepIcon;
            scenarioTitleElement.textContent = currentScenario.title;
            
            stepsContainer.innerHTML = '';
            
            const stepTextElement = document.createElement('p');
            stepTextElement.innerHTML = stepObject.text.replace(/\n/g, '<br>');
            stepTextElement.style.fontSize = '1.3rem';
            stepTextElement.style.lineHeight = '1.8';
            stepsContainer.appendChild(stepTextElement);

            decisionButtonsContainer.innerHTML = ''; 

            prevStepBtn.style.display = stepHistory.length > 0 ? 'inline-flex' : 'none';
            endCallBtn.style.display = 'inline-flex';
            nextStepBtn.style.display = 'none';

            if (stepObject.type === 'decision' && Array.isArray(stepObject.options)) {
                stepObject.options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'decision-button'; 
                    button.textContent = option.label;
                    button.addEventListener('click', () => navigateToStep(option.next_id));
                    decisionButtonsContainer.appendChild(button);
                });
            } else if (stepObject.type === 'form' && Array.isArray(stepObject.fields)) {
                const formContainer = document.createElement('div');
                formContainer.className = 'form-step-container';
                formContainer.id = 'current-step-form';
                
                stepObject.fields.forEach(field => {
                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'form-field';
                    const label = document.createElement('label');
                    label.setAttribute('for', `field-${field.id}`);
                    label.textContent = field.label;
                    fieldDiv.appendChild(label);

                    const input = document.createElement(field.type === 'textarea' ? 'textarea' : 'input');
                    input.id = `field-${field.id}`;
                    input.name = field.id;
                    input.type = field.type || 'text';
                    if (field.required) input.required = true;
                    if (field.placeholder) input.placeholder = field.placeholder;
                    input.rows = field.type === 'textarea' ? 4 : undefined;
                    fieldDiv.appendChild(input);
                    formContainer.appendChild(fieldDiv);
                });
                stepsContainer.appendChild(formContainer);
                nextStepBtn.style.display = 'inline-flex';
            } else { 
                const nextStepBtnText = nextStepBtn.querySelector('.btn-text');
                if (stepObject.next_id) {
                    if (nextStepBtnText) nextStepBtnText.textContent = "Next Step";
                } else { 
                    if (nextStepBtnText) nextStepBtnText.textContent = "Finish Scenario";
                }
                nextStepBtn.style.display = 'inline-flex';
            }

            startStepTimer(); 
            saveCallState();
        }
        
        function navigateToStep(nextId) {
            stepVisitCount[nextId] = (stepVisitCount[nextId] || 0) + 1;
            if (stepVisitCount[nextId] > 5) {
                finishCall(false, "Error: Potential infinite loop detected. Ticket terminated.");
                return;
            }

            document.getElementById('call-flow-view').classList.add('decision-made-animation');
            setTimeout(() => document.getElementById('call-flow-view').classList.remove('decision-made-animation'), 700);

            stopAndRecordStepTimer();
            if (nextId === null || typeof nextId === 'undefined' || nextId === "") { 
                finishCall(true, "Reached end of scenario path."); 
                return;
            }

            const targetStep = currentScenario.steps.find(s => s?.id === nextId); 
            if (!targetStep) {
                finishCall(false, `Error: Path broken, step ${nextId} not found.`);
                return;
            }

            if (currentStepId) stepHistory.push(currentStepId); 
            currentStepId = nextId;
            renderStep();
        }

        nextStepBtn.addEventListener('click', () => {
            const stepObject = currentScenario.steps.find(s => s?.id === currentStepId); 
            if (!stepObject) return;
            
            if (stepObject.type === 'form') {
                const form = document.getElementById('current-step-form');
                const inputs = form.querySelectorAll('input, textarea');
                let formData = {};
                let isValid = true;
                inputs.forEach(input => {
                    if(input.required && !input.value) isValid = false;
                    formData[input.name] = input.value;
                });

                if(!isValid) { 
                    showCustomToast("Please fill all required fields."); 
                    return; 
                }

                console.log("Form Data Collected:", formData);
            }

            if (stepObject.next_id) navigateToStep(stepObject.next_id);
            else { stopAndRecordStepTimer(); finishCall(true, "Scenario finished via button."); }
        });

        prevStepBtn.addEventListener('click', () => {
            stopAndRecordStepTimer(); 
            if (stepHistory.length > 0) { 
                currentStepId = stepHistory.pop();
                if(stepVisitCount[currentStepId]) stepVisitCount[currentStepId] = 0;
                renderStep(); 
            }
        });
        
        endCallBtn.addEventListener('click', () => { 
            if (confirm("Are you sure you want to end this ticket?")) {
                stopAndRecordStepTimer(); 
                finishCall(false, "Ticket ended by agent"); 
            }
        });

        function startStepTimer() {
            callTimerDiv.style.display = 'inline-block'; 
            if (stepTimerInterval) clearInterval(stepTimerInterval);
            if (stepStartTime === 0) stepStartTime = Date.now(); 
            
            const updateTimerDisplay = () => {
                const totalSeconds = callStartTimeISO ? Math.floor((Date.now() - new Date(callStartTimeISO).getTime()) / 1000) : 0;
                const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
                const seconds = String(totalSeconds % 60).padStart(2, '0');
                callTimerDiv.textContent = `${minutes}:${seconds}`;
            };
            updateTimerDisplay(); 
            stepTimerInterval = setInterval(updateTimerDisplay, 1000);
        }

        function stopAndRecordStepTimer() {
            if (stepTimerInterval) clearInterval(stepTimerInterval);
            stepTimerInterval = null;
            if (stepStartTime > 0 && currentStepId && accumulatedStepDurations.hasOwnProperty(currentStepId)) {
                accumulatedStepDurations[currentStepId] += Math.floor((Date.now() - stepStartTime) / 1000);
            }
            stepStartTime = 0; 
        }
        
        async function finishCall(completed, reasonText) { 
            stopAndRecordStepTimer(); 
            const endTimeISO = new Date().toISOString();
            const durationInSeconds = callStartTimeISO ? Math.floor((new Date(endTimeISO) - new Date(callStartTimeISO)) / 1000) : 0;
            const quality = completed ? 'Good' : (durationInSeconds > 0 ? 'Bad' : 'N/A'); 
            const reason = reasonText || (completed ? 'Scenario completed.' : 'Ticket ended prematurely.');
            
            updateSystemStatus(completed ? "Completed" : "Ended", completed ? "status-completed" : "status-ended");

            if (callSessionId) {
                await supabase.from('call_sessions').update({ 
                    end_time: endTimeISO, 
                    duration: durationInSeconds, 
                    completed: completed, 
                    call_quality: quality, 
                    quality_reason: reason 
                }).eq('id', callSessionId);
            }
            
            displayPostCallSummary(quality, reason, durationInSeconds);
            clearCallState(); 
        }

        function displayPostCallSummary(quality, reason, totalDurationSeconds) {
            let summaryHTML = `
                <p><strong>Ticket Quality:</strong> <span class="quality-text quality-${quality?.toLowerCase() || 'na'}">${quality || 'N/A'}</span></p>
                <p><strong>Reason:</strong> ${reason || "N/A"}</p>
                <p><strong>Total Handle Time:</strong> ${Math.floor(totalDurationSeconds / 60)}m ${totalDurationSeconds % 60}s</p>
                <hr style="margin: 2rem 0; border-color: var(--border-color);">
                <p><strong>Time Spent on Steps:</strong></p>
                <ul style="list-style: none; padding-left: 0;">
            `;

            if (currentScenario?.steps) {
                let visitedSteps = [...new Set([...stepHistory, currentStepId])].filter(id => id != null);
                visitedSteps.forEach(stepId => {
                    const stepObject = currentScenario.steps.find(s => s?.id === stepId); 
                    const duration = accumulatedStepDurations[stepId] || 0;
                    if (stepObject && duration > 0) {
                        summaryHTML += `<li style="margin-bottom: 1rem; padding: 1rem; background: var(--input-background-color); border-radius: 8px;">
                            "${stepObject.text.substring(0,60)}..."<br>
                            <strong style="color: var(--primary-color);">${duration}s</strong>
                        </li>`;
                    }
                });
            } else { 
                summaryHTML += `<li style="color: var(--text-color-secondary); font-style: italic;">No step data available.</li>`; 
            }
            summaryHTML += `</ul>`;
            callSummaryContentDiv.innerHTML = summaryHTML;
            switchToSummaryView();
        }
        
        returnToInitialViewBtn.addEventListener('click', async () => {
            resetCallState(true); 
            await loadActiveScenarios();
        });

        function saveCallState() {
            if (!callSessionId) return;
            const state = { 
                callSessionId, 
                currentScenario, 
                currentStepId, 
                stepHistory, 
                accumulatedStepDurations, 
                stepStartTime, 
                callStartTimeISO, 
                stepVisitCount 
            };
            sessionStorage.setItem(SESSION_STATE_KEY, JSON.stringify(state));
        }

        function restoreCallState() {
            const savedState = JSON.parse(sessionStorage.getItem(SESSION_STATE_KEY));
            if (!savedState || !savedState.callSessionId) return false;
            
            callSessionId = savedState.callSessionId;
            currentScenario = savedState.currentScenario; 
            currentStepId = savedState.currentStepId;
            stepHistory = savedState.stepHistory;
            accumulatedStepDurations = savedState.accumulatedStepDurations;
            stepStartTime = savedState.stepStartTime || Date.now(); 
            callStartTimeISO = savedState.callStartTimeISO; 
            stepVisitCount = savedState.stepVisitCount || {};
            return true;
        }

        function clearCallState() {
            sessionStorage.removeItem(SESSION_STATE_KEY);
        }

        function resetCallState(switchToInitial = false) {
            stopAndRecordStepTimer(); 
            clearCallState();         
            callSessionId = currentStepId = currentScenario = null;
            stepHistory = [];
            accumulatedStepDurations = {}; 
            stepVisitCount = {};
            stepStartTime = 0;
            if (switchToInitial) switchToInitialView();
        }

        logoutButton.addEventListener('click', async () => {
            resetCallState(); 
            localStorage.removeItem('elevoCoreUserData'); 
            if (supabase) await supabase.auth.signOut();
            window.location.replace("login.html");
        });
        
        searchScenarioInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const scenarios = document.querySelectorAll('.scenario-item');
            let hasVisibleItems = false;
            
            scenarios.forEach(scenario => {
                const title = scenario.textContent.toLowerCase();
                const isVisible = title.includes(searchTerm);
                scenario.style.display = isVisible ? 'flex' : 'none';
                if (isVisible) hasVisibleItems = true;
            });

            // Show message if no results
            if (!hasVisibleItems && searchTerm) {
                const noResults = document.createElement('div');
                noResults.className = 'scenario-item';
                noResults.innerHTML = `
                    <div style="text-align: center; width: 100%; color: var(--text-color-secondary);">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">🔍</div>
                        <div>No scenarios found for "${searchTerm}"</div>
                    </div>
                `;
                document.getElementById('customScenarioList').appendChild(noResults);
            }
        });

        window.addEventListener('beforeunload', () => { if (callSessionId) saveCallState(); });
        
        if (supabase) initializeApp();
        else authLoadingDiv.innerHTML = '<p style="color:var(--danger-color); font-size: 1.2rem;">Core services could not be initialized.</p>';
    </script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const userNameElement = document.getElementById("userName");
  const user = JSON.parse(localStorage.getItem("user"));
  if (userNameElement && user) {
    userNameElement.textContent = user.name || user.email || "User";
  }
});
</script>

</body>
</html>
