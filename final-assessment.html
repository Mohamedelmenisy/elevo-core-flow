<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Assessment - Coaching & Leadership</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">

    <!-- *** IMPORTANT: Ensure this Supabase JS library is included BEFORE your script runs *** -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- Base Styles (Consistent) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f8fafc; margin: 0; padding: 0; line-height: 1.6; color: #374151; display: flex; flex-direction: column; min-height: 100vh; padding-top: 62px; /* Space for fixed header */ }
        main { flex-grow: 1; display: flex; justify-content: center; align-items: flex-start; flex-direction: column; width: 100%; max-width: 900px; margin: 20px auto; padding: 0 20px; }

        /* User Bar (Consistent - No Changes) */
        .user-bar { background-color: #34495e; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; color: white; font-size: 14px; position: fixed; top: 0; left: 0; width: 100%; z-index: 1010; /* Higher z-index */ box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-info svg { opacity: 0.8; vertical-align: middle; color: white; }
        .user-details-bar { display: flex; flex-direction: column; }
        .user-name-bar { font-weight: 600; font-size: 14px; color: white; }
        .user-email-bar { font-size: 12px; opacity: 0.8; color: white; }
        .logout-button { background-color: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 6px; font-size: 13px; }
        .logout-button:hover { background-color: #c0392b; transform: translateY(-1px); }
        .logout-button svg { color: white; }

        /* Footer (Consistent - No Changes) */
        .footer { text-align: center; padding: 25px 30px; background: #f9fafb; color: #6b7280; margin-top: auto; font-size: 14px; width: 100%; border-top: 1px solid #e5e7eb; }

        /* --- Final Assessment & Form Styles --- */
        .assessment-container { background: white; padding: 35px 45px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); border-radius: 12px; width: 100%; margin-bottom: 35px; text-align: left; opacity: 0; transition: opacity 0.7s ease-in-out; border: 1px solid #e5e7eb; display: none; }
        .assessment-container.fade-in { opacity: 1; }
        .assessment-container h2 { color: #1f2937; margin-bottom: 25px; font-size: 26px; font-weight: 600; border-bottom: 1px solid #e5e7eb; padding-bottom: 15px; text-align: center; }
        .assessment-container h2 .title-emoji { display: inline-block; margin-right: 8px; font-size: 1.1em; }
        .assessment-intro { background-color: #eff6ff; border-left: 5px solid #3b82f6; padding: 18px 25px; margin-bottom: 30px; border-radius: 6px; font-size: 15px; color: #374151; line-height: 1.7; }
        .assessment-intro strong { color: #1e40af; }
        #adminAssessmentNote { font-weight: bold; color: #b45309; display: none; }
        .focus-reminder { background-color: #fffbeb; border: 1px solid #fcd34d; color: #92400e; padding: 12px 18px; margin-bottom: 30px; border-radius: 6px; font-size: 14px; display: flex; align-items: center; gap: 8px; }

        /* Sticky Progress Bar Styles */
        #assessmentProgressContainer {
            position: sticky;
            top: 62px; /* Height of the user bar */
            background-color: rgba(248, 250, 252, 0.95); /* Match body background with slight transparency */
            backdrop-filter: blur(5px); /* Optional blur effect */
            padding: 10px 0;
            z-index: 1000; /* Below user bar, above form content */
            margin-left: -45px; /* Counteract container padding */
            margin-right: -45px;/* Counteract container padding */
            padding-left: 45px; /* Restore padding inside */
            padding-right: 45px;/* Restore padding inside */
            border-bottom: 1px solid #e5e7eb; /* Subtle separator */
            margin-bottom: 30px; /* Space below sticky bar */
        }
        #assessmentProgressLabel { font-size: 14px; color: #4b5563; margin-bottom: 8px; text-align: center; }
        #assessmentProgress { width: 100%; height: 12px; background-color: #e5e7eb; border-radius: 6px; overflow: hidden; }
        #assessmentProgressBar { width: 0%; height: 100%; background: linear-gradient(90deg, #a78bfa, #7c3aed); border-radius: 6px; transition: width 0.5s ease-out; }

        /* Form Group & Input Styles */
        #finalAssessmentForm .form-group { margin-bottom: 40px; padding: 20px; border: 1px solid #e5e7eb; border-radius: 8px; background-color: #f9fafb; transition: background-color 0.3s ease; /* Add transition */ }
        #finalAssessmentForm label, #finalAssessmentForm legend { display: block; margin-bottom: 12px; font-weight: 600; color: #374151; font-size: 17px; }
        #finalAssessmentForm fieldset { border: none; padding: 0; margin: 0 0 15px 0; }
        #finalAssessmentForm fieldset label { font-weight: normal; font-size: 15px; margin-bottom: 8px; display: flex; align-items: center; }
        #finalAssessmentForm input[type="radio"] { margin-right: 8px; width: auto; accent-color: #7c3aed; }
        #finalAssessmentForm textarea, #finalAssessmentForm input[type="number"], #finalAssessmentForm fieldset { transition: background-color 0.3s ease; /* Add transition */ }
        #finalAssessmentForm textarea, #finalAssessmentForm input[type="number"] { width: 100%; padding: 12px 14px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 15px; transition: border-color 0.3s, box-shadow 0.3s, background-color 0.3s; color: #1f2937; background-color: #fff; }
        #finalAssessmentForm textarea { min-height: 120px; resize: vertical; }
        #finalAssessmentForm textarea:focus, #finalAssessmentForm input[type="number"]:focus, #finalAssessmentForm input[type="radio"]:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); outline: none; }

        /* Style for Saved Answers */
        #finalAssessmentForm .answer-saved-visual textarea,
        #finalAssessmentForm .answer-saved-visual input[type="number"],
        #finalAssessmentForm .answer-saved-visual fieldset {
            background-color: #eef2ff; /* Light indigo background */
            border-color: #a5b4fc; /* Slightly darker indigo border */
        }

        #finalAssessmentForm .input-meta-info { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
        #finalAssessmentForm .word-count-info { font-size: 13px; color: #6b7280; }
        #finalAssessmentForm .paste-warning { font-size: 13px; color: #f97316; display: none; }
        #finalAssessmentForm .error-message { color: #ef4444; font-size: 14px; margin-top: 8px; display: none; font-weight: 500;}
        #finalAssessmentForm input.invalid, #finalAssessmentForm textarea.invalid, #finalAssessmentForm fieldset.invalid { border-color: #ef4444 !important; /* Ensure error border overrides saved border */ }
        #finalAssessmentForm fieldset.invalid legend { color: #ef4444; } /* Highlight legend on radio error */

        .answer-actions { margin-top: 15px; display: flex; gap: 10px; align-items: center; }
        .answer-actions .action-feedback { font-size: 13px; color: #10b981; visibility: hidden; opacity: 0; transition: opacity 0.5s ease-out; font-weight: 500;}
        .answer-actions .action-feedback.show { visibility: visible; opacity: 1;}
        .answer-actions .action-feedback.error { color: #ef4444; } /* Error feedback color */

        .save-answer-btn, .clear-answer-btn { background-color: #e5e7eb; color: #374151; border: 1px solid #d1d5db; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s ease; }
        .save-answer-btn:hover:not(:disabled) { background-color: #d1d5db; border-color: #9ca3af; }
        .clear-answer-btn { background-color: transparent; color: #ef4444; border: 1px solid transparent; }
        .clear-answer-btn:hover:not(:disabled) { background-color: #fee2e2; color: #b91c1c; border-color: #fecaca; }
        .save-answer-btn:disabled, .clear-answer-btn:disabled { background-color: #f3f4f6; color: #9ca3af; cursor: not-allowed; border-color: #e5e7eb; opacity: 0.7; }

        /* Final Submit Button (Consistent - No Changes) */
        #finalSubmitBtn { background-color: #7c3aed; color: white; padding: 14px 30px; border: none; border-radius: 8px; font-size: 17px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: block; margin: 30px auto 0 auto; }
        #finalSubmitBtn:hover:not(:disabled) { background-color: #6d28d9; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(124, 58, 237, 0.25); }
        #finalSubmitBtn:disabled { background-color: #9ca3af; cursor: not-allowed; transform: none; box-shadow: none;}

        /* Completion Popup Styles (Consistent - No Changes) */
        #assessmentCompletePopup { display: none; position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background-color: white; padding: 35px 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); z-index: 1002; text-align: center; border-top: 6px solid #7c3aed; min-width: 320px; max-width: 450px; }
        #assessmentCompletePopup .completion-icon { font-size: 3rem; color: #10b981; margin-bottom: 15px; }
        #assessmentCompletePopup p { font-size: 17px; color: #374151; margin-bottom: 10px; line-height: 1.6; }
        #assessmentCompletePopup .completion-score { font-size: 15px; color: #6b7280; margin-bottom: 25px; font-weight: 500; }
        #assessmentCompletePopup button { background-color: #3b82f6; color: white; padding: 11px 22px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; }
        #assessmentCompletePopup button:hover { background-color: #2563eb; }
        .popup-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 1001; }

        /* Access Denied Modal (Consistent - No Changes) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.65); display: none; align-items: center; justify-content: center; z-index: 9999; cursor: pointer; padding: 20px; }
        .modal-content-box { background: white; border-radius: 12px; padding: 35px 40px; max-width: 450px; width: 95%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.25); cursor: default; border-top: 5px solid #e74c3c; }
        .modal-content-box h2 { color: #e74c3c; margin-bottom: 18px; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .modal-content-box p { margin-bottom: 28px; color: #374151; font-size: 1.05rem; line-height: 1.6; }
        .modal-content-box button { background-color: #3498db; color: white; padding: 11px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 500; transition: background-color 0.3s ease; }
        .modal-content-box button:hover { background-color: #2980b9; }

        /* Loading / Initial Message */
        #loadingOrAccessMessage { text-align: center; padding: 60px 20px; font-size: 20px; color: #6b7280; width: 100%; }

        /* Responsive Adjustments */
         @media (max-width: 768px) { body { padding-top: 62px; } main { padding: 0 15px; margin: 15px auto; } .assessment-container { padding: 25px 30px; } .user-bar { padding: 10px 15px; } #assessmentProgressContainer { margin-left: -30px; margin-right: -30px; padding-left: 30px; padding-right: 30px;} }
         @media (max-width: 600px) {
            .assessment-container { padding: 20px 15px; } .assessment-container h2 { font-size: 22px; }
            #finalAssessmentForm textarea { min-height: 100px; } #finalAssessmentForm label, #finalAssessmentForm legend { font-size: 16px; } #finalAssessmentForm input[type="number"], #finalAssessmentForm textarea { padding: 10px 12px; font-size: 14px; } .save-answer-btn, .clear-answer-btn { padding: 5px 10px; font-size: 12px; } #finalSubmitBtn { padding: 12px 25px; font-size: 16px; }
            #assessmentCompletePopup { width: 90%; padding: 25px 20px; } .modal-content-box { padding: 25px 15px; } .modal-content-box h2 { font-size: 1.3rem; } .modal-content-box p { font-size: 0.95rem; } .modal-content-box button { padding: 10px 20px; font-size: 0.9rem;} .focus-reminder { font-size: 13px; padding: 10px 15px; }
            #assessmentProgressContainer { margin-left: -15px; margin-right: -15px; padding-left: 15px; padding-right: 15px;}
        }
    </style>
</head>
<body>
    <!-- User Bar -->
    <div class="user-bar"> <!-- Content remains the same --> </div>

    <!-- Access Denied Modal -->
    <div id="accessDeniedModal" class="modal-overlay" style="display: none;"> <!-- Content remains the same --> </div>

    <!-- Main Content Area -->
    <main>
        <div id="loadingOrAccessMessage">Loading Assessment...</div>

        <!-- Final Assessment Container -->
        <section id="assessmentContainer" class="assessment-container">
             <h2><span class="title-emoji">🤔</span> Post-Course Reflection</h2>
            <p class="assessment-intro"> <!-- Content remains the same --> </p>
            <div class="focus-reminder"> <!-- Content remains the same --> </div>

            <!-- Overall Progress Indicator (Sticky) -->
             <div id="assessmentProgressContainer">
                 <div id="assessmentProgressLabel">Assessment Progress: 0%</div>
                 <div id="assessmentProgress">
                     <div id="assessmentProgressBar"></div>
                 </div>
             </div>

            <form id="finalAssessmentForm" novalidate>
                <!-- Question 1: Situational Disengaged -->
                 <div class="form-group" data-group-id="q_situational_disengaged">
                     <label for="q_situational_disengaged">Scenario: You notice a team member who seems consistently disengaged...</label>
                     <textarea id="q_situational_disengaged" name="situational_disengaged" required data-min-words="30" data-question-id="q_situational_disengaged" placeholder="Outline your approach..."></textarea>
                     <div class="input-meta-info">
                         <div class="paste-warning" id="q_situational_disengaged_paste_warning">Pasting...</div>
                         <div class="word-count-info" id="q_situational_disengaged_word_count_container">Words: <span id="q_situational_disengaged_word_count">0</span><span>/30</span></div>
                     </div>
                     <div class="error-message" id="q_situational_disengaged_error"></div>
                     <div class="answer-actions">
                        <button type="button" class="save-answer-btn" data-question-id="q_situational_disengaged">Save Answer</button>
                        <button type="button" class="clear-answer-btn" data-question-id="q_situational_disengaged">Clear Answer</button>
                        <span class="action-feedback" id="q_situational_disengaged_feedback"></span>
                     </div>
                 </div>

                 <!-- Question 2: Situational Feedback -->
                 <div class="form-group" data-group-id="q_situational_feedback">
                     <label for="q_situational_feedback">Scenario: You need to provide constructive feedback...</label>
                     <textarea id="q_situational_feedback" name="situational_feedback" required data-min-words="30" data-question-id="q_situational_feedback" placeholder="Describe your feedback process..."></textarea>
                     <div class="input-meta-info">
                         <div class="paste-warning" id="q_situational_feedback_paste_warning">Pasting...</div>
                         <div class="word-count-info" id="q_situational_feedback_word_count_container">Words: <span id="q_situational_feedback_word_count">0</span><span>/30</span></div>
                     </div>
                     <div class="error-message" id="q_situational_feedback_error"></div>
                     <div class="answer-actions">
                        <button type="button" class="save-answer-btn" data-question-id="q_situational_feedback">Save Answer</button>
                        <button type="button" class="clear-answer-btn" data-question-id="q_situational_feedback">Clear Answer</button>
                        <span class="action-feedback" id="q_situational_feedback_feedback"></span>
                    </div>
                 </div>

                 <!-- Question 3: Reflection Skill -->
                 <div class="form-group" data-group-id="q_reflection_skill">
                     <label for="q_reflection_skill">What’s one specific coaching skill...</label>
                     <textarea id="q_reflection_skill" name="reflection_skill_improved" required data-min-words="30" data-question-id="q_reflection_skill" placeholder="Identify the skill..."></textarea>
                     <div class="input-meta-info">
                         <div class="paste-warning" id="q_reflection_skill_paste_warning">Pasting...</div>
                         <div class="word-count-info" id="q_reflection_skill_word_count_container">Words: <span id="q_reflection_skill_word_count">0</span><span>/30</span></div>
                     </div>
                     <div class="error-message" id="q_reflection_skill_error"></div>
                     <div class="answer-actions">
                        <button type="button" class="save-answer-btn" data-question-id="q_reflection_skill">Save Answer</button>
                        <button type="button" class="clear-answer-btn" data-question-id="q_reflection_skill">Clear Answer</button>
                        <span class="action-feedback" id="q_reflection_skill_feedback"></span>
                    </div>
                 </div>

                 <!-- Question 4: Reflection Challenge -->
                 <div class="form-group" data-group-id="q_reflection_challenge">
                     <label for="q_reflection_challenge">Reflecting on the course material, what was the most challenging concept...</label>
                     <textarea id="q_reflection_challenge" name="reflection_challenge" required data-min-words="30" data-question-id="q_reflection_challenge" placeholder="Discuss your biggest challenge..."></textarea>
                     <div class="input-meta-info">
                         <div class="paste-warning" id="q_reflection_challenge_paste_warning">Pasting...</div>
                         <div class="word-count-info" id="q_reflection_challenge_word_count_container">Words: <span id="q_reflection_challenge_word_count">0</span><span>/30</span></div>
                     </div>
                     <div class="error-message" id="q_reflection_challenge_error"></div>
                     <div class="answer-actions">
                         <button type="button" class="save-answer-btn" data-question-id="q_reflection_challenge">Save Answer</button>
                         <button type="button" class="clear-answer-btn" data-question-id="q_reflection_challenge">Clear Answer</button>
                         <span class="action-feedback" id="q_reflection_challenge_feedback"></span>
                     </div>
                 </div>

                 <!-- Question 5: Evaluation (Rating + Explanation) -->
                 <div class="form-group" data-group-id="q_eval_confidence_rating"> <!-- Group ID for combined visual -->
                     <label for="q_eval_confidence_rating">On a scale of 1 (Not confident) to 5 (Very confident)...</label>
                     <input type="number" id="q_eval_confidence_rating" name="evaluation_confidence_rating" required min="1" max="5" step="1" data-question-id="q_eval_confidence_rating" placeholder="Enter 1-5">
                     <div class="error-message" id="q_eval_confidence_rating_error"></div>
                     <div class="answer-actions" style="margin-bottom: 15px;">
                         <button type="button" class="save-answer-btn" data-question-id="q_eval_confidence_rating">Save Rating</button>
                         <button type="button" class="clear-answer-btn" data-question-id="q_eval_confidence_rating">Clear Rating</button>
                         <span class="action-feedback" id="q_eval_confidence_rating_feedback"></span>
                     </div>

                     <label for="q_eval_confidence_explanation" style="margin-top: 20px;">Briefly explain your rating.</label>
                     <textarea id="q_eval_confidence_explanation" name="evaluation_confidence_explanation" required data-min-words="25" data-question-id="q_eval_confidence_explanation" placeholder="Explain your confidence level..."></textarea>
                     <div class="input-meta-info">
                         <div class="paste-warning" id="q_eval_confidence_explanation_paste_warning">Pasting...</div>
                         <div class="word-count-info" id="q_eval_confidence_explanation_word_count_container">Words: <span id="q_eval_confidence_explanation_word_count">0</span><span>/25</span></div>
                     </div>
                     <div class="error-message" id="q_eval_confidence_explanation_error"></div>
                     <div class="answer-actions">
                        <button type="button" class="save-answer-btn" data-question-id="q_eval_confidence_explanation">Save Explanation</button>
                        <button type="button" class="clear-answer-btn" data-question-id="q_eval_confidence_explanation">Clear Explanation</button>
                        <span class="action-feedback" id="q_eval_confidence_explanation_feedback"></span>
                    </div>
                 </div>

                 <!-- Question 6: Multiple Choice (NEW) -->
                 <div class="form-group" data-group-id="q_mc_model_preference">
                      <fieldset data-question-id="q_mc_model_preference">
                         <legend>Which coaching model discussed... do you foresee yourself using most often?</legend>
                         <label><input type="radio" name="mc_model_preference" value="grow" required> The GROW Model...</label>
                         <label><input type="radio" name="mc_model_preference" value="skillwill"> The Skill/Will Matrix...</label>
                         <label><input type="radio" name="mc_model_preference" value="solution"> Solution-Focused Coaching...</label>
                         <label><input type="radio" name="mc_model_preference" value="positive"> The POSITIVE Model...</label>
                         <label><input type="radio" name="mc_model_preference" value="practice"> The PRACTICE Model...</label>
                         <label><input type="radio" name="mc_model_preference" value="mix"> A mix, depending on the situation</label>
                         <label><input type="radio" name="mc_model_preference" value="unsure"> Unsure yet</label>
                      </fieldset>
                      <div class="error-message" id="q_mc_model_preference_error">Please select an option.</div>
                      <div class="answer-actions">
                          <button type="button" class="save-answer-btn" data-question-id="q_mc_model_preference">Save Selection</button>
                          <button type="button" class="clear-answer-btn" data-question-id="q_mc_model_preference">Clear Selection</button>
                          <span class="action-feedback" id="q_mc_model_preference_feedback"></span>
                      </div>
                 </div>

                 <!-- Submit Button -->
                <button type="submit" id="finalSubmitBtn">Submit Final Assessment</button>
            </form>
        </section>

        <!-- Completion Popup -->
        <div class="popup-overlay" id="completionPopupOverlay"></div>
        <div id="assessmentCompletePopup"> <!-- Content remains the same --> </div>

    </main>

    <!-- Footer -->
    <footer class="footer"> <!-- Content remains the same --> </footer>

    <script>
        // --- Constants (Consistent - No Changes) ---
        const LOGGED_IN_KEY = 'isUserLoggedIn';
        const CURRENT_USER_KEY = 'currentUser';
        const ADMIN_EMAIL = 'm.elsayed@thechefz.co';
        const FINAL_ASSESSMENT_ID = 'final_assessment';
        const FEEDBACK_URL = 'feedback.html';
        const WHATS_NEXT_URL = 'whats-next.html';
        const requiredCourseSections = [ { id: 'index' }, { id: 'article1' }, { id: 'skills' }, { id: 'individuals' }, { id: 'team' }, { id: 'self' }, { id: 'action' } ];

        // --- Globals ---
        let IS_ADMIN_USER = false;
        let currentUser = null;
        let supabase = null; // <--- Add Supabase global

        // --- Supabase Initialization ---
        try {
            if (typeof window.supabase === 'undefined' || typeof window.supabase.createClient !== 'function') {
                throw new Error("Supabase library (supabase-js) not found or not loaded correctly.");
            }
            const supabaseUrl = 'https://lgcutmuspcaralydycmg.supabase.co';
            const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnY3V0bXVzcGNhcmFseWR5Y21nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0NDY3MDEsImV4cCI6MjA2MTAyMjcwMX0.3u5Y7pkH2NNnnoGLMWVfAa5b8fq88o1itRYnG1K38tE';
            supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
            console.log("Supabase client initialized successfully.");
        } catch (error) {
             console.error("FATAL: Supabase client initialization failed:", error.message);
             // Display a user-facing error message if needed
             const loadingMsg = document.getElementById('loadingOrAccessMessage');
             if (loadingMsg) loadingMsg.textContent = 'Error initializing data connection. Please refresh.';
             // Optionally hide the assessment container if Supabase fails critically
             // const assessmentContainer = document.getElementById('assessmentContainer');
             // if(assessmentContainer) assessmentContainer.style.display = 'none';
        }

        // --- Utility & Core Functions (getLocalStorageUser, saveCurrentUser, populateTopBar, countWords, goBackToNext, logout - No Changes) ---
        function getLocalStorageUser() { /* ... Keep existing implementation ... */ try { const userDataString = localStorage.getItem(CURRENT_USER_KEY); if (!userDataString) return null; const parsedUser = JSON.parse(userDataString); if (parsedUser && typeof parsedUser === 'object' && parsedUser.name && parsedUser.email && parsedUser.progress) { /* NEW: Initialize assessment fields if missing */ if (typeof parsedUser.finalAssessmentCompleted === 'undefined') { parsedUser.finalAssessmentCompleted = false; } if (typeof parsedUser.finalAssessmentAnswers === 'undefined') { parsedUser.finalAssessmentAnswers = {}; } return parsedUser; } console.warn("Invalid user data structure in localStorage."); return null; } catch (error) { console.error("Error parsing user data:", error); return null; } }
        function saveCurrentUser(userObject) { /* ... Keep existing implementation ... */ try { if (!userObject) throw new Error("Cannot save invalid user object."); localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(userObject)); console.log("User data saved locally:", userObject); } catch (error) { console.error("Error saving user data locally:", error); } }
        function populateTopBar(user) { /* ... Keep existing implementation ... */ const userNameElement = document.getElementById('userNameBar'); const userEmailElement = document.getElementById('userEmailBar'); if (user && userNameElement && userEmailElement) { userNameElement.textContent = user.name || 'User'; userEmailElement.textContent = user.email; } else { if(userNameElement) userNameElement.textContent = 'N/A'; if(userEmailElement) userEmailElement.textContent = 'N/A'; } }
        function countWords(text) { /* ... Keep existing implementation ... */ return text ? text.trim().split(/\s+/).filter(Boolean).length : 0; }
        function goBackToNext() { /* ... Keep existing implementation ... */ console.log("Redirecting user to required completion page:", WHATS_NEXT_URL); window.location.href = WHATS_NEXT_URL; }
        function logout() { /* ... Keep existing implementation ... */ console.log("Logging out..."); try { localStorage.removeItem(LOGGED_IN_KEY); localStorage.removeItem(CURRENT_USER_KEY); IS_ADMIN_USER = false; currentUser = null; supabase = null; /* Clear Supabase client */ window.location.href = 'login.html'; } catch (e) { console.error("Logout error:", e); window.location.href = 'login.html'; } }

        // --- IMMEDIATE ACCESS CONTROL (Self-Executing Function - Minor Change: Ensure currentUser uses updated getLocalStorageUser) ---
        (function checkAccess() {
            console.log("%cRunning IMMEDIATE access check...", "color: orange; font-weight: bold;");
            const isLoggedIn = localStorage.getItem(LOGGED_IN_KEY) === 'true';
            // Use the updated function which initializes assessment fields if needed
            const user = getLocalStorageUser();
            currentUser = user; // Assign to global early

            if (!isLoggedIn || !user || !user.progress) { /* ... Keep existing logic ... */ console.warn("Redirecting to login: User not logged in or data invalid."); window.location.replace('login.html'); throw new Error("Redirecting user: Not logged in or invalid data. Halting script."); }
            const isAdmin = user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase(); IS_ADMIN_USER = isAdmin; if (isAdmin) { console.log("%cAdmin Access Granted: Bypassing module completion checks.", "color: blue; font-weight: bold;"); } else { console.log("%cNon-Admin User: Checking module completion...", "color: orange;"); let allSectionsComplete = true; for (const section of requiredCourseSections) { if ((user.progress[section.id] || 0) < 100) { allSectionsComplete = false; console.warn(`Non-admin incomplete: Section '${section.id}' (Progress: ${user.progress[section.id] || 0})`); break; } } if (!allSectionsComplete) { /* ... Keep existing denial logic ... */ console.warn("%cAccess Denied for Non-Admin: Course not fully completed. Showing Modal.", "color: red; font-weight: bold;"); const loadingMsg = document.getElementById('loadingOrAccessMessage'); const assessmentContainer = document.getElementById('assessmentContainer'); if (loadingMsg) loadingMsg.style.display = 'none'; if (assessmentContainer) assessmentContainer.style.display = 'none'; const modal = document.getElementById('accessDeniedModal'); if (modal) { modal.style.display = 'flex'; } else { console.error("Access Denied Modal element (#accessDeniedModal) not found!"); alert("Access Denied: Please complete all course modules."); window.location.href = WHATS_NEXT_URL; } throw new Error("Stopping script: Non-admin user has not completed required modules."); } else { console.log("%cNon-Admin Access Granted: All modules completed.", "color: green; font-weight: bold;"); } } console.log("%cAccess Check Complete: Proceeding with page setup.", "color: green;");
        })();
        // --- END IMMEDIATE ACCESS CONTROL ---


        // --- NEW: Supabase Data Update Function ---
        async function updateSupabaseAssessmentData() {
            if (!supabase) { console.error("Supabase client not initialized. Cannot update."); return false; }
            if (!currentUser || !currentUser.id) { console.error("Current user data or ID missing. Cannot update Supabase."); return false; }

            console.log("Attempting to update Supabase assessment data...");
            try {
                const updateData = {
                    // Ensure keys match your Supabase column names EXACTLY
                    final_assessment_answers: currentUser.finalAssessmentAnswers || {},
                    final_assessment_completed: currentUser.finalAssessmentCompleted || false
                };
                console.log("Data being sent to Supabase:", updateData);

                const { data, error } = await supabase
                    .from('users') // Assuming data is in the 'users' table
                    .update(updateData)
                    .eq('id', currentUser.id) // Match the current user's ID
                    .select() // Optionally select to confirm update

                if (error) { throw error; }

                console.log("Supabase assessment data updated successfully:", data);
                return true; // Indicate success
            } catch (error) {
                console.error("Error updating Supabase assessment data:", error.message);
                // Consider showing a user-facing error message here
                alert(`Error saving progress to server: ${error.message}. Your changes might only be saved locally.`);
                return false; // Indicate failure
            }
        }


        // --- DOMContentLoaded Event Listener (MODIFIED for Supabase Check) ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM fully loaded. Setting up assessment page.");

            if (!supabase) {
                 console.error("DOM Load Error: Supabase client failed to initialize. Aborting page setup.");
                 const loadingMsg = document.getElementById('loadingOrAccessMessage');
                 if (loadingMsg) loadingMsg.textContent = 'Error connecting to data services. Cannot load assessment.';
                 const assessmentContainer = document.getElementById('assessmentContainer');
                 if (assessmentContainer) assessmentContainer.style.display = 'none';
                 return; // Stop if Supabase isn't working
            }

            if (!currentUser) { /* ... Keep existing error handling ... */ return; }

            // ... (rest of the DOMContentLoaded setup remains largely the same)
            const loadingMsg = document.getElementById('loadingOrAccessMessage');
            const assessmentContainer = document.getElementById('assessmentContainer');
            const assessmentForm = document.getElementById('finalAssessmentForm');
            const accessDeniedModal = document.getElementById('accessDeniedModal');

            populateTopBar(currentUser);
            setupFormInteractions(); // Setup word count, paste prevention, save/delete buttons
            loadAnswers(); // Load existing answers from localStorage & apply styles
            updateProgressIndicator(); // Update progress bar based on loaded answers

            const alreadyCompleted = currentUser.finalAssessmentCompleted; // Use the potentially initialized value

             if (alreadyCompleted) {
                 disableFormAndShowCompletion();
             } else {
                 assessmentForm.addEventListener('submit', handleFinalAssessmentSubmit);
             }

             setupFeedbackButtonListener();

            if (loadingMsg) loadingMsg.style.display = 'none';
            if (assessmentContainer) { assessmentContainer.style.display = 'block'; setTimeout(() => assessmentContainer.classList.add('fade-in'), 50); }
            if (accessDeniedModal) { accessDeniedModal.addEventListener('click', function (event) { if (event.target === accessDeniedModal) { goBackToNext(); } }); }
        });


        // --- Answer Handling Functions (MODIFIED for Supabase & UI Feedback) ---

        function showActionFeedback(questionId, message, isError = false) {
            const feedbackEl = document.getElementById(`${questionId}_feedback`);
            if (feedbackEl) {
                feedbackEl.textContent = message;
                feedbackEl.classList.remove('error'); // Remove error class first
                if (isError) { feedbackEl.classList.add('error'); }
                feedbackEl.classList.add('show');
                setTimeout(() => { feedbackEl.classList.remove('show'); }, 2500); // Show for 2.5 seconds
            }
        }

        // Gets the element representing the question group (div or fieldset)
        function getQuestionGroupElement(questionId) {
             const inputElement = document.querySelector(`[data-question-id="${questionId}"]`);
             if (!inputElement) return null;
             // Find the closest ancestor that is a .form-group
             return inputElement.closest('.form-group');
        }

        async function saveAnswer(questionId) { // Make async for Supabase call
            const inputElement = document.querySelector(`[data-question-id="${questionId}"]:not(button)`);
            const groupElement = getQuestionGroupElement(questionId); // Get the group element
            let answerValue = null;

            if (!inputElement) { console.error(`Input element not found for question ID: ${questionId}`); return; }

            // --- Get Value ---
            if (inputElement.type === 'textarea' || inputElement.type === 'number') { answerValue = inputElement.value; /* Keep whitespace for now */ }
             else if (inputElement.tagName === 'FIELDSET') { const checkedRadio = inputElement.querySelector('input[type="radio"]:checked'); answerValue = checkedRadio ? checkedRadio.value : null; }
             else { console.warn(`Unsupported input type for saving: ${inputElement.type || inputElement.tagName}`); return; }

            // --- Basic Validation (same as before) ---
            let isValidForSave = true;
            const errorElement = document.getElementById(`${questionId}_error`);
            if(errorElement) errorElement.style.display = 'none';
            const elementToValidate = inputElement.tagName === 'FIELDSET' ? inputElement : inputElement; // Apply invalid class to fieldset or input
             if(elementToValidate.classList) elementToValidate.classList.remove('invalid');

            // Trim for validation checks but save the original value potentially
            const trimmedValue = typeof answerValue === 'string' ? answerValue.trim() : answerValue;

            if (elementToValidate.hasAttribute('required') && !trimmedValue) { /* ... required error ... */ if(errorElement){ errorElement.textContent = 'This field is required.'; errorElement.style.display = 'block'; } if(elementToValidate.classList) elementToValidate.classList.add('invalid'); isValidForSave = false; }
             else if (inputElement.type === 'textarea' && inputElement.dataset.minWords && !IS_ADMIN_USER) { /* ... word count validation ... */ if (!validateWordCount(inputElement, parseInt(inputElement.dataset.minWords, 10), errorElement)) { isValidForSave = false; } }
             else if (inputElement.type === 'number') { /* ... number range validation ... */ const ratingVal = parseInt(inputElement.value, 10); const min = parseInt(inputElement.min, 10); const max = parseInt(inputElement.max, 10); if (inputElement.required && (!inputElement.value || isNaN(ratingVal) || ratingVal < min || ratingVal > max)) { if(errorElement){errorElement.textContent = `Rating must be between ${min}-${max}.`;errorElement.style.display = 'block';} if(elementToValidate.classList) elementToValidate.classList.add('invalid'); isValidForSave = false; } }

            if (!isValidForSave) { console.warn(`Validation failed for ${questionId}. Not saving.`); showActionFeedback(questionId, 'Invalid input!', true); return; }

            // --- Save Locally ---
            currentUser = getLocalStorageUser(); // Get fresh data
            if (!currentUser) { console.error("Cannot save answer: User data missing."); showActionFeedback(questionId, 'Error: User data missing!', true); return; }
            if (!currentUser.finalAssessmentAnswers) { currentUser.finalAssessmentAnswers = {}; }
             // Save the potentially un-trimmed value
            currentUser.finalAssessmentAnswers[questionId] = answerValue;

            // --- Save to Supabase ---
            const success = await updateSupabaseAssessmentData();

            if (success) {
                saveCurrentUser(currentUser); // Update local storage only if Supabase succeeded
                console.log(`Answer saved for ${questionId}:`, answerValue);
                // Apply visual feedback
                if (groupElement) groupElement.classList.add('answer-saved-visual');
                showActionFeedback(questionId, 'Saved!');
                updateProgressIndicator(); // Update progress
            } else {
                // Don't save locally if Supabase failed, maybe revert local object?
                // For simplicity now, just show error. User needs to retry.
                showActionFeedback(questionId, 'Save Error!', true);
                // Remove visual feedback if it was added optimistically
                if (groupElement) groupElement.classList.remove('answer-saved-visual');
            }
        }

        async function deleteAnswer(questionId) { // Make async for Supabase call
            const inputElement = document.querySelector(`[data-question-id="${questionId}"]:not(button)`);
            const groupElement = getQuestionGroupElement(questionId); // Get the group element
            const errorElement = document.getElementById(`${questionId}_error`);
            const wordCountSpan = document.getElementById(`${questionId}_word_count`);

            if (!inputElement) { console.error(`Input element not found for question ID: ${questionId}`); return; }

            // --- Clear Input Value ---
            if (inputElement.type === 'textarea' || inputElement.type === 'number') { inputElement.value = ''; if (wordCountSpan) wordCountSpan.textContent = '0'; }
             else if (inputElement.tagName === 'FIELDSET') { const radios = inputElement.querySelectorAll('input[type="radio"]'); radios.forEach(radio => radio.checked = false); }

             // --- Clear Errors & Visual Feedback ---
            if(errorElement) errorElement.style.display = 'none';
            const elementToClear = inputElement.tagName === 'FIELDSET' ? inputElement : inputElement;
            if(elementToClear.classList) elementToClear.classList.remove('invalid');
            if (groupElement) groupElement.classList.remove('answer-saved-visual'); // Remove saved style

            // --- Delete Locally ---
            currentUser = getLocalStorageUser(); // Get fresh data
            if (!currentUser || !currentUser.finalAssessmentAnswers || !currentUser.finalAssessmentAnswers.hasOwnProperty(questionId)) {
                console.log(`No saved answer to delete for ${questionId}.`);
                 showActionFeedback(questionId, 'Cleared!'); // Show feedback even if nothing was saved
                return; // Nothing to delete in Supabase either
            }
            delete currentUser.finalAssessmentAnswers[questionId];

            // --- Save Deletion to Supabase ---
            const success = await updateSupabaseAssessmentData();

            if (success) {
                saveCurrentUser(currentUser); // Update local storage
                console.log(`Answer deleted for ${questionId}`);
                showActionFeedback(questionId, 'Cleared!');
                updateProgressIndicator(); // Update progress
            } else {
                // Failed to delete in Supabase, maybe show error?
                // Reverting local change might be complex. Alert user to retry.
                 showActionFeedback(questionId, 'Clear Error!', true);
                 // Optionally, restore the value locally if needed, but likely better to let user retry.
                 // loadAnswers(); // Re-load could restore the value if needed.
            }
        }

        function loadAnswers() {
            currentUser = getLocalStorageUser();
            if (!currentUser || !currentUser.finalAssessmentAnswers) { console.log("No saved assessment answers found to load."); return; }
            console.log("Loading saved answers...");
            const answers = currentUser.finalAssessmentAnswers;
            for (const questionId in answers) {
                const inputElement = document.querySelector(`[data-question-id="${questionId}"]:not(button)`);
                 const groupElement = getQuestionGroupElement(questionId);
                if (inputElement) {
                    const savedValue = answers[questionId];
                     // Check if there is actually a saved value before applying styles/values
                     const hasValue = savedValue !== null && savedValue !== '';

                    if (inputElement.type === 'textarea' || inputElement.type === 'number') {
                        inputElement.value = hasValue ? savedValue : '';
                        if(inputElement.type === 'textarea') { inputElement.dispatchEvent(new Event('input', { bubbles: true })); }
                    } else if (inputElement.tagName === 'FIELDSET') {
                        const radioToCheck = inputElement.querySelector(`input[type="radio"][value="${savedValue}"]`);
                        if (radioToCheck) { radioToCheck.checked = true; }
                        else { // Clear selection if saved value doesn't match any option
                            const radios = inputElement.querySelectorAll('input[type="radio"]');
                            radios.forEach(radio => radio.checked = false);
                         }
                    }
                    // Apply saved visual style IF a value exists
                    if (hasValue && groupElement) {
                        groupElement.classList.add('answer-saved-visual');
                    } else if (groupElement) {
                         groupElement.classList.remove('answer-saved-visual');
                    }
                } else { console.warn(`Input element not found for saved answer ID: ${questionId}`); }
            }
        }


        // --- Progress Indicator (No Changes needed) ---
        function updateProgressIndicator() { /* ... Keep existing implementation ... */ const form = document.getElementById('finalAssessmentForm'); const progressBar = document.getElementById('assessmentProgressBar'); const progressLabel = document.getElementById('assessmentProgressLabel'); if (!form || !progressBar || !progressLabel) return; const requiredInputs = form.querySelectorAll('[required][data-question-id]'); const totalRequired = requiredInputs.length; if (totalRequired === 0) { progressBar.style.width = '100%'; progressLabel.textContent = 'Assessment Progress: 100% (No required fields)'; return; } let answeredCount = 0; const savedAnswers = currentUser?.finalAssessmentAnswers || {}; requiredInputs.forEach(input => { const questionId = input.dataset.questionId; let hasAnswer = savedAnswers.hasOwnProperty(questionId) && savedAnswers[questionId] !== null && savedAnswers[questionId] !== ''; if (input.tagName === 'FIELDSET') { const radioInput = input.querySelector('input[type="radio"]'); if (radioInput) { const radioQuestionId = radioInput.dataset.questionId || questionId; hasAnswer = savedAnswers.hasOwnProperty(radioQuestionId) && savedAnswers[radioQuestionId] !== null && savedAnswers[radioQuestionId] !== ''; } } if (hasAnswer) { answeredCount++; } }); answeredCount = Math.min(answeredCount, totalRequired); const percentage = totalRequired > 0 ? Math.round((answeredCount / totalRequired) * 100) : 100; progressBar.style.width = `${percentage}%`; progressLabel.textContent = `Assessment Progress: ${percentage}%`; console.log(`Progress Updated: ${answeredCount}/${totalRequired} (${percentage}%)`); }


        // --- Form Setup Functions (No Changes needed) ---
        function validateWordCount(textarea, minWords, errorElement) { /* ... Keep existing implementation ... */ if (IS_ADMIN_USER || isNaN(minWords)) { if (errorElement) errorElement.style.display = 'none'; if(textarea.classList) textarea.classList.remove('invalid'); return true; } const words = countWords(textarea.value); const isFieldEmpty = !textarea.value.trim(); if (!isFieldEmpty && words < minWords) { if(errorElement) { errorElement.textContent = `Minimum ${minWords} words required.`; errorElement.style.display = 'block'; } if(textarea.classList) textarea.classList.add('invalid'); return false; } else { if (errorElement) errorElement.style.display = 'none'; if(textarea.classList) textarea.classList.remove('invalid'); return true; } }
        function setupWordCountValidation(textarea) { /* ... Keep existing implementation ... */ const questionId = textarea.dataset.questionId; const countSpan = document.getElementById(`${questionId}_word_count`); const errorElement = document.getElementById(`${questionId}_error`); const countContainer = document.getElementById(`${questionId}_word_count_container`); const minWords = parseInt(textarea.getAttribute('data-min-words'), 10); if (!countSpan || !errorElement || !countContainer || isNaN(minWords)) return; if (IS_ADMIN_USER) { countContainer.style.display = 'none'; return; } const minWordsDisplay = countContainer.querySelector('span + span'); if (minWordsDisplay) minWordsDisplay.textContent = `/${minWords}`; textarea.addEventListener('input', () => { const words = countWords(textarea.value); countSpan.textContent = words; validateWordCount(textarea, minWords, errorElement); }); }
        function setupPastePrevention(textarea) { /* ... Keep existing implementation ... */ if (IS_ADMIN_USER) return; const questionId = textarea.dataset.questionId; const warningElement = document.getElementById(`${questionId}_paste_warning`); if (!warningElement) return; textarea.addEventListener('paste', (event) => { event.preventDefault(); warningElement.textContent = 'Pasting content is disabled.'; warningElement.style.display = 'block'; setTimeout(() => { warningElement.style.display = 'none'; }, 4000); }); }
        function setupFormInteractions() { /* ... Keep existing implementation ... */ const form = document.getElementById('finalAssessmentForm'); if (!form) return; if (IS_ADMIN_USER) { const adminNote = document.getElementById('adminAssessmentNote'); if (adminNote) adminNote.style.display = 'inline'; form.querySelectorAll('textarea[data-min-words]').forEach(ta => ta.placeholder = "Admin Mode: No restrictions."); } else { form.querySelectorAll('textarea[data-min-words]').forEach(ta => { const min = ta.getAttribute('data-min-words'); if (min) ta.placeholder += ` (Minimum ${min} words)`; }); } form.querySelectorAll('textarea[data-question-id]').forEach(ta => { setupWordCountValidation(ta); setupPastePrevention(ta); }); form.querySelectorAll('input[type="number"][data-question-id]').forEach(numInput => {}); form.querySelectorAll('.save-answer-btn').forEach(button => { button.addEventListener('click', (e) => { const questionId = e.target.dataset.questionId; saveAnswer(questionId); }); }); form.querySelectorAll('.clear-answer-btn').forEach(button => { button.addEventListener('click', (e) => { const questionId = e.target.dataset.questionId; deleteAnswer(questionId); }); }); }


        // --- Final Submission Handling (MODIFIED for Supabase) ---
        async function handleFinalAssessmentSubmit(event) { // Make async
            event.preventDefault();
            console.log("Final Assessment submission initiated...");
            const form = event.target;
            const submitButton = document.getElementById('finalSubmitBtn');

            submitButton.disabled = true; submitButton.textContent = 'Checking Answers...';
            form.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            form.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));

            let allRequiredAnswered = true;
            const requiredInputs = form.querySelectorAll('[required][data-question-id]');
            const savedAnswers = currentUser?.finalAssessmentAnswers || {};

            // --- Validation Check (same as before) ---
            requiredInputs.forEach(input => { /* ... Keep existing validation logic ... */ const questionId = input.dataset.questionId; let hasAnswer = savedAnswers.hasOwnProperty(questionId) && savedAnswers[questionId] !== null && savedAnswers[questionId] !== ''; if (input.tagName === 'FIELDSET') { const radioInput = input.querySelector('input[type="radio"]'); if (radioInput) { const radioQuestionId = radioInput.dataset.questionId || questionId; hasAnswer = savedAnswers.hasOwnProperty(radioQuestionId) && savedAnswers[radioQuestionId] !== null && savedAnswers[radioQuestionId] !== ''; } } if (!hasAnswer) { allRequiredAnswered = false; const errorEl = document.getElementById(`${questionId}_error`); if (errorEl) { errorEl.textContent = 'Required field not saved.'; errorEl.style.display = 'block'; } const fieldToHighlight = input.tagName === 'FIELDSET' ? input.querySelector('input, textarea') || input : input; if(fieldToHighlight && fieldToHighlight.classList) fieldToHighlight.classList.add('invalid'); } });

            if (!allRequiredAnswered) {
                console.log("Submission check failed: Not all required questions answered.");
                 submitButton.disabled = false; submitButton.textContent = 'Submit Final Assessment';
                 // ... (scroll to first error logic) ...
                 const firstError = form.querySelector('.invalid'); if (firstError) { firstError.scrollIntoView({ behavior: 'smooth', block: 'center' }); const focusTarget = firstError.tagName === 'FIELDSET' ? firstError.querySelector('input, textarea') : firstError; if(focusTarget) focusTarget.focus(); }
                 alert("Please ensure all required questions have saved answers before submitting.");
                 return; // Stop submission
            }

            // --- All Valid: Proceed with Supabase Update ---
            console.log("All required questions answered. Finalizing submission.");
            submitButton.textContent = 'Submitting...';
            currentUser = getLocalStorageUser(); // Get fresh data
            if (!currentUser) { /* ... Error handling ... */ alert("Error submitting. User data not found."); submitButton.disabled = false; submitButton.textContent = 'Submit Final Assessment'; return; }

            currentUser.finalAssessmentCompleted = true; // Mark as completed locally
            if (!currentUser.progress) { currentUser.progress = {}; }
            currentUser.progress[FINAL_ASSESSMENT_ID] = 100;

            // --- Attempt to save final state to Supabase ---
            const success = await updateSupabaseAssessmentData();

            if (success) {
                saveCurrentUser(currentUser); // Save final state locally
                updateProgressIndicator(); // Ensure progress is 100%
                disableFormAndShowCompletion(100); // Show completion popup
            } else {
                // Supabase update failed!
                alert("Failed to save final submission to the server. Please try again. Your progress is saved locally.");
                // Revert local completion status? Or let user try again?
                currentUser.finalAssessmentCompleted = false; // Revert local status
                currentUser.progress[FINAL_ASSESSMENT_ID] = currentUser.progress[FINAL_ASSESSMENT_ID] === 100 ? 99 : (currentUser.progress[FINAL_ASSESSMENT_ID] || 0); // Revert progress slightly if needed
                submitButton.disabled = false; // Re-enable button
                submitButton.textContent = 'Submit Final Assessment';
            }
        }


        // --- Disable Form & Show Popup (No Changes needed) ---
        function disableFormAndShowCompletion(percentage = 100) { /* ... Keep existing implementation ... */ const form = document.getElementById('finalAssessmentForm'); const submitButton = document.getElementById('finalSubmitBtn'); const completePopup = document.getElementById('assessmentCompletePopup'); const completionOverlay = document.getElementById('completionPopupOverlay'); const scoreTextElement = document.getElementById('completionScoreText'); if(form) { form.querySelectorAll('textarea, input, button, fieldset').forEach(el => el.disabled = true); } if (submitButton) { submitButton.textContent = 'Assessment Submitted'; submitButton.disabled = true; } if (completePopup && completionOverlay && scoreTextElement) { scoreTextElement.textContent = `Your completion score: ${percentage}%`; completePopup.style.display = 'block'; completionOverlay.style.display = 'block'; } else { console.error("Completion popup elements not found!"); } }


        // --- Feedback Button Listener (No Changes needed) ---
        function setupFeedbackButtonListener() { /* ... Keep existing implementation ... */ const button = document.getElementById('proceedToFeedbackBtn'); const popup = document.getElementById('assessmentCompletePopup'); const overlay = document.getElementById('completionPopupOverlay'); if(button && popup && overlay) { button.addEventListener('click', () => { popup.style.display = 'none'; overlay.style.display = 'none'; console.log("Redirecting to feedback page:", FEEDBACK_URL); window.location.href = FEEDBACK_URL; }); } else { console.warn("Could not find all elements for feedback button listener."); } }

    </script>
</body>
</html>
