<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Assessment - Coaching & Leadership</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <style>
        /* --- Base Styles (Consistent) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f8fafc; margin: 0; padding: 0; line-height: 1.6; color: #374151; display: flex; flex-direction: column; min-height: 100vh; padding-top: 62px; /* Space for fixed header */ }
        main { flex-grow: 1; display: flex; justify-content: center; align-items: flex-start; flex-direction: column; width: 100%; max-width: 1000px; margin: 20px auto; padding: 0 20px; }

        /* User Bar (Consistent) */
        .user-bar { background-color: #34495e; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; color: white; font-size: 14px; position: fixed; top: 0; left: 0; width: 100%; z-index: 1001; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-info svg { opacity: 0.8; vertical-align: middle; color: white; }
        .user-details-bar { display: flex; flex-direction: column; }
        .user-name-bar { font-weight: 600; font-size: 14px; color: white; }
        .user-email-bar { font-size: 12px; opacity: 0.8; color: white; }
        .logout-button { background-color: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 6px; font-size: 13px; }
        .logout-button:hover { background-color: #c0392b; transform: translateY(-1px); }
        .logout-button svg { color: white; }

        /* Footer (Consistent) */
        .footer { text-align: center; padding: 25px 30px; background: #f9fafb; color: #6b7280; margin-top: auto; font-size: 14px; width: 100%; border-top: 1px solid #e5e7eb; }

        /* --- Final Assessment & Form Styles (Consistent) --- */
        .assessment-container {
            background: white;
            padding: 35px 45px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            width: 100%;
            margin-bottom: 35px;
            text-align: left;
            opacity: 0; /* Start hidden for fade-in */
            transition: opacity 0.7s ease-in-out;
            border: 1px solid #e5e7eb;
            display: none; /* Initially hidden until access check passes */
        }
        .assessment-container.fade-in { opacity: 1; } /* Class to trigger fade-in */

        .assessment-container h2 { color: #1f2937; margin-bottom: 25px; font-size: 28px; font-weight: 600; border-bottom: 1px solid #e5e7eb; padding-bottom: 15px; }
        .assessment-intro { background-color: #eff6ff; border-left: 5px solid #3b82f6; padding: 18px 25px; margin-bottom: 30px; border-radius: 6px; font-size: 16px; color: #374151; line-height: 1.7; }
        .assessment-intro strong { color: #1e40af; }
        #adminAssessmentNote { font-weight: bold; color: #b45309; display: none; /* Shown only for admin */ }
        #finalAssessmentForm .form-group { margin-bottom: 35px; }
        #finalAssessmentForm label { display: block; margin-bottom: 12px; font-weight: 600; color: #374151; font-size: 18px; }
        #finalAssessmentForm textarea, #finalAssessmentForm input[type="number"] { width: 100%; padding: 14px 16px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; transition: border-color 0.3s, box-shadow 0.3s; color: #1f2937; }
        #finalAssessmentForm textarea { min-height: 140px; resize: vertical; }
        #finalAssessmentForm textarea:focus, #finalAssessmentForm input[type="number"]:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); outline: none; }
        .form-group.situational { border-left: 3px solid #f59e0b; padding-left: 15px; background-color: #fffbeb; border-radius: 4px; padding-top: 15px; padding-right: 15px; padding-bottom: 5px;}
        .form-group.reflection { border-left: 3px solid #10b981; padding-left: 15px; background-color: #f0fdf4; border-radius: 4px; padding-top: 15px; padding-right: 15px; padding-bottom: 5px;}
        .form-group.evaluation { border-left: 3px solid #6366f1; padding-left: 15px; background-color: #eef2ff; border-radius: 4px; padding-top: 15px; padding-right: 15px; padding-bottom: 5px;}
        #finalAssessmentForm .input-meta-info { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
        #finalAssessmentForm .word-count-info { font-size: 13px; color: #6b7280; }
        #finalAssessmentForm .paste-warning { font-size: 13px; color: #f97316; display: none; }
        #finalAssessmentForm .error-message { color: #ef4444; font-size: 14px; margin-top: 8px; display: none; font-weight: 500;}
        #finalAssessmentForm input.invalid, #finalAssessmentForm textarea.invalid { border-color: #ef4444; }
        #submissionProgressContainer { width: 100%; height: 10px; background-color: #e5e7eb; border-radius: 5px; overflow: hidden; margin: 20px 0 30px 0; display: none; }
        #submissionProgressBar { width: 0%; height: 100%; background: linear-gradient(90deg, #a78bfa, #7c3aed); border-radius: 5px; transition: width 0.4s ease-out; }
        #finalSubmitBtn { background-color: #7c3aed; color: white; padding: 14px 30px; border: none; border-radius: 8px; font-size: 17px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        #finalSubmitBtn:hover { background-color: #6d28d9; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(124, 58, 237, 0.25); }
        #finalSubmitBtn:disabled { background-color: #9ca3af; cursor: not-allowed; transform: none; box-shadow: none;}

        /* Completion Popup Styles */
        #assessmentCompletePopup {
            display: none; /* Hidden initially */
            position: fixed;
            left: 50%; top: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 45px 50px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            z-index: 1002; /* Above overlay */
            text-align: center;
            border-top: 6px solid #7c3aed;
            min-width: 350px;
         }
        #assessmentCompletePopup p { font-size: 19px; color: #374151; margin-bottom: 30px; line-height: 1.6; } /* Default P style */
        #assessmentCompletePopup button { background-color: #3b82f6; color: white; padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; font-size: 17px; transition: background-color 0.3s; font-weight: 500; }
        #assessmentCompletePopup button:hover { background-color: #2563eb; }
         .popup-overlay { /* Only for completion popup */
             display: none; /* Hidden initially */
             position: fixed;
             top: 0; left: 0;
             width: 100%; height: 100%;
             background-color: rgba(0,0,0,0.6);
             z-index: 1001; /* Below popup, above content */
         }


        /* --- Access Denied Modal Styles (Centering & Appearance) --- */
         .modal-overlay { /* This is the outer div (#accessDeniedModal) */
             position: fixed; top: 0; left: 0; width: 100%; height: 100%;
             background: rgba(0,0,0,0.65); /* Darker overlay */
             /* Flexbox for centering */
             display: none; /* Initially hidden, shown via JS if access denied */
             align-items: center; /* Vertical centering */
             justify-content: center; /* Horizontal centering */
             /* Stacking */
             z-index: 9999; /* Highest z-index */
             cursor: pointer; /* Allow clicking overlay to close (handled in JS) */
             padding: 20px; /* Prevent content touching edges */
         }
         .modal-content-box { /* This is the inner div holding the message */
             background: white;
             border-radius: 12px;
             padding: 35px 40px;
             max-width: 450px;
             width: 95%;
             text-align: center;
             box-shadow: 0 10px 30px rgba(0,0,0,0.25);
             cursor: default; /* Reset cursor for the box */
             border-top: 5px solid #e74c3c; /* Red top border */
         }
         .modal-content-box h2 { /* Contains icon and text */
             color: #e74c3c;
             margin-bottom: 18px;
             font-size: 1.5rem;
             display: flex;
             align-items: center;
             justify-content: center;
             gap: 8px;
         }
         .modal-content-box p { /* The denial message */
             margin-bottom: 28px;
             color: #374151;
             font-size: 1.05rem;
             line-height: 1.6;
         }
         .modal-content-box button { /* The "Go Back" button */
             background-color: #3498db; /* Blue button */
             color: white;
             padding: 11px 25px;
             border: none;
             border-radius: 8px;
             cursor: pointer;
             font-size: 1rem;
             font-weight: 500;
             transition: background-color 0.3s ease;
         }
         .modal-content-box button:hover {
             background-color: #2980b9;
         }

        /* Loading / Initial Message */
         #loadingOrAccessMessage {
             text-align: center;
             padding: 60px 20px;
             font-size: 20px;
             color: #6b7280;
             width: 100%;
             /* This will be hidden by JS if access is denied or granted */
          }

        /* Responsive Adjustments */
         @media (max-width: 768px) {
            body { padding-top: 62px; }
            main { padding: 0 15px; margin: 15px auto; }
            .assessment-container { padding: 25px 30px; }
            .user-bar { padding: 10px 20px; }
         }
         @media (max-width: 600px) {
            .assessment-container { padding: 20px; }
            #finalAssessmentForm textarea { min-height: 120px; }
            #finalAssessmentForm label { font-size: 17px; }
            #finalAssessmentForm input[type="number"], #finalAssessmentForm textarea { padding: 12px 14px; font-size: 15px; }
            #finalSubmitBtn { padding: 12px 25px; font-size: 16px; }
            .form-group.situational, .form-group.reflection, .form-group.evaluation { padding-left: 10px; padding-right: 10px; }
            #assessmentCompletePopup { width: 90%; padding: 30px 25px; }
            /* Access Denied Modal adjustments */
            .modal-content-box { padding: 25px 20px; }
            .modal-content-box h2 { font-size: 1.3rem; }
            .modal-content-box p { font-size: 1rem; }
            .modal-content-box button { padding: 10px 20px; font-size: 0.95rem;}
        }
    </style>
</head>
<body>
    <!-- User Bar -->
    <div class="user-bar">
        <div class="user-info">
             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            <div class="user-details-bar">
                <span class="user-name-bar" id="userNameBar">Loading...</span>
                <span class="user-email-bar" id="userEmailBar"></span>
            </div>
        </div>
        <button class="logout-button" onclick="logout()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
            Logout
        </button>
    </div>

    <!-- Access Denied Modal HTML (Message is predefined) -->
    <div id="accessDeniedModal" class="modal-overlay" style="display: none;">
      <!-- Outer div overlay -->
      <div class="modal-content-box" onclick="event.stopPropagation()">
          <!-- Inner content box -->
          <h2>🚫 Access Denied</h2>
          <p> <!-- This message is shown when access is denied -->
              You need to complete all course modules before taking the final assessment.
          </p>
          <button onclick="goBackToNext()"> <!-- Button redirects user -->
              Go Back
          </button>
      </div>
    </div>


    <!-- Main Content Area -->
    <main>
        <!-- Initial message shown before content loads or if access denied initially -->
        <div id="loadingOrAccessMessage">Loading Assessment...</div>

        <!-- Final Assessment Container (Hidden initially by CSS, shown by JS if access granted) -->
        <section id="assessmentContainer" class="assessment-container">
             <h2>Post-Course Reflection</h2>
            <p class="assessment-intro">
                <strong>Congratulations on completing the core modules!</strong> This final assessment helps you reflect on your learning and how you'll apply it. Please answer thoughtfully and honestly in your own words.
                <span id="adminAssessmentNote"> (Admin: Word count and paste restrictions are disabled for your account.)</span>
            </p>

            <form id="finalAssessmentForm" novalidate>
                <!-- Form Group: Situational 1 -->
                 <div class="form-group situational">
                     <label for="q_situational_disengaged">Scenario: You notice a team member who seems consistently disengaged during coaching sessions. They give short answers and avoid eye contact.</label>
                     <textarea id="q_situational_disengaged" name="situational_disengaged" required data-min-words="30" placeholder="Outline your approach to address this situation in the next session. What specific techniques might you use?"></textarea>
                     <div class="input-meta-info">
                         <div class="paste-warning" id="q_situational_paste_warning">Pasting...</div>
                         <div class="word-count-info" id="q_situational_word_count_container">Words: <span id="q_situational_word_count">0</span><span>/30</span></div>
                     </div>
                     <div class="error-message" id="q_situational_error"></div>
                 </div>

                 <!-- Form Group: Situational 2 -->
                 <div class="form-group situational">
                     <label for="q_situational_feedback">Scenario: You need to provide constructive feedback to a high-performing team member about a minor but recurring communication issue.</label>
                     <textarea id="q_situational_feedback" name="situational_feedback" required data-min-words="30" placeholder="Describe your feedback process using a recognized model (e.g., SBI, STAR). How will you ensure the feedback lands effectively?"></textarea>
                     <div class="input-meta-info">
                         <div class="paste-warning" id="q_feedback_paste_warning">Pasting...</div>
                         <div class="word-count-info" id="q_feedback_word_count_container">Words: <span id="q_feedback_word_count">0</span><span>/30</span></div>
                     </div>
                     <div class="error-message" id="q_feedback_error"></div>
                 </div>

                 <!-- Form Group: Reflection 1 -->
                 <div class="form-group reflection">
                     <label for="q_reflection_skill">What’s one specific coaching skill (e.g., active listening, powerful questioning, goal setting) you feel you've significantly improved through this course?</label>
                     <textarea id="q_reflection_skill" name="reflection_skill_improved" required data-min-words="30" placeholder="Identify the skill and provide a specific example of how you might apply it differently now compared to before the course."></textarea>
                     <div class="input-meta-info">
                         <div class="paste-warning" id="q_skill_paste_warning">Pasting...</div>
                         <div class="word-count-info" id="q_skill_word_count_container">Words: <span id="q_skill_word_count">0</span><span>/30</span></div>
                     </div>
                     <div class="error-message" id="q_skill_error"></div>
                 </div>

                 <!-- Form Group: Reflection 2 -->
                 <div class="form-group reflection">
                     <label for="q_reflection_challenge">Reflecting on the course material, what was the most challenging concept or technique for you to grasp or consider implementing?</label>
                     <textarea id="q_reflection_challenge" name="reflection_challenge" required data-min-words="30" placeholder="Discuss your biggest challenge and outline one step you plan to take to overcome it or practice it further."></textarea>
                     <div class="input-meta-info">
                         <div class="paste-warning" id="q_challenge_paste_warning">Pasting...</div>
                         <div class="word-count-info" id="q_challenge_word_count_container">Words: <span id="q_challenge_word_count">0</span><span>/30</span></div>
                     </div>
                     <div class="error-message" id="q_challenge_error"></div>
                 </div>

                 <!-- Form Group: Evaluation -->
                 <div class="form-group evaluation">
                     <label for="q_eval_confidence_rating">On a scale of 1 (Not confident) to 5 (Very confident), how confident do you feel in applying the coaching principles learned in this course *after* completing it?</label>
                     <input type="number" id="q_eval_confidence_rating" name="evaluation_confidence_rating" required min="1" max="5" step="1" placeholder="Enter 1-5">
                     <div class="error-message" id="q_eval_rating_error"></div>

                     <label for="q_eval_confidence_explanation" style="margin-top: 15px;">Briefly explain your rating.</label>
                     <textarea id="q_eval_confidence_explanation" name="evaluation_confidence_explanation" required data-min-words="25" placeholder="Explain your confidence level. What contributed most to this feeling?"></textarea>
                     <div class="input-meta-info">
                         <div class="paste-warning" id="q_eval_exp_paste_warning">Pasting...</div>
                         <div class="word-count-info" id="q_eval_exp_word_count_container">Words: <span id="q_eval_exp_word_count">0</span><span>/25</span></div>
                     </div>
                     <div class="error-message" id="q_eval_exp_error"></div>
                 </div>

                 <!-- Validation Warning Box (Hidden Initially) -->
                 <div id="validationWarningBox" style="display: none; border: 1px solid #f56565; background-color: #fff5f5; color: #c53030; padding: 15px 20px; margin-bottom: 25px; border-radius: 8px; font-weight: 500;">
                     <span style="font-size: 1.2em; margin-right: 8px;">⚠️</span>
                     <span id="validationWarningMessage">You must answer all the questions before submitting the assessment.</span>
                 </div>

                 <!-- Submission Progress Bar -->
                 <div id="submissionProgressContainer">
                     <div id="submissionProgressBar"></div>
                 </div>

                 <!-- Submit Button -->
                <button type="submit" id="finalSubmitBtn">Submit Final Assessment</button>
            </form>
        </section>

        <!-- Completion Popup -->
        <div class="popup-overlay" id="completionPopupOverlay"></div>
        <div id="assessmentCompletePopup">
             <p style="font-size: 22px; margin-bottom: 20px;">🎉</p> <!-- Emoji for flair -->
             <p style="font-size: 1.1rem; color: #374151; margin-bottom: 25px; line-height: 1.6;">
                 Thank you for completing the final assessment.<br>We appreciate your effort throughout the course.
             </p>
             <div id="feedbackPlaceholder" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; color: #6b7280; font-size: 0.95rem;">
                 <span style="font-size: 1.3em; margin-right: 8px; vertical-align: middle;">💬</span>
                 <span style="vertical-align: middle;">We'd love your feedback! [Feedback form coming soon]</span>
             </div>
             <button id="closeCompletePopupBtn" style="margin-top: 35px;">Return to Dashboard</button>
        </div>

    </main>

    <!-- Footer -->
    <footer class="footer">
        © 2025 Elmenisy Leadership Coaching - All Rights Reserved
    </footer>

    <script>
        // --- Constants ---
        const LOGGED_IN_KEY = 'isUserLoggedIn';
        const CURRENT_USER_KEY = 'currentUser';
        const ADMIN_EMAIL = 'm.elsayed@thechefz.co'; // IMPORTANT: Set the correct admin email
        const FINAL_ASSESSMENT_ID = 'final_assessment';
        const DASHBOARD_URL = 'questiondashboard.html';
        const WHATS_NEXT_URL = 'whats-next.html'; // URL to redirect incomplete users
        const requiredCourseSections = [
            { id: 'index' }, { id: 'article1' }, { id: 'skills' },
            { id: 'individuals' }, { id: 'team' }, { id: 'self' }, { id: 'action' }
        ];

        // --- Globals ---
        let IS_ADMIN_USER = false; // Will be set during access check
        let currentUser = null; // Holds user data if access is granted

        // --- Get User Data Function ---
        function getLocalStorageUser() {
            try {
                const userDataString = localStorage.getItem(CURRENT_USER_KEY);
                if (!userDataString) return null;
                const parsedUser = JSON.parse(userDataString);
                if (parsedUser && typeof parsedUser === 'object' && parsedUser.name && parsedUser.email && parsedUser.progress) {
                    return parsedUser;
                }
                console.warn("Invalid user data structure in localStorage.");
                return null;
            } catch (error) {
                console.error("Error parsing user data:", error);
                return null;
            }
        }

        // --- **MODIFIED** IMMEDIATE ACCESS CONTROL (Self-Executing Function) ---
        (function checkAccess() {
            console.log("%cRunning IMMEDIATE access check...", "color: orange; font-weight: bold;");
            const isLoggedIn = localStorage.getItem(LOGGED_IN_KEY) === 'true';
            const user = getLocalStorageUser();

            // 1. Basic Login & User Data Check
            if (!isLoggedIn || !user || !user.progress) {
                 console.warn("Redirecting to login: User not logged in or data invalid.");
                 window.location.replace('login.html');
                 throw new Error("Redirecting user: Not logged in or invalid data. Halting script.");
            }

            // 2. Determine if user is Admin *early*
            const isAdmin = user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
            IS_ADMIN_USER = isAdmin; // Set global variable for use elsewhere

            // 3. Handle Admin Access
            if (isAdmin) {
                console.log("%cAdmin Access Granted: Bypassing module completion checks.", "color: blue; font-weight: bold;");
                currentUser = user; // Grant access by setting the global user object
                // Admin access granted, no need for further checks here. Script continues.
            }
            // 4. Handle Non-Admin Access (Requires Module Check)
            else {
                console.log("%cNon-Admin User: Checking module completion...", "color: orange;");
                let allSectionsComplete = true;
                for (const section of requiredCourseSections) {
                    if ((user.progress[section.id] || 0) < 100) { // Check progress, default to 0 if missing
                        allSectionsComplete = false;
                        console.warn(`Non-admin incomplete: Section '${section.id}' (Progress: ${user.progress[section.id] || 0})`);
                        break; // Stop checking once one incomplete section is found
                    }
                }

                // 4a. Non-Admin & Incomplete -> Deny Access, Show Modal
                if (!allSectionsComplete) {
                    console.warn("%cAccess Denied for Non-Admin: Course not fully completed. Showing Modal.", "color: red; font-weight: bold;");

                    // Hide potential background content immediately
                    const loadingMsg = document.getElementById('loadingOrAccessMessage');
                    const assessmentContainer = document.getElementById('assessmentContainer');
                    if (loadingMsg) loadingMsg.style.display = 'none';
                    if (assessmentContainer) assessmentContainer.style.display = 'none';

                    // Show the "Access Denied" modal
                    const modal = document.getElementById('accessDeniedModal');
                    if (modal) {
                        modal.style.display = 'flex'; // Use flex to activate centering CSS
                        // NOTE: Redirection happens when the user clicks the button in the modal,
                        // which calls the globally defined goBackToNext() function.
                    } else {
                        console.error("Access Denied Modal element (#accessDeniedModal) not found!");
                        // Fallback if modal isn't found
                        alert("Access Denied: Please complete all course modules.");
                        window.location.href = WHATS_NEXT_URL; // Redirect immediately as fallback
                    }

                    // Stop further script execution for this page load
                    throw new Error("Stopping script: Non-admin user has not completed required modules.");
                }
                // 4b. Non-Admin & Complete -> Grant Access
                else {
                    console.log("%cNon-Admin Access Granted: All modules completed.", "color: green; font-weight: bold;");
                    currentUser = user; // Grant access by setting the global user object
                    // Script continues.
                }
            }

            // If the script reaches this point, access has been granted (either admin or completed non-admin)
            console.log("%cAccess Check Complete: Proceeding with page setup.", "color: green;");

        })();
        // --- END IMMEDIATE ACCESS CONTROL ---


        // --- DOMContentLoaded Event Listener ---
        // Runs ONLY if the checkAccess function did not throw an error
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM fully loaded. Setting up assessment page.");

            // This check is important. If access was denied, currentUser would be null.
            if (!currentUser) {
                 console.error("DOM Load Error: currentUser is null. Access was likely denied earlier. Aborting page setup.");
                 // Make sure content is hidden and maybe show error message
                 const loadingMsg = document.getElementById('loadingOrAccessMessage');
                 if (loadingMsg) loadingMsg.textContent = 'Page setup aborted due to access restrictions.';
                 const assessmentContainer = document.getElementById('assessmentContainer');
                 if (assessmentContainer) assessmentContainer.style.display = 'none';
                 return; // Stop execution
            }

            // --- Element References ---
            const loadingMsg = document.getElementById('loadingOrAccessMessage');
            const assessmentContainer = document.getElementById('assessmentContainer');
            const assessmentForm = document.getElementById('finalAssessmentForm');
            const completePopup = document.getElementById('assessmentCompletePopup');
            const completionOverlay = document.getElementById('completionPopupOverlay');
            const closeCompletePopupButton = document.getElementById('closeCompletePopupBtn');
            const submitButton = document.getElementById('finalSubmitBtn');
            const accessDeniedModal = document.getElementById('accessDeniedModal'); // For closing logic

            // --- Populate Top Bar ---
            populateTopBar(currentUser);

            // --- Setup Form & Check Completion Status ---
            setupFinalAssessmentForm(); // Includes admin-specific logic now
            const alreadyCompleted = currentUser.finalAssessmentCompleted || currentUser.progress[FINAL_ASSESSMENT_ID] === 100;

             if (alreadyCompleted) {
                console.log("Assessment already completed by this user. Disabling form.");
                 assessmentForm.querySelectorAll('textarea, input[type="number"], button').forEach(el => el.disabled = true);
                 submitButton.textContent = 'Assessment Submitted';
                 const introNote = assessmentContainer.querySelector('.assessment-intro');
                 if(introNote) {
                     const completedNote = document.createElement('p');
                     completedNote.innerHTML = '<strong>Note:</strong> You have already completed and submitted this assessment.';
                     completedNote.style.cssText = 'margin-top: 15px; font-weight: 500; color: #7c3aed;';
                     introNote.appendChild(completedNote);
                 }
             } else {
                 assessmentForm.addEventListener('submit', handleFinalAssessmentSubmit);
             }

            // --- Show Assessment Content (Access was granted) ---
            if (loadingMsg) loadingMsg.style.display = 'none';
            if (assessmentContainer) {
                assessmentContainer.style.display = 'block';
                setTimeout(() => assessmentContainer.classList.add('fade-in'), 50);
            }

            // --- Completion Popup Close Button ---
             if (closeCompletePopupButton && completePopup && completionOverlay) {
                 closeCompletePopupButton.addEventListener('click', () => {
                     completePopup.style.display = 'none';
                     completionOverlay.style.display = 'none';
                     window.location.href = DASHBOARD_URL;
                 });
             }

            // --- Access Denied Modal Closing Logic Setup ---
            // This listener is added, but will only be relevant if the modal
            // was somehow shown *after* the initial check (less likely now).
            // The primary closing mechanism for denied access is the button click.
            if (accessDeniedModal) {
              accessDeniedModal.addEventListener('click', function (event) {
                  if (event.target === accessDeniedModal) {
                     goBackToNext(); // Redirect if overlay is clicked
                  }
              });
            }

        }); // End DOMContentLoaded

        // *** Define goBackToNext function globally ***
        // Needs to be global for the inline onclick="goBackToNext()" in the modal button HTML
        function goBackToNext() {
            console.log("Redirecting user to required completion page:", WHATS_NEXT_URL);
            window.location.href = WHATS_NEXT_URL;
        }


        // --- Helper Functions ---

        function saveCurrentUser(userObject) {
            try {
                if (!userObject) throw new Error("Cannot save invalid user object.");
                localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(userObject));
                console.log("User data saved:", userObject);
            } catch (error) {
                console.error("Error saving user data:", error);
            }
        }

        function populateTopBar(user) {
            const userNameElement = document.getElementById('userNameBar');
            const userEmailElement = document.getElementById('userEmailBar');
            if (user && userNameElement && userEmailElement) {
                userNameElement.textContent = user.name || 'User';
                userEmailElement.textContent = user.email;
            } else {
                if(userNameElement) userNameElement.textContent = 'N/A';
                if(userEmailElement) userEmailElement.textContent = 'N/A';
            }
        }

        function countWords(text) {
            return text ? text.trim().split(/\s+/).filter(Boolean).length : 0;
        }

        // MODIFIED: Word count validation should still be bypassed for admin *during input*,
        // but the 'required' check during final submission should apply to all.
        function validateWordCount(textarea, minWords, errorElement /*, isAdmin - removed */) {
            // If admin, we DON'T show inline errors during typing, but the submit handler *might* still check if required.
            // This function primarily controls the *inline* feedback during typing.
            if (IS_ADMIN_USER || isNaN(minWords)) {
                if (errorElement) errorElement.style.display = 'none';
                textarea.classList.remove('invalid');
                return true; // Always return true for admin *here* to avoid inline errors
            }
            // For non-admins, perform the check as before
            const words = countWords(textarea.value);
            const isFieldEmpty = !textarea.value.trim();
            if (!isFieldEmpty && words < minWords) {
                errorElement.textContent = `Minimum ${minWords} words required.`;
                errorElement.style.display = 'block';
                textarea.classList.add('invalid');
                return false;
            } else {
                errorElement.style.display = 'none';
                textarea.classList.remove('invalid');
                return true;
            }
        }

        // Modified slightly to use the global IS_ADMIN_USER
        function setupWordCountValidation(textarea, countSpan, errorElement, countContainer /*, isAdmin - removed */) {
            const minWords = parseInt(textarea.getAttribute('data-min-words'), 10);
            if (isNaN(minWords)) return;

            if (IS_ADMIN_USER) { // Use global variable
                if(countContainer) countContainer.style.display = 'none';
                return;
            }

            const minWordsDisplay = countContainer.querySelector('span + span');
             if (minWordsDisplay) minWordsDisplay.textContent = `/${minWords}`;

            textarea.addEventListener('input', () => {
                const words = countWords(textarea.value);
                countSpan.textContent = words;
                validateWordCount(textarea, minWords, errorElement /*, IS_ADMIN_USER - removed */);
            });
            // Initial check
            validateWordCount(textarea, minWords, errorElement /*, IS_ADMIN_USER - removed */);
        }

        // Modified slightly to use the global IS_ADMIN_USER
        function setupPastePrevention(textarea, warningElement /*, isAdmin - removed */) {
            if (!IS_ADMIN_USER) { // Use global variable
                textarea.addEventListener('paste', (event) => {
                    event.preventDefault();
                    warningElement.textContent = 'Pasting content is disabled.';
                    warningElement.style.display = 'block';
                    setTimeout(() => { warningElement.style.display = 'none'; }, 4000);
                });
            } else {
                warningElement.style.display = 'none'; // Ensure it's hidden for admin
            }
        }

        // Modified slightly to use the global IS_ADMIN_USER
        function setupFinalAssessmentForm() {
            const form = document.getElementById('finalAssessmentForm');
            if (!form) return;
            const textareas = form.querySelectorAll('textarea[data-min-words]');

            if (IS_ADMIN_USER) { // Use global variable
                const adminNote = document.getElementById('adminAssessmentNote');
                if (adminNote) adminNote.style.display = 'inline';
                textareas.forEach(ta => ta.placeholder = "Admin Mode: No restrictions.");
                // Hide word count display for admin
                form.querySelectorAll('.word-count-info').forEach(el => el.style.display = 'none');
            } else {
                textareas.forEach(ta => {
                    const min = ta.getAttribute('data-min-words');
                    if (min) ta.placeholder += ` (Minimum ${min} words)`;
                });
            }

            // Setup listeners for all textareas (word count and paste)
            form.querySelectorAll('textarea').forEach(ta => {
                const baseId = ta.id;
                const countSpan = document.getElementById(`${baseId}_word_count`);
                const errorElement = document.getElementById(`${baseId}_error`);
                const countContainer = document.getElementById(`${baseId}_word_count_container`);
                const pasteWarning = document.getElementById(`${baseId}_paste_warning`);

                if (ta.hasAttribute('data-min-words') && countSpan && errorElement && countContainer) {
                     setupWordCountValidation(ta, countSpan, errorElement, countContainer);
                }
                if (pasteWarning) {
                     setupPastePrevention(ta, pasteWarning);
                }
             });

            // Setup for number input (remains the same logic, applies to all)
             const ratingInput = form.querySelector('#q_eval_confidence_rating');
             const ratingError = form.querySelector('#q_eval_rating_error');
             if (ratingInput && ratingError) {
                 ratingInput.addEventListener('input', () => {
                     const val = parseInt(ratingInput.value, 10);
                     const min = parseInt(ratingInput.min, 10);
                     const max = parseInt(ratingInput.max, 10);
                     if (ratingInput.value && (isNaN(val) || val < min || val > max)) {
                          ratingError.textContent = `Please enter a number between ${min} and ${max}.`;
                          ratingError.style.display = 'block';
                          ratingInput.classList.add('invalid');
                     } else {
                          ratingError.style.display = 'none';
                          ratingInput.classList.remove('invalid');
                     }
                 });
             }
        }

        // --- MODIFIED Submission Handler ---
        function handleFinalAssessmentSubmit(event) {
            event.preventDefault();
            console.log("Final Assessment submission initiated...");
            const form = event.target;
            const submitButton = document.getElementById('finalSubmitBtn');
            const progressContainer = document.getElementById('submissionProgressContainer');
            const progressBar = document.getElementById('submissionProgressBar');
            const completionOverlay = document.getElementById('completionPopupOverlay');
            const completePopup = document.getElementById('assessmentCompletePopup');
            // --- Get references to the new warning box ---
            const validationWarningBox = document.getElementById('validationWarningBox');
            const validationWarningMessage = document.getElementById('validationWarningMessage'); // Specific span for message text if needed, otherwise use the box itself.

            // --- Hide warning box at the start of every submission attempt ---
            if (validationWarningBox) validationWarningBox.style.display = 'none';

            submitButton.disabled = true;
            submitButton.textContent = 'Validating...'; // Changed text
            if(progressContainer) progressContainer.style.display = 'block'; // Show progress bar during validation
            if(progressBar) progressBar.style.width = '10%'; // Initial progress

            form.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            form.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));

            let isValid = true;
            let firstInvalidElement = null; // To focus later if needed

            const inputs = {
                situational_disengaged: form.querySelector('#q_situational_disengaged'),
                situational_feedback: form.querySelector('#q_situational_feedback'),
                reflection_skill: form.querySelector('#q_reflection_skill'),
                reflection_challenge: form.querySelector('#q_reflection_challenge'),
                evaluation_confidence_rating: form.querySelector('#q_eval_confidence_rating'),
                evaluation_confidence_explanation: form.querySelector('#q_eval_confidence_explanation')
            };
            const errors = {
                situational_disengaged: form.querySelector('#q_situational_error'),
                situational_feedback: form.querySelector('#q_feedback_error'),
                reflection_skill: form.querySelector('#q_skill_error'),
                reflection_challenge: form.querySelector('#q_challenge_error'),
                evaluation_confidence_rating: form.querySelector('#q_eval_rating_error'),
                evaluation_confidence_explanation: form.querySelector('#q_eval_exp_error')
            };

            let validationProgress = 10;
            const totalFields = Object.keys(inputs).length;
            const progressIncrement = Math.floor(80 / totalFields); // Leave some room for final steps

            // --- VALIDATION LOOP (Applies to ALL users for 'required' and 'range') ---
            for (const key in inputs) {
                const input = inputs[key];
                const errorEl = errors[key];
                if (!input) continue;

                let fieldValid = true;
                const isRequired = input.hasAttribute('required');

                // Check if the field is required and empty (APPLIES TO ADMINS TOO)
                if (isRequired && !input.value.trim()) {
                    errorEl.textContent = 'This field is required.';
                    errorEl.style.display = 'block';
                    input.classList.add('invalid');
                    fieldValid = false;
                }
                // Check number range validity (APPLIES TO ADMINS TOO)
                else if (input.type === 'number') {
                    const val = parseInt(input.value, 10);
                    const min = parseInt(input.min, 10);
                    const max = parseInt(input.max, 10);
                    // Check required AND range if value exists
                    if (isRequired && !input.value) { // Separate check for empty required number
                         errorEl.textContent = 'This field is required.';
                         errorEl.style.display = 'block';
                         input.classList.add('invalid');
                         fieldValid = false;
                    } else if (input.value && (isNaN(val) || val < min || val > max)) { // Check range only if not empty
                        errorEl.textContent = `Please enter a valid rating between ${min} and ${max}.`;
                        errorEl.style.display = 'block';
                        input.classList.add('invalid');
                        fieldValid = false;
                    }
                }
                // Check word count ONLY IF NOT ADMIN and field has min-words attribute and is not empty
                else if (!IS_ADMIN_USER && input.type === 'textarea' && input.hasAttribute('data-min-words') && input.value.trim()) {
                     const minWords = parseInt(input.getAttribute('data-min-words'), 10);
                     const words = countWords(input.value);
                     if (words < minWords) {
                         errorEl.textContent = `Minimum ${minWords} words required.`;
                         errorEl.style.display = 'block';
                         input.classList.add('invalid');
                         fieldValid = false;
                     }
                }

                 // Simulate validation progress
                validationProgress += progressIncrement;
                if(progressBar) progressBar.style.width = `${Math.min(validationProgress, 90)}%`;

                if (!fieldValid) {
                    isValid = false;
                    if (!firstInvalidElement) {
                        firstInvalidElement = input; // Track the first error element
                    }
                }
            } // End Validation Loop

            // --- Use setTimeout to simulate async validation and allow progress bar update ---
            setTimeout(() => {
                if (isValid) {
                    // --- SUCCESS PATH ---
                    console.log("Validation successful. Submitting...");
                    submitButton.textContent = 'Submitting...';
                    if(progressBar) progressBar.style.width = '100%';

                    let updatedUser = getLocalStorageUser();
                    if (!updatedUser) {
                        console.error("User data lost before saving.");
                        if (validationWarningBox) { // Show error in the warning box
                           validationWarningMessage.textContent = "Error: Could not retrieve user data. Please try logging out and back in.";
                           validationWarningBox.style.display = 'block';
                        } else {
                           alert("Error: Could not retrieve user data. Please try logging out and back in.");
                        }
                        submitButton.disabled = false;
                        submitButton.textContent = 'Submission Error - Try Again';
                        if(progressContainer) progressContainer.style.display = 'none';
                        return;
                    }

                    const finalAnswers = {};
                    for (const key in inputs) {
                        if(inputs[key]) {
                            finalAnswers[key] = inputs[key].value.trim();
                        }
                    }

                    updatedUser.finalAssessmentAnswers = finalAnswers;
                    updatedUser.finalAssessmentCompleted = true;
                    if (!updatedUser.progress) { updatedUser.progress = {}; }
                    updatedUser.progress[FINAL_ASSESSMENT_ID] = 100;

                    saveCurrentUser(updatedUser);

                    // Show the updated completion popup
                    if(completePopup) completePopup.style.display = 'block';
                    if(completionOverlay) completionOverlay.style.display = 'block';

                    // Hide progress bar after a short delay
                    setTimeout(() => {
                        if(progressContainer) progressContainer.style.display = 'none';
                         // Disable form elements again after successful submission
                         form.querySelectorAll('textarea, input[type="number"], button').forEach(el => el.disabled = true);
                         submitButton.textContent = 'Assessment Submitted';
                    }, 500);

                } else {
                    // --- VALIDATION FAILED PATH ---
                    console.log("Form validation failed.");
                    if(progressContainer) progressContainer.style.display = 'none'; // Hide progress bar
                    if(progressBar) progressBar.style.width = '0%'; // Reset progress

                    // Show the custom validation warning box
                    if (validationWarningBox) {
                        validationWarningMessage.textContent = '⚠️ You must answer all the required questions and correct any errors before submitting.'; // Slightly more specific message
                        validationWarningBox.style.display = 'block';
                    } else {
                        // Fallback if the box element wasn't found
                        alert("⚠️ You must answer all the required questions and correct any errors before submitting.");
                    }

                    submitButton.disabled = false; // Re-enable button
                    submitButton.textContent = 'Submit Final Assessment';

                    // Scroll to and focus the first invalid element
                    if (firstInvalidElement) {
                        firstInvalidElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // Add a slight delay before focus sometimes helps browser rendering
                        setTimeout(() => firstInvalidElement.focus(), 100);
                    }
                }
            }, 500); // Delay to simulate processing and show progress
        }

        function logout() {
            console.log("Logging out...");
            try {
                localStorage.removeItem(LOGGED_IN_KEY); localStorage.removeItem(CURRENT_USER_KEY);
                IS_ADMIN_USER = false; currentUser = null;
                window.location.href = 'login.html';
            } catch (e) { console.error("Logout error:", e); window.location.href = 'login.html'; }
        }

    </script>
</body>
</html>
