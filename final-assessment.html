<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Assessment - Coaching & Leadership</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <style>
        /* --- Base Styles (Consistent) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f8fafc; margin: 0; padding: 0; line-height: 1.6; color: #374151; display: flex; flex-direction: column; min-height: 100vh; padding-top: 62px; }
        main { flex-grow: 1; display: flex; justify-content: center; align-items: flex-start; flex-direction: column; width: 100%; max-width: 1000px; margin: 20px auto; padding: 0 20px; }
        /* User Bar (Consistent) */
        .user-bar { background-color: #34495e; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; color: white; font-size: 14px; position: fixed; top: 0; left: 0; width: 100%; z-index: 1001; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-info svg { opacity: 0.8; vertical-align: middle; color: white; }
        .user-details-bar { display: flex; flex-direction: column; }
        .user-name-bar { font-weight: 600; font-size: 14px; color: white; }
        .user-email-bar { font-size: 12px; opacity: 0.8; color: white; }
        .logout-button { background-color: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 6px; font-size: 13px; }
        .logout-button:hover { background-color: #c0392b; transform: translateY(-1px); }
        .logout-button svg { color: white; }
        .footer { text-align: center; padding: 25px 30px; background: #f9fafb; color: #6b7280; margin-top: auto; font-size: 14px; width: 100%; border-top: 1px solid #e5e7eb; }

        /* --- Final Assessment & Form Styles (Consistent) --- */
        .assessment-container { background: white; padding: 35px 45px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); border-radius: 12px; width: 100%; margin-bottom: 35px; text-align: left; opacity: 0; transition: opacity 0.7s ease-in-out; border: 1px solid #e5e7eb; display: none; /* Hidden until access check passes */ }
        .assessment-container.fade-in { opacity: 1; }
        .assessment-container h2 { color: #1f2937; margin-bottom: 25px; font-size: 28px; font-weight: 600; border-bottom: 1px solid #e5e7eb; padding-bottom: 15px; }
        .assessment-intro { background-color: #eff6ff; border-left: 5px solid #3b82f6; padding: 18px 25px; margin-bottom: 30px; border-radius: 6px; font-size: 16px; color: #374151; line-height: 1.7; }
         .assessment-intro strong { color: #1e40af; }
         #adminAssessmentNote { font-weight: bold; color: #b45309; display: none; }
        #finalAssessmentForm .form-group { margin-bottom: 35px; }
        #finalAssessmentForm label { display: block; margin-bottom: 12px; font-weight: 600; color: #374151; font-size: 18px; }
        #finalAssessmentForm textarea, #finalAssessmentForm input[type="number"] { width: 100%; padding: 14px 16px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; transition: border-color 0.3s, box-shadow 0.3s; color: #1f2937; }
        #finalAssessmentForm textarea { min-height: 140px; resize: vertical; }
        #finalAssessmentForm textarea:focus, #finalAssessmentForm input[type="number"]:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); outline: none; }
        .form-group.situational { border-left: 3px solid #f59e0b; padding-left: 15px; background-color: #fffbeb; border-radius: 4px; padding-top: 15px; padding-right: 15px; padding-bottom: 5px;}
        .form-group.reflection { border-left: 3px solid #10b981; padding-left: 15px; background-color: #f0fdf4; border-radius: 4px; padding-top: 15px; padding-right: 15px; padding-bottom: 5px;}
        .form-group.evaluation { border-left: 3px solid #6366f1; padding-left: 15px; background-color: #eef2ff; border-radius: 4px; padding-top: 15px; padding-right: 15px; padding-bottom: 5px;}
        #finalAssessmentForm .input-meta-info { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
        #finalAssessmentForm .word-count-info { font-size: 13px; color: #6b7280; }
        #finalAssessmentForm .paste-warning { font-size: 13px; color: #f97316; display: none; }
        #finalAssessmentForm .error-message { color: #ef4444; font-size: 14px; margin-top: 8px; display: none; font-weight: 500;}
        #finalAssessmentForm input.invalid, #finalAssessmentForm textarea.invalid { border-color: #ef4444; }
        #submissionProgressContainer { width: 100%; height: 10px; background-color: #e5e7eb; border-radius: 5px; overflow: hidden; margin: 20px 0 30px 0; display: none; }
        #submissionProgressBar { width: 0%; height: 100%; background: linear-gradient(90deg, #a78bfa, #7c3aed); border-radius: 5px; transition: width 0.4s ease-out; }
        #finalSubmitBtn { background-color: #7c3aed; color: white; padding: 14px 30px; border: none; border-radius: 8px; font-size: 17px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        #finalSubmitBtn:hover { background-color: #6d28d9; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(124, 58, 237, 0.25); }
        #finalSubmitBtn:disabled { background-color: #9ca3af; cursor: not-allowed; transform: none; box-shadow: none;}
        #assessmentCompletePopup { display: none; position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background-color: white; padding: 45px 50px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); z-index: 1002; text-align: center; border-top: 6px solid #7c3aed; min-width: 350px; }
         #assessmentCompletePopup p { font-size: 19px; color: #374151; margin-bottom: 30px; line-height: 1.6; }
         #assessmentCompletePopup button { background-color: #3b82f6; color: white; padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; font-size: 17px; transition: background-color 0.3s; font-weight: 500; }
         #assessmentCompletePopup button:hover { background-color: #2563eb; }

        /* --- MODIFIED: Modal Styles --- */
         .modal-overlay {
             position: fixed; top: 0; left: 0; width: 100%; height: 100%;
             background-color: rgba(0, 0, 0, 0.7); /* Dimmed background */
             z-index: 1000; display: none; /* Hidden by default */
             cursor: pointer; /* Indicate clicking overlay closes it */
         }
         .modal-box {
             position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
             background-color: white; padding: 35px 45px; /* Increased padding */
             border-radius: 10px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); /* Slightly stronger shadow */
             z-index: 1001; min-width: 340px; max-width: 550px; text-align: center;
             display: none; /* Hidden by default */
             border-top: 6px solid #f59e0b; /* Warning yellow/orange border */
         }
         .modal-box h2 {
             color: #d97706; /* Darker warning color */
             margin-bottom: 18px; font-size: 1.6rem; /* Larger heading */
             display: flex; align-items: center; justify-content: center; gap: 10px; /* Center icon and text */
         }
         .modal-box h2 svg { /* Style for the icon */
            width: 26px; height: 26px; stroke-width: 2;
         }
         .modal-box p { color: #374151; margin-bottom: 30px; font-size: 1.1rem; line-height: 1.65; }
         .modal-box button {
             background-color: #f59e0b; /* Match border color */
             color: white; padding: 11px 22px; border: none; border-radius: 6px;
             cursor: pointer; font-size: 1rem; transition: background-color 0.3s;
             font-weight: 600; /* Bolder button text */
         }
         .modal-box button:hover { background-color: #d97706; } /* Darker on hover */

         #loadingOrAccessMessage { text-align: center; padding: 60px 20px; font-size: 20px; color: #6b7280; width: 100%; }

        /* Responsive Adjustments */
         @media (max-width: 768px) { body { padding-top: 62px; } main { padding: 0 15px; margin: 15px auto; } .assessment-container { padding: 25px 30px; } .user-bar { padding: 10px 20px; } .modal-box { width: 90%; padding: 30px 25px; } }
         @media (max-width: 600px) { .assessment-container { padding: 20px; } #finalAssessmentForm textarea { min-height: 120px; } #finalAssessmentForm label { font-size: 17px; } #finalAssessmentForm input[type="number"], #finalAssessmentForm textarea { padding: 12px 14px; font-size: 15px; } #finalSubmitBtn { padding: 12px 25px; font-size: 16px; } .form-group.situational, .form-group.reflection, .form-group.evaluation { padding-left: 10px; padding-right: 10px; } #assessmentCompletePopup { width: 90%; padding: 30px 25px; } .modal-box h2 { font-size: 1.4rem; } .modal-box p { font-size: 1rem; } .modal-box button { font-size: 0.95rem; padding: 10px 20px; } }
    </style>
</head>
<body>
    <!-- User Bar -->
    <div class="user-bar">
        <div class="user-info">
             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            <div class="user-details-bar">
                <span class="user-name-bar" id="userNameBar">Loading...</span>
                <span class="user-email-bar" id="userEmailBar"></span>
            </div>
        </div>
        <button class="logout-button" onclick="logout()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
            Logout
        </button>
    </div>

    <!-- MODIFIED: Access Denied Modal HTML -->
    <div id="accessDeniedOverlay" class="modal-overlay"></div>
    <div id="accessDeniedModal" class="modal-box">
        <h2>
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
             Access Denied
        </h2>
        <p>You need to complete all course modules before taking the final assessment.<br>Please go back and finish the remaining sections.</p>
        <button id="goBackDeniedBtn">Go Back</button> {/* Changed ID and Text */}
    </div>

    <!-- Main Content Area -->
    <main>
        <div id="loadingOrAccessMessage">Loading Assessment...</div>

        <!-- Final Assessment Container -->
        <section id="assessmentContainer" class="assessment-container">
             <h2>Post-Course Reflection</h2>
            <p class="assessment-intro">
                <strong>Congratulations on completing the core modules!</strong> This final assessment helps you reflect on your learning and how you'll apply it. Please answer thoughtfully and honestly in your own words.
                <span id="adminAssessmentNote"> (Admin: Word count and paste restrictions are disabled for your account.)</span>
            </p>

            <form id="finalAssessmentForm" novalidate>
                {/* Form content remains exactly the same */}
                {/* ... (Situational, Reflection, Evaluation questions etc.) ... */}
                 <div class="form-group situational"> <label for="q_situational_disengaged">Scenario: ...disengaged...</label> <textarea id="q_situational_disengaged" name="situational_disengaged" required data-min-words="30" placeholder="Outline your approach..."></textarea> <div class="input-meta-info"> <div class="paste-warning" id="q_situational_paste_warning">Pasting...</div> <div class="word-count-info" id="q_situational_word_count_container">Words: <span id="q_situational_word_count">0</span><span>/30</span></div> </div> <div class="error-message" id="q_situational_error"></div> </div>
                 <div class="form-group situational"> <label for="q_situational_feedback">Scenario: ...feedback...</label> <textarea id="q_situational_feedback" name="situational_feedback" required data-min-words="30" placeholder="Describe your feedback process..."></textarea> <div class="input-meta-info"> <div class="paste-warning" id="q_feedback_paste_warning">Pasting...</div> <div class="word-count-info" id="q_feedback_word_count_container">Words: <span id="q_feedback_word_count">0</span><span>/30</span></div> </div> <div class="error-message" id="q_feedback_error"></div> </div>
                 <div class="form-group reflection"> <label for="q_reflection_skill">What’s one specific coaching skill...</label> <textarea id="q_reflection_skill" name="reflection_skill_improved" required data-min-words="30" placeholder="Identify the skill..."></textarea> <div class="input-meta-info"> <div class="paste-warning" id="q_skill_paste_warning">Pasting...</div> <div class="word-count-info" id="q_skill_word_count_container">Words: <span id="q_skill_word_count">0</span><span>/30</span></div> </div> <div class="error-message" id="q_skill_error"></div> </div>
                 <div class="form-group reflection"> <label for="q_reflection_challenge">Reflecting... most challenging concept...</label> <textarea id="q_reflection_challenge" name="reflection_challenge" required data-min-words="30" placeholder="Discuss your biggest challenge..."></textarea> <div class="input-meta-info"> <div class="paste-warning" id="q_challenge_paste_warning">Pasting...</div> <div class="word-count-info" id="q_challenge_word_count_container">Words: <span id="q_challenge_word_count">0</span><span>/30</span></div> </div> <div class="error-message" id="q_challenge_error"></div> </div>
                 <div class="form-group evaluation"> <label for="q_eval_confidence_rating">On a scale of 1 to 5... confidence *after*?</label> <input type="number" id="q_eval_confidence_rating" name="evaluation_confidence_rating" required min="1" max="5" step="1" placeholder="Enter 1-5"> <div class="error-message" id="q_eval_rating_error"></div> <label for="q_eval_confidence_explanation" style="margin-top: 15px;">Briefly explain...</label> <textarea id="q_eval_confidence_explanation" name="evaluation_confidence_explanation" required data-min-words="25" placeholder="Explain your confidence..."></textarea> <div class="input-meta-info"> <div class="paste-warning" id="q_eval_exp_paste_warning">Pasting...</div> <div class="word-count-info" id="q_eval_exp_word_count_container">Words: <span id="q_eval_exp_word_count">0</span><span>/25</span></div> </div> <div class="error-message" id="q_eval_exp_error"></div> </div>
                 <div id="submissionProgressContainer"> <div id="submissionProgressBar"></div> </div>
                <button type="submit" id="finalSubmitBtn">Submit Final Assessment</button>
            </form>
        </section>

        <!-- Completion Popup (Unchanged) -->
        <div class="popup-overlay" id="completionPopupOverlay"></div>
        <div id="assessmentCompletePopup">
             <p>Success! Your final assessment has been submitted. Thank you for your thoughtful responses.</p>
             <button id="closeCompletePopupBtn">Return to Dashboard</button>
        </div>

    </main>

    <!-- Footer -->
    <footer class="footer">
        © 2025 Elmenisy Leadership Coaching - All Rights Reserved
    </footer>

    <script>
        // --- Constants (Consistent) ---
        const LOGGED_IN_KEY = 'isUserLoggedIn';
        const CURRENT_USER_KEY = 'currentUser';
        const ADMIN_EMAIL = 'm.elsayed@thechefz.co';
        const FINAL_ASSESSMENT_ID = 'final_assessment';
        const DASHBOARD_URL = 'questiondashboard.html';
        const WHATS_NEXT_URL = 'whats-next.html'; // <<< Define whats-next URL
        const requiredCourseSections = [ { id: 'index' }, { id: 'article1' }, { id: 'skills' }, { id: 'individuals' }, { id: 'team' }, { id: 'self' }, { id: 'action' }];

        // --- Globals (Consistent) ---
        let IS_ADMIN_USER = false;
        let currentUser = null;

        // --- Get User Data (Consistent) ---
        function getLocalStorageUser() { /* ... same function ... */
            try { const d=localStorage.getItem(CURRENT_USER_KEY); if(!d) return null; const p=JSON.parse(d); return (p && typeof p==='object' && p.name && p.email && p.progress) ? p : null; } catch(e){ console.error("Error parsing user data:", e); return null;}
        }

        // --- IMMEDIATE ACCESS CONTROL (MODIFIED FOR MODAL & REDIRECT) ---
        (function checkAccess() {
            console.log("%cFinal Assessment: Running IMMEDIATE access check...", "color: orange; font-weight: bold;");
            const isLoggedIn = localStorage.getItem(LOGGED_IN_KEY) === 'true';
            const user = getLocalStorageUser();

            if (!isLoggedIn || !user || !user.progress) {
                console.error("%cFinal Assessment Redirect: Not logged in or user data/progress invalid.", "color: red;");
                 window.location.replace('login.html');
                 throw new Error("Redirecting user: Not logged in or invalid data.");
            }

            let allSectionsComplete = true;
            for (const section of requiredCourseSections) {
                if ((user.progress[section.id] || 0) < 100) {
                    allSectionsComplete = false;
                    break;
                }
            }

            if (!allSectionsComplete) {
                 console.warn("%cFinal Assessment Access Denied: Course not fully completed. Showing Modal.", "color: red;");
                 const overlay = document.getElementById('accessDeniedOverlay');
                 const modal = document.getElementById('accessDeniedModal');
                 if (overlay && modal) {
                     overlay.style.display = 'block';
                     modal.style.display = 'block';
                 } else {
                     console.error("Access Denied Modal elements not found!");
                     alert("Access Denied: Please complete all course modules.");
                 }
                 throw new Error("Stopping script execution: Course not complete."); // Still essential
            }

            // If access is granted:
            console.log("%cFinal Assessment: Access Granted. Proceeding.", "color: green;");
            currentUser = user;
            IS_ADMIN_USER = currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
        })();
        // --- END IMMEDIATE ACCESS CONTROL ---


        document.addEventListener('DOMContentLoaded', function() {
            console.log("Final Assessment DOM loaded.");

            if (!currentUser) {
                 // This should technically not be reached if checkAccess threw an error,
                 // but good as a fallback/debug mechanism.
                 console.error("DOM Load Error: currentUser is null. Hiding assessment.");
                 document.getElementById('loadingOrAccessMessage').textContent = 'Error loading assessment data.';
                 const assessmentContainer = document.getElementById('assessmentContainer');
                 if(assessmentContainer) assessmentContainer.style.display = 'none';
                 // Do NOT proceed further.
                 return;
            }

            // --- Element References ---
            const loadingMsg = document.getElementById('loadingOrAccessMessage');
            const assessmentContainer = document.getElementById('assessmentContainer');
            const assessmentForm = document.getElementById('finalAssessmentForm');
            const completePopup = document.getElementById('assessmentCompletePopup');
            const completionOverlay = document.getElementById('completionPopupOverlay');
            const closeCompletePopupButton = document.getElementById('closeCompletePopupBtn');
            const submitButton = document.getElementById('finalSubmitBtn');

            // *** MODIFIED: Access Denied Modal References & Listeners ***
            const deniedOverlay = document.getElementById('accessDeniedOverlay');
            const deniedModal = document.getElementById('accessDeniedModal');
            const goBackButton = document.getElementById('goBackDeniedBtn'); // Get new button ID

            // Function to close modal and redirect to WHATS_NEXT_URL
            function closeDeniedModalAndGoBack() {
                 if (deniedOverlay) deniedOverlay.style.display = 'none';
                 if (deniedModal) deniedModal.style.display = 'none';
                 window.location.href = WHATS_NEXT_URL; // <<< Redirect to whats-next.html
            }

            // Attach listener to the "Go Back" button
            if(goBackButton) {
                 goBackButton.addEventListener('click', closeDeniedModalAndGoBack);
            }
            // Attach listener to the overlay
            if(deniedOverlay) {
                 deniedOverlay.addEventListener('click', closeDeniedModalAndGoBack); // Click outside closes
            }
            // Stop propagation if clicking inside the modal itself
             if(deniedModal) {
                 deniedModal.addEventListener('click', (event) => event.stopPropagation());
             }


            // --- Populate Top Bar ---
            populateTopBar(currentUser);

            // --- Setup Form & Completion Check (Logic remains the same) ---
            setupFinalAssessmentForm();
            const alreadyCompleted = currentUser.finalAssessmentCompleted || currentUser.progress[FINAL_ASSESSMENT_ID] === 100;
             if (alreadyCompleted) {
                 // ... disable form logic ...
                 assessmentForm.querySelectorAll('textarea, input, button').forEach(el => el.disabled = true);
                 submitButton.textContent = 'Assessment Submitted';
                 const introNote = assessmentContainer.querySelector('.assessment-intro');
                 if(introNote) { const completedNote = document.createElement('p'); completedNote.innerHTML = '<strong>Note:</strong> You have already completed this assessment.'; completedNote.style.cssText = 'margin-top: 15px; font-weight: 500; color: #7c3aed;'; introNote.appendChild(completedNote); }
             } else {
                 assessmentForm.addEventListener('submit', handleFinalAssessmentSubmit);
             }

            // Show Assessment Content (only if access granted)
            loadingMsg.style.display = 'none';
            assessmentContainer.style.display = 'block';
            setTimeout(() => assessmentContainer.classList.add('fade-in'), 50);

            // Completion Popup Close Button (Redirects to Dashboard)
             closeCompletePopupButton.addEventListener('click', () => {
                 if(completePopup) completePopup.style.display = 'none';
                 if(completionOverlay) completionOverlay.style.display = 'none';
                 window.location.href = DASHBOARD_URL; // Completion goes to Dashboard
             });

        });

        // --- Helper Functions (Core logic unchanged, ensure consistency) ---

        function saveCurrentUser(userObject) { /* ... same as before ... */
            try { if (!userObject) throw new Error("Invalid user object."); localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(userObject)); console.log("Saved user data:", userObject); } catch (error) { console.error("Error saving user data:", error); }
        }
        function populateTopBar(user) { /* ... same as before (uses correct IDs) ... */
             const userNameElement = document.getElementById('userNameBar'); const userEmailElement = document.getElementById('userEmailBar'); if (user && userNameElement && userEmailElement) { userNameElement.textContent = user.name || 'User'; userEmailElement.textContent = user.email; } else { if(userNameElement) userNameElement.textContent = 'N/A'; if(userEmailElement) userEmailElement.textContent = 'N/A'; }
        }
        function countWords(text) { /* ... same as before ... */
             return text ? text.trim().split(/\s+/).filter(Boolean).length : 0;
        }
        function setupWordCountValidation(textarea, countSpan, errorElement, countContainer, isAdmin) { /* ... same as before ... */
             const minWords = parseInt(textarea.getAttribute('data-min-words'), 10); if (isNaN(minWords)) return; if (isAdmin) { countContainer.style.display = 'none'; return; } countContainer.querySelector('span + span').textContent = `/${minWords}`; textarea.addEventListener('input', () => { const words = countWords(textarea.value); countSpan.textContent = words; validateWordCount(textarea, minWords, errorElement, isAdmin); }); validateWordCount(textarea, minWords, errorElement, isAdmin);
        }
        function validateWordCount(textarea, minWords, errorElement, isAdmin) { /* ... same as before ... */
             if (isAdmin || isNaN(minWords)) { errorElement.style.display = 'none'; textarea.classList.remove('invalid'); return true; } const words = countWords(textarea.value); const isFieldEmpty = !textarea.value.trim(); if (!isFieldEmpty && words < minWords) { errorElement.textContent = `Minimum ${minWords} words required.`; errorElement.style.display = 'block'; textarea.classList.add('invalid'); return false; } else { errorElement.style.display = 'none'; textarea.classList.remove('invalid'); return true; }
        }
        function setupPastePrevention(textarea, warningElement, isAdmin) { /* ... same as before ... */
             if (!isAdmin) { textarea.addEventListener('paste', (event) => { event.preventDefault(); warningElement.textContent = 'Pasting is disabled.'; warningElement.style.display = 'block'; setTimeout(() => { warningElement.style.display = 'none'; }, 4000); }); } else { warningElement.style.display = 'none'; }
        }
        function setupFinalAssessmentForm() { /* ... same as before ... */
             const form = document.getElementById('finalAssessmentForm'); const textareas = form.querySelectorAll('textarea[data-min-words]'); if (IS_ADMIN_USER) { document.getElementById('adminAssessmentNote').style.display = 'inline'; textareas.forEach(ta => ta.placeholder = "Admin: No word count required."); } else { textareas.forEach(ta => { const min = ta.getAttribute('data-min-words'); ta.placeholder = ta.placeholder + ` (min ${min} words)`; }); } textareas.forEach(ta => { const baseId = ta.id; const countSpan = document.getElementById(`${baseId}_word_count`); const errorElement = document.getElementById(`${baseId}_error`); const countContainer = document.getElementById(`${baseId}_word_count_container`); const pasteWarning = document.getElementById(`${baseId}_paste_warning`); if (countSpan && errorElement && countContainer && pasteWarning) { setupWordCountValidation(ta, countSpan, errorElement, countContainer, IS_ADMIN_USER); setupPastePrevention(ta, pasteWarning, IS_ADMIN_USER); } else { console.warn(`Missing elements for validation setup for ${baseId}`); } });
        }
        function handleFinalAssessmentSubmit(event) { /* ... same as before, including showing completion popup ... */
            event.preventDefault(); console.log("Final Assessment submit triggered.");
            const form = event.target; const submitButton = document.getElementById('finalSubmitBtn'); const progressContainer = document.getElementById('submissionProgressContainer'); const progressBar = document.getElementById('submissionProgressBar');
            const completionOverlay = document.getElementById('completionPopupOverlay'); // Get unique ID
            const completePopup = document.getElementById('assessmentCompletePopup');
            submitButton.disabled = true; submitButton.textContent = 'Submitting...'; progressContainer.style.display = 'block'; progressBar.style.width = '10%';
            form.querySelectorAll('.error-message').forEach(el => el.style.display = 'none'); form.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));
            const inputs = { situational_disengaged: form.querySelector('#q_situational_disengaged'), situational_feedback: form.querySelector('#q_situational_feedback'), reflection_skill: form.querySelector('#q_reflection_skill'), reflection_challenge: form.querySelector('#q_reflection_challenge'), evaluation_confidence_rating: form.querySelector('#q_eval_confidence_rating'), evaluation_confidence_explanation: form.querySelector('#q_eval_confidence_explanation') }; const errors = { situational_disengaged: form.querySelector('#q_situational_error'), situational_feedback: form.querySelector('#q_feedback_error'), reflection_skill: form.querySelector('#q_skill_error'), reflection_challenge: form.querySelector('#q_challenge_error'), evaluation_confidence_rating: form.querySelector('#q_eval_rating_error'), evaluation_confidence_explanation: form.querySelector('#q_eval_exp_error') };
            let isValid = true; let validationProgress = 10; const progressIncrement = Math.floor(90 / Object.keys(inputs).length);
            for (const key in inputs) { const input = inputs[key]; const errorEl = errors[key]; let fieldValid = true; if (input.type === 'textarea') { if (!input.value.trim()) { errorEl.textContent = 'This field is required.'; errorEl.style.display = 'block'; input.classList.add('invalid'); fieldValid = false; } else if (!validateWordCount(input, parseInt(input.getAttribute('data-min-words'), 10), errorEl, IS_ADMIN_USER)) { fieldValid = false; } } else if (input.type === 'number') { const ratingVal = parseInt(input.value, 10); if (!input.value || isNaN(ratingVal) || ratingVal < input.min || ratingVal > input.max) { errorEl.textContent = `Please enter a valid rating between ${input.min} and ${input.max}.`; errorEl.style.display = 'block'; input.classList.add('invalid'); fieldValid = false; } } validationProgress += progressIncrement; progressBar.style.width = `${Math.min(validationProgress, 95)}%`; if (!fieldValid) isValid = false; }
            setTimeout(() => { if (isValid) { progressBar.style.width = '100%'; let updatedUser = getLocalStorageUser(); if (!updatedUser) { console.error("User data lost before saving final assessment."); alert("Error saving assessment."); submitButton.disabled = false; submitButton.textContent = 'Submit Final Assessment'; progressContainer.style.display = 'none'; return; } const finalAnswers = {}; for (const key in inputs) { finalAnswers[key] = inputs[key].value.trim(); } updatedUser.finalAssessmentAnswers = finalAnswers; updatedUser.finalAssessmentCompleted = true; if (!updatedUser.progress) { updatedUser.progress = {}; } updatedUser.progress[FINAL_ASSESSMENT_ID] = 100; saveCurrentUser(updatedUser); if(completePopup) completePopup.style.display = 'block'; if(completionOverlay) completionOverlay.style.display = 'block'; } else { console.log("Final Assessment form invalid."); submitButton.disabled = false; submitButton.textContent = 'Submit Final Assessment'; progressContainer.style.display = 'none'; progressBar.style.width = '0%'; const firstError = form.querySelector('.invalid'); if (firstError) { firstError.scrollIntoView({ behavior: 'smooth', block: 'center' }); firstError.focus(); } } }, 300);
        }
        function logout() { /* ... same consistent function ... */
            console.log("Logging out..."); try { localStorage.removeItem(LOGGED_IN_KEY); localStorage.removeItem(CURRENT_USER_KEY); IS_ADMIN_USER = false; currentUser = null; window.location.href = 'login.html'; } catch (e) { console.error("Logout error:", e); window.location.href = 'login.html'; }
        }
    </script>
</body>
</html>
