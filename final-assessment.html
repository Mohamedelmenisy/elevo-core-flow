<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Assessment - Coaching & Leadership</title>
    <!-- Favicon Links (Same as dashboard) -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <style>
        /* --- Base Styles (Copied & Adapted from Dashboard) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f8fafc; margin: 0; padding: 0; line-height: 1.6; color: #374151; display: flex; flex-direction: column; min-height: 100vh; }
        main { flex-grow: 1; display: flex; justify-content: center; align-items: flex-start; flex-direction: column; width: 100%; max-width: 1000px; margin: 20px auto; padding: 0 20px; }
        .header { background: linear-gradient(90deg, #2c3e50, #34495e); color: white; padding: 18px 0; text-align: center; font-size: 26px; font-weight: 600; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); width: 100%; border-bottom: 3px solid #3498db; }
        .user-bar { background-color: #ffffff; padding: 12px 30px; display: flex; justify-content: space-between; align-items: center; color: #4b5563; font-size: 15px; width: 100%; border-bottom: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-info svg { color: #3498db; }
        .user-details-bar { display: flex; flex-direction: column; }
        .user-name-bar { font-weight: 600; font-size: 16px; color: #1f2937; }
        .user-email-bar { font-size: 13px; opacity: 0.8; color: #6b7280; }
        .logout-button { background-color: #ef4444; color: white; border: none; padding: 9px 18px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; }
        .logout-button:hover { background-color: #dc2626; box-shadow: 0 2px 5px rgba(239, 68, 68, 0.3); transform: translateY(-1px); }
        .logout-button:active { transform: translateY(0); }
        .footer { text-align: center; padding: 25px 30px; background: #f9fafb; color: #6b7280; margin-top: auto; font-size: 14px; width: 100%; border-top: 1px solid #e5e7eb; }

        /* --- Final Assessment Styles --- */
        .assessment-container {
            background: white;
            padding: 35px 45px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            width: 100%;
            margin-bottom: 35px;
            text-align: left;
            opacity: 0; /* Initially hidden for fade-in */
            transition: opacity 0.7s ease-in-out;
            border: 1px solid #e5e7eb;
            display: none; /* Hidden until access check passes */
        }
        .assessment-container.fade-in { opacity: 1; }
        .assessment-container h2 {
            color: #1f2937;
            margin-bottom: 25px;
            font-size: 28px;
            font-weight: 600;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 15px;
        }
        .assessment-intro {
            background-color: #eff6ff;
            border-left: 5px solid #3b82f6;
            padding: 18px 25px;
            margin-bottom: 30px;
            border-radius: 6px;
            font-size: 16px;
            color: #374151;
            line-height: 1.7;
        }
         .assessment-intro strong { color: #1e40af; } /* Darker blue for emphasis */
         #adminAssessmentNote { font-weight: bold; color: #b45309; display: none; } /* Hidden by default */

        #finalAssessmentForm .form-group { margin-bottom: 35px; } /* More spacing */
        #finalAssessmentForm label { display: block; margin-bottom: 12px; font-weight: 600; color: #374151; font-size: 18px; }
        #finalAssessmentForm textarea, #finalAssessmentForm input[type="number"] {
            width: 100%; padding: 14px 16px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s; color: #1f2937;
        }
        #finalAssessmentForm textarea { min-height: 140px; resize: vertical; }
        #finalAssessmentForm textarea:focus, #finalAssessmentForm input[type="number"]:focus {
            border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); outline: none;
        }
        /* Specific styling for question types (optional) */
        .form-group.situational { border-left: 3px solid #f59e0b; padding-left: 15px; background-color: #fffbeb; border-radius: 4px; padding-top: 15px; padding-right: 15px; padding-bottom: 5px;}
        .form-group.reflection { border-left: 3px solid #10b981; padding-left: 15px; background-color: #f0fdf4; border-radius: 4px; padding-top: 15px; padding-right: 15px; padding-bottom: 5px;}
        .form-group.evaluation { border-left: 3px solid #6366f1; padding-left: 15px; background-color: #eef2ff; border-radius: 4px; padding-top: 15px; padding-right: 15px; padding-bottom: 5px;}

        #finalAssessmentForm .input-meta-info { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
        #finalAssessmentForm .word-count-info { font-size: 13px; color: #6b7280; }
        #finalAssessmentForm .paste-warning { font-size: 13px; color: #f97316; display: none; }
        #finalAssessmentForm .error-message { color: #ef4444; font-size: 14px; margin-top: 8px; display: none; font-weight: 500;}
        #finalAssessmentForm input.invalid, #finalAssessmentForm textarea.invalid { border-color: #ef4444; }

        /* Submission Progress Bar */
        #submissionProgressContainer {
            width: 100%; height: 10px; background-color: #e5e7eb; border-radius: 5px;
            overflow: hidden; margin: 20px 0 30px 0; display: none; /* Hidden initially */
        }
        #submissionProgressBar {
            width: 0%; height: 100%; background: linear-gradient(90deg, #a78bfa, #7c3aed); /* Violet gradient */
            border-radius: 5px; transition: width 0.4s ease-out;
        }

        #finalSubmitBtn {
            background-color: #7c3aed; /* Violet */ color: white; padding: 14px 30px; border: none; border-radius: 8px;
            font-size: 17px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
        }
        #finalSubmitBtn:hover { background-color: #6d28d9; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(124, 58, 237, 0.25); }
        #finalSubmitBtn:disabled { background-color: #9ca3af; cursor: not-allowed; transform: none; box-shadow: none;}

        /* Completion Popup */
        #assessmentCompletePopup {
            display: none; position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%);
            background-color: white; padding: 45px 50px; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); z-index: 1000; text-align: center;
            border-top: 6px solid #7c3aed; min-width: 350px;
        }
         #assessmentCompletePopup p { font-size: 19px; color: #374151; margin-bottom: 30px; line-height: 1.6; }
         #assessmentCompletePopup button {
            background-color: #3b82f6; color: white; padding: 12px 25px; border: none;
            border-radius: 6px; cursor: pointer; font-size: 17px; transition: background-color 0.3s; font-weight: 500;
         }
         #assessmentCompletePopup button:hover { background-color: #2563eb; }
         .popup-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 999; }

         /* Loading / Access Denied Message */
         #loadingOrAccessMessage { text-align: center; padding: 60px 20px; font-size: 20px; color: #6b7280; width: 100%; }
         #loadingOrAccessMessage.access-denied { color: #ef4444; font-weight: 500;}


        /* Responsive Adjustments (from dashboard) */
         @media (max-width: 768px) {
             main { padding: 0 15px; margin: 15px auto; }
             .assessment-container { padding: 25px 30px; }
             .header { font-size: 22px; padding: 15px 0; }
             .user-bar { padding: 10px 20px; }
         }
         @media (max-width: 600px) {
             .assessment-container { padding: 20px; }
             #finalAssessmentForm textarea { min-height: 120px; }
             #finalAssessmentForm label { font-size: 17px; }
             #finalAssessmentForm input[type="number"], #finalAssessmentForm textarea { padding: 12px 14px; font-size: 15px; }
             #finalSubmitBtn { padding: 12px 25px; font-size: 16px; }
             .form-group.situational, .form-group.reflection, .form-group.evaluation { padding-left: 10px; padding-right: 10px; }
             #assessmentCompletePopup { width: 90%; padding: 30px 25px; }
         }

    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">Coaching & Leadership Final Assessment</header>

    <!-- User Bar -->
    <div class="user-bar">
        <div class="user-info">
             <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path> <circle cx="12" cy="7" r="4"></circle> </svg>
            <div class="user-details-bar">
                <span class="user-name-bar" id="userNameBar">Loading...</span>
                <span class="user-email-bar" id="userEmailBar"></span>
            </div>
        </div>
        <button class="logout-button" onclick="logout()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path> <polyline points="16 17 21 12 16 7"></polyline> <line x1="21" y1="12" x2="9" y2="12"></line> </svg>
            Logout
        </button>
    </div>

    <!-- Main Content Area -->
    <main>
        <div id="loadingOrAccessMessage">Loading Assessment...</div>

        <!-- Final Assessment Container -->
        <section id="assessmentContainer" class="assessment-container">
            <h2>Post-Course Reflection</h2>
            <p class="assessment-intro">
                <strong>Congratulations on completing the core modules!</strong> This final assessment helps you reflect on your learning and how you'll apply it. Please answer thoughtfully and honestly in your own words.
                <span id="adminAssessmentNote"> (Admin: Word count and paste restrictions are disabled for your account.)</span>
            </p>

            <form id="finalAssessmentForm" novalidate>

                <!-- Situational Questions -->
                <div class="form-group situational">
                    <label for="q_situational_disengaged">Scenario: You are coaching a team member who appears consistently disengaged and withdrawn during meetings. Based on what you've learned, describe 2-3 specific steps you would take to approach this situation and help them rediscover their motivation.</label>
                    <textarea id="q_situational_disengaged" name="situational_disengaged" required data-min-words="30" placeholder="Outline your approach..."></textarea>
                    <div class="input-meta-info">
                        <div class="paste-warning" id="q_situational_paste_warning">Pasting content is discouraged. Please use your own words.</div>
                        <div class="word-count-info" id="q_situational_word_count_container">Words: <span id="q_situational_word_count">0</span>/30</div>
                    </div>
                    <div class="error-message" id="q_situational_error"></div>
                </div>

                <div class="form-group situational">
                    <label for="q_situational_feedback">Scenario: A colleague asks you for feedback on a presentation they are nervous about. How would you structure your feedback session using the coaching principles discussed in the course to be both constructive and confidence-boosting?</label>
                    <textarea id="q_situational_feedback" name="situational_feedback" required data-min-words="30" placeholder="Describe your feedback process..."></textarea>
                    <div class="input-meta-info">
                        <div class="paste-warning" id="q_feedback_paste_warning">Pasting content is discouraged. Please use your own words.</div>
                        <div class="word-count-info" id="q_feedback_word_count_container">Words: <span id="q_feedback_word_count">0</span>/30</div>
                    </div>
                    <div class="error-message" id="q_feedback_error"></div>
                </div>

                <!-- Reflection Questions -->
                <div class="form-group reflection">
                    <label for="q_reflection_skill">What’s one specific coaching skill (e.g., active listening, powerful questioning, goal setting) you feel you significantly improved upon during this course? Describe how you plan to consciously apply this skill in your professional interactions in the next month.</label>
                    <textarea id="q_reflection_skill" name="reflection_skill_improved" required data-min-words="30" placeholder="Identify the skill and your action plan..."></textarea>
                    <div class="input-meta-info">
                        <div class="paste-warning" id="q_skill_paste_warning">Pasting content is discouraged. Please use your own words.</div>
                        <div class="word-count-info" id="q_skill_word_count_container">Words: <span id="q_skill_word_count">0</span>/30</div>
                    </div>
                    <div class="error-message" id="q_skill_error"></div>
                </div>

                 <div class="form-group reflection">
                    <label for="q_reflection_challenge">Reflecting on the course content, what was the most challenging concept or technique for you to grasp or imagine implementing? Why was it challenging, and what step could you take to overcome that challenge?</label>
                    <textarea id="q_reflection_challenge" name="reflection_challenge" required data-min-words="30" placeholder="Discuss your biggest learning challenge..."></textarea>
                    <div class="input-meta-info">
                        <div class="paste-warning" id="q_challenge_paste_warning">Pasting content is discouraged. Please use your own words.</div>
                        <div class="word-count-info" id="q_challenge_word_count_container">Words: <span id="q_challenge_word_count">0</span>/30</div>
                    </div>
                    <div class="error-message" id="q_challenge_error"></div>
                </div>


                <!-- Self-Evaluation Scale -->
                <div class="form-group evaluation">
                    <label for="q_eval_confidence_rating">On a scale of 1 (Not Confident) to 5 (Very Confident), how would you rate your overall confidence in your coaching abilities *after* completing this course?</label>
                    <input type="number" id="q_eval_confidence_rating" name="evaluation_confidence_rating" required min="1" max="5" step="1" placeholder="Enter a number between 1 and 5">
                    <div class="error-message" id="q_eval_rating_error"></div>

                    <label for="q_eval_confidence_explanation" style="margin-top: 15px;">Briefly explain your rating. How does this compare to your confidence level *before* the course (if you recall)?</label>
                    <textarea id="q_eval_confidence_explanation" name="evaluation_confidence_explanation" required data-min-words="25" placeholder="Explain your confidence level change..."></textarea>
                     <div class="input-meta-info">
                         <div class="paste-warning" id="q_eval_exp_paste_warning">Pasting content is discouraged. Please use your own words.</div>
                         <div class="word-count-info" id="q_eval_exp_word_count_container">Words: <span id="q_eval_exp_word_count">0</span>/25</div>
                     </div>
                    <div class="error-message" id="q_eval_exp_error"></div>
                </div>

                <!-- Submission Progress -->
                <div id="submissionProgressContainer">
                    <div id="submissionProgressBar"></div>
                </div>

                <button type="submit" id="finalSubmitBtn">Submit Final Assessment</button>
            </form>
        </section>

        <!-- Completion Popup -->
        <div class="popup-overlay" id="popupOverlay"></div>
        <div id="assessmentCompletePopup">
             <p>Success! Your final assessment has been submitted. Thank you for your thoughtful responses.</p>
             <button id="closeCompletePopupBtn">Return to Dashboard</button>
        </div>

    </main>

    <!-- Footer -->
    <footer class="footer">
        © 2025 Elmenisy Leadership Coaching - All Rights Reserved
    </footer>

    <script>
        // --- Constants ---
        const LOGGED_IN_KEY = 'isUserLoggedIn';
        const CURRENT_USER_KEY = 'currentUser';
        const ADMIN_EMAIL = 'm.elsayed@thechefz.co'; // Case-insensitive comparison
        const FINAL_ASSESSMENT_ID = 'final_assessment'; // Unique ID for progress tracking
        const DASHBOARD_URL = 'questiondashboard.html'; // URL of the main dashboard

        // Define the core course sections *required* to be completed before accessing this page
        // IMPORTANT: Do NOT include 'final_assessment' itself in this list for the check!
        const requiredCourseSections = [
            { id: 'index' }, // Assuming 'index' is a required section
            { id: 'article1' },
            { id: 'skills' },
            { id: 'individuals' },
            { id: 'team' },
            { id: 'self' },
            { id: 'action' },
        ];

        // --- Global variable for admin status & user data ---
        let IS_ADMIN_USER = false;
        let currentUser = null; // Will be populated after checks

        // --- Helper Function: Get User Data (Simplified from dashboard) ---
        function getLocalStorageUser() {
             try {
                 const userData = localStorage.getItem(CURRENT_USER_KEY);
                 if (!userData) return null;
                 const parsedUser = JSON.parse(userData);
                 // Basic validation
                 if (parsedUser && typeof parsedUser === 'object' && parsedUser.name && parsedUser.email && parsedUser.progress) {
                     return parsedUser;
                 }
                 return null;
             } catch (error) {
                 console.error("Error parsing current user data:", error);
                 return null;
             }
        }

        // --- IMMEDIATE ACCESS CONTROL ---
        (function checkAccess() {
            console.log("%cFinal Assessment: Running IMMEDIATE access check...", "color: orange; font-weight: bold;");
            const isLoggedIn = localStorage.getItem(LOGGED_IN_KEY) === 'true';
            const user = getLocalStorageUser();

            if (!isLoggedIn || !user) {
                console.error("%cFinal Assessment Redirect: Not logged in or user data invalid.", "color: red;");
                alert("Access Denied: You must be logged in to view this page.");
                window.location.replace('login.html'); // Redirect to login
                throw new Error("Redirecting user: Not logged in.");
            }

            // Check if ALL required course sections are complete (>= 100%)
            let allSectionsComplete = true;
            for (const section of requiredCourseSections) {
                const progress = user.progress[section.id] || 0;
                if (progress < 100) {
                    allSectionsComplete = false;
                    console.warn(`%cFinal Assessment Access Denied: Section '${section.id}' not complete (Progress: ${progress}%)`, "color: red;");
                    break; // No need to check further
                }
            }

            if (!allSectionsComplete) {
                 console.error("%cFinal Assessment Redirect: Course not fully completed.", "color: red;");
                 alert("Access Denied: Please complete all course modules before accessing the final assessment.");
                 window.location.replace(DASHBOARD_URL); // Redirect to dashboard
                 throw new Error("Redirecting user: Course not complete.");
            }

             // Check if final assessment already completed (allow review but maybe disable form?)
             if (user.progress[FINAL_ASSESSMENT_ID] === 100 || user.finalAssessmentCompleted) {
                 console.log("%cFinal Assessment Info: Assessment already completed. Allowing review.", "color: blue;");
                 // We'll handle disabling the form later in DOMContentLoaded if needed
             }


            console.log("%cFinal Assessment: Access Granted. Proceeding.", "color: green;");
            currentUser = user; // Store user data globally for later use
            IS_ADMIN_USER = currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase(); // Set admin status
        })();
        // --- END IMMEDIATE ACCESS CONTROL ---


        document.addEventListener('DOMContentLoaded', function() {
            console.log("Final Assessment DOM loaded.");

            // If access checks failed, currentUser might be null. Script should have stopped via throw new Error.
             if (!currentUser) {
                 console.error("DOM Load Error: currentUser is null. Access control likely failed.");
                 document.getElementById('loadingOrAccessMessage').textContent = 'Error loading user data. Please try refreshing or logging in again.';
                 document.getElementById('loadingOrAccessMessage').classList.add('access-denied');
                 return; // Stop execution
             }

            // --- Element References ---
            const loadingMsg = document.getElementById('loadingOrAccessMessage');
            const assessmentContainer = document.getElementById('assessmentContainer');
            const assessmentForm = document.getElementById('finalAssessmentForm');
            const completePopup = document.getElementById('assessmentCompletePopup');
            const popupOverlay = document.getElementById('popupOverlay');
            const closePopupButton = document.getElementById('closeCompletePopupBtn');
            const submitButton = document.getElementById('finalSubmitBtn');
            const progressContainer = document.getElementById('submissionProgressContainer');
            const progressBar = document.getElementById('submissionProgressBar');

            // Populate Top Bar
            populateTopBar(currentUser);

            // Setup Form (Validation, Paste Prevention based on IS_ADMIN_USER)
            setupFinalAssessmentForm();

             // Check if assessment was already completed - disable form if so
             const alreadyCompleted = currentUser.finalAssessmentCompleted || currentUser.progress[FINAL_ASSESSMENT_ID] === 100;
             if (alreadyCompleted) {
                 console.log("Disabling form as assessment is already completed.");
                 assessmentForm.querySelectorAll('textarea, input, button').forEach(el => el.disabled = true);
                 submitButton.textContent = 'Assessment Submitted';
                 // Optionally load saved answers into fields for review (requires more logic)
                 const introNote = assessmentContainer.querySelector('.assessment-intro');
                 if(introNote) {
                    const completedNote = document.createElement('p');
                    completedNote.innerHTML = '<strong>Note:</strong> You have already completed this assessment. Your previous answers are saved.';
                    completedNote.style.marginTop = '15px';
                    completedNote.style.fontWeight = '500';
                    completedNote.style.color = '#7c3aed';
                    introNote.appendChild(completedNote);
                 }
             } else {
                 // Attach Submit Handler only if not completed
                 assessmentForm.addEventListener('submit', handleFinalAssessmentSubmit);
             }


            // Show Content
            loadingMsg.style.display = 'none';
            assessmentContainer.style.display = 'block';
            setTimeout(() => assessmentContainer.classList.add('fade-in'), 50);

            // Popup Close Button
             closePopupButton.addEventListener('click', () => {
                 completePopup.style.display = 'none';
                 popupOverlay.style.display = 'none';
                 window.location.href = DASHBOARD_URL; // Go back to dashboard after closing popup
             });

        });

        // --- Helper Functions (Reused/Adapted) ---

        function saveCurrentUser(userObject) {
             try {
                 if (!userObject || typeof userObject !== 'object') { throw new Error("Invalid user object."); }
                 localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(userObject));
                 console.log("Saved user data to localStorage:", userObject);
             } catch (error) {
                 console.error("Error saving current user data:", error);
             }
        }

        function populateTopBar(user) {
            const userNameBar = document.getElementById('userNameBar');
            const userEmailBar = document.getElementById('userEmailBar');
            if (userNameBar) userNameBar.textContent = user.name;
            if (userEmailBar) userEmailBar.textContent = user.email;
        }

        function countWords(text) {
            return text ? text.trim().split(/\s+/).filter(Boolean).length : 0;
        }

         function setupWordCountValidation(textarea, countSpan, errorElement, countContainer, isAdmin) {
             const minWords = parseInt(textarea.getAttribute('data-min-words'), 10);
             if (isNaN(minWords)) return; // Skip if no data-min-words

             if (isAdmin) {
                 countContainer.style.display = 'none';
                 return;
             }
             countContainer.querySelector('span + span').textContent = `/${minWords}`; // Set the target number display

             textarea.addEventListener('input', () => {
                 const words = countWords(textarea.value);
                 countSpan.textContent = words;
                 validateWordCount(textarea, minWords, errorElement, isAdmin);
             });
             validateWordCount(textarea, minWords, errorElement, isAdmin); // Initial check
         }

        function validateWordCount(textarea, minWords, errorElement, isAdmin) {
             if (isAdmin || isNaN(minWords)) {
                 errorElement.style.display = 'none';
                 textarea.classList.remove('invalid');
                 return true;
             }

             const words = countWords(textarea.value);
             const isFieldEmpty = !textarea.value.trim();

             if (!isFieldEmpty && words < minWords) {
                 errorElement.textContent = `Minimum ${minWords} words required.`;
                 errorElement.style.display = 'block';
                 textarea.classList.add('invalid');
                 return false;
             } else {
                 errorElement.style.display = 'none';
                 textarea.classList.remove('invalid');
                 return true;
             }
        }

        function setupPastePrevention(textarea, warningElement, isAdmin) {
            if (!isAdmin) {
                textarea.addEventListener('paste', (event) => {
                    event.preventDefault();
                    warningElement.textContent = 'Pasting is disabled. Please type your answer.';
                    warningElement.style.display = 'block';
                    setTimeout(() => { warningElement.style.display = 'none'; }, 4000);
                });
            } else {
                 warningElement.style.display = 'none';
            }
        }

        function setupFinalAssessmentForm() {
            const form = document.getElementById('finalAssessmentForm');
            const textareas = form.querySelectorAll('textarea[data-min-words]');

            if (IS_ADMIN_USER) {
                document.getElementById('adminAssessmentNote').style.display = 'inline';
                textareas.forEach(ta => ta.placeholder = "Admin: No word count required.");
            } else {
                 textareas.forEach(ta => {
                    const min = ta.getAttribute('data-min-words');
                    ta.placeholder = ta.placeholder + ` (min ${min} words)`;
                 });
            }

            // Setup validation for each textarea
            textareas.forEach(ta => {
                const baseId = ta.id;
                const countSpan = document.getElementById(`${baseId}_word_count`);
                const errorElement = document.getElementById(`${baseId}_error`);
                const countContainer = document.getElementById(`${baseId}_word_count_container`);
                const pasteWarning = document.getElementById(`${baseId}_paste_warning`);

                if (countSpan && errorElement && countContainer && pasteWarning) {
                    setupWordCountValidation(ta, countSpan, errorElement, countContainer, IS_ADMIN_USER);
                    setupPastePrevention(ta, pasteWarning, IS_ADMIN_USER);
                } else {
                    console.warn(`Missing elements for validation setup for ${baseId}`);
                }
            });
        }

        function handleFinalAssessmentSubmit(event) {
            event.preventDefault();
            console.log("Final Assessment submit triggered.");
            const form = event.target;
            const submitButton = document.getElementById('finalSubmitBtn');
            const progressContainer = document.getElementById('submissionProgressContainer');
            const progressBar = document.getElementById('submissionProgressBar');

            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...';
            progressContainer.style.display = 'block';
            progressBar.style.width = '10%'; // Initial progress

            // --- Clear previous errors ---
            form.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            form.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));

            // --- Get All Input Elements ---
            const inputs = {
                situational_disengaged: form.querySelector('#q_situational_disengaged'),
                situational_feedback: form.querySelector('#q_situational_feedback'),
                reflection_skill: form.querySelector('#q_reflection_skill'),
                reflection_challenge: form.querySelector('#q_reflection_challenge'),
                evaluation_confidence_rating: form.querySelector('#q_eval_confidence_rating'),
                evaluation_confidence_explanation: form.querySelector('#q_eval_confidence_explanation')
            };
            const errors = {
                situational_disengaged: form.querySelector('#q_situational_error'),
                situational_feedback: form.querySelector('#q_feedback_error'),
                reflection_skill: form.querySelector('#q_skill_error'),
                reflection_challenge: form.querySelector('#q_challenge_error'),
                evaluation_confidence_rating: form.querySelector('#q_eval_rating_error'),
                evaluation_confidence_explanation: form.querySelector('#q_eval_exp_error')
            };

            let isValid = true;
            let validationProgress = 10; // Start after initial 10%
            const progressIncrement = Math.floor(90 / Object.keys(inputs).length); // Distribute remaining 90%

            // --- Validation Loop ---
            for (const key in inputs) {
                const input = inputs[key];
                const errorEl = errors[key];
                let fieldValid = true;

                if (input.type === 'textarea') {
                    if (!input.value.trim()) {
                        errorEl.textContent = 'This field is required.'; errorEl.style.display = 'block'; input.classList.add('invalid'); fieldValid = false;
                    } else if (!validateWordCount(input, parseInt(input.getAttribute('data-min-words'), 10), errorEl, IS_ADMIN_USER)) {
                        fieldValid = false; // validateWordCount handles display
                    }
                } else if (input.type === 'number') {
                    const ratingVal = parseInt(input.value, 10);
                     if (!input.value || isNaN(ratingVal) || ratingVal < input.min || ratingVal > input.max) {
                        errorEl.textContent = `Please enter a valid rating between ${input.min} and ${input.max}.`; errorEl.style.display = 'block'; input.classList.add('invalid'); fieldValid = false;
                    }
                }
                 validationProgress += progressIncrement;
                 progressBar.style.width = `${Math.min(validationProgress, 95)}%`; // Update progress bar during validation

                 if (!fieldValid) isValid = false;
            }


            // --- Process if Valid ---
             // Use setTimeout to allow progress bar to visually update before final action
            setTimeout(() => {
                if (isValid) {
                    console.log("Final Assessment form is valid.");
                    progressBar.style.width = '100%';

                    // Re-fetch user data to ensure it's current before saving
                    let updatedUser = getLocalStorageUser();
                    if (!updatedUser) { // Safety check
                        console.error("Critical Error: User data lost before saving final assessment.");
                        alert("An error occurred saving your assessment. Please try again.");
                        submitButton.disabled = false; submitButton.textContent = 'Submit Final Assessment'; progressContainer.style.display = 'none';
                        return;
                    }

                    // Prepare answers object
                    const finalAnswers = {};
                    for (const key in inputs) {
                        finalAnswers[key] = inputs[key].value.trim();
                    }

                    // Save answers and completion status
                    updatedUser.finalAssessmentAnswers = finalAnswers;
                    updatedUser.finalAssessmentCompleted = true;

                     // Ensure progress object exists before assigning
                     if (!updatedUser.progress) { updatedUser.progress = {}; }
                    updatedUser.progress[FINAL_ASSESSMENT_ID] = 100; // Mark progress on dashboard

                    saveCurrentUser(updatedUser); // Save everything

                    // Show success popup
                    document.getElementById('assessmentCompletePopup').style.display = 'block';
                    document.getElementById('popupOverlay').style.display = 'block';

                } else {
                    console.log("Final Assessment form is invalid.");
                     submitButton.disabled = false;
                     submitButton.textContent = 'Submit Final Assessment';
                     progressContainer.style.display = 'none'; // Hide progress bar on failure
                     progressBar.style.width = '0%';      // Reset progress bar
                     const firstError = form.querySelector('.invalid');
                     if (firstError) {
                         firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                         firstError.focus();
                     }
                }
            }, 300); // Short delay for UI update

        }


        function logout() {
            console.log("Logging out user...");
            try {
                localStorage.removeItem(LOGGED_IN_KEY);
                localStorage.removeItem(CURRENT_USER_KEY);
                IS_ADMIN_USER = false; // Reset global flag
                currentUser = null;   // Clear global user data
                console.log("Local storage cleared for logout.");
                window.location.href = 'login.html';
            } catch (e) {
                console.error("Error during logout:", e);
                window.location.href = 'login.html'; // Force redirect
            }
        }

    </script>
</body>
</html>
