<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Assessment - Coaching & Leadership</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <style>
        /* --- Base Styles (Consistent) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f8fafc; margin: 0; padding: 0; line-height: 1.6; color: #374151; display: flex; flex-direction: column; min-height: 100vh; padding-top: 62px; /* Space for fixed header */ }
        main { flex-grow: 1; display: flex; justify-content: center; align-items: flex-start; flex-direction: column; width: 100%; max-width: 900px; /* Slightly narrower for better focus */ margin: 20px auto; padding: 0 20px; }

        /* User Bar (Consistent - No Changes) */
        .user-bar { background-color: #34495e; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; color: white; font-size: 14px; position: fixed; top: 0; left: 0; width: 100%; z-index: 1001; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-info svg { opacity: 0.8; vertical-align: middle; color: white; }
        .user-details-bar { display: flex; flex-direction: column; }
        .user-name-bar { font-weight: 600; font-size: 14px; color: white; }
        .user-email-bar { font-size: 12px; opacity: 0.8; color: white; }
        .logout-button { background-color: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 6px; font-size: 13px; }
        .logout-button:hover { background-color: #c0392b; transform: translateY(-1px); }
        .logout-button svg { color: white; }

        /* Footer (Consistent - No Changes) */
        .footer { text-align: center; padding: 25px 30px; background: #f9fafb; color: #6b7280; margin-top: auto; font-size: 14px; width: 100%; border-top: 1px solid #e5e7eb; }

        /* --- Final Assessment & Form Styles --- */
        .assessment-container {
            background: white;
            padding: 35px 45px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* Softer shadow */
            border-radius: 12px;
            width: 100%;
            margin-bottom: 35px;
            text-align: left;
            opacity: 0; /* Start hidden for fade-in */
            transition: opacity 0.7s ease-in-out;
            border: 1px solid #e5e7eb;
            display: none; /* Initially hidden until access check passes */
        }
        .assessment-container.fade-in { opacity: 1; } /* Class to trigger fade-in */

        /* Centered Title with Emoji */
        .assessment-container h2 {
             color: #1f2937;
             margin-bottom: 25px;
             font-size: 26px; /* Slightly smaller */
             font-weight: 600;
             border-bottom: 1px solid #e5e7eb;
             padding-bottom: 15px;
             text-align: center; /* Center the title */
         }
         .assessment-container h2 .title-emoji { /* Style for emoji if needed */
            display: inline-block;
            margin-right: 8px;
            font-size: 1.1em; /* Make emoji slightly larger */
         }

        .assessment-intro { background-color: #eff6ff; border-left: 5px solid #3b82f6; padding: 18px 25px; margin-bottom: 30px; border-radius: 6px; font-size: 15px; color: #374151; line-height: 1.7; }
        .assessment-intro strong { color: #1e40af; }
        #adminAssessmentNote { font-weight: bold; color: #b45309; display: none; /* Shown only for admin */ }

        /* NEW: Focus Reminder Style */
        .focus-reminder {
            background-color: #fffbeb; /* Light yellow */
            border: 1px solid #fcd34d; /* Amber border */
            color: #92400e; /* Dark amber text */
            padding: 12px 18px;
            margin-bottom: 30px;
            border-radius: 6px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #finalAssessmentForm .form-group {
            margin-bottom: 40px; /* More space between questions */
            padding: 20px; /* Add padding */
            border: 1px solid #e5e7eb; /* Subtle border instead of colored ones */
            border-radius: 8px;
            background-color: #f9fafb; /* Very light grey background */
        }
        #finalAssessmentForm label, #finalAssessmentForm legend { /* Style legend like label */
             display: block;
             margin-bottom: 12px;
             font-weight: 600;
             color: #374151;
             font-size: 17px; /* Slightly smaller label */
        }
         #finalAssessmentForm fieldset { border: none; padding: 0; margin: 0 0 15px 0; }
         #finalAssessmentForm fieldset label { font-weight: normal; font-size: 15px; margin-bottom: 8px; display: flex; align-items: center; }
         #finalAssessmentForm input[type="radio"] { margin-right: 8px; width: auto; accent-color: #7c3aed; /* Style radio button color */ }

        #finalAssessmentForm textarea, #finalAssessmentForm input[type="number"] {
             width: 100%; padding: 12px 14px; /* Slightly smaller padding */
             border: 1px solid #d1d5db; border-radius: 6px; font-size: 15px; transition: border-color 0.3s, box-shadow 0.3s; color: #1f2937; background-color: #fff; /* Ensure white background */
        }
        #finalAssessmentForm textarea { min-height: 120px; resize: vertical; }
        #finalAssessmentForm textarea:focus, #finalAssessmentForm input[type="number"]:focus, #finalAssessmentForm input[type="radio"]:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); outline: none; }
        #finalAssessmentForm .input-meta-info { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
        #finalAssessmentForm .word-count-info { font-size: 13px; color: #6b7280; }
        #finalAssessmentForm .paste-warning { font-size: 13px; color: #f97316; display: none; }
        #finalAssessmentForm .error-message { color: #ef4444; font-size: 14px; margin-top: 8px; display: none; font-weight: 500;}
        #finalAssessmentForm input.invalid, #finalAssessmentForm textarea.invalid { border-color: #ef4444; }

        /* NEW: Individual Answer Buttons Styling */
        .answer-actions { margin-top: 15px; display: flex; gap: 10px; align-items: center; }
        .answer-actions .action-feedback { font-size: 13px; color: #10b981; visibility: hidden; opacity: 0; transition: opacity 0.5s ease-out;}
        .answer-actions .action-feedback.show { visibility: visible; opacity: 1;}

        .save-answer-btn, .clear-answer-btn {
            background-color: #e5e7eb; color: #374151; border: 1px solid #d1d5db; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s ease;
        }
        .save-answer-btn:hover { background-color: #d1d5db; border-color: #9ca3af; }
        .clear-answer-btn { background-color: transparent; color: #ef4444; border: 1px solid transparent; }
        .clear-answer-btn:hover { background-color: #fee2e2; color: #b91c1c; border-color: #fecaca; }
        .save-answer-btn:disabled, .clear-answer-btn:disabled { background-color: #f3f4f6; color: #9ca3af; cursor: not-allowed; border-color: #e5e7eb; }

        /* NEW: Overall Progress Indicator Styling */
        #assessmentProgressContainer { margin-bottom: 30px; }
        #assessmentProgressLabel { font-size: 14px; color: #4b5563; margin-bottom: 8px; text-align: center; }
        #assessmentProgress { width: 100%; height: 12px; background-color: #e5e7eb; border-radius: 6px; overflow: hidden; }
        #assessmentProgressBar { width: 0%; height: 100%; background: linear-gradient(90deg, #a78bfa, #7c3aed); border-radius: 6px; transition: width 0.5s ease-out; }


        /* Final Submit Button (Consistent) */
        #finalSubmitBtn { background-color: #7c3aed; color: white; padding: 14px 30px; border: none; border-radius: 8px; font-size: 17px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: block; /* Make block */ margin: 30px auto 0 auto; /* Center button */ }
        #finalSubmitBtn:hover:not(:disabled) { background-color: #6d28d9; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(124, 58, 237, 0.25); }
        #finalSubmitBtn:disabled { background-color: #9ca3af; cursor: not-allowed; transform: none; box-shadow: none;}

        /* Completion Popup Styles (Refined) */
        #assessmentCompletePopup {
            display: none; /* Hidden initially */
            position: fixed;
            left: 50%; top: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 35px 40px; /* Adjusted padding */
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            z-index: 1002; /* Above overlay */
            text-align: center;
            border-top: 6px solid #7c3aed;
            min-width: 320px; /* Adjusted min-width */
            max-width: 450px; /* Added max-width */
         }
        #assessmentCompletePopup .completion-icon {
            font-size: 3rem; /* Larger icon */
            color: #10b981; /* Green color */
            margin-bottom: 15px;
        }
        #assessmentCompletePopup p { font-size: 17px; /* Slightly smaller text */ color: #374151; margin-bottom: 10px; line-height: 1.6; }
        #assessmentCompletePopup .completion-score {
            font-size: 15px; color: #6b7280; margin-bottom: 25px; font-weight: 500;
        }

        #assessmentCompletePopup button {
            background-color: #3b82f6; /* Blue button */
            color: white; padding: 11px 22px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; font-weight: 500; display: inline-flex; align-items: center; gap: 8px;
         }
        #assessmentCompletePopup button:hover { background-color: #2563eb; }
         .popup-overlay { /* Only for completion popup */
             display: none; /* Hidden initially */
             position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 1001; /* Below popup, above content */
         }

        /* Access Denied Modal (Consistent - No Changes) */
         .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.65); display: none; align-items: center; justify-content: center; z-index: 9999; cursor: pointer; padding: 20px; }
         .modal-content-box { background: white; border-radius: 12px; padding: 35px 40px; max-width: 450px; width: 95%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.25); cursor: default; border-top: 5px solid #e74c3c; }
         .modal-content-box h2 { color: #e74c3c; margin-bottom: 18px; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; gap: 8px; }
         .modal-content-box p { margin-bottom: 28px; color: #374151; font-size: 1.05rem; line-height: 1.6; }
         .modal-content-box button { background-color: #3498db; color: white; padding: 11px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 500; transition: background-color 0.3s ease; }
         .modal-content-box button:hover { background-color: #2980b9; }

        /* Loading / Initial Message */
         #loadingOrAccessMessage { text-align: center; padding: 60px 20px; font-size: 20px; color: #6b7280; width: 100%; }

        /* Responsive Adjustments */
         @media (max-width: 768px) { body { padding-top: 62px; } main { padding: 0 15px; margin: 15px auto; } .assessment-container { padding: 25px 30px; } .user-bar { padding: 10px 15px; } }
         @media (max-width: 600px) {
            .assessment-container { padding: 20px 15px; }
             .assessment-container h2 { font-size: 22px; }
            #finalAssessmentForm textarea { min-height: 100px; }
            #finalAssessmentForm label, #finalAssessmentForm legend { font-size: 16px; }
            #finalAssessmentForm input[type="number"], #finalAssessmentForm textarea { padding: 10px 12px; font-size: 14px; }
            .save-answer-btn, .clear-answer-btn { padding: 5px 10px; font-size: 12px; }
            #finalSubmitBtn { padding: 12px 25px; font-size: 16px; }
            #assessmentCompletePopup { width: 90%; padding: 25px 20px; }
            .modal-content-box { padding: 25px 15px; }
            .modal-content-box h2 { font-size: 1.3rem; }
            .modal-content-box p { font-size: 0.95rem; }
            .modal-content-box button { padding: 10px 20px; font-size: 0.9rem;}
            .focus-reminder { font-size: 13px; padding: 10px 15px; }
        }
    </style>
</head>
<body>
    <!-- User Bar (Consistent - No Changes) -->
    <div class="user-bar">
        <div class="user-info">
             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            <div class="user-details-bar">
                <span class="user-name-bar" id="userNameBar">Loading...</span>
                <span class="user-email-bar" id="userEmailBar"></span>
            </div>
        </div>
        <button class="logout-button" onclick="logout()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
            Logout
        </button>
    </div>

    <!-- Access Denied Modal (Consistent - No Changes) -->
    <div id="accessDeniedModal" class="modal-overlay" style="display: none;">
      <div class="modal-content-box" onclick="event.stopPropagation()">
          <h2>ðŸš« Access Denied</h2>
          <p>You need to complete all course modules before taking the final assessment.</p>
          <button onclick="goBackToNext()">Go Back</button>
      </div>
    </div>

    <!-- Main Content Area -->
    <main>
        <div id="loadingOrAccessMessage">Loading Assessment...</div>

        <!-- Final Assessment Container -->
        <section id="assessmentContainer" class="assessment-container">
             <h2><span class="title-emoji">ðŸ¤”</span> Post-Course Reflection</h2>
            <p class="assessment-intro">
                <strong>Congratulations on completing the core modules!</strong> This final assessment helps you reflect on your learning and how you'll apply it. Please answer thoughtfully and honestly in your own words. Save your progress after each question.
                <span id="adminAssessmentNote"> (Admin: Word count and paste restrictions are disabled for your account.)</span>
            </p>

            <!-- Focus Reminder -->
             <div class="focus-reminder">
                 <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                 <span>Please focus on providing your genuine reflections. Each answer should be considered carefully.</span>
             </div>

            <!-- Overall Progress Indicator -->
             <div id="assessmentProgressContainer">
                 <div id="assessmentProgressLabel">Assessment Progress: 0%</div>
                 <div id="assessmentProgress">
                     <div id="assessmentProgressBar"></div>
                 </div>
             </div>


            <form id="finalAssessmentForm" novalidate>
                <!-- Question 1: Situational Disengaged -->
                 <div class="form-group">
                     <label for="q_situational_disengaged">Scenario: You notice a team member who seems consistently disengaged during coaching sessions. They give short answers and avoid eye contact.</label>
                     <textarea id="q_situational_disengaged" name="situational_disengaged" required data-min-words="30" data-question-id="q_situational_disengaged" placeholder="Outline your approach to address this situation in the next session. What specific techniques might you use?"></textarea>
                     <div class="input-meta-info">
                         <div class="paste-warning" id="q_situational_disengaged_paste_warning">Pasting...</div>
                         <div class="word-count-info" id="q_situational_disengaged_word_count_container">Words: <span id="q_situational_disengaged_word_count">0</span><span>/30</span></div>
                     </div>
                     <div class="error-message" id="q_situational_disengaged_error"></div>
                     <div class="answer-actions">
                        <button type="button" class="save-answer-btn" data-question-id="q_situational_disengaged">Save Answer</button>
                        <button type="button" class="clear-answer-btn" data-question-id="q_situational_disengaged">Clear Answer</button>
                        <span class="action-feedback" id="q_situational_disengaged_feedback"></span>
                     </div>
                 </div>

                 <!-- Question 2: Situational Feedback -->
                 <div class="form-group">
                     <label for="q_situational_feedback">Scenario: You need to provide constructive feedback to a high-performing team member about a minor but recurring communication issue.</label>
                     <textarea id="q_situational_feedback" name="situational_feedback" required data-min-words="30" data-question-id="q_situational_feedback" placeholder="Describe your feedback process using a recognized model (e.g., SBI, STAR). How will you ensure the feedback lands effectively?"></textarea>
                     <div class="input-meta-info">
                         <div class="paste-warning" id="q_situational_feedback_paste_warning">Pasting...</div>
                         <div class="word-count-info" id="q_situational_feedback_word_count_container">Words: <span id="q_situational_feedback_word_count">0</span><span>/30</span></div>
                     </div>
                     <div class="error-message" id="q_situational_feedback_error"></div>
                     <div class="answer-actions">
                        <button type="button" class="save-answer-btn" data-question-id="q_situational_feedback">Save Answer</button>
                        <button type="button" class="clear-answer-btn" data-question-id="q_situational_feedback">Clear Answer</button>
                        <span class="action-feedback" id="q_situational_feedback_feedback"></span>
                    </div>
                 </div>

                 <!-- Question 3: Reflection Skill -->
                 <div class="form-group">
                     <label for="q_reflection_skill">Whatâ€™s one specific coaching skill (e.g., active listening, powerful questioning, goal setting) you feel you've significantly improved through this course?</label>
                     <textarea id="q_reflection_skill" name="reflection_skill_improved" required data-min-words="30" data-question-id="q_reflection_skill" placeholder="Identify the skill and provide a specific example of how you might apply it differently now compared to before the course."></textarea>
                     <div class="input-meta-info">
                         <div class="paste-warning" id="q_reflection_skill_paste_warning">Pasting...</div>
                         <div class="word-count-info" id="q_reflection_skill_word_count_container">Words: <span id="q_reflection_skill_word_count">0</span><span>/30</span></div>
                     </div>
                     <div class="error-message" id="q_reflection_skill_error"></div>
                     <div class="answer-actions">
                        <button type="button" class="save-answer-btn" data-question-id="q_reflection_skill">Save Answer</button>
                        <button type="button" class="clear-answer-btn" data-question-id="q_reflection_skill">Clear Answer</button>
                        <span class="action-feedback" id="q_reflection_skill_feedback"></span>
                    </div>
                 </div>

                 <!-- Question 4: Reflection Challenge -->
                 <div class="form-group">
                     <label for="q_reflection_challenge">Reflecting on the course material, what was the most challenging concept or technique for you to grasp or consider implementing?</label>
                     <textarea id="q_reflection_challenge" name="reflection_challenge" required data-min-words="30" data-question-id="q_reflection_challenge" placeholder="Discuss your biggest challenge and outline one step you plan to take to overcome it or practice it further."></textarea>
                     <div class="input-meta-info">
                         <div class="paste-warning" id="q_reflection_challenge_paste_warning">Pasting...</div>
                         <div class="word-count-info" id="q_reflection_challenge_word_count_container">Words: <span id="q_reflection_challenge_word_count">0</span><span>/30</span></div>
                     </div>
                     <div class="error-message" id="q_reflection_challenge_error"></div>
                     <div class="answer-actions">
                         <button type="button" class="save-answer-btn" data-question-id="q_reflection_challenge">Save Answer</button>
                         <button type="button" class="clear-answer-btn" data-question-id="q_reflection_challenge">Clear Answer</button>
                         <span class="action-feedback" id="q_reflection_challenge_feedback"></span>
                     </div>
                 </div>

                 <!-- Question 5: Evaluation (Rating + Explanation) -->
                 <div class="form-group">
                     <label for="q_eval_confidence_rating">On a scale of 1 (Not confident) to 5 (Very confident), how confident do you feel in applying the coaching principles learned in this course *after* completing it?</label>
                     <input type="number" id="q_eval_confidence_rating" name="evaluation_confidence_rating" required min="1" max="5" step="1" data-question-id="q_eval_confidence_rating" placeholder="Enter 1-5">
                     <div class="error-message" id="q_eval_confidence_rating_error"></div>
                     <!-- Add save/delete for rating -->
                     <div class="answer-actions" style="margin-bottom: 15px;">
                         <button type="button" class="save-answer-btn" data-question-id="q_eval_confidence_rating">Save Rating</button>
                         <button type="button" class="clear-answer-btn" data-question-id="q_eval_confidence_rating">Clear Rating</button>
                         <span class="action-feedback" id="q_eval_confidence_rating_feedback"></span>
                     </div>

                     <label for="q_eval_confidence_explanation" style="margin-top: 20px;">Briefly explain your rating.</label>
                     <textarea id="q_eval_confidence_explanation" name="evaluation_confidence_explanation" required data-min-words="25" data-question-id="q_eval_confidence_explanation" placeholder="Explain your confidence level. What contributed most to this feeling?"></textarea>
                     <div class="input-meta-info">
                         <div class="paste-warning" id="q_eval_confidence_explanation_paste_warning">Pasting...</div>
                         <div class="word-count-info" id="q_eval_confidence_explanation_word_count_container">Words: <span id="q_eval_confidence_explanation_word_count">0</span><span>/25</span></div>
                     </div>
                     <div class="error-message" id="q_eval_confidence_explanation_error"></div>
                     <div class="answer-actions">
                        <button type="button" class="save-answer-btn" data-question-id="q_eval_confidence_explanation">Save Explanation</button>
                        <button type="button" class="clear-answer-btn" data-question-id="q_eval_confidence_explanation">Clear Explanation</button>
                        <span class="action-feedback" id="q_eval_confidence_explanation_feedback"></span>
                    </div>
                 </div>

                 <!-- Question 6: Multiple Choice (NEW) -->
                 <div class="form-group">
                      <fieldset data-question-id="q_mc_model_preference">
                         <legend>Which coaching model discussed (or similar structured approaches) do you foresee yourself using most often?</legend>
                         <label><input type="radio" name="mc_model_preference" value="grow" required> The GROW Model (Goal, Reality, Options, Will)</label>
                         <label><input type="radio" name="mc_model_preference" value="skillwill"> The Skill/Will Matrix (Guide, Delegate, Direct, Excite)</label>
                         <label><input type="radio" name="mc_model_preference" value="solution"> Solution-Focused Coaching (Focus on solutions, not problems)</label>
                         <label><input type="radio" name="mc_model_preference" value="positive"> The POSITIVE Model (Motivation & long-term goals)</label>
                         <label><input type="radio" name="mc_model_preference" value="practice"> The PRACTICE Model (Problem identification & solving)</label>
                         <label><input type="radio" name="mc_model_preference" value="mix"> A mix, depending on the situation</label>
                         <label><input type="radio" name="mc_model_preference" value="unsure"> Unsure yet</label>
                      </fieldset>
                      <div class="error-message" id="q_mc_model_preference_error">Please select an option.</div>
                      <div class="answer-actions">
                          <button type="button" class="save-answer-btn" data-question-id="q_mc_model_preference">Save Selection</button>
                          <button type="button" class="clear-answer-btn" data-question-id="q_mc_model_preference">Clear Selection</button>
                          <span class="action-feedback" id="q_mc_model_preference_feedback"></span>
                      </div>
                 </div>

                 <!-- Submit Button -->
                <button type="submit" id="finalSubmitBtn">Submit Final Assessment</button>
            </form>
        </section>

        <!-- Completion Popup (Refined) -->
        <div class="popup-overlay" id="completionPopupOverlay"></div>
        <div id="assessmentCompletePopup">
             <div class="completion-icon">ðŸŽ‰</div> <!-- Celebration Emoji -->
             <p>Thank you for completing the final assessment!</p>
             <p class="completion-score" id="completionScoreText">Your completion score: 100%</p> <!-- Score will be updated by JS -->
             <button id="proceedToFeedbackBtn">
                 <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-message-circle"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                 Proceed to Feedback
             </button>
        </div>

    </main>

    <!-- Footer (Consistent - No Changes) -->
    <footer class="footer">
        Â© 2025 Elmenisy Leadership Coaching - All Rights Reserved
    </footer>

    <script>
        // --- Constants (Consistent - No Changes) ---
        const LOGGED_IN_KEY = 'isUserLoggedIn';
        const CURRENT_USER_KEY = 'currentUser';
        const ADMIN_EMAIL = 'm.elsayed@thechefz.co'; // IMPORTANT: Set the correct admin email
        const FINAL_ASSESSMENT_ID = 'final_assessment'; // Keep for progress tracking? Yes.
        const FEEDBACK_URL = 'feedback.html'; // Target after completion
        const WHATS_NEXT_URL = 'whats-next.html'; // Target if access denied
        const requiredCourseSections = [
            { id: 'index' }, { id: 'article1' }, { id: 'skills' },
            { id: 'individuals' }, { id: 'team' }, { id: 'self' }, { id: 'action' }
        ];

        // --- Globals ---
        let IS_ADMIN_USER = false;
        let currentUser = null;

        // --- Get User Data Function (Consistent - No Changes) ---
        function getLocalStorageUser() { /* ... Keep existing implementation ... */ try { const userDataString = localStorage.getItem(CURRENT_USER_KEY); if (!userDataString) return null; const parsedUser = JSON.parse(userDataString); if (parsedUser && typeof parsedUser === 'object' && parsedUser.name && parsedUser.email && parsedUser.progress) { return parsedUser; } console.warn("Invalid user data structure in localStorage."); return null; } catch (error) { console.error("Error parsing user data:", error); return null; } }
        function saveCurrentUser(userObject) { /* ... Keep existing implementation ... */ try { if (!userObject) throw new Error("Cannot save invalid user object."); localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(userObject)); console.log("User data saved:", userObject); } catch (error) { console.error("Error saving user data:", error); } }
        function populateTopBar(user) { /* ... Keep existing implementation ... */ const userNameElement = document.getElementById('userNameBar'); const userEmailElement = document.getElementById('userEmailBar'); if (user && userNameElement && userEmailElement) { userNameElement.textContent = user.name || 'User'; userEmailElement.textContent = user.email; } else { if(userNameElement) userNameElement.textContent = 'N/A'; if(userEmailElement) userEmailElement.textContent = 'N/A'; } }
        function countWords(text) { /* ... Keep existing implementation ... */ return text ? text.trim().split(/\s+/).filter(Boolean).length : 0; }
        function goBackToNext() { /* ... Keep existing implementation ... */ console.log("Redirecting user to required completion page:", WHATS_NEXT_URL); window.location.href = WHATS_NEXT_URL; }
        function logout() { /* ... Keep existing implementation ... */ console.log("Logging out..."); try { localStorage.removeItem(LOGGED_IN_KEY); localStorage.removeItem(CURRENT_USER_KEY); IS_ADMIN_USER = false; currentUser = null; window.location.href = 'login.html'; } catch (e) { console.error("Logout error:", e); window.location.href = 'login.html'; } }

        // --- IMMEDIATE ACCESS CONTROL (Self-Executing Function - No Changes) ---
        (function checkAccess() { /* ... Keep existing implementation ... */ console.log("%cRunning IMMEDIATE access check...", "color: orange; font-weight: bold;"); const isLoggedIn = localStorage.getItem(LOGGED_IN_KEY) === 'true'; const user = getLocalStorageUser(); if (!isLoggedIn || !user || !user.progress) { console.warn("Redirecting to login: User not logged in or data invalid."); window.location.replace('login.html'); throw new Error("Redirecting user: Not logged in or invalid data. Halting script."); } const isAdmin = user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase(); IS_ADMIN_USER = isAdmin; if (isAdmin) { console.log("%cAdmin Access Granted: Bypassing module completion checks.", "color: blue; font-weight: bold;"); currentUser = user; } else { console.log("%cNon-Admin User: Checking module completion...", "color: orange;"); let allSectionsComplete = true; for (const section of requiredCourseSections) { if ((user.progress[section.id] || 0) < 100) { allSectionsComplete = false; console.warn(`Non-admin incomplete: Section '${section.id}' (Progress: ${user.progress[section.id] || 0})`); break; } } if (!allSectionsComplete) { console.warn("%cAccess Denied for Non-Admin: Course not fully completed. Showing Modal.", "color: red; font-weight: bold;"); const loadingMsg = document.getElementById('loadingOrAccessMessage'); const assessmentContainer = document.getElementById('assessmentContainer'); if (loadingMsg) loadingMsg.style.display = 'none'; if (assessmentContainer) assessmentContainer.style.display = 'none'; const modal = document.getElementById('accessDeniedModal'); if (modal) { modal.style.display = 'flex'; } else { console.error("Access Denied Modal element (#accessDeniedModal) not found!"); alert("Access Denied: Please complete all course modules."); window.location.href = WHATS_NEXT_URL; } throw new Error("Stopping script: Non-admin user has not completed required modules."); } else { console.log("%cNon-Admin Access Granted: All modules completed.", "color: green; font-weight: bold;"); currentUser = user; } } console.log("%cAccess Check Complete: Proceeding with page setup.", "color: green;"); })();
        // --- END IMMEDIATE ACCESS CONTROL ---


        // --- DOMContentLoaded Event Listener (MODIFIED) ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM fully loaded. Setting up assessment page.");

            if (!currentUser) { /* ... Keep existing error handling ... */ console.error("DOM Load Error: currentUser is null. Access was likely denied earlier. Aborting page setup."); const loadingMsg = document.getElementById('loadingOrAccessMessage'); if (loadingMsg) loadingMsg.textContent = 'Page setup aborted due to access restrictions.'; const assessmentContainer = document.getElementById('assessmentContainer'); if (assessmentContainer) assessmentContainer.style.display = 'none'; return; }

            const loadingMsg = document.getElementById('loadingOrAccessMessage');
            const assessmentContainer = document.getElementById('assessmentContainer');
            const assessmentForm = document.getElementById('finalAssessmentForm');
            const accessDeniedModal = document.getElementById('accessDeniedModal');

            populateTopBar(currentUser);
            setupFormInteractions(); // Setup word count, paste prevention, save/delete buttons
            loadAnswers(); // Load existing answers from localStorage
            updateProgressIndicator(); // Update progress bar based on loaded answers

            const alreadyCompleted = currentUser.finalAssessmentCompleted || currentUser.progress[FINAL_ASSESSMENT_ID] === 100;

             if (alreadyCompleted) {
                 disableFormAndShowCompletion(); // Disable everything and show completion popup if needed
             } else {
                 // Only add submit listener if not already completed
                 assessmentForm.addEventListener('submit', handleFinalAssessmentSubmit);
             }

             // Always setup feedback button listener
             setupFeedbackButtonListener();

            if (loadingMsg) loadingMsg.style.display = 'none';
            if (assessmentContainer) { // Show the main container
                assessmentContainer.style.display = 'block';
                setTimeout(() => assessmentContainer.classList.add('fade-in'), 50);
            }

            // Modal close listener (Consistent - No Changes)
            if (accessDeniedModal) { accessDeniedModal.addEventListener('click', function (event) { if (event.target === accessDeniedModal) { goBackToNext(); } }); }
        });

        // --- NEW: Functions for Individual Answer Handling ---

        function showActionFeedback(questionId, message) {
            const feedbackEl = document.getElementById(`${questionId}_feedback`);
            if (feedbackEl) {
                feedbackEl.textContent = message;
                feedbackEl.classList.add('show');
                setTimeout(() => {
                    feedbackEl.classList.remove('show');
                }, 2000); // Hide after 2 seconds
            }
        }

        function saveAnswer(questionId) {
            const inputElement = document.querySelector(`[data-question-id="${questionId}"]:not(button)`);
            let answerValue = null;

            if (!inputElement) {
                console.error(`Input element not found for question ID: ${questionId}`);
                return;
            }

            if (inputElement.type === 'textarea' || inputElement.type === 'number') {
                answerValue = inputElement.value.trim();
            } else if (inputElement.tagName === 'FIELDSET') { // Handle radio buttons
                const checkedRadio = inputElement.querySelector('input[type="radio"]:checked');
                answerValue = checkedRadio ? checkedRadio.value : null;
            } else {
                 console.warn(`Unsupported input type for saving: ${inputElement.type || inputElement.tagName}`);
                 return; // Don't save unsupported types
            }

            // Basic Validation before saving
            let isValidForSave = true;
            const errorElement = document.getElementById(`${questionId}_error`);
            if(errorElement) errorElement.style.display = 'none'; // Hide previous error
            if(inputElement.classList) inputElement.classList.remove('invalid');

            if (inputElement.required && !answerValue) {
                if (errorElement) {
                    errorElement.textContent = 'This field is required to save.';
                    errorElement.style.display = 'block';
                }
                if(inputElement.classList) inputElement.classList.add('invalid');
                 isValidForSave = false;
            } else if (inputElement.type === 'textarea' && inputElement.dataset.minWords && !IS_ADMIN_USER) {
                if (!validateWordCount(inputElement, parseInt(inputElement.dataset.minWords, 10), errorElement)) {
                    isValidForSave = false;
                 }
            } else if (inputElement.type === 'number') {
                 const ratingVal = parseInt(inputElement.value, 10);
                 const min = parseInt(inputElement.min, 10);
                 const max = parseInt(inputElement.max, 10);
                 if (inputElement.required && (!inputElement.value || isNaN(ratingVal) || ratingVal < min || ratingVal > max)) {
                    if(errorElement) {
                        errorElement.textContent = `Please enter a valid rating between ${min} and ${max}.`;
                        errorElement.style.display = 'block';
                    }
                    if(inputElement.classList) inputElement.classList.add('invalid');
                    isValidForSave = false;
                 }
             } else if (inputElement.tagName === 'FIELDSET' && inputElement.querySelector('input[required]') && !answerValue) {
                  if (errorElement) {
                     errorElement.textContent = 'Please select an option to save.';
                     errorElement.style.display = 'block';
                  }
                  isValidForSave = false;
             }


            if (!isValidForSave) {
                console.warn(`Validation failed for ${questionId}. Not saving.`);
                showActionFeedback(questionId, 'Validation failed!');
                return; // Don't save if invalid
            }


            currentUser = getLocalStorageUser(); // Get fresh data
            if (!currentUser) { console.error("Cannot save answer: User data missing."); return; }

            if (!currentUser.finalAssessmentAnswers) {
                currentUser.finalAssessmentAnswers = {};
            }
            currentUser.finalAssessmentAnswers[questionId] = answerValue;
            saveCurrentUser(currentUser);
            console.log(`Answer saved for ${questionId}:`, answerValue);
            showActionFeedback(questionId, 'Answer Saved!');
            updateProgressIndicator(); // Update progress after saving
        }

        function deleteAnswer(questionId) {
            const inputElement = document.querySelector(`[data-question-id="${questionId}"]:not(button)`);
            const errorElement = document.getElementById(`${questionId}_error`);
            const wordCountSpan = document.getElementById(`${questionId}_word_count`); // For resetting word count display

            if (!inputElement) {
                 console.error(`Input element not found for question ID: ${questionId}`);
                 return;
            }

            if (inputElement.type === 'textarea' || inputElement.type === 'number') {
                inputElement.value = '';
                if (wordCountSpan) wordCountSpan.textContent = '0'; // Reset word count display
            } else if (inputElement.tagName === 'FIELDSET') { // Handle radio buttons
                 const radios = inputElement.querySelectorAll('input[type="radio"]');
                 radios.forEach(radio => radio.checked = false);
            }

            if(errorElement) errorElement.style.display = 'none'; // Hide error on clear
            if(inputElement.classList) inputElement.classList.remove('invalid');

            currentUser = getLocalStorageUser(); // Get fresh data
            if (!currentUser || !currentUser.finalAssessmentAnswers) {
                console.log(`No answers to delete for ${questionId}.`);
                 showActionFeedback(questionId, 'Answer Cleared!');
                return;
            } // Nothing to delete

            delete currentUser.finalAssessmentAnswers[questionId];
            saveCurrentUser(currentUser);
            console.log(`Answer deleted for ${questionId}`);
            showActionFeedback(questionId, 'Answer Cleared!');
            updateProgressIndicator(); // Update progress after deleting
        }

        function loadAnswers() {
            currentUser = getLocalStorageUser(); // Ensure we have the latest user data
            if (!currentUser || !currentUser.finalAssessmentAnswers) {
                console.log("No saved assessment answers found to load.");
                return;
            }

            console.log("Loading saved answers...");
            const answers = currentUser.finalAssessmentAnswers;
            for (const questionId in answers) {
                const inputElement = document.querySelector(`[data-question-id="${questionId}"]:not(button)`);
                if (inputElement) {
                    if (inputElement.type === 'textarea' || inputElement.type === 'number') {
                        inputElement.value = answers[questionId] || '';
                        // Trigger input event to update word count for textareas
                        if(inputElement.type === 'textarea') {
                            inputElement.dispatchEvent(new Event('input', { bubbles: true }));
                        }
                    } else if (inputElement.tagName === 'FIELDSET') {
                        const targetValue = answers[questionId];
                        const radioToCheck = inputElement.querySelector(`input[type="radio"][value="${targetValue}"]`);
                        if (radioToCheck) {
                            radioToCheck.checked = true;
                        }
                    }
                } else {
                    console.warn(`Input element not found for saved answer ID: ${questionId}`);
                }
            }
        }

        // --- NEW: Progress Indicator Function ---
        function updateProgressIndicator() {
            const form = document.getElementById('finalAssessmentForm');
            const progressBar = document.getElementById('assessmentProgressBar');
            const progressLabel = document.getElementById('assessmentProgressLabel');
            if (!form || !progressBar || !progressLabel) return;

            const requiredInputs = form.querySelectorAll('[required][data-question-id]');
            const totalRequired = requiredInputs.length;
            if (totalRequired === 0) {
                progressBar.style.width = '100%';
                progressLabel.textContent = 'Assessment Progress: 100% (No required fields)';
                return;
            }

            let answeredCount = 0;
            const savedAnswers = currentUser?.finalAssessmentAnswers || {};

            requiredInputs.forEach(input => {
                const questionId = input.dataset.questionId;
                // Check if an answer exists AND it's not empty/null
                if (savedAnswers.hasOwnProperty(questionId) && savedAnswers[questionId]) {
                     // Special check for radio groups - ensure the fieldset itself has an answer
                     if(input.tagName === 'FIELDSET') {
                          // Find the actual input within the fieldset to get the ID
                          const radioInput = input.querySelector('input[type="radio"][data-question-id]');
                          if (radioInput && savedAnswers.hasOwnProperty(radioInput.dataset.questionId) && savedAnswers[radioInput.dataset.questionId]) {
                               answeredCount++;
                          }
                     } else if (input.type !== 'radio') { // Don't double count radio buttons here
                          answeredCount++;
                     }
                } else if (input.tagName === 'FIELDSET') { // Handle case where answer might be saved under radio id not fieldset id
                     const radioInput = input.querySelector('input[type="radio"]');
                     if (radioInput && savedAnswers.hasOwnProperty(radioInput.dataset.questionId) && savedAnswers[radioInput.dataset.questionId]) {
                          answeredCount++;
                     }
                }
            });

            // Ensure answeredCount doesn't exceed totalRequired (e.g., due to fieldset counting)
            answeredCount = Math.min(answeredCount, totalRequired);


            const percentage = totalRequired > 0 ? Math.round((answeredCount / totalRequired) * 100) : 100;
            progressBar.style.width = `${percentage}%`;
            progressLabel.textContent = `Assessment Progress: ${percentage}%`;
            console.log(`Progress Updated: ${answeredCount}/${totalRequired} (${percentage}%)`);
        }

        // --- Form Setup Functions (Minor Modifications) ---

        function validateWordCount(textarea, minWords, errorElement) {
            if (IS_ADMIN_USER || isNaN(minWords)) {
                if (errorElement) errorElement.style.display = 'none';
                if(textarea.classList) textarea.classList.remove('invalid');
                return true;
            }
            const words = countWords(textarea.value);
            const isFieldEmpty = !textarea.value.trim();

            if (!isFieldEmpty && words < minWords) {
                if(errorElement) {
                    errorElement.textContent = `Minimum ${minWords} words required.`;
                    errorElement.style.display = 'block';
                }
                if(textarea.classList) textarea.classList.add('invalid');
                return false;
            } else {
                if (errorElement) errorElement.style.display = 'none';
                 if(textarea.classList) textarea.classList.remove('invalid');
                return true; // Valid if not empty and meets word count, OR if empty (required check is separate)
            }
        }

        function setupWordCountValidation(textarea) {
            const questionId = textarea.dataset.questionId;
            const countSpan = document.getElementById(`${questionId}_word_count`);
            const errorElement = document.getElementById(`${questionId}_error`);
            const countContainer = document.getElementById(`${questionId}_word_count_container`);
            const minWords = parseInt(textarea.getAttribute('data-min-words'), 10);

            if (!countSpan || !errorElement || !countContainer || isNaN(minWords)) return;

            if (IS_ADMIN_USER) {
                countContainer.style.display = 'none'; return;
            }

            const minWordsDisplay = countContainer.querySelector('span + span');
            if (minWordsDisplay) minWordsDisplay.textContent = `/${minWords}`;

            textarea.addEventListener('input', () => {
                const words = countWords(textarea.value);
                countSpan.textContent = words;
                validateWordCount(textarea, minWords, errorElement); // Validate on input
            });
            // Initial validation call might be useful if loading pre-filled data
            // validateWordCount(textarea, minWords, errorElement); // Commented out - let save handle initial validation
        }


        function setupPastePrevention(textarea) {
            if (IS_ADMIN_USER) return;
            const questionId = textarea.dataset.questionId;
             const warningElement = document.getElementById(`${questionId}_paste_warning`);
            if (!warningElement) return;

            textarea.addEventListener('paste', (event) => {
                event.preventDefault();
                warningElement.textContent = 'Pasting content is disabled.';
                warningElement.style.display = 'block';
                setTimeout(() => { warningElement.style.display = 'none'; }, 4000);
            });
        }

         // Consolidate form interaction setups
         function setupFormInteractions() {
             const form = document.getElementById('finalAssessmentForm'); if (!form) return;

             if (IS_ADMIN_USER) {
                 const adminNote = document.getElementById('adminAssessmentNote');
                 if (adminNote) adminNote.style.display = 'inline';
                 form.querySelectorAll('textarea[data-min-words]').forEach(ta => ta.placeholder = "Admin Mode: No restrictions.");
             } else {
                 form.querySelectorAll('textarea[data-min-words]').forEach(ta => {
                     const min = ta.getAttribute('data-min-words');
                     if (min) ta.placeholder += ` (Minimum ${min} words)`;
                 });
             }

             // Setup Textareas
             form.querySelectorAll('textarea[data-question-id]').forEach(ta => {
                 setupWordCountValidation(ta);
                 setupPastePrevention(ta);
             });

             // Setup Number Inputs (Basic validation on input/blur could be added if needed)
              form.querySelectorAll('input[type="number"][data-question-id]').forEach(numInput => {
                // Add validation listener if needed, similar to rating in previous versions
              });


             // Setup Save Buttons
             form.querySelectorAll('.save-answer-btn').forEach(button => {
                 button.addEventListener('click', (e) => {
                    const questionId = e.target.dataset.questionId;
                    saveAnswer(questionId);
                 });
             });

             // Setup Clear Buttons
             form.querySelectorAll('.clear-answer-btn').forEach(button => {
                 button.addEventListener('click', (e) => {
                    const questionId = e.target.dataset.questionId;
                    deleteAnswer(questionId);
                 });
             });
         }


        // --- Final Submission Handling (MODIFIED) ---
        function handleFinalAssessmentSubmit(event) {
            event.preventDefault();
            console.log("Final Assessment submission initiated...");
            const form = event.target;
            const submitButton = document.getElementById('finalSubmitBtn');

            submitButton.disabled = true;
            submitButton.textContent = 'Checking Answers...';
            form.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            form.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));

            let allRequiredAnswered = true;
            const requiredInputs = form.querySelectorAll('[required][data-question-id]');
            const savedAnswers = currentUser?.finalAssessmentAnswers || {};

            requiredInputs.forEach(input => {
                const questionId = input.dataset.questionId;
                let hasAnswer = savedAnswers.hasOwnProperty(questionId) && savedAnswers[questionId];

                 // Check specifically for radio button groups based on fieldset ID
                 if (input.tagName === 'FIELDSET') {
                     const radioInput = input.querySelector('input[type="radio"]'); // Any radio in the group
                     if (radioInput) {
                          const radioQuestionId = radioInput.dataset.questionId; // Use ID from radio if available
                          hasAnswer = savedAnswers.hasOwnProperty(radioQuestionId) && savedAnswers[radioQuestionId];
                          // If still no answer, check using fieldset ID as fallback
                          if (!hasAnswer) {
                               hasAnswer = savedAnswers.hasOwnProperty(questionId) && savedAnswers[questionId];
                          }
                     } else {
                         // Fallback if no radio has ID, use fieldset ID directly
                         hasAnswer = savedAnswers.hasOwnProperty(questionId) && savedAnswers[questionId];
                     }
                 }


                if (!hasAnswer) {
                    allRequiredAnswered = false;
                    const errorEl = document.getElementById(`${questionId}_error`);
                    if (errorEl) {
                        errorEl.textContent = 'This required field has not been saved.';
                        errorEl.style.display = 'block';
                    }
                     // Highlight the first input within the group if possible
                    const fieldToHighlight = input.tagName === 'FIELDSET' ? input.querySelector('input, textarea') : input;
                    if(fieldToHighlight && fieldToHighlight.classList) fieldToHighlight.classList.add('invalid');
                    else if (input.classList) input.classList.add('invalid'); // Highlight fieldset or input itself
                }
            });

            setTimeout(() => { // Simulate check delay
                if (allRequiredAnswered) {
                    console.log("All required questions answered. Finalizing submission.");
                    currentUser = getLocalStorageUser(); // Get fresh data
                    if (!currentUser) { /* ... Error handling ... */ alert("Error submitting. User data not found."); submitButton.disabled = false; submitButton.textContent = 'Submit Final Assessment'; return; }

                    currentUser.finalAssessmentCompleted = true;
                    if (!currentUser.progress) { currentUser.progress = {}; }
                    currentUser.progress[FINAL_ASSESSMENT_ID] = 100; // Mark progress as 100
                    saveCurrentUser(currentUser);

                    // Calculate final score/percentage for display
                    updateProgressIndicator(); // Ensure progress is 100%
                    const finalPercentage = 100; // Assume 100 if all required are answered

                    disableFormAndShowCompletion(finalPercentage); // Pass percentage

                } else {
                    console.log("Submission check failed: Not all required questions answered.");
                    submitButton.disabled = false; // Re-enable button
                    submitButton.textContent = 'Submit Final Assessment';
                    const firstError = form.querySelector('.invalid');
                    if (firstError) {
                        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // Focus might not work well on fieldset, focus first input inside if possible
                        const focusTarget = firstError.tagName === 'FIELDSET' ? firstError.querySelector('input, textarea') : firstError;
                         if(focusTarget) focusTarget.focus();
                    }
                    alert("Please ensure all required questions have saved answers before submitting.");
                }
            }, 300);
        }

        // --- NEW: Function to Disable Form and Show Popup ---
        function disableFormAndShowCompletion(percentage = 100) { // Default to 100 if called without arg
            const form = document.getElementById('finalAssessmentForm');
            const submitButton = document.getElementById('finalSubmitBtn');
            const completePopup = document.getElementById('assessmentCompletePopup');
            const completionOverlay = document.getElementById('completionPopupOverlay');
            const scoreTextElement = document.getElementById('completionScoreText');

            // Disable all inputs and buttons within the form
            if(form) {
                form.querySelectorAll('textarea, input, button, fieldset').forEach(el => el.disabled = true);
            }
             if (submitButton) {
                 submitButton.textContent = 'Assessment Submitted';
                 submitButton.disabled = true;
             }

             // Show completion popup
             if (completePopup && completionOverlay && scoreTextElement) {
                 scoreTextElement.textContent = `Your completion score: ${percentage}%`;
                 completePopup.style.display = 'block';
                 completionOverlay.style.display = 'block';
             } else {
                 console.error("Completion popup elements not found!");
             }
        }


        // --- NEW: Setup Feedback Button Listener ---
        function setupFeedbackButtonListener() {
             const button = document.getElementById('proceedToFeedbackBtn');
             const popup = document.getElementById('assessmentCompletePopup');
             const overlay = document.getElementById('completionPopupOverlay');

             if(button && popup && overlay) {
                 button.addEventListener('click', () => {
                     popup.style.display = 'none';
                     overlay.style.display = 'none';
                     console.log("Redirecting to feedback page:", FEEDBACK_URL);
                     window.location.href = FEEDBACK_URL; // Redirect to feedback page
                 });
             } else {
                 console.warn("Could not find all elements for feedback button listener.");
             }
        }

    </script>
</body>
</html>
