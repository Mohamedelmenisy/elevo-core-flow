<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Feedback</title> <!-- Changed Title -->
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
     <!-- Supabase JS Library -->
     <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- Global Styles (Original) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html { scroll-behavior: smooth; }
        body { margin: 0; padding: 0; line-height: 1.7; background-color: #f9f9f9; color: #333; }
        /* --- User Bar Styles (Original) --- */
        .user-bar { background-color: #34495e; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; color: white; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-info svg { opacity: 0.8; }
        .user-details { display: flex; flex-direction: column; }
        .user-name { font-weight: 600; font-size: 14px; }
        .user-email { font-size: 12px; opacity: 0.8; }
        .logout-button { background-color: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 6px; font-size: 13px; }
        .logout-button:hover { background-color: #c0392b; transform: translateY(-1px); }
        .logout-button:active { transform: translateY(0); }
        /* --- Navigation Tabs (Original Sticky) --- */
        .nav-tab { background-color: #2c3e50; padding: 12px 10px; text-align: center; position: sticky; top: 0; z-index: 100; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; scrollbar-width: thin; scrollbar-color: #556a80 #2c3e50; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .nav-tab::-webkit-scrollbar { height: 6px; }
        .nav-tab::-webkit-scrollbar-track { background: #2c3e50; }
        .nav-tab::-webkit-scrollbar-thumb { background-color: #556a80; border-radius: 10px; border: 1px solid #2c3e50; }
        .nav-tab a { color: white; text-decoration: none; margin: 0 8px; padding: 8px 12px; border-radius: 6px; transition: background-color 0.3s, color 0.3s; font-size: 14px; display: inline-block; }
        .nav-tab a:hover, .nav-tab a.active { background-color: #34495e; color: #fff; }

        /* --- Sticky Progress Bar --- */
        #sticky-progress-container { position: sticky; top: 48px; left: 0; width: 100%; background-color: #e9ecef; padding: 8px 0; z-index: 99; box-shadow: 0 3px 6px rgba(0,0,0,0.1); border-bottom: 1px solid #dee2e6; }
        #sticky-progress-bar-wrapper { max-width: 800px; margin: 0 auto; background-color: #d8dde2; border-radius: 8px; overflow: hidden; height: 24px; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); }
        #sticky-progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #2ecc71, #27ae60); transition: width 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55); display: flex; align-items: center; justify-content: center; position: relative; text-align: center; }
        #sticky-progress-text { font-size: 13px; font-weight: 700; color: white; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); white-space: nowrap; padding: 0 10px; position: absolute; left: 50%; transform: translateX(-50%); }
        /* --- End Sticky Progress Bar --- */

        /* Main Content Styles (Original) */
        h1 { color: #fff; background-color: #e67e22; padding: 20px; border-radius: 8px; text-align: center; margin: 25px auto; max-width: 800px; font-size: 26px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .container { max-width: 800px; margin: 20px auto 30px; background: white; padding: 30px; box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 8px; position: relative; }
        .question-box { background-color: rgba(52, 152, 219, 0.08); padding: 25px; border-radius: 6px; margin: 25px 0; border: 1px solid rgba(52, 152, 219, 0.2); border-left: 5px solid #3498db; position: relative; }
        .question-box h3 { margin-top: 0; margin-bottom: 15px; color: #34495e; font-weight: 600; font-size: 1.2em; }
        .question-box h3 .required-star { color: #e74c3c; font-weight: bold; margin-left: 3px; }
        textarea, input[type="text"], input[type="number"], select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; margin-top: 8px; margin-bottom: 10px; background-color: white; min-height: 45px; line-height: 1.6; display: block; color: #333; font-size: 15px; transition: border-color 0.3s, box-shadow 0.3s; }
        textarea { min-height: 100px; resize: vertical; }
        textarea:focus, input:focus, select:focus { outline: none; border-color: #e67e22; box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.2); }
        textarea::placeholder, input::placeholder { color: #aaa; opacity: 1; }
        textarea:disabled, input:disabled, select:disabled { background-color: #f0f0f0 !important; cursor: not-allowed !important; color: #6c757d !important; border-color: #ddd !important; box-shadow: none !important;}
        .save-button, .delete-button { color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; transition: all 0.3s ease; font-size: 14px; font-weight: 500; }
        .save-button { background-color: #27ae60; }
        .delete-button { background-color: #e74c3c; margin-left: 8px; }
        .save-button:hover:not(:disabled) { background-color: #2ecc71; transform: translateY(-1px); }
        .delete-button:hover:not(:disabled) { background-color: #c0392b; transform: translateY(-1px); }
        .save-button:active, .delete-button:active { transform: translateY(0); }
        .save-button:disabled, .delete-button:disabled { background-color: #bdc3c7 !important; cursor: not-allowed !important; transform: none !important; box-shadow: none !important; opacity: 0.7 !important; }
        .button-group { display: flex; align-items: center; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .save-status { font-size: 14px; color: #27ae60; margin-top: 12px; display: none; font-weight: 600; }
        .error-message { color: #e74c3c; font-size: 13px; display: block; margin-top: 4px; margin-bottom: 10px; font-weight: 500; min-height: 1.2em; display: none; }
        .navigation-buttons { display: flex; justify-content: flex-end; /* Only Submit button */ margin-top: 40px; gap: 20px; border-top: 1px solid #eee; padding-top: 25px; }
        .navigation-buttons button { text-decoration: none; padding: 12px 25px; color: white; border-radius: 4px; font-weight: 600; text-align: center; transition: all 0.3s ease; font-size: 16px; border: none; cursor: pointer; background-color: #e67e22; }
        .navigation-buttons button:hover:not(:disabled) { background-color: #d35400; transform: translateY(-1px); }
        .navigation-buttons button:disabled { background-color: #bdc3c7 !important; cursor: not-allowed !important; opacity: 0.7 !important; }
        .floating-warning { background-color: #fff8e1; border-left: 4px solid #ffc107; padding: 15px 25px; color: #333; display: none; position: fixed; top: 100px; /* Adjusted */ left: 50%; transform: translateX(-50%); z-index: 1001; border-radius: 6px; box-shadow: 0 3px 10px rgba(0,0,0,0.2); animation: slideDownFadeInWarn 0.4s ease-out; font-weight: 500; max-width: 90%; width: auto; min-width: 300px; text-align: center; }
        @keyframes slideDownFadeInWarn { from { opacity: 0; top: 70px; } to { opacity: 1; top: 100px; } }
        @keyframes fadeOutUpWarn { from { opacity: 1; top: 100px; } to { opacity: 0; top: 70px; } }
        .required-field { border: 2px solid #e74c3c !important; background-color: #fff2f1 !important; box-shadow: none !important; }
        .required-star { color: #e74c3c; font-weight: bold; margin-left: 2px; }
        .question-progress-container { display: none !important; }

         /* Rating Styles */
         .rating-container { margin-top: 10px; margin-bottom: 15px; }
         .rating-label { display: block; margin-bottom: 8px; font-weight: 500; color: #495057; }
         .rating-options { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
         .rating-options input[type="radio"] { position: absolute; opacity: 0; width: 0; height: 0; }
         .rating-options label {
             cursor: pointer;
             padding: 8px 15px;
             border: 1px solid #ced4da;
             border-radius: 20px; /* Pill shape */
             background-color: #fff;
             color: #495057;
             transition: all 0.3s ease;
             font-size: 14px;
         }
         .rating-options input[type="radio"]:checked + label {
             background-color: #3498db; /* Blue when selected */
             color: white;
             border-color: #2980b9;
             font-weight: 600;
         }
          .rating-options input[type="radio"]:disabled + label {
             background-color: #e9ecef;
             color: #adb5bd;
             cursor: not-allowed;
             border-color: #dee2e6;
         }
         .rating-options label:hover:not(.disabled):not(:has(input:checked)) { /* Hover only if not disabled or checked */
             background-color: #eef5fc;
             border-color: #a5cff8;
         }
          /* Class to disable hover/click on labels when whole group is disabled */
         .rating-options.disabled label {
             cursor: not-allowed;
             background-color: #e9ecef;
             color: #adb5bd;
             border-color: #dee2e6;
         }

        /* --- Responsive Adjustments --- */
        @media (max-width: 768px) {
             #sticky-progress-container { top: 48px; padding: 6px 0; }
             #sticky-progress-bar-wrapper { height: 20px; }
             #sticky-progress-text { font-size: 11px; }
             .floating-warning { top: 90px; /* Adjusted */ }
             @keyframes slideDownFadeInWarn { from { opacity: 0; top: 70px; } to { opacity: 1; top: 90px; } }
             @keyframes fadeOutUpWarn { from { opacity: 1; top: 90px; } to { opacity: 0; top: 70px; } }
             /* Other original */
             h1 { font-size: 22px; padding: 15px; margin: 20px 15px; }
             .container { padding: 20px; margin: 15px auto 20px; }
             .user-bar { padding: 10px 15px; font-size: 13px; }
             .user-name { font-size: 13px; } .user-email { font-size: 11px; }
             .logout-button { padding: 7px 12px; font-size: 12px; }
             .nav-tab a { margin: 0 5px; padding: 7px 10px; font-size: 13px;}
             .question-box { padding: 15px; margin: 20px 0; }
             textarea { min-height: 80px; }
             .save-button, .delete-button { padding: 7px 13px; font-size: 13px; }
             .navigation-buttons { justify-content: center; } /* Center single button */
             .navigation-buttons button { font-size: 15px; padding: 12px 20px; flex: 0 1 auto; /* Allow button to size naturally */}
             .rating-options label { padding: 6px 12px; font-size: 13px;}
        }
         @media (max-width: 480px) {
             #sticky-progress-container { top: 48px; }
             #sticky-progress-bar-wrapper { height: 18px; }
             #sticky-progress-text { font-size: 10px; }
             .floating-warning { top: 85px; /* Adjusted */ }
             @keyframes slideDownFadeInWarn { from { opacity: 0; top: 65px; } to { opacity: 1; top: 85px; } }
             @keyframes fadeOutUpWarn { from { opacity: 1; top: 85px; } to { opacity: 0; top: 65px; } }
             /* Other original */
             h1 { font-size: 20px; } h2 { font-size: 1.3em; } h3 { font-size: 1.1em; }
             .container { padding: 15px; margin: 10px auto 15px; }
             .button-group { gap: 8px; }
             .rating-options { gap: 6px; }
             .rating-options label { padding: 5px 10px; font-size: 12px;}
         }
    </style>
</head>
<body>
    <!-- User Info Bar (Original) -->
    <div class="user-bar">
        <div class="user-info"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.8;"> <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path> <circle cx="12" cy="7" r="4"></circle> </svg> <div class="user-details"> <span class="user-name" id="userName">Loading...</span> <span class="user-email" id="userEmail"></span> </div> </div> <button class="logout-button" onclick="logout()"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path> <polyline points="16 17 21 12 16 7"></polyline> <line x1="21" y1="12" x2="9" y2="12"></line> </svg> Logout </button>
    </div>

    <!-- Navigation Tabs (Original Sticky) -->
    <nav class="nav-tab">
        <a href="dashboard.html">Dashboard</a>
        <a href="index.html">Home</a>
        <a href="introduction.html">Introduction</a>
        <a href="coaching-skills.html">Coaching Skills</a>
        <a href="coaching-individuals.html">Coaching Individuals</a>
        <a href="coaching-team.html">Team Coaching</a>
        <a href="coaching-yourself.html">Self Coaching</a>
        <a href="action-plan.html">Action Plan</a>
        <a href="ass.html">Assessment</a>
        <!-- Add link to feedback.html if needed -->
        <a href="feedback.html" class="active">Feedback</a>
    </nav>

    <!-- Sticky Progress Bar -->
    <div id="sticky-progress-container">
        <div id="sticky-progress-bar-wrapper">
            <div id="sticky-progress-bar">
                <span id="sticky-progress-text">Progress: 0%</span>
            </div>
        </div>
    </div>

    <h1>Course Feedback</h1>

    <!-- Floating Warning Message -->
    <div class="floating-warning" id="generalWarningMessage"></div>

    <div class="container">

        <p style="text-align: center; font-size: 1.1em; margin-bottom: 30px;">We value your feedback! Please take a moment to share your thoughts on the course content and your learning experience.</p>

        <!-- Question 1: Overall Rating -->
        <div class="question-box" id="question-container-feedback_q1">
            <h3>Overall Course Rating<span class="required-star">*</span></h3>
            <p>How would you rate your overall experience with this Coaching & Leadership course?</p>
            <div class="rating-container">
                <span class="rating-label">Rate from 1 (Poor) to 5 (Excellent):</span>
                <div class="rating-options">
                    <input type="radio" id="rating1" name="overall_rating" value="1" class="required-answer editable-answer" data-question="feedback_q1">
                    <label for="rating1">1</label>
                    <input type="radio" id="rating2" name="overall_rating" value="2" class="required-answer editable-answer" data-question="feedback_q1">
                    <label for="rating2">2</label>
                    <input type="radio" id="rating3" name="overall_rating" value="3" class="required-answer editable-answer" data-question="feedback_q1">
                    <label for="rating3">3</label>
                    <input type="radio" id="rating4" name="overall_rating" value="4" class="required-answer editable-answer" data-question="feedback_q1">
                    <label for="rating4">4</label>
                    <input type="radio" id="rating5" name="overall_rating" value="5" class="required-answer editable-answer" data-question="feedback_q1">
                    <label for="rating5">5</label>
                </div>
            </div>
            <div class="button-group">
                <button class="save-button" onclick="saveAnswer('feedback_q1')">Save Rating</button>
                <button class="delete-button" onclick="deleteAnswer('feedback_q1')">Clear Rating</button>
                 <span class="error-message" id="error-feedback_q1"></span>
            </div>
            <span class="save-status" id="save-status-feedback_q1">Saved ✅</span>
        </div>

        <!-- Question 2: Most Valuable Part -->
        <div class="question-box" id="question-container-feedback_q2">
            <h3>Most Valuable Aspect<span class="required-star">*</span></h3>
            <p>What part of the course did you find most valuable or insightful?</p>
            <textarea placeholder="e.g., Learning about the GROW model, the section on team dynamics, the practical exercises..." class="editable-answer required-answer" data-question="feedback_q2"></textarea>
            <div class="button-group">
                <button class="save-button" onclick="saveAnswer('feedback_q2')">Save</button>
                <button class="delete-button" onclick="deleteAnswer('feedback_q2')">Delete</button>
                 <span class="error-message" id="error-feedback_q2"></span>
            </div>
            <span class="save-status" id="save-status-feedback_q2">Saved ✅</span>
        </div>

         <!-- Question 3: Least Valuable Part -->
        <div class="question-box" id="question-container-feedback_q3">
            <h3>Least Valuable Aspect (Optional)</h3>
            <p>Was there any part of the course you found less helpful or clear? (Optional)</p>
            <textarea placeholder="Your honest feedback helps us improve..." class="editable-answer" data-question="feedback_q3"></textarea> <!-- Not required -->
            <div class="button-group">
                <button class="save-button" onclick="saveAnswer('feedback_q3')">Save</button>
                <button class="delete-button" onclick="deleteAnswer('feedback_q3')">Delete</button>
                 <span class="error-message" id="error-feedback_q3"></span> <!-- Still include for potential future validation -->
            </div>
             <span class="save-status" id="save-status-feedback_q3">Saved ✅</span>
        </div>

         <!-- Question 4: Application -->
        <div class="question-box" id="question-container-feedback_q4">
            <h3>Practical Application<span class="required-star">*</span></h3>
            <p>How likely are you to apply the coaching techniques learned in this course in your work? (1 = Very Unlikely, 5 = Very Likely)</p>
             <div class="rating-container">
                <div class="rating-options">
                    <input type="radio" id="apply1" name="apply_likelihood" value="1" class="required-answer editable-answer" data-question="feedback_q4">
                    <label for="apply1">1</label>
                    <input type="radio" id="apply2" name="apply_likelihood" value="2" class="required-answer editable-answer" data-question="feedback_q4">
                    <label for="apply2">2</label>
                    <input type="radio" id="apply3" name="apply_likelihood" value="3" class="required-answer editable-answer" data-question="feedback_q4">
                    <label for="apply3">3</label>
                    <input type="radio" id="apply4" name="apply_likelihood" value="4" class="required-answer editable-answer" data-question="feedback_q4">
                    <label for="apply4">4</label>
                    <input type="radio" id="apply5" name="apply_likelihood" value="5" class="required-answer editable-answer" data-question="feedback_q4">
                    <label for="apply5">5</label>
                </div>
            </div>
            <div class="button-group">
                <button class="save-button" onclick="saveAnswer('feedback_q4')">Save Rating</button>
                <button class="delete-button" onclick="deleteAnswer('feedback_q4')">Clear Rating</button>
                 <span class="error-message" id="error-feedback_q4"></span>
            </div>
            <span class="save-status" id="save-status-feedback_q4">Saved ✅</span>
        </div>

         <!-- Question 5: Suggestions -->
        <div class="question-box" id="question-container-feedback_q5">
            <h3>Suggestions for Improvement (Optional)</h3>
            <p>Do you have any suggestions for how this course could be improved? (Topics, examples, format, etc.)</p>
            <textarea placeholder="We appreciate your ideas!" class="editable-answer" data-question="feedback_q5"></textarea> <!-- Not required -->
            <div class="button-group">
                <button class="save-button" onclick="saveAnswer('feedback_q5')">Save</button>
                <button class="delete-button" onclick="deleteAnswer('feedback_q5')">Delete</button>
                 <span class="error-message" id="error-feedback_q5"></span>
            </div>
             <span class="save-status" id="save-status-feedback_q5">Saved ✅</span>
        </div>

        <p style="text-align: center; font-weight: 600; margin-top: 30px;">Thank you for completing the course and providing your valuable feedback!</p>

        <!-- Navigation Buttons -->
        <div class="navigation-buttons">
             <!-- Only Submit Button Needed -->
            <button type="button" class="button" id="submitFeedbackButton">Submit Feedback</button>
        </div>
    </div><!-- /.container -->

    <script>
        // --- Supabase Configuration ---
        const SUPABASE_URL = 'https://lgcutmuspcaralydycmg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnY3V0bXVzcGNhcmFseWR5Y21nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0NDY3MDEsImV4cCI6MjA2MTAyMjcwMX0.3u5Y7pkH2NNnnoGLMWVfAa5b8fq88o1itRYnG1K38tE';
        let supabase = null;

        // --- Configuration ---
        const localStorageKey = 'allUserAnswers_feedback'; // Unique key for this page
        const SECTION_ID = 'feedback'; // Unique ID for progress tracking
        const PAGE_NAME = 'feedback.html'; // Page name for Supabase

        // --- Unified Keys ---
        const LOGGED_IN_KEY = 'isUserLoggedIn';
        const CURRENT_USER_KEY = 'currentUser';

        // --- Required Question IDs for Progress Bar ---
        const requiredQuestionIds = [
            'feedback_q1', // Overall Rating
            'feedback_q2', // Most Valuable
            'feedback_q4'  // Application Likelihood
            // Q3 and Q5 are optional
        ];


        // Initialize Supabase Client
        try {
            if (window.supabase && window.supabase.createClient) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log(`Supabase client initialized successfully on ${PAGE_NAME}.`);
            } else { throw new Error("Supabase library not found."); }
        } catch (error) { console.error("CRITICAL ERROR initializing Supabase:", error); }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
             console.log(`%c${PAGE_NAME}: DOMContentLoaded event fired.`, "color: green;");
             if (!supabase) {
                 console.error(`Supabase client failed to initialize on ${PAGE_NAME}.`);
                 showGeneralWarningMessage('Database connection error. Progress might not save correctly.', true);
             }
             const currentUser = getCurrentUser();
             if (!currentUser || !currentUser.id || !currentUser.email) {
                 console.error(`%c${PAGE_NAME}: User not logged in or essential data missing. Redirecting...`, "color: red;");
                  if (!window.location.search.includes('redir_attempt')) { window.location.href = `login.html?redirect=${encodeURIComponent(window.location.pathname + window.location.search)}&redir_attempt=1`; }
                  else { console.error("REDIRECTION LOOP DETECTED."); document.body.innerHTML = '<p style="color: red; padding: 20px;">Login check failed repeatedly.</p>'; }
                 return;
             }
             console.log(`%c${PAGE_NAME}: User validated (${currentUser.email}, ID: ${currentUser.id}). Initializing.`, "color: green;");
             displayUserInfo();
             loadUserAnswers(currentUser);
             updateStickyProgressBar(); // Initial progress calculation
             setupEventListeners(currentUser);
             highlightActiveNav();
             console.log(`%c${PAGE_NAME}: Initialization complete.`, "color: blue;");
        });

        // --- User Info & Auth ---
        function getCurrentUser() { try { const d = localStorage.getItem(CURRENT_USER_KEY); if (!d) return null; const p = JSON.parse(d); if (p && typeof p === 'object' && p.email && p.name && p.id) { if (typeof p.progress !== 'object' || p.progress === null) p.progress = {}; return p; } else { localStorage.removeItem(CURRENT_USER_KEY); localStorage.removeItem(LOGGED_IN_KEY); return null; } } catch (e) { console.error("GUC Error:", e); localStorage.removeItem(CURRENT_USER_KEY); localStorage.removeItem(LOGGED_IN_KEY); return null; } }
        function saveCurrentUser(userObject) { try { if (!userObject || typeof userObject !== 'object') throw new Error("Invalid user object"); localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(userObject)); } catch (error) { console.error("SCU Error:", error); } }
        function displayUserInfo() { const u=getCurrentUser(); if(u){document.getElementById('userName').textContent=`Welcome, ${u.name || u.email.split('@')[0]}`; document.getElementById('userEmail').textContent=u.email;}else{console.warn("DIU: No user");}}
        function logout() { localStorage.removeItem(LOGGED_IN_KEY); localStorage.removeItem(CURRENT_USER_KEY); localStorage.removeItem(localStorageKey); window.location.href = 'login.html';}
        function highlightActiveNav() { const cP=window.location.pathname.split('/').pop()||PAGE_NAME; document.querySelectorAll('.nav-tab a').forEach(l=>{const lP=(l.getAttribute('href')||'').split('/').pop(); l.classList.toggle('active',lP===cP);});}

        // --- Answer Handling ---
        function loadUserAnswers(currentUser) {
             if (!currentUser || !currentUser.email) return;
             let allAnswers = {};
             try { const d = localStorage.getItem(localStorageKey); if (d) allAnswers = JSON.parse(d) || {}; }
             catch (e) { console.error("Load Answers Error:", e); }
             const userAnswers = allAnswers[currentUser.email] || {};

             document.querySelectorAll('.editable-answer').forEach(field => {
                 const questionId = field.dataset.question;
                 if (questionId) {
                      loadFieldState(field, questionId, userAnswers); // Call updated load state
                 }
             });
              // updateStickyProgressBar() called after DOMContentLoaded
        }

        // --- Modified loadFieldState for 'Save Once' behavior (Handles Radio Buttons) ---
        function loadFieldState(field, questionId, userAnswers) {
            if (!field) return;
            const isRadioGroup = field.type === 'radio';
            const container = field.closest('.question-box');
            if (!container) return; // Need container to find elements

            const errorId = `error-${questionId}`;
            const statusId = `save-status-${questionId}`;
            const statusElement = document.getElementById(statusId);
            const buttonGroup = container.querySelector('.button-group'); // Buttons are inside question-box
            const saveButton = buttonGroup?.querySelector('.save-button');
            const deleteButton = buttonGroup?.querySelector('.delete-button');
             // Find all related radio buttons for disabling/enabling the group
             const radioOptionsContainer = container.querySelector('.rating-options');

            hideError(errorId);
            if (statusElement) statusElement.style.display = 'none';

            const savedValue = userAnswers[questionId];

            if (savedValue !== undefined && savedValue !== null && String(savedValue).trim() !== '') {
                // --- Saved Answer Found ---
                field.classList.remove('required-field'); // Remove error class if present

                if (isRadioGroup) {
                     // Find the specific radio button with the saved value and check it
                     const checkedRadio = container.querySelector(`input[type="radio"][data-question="${questionId}"][value="${savedValue}"]`);
                     if (checkedRadio) checkedRadio.checked = true;

                     // Disable all radio buttons in the group and style labels
                     container.querySelectorAll(`input[type="radio"][data-question="${questionId}"]`).forEach(radio => radio.disabled = true);
                     if(radioOptionsContainer) radioOptionsContainer.classList.add('disabled'); // Add class to style labels
                 } else {
                     // For textarea/other inputs
                     field.value = savedValue;
                     field.disabled = true;
                 }

                // Hide button group and show status
                if (buttonGroup) buttonGroup.style.display = 'none';
                if (statusElement) { statusElement.textContent = 'Saved ✅'; statusElement.style.display = 'inline-block'; }

            } else {
                // --- No Saved Answer ---
                 field.classList.remove('required-field');
                 if (isRadioGroup) {
                     // Ensure all radio buttons in the group are enabled and unchecked
                     container.querySelectorAll(`input[type="radio"][data-question="${questionId}"]`).forEach(radio => {
                         radio.disabled = false;
                         radio.checked = false;
                     });
                      if(radioOptionsContainer) radioOptionsContainer.classList.remove('disabled');
                 } else {
                     field.value = ''; // Clear textarea/input
                     field.disabled = false;
                 }

                 // Show button group, reset buttons, hide status
                 if (buttonGroup) {
                     buttonGroup.style.display = 'flex';
                     if (saveButton) { saveButton.disabled = false; saveButton.textContent = field.type === 'radio' ? 'Save Rating' : 'Save'; }
                     if (deleteButton) { deleteButton.disabled = false; deleteButton.style.display = 'inline-block'; deleteButton.textContent = field.type === 'radio' ? 'Clear Rating' : 'Delete'; }
                 }
                 if (statusElement) statusElement.style.display = 'none';
            }
        }


        function saveAnswerToStorage(userEmail, questionId, answer) { /* ... (unchanged) ... */ if(!userEmail) return false; let a={}; try{const d=localStorage.getItem(localStorageKey); if(d) a=JSON.parse(d)||{};}catch(e){a={};} if(!a[userEmail]) a[userEmail]={}; a[userEmail][questionId]=answer; try{localStorage.setItem(localStorageKey,JSON.stringify(a)); return true;} catch(e){console.error("Save Storage Err:",e); return false;} }
        function deleteAnswerFromStorage(userEmail, questionId) { /* ... (unchanged) ... */ if(!userEmail) return false; let a={}; try{const d=localStorage.getItem(localStorageKey); if(d) a=JSON.parse(d)||{}; else return false;} catch(e){return false;} let u=false; if(a[userEmail]?.[questionId]!==undefined){delete a[userEmail][questionId]; u=true; if(Object.keys(a[userEmail]).length===0) delete a[userEmail];} if(u){try{localStorage.setItem(localStorageKey,JSON.stringify(a)); return true;}catch(e){return false;}} return false; }

        // --- Sticky Progress Bar Function ---
        function updateStickyProgressBar() {
            const currentUser = getCurrentUser(); if (!currentUser?.email) return;
            let allAnswers = {}; try { const d = localStorage.getItem(localStorageKey); if (d) allAnswers = JSON.parse(d) || {}; } catch (e) { console.error("Progress LS Error:", e); return; }
            const userAnswers = allAnswers[currentUser.email] || {};
            const totalRequired = requiredQuestionIds.length; if (totalRequired === 0) return;
            let savedRequiredCount = 0;
            requiredQuestionIds.forEach(qId => { if (userAnswers[qId] !== undefined && userAnswers[qId] !== null && String(userAnswers[qId]).trim() !== '') { savedRequiredCount++; } });
            const percentage = Math.round((savedRequiredCount / totalRequired) * 100);
            const barElement = document.getElementById('sticky-progress-bar'); const textElement = document.getElementById('sticky-progress-text');
            if (barElement && textElement) { barElement.style.width = `${percentage}%`; textElement.textContent = `Progress: ${percentage}%`; }
            if (!currentUser.progress) currentUser.progress = {}; currentUser.progress[SECTION_ID] = percentage; saveCurrentUser(currentUser);
             console.log(`Sticky Progress Updated: ${percentage}% (${savedRequiredCount}/${totalRequired})`);
        }

        // --- Event Listeners Setup ---
        function setupEventListeners(currentUser) {
             if (!currentUser?.email) return;
             document.querySelectorAll('.editable-answer').forEach(field => {
                 const eventType = (field.tagName === 'TEXTAREA' || field.type === 'text') ? 'input' : 'change'; // Use change for radio/select
                 field.addEventListener(eventType, function() {
                     const questionId = this.dataset.question;
                     if (questionId) {
                         hideError(`error-${questionId}`);
                         // No need to remove required-field class on input for radio
                         if (!this.disabled) {
                             const buttonGroup = this.closest('.question-box')?.querySelector('.button-group');
                             const saveButton = buttonGroup?.querySelector('.save-button');
                             if(saveButton) saveButton.disabled = false;
                         }
                     }
                 });
             });
             const submitButton = document.getElementById('submitFeedbackButton');
             if (submitButton) { submitButton.addEventListener('click', handleSubmitFeedback); }
              else { console.warn("Submit Feedback button not found."); }
        }

        // --- UI Feedback & Validation ---
        function validateAllAnswers(showErrors = false) {
            let allValid = true; let firstInvalidField = null;
            console.log(`Feedback Validation (Show Errors: ${showErrors})`);
            hideWarningMessage();

            requiredQuestionIds.forEach(qId => {
                const container = document.getElementById(`question-container-${qId}`);
                const errorId = `error-${qId}`;
                hideError(errorId); // Clear previous error

                const field = container?.querySelector(`.required-answer[data-question="${qId}"]`); // General selector

                if (!field) { // Should not happen if IDs match
                    console.warn(`Required field container or input ${qId} not found!`);
                    allValid = false;
                    return; // Skip to next ID
                }

                 // Check if the group/field is already disabled (saved)
                 const isSaved = field.disabled;
                 if (isSaved) return; // Skip validation if already saved

                 let isAnswered = false;
                 if (field.type === 'radio') {
                     const checkedRadio = container.querySelector(`input[type="radio"][data-question="${qId}"]:checked`);
                     if (checkedRadio) isAnswered = true;
                 } else { // Textarea or other input
                     if (field.value.trim() !== '') isAnswered = true;
                 }

                 if (!isAnswered) {
                     allValid = false;
                     if (showErrors) {
                         showError(errorId, field.type === 'radio' ? null : field, 'Please provide your feedback.'); // Use generic message or field-specific
                     }
                     if (!firstInvalidField) {
                          // Focus the first radio button or the textarea/input
                          firstInvalidField = field.type === 'radio' ? container.querySelector(`input[type="radio"][data-question="${qId}"]`) : field;
                     }
                 } else {
                     // Clear required-field class from textareas if valid
                     if(field.type !== 'radio') field.classList.remove('required-field');
                 }

            });


            if (!allValid && showErrors && firstInvalidField) {
                 firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                 // Focusing radio buttons might not be ideal, focus container instead?
                 // setTimeout(() => { try { firstInvalidField.focus({ preventScroll: true }); } catch(e){} }, 350);
                 showGeneralWarningMessage();
            } else if (!allValid && showErrors) { showGeneralWarningMessage(); }

            console.log("Feedback Validation result:", allValid);
            return allValid;
        }


        function showGeneralWarningMessage(message = "Please complete all required feedback questions marked with *.", sticky = false) { const w=document.getElementById('generalWarningMessage'); if(!w) return; w.innerHTML = `<strong>Action Required:</strong> ${message}`; w.style.animation='none'; void w.offsetWidth; w.style.display='block'; w.style.animation='slideDownFadeInWarn 0.4s ease-out'; clearTimeout(w.timer); if (!sticky) { w.timer=setTimeout(()=>{ w.style.animation='fadeOutUpWarn 0.5s ease-out forwards'; setTimeout(()=>{ if(w.style.animationName === 'fadeOutUpWarn'){w.style.display='none';w.style.animation='';} }, 500); }, 4000); } }
        function hideWarningMessage() { const w=document.getElementById('generalWarningMessage'); if(w && w.style.display !== 'none'){ w.style.animation='fadeOutUpWarn 0.5s ease-out forwards'; setTimeout(()=>{if(w.style.animationName==='fadeOutUpWarn'){w.style.display='none'; w.style.animation='';}},500);}}
        function showError(errorId, fieldToMark, message = 'This field is required.') { const e=document.getElementById(errorId); if(e){e.textContent=message; e.style.display='block'; e.style.width='100%'; e.style.textAlign = fieldToMark ? 'left' : 'center';} if(fieldToMark) fieldToMark.classList.add('required-field');}
        function hideError(errorId) { const e=document.getElementById(errorId); if(e) e.style.display='none';}
        function hideMessages(statusId, errorId, field) { hideError(errorId); const s = statusId ? document.getElementById(statusId) : null; if(s)s.style.display='none'; if (field) field.classList.remove('required-field'); }

        // --- Actions (Save, Delete - 'Save Once' Logic) ---
        window.saveAnswer = async function(questionId) {
            if (!supabase) { alert('Database connection error.'); return; }
            const currentUser = getCurrentUser(); if (!currentUser?.email || !currentUser.id) { alert('Session expired.'); logout(); return; }

            const container = document.getElementById(`question-container-${questionId}`);
            if (!container) { console.error("Save Error: Question container not found for", questionId); return; }

            const field = container.querySelector(`.editable-answer[data-question="${questionId}"]`); // General selector
            const errorId = `error-${questionId}`; const statusId = `save-status-${questionId}`;
            const statusElement = document.getElementById(statusId);
            const buttonGroup = container.querySelector('.button-group');
            const saveButton = buttonGroup?.querySelector('.save-button'); const deleteButton = buttonGroup?.querySelector('.delete-button');
            const radioOptionsContainer = container.querySelector('.rating-options'); // For radio groups

            if (!field || !buttonGroup || !saveButton || !deleteButton) { console.error(`Save Error: Required elements missing for ${questionId}.`); return; }
            // Check if *any* field in the group is disabled (applies to radio group)
            if (field.disabled) { console.warn(`Attempted save on disabled field/group: ${questionId}.`); return; }

            let answer = null; let trimmedAnswer = null; let isValid = false;
            const isRequired = requiredQuestionIds.includes(questionId); // Check if this ID is in the required list

            hideMessages(statusId, errorId, field); // Clear errors/status

            if (field.type === 'radio') {
                 const checkedRadio = container.querySelector(`input[type="radio"][data-question="${questionId}"]:checked`);
                 if (checkedRadio) {
                     answer = checkedRadio.value;
                     trimmedAnswer = answer; // Value is likely already trimmed
                     isValid = true;
                 } else if (isRequired) {
                     showError(errorId, null, 'Please select a rating.'); isValid = false;
                 } else {
                     isValid = true; // Allow saving empty optional radio (though unlikely scenario)
                 }
            } else { // Textarea or other inputs
                 answer = field.value; trimmedAnswer = answer.trim();
                 if (isRequired && trimmedAnswer === '') { showError(errorId, field); isValid = false; }
                 else { isValid = true; } // Allow saving empty optional text areas
            }

            if (!isValid) { updateStickyProgressBar(); return; } // Stop if not valid

            saveButton.disabled = true; saveButton.textContent = 'Saving...'; deleteButton.disabled = true;

            try {
                // --- Get Question Text ---
                 let questionText = `Feedback: ${questionId}`; // Default
                 const h3 = container.querySelector('h3');
                 if(h3) questionText = h3.textContent.replace('*','').trim();

                const submissionTime = new Date().toISOString();
                // --- Prepare Payload ---
                 const userProgressPayload = {
                    user_id: currentUser.id, email: currentUser.email, question_id: questionId,
                    question_text: questionText, answer: answer, // Save raw answer (number for rating, text for textarea)
                    page: PAGE_NAME, status: 'completed', submitted_at: submissionTime, updated_at: submissionTime,
                    section_type: 'feedback', // Specific type
                    section_id: SECTION_ID, section_title: document.title || 'Course Feedback',
                    progress_percentage: 100, score: null, is_passed: null // Feedback usually not scored/passed
                };


                // --- Save to Supabase ---
                console.log("Upserting feedback to user_progress:", userProgressPayload);
                const { data, error } = await supabase.from('user_progress').upsert([userProgressPayload], { onConflict: ['user_id', 'question_id'] }).select();
                if (error) throw new Error(`Supabase error: ${error.message}`);
                console.log("Supabase upsert successful:", data);

                // --- Update UI on SUCCESS ---
                if(field.type === 'radio') {
                     // Disable all radio buttons in the group
                     container.querySelectorAll(`input[type="radio"][data-question="${questionId}"]`).forEach(radio => radio.disabled = true);
                      if(radioOptionsContainer) radioOptionsContainer.classList.add('disabled');
                 } else {
                     field.disabled = true; // Disable textarea/input
                 }
                 field.classList.remove('required-field');
                 buttonGroup.style.display = 'none'; // Hide buttons
                 if (statusElement) { statusElement.textContent = 'Saved ✅'; statusElement.style.display = 'inline-block'; }

                saveAnswerToStorage(currentUser.email, questionId, answer); // Save to local storage
                updateStickyProgressBar(); // Update overall progress

            } catch (error) {
                console.error(`Failed to save answer for ${questionId}:`, error);
                showError(errorId, field.type === 'radio' ? null : field, `Save failed. Try again.`);
                // Re-enable buttons & fields on failure
                if(field.type === 'radio') {
                     container.querySelectorAll(`input[type="radio"][data-question="${questionId}"]`).forEach(radio => radio.disabled = false);
                      if(radioOptionsContainer) radioOptionsContainer.classList.remove('disabled');
                 } else {
                     field.disabled = false;
                 }
                 buttonGroup.style.display = 'flex';
                 if(saveButton) { saveButton.disabled = false; saveButton.textContent = field.type === 'radio' ? 'Save Rating' : 'Save'; }
                 if(deleteButton) { deleteButton.disabled = false; deleteButton.style.display = 'inline-block'; deleteButton.textContent = field.type === 'radio' ? 'Clear Rating' : 'Delete'; }
                 if (statusElement) statusElement.style.display = 'none';
                 updateStickyProgressBar();
            }
        };

        window.deleteAnswer = function(questionId) {
            const container = document.getElementById(`question-container-${questionId}`);
            if (!container) return;
            const field = container.querySelector(`.editable-answer[data-question="${questionId}"]`);
             if (!field || field.disabled) { console.warn(`Cannot delete saved/disabled answer: ${questionId}`); const errorId=`error-${questionId}`; showError(errorId, null, "Saved answers cannot be deleted."); setTimeout(()=>hideError(errorId),3000); return; }

            const currentUser = getCurrentUser(); if (!currentUser?.email) return;
            const errorId = `error-${questionId}`; const statusId = `save-status-${questionId}`; const statusElement = document.getElementById(statusId);
            const buttonGroup = container.querySelector('.button-group'); const saveButton = buttonGroup?.querySelector('.save-button'); const deleteButton = buttonGroup?.querySelector('.delete-button');
            const radioOptionsContainer = container.querySelector('.rating-options');

            hideMessages(statusId, errorId, field); // Clear error, hide status
            if (field.type === 'radio') {
                 // Uncheck all radio buttons in the group
                 container.querySelectorAll(`input[type="radio"][data-question="${questionId}"]`).forEach(radio => { radio.checked = false; radio.disabled=false; });
                  if(radioOptionsContainer) radioOptionsContainer.classList.remove('disabled');
            } else {
                 field.value = ''; // Clear textarea/input
                 field.disabled=false;
                 field.classList.remove('required-field');
            }

            deleteAnswerFromStorage(currentUser.email, questionId); console.log("Cleared unsaved answer locally for", questionId);
            updateStickyProgressBar(); // Update progress
            // Ensure buttons are visible/enabled
            if(buttonGroup){ buttonGroup.style.display = 'flex'; if(saveButton) saveButton.disabled = false; if(deleteButton) deleteButton.disabled = false; }
        };

        // --- Submit Feedback Function ---
        async function handleSubmitFeedback() {
            const submitButton = document.getElementById('submitFeedbackButton');
            if (!validateAllAnswers(true)) {
                showGeneralWarningMessage("Please complete all required feedback questions before submitting.");
                return;
            }

            // Optional: Add a confirmation dialog
            if (!confirm("Are you sure you want to submit your feedback? This action cannot be undone.")) {
                return;
            }

            setButtonLoading(submitButton, true, 'Submitting...');

            // In this case, all data is already saved individually to user_progress
            // We just need to potentially mark this feedback section as complete
            // or navigate the user.

            const currentUser = getCurrentUser();
            if (!currentUser || !currentUser.id) {
                 showError('User session error. Cannot finalize submission.', submitButton);
                 setButtonLoading(submitButton, false, 'Submit Feedback');
                 return;
            }

            // --- Option 1: Log a 'Feedback Submitted' event ---
            try {
                const { error } = await supabase.from('user_progress').insert([{
                    user_id: currentUser.id, email: currentUser.email,
                    question_id: `${SECTION_ID}_submitted_marker`, question_text: `Feedback Section Submitted`,
                    answer: 'Submitted', page: PAGE_NAME, status: 'completed',
                    submitted_at: new Date().toISOString(), updated_at: new Date().toISOString(),
                    section_type: 'feedback_completion', section_id: SECTION_ID,
                    section_title: document.title || 'Course Feedback', progress_percentage: 100,
                    score: null, is_passed: true
                }]);
                if (error) {
                    console.error("Error logging feedback submission event:", error);
                    // Don't necessarily block the user if this fails
                } else {
                    console.log("Feedback submission event logged successfully.");
                }

                // --- Option 2: Update a field in the 'users' table (if you have one) ---
                // const { error: userUpdateError } = await supabase
                //    .from('users')
                //    .update({ feedback_submitted: true }) // Assuming a boolean field
                //    .eq('id', currentUser.id);
                // if (userUpdateError) console.error("Error updating user feedback status:", userUpdateError);

                // --- UI Update & Navigation ---
                alert("Thank you for your feedback!"); // Simple confirmation
                // Disable the submit button permanently after successful submission
                setButtonLoading(submitButton, true, 'Submitted ✅');
                 // Optional: Redirect to dashboard or next page
                 window.location.href = 'dashboard.html'; // Redirect to dashboard

            } catch (err) {
                 console.error("Error during feedback submission finalization:", err);
                 showError('An error occurred while finalizing your feedback. Please try again.', submitButton);
                 setButtonLoading(submitButton, false, 'Submit Feedback');
            }
        }

        // Helper for submit button state
        function setButtonLoading(button, isLoading, text = 'Submit Feedback') {
            if (!button) return;
            button.disabled = isLoading;
            button.textContent = isLoading ? 'Submitting...' : text;
        }

    </script>

</body>
</html>
