<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Feedback</title> <!-- Changed Title -->
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
     <!-- Supabase JS Library -->
     <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- Global Styles (Original) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html { scroll-behavior: smooth; }
        body { margin: 0; padding: 0; line-height: 1.7; background-color: #f9f9f9; color: #333; }
        /* --- User Bar Styles (Original) --- */
        .user-bar { background-color: #34495e; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; color: white; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-info svg { opacity: 0.8; }
        .user-details { display: flex; flex-direction: column; }
        .user-name { font-weight: 600; font-size: 14px; }
        .user-email { font-size: 12px; opacity: 0.8; }
        .logout-button { background-color: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 6px; font-size: 13px; }
        .logout-button:hover { background-color: #c0392b; transform: translateY(-1px); }
        .logout-button:active { transform: translateY(0); }
        /* --- Navigation Tabs (Original Sticky) --- */
        .nav-tab { background-color: #2c3e50; padding: 12px 10px; text-align: center; position: sticky; top: 0; z-index: 100; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; scrollbar-width: thin; scrollbar-color: #556a80 #2c3e50; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .nav-tab::-webkit-scrollbar { height: 6px; }
        .nav-tab::-webkit-scrollbar-track { background: #2c3e50; }
        .nav-tab::-webkit-scrollbar-thumb { background-color: #556a80; border-radius: 10px; border: 1px solid #2c3e50; }
        .nav-tab a { color: white; text-decoration: none; margin: 0 8px; padding: 8px 12px; border-radius: 6px; transition: background-color 0.3s, color 0.3s; font-size: 14px; display: inline-block; }
        .nav-tab a:hover, .nav-tab a.active { background-color: #34495e; color: #fff; }

        /* --- Sticky Progress Bar --- */
        #sticky-progress-container { position: sticky; top: 48px; /* Adjusted for potential nav bar height */ left: 0; width: 100%; background-color: #e9ecef; padding: 8px 0; z-index: 99; box-shadow: 0 3px 6px rgba(0,0,0,0.1); border-bottom: 1px solid #dee2e6; }
        #sticky-progress-bar-wrapper { max-width: 800px; margin: 0 auto; background-color: #d8dde2; border-radius: 8px; overflow: hidden; height: 24px; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); }
        #sticky-progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #2ecc71, #27ae60); transition: width 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55); display: flex; align-items: center; justify-content: center; position: relative; text-align: center; }
        #sticky-progress-text { font-size: 13px; font-weight: 700; color: white; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); white-space: nowrap; padding: 0 10px; position: absolute; left: 50%; transform: translateX(-50%); }
        /* --- End Sticky Progress Bar --- */

        /* Main Content Styles (Original) */
        h1 { color: #fff; background-color: #e67e22; padding: 20px; border-radius: 8px; text-align: center; margin: 25px auto; max-width: 800px; font-size: 26px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .container { max-width: 800px; margin: 20px auto 30px; background: white; padding: 30px; box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 8px; position: relative; }
        .question-box { background-color: rgba(52, 152, 219, 0.08); padding: 25px; border-radius: 6px; margin: 25px 0; border: 1px solid rgba(52, 152, 219, 0.2); border-left: 5px solid #3498db; position: relative; }
        .question-box h3 { margin-top: 0; margin-bottom: 15px; color: #34495e; font-weight: 600; font-size: 1.2em; }
        .question-box h3 .required-star { color: #e74c3c; font-weight: bold; margin-left: 3px; }
        textarea, input[type="text"], input[type="number"], select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; margin-top: 8px; margin-bottom: 10px; background-color: white; min-height: 45px; line-height: 1.6; display: block; color: #333; font-size: 15px; transition: border-color 0.3s, box-shadow 0.3s; }
        textarea { min-height: 100px; resize: vertical; }
        textarea:focus, input:focus, select:focus { outline: none; border-color: #e67e22; box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.2); }
        textarea::placeholder, input::placeholder { color: #aaa; opacity: 1; }
        textarea:disabled, input:disabled, select:disabled { background-color: #f0f0f0 !important; cursor: not-allowed !important; color: #6c757d !important; border-color: #ddd !important; box-shadow: none !important;}
        .save-button, .delete-button { color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; transition: all 0.3s ease; font-size: 14px; font-weight: 500; }
        .save-button { background-color: #27ae60; }
        .delete-button { background-color: #e74c3c; margin-left: 8px; }
        .save-button:hover:not(:disabled) { background-color: #2ecc71; transform: translateY(-1px); }
        .delete-button:hover:not(:disabled) { background-color: #c0392b; transform: translateY(-1px); }
        .save-button:active, .delete-button:active { transform: translateY(0); }
        .save-button:disabled, .delete-button:disabled { background-color: #bdc3c7 !important; cursor: not-allowed !important; transform: none !important; box-shadow: none !important; opacity: 0.7 !important; }
        .button-group { display: flex; align-items: center; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .save-status { font-size: 14px; color: #27ae60; margin-top: 12px; display: none; font-weight: 600; }
        .error-message { color: #e74c3c; font-size: 13px; display: block; margin-top: 4px; margin-bottom: 10px; font-weight: 500; min-height: 1.2em; display: none; }
        .navigation-buttons { display: flex; justify-content: flex-end; /* Only Submit button */ margin-top: 40px; gap: 20px; border-top: 1px solid #eee; padding-top: 25px; }
        .navigation-buttons button { text-decoration: none; padding: 12px 25px; color: white; border-radius: 4px; font-weight: 600; text-align: center; transition: all 0.3s ease; font-size: 16px; border: none; cursor: pointer; background-color: #e67e22; }
        .navigation-buttons button:hover:not(:disabled) { background-color: #d35400; transform: translateY(-1px); }
        .navigation-buttons button:disabled { background-color: #bdc3c7 !important; cursor: not-allowed !important; opacity: 0.7 !important; }
        .floating-warning { background-color: #fff8e1; border-left: 4px solid #ffc107; padding: 15px 25px; color: #333; display: none; position: fixed; top: 100px; /* Adjusted */ left: 50%; transform: translateX(-50%); z-index: 1001; border-radius: 6px; box-shadow: 0 3px 10px rgba(0,0,0,0.2); animation: slideDownFadeInWarn 0.4s ease-out; font-weight: 500; max-width: 90%; width: auto; min-width: 300px; text-align: center; }
        @keyframes slideDownFadeInWarn { from { opacity: 0; top: 70px; } to { opacity: 1; top: 100px; } }
        @keyframes fadeOutUpWarn { from { opacity: 1; top: 100px; } to { opacity: 0; top: 70px; } }
        .required-field { border: 2px solid #e74c3c !important; background-color: #fff2f1 !important; box-shadow: none !important; }
        .required-star { color: #e74c3c; font-weight: bold; margin-left: 2px; }
        .question-progress-container { display: none !important; }

         /* Rating Styles */
         .rating-container { margin-top: 10px; margin-bottom: 15px; }
         .rating-label { display: block; margin-bottom: 8px; font-weight: 500; color: #495057; }
         .rating-options { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
         .rating-options input[type="radio"] { position: absolute; opacity: 0; width: 0; height: 0; }
         .rating-options label {
             cursor: pointer;
             padding: 8px 15px;
             border: 1px solid #ced4da;
             border-radius: 20px; /* Pill shape */
             background-color: #fff;
             color: #495057;
             transition: all 0.3s ease;
             font-size: 14px;
         }
         .rating-options input[type="radio"]:checked + label {
             background-color: #3498db; /* Blue when selected */
             color: white;
             border-color: #2980b9;
             font-weight: 600;
         }
          .rating-options input[type="radio"]:disabled + label {
             background-color: #e9ecef;
             color: #adb5bd;
             cursor: not-allowed;
             border-color: #dee2e6;
         }
         .rating-options label:hover:not(.disabled):not(:has(input:checked)) { /* Hover only if not disabled or checked */
             background-color: #eef5fc;
             border-color: #a5cff8;
         }
          /* Class to disable hover/click on labels when whole group is disabled */
         .rating-options.disabled label {
             cursor: not-allowed;
             background-color: #e9ecef !important; /* Ensure override */
             color: #adb5bd !important;
             border-color: #dee2e6 !important;
             /* Remove hover effects */
             transition: none;
             transform: none;
         }
          .rating-options.disabled label:hover { /* Explicitly disable hover effects */
            background-color: #e9ecef !important;
            border-color: #dee2e6 !important;
          }

        /* --- Completion Screen Styles --- */
        #completionScreen {
            display: none; /* Hidden by default */
            text-align: center;
            padding: 40px 20px;
            margin: 30px auto;
            max-width: 600px;
            background-color: #e8f5e9; /* Light green background */
            border: 1px solid #a5d6a7;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        #completionScreen h2 {
            font-size: 2em;
            color: #2e7d32; /* Dark green */
            margin-bottom: 15px;
        }
        #completionScreen p {
            font-size: 1.1em;
            color: #333;
            line-height: 1.6;
            margin-bottom: 25px;
        }
        #completionScreen .exit-button {
            background-color: #e67e22; /* Orange button */
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 16px;
            text-decoration: none; /* If using <a> tag */
            display: inline-block;
        }
        #completionScreen .exit-button:hover {
            background-color: #d35400;
            transform: translateY(-1px);
        }

        /* --- Responsive Adjustments (Original + Completion Screen) --- */
        @media (max-width: 768px) {
             #sticky-progress-container { top: 48px; padding: 6px 0; } /* Ensure correct top value based on nav */
             #sticky-progress-bar-wrapper { height: 20px; }
             #sticky-progress-text { font-size: 11px; }
             .floating-warning { top: 90px; /* Adjusted */ }
             @keyframes slideDownFadeInWarn { from { opacity: 0; top: 70px; } to { opacity: 1; top: 90px; } }
             @keyframes fadeOutUpWarn { from { opacity: 1; top: 90px; } to { opacity: 0; top: 70px; } }
             /* Other original */
             h1 { font-size: 22px; padding: 15px; margin: 20px 15px; }
             .container { padding: 20px; margin: 15px auto 20px; }
             .user-bar { padding: 10px 15px; font-size: 13px; }
             .user-name { font-size: 13px; } .user-email { font-size: 11px; }
             .logout-button { padding: 7px 12px; font-size: 12px; }
             .nav-tab { top: 0; } /* Reset top for nav-tab */
             .nav-tab a { margin: 0 5px; padding: 7px 10px; font-size: 13px;}
             .question-box { padding: 15px; margin: 20px 0; }
             textarea { min-height: 80px; }
             .save-button, .delete-button { padding: 7px 13px; font-size: 13px; }
             .navigation-buttons { justify-content: center; } /* Center single button */
             .navigation-buttons button { font-size: 15px; padding: 12px 20px; flex: 0 1 auto; /* Allow button to size naturally */}
             .rating-options label { padding: 6px 12px; font-size: 13px;}
             #completionScreen { padding: 30px 15px; }
             #completionScreen h2 { font-size: 1.8em; }
             #completionScreen p { font-size: 1em; }
             #completionScreen .exit-button { padding: 10px 25px; font-size: 15px; }
        }
         @media (max-width: 480px) {
             #sticky-progress-container { top: 48px; } /* Ensure correct top value */
             #sticky-progress-bar-wrapper { height: 18px; }
             #sticky-progress-text { font-size: 10px; }
             .floating-warning { top: 85px; /* Adjusted */ }
             @keyframes slideDownFadeInWarn { from { opacity: 0; top: 65px; } to { opacity: 1; top: 85px; } }
             @keyframes fadeOutUpWarn { from { opacity: 1; top: 85px; } to { opacity: 0; top: 65px; } }
             /* Other original */
             h1 { font-size: 20px; } h2 { font-size: 1.3em; } h3 { font-size: 1.1em; }
             .container { padding: 15px; margin: 10px auto 15px; }
             .button-group { gap: 8px; }
             .rating-options { gap: 6px; }
             .rating-options label { padding: 5px 10px; font-size: 12px;}
             #completionScreen h2 { font-size: 1.6em; }
             #completionScreen p { font-size: 0.95em; }
             #completionScreen .exit-button { padding: 10px 20px; font-size: 14px; }
         }
    </style>
</head>
<body>
    <!-- User Info Bar (Original) -->
    <div class="user-bar">
        <div class="user-info"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.8;"> <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path> <circle cx="12" cy="7" r="4"></circle> </svg> <div class="user-details"> <span class="user-name" id="userName">Loading...</span> <span class="user-email" id="userEmail"></span> </div> </div> <button class="logout-button" onclick="logout()"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path> <polyline points="16 17 21 12 16 7"></polyline> <line x1="21" y1="12" x2="9" y2="12"></line> </svg> Logout </button>
    </div>

    <!-- Navigation Tabs (Original Sticky) -->
    <nav class="nav-tab">
        <a href="dashboard.html">Dashboard</a>
        <a href="index.html">Home</a>
        <a href="introduction.html">Introduction</a>
        <a href="coaching-skills.html">Coaching Skills</a>
        <a href="coaching-individuals.html">Coaching Individuals</a>
        <a href="coaching-team.html">Team Coaching</a>
        <a href="coaching-yourself.html">Self Coaching</a>
        <a href="action-plan.html">Action Plan</a>
        <a href="ass.html">Assessment</a>
        <!-- Add link to feedback.html if needed -->
        <a href="feedback.html" class="active">Feedback</a>
    </nav>

    <!-- Sticky Progress Bar -->
    <div id="sticky-progress-container">
        <div id="sticky-progress-bar-wrapper">
            <div id="sticky-progress-bar">
                <span id="sticky-progress-text">Progress: 0%</span>
            </div>
        </div>
    </div>

    <!-- Main Heading -->
    <h1>Course Feedback</h1>

    <!-- Floating Warning Message -->
    <div class="floating-warning" id="generalWarningMessage"></div>

    <!-- Main Feedback Form Container -->
    <div class="container" id="feedbackFormContainer">

        <p style="text-align: center; font-size: 1.1em; margin-bottom: 30px;">We value your feedback! Please take a moment to share your thoughts on the course content and your learning experience.</p>

        <!-- Question 1: Overall Rating -->
        <div class="question-box" id="question-container-feedback_q1">
            <h3>Overall Course Rating<span class="required-star">*</span></h3>
            <p>How would you rate your overall experience with this Coaching & Leadership course?</p>
            <div class="rating-container">
                <span class="rating-label">Rate from 1 (Poor) to 5 (Excellent):</span>
                <div class="rating-options">
                    <input type="radio" id="rating1" name="overall_rating" value="1" class="required-answer editable-answer" data-question="feedback_q1">
                    <label for="rating1">1</label>
                    <input type="radio" id="rating2" name="overall_rating" value="2" class="required-answer editable-answer" data-question="feedback_q1">
                    <label for="rating2">2</label>
                    <input type="radio" id="rating3" name="overall_rating" value="3" class="required-answer editable-answer" data-question="feedback_q1">
                    <label for="rating3">3</label>
                    <input type="radio" id="rating4" name="overall_rating" value="4" class="required-answer editable-answer" data-question="feedback_q1">
                    <label for="rating4">4</label>
                    <input type="radio" id="rating5" name="overall_rating" value="5" class="required-answer editable-answer" data-question="feedback_q1">
                    <label for="rating5">5</label>
                </div>
            </div>
            <div class="button-group">
                <button class="save-button" onclick="saveAnswer('feedback_q1')">Save Rating</button>
                <button class="delete-button" onclick="deleteAnswer('feedback_q1')">Clear Rating</button>
                 <span class="error-message" id="error-feedback_q1"></span>
            </div>
            <span class="save-status" id="save-status-feedback_q1">Saved ✅</span>
        </div>

        <!-- Question 2: Most Valuable Part -->
        <div class="question-box" id="question-container-feedback_q2">
            <h3>Most Valuable Aspect<span class="required-star">*</span></h3>
            <p>What part of the course did you find most valuable or insightful?</p>
            <textarea placeholder="e.g., Learning about the GROW model, the section on team dynamics, the practical exercises..." class="editable-answer required-answer" data-question="feedback_q2"></textarea>
            <div class="button-group">
                <button class="save-button" onclick="saveAnswer('feedback_q2')">Save</button>
                <button class="delete-button" onclick="deleteAnswer('feedback_q2')">Delete</button>
                 <span class="error-message" id="error-feedback_q2"></span>
            </div>
            <span class="save-status" id="save-status-feedback_q2">Saved ✅</span>
        </div>

         <!-- Question 3: Least Valuable Part -->
        <div class="question-box" id="question-container-feedback_q3">
            <h3>Least Valuable Aspect (Optional)</h3>
            <p>Was there any part of the course you found less helpful or clear? (Optional)</p>
            <textarea placeholder="Your honest feedback helps us improve..." class="editable-answer" data-question="feedback_q3"></textarea> <!-- Not required -->
            <div class="button-group">
                <button class="save-button" onclick="saveAnswer('feedback_q3')">Save</button>
                <button class="delete-button" onclick="deleteAnswer('feedback_q3')">Delete</button>
                 <span class="error-message" id="error-feedback_q3"></span> <!-- Still include for potential future validation -->
            </div>
             <span class="save-status" id="save-status-feedback_q3">Saved ✅</span>
        </div>

         <!-- Question 4: Application -->
        <div class="question-box" id="question-container-feedback_q4">
            <h3>Practical Application<span class="required-star">*</span></h3>
            <p>How likely are you to apply the coaching techniques learned in this course in your work? (1 = Very Unlikely, 5 = Very Likely)</p>
             <div class="rating-container">
                <div class="rating-options">
                    <input type="radio" id="apply1" name="apply_likelihood" value="1" class="required-answer editable-answer" data-question="feedback_q4">
                    <label for="apply1">1</label>
                    <input type="radio" id="apply2" name="apply_likelihood" value="2" class="required-answer editable-answer" data-question="feedback_q4">
                    <label for="apply2">2</label>
                    <input type="radio" id="apply3" name="apply_likelihood" value="3" class="required-answer editable-answer" data-question="feedback_q4">
                    <label for="apply3">3</label>
                    <input type="radio" id="apply4" name="apply_likelihood" value="4" class="required-answer editable-answer" data-question="feedback_q4">
                    <label for="apply4">4</label>
                    <input type="radio" id="apply5" name="apply_likelihood" value="5" class="required-answer editable-answer" data-question="feedback_q4">
                    <label for="apply5">5</label>
                </div>
            </div>
            <div class="button-group">
                <button class="save-button" onclick="saveAnswer('feedback_q4')">Save Rating</button>
                <button class="delete-button" onclick="deleteAnswer('feedback_q4')">Clear Rating</button>
                 <span class="error-message" id="error-feedback_q4"></span>
            </div>
            <span class="save-status" id="save-status-feedback_q4">Saved ✅</span>
        </div>

         <!-- Question 5: Suggestions -->
        <div class="question-box" id="question-container-feedback_q5">
            <h3>Suggestions for Improvement (Optional)</h3>
            <p>Do you have any suggestions for how this course could be improved? (Topics, examples, format, etc.)</p>
            <textarea placeholder="We appreciate your ideas!" class="editable-answer" data-question="feedback_q5"></textarea> <!-- Not required -->
            <div class="button-group">
                <button class="save-button" onclick="saveAnswer('feedback_q5')">Save</button>
                <button class="delete-button" onclick="deleteAnswer('feedback_q5')">Delete</button>
                 <span class="error-message" id="error-feedback_q5"></span>
            </div>
             <span class="save-status" id="save-status-feedback_q5">Saved ✅</span>
        </div>

        <p style="text-align: center; font-weight: 600; margin-top: 30px;">Thank you for completing the course and providing your valuable feedback!</p>

        <!-- Navigation Buttons -->
        <div class="navigation-buttons">
             <!-- Only Submit Button Needed -->
            <button type="button" class="button" id="submitFeedbackButton">Submit Feedback</button>
        </div>
    </div><!-- /.container -->

    <!-- Completion Screen (Initially Hidden) -->
    <div id="completionScreen">
        <h2>🎉 Congratulations! 🎉</h2>
        <p>You've successfully completed the Coaching & Leadership course and submitted your feedback.</p>
        <p>Thank you for your valuable input! 🙏<br>Your journey as a coach starts now! 🚀</p>
        <button class="exit-button" onclick="window.location.href='index.html'">Back to Home</button>
    </div>


    <script>
        // --- Supabase Configuration ---
        const SUPABASE_URL = 'https://lgcutmuspcaralydycmg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnY3V0bXVzcGNhcmFseWR5Y21nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0NDY3MDEsImV4cCI6MjA2MTAyMjcwMX0.3u5Y7pkH2NNnnoGLMWVfAa5b8fq88o1itRYnG1K38tE';
        let supabase = null;

        // --- Configuration ---
        const localStorageKey = 'allUserAnswers_feedback'; // Unique key for this page (stores SAVED status)
        const SECTION_ID = 'feedback'; // Unique ID for progress tracking (on this page)
        const PAGE_NAME = 'feedback.html'; // Page name
        const FEEDBACK_TABLE = 'feedback_responses'; // Name of the new Supabase table

        // --- Unified Keys ---
        const LOGGED_IN_KEY = 'isUserLoggedIn';
        const CURRENT_USER_KEY = 'currentUser';

        // --- Required Question IDs for Progress Bar & Submission Validation ---
        const requiredQuestionIds = [
            'feedback_q1', // Overall Rating
            'feedback_q2', // Most Valuable
            'feedback_q4'  // Application Likelihood
            // Q3 and Q5 are optional
        ];

        // --- Supabase Table Structure & RLS (Informational Comment) ---
        /*
            REQUIRED Supabase Table: feedback_responses

            Columns:
            - id: uuid (Primary Key, default: gen_random_uuid())
            - user_id: uuid (Foreign Key to auth.users id, Indexed)
            - email: text
            - question: text (Stores the full question text, e.g., "Overall Course Rating")
            - answer: text (Stores the user's answer, e.g., "5" or "The GROW model was helpful.")
            - submitted_at: timestamp with time zone (default: now())

            Recommended Index:
            - Create an index on (user_id)
            - Optional: Create a UNIQUE constraint on (user_id, question) if you want the DB to strictly enforce one answer per user per question text. The current JS logic prevents overwriting via UI disable.

            REQUIRED Row Level Security (RLS) Policies on feedback_responses:
            1. Enable RLS on the table.
            2. Policy Name: "Allow authenticated users to insert their own feedback"
               Target Roles: authenticated
               Command: INSERT
               USING expression: (auth.uid() = user_id)
               WITH CHECK expression: (auth.uid() = user_id)
            3. Policy Name: "Allow users to view their own feedback" (Optional, if needed later)
               Target Roles: authenticated
               Command: SELECT
               USING expression: (auth.uid() = user_id)
               WITH CHECK expression: (auth.uid() = user_id) // Not strictly needed for SELECT
        */


        // Initialize Supabase Client
        try {
            if (window.supabase && window.supabase.createClient) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log(`Supabase client initialized successfully on ${PAGE_NAME}.`);
            } else { throw new Error("Supabase library not found."); }
        } catch (error) { console.error("CRITICAL ERROR initializing Supabase:", error); }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
             console.log(`%c${PAGE_NAME}: DOMContentLoaded event fired.`, "color: green;");
             if (!supabase) {
                 console.error(`Supabase client failed to initialize on ${PAGE_NAME}.`);
                 showGeneralWarningMessage('Database connection error. Progress might not save correctly.', true);
             }
             const currentUser = getCurrentUser();
             if (!currentUser || !currentUser.id || !currentUser.email) {
                 console.error(`%c${PAGE_NAME}: User not logged in or essential data missing. Redirecting...`, "color: red;");
                  // Basic redirection loop prevention
                  if (!window.location.search.includes('redir_attempt')) { window.location.href = `login.html?redirect=${encodeURIComponent(window.location.pathname + window.location.search)}&redir_attempt=1`; }
                  else { console.error("REDIRECTION LOOP DETECTED."); document.body.innerHTML = '<p style="color: red; padding: 20px;">Login check failed repeatedly. Please log in again.</p>'; }
                 return;
             }
             console.log(`%c${PAGE_NAME}: User validated (${currentUser.email}, ID: ${currentUser.id}). Initializing.`, "color: green;");
             displayUserInfo();
             loadUserAnswers(currentUser); // Load SAVED state from localStorage
             updateStickyProgressBar(); // Initial progress calculation based on loaded state
             setupEventListeners(currentUser);
             highlightActiveNav();
             console.log(`%c${PAGE_NAME}: Initialization complete.`, "color: blue;");
        });

        // --- User Info & Auth ---
        function getCurrentUser() { try { const d = localStorage.getItem(CURRENT_USER_KEY); if (!d) return null; const p = JSON.parse(d); if (p && typeof p === 'object' && p.email && p.name && p.id) { if (typeof p.progress !== 'object' || p.progress === null) p.progress = {}; return p; } else { localStorage.removeItem(CURRENT_USER_KEY); localStorage.removeItem(LOGGED_IN_KEY); return null; } } catch (e) { console.error("GUC Error:", e); localStorage.removeItem(CURRENT_USER_KEY); localStorage.removeItem(LOGGED_IN_KEY); return null; } }
        function saveCurrentUser(userObject) { try { if (!userObject || typeof userObject !== 'object') throw new Error("Invalid user object"); localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(userObject)); } catch (error) { console.error("SCU Error:", error); } }
        function displayUserInfo() { const u=getCurrentUser(); if(u){document.getElementById('userName').textContent=`Welcome, ${u.name || u.email.split('@')[0]}`; document.getElementById('userEmail').textContent=u.email;}else{console.warn("DIU: No user");}}
        function logout() { localStorage.removeItem(LOGGED_IN_KEY); localStorage.removeItem(CURRENT_USER_KEY); localStorage.removeItem(localStorageKey); window.location.href = 'login.html';}
        function highlightActiveNav() { const cP=window.location.pathname.split('/').pop()||PAGE_NAME; document.querySelectorAll('.nav-tab a').forEach(l=>{const lP=(l.getAttribute('href')||'').split('/').pop(); l.classList.toggle('active',lP===cP);});}

        // --- Answer Handling (Loading state from localStorage) ---
        function loadUserAnswers(currentUser) {
             if (!currentUser || !currentUser.email) return;
             let allAnswersState = {}; // This stores whether an answer IS SAVED (true/false or the value itself)
             try { const d = localStorage.getItem(localStorageKey); if (d) allAnswersState = JSON.parse(d) || {}; }
             catch (e) { console.error("Load Answers State Error:", e); }
             const userAnswersState = allAnswersState[currentUser.email] || {};

             document.querySelectorAll('.editable-answer').forEach(field => {
                 const questionId = field.dataset.question;
                 if (questionId) {
                      loadFieldState(field, questionId, userAnswersState); // Pass the state object
                 }
             });
             // updateStickyProgressBar() called after DOMContentLoaded
        }

        // --- Load Field State (Disables elements if marked as saved in localStorage) ---
        function loadFieldState(field, questionId, userAnswersState) {
            if (!field) return;
            const isRadioGroup = field.type === 'radio';
            const container = field.closest('.question-box');
            if (!container) return;

            const errorId = `error-${questionId}`;
            const statusId = `save-status-${questionId}`;
            const statusElement = document.getElementById(statusId);
            const buttonGroup = container.querySelector('.button-group');
            const saveButton = buttonGroup?.querySelector('.save-button');
            const deleteButton = buttonGroup?.querySelector('.delete-button');
            const radioOptionsContainer = container.querySelector('.rating-options');

            hideError(errorId);
            if (statusElement) statusElement.style.display = 'none';

            // Check if this questionId has a saved state marker in localStorage
            const isSaved = userAnswersState[questionId] !== undefined && userAnswersState[questionId] !== null;

            if (isSaved) {
                // --- Saved Answer State Found in localStorage ---
                field.classList.remove('required-field');

                if (isRadioGroup) {
                     // Disable all radio buttons in the group and style labels
                     container.querySelectorAll(`input[type="radio"][data-question="${questionId}"]`).forEach(radio => radio.disabled = true);
                     if(radioOptionsContainer) radioOptionsContainer.classList.add('disabled');
                     // Select the previously saved value (optional, but good UX if needed)
                     const savedValue = userAnswersState[questionId]; // Retrieve the actual value if stored
                     if (savedValue) {
                        const checkedRadio = container.querySelector(`input[type="radio"][data-question="${questionId}"][value="${savedValue}"]`);
                        if (checkedRadio) checkedRadio.checked = true;
                     }
                 } else {
                     // For textarea/other inputs - disable but don't necessarily load value from LS (it's in DB)
                     field.disabled = true;
                     // Optionally load the value IF it was stored in LS during save for display purpose
                     // const savedValue = userAnswersState[questionId];
                     // if (savedValue) field.value = savedValue;
                 }

                // Hide button group and show status
                if (buttonGroup) buttonGroup.style.display = 'none';
                if (statusElement) { statusElement.textContent = 'Saved ✅'; statusElement.style.display = 'inline-block'; }

            } else {
                // --- No Saved Answer State in localStorage ---
                 field.classList.remove('required-field');
                 if (isRadioGroup) {
                     // Ensure all radio buttons in the group are enabled and unchecked
                     container.querySelectorAll(`input[type="radio"][data-question="${questionId}"]`).forEach(radio => {
                         radio.disabled = false;
                         radio.checked = false;
                     });
                      if(radioOptionsContainer) radioOptionsContainer.classList.remove('disabled');
                 } else {
                     field.value = ''; // Clear textarea/input
                     field.disabled = false;
                 }

                 // Show button group, reset buttons, hide status
                 if (buttonGroup) {
                     buttonGroup.style.display = 'flex';
                     if (saveButton) { saveButton.disabled = false; saveButton.textContent = field.type === 'radio' ? 'Save Rating' : 'Save'; }
                     if (deleteButton) { deleteButton.disabled = false; deleteButton.style.display = 'inline-block'; deleteButton.textContent = field.type === 'radio' ? 'Clear Rating' : 'Delete'; }
                 }
                 if (statusElement) statusElement.style.display = 'none';
            }
        }

        // --- Local Storage Management (Stores SAVED status, not necessarily the answer value itself) ---
        function markAnswerAsSavedInStorage(userEmail, questionId, valueToStore = true) {
            if (!userEmail || !questionId) return false;
            let allStates = {};
            try { const d = localStorage.getItem(localStorageKey); if (d) allStates = JSON.parse(d) || {}; }
            catch (e) { allStates = {}; }
            if (!allStates[userEmail]) allStates[userEmail] = {};
            allStates[userEmail][questionId] = valueToStore; // Store true or the actual value if needed for loading display
            try { localStorage.setItem(localStorageKey, JSON.stringify(allStates)); return true; }
            catch (e) { console.error("Save State Storage Err:", e); return false; }
        }

        function removeAnswerSavedStateFromStorage(userEmail, questionId) {
            if (!userEmail || !questionId) return false;
            let allStates = {};
            try { const d = localStorage.getItem(localStorageKey); if (d) allStates = JSON.parse(d) || {}; else return false; }
            catch (e) { return false; }
            let stateChanged = false;
            if (allStates[userEmail]?.[questionId] !== undefined) {
                delete allStates[userEmail][questionId];
                stateChanged = true;
                if (Object.keys(allStates[userEmail]).length === 0) delete allStates[userEmail];
            }
            if (stateChanged) {
                try { localStorage.setItem(localStorageKey, JSON.stringify(allStates)); return true; }
                catch (e) { console.error("Delete State Storage Err:", e); return false; }
            }
            return false;
        }


        // --- Sticky Progress Bar Function (Based on saved state in localStorage) ---
        function updateStickyProgressBar() {
            const currentUser = getCurrentUser(); if (!currentUser?.email) return;
            let allAnswersState = {}; try { const d = localStorage.getItem(localStorageKey); if (d) allAnswersState = JSON.parse(d) || {}; } catch (e) { console.error("Progress LS Error:", e); return; }
            const userAnswersState = allAnswersState[currentUser.email] || {};
            const totalRequired = requiredQuestionIds.length; if (totalRequired === 0) return;
            let savedRequiredCount = 0;
            requiredQuestionIds.forEach(qId => {
                // Check if the question ID exists as a key in the user's saved state
                if (userAnswersState[qId] !== undefined && userAnswersState[qId] !== null) {
                    savedRequiredCount++;
                }
            });
            const percentage = totalRequired > 0 ? Math.round((savedRequiredCount / totalRequired) * 100) : 0;
            const barElement = document.getElementById('sticky-progress-bar'); const textElement = document.getElementById('sticky-progress-text');
            if (barElement && textElement) { barElement.style.width = `${percentage}%`; textElement.textContent = `Progress: ${percentage}%`; }
            // Also update progress in the main user object in localStorage (for dashboard etc.)
            if (!currentUser.progress) currentUser.progress = {};
             currentUser.progress[SECTION_ID] = percentage; // Use SECTION_ID for feedback progress
             saveCurrentUser(currentUser);
             console.log(`Sticky Progress Updated: ${percentage}% (${savedRequiredCount}/${totalRequired})`);
        }

        // --- Event Listeners Setup ---
        function setupEventListeners(currentUser) {
             if (!currentUser?.email) return;
             document.querySelectorAll('.editable-answer').forEach(field => {
                 const eventType = (field.tagName === 'TEXTAREA' || field.type === 'text' || field.type === 'number') ? 'input' : 'change'; // Use change for radio/select
                 field.addEventListener(eventType, function() {
                     const questionId = this.dataset.question;
                     if (questionId && !this.disabled) { // Only act if not already saved/disabled
                         hideError(`error-${questionId}`);
                         const buttonGroup = this.closest('.question-box')?.querySelector('.button-group');
                         const saveButton = buttonGroup?.querySelector('.save-button');
                         if (saveButton) saveButton.disabled = false;
                     }
                 });
             });
             const submitButton = document.getElementById('submitFeedbackButton');
             if (submitButton) { submitButton.addEventListener('click', handleSubmitFeedback); }
              else { console.warn("Submit Feedback button not found."); }
        }

        // --- UI Feedback & Validation ---
        function validateAllAnswers(showErrors = false) {
            let allRequiredSaved = true; let firstInvalidField = null;
            console.log(`Feedback Validation (Show Errors: ${showErrors}) - Checking if all required are SAVED.`);
            hideWarningMessage();

            // Check if all REQUIRED questions have been saved (i.e., are disabled)
            requiredQuestionIds.forEach(qId => {
                const container = document.getElementById(`question-container-${qId}`);
                const field = container?.querySelector(`.required-answer[data-question="${qId}"]`); // Get any field in the group

                if (!field) {
                    console.error(`Validation Error: Required field/container ${qId} not found!`);
                    allRequiredSaved = false; // Critical error
                    return;
                }

                // The validation check is simply: Is the field disabled?
                // If it's required AND enabled, it means it hasn't been saved yet.
                if (!field.disabled) {
                    allRequiredSaved = false;
                    if (!firstInvalidField) {
                        firstInvalidField = field; // Mark the first unsaved required field
                    }
                    if (showErrors) {
                        const errorId = `error-${qId}`;
                        showError(errorId, field.type === 'radio' ? null : field, 'Please save your feedback for this required question.');
                    }
                } else {
                    // Field is disabled (saved), clear any residual error indicators
                    const errorId = `error-${qId}`;
                    hideError(errorId);
                     if (field.type !== 'radio') field.classList.remove('required-field');
                }
            });

            if (!allRequiredSaved && showErrors && firstInvalidField) {
                 firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                 showGeneralWarningMessage();
            } else if (!allRequiredSaved && showErrors) { showGeneralWarningMessage(); }

            console.log("Feedback Validation (All Required Saved) result:", allRequiredSaved);
            return allRequiredSaved;
        }


        function showGeneralWarningMessage(message = "Please save your answers for all required feedback questions marked with * before submitting.", sticky = false) { const w=document.getElementById('generalWarningMessage'); if(!w) return; w.innerHTML = `<strong>Action Required:</strong> ${message}`; w.style.animation='none'; void w.offsetWidth; w.style.display='block'; w.style.animation='slideDownFadeInWarn 0.4s ease-out'; clearTimeout(w.timer); if (!sticky) { w.timer=setTimeout(()=>{ w.style.animation='fadeOutUpWarn 0.5s ease-out forwards'; setTimeout(()=>{ if(w.style.animationName === 'fadeOutUpWarn'){w.style.display='none';w.style.animation='';} }, 500); }, 5000); } } // Increased timeout
        function hideWarningMessage() { const w=document.getElementById('generalWarningMessage'); if(w && w.style.display !== 'none'){ w.style.animation='fadeOutUpWarn 0.5s ease-out forwards'; setTimeout(()=>{if(w.style.animationName==='fadeOutUpWarn'){w.style.display='none'; w.style.animation='';}},500);}}
        function showError(errorId, fieldToMark, message = 'This field is required.') { const e=document.getElementById(errorId); if(e){e.textContent=message; e.style.display='block'; e.style.width='100%'; e.style.textAlign = fieldToMark ? 'left' : 'center';} if(fieldToMark && !fieldToMark.disabled) fieldToMark.classList.add('required-field');} // Only add class if not disabled
        function hideError(errorId) { const e=document.getElementById(errorId); if(e) e.style.display='none';}
        function hideMessages(statusId, errorId, field) { hideError(errorId); const s = statusId ? document.getElementById(statusId) : null; if(s)s.style.display='none'; if (field && field.type !== 'radio') field.classList.remove('required-field'); }


        // --- Actions (Save to DB, Delete unsaved) ---
        window.saveAnswer = async function(questionId) {
            if (!supabase) { showGeneralWarningMessage('Database connection error. Cannot save.', true); return; }
            const currentUser = getCurrentUser(); if (!currentUser?.email || !currentUser.id) { showGeneralWarningMessage('Session expired. Please log in again.', true); setTimeout(logout, 3000); return; }

            const container = document.getElementById(`question-container-${questionId}`);
            if (!container) { console.error("Save Error: Question container not found for", questionId); return; }

            const field = container.querySelector(`.editable-answer[data-question="${questionId}"]`); // General selector
            const errorId = `error-${questionId}`; const statusId = `save-status-${questionId}`;
            const statusElement = document.getElementById(statusId);
            const buttonGroup = container.querySelector('.button-group');
            const saveButton = buttonGroup?.querySelector('.save-button'); const deleteButton = buttonGroup?.querySelector('.delete-button');
            const radioOptionsContainer = container.querySelector('.rating-options');

            if (!field || !buttonGroup || !saveButton || !deleteButton) { console.error(`Save Error: Required elements missing for ${questionId}.`); return; }
            // Check if ANY field in the group is already disabled (primary check)
            if (field.disabled) { console.warn(`Attempted save on already disabled field/group: ${questionId}.`); return; }

            let answer = null; let trimmedAnswer = null; let isValid = false;
            const isRequired = requiredQuestionIds.includes(questionId);

            hideMessages(statusId, errorId, field); // Clear errors/status

            // --- Get Answer Value & Validate ---
            if (field.type === 'radio') {
                 const checkedRadio = container.querySelector(`input[type="radio"][data-question="${questionId}"]:checked`);
                 if (checkedRadio) {
                     answer = checkedRadio.value;
                     trimmedAnswer = answer; // Value is likely already trimmed
                     isValid = true;
                 } else if (isRequired) {
                     showError(errorId, null, 'Please select a rating.'); isValid = false;
                 } else {
                     isValid = true; // Allow saving empty optional radio (though unlikely scenario)
                     answer = null; // Explicitly null if optional and nothing selected
                 }
            } else { // Textarea or other inputs
                 answer = field.value; trimmedAnswer = answer.trim();
                 if (isRequired && trimmedAnswer === '') {
                     showError(errorId, field, 'Please provide your feedback for this required question.'); isValid = false;
                 } else if (!isRequired && trimmedAnswer === '') {
                     answer = null; // Save null for empty optional textarea
                     isValid = true;
                 }
                 else { isValid = true; } // Valid if required and filled, or optional and filled
            }

            if (!isValid) { updateStickyProgressBar(); return; } // Stop if not valid

            setButtonLoading(saveButton, true, 'Saving...'); // Use helper for button state
            deleteButton.disabled = true;

            try {
                // --- Get Question Text ---
                 let questionText = `Feedback Question ID: ${questionId}`; // Default fallback
                 const h3 = container.querySelector('h3');
                 if (h3) {
                     questionText = h3.textContent.replace(/\s*\*/g, '').trim(); // Remove star and trim
                 } else {
                    // Try finding a preceding <p> if no h3
                    const p = container.querySelector('p');
                    if(p) questionText = p.textContent.trim();
                 }


                const submissionTime = new Date().toISOString();
                // --- Prepare Payload for feedback_responses table ---
                 const feedbackPayload = {
                    user_id: currentUser.id,
                    email: currentUser.email,
                    question: questionText, // The full question text
                    answer: answer, // The raw answer (can be null for empty optional)
                    submitted_at: submissionTime
                 };

                // --- Save to Supabase feedback_responses Table ---
                // Using UPSERT with conflict resolution on (user_id, question)
                // Requires a UNIQUE constraint on (user_id, question) in the DB.
                console.log(`Upserting to ${FEEDBACK_TABLE}:`, feedbackPayload);
                const { data, error } = await supabase
                    .from(FEEDBACK_TABLE)
                    .upsert([feedbackPayload], { onConflict: 'user_id, question' }) // Specify columns for conflict
                    .select(); // Select to confirm

                // --- Alternative: Simple INSERT (if UPSERT/constraint is problematic) ---
                // console.log(`Inserting into ${FEEDBACK_TABLE}:`, feedbackPayload);
                // const { data, error } = await supabase
                //     .from(FEEDBACK_TABLE)
                //     .insert([feedbackPayload])
                //     .select();

                if (error) {
                     // Handle potential duplicate error if constraint exists but upsert fails
                     if (error.code === '23505') { // Postgres unique violation code
                        console.warn(`Duplicate detected for question "${questionText}". Assuming already saved.`);
                        // Proceed as if successful because the data is likely already there
                     } else {
                         throw new Error(`Supabase error: ${error.message} (Code: ${error.code})`);
                     }
                }
                 console.log("Supabase save/upsert successful:", data);

                // --- Update UI on SUCCESS ---
                if(field.type === 'radio') {
                     container.querySelectorAll(`input[type="radio"][data-question="${questionId}"]`).forEach(radio => radio.disabled = true);
                     if(radioOptionsContainer) radioOptionsContainer.classList.add('disabled');
                 } else {
                     field.disabled = true; // Disable textarea/input
                 }
                 field.classList.remove('required-field');
                 buttonGroup.style.display = 'none'; // Hide buttons
                 if (statusElement) { statusElement.textContent = 'Saved ✅'; statusElement.style.display = 'inline-block'; }

                markAnswerAsSavedInStorage(currentUser.email, questionId, answer); // Mark as saved in local storage (store answer for potential reload UX)
                updateStickyProgressBar(); // Update overall progress

            } catch (error) {
                console.error(`Failed to save answer for ${questionId} ("${questionText}"):`, error);
                showError(errorId, field.type === 'radio' ? null : field, `Save failed. Please try again or contact support.`);
                // Re-enable buttons & fields on failure
                if(field.type === 'radio') {
                     container.querySelectorAll(`input[type="radio"][data-question="${questionId}"]`).forEach(radio => radio.disabled = false);
                      if(radioOptionsContainer) radioOptionsContainer.classList.remove('disabled');
                 } else {
                     field.disabled = false;
                 }
                 // Ensure buttons are re-enabled and text reset
                 setButtonLoading(saveButton, false, field.type === 'radio' ? 'Save Rating' : 'Save');
                 deleteButton.disabled = false; deleteButton.style.display = 'inline-block'; // Ensure delete is visible again

                 if (statusElement) statusElement.style.display = 'none';
                 updateStickyProgressBar(); // Recalculate progress in case validation state changed
            }
        };

        window.deleteAnswer = function(questionId) {
            const container = document.getElementById(`question-container-${questionId}`);
            if (!container) return;
            const field = container.querySelector(`.editable-answer[data-question="${questionId}"]`);
            if (!field) return; // Should not happen

            // --- PREVENT DELETING SAVED ANSWERS ---
            if (field.disabled) {
                console.warn(`Attempted to delete already saved/disabled answer: ${questionId}`);
                const errorId = `error-${questionId}`;
                showError(errorId, null, "Saved answers cannot be cleared or deleted.");
                // Hide the error message after a few seconds
                setTimeout(() => hideError(errorId), 3500);
                return; // Stop the function
            }

            // --- Proceed with clearing UNSAVED answer ---
            const currentUser = getCurrentUser(); if (!currentUser?.email) return; // Should be logged in
            const errorId = `error-${questionId}`; const statusId = `save-status-${questionId}`; const statusElement = document.getElementById(statusId);
            const buttonGroup = container.querySelector('.button-group'); const saveButton = buttonGroup?.querySelector('.save-button'); const deleteButton = buttonGroup?.querySelector('.delete-button');
            const radioOptionsContainer = container.querySelector('.rating-options');

            hideMessages(statusId, errorId, field); // Clear error, hide status

            if (field.type === 'radio') {
                 // Uncheck all radio buttons in the group, ensure enabled
                 container.querySelectorAll(`input[type="radio"][data-question="${questionId}"]`).forEach(radio => {
                    radio.checked = false;
                    radio.disabled = false; // Ensure enabled
                 });
                 if(radioOptionsContainer) radioOptionsContainer.classList.remove('disabled');
            } else {
                 field.value = ''; // Clear textarea/input
                 field.disabled = false; // Ensure enabled
                 field.classList.remove('required-field');
            }

            // No need to interact with DB here, just clear local state if it existed (shouldn't for unsaved)
            removeAnswerSavedStateFromStorage(currentUser.email, questionId);
            console.log("Cleared unsaved answer input locally for", questionId);
            updateStickyProgressBar(); // Update progress (shouldn't change if it wasn't saved, but good practice)

            // Ensure buttons are visible/enabled correctly for an unsaved state
            if (buttonGroup) {
                buttonGroup.style.display = 'flex';
                if (saveButton) saveButton.disabled = false; // Should be re-enabled
                if (deleteButton) deleteButton.disabled = false; // Should be enabled
            }
        };

        // --- Submit Feedback Function (Validation & Show Completion Screen) ---
        async function handleSubmitFeedback() {
            const submitButton = document.getElementById('submitFeedbackButton');
            const formContainer = document.getElementById('feedbackFormContainer');
            const completionScreen = document.getElementById('completionScreen');

            if (!formContainer || !completionScreen || !submitButton) {
                console.error("Submit Error: Missing essential elements (form container, completion screen, or submit button).");
                showGeneralWarningMessage("An unexpected error occurred. Cannot submit feedback.", true);
                return;
            }

            // 1. Validate that all REQUIRED questions are saved (disabled)
            if (!validateAllAnswers(true)) {
                showGeneralWarningMessage("Please save your answers for all required feedback questions (*) before submitting.");
                // Ensure button is not stuck in loading state if validation fails early
                 setButtonLoading(submitButton, false, 'Submit Feedback');
                return;
            }

            // 2. Confirmation Dialog
            if (!confirm("Are you sure you want to finalize and submit your feedback?")) {
                setButtonLoading(submitButton, false, 'Submit Feedback'); // Reset button if cancelled
                return;
            }

            // 3. Show Loading State
            setButtonLoading(submitButton, true, 'Finalizing...');

            // 4. Hide Form, Show Completion Screen
            // No further DB interaction needed here as answers were saved individually.
            try {
                // Hide form elements gracefully (optional animation)
                formContainer.style.transition = 'opacity 0.5s ease-out';
                formContainer.style.opacity = '0';

                // Hide progress bar and warning messages
                const progressContainer = document.getElementById('sticky-progress-container');
                if(progressContainer) progressContainer.style.display = 'none';
                hideWarningMessage(); // Hide any floating warning

                // Use setTimeout to allow opacity transition before setting display: none
                setTimeout(() => {
                    formContainer.style.display = 'none';
                    // Display completion screen
                    completionScreen.style.display = 'block';
                    // Optional: Scroll to top
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    // Hide the main H1 title as well
                    const mainTitle = document.querySelector('h1');
                     if(mainTitle) mainTitle.style.display = 'none';
                }, 500); // Match timeout to transition duration

                console.log("Feedback submission finalized. Displaying completion screen.");

                // No need to disable the submit button further as the form is hidden.

            } catch (err) {
                 console.error("Error during feedback finalization UI transition:", err);
                 showGeneralWarningMessage('An error occurred while finalizing your feedback. Please refresh and try again.', true);
                 setButtonLoading(submitButton, false, 'Submit Feedback'); // Reset button on error
                 // Optionally re-show the form if the transition failed badly
                 formContainer.style.display = 'block';
                 formContainer.style.opacity = '1';
            }
        }

        // --- Helper for Button Loading State ---
        function setButtonLoading(button, isLoading, loadingText = 'Saving...', defaultText = 'Save') {
            if (!button) return;
            button.disabled = isLoading;
            if (isLoading) {
                button.textContent = loadingText;
                // Optional: Add a spinner icon or class
            } else {
                button.textContent = defaultText || button.dataset.defaultText || 'Save'; // Restore original or provided text
                // Optional: Remove spinner icon or class
            }
        }
         // Add default text to save buttons on load if needed for the helper
         document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.save-button').forEach(btn => {
                btn.dataset.defaultText = btn.textContent;
            });
             document.querySelectorAll('.delete-button').forEach(btn => {
                btn.dataset.defaultText = btn.textContent;
            });
             const submitBtn = document.getElementById('submitFeedbackButton');
             if(submitBtn) submitBtn.dataset.defaultText = submitBtn.textContent;
         });


    </script>

</body>
</html>
