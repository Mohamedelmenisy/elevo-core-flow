<!doctype html>
<html lang=en>
<head>
<meta charset=UTF-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Login - Elevo Core</title>
<link rel=icon href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M3 12h18M3 6h12M3 18h15'/><path d='M17 9l4 3l-4 3'/></svg>">
<link rel=stylesheet href=style.css>
<style>::-webkit-scrollbar{display:none}body,html{scrollbar-width:none;-ms-overflow-style:none}.welcome-note{background:linear-gradient(135deg,rgba(var(--primary-color-rgb),.1),rgba(var(--primary-color-rgb),.05));border-left:4px solid var(--primary-color);border-radius:var(--border-radius-md);padding:1rem 1.25rem;margin-bottom:2rem;display:flex;align-items:center;gap:1rem;box-shadow:var(--shadow-sm)}.note-icon{font-size:1.5rem;color:var(--primary-color)}.welcome-note p{margin:0;font-size:.9em;color:var(--text-color-light);line-height:1.5}</style>
</head>
<body>
<div class=login-container>
<div class=logo>
<svg xmlns=http://www.w3.org/2000/svg viewBox="0 0 24 24" fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round aria-hidden=true> <circle cx=12 cy=12 r=10></circle> <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon> </svg>
<h2>Elevo Core</h2>
</div>
<div class=login-header>
<h2>Welcome Back</h2>
<p>Please enter your credentials to access Elevo Core.</p>
</div>
<div class=welcome-note>
<div class=note-icon>ðŸ’¡</div>
<p>Welcome! New users start as Agents with access to a personal dashboard. Administrator privileges are granted later by management from the database.</p>
</div>
<div id=supabaseErrorMessage class="form-message error-message" style=display:none>
Error: Could not initialize authentication service.
</div>
<div id=alreadyLoggedInMessage class="form-message success-message" style=display:none>
You are already logged in. <a href=core-flow.html style=color:var(--success-color);font-weight:700;text-decoration:underline>Go to App</a>
</div>
<div id=loginMessage class="form-message success-message" style=display:none></div>
<div id=loginError class="form-message error-message general-form-error" style=display:none></div>
<form id=loginForm novalidate>
<div class=form-group>
<label for=email>Email Address</label>
<div class=input-wrapper>
<span class=input-icon aria-hidden=true>
<svg xmlns=http://www.w3.org/2000/svg width=24 height=24 viewBox="0 0 24 24" fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
</span>
<input type=email id=email name=email required placeholder=your.email@example.com aria-describedby="emailError loginError">
</div>
<div id=emailError class="error-message field-error-message"></div>
</div>
<div class=form-group>
<label for=password>Password</label>
<div class=input-wrapper>
<span class=input-icon aria-hidden=true>
<svg xmlns=http://www.w3.org/2000/svg width=24 height=24 viewBox="0 0 24 24" fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round><rect x=3 y=11 width=18 height=11 rx=2 ry=2></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
</span>
<input type=password id=password name=password required placeholder=â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢ aria-describedby="passwordError loginError">
<span class=password-toggle aria-label="Show password" role=button tabindex=0> <svg viewBox="0 0 24 24" fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx=12 cy=12 r=3></circle></svg> </span>
</div>
<div id=passwordError class="error-message field-error-message"></div>
</div>
<div class=form-options>
<div class=remember-me>
<input type=checkbox id=remember name=remember>
<label for=remember>Remember me</label>
</div>
<a href=# id=forgotPasswordLink class=forgot-password-link>Forgot password?</a>
</div>
<p class=data-privacy-notice>
<svg xmlns=http://www.w3.org/2000/svg width=16 height=16 viewBox="0 0 24 24" fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round aria-hidden=true><rect x=3 y=11 width=18 height=11 rx=2 ry=2></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
Your information is kept confidential and secure.
</p>
<button type=submit class="login-btn primary-button" id=loginButton> <span class=btn-text>Sign In</span> <span class=loading-spinner></span> </button>
</form>
<div class=links>
Don't have an account? <a href=signup.html>Sign up</a>
</div>
</div>
<script type=module>import{createClient}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";const SUPABASE_URL="https://aefiigottnlcmjzilqnh.supabase.co",SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlZmlpZ290dG5sY21qemlscW5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNzY2MDQsImV4cCI6MjA2Mjc1MjYwNH0.FypB02v3tGMnxXV9ZmZMdMC0oQpREKOJWgHMPxUzwX4";let supabase;try{supabase=createClient(SUPABASE_URL,SUPABASE_ANON_KEY),console.log("Supabase client initialized for login.html using ES Modules")}catch(e){console.error("Supabase client initialization failed:",e);const o=document.getElementById("supabaseErrorMessage");o&&(o.textContent=e.message||"Error: Could not initialize authentication service.",o.style.display="block");const s=document.getElementById("loginForm");s&&(s.style.display="none")}const loginForm=document.getElementById("loginForm"),emailInput=document.getElementById("email"),passwordInput=document.getElementById("password"),rememberCheckbox=document.getElementById("remember"),loginButton=document.getElementById("loginButton"),passwordToggle=document.querySelector(".password-toggle"),emailError=document.getElementById("emailError"),passwordError=document.getElementById("passwordError"),loginGeneralError=document.getElementById("loginError"),loginSuccessMessage=document.getElementById("loginMessage"),forgotPasswordLink=document.getElementById("forgotPasswordLink"),REMEMBERED_EMAIL_KEY="elevoCoreRememberedEmail",USER_DATA_KEY="elevoCoreUserData";function displayError(e,o){e&&(e.textContent=o,e.style.display="block")}function clearError(e){e&&(e.textContent="",e.style.display="none")}function displaySuccess(e,o){e&&(e.textContent=o,e.style.display="block")}function setButtonLoading(e){loginButton&&(loginButton.disabled=e,loginButton.classList.toggle("loading",e))}function togglePasswordVisibility(e,o){if(!e||!o)return;const s="password"===o.type;o.type=s?"text":"password",e.innerHTML=s?'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>',e.setAttribute("aria-label",s?"Hide password":"Show password")}async function storeUserDetails(e){if(!e||!supabase)return null;try{const{data:o,error:s}=await supabase.from("users").select("name, is_admin, role").eq("id",e.id).single();s&&"PGRST116"!==s.code&&console.warn("Error fetching user profile:",s.message);const r={id:e.id,email:e.email,name:o?.name||e.user_metadata?.full_name||e.email.split("@")[0],isAdmin:o?.is_admin||!1,role:o?.role||"agent"};return localStorage.setItem(USER_DATA_KEY,JSON.stringify(r)),console.log("User details stored in localStorage:",r),r}catch(e){return console.error("Failed to store user details:",e),null}}async function initializePage(){if(!supabase)return;const{data:{user:e},error:o}=await supabase.auth.getUser();if(e&&!o){console.log("User has a valid session. Checking role and redirecting...");const o="admin"===((await storeUserDetails(e))?.role||"agent")?"dashboard.html":"agent-portal.html";return void window.location.replace(o)}console.log("No valid session found. Displaying login form.");const s=localStorage.getItem(REMEMBERED_EMAIL_KEY);s&&emailInput&&(emailInput.value=s,rememberCheckbox&&(rememberCheckbox.checked=!0))}passwordToggle&&passwordInput&&passwordToggle.addEventListener("click",(()=>togglePasswordVisibility(passwordToggle,passwordInput))),loginForm&&supabase&&loginForm.addEventListener("submit",(async function(e){e.preventDefault(),clearError(emailError),clearError(passwordError),clearError(loginGeneralError),clearError(loginSuccessMessage),setButtonLoading(!0);const o=emailInput.value.trim().toLowerCase(),s=passwordInput.value;rememberCheckbox.checked?localStorage.setItem(REMEMBERED_EMAIL_KEY,o):localStorage.removeItem(REMEMBERED_EMAIL_KEY);try{const{data:e,error:r}=await supabase.auth.signInWithPassword({email:o,password:s});if(r)throw r;if(!e||!e.user)throw new Error("Login successful but no user data returned.");{const o=(await storeUserDetails(e.user))?.role||"agent",s="admin"===o?"dashboard.html":"agent-portal.html";displaySuccess(loginSuccessMessage,`Login successful! Redirecting to your ${o} dashboard...`),setTimeout((()=>{window.location.replace(s)}),1500)}}catch(e){console.error("Login error:",e);let o="Login failed. Please check your credentials.";e&&e.message&&(o=e.message.toLowerCase().includes("invalid login credentials")?"Incorrect email or password.":e.message.toLowerCase().includes("email not confirmed")?"Please check your inbox to confirm your email address first.":e.message),displayError(loginGeneralError,o),setButtonLoading(!1)}})),forgotPasswordLink&&supabase&&forgotPasswordLink.addEventListener("click",(async e=>{e.preventDefault();const o=emailInput.value.trim();if(!o)return void displayError(loginGeneralError,"Please enter your email address above to request a password reset.");displaySuccess(loginSuccessMessage,"Sending reset instructions...");const{error:s}=await supabase.auth.resetPasswordForEmail(o,{redirectTo:window.location.origin+"/reset-password.html"});s?displayError(loginGeneralError,s.message):displaySuccess(loginSuccessMessage,"Password reset instructions sent. Please check your email.")})),supabase&&initializePage()</script>
<script type="module">
import { supabase } from './supabaseClient.js';

document.addEventListener('DOMContentLoaded', () => {
  const loginForm = document.getElementById('loginForm');
  const loginError = document.getElementById('loginError');
  const loginMessage = document.getElementById('loginMessage');

  // show "already logged in" if session exists
  (async () => {
    try {
      const { data } = await supabase.auth.getSession();
      const session = data?.session ?? null;
      if (session) {
        const already = document.getElementById('alreadyLoggedInMessage');
        if (already) already.style.display = 'block';
      }
    } catch (err) {
      const supabaseErrorMessage = document.getElementById('supabaseErrorMessage');
      if (supabaseErrorMessage) supabaseErrorMessage.style.display = 'block';
      console.error('Auth init error', err);
    }
  })();

  // simple form submit
  loginForm?.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    if (loginError) loginError.style.display = 'none';
    const email = document.getElementById('email')?.value?.trim();
    const password = document.getElementById('password')?.value;
    if (!email || !password) {
      if (loginError) {
        loginError.textContent = 'Please provide email and password.';
        loginError.style.display = 'block';
      }
      return;
    }

    try {
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) throw error;
      // successful sign in: small delay for UX then redirect to core-flow.html
      if (loginMessage) {
        loginMessage.textContent = 'Signed in â€” redirecting...';
        loginMessage.style.display = 'block';
      }
      // short delay to allow UI update & any auth state propagation
      setTimeout(() => {
        window.location.href = 'core-flow.html';
      }, 450); // ~half second
    } catch (err) {
      console.error('Login error', err);
      if (loginError) {
        loginError.textContent = err?.message || 'Sign in failed.';
        loginError.style.display = 'block';
      }
    }
  });

  // password show/hide toggle (if present)
  document.querySelectorAll('.password-toggle').forEach(toggle => {
    toggle.addEventListener('click', () => {
      const input = toggle.closest('.input-wrapper')?.querySelector('input[type="password"], input[type="text"]');
      if (!input) return;
      input.type = input.type === 'password' ? 'text' : 'password';
    });
  });
});
</script>

</body>
</html>
