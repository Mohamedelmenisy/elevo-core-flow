<!doctype html>
<html lang=en class=dark>
<head>
<meta charset=UTF-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Admin Dashboard - Elevo Core</title>
<link rel=icon href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234e8cff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M12 22V12M9 19l3-3 3 3M12 2a4 4 0 0 0-4 4v0a4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4z'/></svg>">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel=stylesheet>
<script src=https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2></script>
<script src=https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js></script>
<script src=role-check.js></script>
<style>
:root{--primary-color:#4e8cff;--primary-color-rgb:78,140,255;--accent-color:#8b5cf6;--success-color:#10b981;--warning-color:#f59e0b;--danger-color:#ef4444;--bg-color:#111827;--card-bg-color:#1f2937;--border-color:#4b5563;--text-color:#f9fafb;--text-color-light:#d1d5db;--border-radius-lg:12px;}
body{font-family:Poppins,sans-serif;background-color:var(--bg-color);color:var(--text-color);margin:0;}
.app-container{display:flex;flex-direction:column;min-height:100vh;}
.app-header{background-color:rgba(17,24,39,.95);padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;box-shadow:0 4px 6px -1px rgba(0,0,0,.1);position:sticky;top:0;z-index:100;backdrop-filter:blur(10px);border-bottom:1px solid var(--border-color);}
.app-title{font-weight:600;font-size:1.4rem;color:var(--primary-color);}
.header-controls{display:flex;align-items:center;gap:1.5rem;}
.nav-link{color:var(--text-color-light);text-decoration:none;padding:.5rem 1rem;border-radius:8px;transition:all .15s ease;font-weight:500;}
.nav-link:hover{background-color:#374151;color:var(--text-color);}
.logout-btn{background:transparent;border:none;color:var(--text-color-light);cursor:pointer;padding:.5rem;border-radius:8px;transition:all .15s ease;}
.logout-btn:hover{background-color:var(--danger-color);color:#fff;}
.dashboard-main{padding:1.5rem 2rem;flex-grow:1;}
.dashboard-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;margin-bottom:1.5rem;}
.dashboard-header h1{font-size:2rem;font-weight:700;color:var(--text-color);}
.action-button{padding:.75rem 1.5rem;border:none;border-radius:8px;cursor:pointer;font-weight:500;display:inline-flex;align-items:center;gap:.5rem;transition:all .15s ease;}
.primary-button{background-color:var(--primary-color);color:#fff;}
.primary-button:hover{background-color:#3b82f6;}
.secondary-button{background-color:#374151;color:var(--text-color);}
.secondary-button:hover{background-color:#4b5563;}
.dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.5rem;}
.dashboard-card{background-color:var(--card-bg-color);border-radius:var(--border-radius-lg);padding:1.5rem;box-shadow:0 4px 6px rgba(0,0,0,.1);transition:transform .2s ease,box-shadow .2s ease;border-left:4px solid transparent;}
.dashboard-card:hover{transform:translateY(-4px);box-shadow:0 10px 15px rgba(0,0,0,.2);}
.dashboard-card h3{margin:0 0 .75rem 0;font-size:1.1em;color:var(--text-color-light);font-weight:500;}
.dashboard-card .value{font-size:2.2em;font-weight:700;margin:.5rem 0;color:var(--text-color);}
.card-large{grid-column:span 2;}
.card-full{grid-column:1/-1;}
.chart-container{height:280px;position:relative;}
.bottom-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-top:1.5rem;}
@media(max-width:992px){.card-large{grid-column:span 1;}.bottom-grid{grid-template-columns:1fr;}}
.loading-container{display:flex;flex-direction:column;align-items:center;justify-content:center;height:70vh;}
.spinner{width:50px;height:50px;border:4px solid rgba(255,255,255,.1);border-left-color:var(--primary-color);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:1rem;}
@keyframes spin{to{transform:rotate(360deg)}}
.app-footer{text-align:center;padding:1.5rem;color:var(--text-color-light);font-size:.9em;border-top:1px solid var(--border-color);margin-top:auto;}
</style>
</head>
<body>
<div id=app-container class=app-container>
<header class=app-header>
    <span class=app-title>Elevo Core - Admin Dashboard</span>
    <div class=header-controls>
        <a href=core-flow.html class=nav-link>Call App</a>
        <a href=agent-portal.html class=nav-link>Agent Portal</a>
        <a href=rtm-dashboard.html class=nav-link>RTM Dashboard</a>
        <span id=userName class=nav-link style="font-weight: bold;"></span>
        <button id=logoutButton class=logout-btn title="Logout">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
        </button>
    </div>
</header>
<main class="app-main dashboard-main">
<div id=auth-loading class=loading-container>
    <div class=spinner></div>
    <p>Syncing data with Elevo Core...</p>
</div>
<div id=dashboardContent style=display:none>
    <div class=dashboard-header>
        <h1>Admin Dashboard</h1>
        <div>
            <button id=refreshDataBtn class="action-button secondary-button">Refresh</button>
            <button id=exportReportBtn class="action-button primary-button">Export Report</button>
        </div>
    </div>
    <div class=dashboard-grid>
        <div class=dashboard-card style="border-left-color: var(--primary-color);">
            <h3>Live Tickets</h3>
            <div class=value id=liveTicketsCount>0</div>
        </div>
        <div class=dashboard-card style="border-left-color: var(--warning-color);">
            <h3>Delayed Tickets</h3>
            <div class=value id=delayedTicketsCount>0</div>
        </div>
        <div class=dashboard-card style="border-left-color: var(--success-color);">
            <h3>Recent Tickets (10m)</h3>
            <div class=value id=recentTicketsCount>0</div>
        </div>
        <div class=dashboard-card style="border-left-color: var(--accent-color);">
            <h3>Total Calls Today</h3>
            <div class=value id=totalCallsToday>0</div>
        </div>
        <div class="dashboard-card card-large">
            <h3>Call Quality Summary</h3>
            <div class=chart-container>
                <canvas id=qualitySummaryChart></canvas>
            </div>
        </div>
        <div class="dashboard-card card-large">
            <h3>Call Volume (Last 7 Days)</h3>
            <div class=chart-container>
                <canvas id=volumeTrendChart></canvas>
            </div>
        </div>
    </div>
    <div class=bottom-grid>
        <div class=dashboard-card>
            <h3>Top 5 Agents Today</h3>
            <ul id=topAgentsList style="list-style:none; padding:0;"></ul>
        </div>
        <div class=dashboard-card>
            <h3>Top Scenario Today</h3>
            <div id=topScenarioContainer></div>
        </div>
    </div>
</div>
</main>
<footer class=app-footer>
    <p>Â© <span id=currentYear></span> Mohamed Elmenisy - Elevo Core. All rights reserved.</p>
</footer>
</div>
<div id=accessDeniedModal style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 1001;">
    <div style="background: #1f2937; padding: 2rem; border-radius: 12px; text-align: center; color: white;">
        <h3>Access Denied</h3>
        <p>This page is for Admins and Managers only.</p>
        <button id="returnToAppBtn" class="action-button primary-button" style="margin-top: 1rem;">Back to App</button>
    </div>
</div>
<script type=module>
const SUPABASE_URL = "https://aefiigottnlcmjzilqnh.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlZmlpZ290dG5sY21qemlscW5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNzY2MDQsImV4cCI6MjA2Mjc1MjYwNH0.FypB02v3tGMnxXV9ZmZMdMC0oQpREKOJWgHMPxUzwX4";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser = null;
let qualitySummaryChart, volumeTrendChart;

document.addEventListener("DOMContentLoaded", async () => {
    currentUser = await window.elevo.checkAccess(['admin', 'manager']);
    if (!currentUser) return;
    
    document.getElementById("currentYear").textContent = new Date().getFullYear();
    setupEventListeners();
    await loadDashboardData();
});

function setupEventListeners(){
    document.getElementById("logoutButton").addEventListener("click", async () => {
        await supabase.auth.signOut();
        window.location.href = "index.html";
    });
    document.getElementById("refreshDataBtn").addEventListener("click", loadDashboardData);
    document.getElementById("exportReportBtn").addEventListener("click", exportDashboardReport);
}

async function loadDashboardData() {
    await Promise.all([
        loadTicketCounts(),
        loadCallQualitySummary(),
        loadTopAgents(),
        loadTopScenario(),
        loadVolumeTrends(),
    ]);
    window.elevo.showToast('Dashboard data refreshed!', 'success');
}

async function loadTicketCounts() {
    try {
        const now = new Date();
        const tenMinutesAgo = new Date(now.getTime() - 10 * 60 * 1000).toISOString();
        const todayStart = new Date(now.setHours(0, 0, 0, 0)).toISOString();
        
        const { count: liveCount } = await supabase.from('call_sessions').select('*', { count: 'exact', head: true }).is('end_time', null);
        const { count: recentCount } = await supabase.from('call_sessions').select('*', { count: 'exact', head: true }).gte('start_time', tenMinutesAgo);
        const { count: todayCount } = await supabase.from('call_sessions').select('*', { count: 'exact', head: true }).gte('start_time', todayStart);

        document.getElementById("liveTicketsCount").textContent = liveCount ?? 0;
        document.getElementById("recentTicketsCount").textContent = recentCount ?? 0;
        document.getElementById("totalCallsToday").textContent = todayCount ?? 0;
        // Delayed tickets logic can be complex, keeping it simple for now
        document.getElementById("delayedTicketsCount").textContent = 'N/A';

    } catch (error) {
        console.error("Error loading ticket counts:", error);
    }
}
async function loadCallQualitySummary(){
    // ... Function to load and render quality chart
}
async function loadTopAgents(){
    // ... Function to load and display top agents
}
async function loadTopScenario(){
    // ... Function to load and display top scenario
}
async function loadVolumeTrends(){
    // ... Function to load and render volume trends
}

function exportDashboardReport() {
    const headers = ["Metric", "Value"];
    const data = [
        ["Live Tickets", document.getElementById('liveTicketsCount').textContent],
        ["Delayed Tickets", document.getElementById('delayedTicketsCount').textContent],
        ["Recent Tickets (10m)", document.getElementById('recentTicketsCount').textContent],
        ["Total Calls Today", document.getElementById('totalCallsToday').textContent],
    ];

    let csvContent = "data:text/csv;charset=utf-8," 
        + headers.join(",") + "\n"
        + data.map(e => e.join(",")).join("\n");

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `elevo_dashboard_report_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.elevo.showToast('Report exported successfully!', 'success');
}
</script>
</body>
</html>
