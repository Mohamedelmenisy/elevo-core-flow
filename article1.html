<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Introduction to Coaching & Leadership</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <style>
        /* --- Global Styles --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            margin: 0;
            padding: 0;
            line-height: 1.7;
            background-color: #f9f9f9; /* Matched Skills page background */
            color: #333; /* Matched Skills page text color */
        }

        /* --- User Bar Styles --- */
        .user-bar {
            background-color: #34495e;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .user-info svg {
             opacity: 0.8;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
        }

        .user-email {
            font-size: 12px;
            opacity: 0.8;
        }

        .logout-button {
            background-color: #e74c3c; /* Aligned red */
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }

        .logout-button:hover {
            background-color: #c0392b; /* Aligned dark red */
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .logout-button:active { transform: translateY(0); }

        /* --- Navigation Tabs --- */
        .nav-tab {
            background-color: #2c3e50;
            padding: 12px 10px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #556a80 #2c3e50;
        }
        .nav-tab::-webkit-scrollbar { height: 6px; }
        .nav-tab::-webkit-scrollbar-track { background: #2c3e50; }
        .nav-tab::-webkit-scrollbar-thumb { background-color: #556a80; border-radius: 10px; border: 1px solid #2c3e50; }

        .nav-tab a {
            color: white;
            text-decoration: none;
            margin: 0 8px;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.3s, color 0.3s;
            font-size: 14px;
            display: inline-block;
        }

        .nav-tab a:hover,
        .nav-tab a.active {
            background-color: #34495e; /* Aligned hover/active color */
            color: #fff;
        }

        /* --- Main Content Styles --- */
        h1 {
            color: #fff;
            background-color: #e67e22; /* Aligned orange */
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 25px auto;
            max-width: 800px;
            font-size: 26px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .container {
            max-width: 800px;
            margin: 25px auto;
            background: white;
            padding: 30px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1); /* Matched skills shadow */
            border-radius: 8px;
        }

        .quote {
            font-style: italic;
            border-left: 5px solid #e67e22;
            padding: 15px 20px;
            background-color: #fdfaf6; /* Slightly warmer than skills page */
            margin: 25px 0;
            color: #555;
            font-size: 15px;
            border-radius: 0 6px 6px 0; /* Match skills page */
        }

        .image-container {
            text-align: center;
            margin: 30px 0;
        }

        .image-container img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            border: 1px solid #eee;
             box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Match skills page */
        }
        .image-container p {
             font-size: 14px;
             color: #555; /* Match skills page */
             margin-top: 10px;
             font-style: normal; /* Remove italic unless preferred */
        }

        .tip-box, .action-box {
            padding: 20px;
            border-radius: 6px; /* Match skills page */
            margin: 25px 0;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* Match skills page */
            border-left-width: 5px; /* Match skills page */
            border-left-style: solid;
        }
        .tip-box strong, .action-box strong {
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .tip-box {
             background-color: #3498db; /* Aligned blue */
             border-left-color: #2980b9;
        }
        .action-box {
            background-color: #e67e22; /* Aligned orange */
            border-left-color: #d35400;
        }

        .question-box {
            background-color: rgba(230, 126, 34, 0.07); /* Aligned bg */
            padding: 25px;
            border-radius: 6px; /* Aligned radius */
            margin: 25px 0;
            border: 1px solid rgba(230, 126, 34, 0.2); /* Aligned border */
        }
        .question-box h3 {
            margin-bottom: 15px;
            color: #34495e; /* Kept darker blue for heading readability */
            font-size: 18px;
        }
        .question-box h3 .highlight { /* Style for asterisk */
            color: #e74c3c;
            font-weight: bold;
            font-size: 1em; /* Keep same size */
            margin-left: 2px;
        }

        textarea, input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd; /* Aligned border */
            border-radius: 4px; /* Aligned radius */
            margin-top: 8px;
            margin-bottom: 10px;
            resize: vertical;
            min-height: 100px;
            font-size: 15px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
         textarea:focus, input[type="text"]:focus {
             border-color: #e67e22; /* Aligned orange */
             outline: 0;
             box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.2); /* Aligned orange shadow */
         }

        /* Table Styles (if used) - Kept consistent */
        table { width: 100%; border-collapse: collapse; margin: 25px 0; font-size: 14px; background-color: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        table th, table td { border: 1px solid #dee2e6; padding: 12px; text-align: left; }
        table th { background-color: #f8f9fa; font-weight: 600; color: #495057; }
        table tr:nth-child(even) { background-color: #f8f9fa; }

        /* Highlighted Sections - Using same structure as Skills page */
        .highlight-section, .skills-list, .ei-elements, .trust-methods {
             padding: 20px; /* Aligned padding */
             border-radius: 6px; /* Aligned radius */
             margin: 25px 0;
             font-size: 15px;
             border-left-width: 5px;
             border-left-style: solid;
        }
        /* Specific colors match Skills page */
        .highlight-section { background-color: rgba(52, 152, 219, 0.1); border-left-color: #3498db;}
        .skills-list { background-color: rgba(46, 204, 113, 0.1); border-left-color: #2ecc71; }
        .ei-elements { background-color: rgba(155, 89, 182, 0.1); border-left-color: #9b59b6; }
        .trust-methods { background-color: rgba(41, 128, 185, 0.1); border-left-color: #2980b9; }


        .skills-list ul {
            margin-top: 10px;
            margin-left: 25px; /* Aligned indent */
            list-style: disc;
        }
        .skills-list li {
            margin-bottom: 8px;
        }

        /* Buttons */
        .save-button, .delete-button {
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px; /* Aligned radius */
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
            box-shadow: none; /* Removed button shadow for cleaner look like Skills page */
        }
        .save-button { background-color: #27ae60; } /* Aligned green */
        .delete-button { background-color: #e74c3c; margin-left: 10px;} /* Aligned red */

        .save-button:hover { background-color: #2ecc71; transform: translateY(-1px); } /* Aligned green hover */
        .delete-button:hover { background-color: #c0392b; transform: translateY(-1px); } /* Aligned red hover */
        .save-button:active, .delete-button:active { transform: translateY(0); }

        .button-group {
            display: flex;
            align-items: center;
            gap: 8px; /* Match Skills page gap */
            margin-top: 10px;
        }

        .save-status {
            font-size: 13px;
            color: #27ae60; /* Aligned green */
            margin-left: 5px; /* Aligned margin */
            font-weight: 500;
            display: none;
        }
        .save-status.deleted {
             color: #6c757d; /* Kept grey for delete */
        }

        .error-message {
            color: #e74c3c; /* Aligned red */
            font-size: 13px;
            margin-left: 5px; /* Aligned margin */
            font-weight: 500;
            display: none;
        }

        /* Required Field Indication */
        .required-field {
            border: 2px solid #e74c3c !important; /* Aligned red border */
            background-color: #fff2f1 !important; /* Aligned light red background */
            /* Removed pulse animation from Skills page as well for consistency */
            box-shadow: none !important; /* Override focus shadow when erroring */
        }

        /* Navigation Buttons (Bottom) */
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            gap: 15px;
            border-top: 1px solid #eee;
            padding-top: 25px;
        }

        .navigation-buttons a {
            text-decoration: none;
            padding: 12px 20px;
            color: white;
            border-radius: 4px; /* Aligned radius */
            font-weight: 600;
            flex: 1;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: none; /* Removed shadow */
            font-size: 15px;
        }
        /* Specific colors */
        .navigation-buttons a:first-child { /* Back button */
            background-color: #6c757d;
         }
        .navigation-buttons a#nextButton { /* Next button */
             background-color: #e67e22;
        }

        .navigation-buttons a:hover {
            transform: translateY(-1px);
             filter: brightness(110%); /* Subtle hover effect */
        }
         .navigation-buttons a:active {
             transform: translateY(0);
              filter: brightness(100%);
         }


        /* Floating Warning Message */
        .floating-warning {
            background-color: #fff8e1; /* Aligned yellow */
            border-left: 5px solid #ffc107; /* Aligned yellow */
            padding: 15px 25px;
            color: #333; /* Aligned text color */
            display: none;
            position: fixed;
            top: 75px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            border-radius: 6px; /* Aligned radius */
            box-shadow: 0 3px 10px rgba(0,0,0,0.2); /* Aligned shadow */
            animation: slideDownFadeIn 0.4s ease-out;
            font-weight: 500;
            max-width: 90%;
            width: auto; /* Allow content width */
            min-width: 300px; /* Minimum width */
            text-align: center;
        }

        @keyframes slideDownFadeIn {
            from { opacity: 0; top: 50px; }
            to { opacity: 1; top: 75px; }
        }

        @keyframes fadeOutUp {
            from { opacity: 1; top: 75px;}
            to { opacity: 0; top: 50px;}
        }

        /* Highlight class for text */
        .highlight {
            color: #e67e22; /* Primary orange for highlights */
            font-weight: 600; /* Slightly bolder */
        }

        /* Accessibility Helper */
        .sr-only {
          position: absolute;
          width: 1px;
          height: 1px;
          padding: 0;
          margin: -1px;
          overflow: hidden;
          clip: rect(0, 0, 0, 0);
          white-space: nowrap;
          border-width: 0;
        }

        /* --- Responsive Adjustments --- */
        @media (max-width: 768px) {
            h1 {
                font-size: 22px;
                padding: 15px;
                margin: 20px 15px;
            }
            .container {
                padding: 20px;
                margin: 20px 15px;
            }
             .user-bar { padding: 10px 15px; font-size: 13px; }
            .user-name { font-size: 13px; }
            .user-email { font-size: 11px; }
            .logout-button { padding: 7px 12px; font-size: 12px; }

            .nav-tab { padding: 10px 5px; }
            .nav-tab a { margin: 0 5px; padding: 7px 10px; font-size: 13px;}

            .quote, .tip-box, .action-box, .question-box, .highlight-section, .skills-list {
                 padding: 15px;
                 margin: 20px 0;
             }
             .question-box h3 { font-size: 16px;}
             textarea, input[type="text"] { font-size: 14px; min-height: 80px;}

             .navigation-buttons {
                 flex-direction: column;
                 padding-top: 20px;
                 margin-top: 30px;
             }
             .navigation-buttons a { font-size: 14px; padding: 12px 15px;}

             .floating-warning {
                 padding: 12px 20px;
                 font-size: 14px;
                 top: 65px;
                 width: calc(100% - 30px);
                 max-width: 400px;
             }
             @keyframes slideDownFadeIn { from { opacity: 0; top: 45px; } to { opacity: 1; top: 65px; } }
             @keyframes fadeOutUp { from { opacity: 1; top: 65px;} to { opacity: 0; top: 45px;} }
        }
    </style>
</head>
<body>
    <!-- User Info Bar -->
    <header class="user-bar">
        <div class="user-info">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <div class="user-details">
                <span class="user-name" id="userName">Welcome back</span>
                <span class="user-email" id="userEmail">user@example.com</span>
            </div>
        </div>
        <button class="logout-button" onclick="logout()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            Logout
        </button>
    </header>

    <!-- Navigation Tabs -->
    <nav class="nav-tab">
        <a href="index.html">Home</a>
        <a href="article1.html" class="active">Article 1</a> <!-- Mark as active -->
        <a href="coaching-skills.html">Coaching Skills</a>
        <a href="coaching-individuals.html">Coaching Individuals</a>
        <a href="coaching-team.html">Team Coaching</a>
        <a href="coaching-yourself.html">Self Coaching</a>
        <a href="action-plan.html">Action Plan</a>
    </nav>

    <main>
        <h1>Introduction to Coaching & Leadership</h1>

        <div class="floating-warning" id="warningMessage">
            <strong>Action Required:</strong> Please complete all required questions before proceeding.
        </div>

        <div class="container">
            <div class="highlight-section"> <!-- Using style from Skills page -->
                <p>Coaching skills are a valuable asset for any manager. A study by Deloitte found that leaders who frequently coached their teams improved their business results by <span class="highlight">21 percent</span>. So, it's no surprise that an increasing number of workplaces consider coaching to be a worthwhile investment. In a survey by the Conference Board Council, 61 percent of the participating organizations used some form of internal coaching.</p>
            </div>

            <div class="quote">
                <p>"I haven't got time for coaching! And who needs it, anyway?"</p>
                <p>If this is your first reaction to what might feel like just another burdensome task, read on. Coaching is an investment that pays dividends.</p>
            </div>

            <div class="image-container">
                 <img src="https://images.unsplash.com/photo-1556761175-5973dc0f32e7?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1032&q=80"
                      alt="Diverse team members collaborating around a laptop in a modern office setting, representing coaching and teamwork."
                      onerror="this.onerror=null; this.src='https://via.placeholder.com/800x450/ffa726/ffffff?text=Coaching+Illustration';">
                 <p>Effective coaching fosters collaboration, improves performance, and supports individual growth.</p>
            </div>

            <h2>The Impact of Coaching</h2>
            <p>One reason for this increase is that people who receive coaching can reap considerable benefits. Research by PwC found that, of the participants who had received coaching:</p>

            <ul style="list-style: disc; margin-left: 25px; margin-bottom: 15px;"> <!-- Added list styling -->
                <li><strong>80%</strong> had increased self-confidence.</li>
                <li><strong>73%</strong> had improved relationships.</li>
                <li><strong>72%</strong> had improved communication skills.</li>
                <li><strong>67%</strong> reported a better work-life balance.</li>
            </ul>

            <p>Numbers like these will likely appeal to any leader, in any industry! But, despite the evidence that effective coaching can make a difference, most managers have very little training in how to do it. The good news is that <span class="highlight">coaching is a skill that you can learn</span>.</p>

            <h2 style="color:#e67e22;">What Will Coaching Do for Me and My Team?</h2> <!-- Added highlight color to heading -->

            <p>We'll tell you right now, coaching isn't always easy – at least, not if you want to do it well. However, it can be a rewarding and inspiring experience, especially when you see your team members develop and succeed. When you coach effectively, you may find that your job satisfaction increases, too, and you have a deeper sense of purpose and meaning at work. What's more, you'll likely strengthen your relationship with your team, building trust and rapport.</p>

            <div class="skills-list"> <!-- Using style from Skills page -->
                <p><strong>This course will guide you through the essential coaching skills. You will learn:</strong></p>
                <ul>
                    <li>How to develop core coaching competencies like active listening, powerful questioning, emotional intelligence, and building trust.</li>
                    <li>Effective frameworks and techniques for coaching individual team members towards their goals.</li>
                    <li>Strategies for fostering a coaching culture and coaching your team collectively.</li>
                    <li>Techniques for applying coaching principles to your own development (self-coaching).</li>
                    <li>How to create a practical action plan to implement your learnings.</li>
                </ul>
            </div>

            <p>By working through the exercises in each section, you'll gain a deeper understanding of the topic and reinforce what you've learned. But first, let's address those time pressures. Consider how a small investment now in effective, targeted coaching can save you and your team large amounts of time and effort in the future. Purpose and enthusiasm will grow, errors will decrease, and loyalty and collaboration will build. And you'll likely find yourself dealing with less conflict, and delegating more effectively.</p>

            <div class="tip-box"> <!-- Using style from Skills page -->
                <strong>TIP: Assess Your Skills</strong><br>
                For more insight into your current coaching skills, and for advice and guidance on how to develop your people effectively, consider taking an online assessment or reflecting on past experiences where you've guided others. (Placeholder for potential link/quiz)
            </div>

            <div class="action-box"> <!-- Using style from Skills page -->
                <strong>ACTION: Prioritize Your Time</strong><br>
                Effective coaching requires dedicated time. Explore time management techniques (like time blocking or prioritization matrices) to carve out space for these important conversations. Protect this time to focus on developing your team.
            </div>

            <!-- Interactive Questions -->
            <h2 style="margin-top: 40px;">Reflection Questions</h2>

            <!-- Question 1 -->
            <div class="question-box">
                <h3>1. In your opinion, what are the top 3 qualities or behaviors of a great coach?<span class="highlight">*</span></h3>
                <label for="q1" class="sr-only">Answer for question 1</label>
                <textarea id="q1" placeholder="e.g., Active listening, empathy, providing constructive feedback..." class="required-answer" data-question="q1" aria-describedby="error-q1"></textarea>
                <div class="button-group">
                    <button class="save-button" onclick="saveAnswer('q1', 'save-status-q1', 'error-q1')">Save</button>
                    <button class="delete-button" onclick="deleteAnswer('q1', 'save-status-q1', 'error-q1')">Delete</button>
                    <span class="save-status" id="save-status-q1"></span>
                    <span class="error-message" id="error-q1"></span>
                </div>
            </div>

            <!-- Question 2 -->
            <div class="question-box">
                <h3>2. Reflecting on the qualities above, which coaching skills do you believe you already possess or use effectively?<span class="highlight">*</span></h3>
                 <label for="q2" class="sr-only">Answer for question 2</label>
                <textarea id="q2" placeholder="Be specific, e.g., 'I am good at giving clear instructions' or 'I try to listen without interrupting'..." class="required-answer" data-question="q2" aria-describedby="error-q2"></textarea>
                <div class="button-group">
                    <button class="save-button" onclick="saveAnswer('q2', 'save-status-q2', 'error-q2')">Save</button>
                    <button class="delete-button" onclick="deleteAnswer('q2', 'save-status-q2', 'error-q2')">Delete</button>
                    <span class="save-status" id="save-status-q2"></span>
                    <span class="error-message" id="error-q2"></span>
                </div>
            </div>

            <!-- Question 3 -->
            <div class="question-box">
                <h3>3. Which 1-2 coaching skills mentioned in the course outline (or from your list in Q1) would you most like to develop further?<span class="highlight">*</span></h3>
                 <label for="q3" class="sr-only">Answer for question 3</label>
                <textarea id="q3" placeholder="e.g., Asking more open-ended questions, building trust faster..." class="required-answer" data-question="q3" aria-describedby="error-q3"></textarea>
                <div class="button-group">
                    <button class="save-button" onclick="saveAnswer('q3', 'save-status-q3', 'error-q3')">Save</button>
                    <button class="delete-button" onclick="deleteAnswer('q3', 'save-status-q3', 'error-q3')">Delete</button>
                    <span class="save-status" id="save-status-q3"></span>
                    <span class="error-message" id="error-q3"></span>
                </div>
            </div>
            <p style="font-size: 13px; color: #6c757d; margin-top: 5px;"><span class="highlight" style="color:#e74c3c">*</span> Required field to proceed</p>


            <!-- Navigation Buttons -->
            <div class="navigation-buttons">
                <a href="index.html" class="nav-button">← Back to Home</a>
                <a href="coaching-skills.html" class="nav-button" id="nextButton">Next: Core Coaching Skills →</a>
            </div>
        </div><!-- /.container -->
    </main>

    <script>
        // --- Configuration ---
        const formspreeEndpoint = 'https://formspree.io/f/xzzeqvea'; // Your Formspree Endpoint URL
        const localStorageKeyPrefix = 'courseAnswers_'; // Prefix for keys
        const currentPageKey = 'article1'; // Specific key part for this page
        const localStorageKey = `${localStorageKeyPrefix}${currentPageKey}`; // Full key: courseAnswers_article1
        const currentUserKey = 'currentUser'; // Key for storing the whole user object

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            const currentUser = getCurrentUser();
            if (!currentUser || !currentUser.email) {
                console.error("User not logged in or email missing. Redirecting...");
                window.location.href = `login.html?redirect=${encodeURIComponent(window.location.pathname)}`;
                return;
            }
            displayUserInfo(currentUser);
            loadUserAnswers(currentUser.email);
            setupEventListeners(currentUser.email);
            highlightActiveNav();
        });

        // --- User Info & Authentication ---
        function getCurrentUser() {
            try {
                const userDataString = localStorage.getItem(currentUserKey);
                return userDataString ? JSON.parse(userDataString) : null;
            } catch (error) {
                console.error("Error parsing user data:", error);
                return null;
            }
        }

        function displayUserInfo(user) {
            document.getElementById('userName').textContent = `Welcome, ${user.name || 'User'}`;
            document.getElementById('userEmail').textContent = user.email;
        }

        function logout() {
            localStorage.removeItem('loggedIn');
            localStorage.removeItem(currentUserKey);
            window.location.href = 'login.html';
        }

        function highlightActiveNav() {
             const currentPath = window.location.pathname.split('/').pop() || 'index.html';
             const navLinks = document.querySelectorAll('.nav-tab a');
             navLinks.forEach(link => {
                 if (link.getAttribute('href') === currentPath) {
                     link.classList.add('active');
                 } else {
                     link.classList.remove('active');
                 }
             });
         }

        // --- Answer Handling (Local Storage) ---
        function loadUserAnswers(userEmail) {
             if (!userEmail) return;
             let allAnswers = {};
             try {
                 const storedData = localStorage.getItem(localStorageKey);
                 if (storedData) {
                     allAnswers = JSON.parse(storedData) || {};
                 }
             } catch(e) {
                 console.error("Error parsing stored answers:", e);
                 // Optional: Clear corrupted data?
                 // localStorage.removeItem(localStorageKey);
             }
             const userAnswers = allAnswers[userEmail] || {};

             document.querySelectorAll('.required-answer').forEach(field => {
                 const questionId = field.getAttribute('data-question');
                 const savedAnswer = userAnswers[questionId];
                 const statusId = `save-status-${questionId}`;
                 const errorId = `error-${questionId}`;

                 if (savedAnswer !== undefined) {
                     field.value = savedAnswer;
                     field.classList.remove('required-field');
                     hideError(errorId); // Hide any previous error

                     if (savedAnswer.trim() !== '') {
                          showSaveStatus(statusId, '✓ Saved'); // Show saved only if not empty
                     } else {
                         hideSaveStatus(statusId); // Hide status if saved answer is empty
                     }
                 } else {
                     field.value = '';
                     hideSaveStatus(statusId);
                     hideError(errorId);
                 }
             });
        }

        function saveAnswerToStorage(userEmail, questionId, answer) {
            if (!userEmail) return false;
             let allAnswers = {};
             try {
                 const storedData = localStorage.getItem(localStorageKey);
                 if (storedData) {
                     allAnswers = JSON.parse(storedData) || {};
                 }
             } catch(e) {
                  console.error("Error parsing stored answers before saving:", e);
                  alert("Could not load existing answers. Saving this answer might overwrite others if storage is corrupted.");
                  allAnswers = {}; // Reset if corrupted to avoid further issues
             }

            if (!allAnswers[userEmail]) {
                allAnswers[userEmail] = {};
            }
            allAnswers[userEmail][questionId] = answer;
            try {
                localStorage.setItem(localStorageKey, JSON.stringify(allAnswers));
                return true;
            } catch (error) {
                 console.error("Error saving to localStorage:", error);
                 alert("Could not save answer. Browser storage might be full.");
                 return false;
            }
        }

        function deleteAnswerFromStorage(userEmail, questionId) {
            if (!userEmail) return false;
             let allAnswers = {};
             try {
                 const storedData = localStorage.getItem(localStorageKey);
                 if (storedData) {
                     allAnswers = JSON.parse(storedData) || {};
                 } else {
                     return false; // Nothing to delete if key doesn't exist
                 }
             } catch(e) {
                 console.error("Error parsing stored answers before deleting:", e);
                 alert("Could not process deletion due to a data error in storage.");
                 return false;
             }

             let updated = false;
             if (allAnswers[userEmail] && allAnswers[userEmail][questionId] !== undefined) {
                 delete allAnswers[userEmail][questionId];
                 updated = true;
                 if (Object.keys(allAnswers[userEmail]).length === 0) {
                     delete allAnswers[userEmail];
                 }
             }

             if(updated) {
                try {
                    localStorage.setItem(localStorageKey, JSON.stringify(allAnswers));
                    return true;
                } catch (error) {
                    console.error("Error saving to localStorage after delete:", error);
                    alert("Could not update storage after deleting answer.");
                    // Data might be in inconsistent state here
                    return false;
                }
             }
             return false; // Indicate nothing was actually deleted
        }

        // --- Event Listeners Setup ---
        function setupEventListeners(userEmail) {
             const nextButton = document.getElementById('nextButton');
             if(nextButton) {
                 nextButton.addEventListener('click', function(e) {
                    if (!validateAllAnswers(true)) {
                        e.preventDefault();
                        showWarningMessage();
                    }
                 });
             }

            // Add input listeners to clear validation errors dynamically
             document.querySelectorAll('.required-answer').forEach(field => {
                 field.addEventListener('input', () => {
                     if (field.value.trim() !== '') {
                          field.classList.remove('required-field');
                          hideError(`error-${field.getAttribute('data-question')}`);
                     }
                 });
             });
        }

        // --- UI Feedback & Validation ---
        function validateAllAnswers(showErrors = false) {
            let allAnswered = true;
            let firstEmptyField = null; // To focus later

            document.querySelectorAll('.required-answer').forEach(field => {
                const questionId = field.getAttribute('data-question');
                const errorId = `error-${questionId}`;
                if (field.value.trim() === '') {
                    allAnswered = false;
                    if (!firstEmptyField) {
                         firstEmptyField = field; // Find the *first* empty field
                    }
                    if (showErrors) {
                        field.classList.add('required-field');
                        showError(errorId, field); // Show error message immediately
                    }
                } else {
                    // If field is filled, remove potential error state
                    field.classList.remove('required-field');
                    hideError(errorId);
                }
            });

            // Scroll to and focus the first empty field if validation fails and errors are shown
            if (!allAnswered && showErrors && firstEmptyField) {
                 firstEmptyField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                 setTimeout(() => firstEmptyField.focus({ preventScroll: true }), 400); // Delay focus slightly
            }

            return allAnswered;
        }


        function showWarningMessage() {
            const warningElement = document.getElementById('warningMessage');
            // If already visible, reset animation first
            warningElement.style.animation = 'none';
            // Trigger reflow to restart animation
            void warningElement.offsetWidth;

            warningElement.style.display = 'block';
            warningElement.style.animation = 'slideDownFadeIn 0.4s ease-out';

            // Auto-hide
            clearTimeout(warningElement.timer); // Clear previous timeout if any
            warningElement.timer = setTimeout(() => {
                warningElement.style.animation = 'fadeOutUp 0.5s ease-out forwards';
                 setTimeout(() => {
                      if (warningElement.style.animationName === 'fadeOutUp') { // Check if it wasn't shown again
                           warningElement.style.display = 'none';
                           warningElement.style.animation = '';
                      }
                 }, 500);
            }, 4000);
        }

        function showSaveStatus(statusId, message = '✓ Saved') {
             const statusElement = document.getElementById(statusId);
             if (!statusElement) return;
             statusElement.textContent = message;
             statusElement.classList.remove('deleted');
             statusElement.style.color = '#27ae60'; // Use aligned green
             if (message.includes('deleted')) {
                 statusElement.classList.add('deleted');
                 statusElement.style.color = '#6c757d'; // Use grey for deleted
             }
             statusElement.style.display = 'inline-block';
             clearTimeout(statusElement.timer);
             statusElement.timer = setTimeout(() => {
                 statusElement.style.display = 'none';
             }, 3000);
        }
         function hideSaveStatus(statusId) { // Added helper to hide status
             const statusElement = document.getElementById(statusId);
             if (statusElement) {
                 statusElement.style.display = 'none';
                 clearTimeout(statusElement.timer);
             }
         }


        function showError(errorId, field, message = 'This field is required.') {
             const errorElement = document.getElementById(errorId);
             if (!errorElement) return;
             errorElement.textContent = message;
             errorElement.style.color = '#e74c3c'; // Use aligned red
             errorElement.style.display = 'inline-block';
             // Field class is added in validateAllAnswers where needed
        }

        function hideError(errorId) {
             const errorElement = document.getElementById(errorId);
              if (!errorElement) return;
             errorElement.style.display = 'none';
             // Field class removal happens in validation or input listener
        }

        // --- Actions (Save, Delete) triggered by buttons ---
        function saveAnswer(questionId, statusId, errorId) {
            const currentUser = getCurrentUser();
            if (!currentUser || !currentUser.email) {
                alert('Session expired. Please login again.');
                window.location.href = 'login.html';
                return;
            }

            const field = document.querySelector(`.required-answer[data-question="${questionId}"]`);
            const answer = field.value; // Get raw value to save
            const trimmedAnswer = answer.trim(); // Use trimmed for validation

            // Clear previous messages for this specific field
            hideSaveStatus(statusId);
            hideError(errorId);
            field.classList.remove('required-field'); // Remove error style initially

            // --- Validate: Must not be empty ---
            if (!trimmedAnswer) {
                field.classList.add('required-field');
                showError(errorId, field); // Show specific error
                return; // Stop save
            }

            // --- Attempt to save to Local Storage ---
            if (!saveAnswerToStorage(currentUser.email, questionId, answer)) {
                 return; // Stop if storage failed
            }

            // --- Submit to Formspree ---
            submitToFormspree(currentUser.email, questionId, answer);

            // --- Show confirmation ---
            showSaveStatus(statusId);
        }


        function deleteAnswer(questionId, statusId, errorId) {
            const currentUser = getCurrentUser();
             if (!currentUser || !currentUser.email) {
                alert('Session expired. Please login again.');
                window.location.href = 'login.html';
                return;
            }

            const field = document.querySelector(`.required-answer[data-question="${questionId}"]`);

            // Clear UI feedback for this field
            hideSaveStatus(statusId);
            hideError(errorId);
            field.classList.remove('required-field');

            // Clear the field visually
            field.value = '';

            // Attempt to remove from Local Storage
            if(deleteAnswerFromStorage(currentUser.email, questionId)) {
                 showSaveStatus(statusId, 'Answer deleted');
            } else {
                 console.log("Answer not found in storage or error during deletion.");
                 // Optionally show a message like "Nothing to delete"
                 // showSaveStatus(statusId, 'Already empty');
            }
        }

        // --- Formspree Submission ---
        function submitToFormspree(userEmail, questionId, answer) {
             if (!formspreeEndpoint) { console.warn("Formspree endpoint not configured."); return; }
             if (!userEmail) { console.warn("No user email for Formspree."); return; }

            const formData = new FormData();
            formData.append('email', userEmail);
            formData.append('page_key', currentPageKey);
            formData.append('question_id', questionId);
            formData.append('answer_text', answer);

            const currentUser = getCurrentUser();
            if (currentUser && currentUser.name) {
                 formData.append('user_name', currentUser.name);
            }
             // Add Question Text for context
            const fieldElement = document.querySelector(`[data-question="${questionId}"]`);
             if (fieldElement) {
                 const questionBox = fieldElement.closest('.question-box');
                 if (questionBox) {
                     const h3 = questionBox.querySelector('h3');
                     if (h3) formData.append('question_text', h3.textContent.replace('*','').trim());
                 }
             }


            fetch(formspreeEndpoint, {
                method: 'POST',
                body: formData,
                headers: { 'Accept': 'application/json' }
            })
            .then(response => {
                if (response.ok) {
                    console.log(`Answer for ${questionId} (Page: ${currentPageKey}) submitted to Formspree.`);
                } else {
                    response.json().then(data => {
                        console.error(`Formspree error (Page: ${currentPageKey}, Q: ${questionId}):`, data.errors ? data.errors.map(e => e.message).join(', ') : `Status ${response.status}`);
                    }).catch(() => {
                        console.error(`Non-OK/Non-JSON response from Formspree (Page: ${currentPageKey}, Q: ${questionId}): Status ${response.status}`);
                    });
                }
            })
            .catch(error => {
                console.error(`Network error submitting to Formspree (Page: ${currentPageKey}, Q: ${questionId}):`, error);
            });
        }

    </script>

</body>
</html>
