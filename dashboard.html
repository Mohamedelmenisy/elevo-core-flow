<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Coaching & Leadership</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12; /* Changed from e67e22 for better visibility */
            --danger-color: #e74c3c;
            --light-bg: #f8fafc;
            --text-color: #333;
            --text-muted: #7f8c8d;
            --border-color: #ecf0f1;
            --card-bg: #ffffff;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 5px 15px rgba(0,0,0,0.07);
            --border-radius: 8px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--light-bg); margin: 0; padding: 0; line-height: 1.6; color: var(--text-color); display: flex; flex-direction: column; min-height: 100vh; }
        main { flex-grow: 1; display: flex; justify-content: center; align-items: flex-start; flex-direction: column; width: 100%; max-width: 1000px; margin: 20px auto; padding: 25px; } /* Reduced top margin */

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.6s ease-out forwards; opacity: 0; /* Start hidden */ }

        @keyframes progressAnimation {
            0% { background-position: 100% 0; }
            100% { background-position: -100% 0; }
        }

        /* --- Header & User Bar --- */
        .header { background-color: var(--primary-color); color: white; padding: 15px 0; text-align: center; font-size: 24px; box-shadow: var(--shadow-sm); width: 100%; }
        .user-bar { background-color: var(--secondary-color); padding: 10px 30px; display: flex; justify-content: space-between; align-items: center; color: white; font-size: 15px; width: 100%; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-info svg { opacity: 0.8; }
        .user-details-bar { display: flex; flex-direction: column; }
        .user-name-bar { font-weight: 600; font-size: 15px; }
        .user-email-bar { font-size: 13px; opacity: 0.8; }
        .logout-button { background-color: var(--danger-color); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s; display: flex; align-items: center; gap: 6px; }
        .logout-button:hover { background-color: #c0392b; transform: translateY(-1px); }
        .logout-button:active { transform: translateY(0); }

        /* --- Dashboard Container & User Details --- */
        /* Wrapper for animation */
        #dashboard-content-wrapper { width: 100%; }
        .dashboard-container { background: var(--card-bg); padding: 35px 45px; box-shadow: var(--shadow-md); border-radius: var(--border-radius); width: 100%; margin-bottom: 30px; }
        .dashboard-container h2 { color: var(--primary-color); margin-bottom: 15px; font-size: 26px; border-bottom: 2px solid var(--border-color); padding-bottom: 12px; }
        .dashboard-user-details { background-color: #f0f4f8; border: 1px solid #dfe6ed; padding: 15px 20px; border-radius: var(--border-radius); margin-bottom: 30px; display: flex; align-items: center; gap: 15px; border-left: 4px solid var(--accent-color); }
        .dashboard-user-details svg { color: var(--accent-color); flex-shrink: 0;}
        .dashboard-user-info { font-size: 16px; color: var(--primary-color); }
        .dashboard-user-info strong { font-weight: 600; }

        /* --- Course Sections --- */
        .course-sections-container { margin-top: 20px; }
        .course-sections h3 { color: var(--secondary-color); margin-top: 30px; margin-bottom: 20px; font-size: 22px; }
        .course-section { background-color: var(--card-bg); border: 1px solid var(--border-color); padding: 18px 25px; margin-bottom: 18px; border-radius: var(--border-radius); display: flex; justify-content: space-between; align-items: center; transition: box-shadow 0.3s ease, transform 0.3s ease; flex-wrap: wrap; gap: 15px; }
        .course-section:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.08); transform: translateY(-3px); }
        .section-title { font-size: 17px; font-weight: 500; color: var(--secondary-color); flex-grow: 1; margin-right: 15px; }
        .section-progress { display: flex; align-items: center; gap: 15px; flex-shrink: 0; flex-basis: 290px; }
        .progress-bar-container { width: 160px; height: 12px; background-color: #e9ecef; /* Slightly darker */ border-radius: 6px; overflow: hidden; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); }
        .progress-bar {
            height: 100%;
            width: 0%;
            border-radius: 6px;
            transition: width 0.8s cubic-bezier(0.25, 0.1, 0.25, 1); /* Smoother transition */
            background: linear-gradient(135deg, var(--success-color) 25%, var(--accent-color) 50%, var(--success-color) 75%); /* Angled gradient */
            background-size: 200% 100%; /* Double width for animation */
            animation: progressAnimation 2s linear infinite; /* Animated background */
        }
        .progress-text { font-size: 14px; color: var(--text-muted); min-width: 85px; text-align: right; font-weight: 500; }
        .section-link { background-color: var(--accent-color); color: white; padding: 7px 14px; border-radius: 5px; text-decoration: none; font-size: 14px; transition: background-color 0.3s; white-space: nowrap; }
        .section-link:hover { background-color: #2980b9; }

        /* --- Assessment Sections --- */
        .assessment-section { background: #f0f4f8; padding: 25px 30px; border-radius: var(--border-radius); margin-bottom: 30px; border: 1px solid #dfe6ed; }
        .assessment-section h3 { color: var(--primary-color); font-size: 20px; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
        .assessment-status { font-size: 13px; font-weight: 500; padding: 4px 10px; border-radius: 15px; background-color: var(--grey-medium); color: white; flex-shrink: 0; }
        .assessment-status.completed { background-color: var(--success-color); }
        .assessment-status.in-progress { background-color: var(--warning-color); }
        .assessment-section p { margin-bottom: 20px; color: var(--secondary-color); font-size: 15px; }
        .assessment-note { font-size: 14px; color: var(--text-muted); background-color: #fff; border: 1px dashed var(--border-color); padding: 10px 15px; border-radius: 6px; margin-bottom: 20px; text-align: left; }
        .assessment-content { /* Was hidden, now shown by default after Start */ margin-top: 15px; }
        .assessment-question { margin-bottom: 20px; text-align: left;}
        .assessment-question label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--secondary-color); }
        .assessment-question textarea, .assessment-question input[type="number"] {
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; background-color: #fff;
            min-height: 45px; font-size: 15px; transition: border-color 0.3s, box-shadow 0.3s;
        }
         .assessment-question textarea { min-height: 80px; resize: vertical;}
         .assessment-question textarea:focus, .assessment-question input[type="number"]:focus {
             border-color: var(--accent-color); outline: none; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
         }
        .assessment-section button.start-button { background: var(--accent-color); } /* Blue start button */
        .assessment-section button.start-button:hover { background: #2980b9; }
        .assessment-section button.submit-button { background: var(--success-color); } /* Green submit button */
        .assessment-section button.submit-button:hover { background-color: #219653; }
        .assessment-section button { color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: background-color 0.3s; font-size: 15px; margin-top: 10px; }
        .validation-error { color: var(--danger-color); font-size: 13px; font-weight: 500; margin-top: 5px; display: block; /* Changed to block */ text-align: left; }


        /* --- Admin Section Styles --- */
        #adminSection { background-color: #e8f6fd; border: 1px solid #bde0fe; border-radius: var(--border-radius); padding: 30px 40px; margin-top: 20px; width: 100%; }
        #adminSection h3 { color: #1c5a8d; margin-bottom: 20px; font-size: 22px; border-bottom: 2px solid #bde0fe; padding-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .admin-note { font-size: 14px; color: #555; background-color: #fff9e0; border: 1px solid #ffeccc; padding: 10px; border-radius: 5px; margin-bottom: 20px; }
        .admin-user-table { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: fixed; }
        .admin-user-table th, .admin-user-table td { border: 1px solid #d0e4f5; padding: 11px 13px; text-align: left; font-size: 14px; word-wrap: break-word; vertical-align: middle; }
        .admin-user-table th { background-color: #d6ebfa; color: #1c5a8d; font-weight: 600; }
        .admin-user-table td { background-color: #f8fcff; }
        .admin-user-table th:nth-child(1) { width: 30%; } /* Section */
        .admin-user-table th:nth-child(2) { width: 15%; text-align: center;} /* Progress */
        .admin-user-table th:nth-child(3) { width: 15%; text-align: center;} /* Pre Score */
        .admin-user-table th:nth-child(4) { width: 15%; text-align: center;} /* Post Score */
        .admin-user-table th:nth-child(5) { width: 25%; } /* Status */
        .admin-user-table td:nth-child(2), .admin-user-table td:nth-child(3), .admin-user-table td:nth-child(4) { text-align: center; font-weight: 500; }
        .admin-user-table td:nth-child(3), .admin-user-table td:nth-child(4) { color: var(--text-muted); }

        /* Loading Message */
        #loadingMessage { text-align: center; padding: 50px; font-size: 18px; color: #555; }
        /* Footer */
        .footer { text-align: center; padding: 20px 30px; background: var(--primary-color); color: rgba(255, 255, 255, 0.8); margin-top: auto; font-size: 14px; width: 100%; }

         /* Responsive Adjustments */
         @media (max-width: 768px) { main { padding: 15px; } .dashboard-container, #adminSection, .assessment-section { padding: 25px; } .dashboard-container h2 { font-size: 22px; } .course-section { flex-direction: column; align-items: flex-start; } .section-title { margin-right: 0; margin-bottom: 10px; } .section-progress { flex-basis: auto; width: 100%; justify-content: space-between; } .progress-bar-container { flex-grow: 1; margin-right: 10px; } .admin-user-table th, .admin-user-table td { font-size: 13px; padding: 8px 10px; } .assessment-section h3 { flex-direction: column; align-items: flex-start; gap: 5px;} }
         @media (max-width: 480px) { .dashboard-user-details { flex-direction: column; align-items: flex-start; text-align: center; } .dashboard-user-details svg { margin-bottom: 5px; } .admin-user-table { display: block; overflow-x: auto; } }

    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">Coaching & Leadership Dashboard</header>

    <!-- User Bar -->
    <div class="user-bar"> <div class="user-info"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path> <circle cx="12" cy="7" r="4"></circle> </svg> <div class="user-details-bar"> <span class="user-name-bar" id="userNameBar">Loading...</span> <span class="user-email-bar" id="userEmailBar"></span> </div> </div> <button class="logout-button" onclick="logout()"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path> <polyline points="16 17 21 12 16 7"></polyline> <line x1="21" y1="12" x2="9" y2="12"></line> </svg> Logout </button> </div>

    <!-- Main Content Area -->
    <main>
        <div id="loadingMessage" style="width: 100%; text-align: center;">Loading Dashboard...</div>

        <!-- User Dashboard Container -->
        <div id="dashboard-content-wrapper"> <!-- Wrapper for animation -->
            <div class="dashboard-container" id="userDashboardContent" style="display: none;">
                <h2 id="welcomeMessage">Welcome!</h2>
                <div class="dashboard-user-details">
                     <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                     <div class="dashboard-user-info"> Logged in as: <strong id="dashboardUserName">Name</strong> (<span id="dashboardUserEmail">email</span>) </div>
                </div>

                 <!-- Pre-Course Assessment Section -->
                 <div class="assessment-section" id="preAssessmentSection" style="display: none;">
                    <h3>Pre-Course Assessment <span class="assessment-status" id="preAssessmentStatus">Not Started</span></h3>
                    <p class="assessment-note">Your answers help us personalize your experience. Please answer honestly in your own words.</p>
                    <button class="start-button" onclick="startPreAssessment()">Start Assessment</button>
                    <div class="assessment-content" id="preAssessmentContent"> <!-- Content initially hidden -->
                        <form id="preAssessmentForm">
                            <div class="assessment-question">
                                <label for="preQ1">1. What does coaching mean to you? (Minimum 20 words)<span style="color:var(--danger-color)">*</span></label>
                                <textarea id="preQ1" placeholder="Describe your understanding of coaching..." data-assessment-question="preQ1" data-min-words="20" required></textarea>
                                <span class="validation-error" id="error-preQ1"></span>
                            </div>
                            <div class="assessment-question">
                                <label for="preQ2">2. How do you differentiate leadership from management?<span style="color:var(--danger-color)">*</span></label>
                                <textarea id="preQ2" placeholder="Explain the key differences in your view..." data-assessment-question="preQ2" required></textarea>
                                <span class="validation-error" id="error-preQ2"></span>
                            </div>
                            <div class="assessment-question">
                                <label for="preQ3">3. What are your expectations from this course?<span style="color:var(--danger-color)">*</span></label>
                                <textarea id="preQ3" placeholder="What do you hope to learn or achieve?" data-assessment-question="preQ3" required></textarea>
                                <span class="validation-error" id="error-preQ3"></span>
                            </div>
                            <div class="assessment-question">
                                <label for="preQ4">4. Rate your coaching confidence (1-5, 5=Very Confident) & explain.<span style="color:var(--danger-color)">*</span></label>
                                <input type="number" id="preQ4-rating" min="1" max="5" placeholder="Rating (1-5)" style="width:120px; margin-bottom: 5px;" data-assessment-question="preQ4_rating" required>
                                <textarea id="preQ4-explanation" placeholder="Briefly explain your rating..." data-assessment-question="preQ4_explanation" required></textarea>
                                <span class="validation-error" id="error-preQ4"></span>
                            </div>
                            <button type="button" class="submit-button" onclick="submitPreAssessment()">Submit Pre-Assessment</button>
                        </form>
                    </div>
                </div>

                <!-- Course Sections Area (Conditionally Displayed) -->
                <div class="course-sections-container" id="courseSectionsContainer" style="display: none;">
                    <div class="course-sections"> <h3>Your Course Progress</h3> <div id="courseSectionsList"> <!-- Sections loaded here --> </div> </div>
                </div>

                 <!-- Post-Course Evaluation Section -->
                 <div class="assessment-section" id="postAssessmentSection" style="display: none;">
                     <h3>Post-Course Evaluation <span class="assessment-status" id="postAssessmentStatus">Not Started</span></h3>
                     <p>Congratulations on reaching this milestone! Please take a few moments to reflect on your learning journey.</p>
                     <button class="start-button" onclick="startPostAssessment()">Start Evaluation</button>
                     <div class="assessment-content" id="postAssessmentContent">
                         <form id="postAssessmentForm">
                            <!-- Placeholder questions -->
                            <div class="assessment-question">
                                <label for="postQ1">1. Rate your coaching confidence NOW (1-5) & explain changes.<span style="color:var(--danger-color)">*</span></label>
                                <input type="number" id="postQ1-rating" min="1" max="5" placeholder="Rating (1-5)" style="width:120px; margin-bottom: 5px;" data-assessment-question="postQ1_rating" required>
                                <textarea id="postQ1-explanation" placeholder="Explain changes since the pre-assessment..." data-assessment-question="postQ1_explanation" required></textarea>
                                <span class="validation-error" id="error-postQ1"></span>
                            </div>
                             <div class="assessment-question">
                                <label for="postQ2">2. Which section or concept was most impactful?<span style="color:var(--danger-color)">*</span></label>
                                <textarea id="postQ2" placeholder="Mention specific sections or ideas..." data-assessment-question="postQ2" required></textarea>
                                <span class="validation-error" id="error-postQ2"></span>
                            </div>
                            <button type="button" class="submit-button" onclick="submitPostAssessment()">Submit Evaluation</button>
                        </form>
                     </div>
                 </div>
            </div>
        </div> <!-- End dashboard-content-wrapper -->

        <!-- Admin-Only Section -->
        <div id="adminSection" style="display: none;">
            <h3><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>Admin Panel - User Progress Overview</h3>
             <p class="admin-note"> <strong>Note:</strong> This view shows data stored in <strong>your</strong> browser (for user: <span id="adminUserEmailDisplay"></span>). For a complete overview of all users, a backend database is required. This panel currently simulates the admin view structure using local data. </p>
            <div id="adminDataContainer"> <p>Loading admin data...</p> </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer"> © 2025 Elmenisy Leadership Coaching - All Rights Reserved </footer>

    <script>
        // --- Unified Keys ---
        const LOGGED_IN_KEY = 'isUserLoggedIn';
        const CURRENT_USER_KEY = 'currentUser';
        const SIGNUP_FLAG_KEY = 'hasSignedUpBefore';
        const ADMIN_EMAIL = 'm.elsayed@thechefz.co';
        const POST_ASSESSMENT_THRESHOLD = 80;
        const MIN_WORD_COUNT_Q1 = 20; // For pre-assessment Q1

        // --- Course Structure ---
        const courseSections = [ { id: 'index', title: 'Intro Goal', link: 'index.html' }, { id: 'article1', title: 'Introduction', link: 'article1.html' }, { id: 'skills', title: 'Coaching Skills', link: 'coaching-skills.html' }, { id: 'individuals', title: 'Coaching Individuals', link: 'coaching-individuals.html' }, { id: 'team', title: 'Team Coaching', link: 'coaching-team.html' }, { id: 'self', title: 'Self Coaching', link: 'coaching-yourself.html' }, { id: 'action', title: 'Action Plan', link: 'action-plan.html' }, ];

        // --- IMMEDIATE REDIRECTION LOGIC ---
        console.log("%cDashboard Page: Running IMMEDIATE redirection check...", "color: purple;"); function q(){const d=localStorage.getItem(CURRENT_USER_KEY); return d&&d.length>2&&d.startsWith('{')&&d.endsWith('}');} const li=localStorage.getItem(LOGGED_IN_KEY)==='true'&&q(); const hs=localStorage.getItem(SIGNUP_FLAG_KEY)==='true'; if(!li){const t=hs?'login.html':'signup.html'; console.error(`%cDashboard IMMEDIATE Redirect: Not logged in. Redirecting to ${t}...`, "color: orange;"); window.location.replace(`${t}?redirect=${encodeURIComponent(window.location.pathname)}`); throw new Error("Redirecting: Not logged in.");} else {console.log("%cDashboard IMMEDIATE Check: User IS logged in.", "color: green;");}

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Dashboard DOM loaded.");
            const currentUser = getCurrentUser();
            if (!currentUser) { console.error("Dashboard Critical: User data missing! Forcing logout."); logout(); return; }
            console.log("Current User Data (Dashboard):", currentUser);

            setupUserInfoDisplay(currentUser);
            handleContentVisibility(currentUser);
            setupPasteListeners(); // Add paste prevention listeners

             const courseSectionsList = document.getElementById('courseSectionsList');
             const courseSectionsContainer = document.getElementById('courseSectionsContainer');
             if(courseSectionsList && courseSectionsContainer && courseSectionsContainer.style.display !== 'none') {
                 displayCourseSections(currentUser, courseSectionsList);
             }

            setupAdminPanel(currentUser);

            const loadingMessage = document.getElementById('loadingMessage');
            const wrapper = document.getElementById('dashboard-content-wrapper');
            if (loadingMessage) loadingMessage.style.display = 'none';
            if (wrapper) {
                wrapper.style.display = 'block'; // Make visible first
                setTimeout(() => wrapper.classList.add('fade-in'), 50); // Then apply animation
            } else {
                 // Fallback if wrapper is missing
                 const userDashboardContent = document.getElementById('userDashboardContent');
                 if (userDashboardContent) userDashboardContent.style.display = 'block';
            }

            console.log("Dashboard initialized successfully.");
        });

        // --- Helper Functions ---
        function getCurrentUser() {
            try {
                const d=localStorage.getItem(CURRENT_USER_KEY); if(!d)return null; const u=JSON.parse(d);
                if(u&&typeof u==='object'&&u.name&&u.email){ let upd=false; if(typeof u.progress!=='object'||u.progress===null){u.progress={};upd=true;} courseSections.forEach(s=>{if(u.progress[s.id]===undefined){u.progress[s.id]=0;upd=true;}}); if(typeof u.assessments!=='object'||u.assessments===null){u.assessments={preCompleted:false,postCompleted:false,preAnswers:{},postAnswers:{},preScore:null,postScore:null};upd=true;} if(upd)saveCurrentUser(u); return u; }
                else{localStorage.removeItem(CURRENT_USER_KEY);localStorage.removeItem(LOGGED_IN_KEY);return null;}
            } catch(e){console.error("GUC Error:",e);localStorage.removeItem(CURRENT_USER_KEY);localStorage.removeItem(LOGGED_IN_KEY);return null;}
        }
        function saveCurrentUser(userObject) { try{if(!userObject)throw new Error("Invalid user object");localStorage.setItem(CURRENT_USER_KEY,JSON.stringify(userObject));console.log("Saved user data:",userObject);}catch(e){console.error("SCU Error:",e);} }
        function setupUserInfoDisplay(user) { document.getElementById('userNameBar').textContent=user.name; document.getElementById('userEmailBar').textContent=user.email; document.getElementById('welcomeMessage').textContent=`Welcome back, ${user.name}!`; document.getElementById('dashboardUserName').textContent=user.name; document.getElementById('dashboardUserEmail').textContent=user.email; const adminEmailD=document.getElementById('adminUserEmailDisplay'); if(adminEmailD)adminEmailD.textContent=user.email; }
        function calculateOverallProgress(user) { if(!user?.progress)return 0; const pV=courseSections.map(s=>user.progress[s.id]||0); if(pV.length===0)return 0; const sum=pV.reduce((a,c)=>a+c,0); return Math.round(sum/pV.length); }
        function logout() { console.log("Logging out..."); try{localStorage.removeItem(LOGGED_IN_KEY);localStorage.removeItem(CURRENT_USER_KEY);console.log("Local storage cleared.");window.location.href='login.html';}catch(e){console.error("Logout Error:",e);window.location.href='login.html';} }

        // --- Content Visibility & Assessment Logic ---
        function handleContentVisibility(user) {
            const preSection = document.getElementById('preAssessmentSection');
            const postSection = document.getElementById('postAssessmentSection');
            const courseContainer = document.getElementById('courseSectionsContainer');
            const preStatusEl = document.getElementById('preAssessmentStatus');
            const postStatusEl = document.getElementById('postAssessmentStatus');

            const isPreDone = user.assessments?.preCompleted === true;
            const isPostDone = user.assessments?.postCompleted === true;
            const progress = calculateOverallProgress(user);

            console.log(`Visibility Check: PreDone=${isPreDone}, PostDone=${isPostDone}, Progress=${progress}%`);

            if (!isPreDone) { // Pre-assessment Mandatory
                if(preSection) preSection.style.display = 'block';
                if(preStatusEl) { preStatusEl.textContent = 'Required'; preStatusEl.className = 'assessment-status in-progress'; } // Indicate required
                if(courseContainer) courseContainer.style.display = 'none';
                if(postSection) postSection.style.display = 'none';
                console.log("Showing Pre-Assessment.");
            } else { // Pre is done
                if(preSection) preSection.style.display = 'none'; // Hide completed Pre
                if(courseContainer) courseContainer.style.display = 'block'; // Show course sections

                if (progress >= POST_ASSESSMENT_THRESHOLD && !isPostDone) { // Trigger Post-assessment
                     if(postSection) postSection.style.display = 'block';
                     if(postStatusEl) { postStatusEl.textContent = 'Required'; postStatusEl.className = 'assessment-status in-progress'; }
                     console.log("Showing Post-Assessment.");
                } else { // Hide Post-assessment (either not triggered or already done)
                     if(postSection) postSection.style.display = 'none';
                     if(postStatusEl && isPostDone) { postStatusEl.textContent = 'Completed'; postStatusEl.className = 'assessment-status completed'; }
                     else if (postStatusEl) { postStatusEl.textContent = 'Not Yet Available'; postStatusEl.className = 'assessment-status'; } // Optional: Status update
                     console.log("Hiding Post-Assessment.");
                }
            }
        }

        // --- Assessment Interactions ---
        function startPreAssessment() { document.getElementById('preAssessmentContent').style.display = 'block'; event.target.style.display = 'none'; }
        function startPostAssessment() { document.getElementById('postAssessmentContent').style.display = 'block'; event.target.style.display = 'none'; }

        function countWords(str) { return str.trim().split(/\s+/).filter(word => word.length > 0).length; }

        function validateAssessment(formId) {
            let isValid = true;
            const form = document.getElementById(formId);
            form.querySelectorAll('.validation-error').forEach(el => el.textContent = ''); // Clear previous errors

            form.querySelectorAll('textarea[required], input[required]').forEach(field => {
                 const questionId = field.dataset.assessmentQuestion || field.id; // Use data attr or id
                 const errorEl = form.querySelector(`#error-${questionId.replace('_rating','').replace('_explanation','')}`); // Find related error span
                 const value = field.value.trim();
                 let fieldError = '';

                 if (value === '') {
                     fieldError = 'This field is required.';
                 } else if (field.dataset.minWords && countWords(value) < parseInt(field.dataset.minWords, 10)) {
                     fieldError = `Please provide at least ${field.dataset.minWords} words.`;
                 } else if (field.type === 'number' && (field.value < field.min || field.value > field.max)) {
                     fieldError = `Please enter a number between ${field.min} and ${field.max}.`;
                 }

                 if (fieldError) {
                     isValid = false;
                     if (errorEl) errorEl.textContent = fieldError;
                     field.style.borderColor = 'var(--danger-color)'; // Highlight error field
                 } else {
                      field.style.borderColor = '#ccc'; // Reset border
                 }
             });
             // Specific check for combined rating/explanation for preQ4
             if (formId === 'preAssessmentForm') {
                 const rating = form.querySelector('#preQ4-rating');
                 const explanation = form.querySelector('#preQ4-explanation');
                 const errorEl = form.querySelector('#error-preQ4');
                 if(rating.value.trim() === '' || explanation.value.trim() === '') {
                      isValid = false;
                      if (errorEl) errorEl.textContent = 'Both rating and explanation are required.';
                      if (rating.value.trim() === '') rating.style.borderColor = 'var(--danger-color)';
                      if (explanation.value.trim() === '') explanation.style.borderColor = 'var(--danger-color)';
                 }
             }
              // Specific check for combined rating/explanation for postQ1
              if (formId === 'postAssessmentForm') {
                 const rating = form.querySelector('#postQ1-rating');
                 const explanation = form.querySelector('#postQ1-explanation');
                 const errorEl = form.querySelector('#error-postQ1');
                 if(rating.value.trim() === '' || explanation.value.trim() === '') {
                      isValid = false;
                      if (errorEl) errorEl.textContent = 'Both rating and explanation are required.';
                      if (rating.value.trim() === '') rating.style.borderColor = 'var(--danger-color)';
                      if (explanation.value.trim() === '') explanation.style.borderColor = 'var(--danger-color)';
                 }
             }

            return isValid;
        }


        function submitPreAssessment() {
            console.log("Submitting Pre-Assessment...");
            if (!validateAssessment('preAssessmentForm')) { console.log("Pre-Assessment Validation Failed."); return; }

            const currentUser = getCurrentUser(); if (!currentUser) return;
            const answers = {}; const form = document.getElementById('preAssessmentForm');
            form.querySelectorAll('textarea[data-assessment-question], input[data-assessment-question]').forEach(field => { answers[field.dataset.assessmentQuestion] = field.value.trim(); });

            currentUser.assessments.preCompleted = true;
            currentUser.assessments.preAnswers = answers;
            currentUser.assessments.preScore = 100; // Placeholder score

            saveCurrentUser(currentUser);
            console.log("Pre-Assessment saved:", currentUser.assessments);
            handleContentVisibility(currentUser); // Update UI immediately
             // Reload course sections now they are visible
            displayCourseSections(currentUser, document.getElementById('courseSectionsList'));
            if (currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) { displayAdminData(document.getElementById('adminDataContainer'), currentUser); }

             // Simple confirmation popup
            alert("Thank you! Your answers have been saved. You can now start your journey!");
         }

        function submitPostAssessment() {
            console.log("Submitting Post-Assessment...");
             if (!validateAssessment('postAssessmentForm')) { console.log("Post-Assessment Validation Failed."); return; }

            const currentUser = getCurrentUser(); if (!currentUser) return;
            const answers = {}; const form = document.getElementById('postAssessmentForm');
            form.querySelectorAll('textarea[data-assessment-question], input[data-assessment-question]').forEach(field => { answers[field.dataset.assessmentQuestion] = field.value.trim(); });

            currentUser.assessments.postCompleted = true;
            currentUser.assessments.postAnswers = answers;
            currentUser.assessments.postScore = 100; // Placeholder score

            saveCurrentUser(currentUser);
            console.log("Post-Assessment saved:", currentUser.assessments);
            handleContentVisibility(currentUser); // Update UI
            if (currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) { displayAdminData(document.getElementById('adminDataContainer'), currentUser); }
            alert("Post-Course Evaluation Submitted! Thank you.");
         }

        // --- Paste Prevention ---
        function handlePaste(e) {
            e.preventDefault();
            console.warn("Paste attempt detected and prevented.");
            // Optional: Show a temporary message near the field
            const target = e.target;
            const warning = document.createElement('span');
            warning.textContent = ' Typing required.';
            warning.style.color = 'var(--danger-color)';
            warning.style.fontSize = '12px';
            warning.style.fontStyle = 'italic';
            target.parentNode.insertBefore(warning, target.nextSibling);
            setTimeout(() => warning.remove(), 2500);
        }

        function setupPasteListeners() {
            document.querySelectorAll('.assessment-content textarea').forEach(textarea => {
                textarea.addEventListener('paste', handlePaste);
            });
             console.log("Paste prevention listeners added to assessment textareas.");
        }

        // --- Display Course Sections ---
        function displayCourseSections(user, containerElement) { /* ... consistent ... */ if (!user || !containerElement) return; containerElement.innerHTML = ''; if (!user.progress) user.progress = {}; courseSections.forEach(s => { const p = user.progress[s.id] || 0; const pP = Math.max(0, Math.min(100, Math.round(p))); const sE = document.createElement('div'); sE.className = 'course-section'; sE.innerHTML = ` <span class="section-title">${s.title}</span> <div class="section-progress"> <div class="progress-bar-container"> <div class="progress-bar" style="width: ${pP}%;"></div> </div> <span class="progress-text">${pP}% Complete</span> <a href="${s.link||'#'}" class="section-link">Start</a> </div> `; const lB = sE.querySelector('.section-link'); if(p>=100){lB.textContent='Review'; lB.style.backgroundColor='var(--success-color)'; lB.onmouseover=()=>lB.style.backgroundColor='#219653'; lB.onmouseout=()=>lB.style.backgroundColor='var(--success-color)';} else if(p>0){lB.textContent='Continue'; lB.style.backgroundColor='var(--warning-color)'; lB.onmouseover=()=>lB.style.backgroundColor='#d35400'; lB.onmouseout=()=>lB.style.backgroundColor='var(--warning-color)';} else{lB.style.backgroundColor='var(--accent-color)'; lB.onmouseover=()=>lB.style.backgroundColor='#2980b9'; lB.onmouseout=()=>lB.style.backgroundColor='var(--accent-color)';} containerElement.appendChild(sE); }); }

        // --- Admin Panel Logic ---
        function setupAdminPanel(user) { /* ... consistent ... */ const iA=user.email.toLowerCase()===ADMIN_EMAIL.toLowerCase(); const aS=document.getElementById('adminSection'); const aDC=document.getElementById('adminDataContainer'); if(iA){console.log("Admin detected."); if(aS)aS.style.display='block'; if(aDC)displayAdminData(aDC,user); else console.error("Admin container not found!");} else {console.log("Regular user."); if(aS)aS.style.display='none';} }
        function displayAdminData(containerElement, adminUser) { /* Updated for Scores */ if(!containerElement||!adminUser)return; if(!adminUser.progress){containerElement.innerHTML='<p>Err: Admin progress missing.</p>'; return;} if(!adminUser.assessments){adminUser.assessments={preScore:null,postScore:null};} let tH=`<table class="admin-user-table"><thead><tr><th>Section</th><th>Progress (%)</th><th>Pre-Score</th><th>Post-Score</th><th>Status</th></tr></thead><tbody>`; courseSections.forEach(s=>{const p=adminUser.progress[s.id]||0; const pP=Math.max(0,Math.min(100,Math.round(p))); let st='Not Started'; if(p>=100)st='Completed'; else if(p>0)st='In Progress'; tH+=`<tr><td>${s.title}</td><td>${pP}%</td><td>${adminUser.assessments.preScore??'N/A'}</td><td>${adminUser.assessments.postScore??'N/A'}</td><td>${st}</td></tr>`;}); tH+=`</tbody></table><p style="margin-top:15px;font-size:14px;"><em>(Showing data for logged-in admin only. Full implementation needs backend.)</em></p>`; containerElement.innerHTML=tH; }

    </script>
</body>
</html>
