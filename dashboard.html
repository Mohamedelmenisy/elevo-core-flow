<!doctype html>
<html lang=en class=dark>
<head>
<meta charset=UTF-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Admin Dashboard - Elevo Core</title>
<link rel=icon href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234e8cff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M12 22V12M9 19l3-3 3 3M12 2a4 4 0 0 0-4 4v0a4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4z'/></svg>">
<link rel=stylesheet href=style.css>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel=stylesheet>
<script src=https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2></script>
<script src=https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js></script>
<script src=role-check.js></script>
<style>.dashboard-main{width:100%;max-width:100%;margin:0;padding:1.5rem 2rem;text-align:left}.dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem;margin-top:1.5rem}.dashboard-card{background-color:var(--card-bg-color);border-radius:var(--border-radius-lg);padding:1.5rem;box-shadow:0 4px 6px rgba(0,0,0,.1);transition:transform .2s ease,box-shadow .2s ease;position:relative;overflow:hidden}.dashboard-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--primary-color),var(--accent-color));transform:scaleX(0);transition:transform .3s ease}.dashboard-card:hover::before{transform:scaleX(1)}.dashboard-card:hover{transform:translateY(-4px);box-shadow:0 10px 15px rgba(0,0,0,.2)}.dashboard-card h3{margin-top:0;margin-bottom:.75rem;font-size:1.1em;color:var(--text-color-light);font-weight:500}.dashboard-card .value{font-size:2.5em;font-weight:700;margin:.5rem 0;color:var(--text-color)}.dashboard-card .trend{display:flex;align-items:center;font-size:.9em;margin-top:.5rem}.trend.up{color:var(--success-color)}.trend.down{color:var(--danger-color)}.trend-icon{margin-right:.25rem}.card-large{grid-column:span 2}.card-full{grid-column:1/-1}.chart-container{height:300px;position:relative}.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:2rem}.stat-card{background-color:var(--card-bg-color);border:1px solid var(--border-color);border-radius:var(--border-radius-lg);padding:1rem 1.25rem;box-shadow:0 4px 8px rgba(0,0,0,.15);transition:transform .2s ease,box-shadow .2s ease}.stat-card:hover{transform:translateY(-2px);box-shadow:0 8px 12px rgba(0,0,0,.2)}.stat-card h3{font-size:.9rem;color:var(--text-color-light);margin-bottom:.5rem;font-weight:500;text-align:center}.stat-card p{font-size:1.8rem;font-weight:700;color:var(--primary-color);text-align:center;margin:0}.stat-item{display:flex;flex-direction:column;align-items:center;text-align:center;padding:1rem;background-color:var(--input-bg-color);border-radius:var(--border-radius-md)}.stat-value{font-size:1.75em;font-weight:700;margin-bottom:.25rem;color:var(--text-color)}.stat-label{font-size:.85em;color:var(--text-color-light)}.top-agents-list,.top-scenarios-list{list-style:none;padding:0;margin:0}.top-agent-item,.top-scenario-item{display:flex;justify-content:space-between;align-items:center;padding:.75rem 0;border-bottom:1px solid var(--border-color)}.top-agent-item:last-child,.top-scenario-item:last-child{border-bottom:none}.agent-name,.scenario-name{font-weight:500}.agent-count,.scenario-count{font-weight:600;color:var(--primary-color)}@media (max-width:768px){.dashboard-grid{grid-template-columns:1fr}.card-full,.card-large{grid-column:1}}.notifications-container{position:relative;display:inline-block}.notification-badge{position:absolute;top:-5px;right:-5px;background:var(--danger-color);color:#fff;border-radius:50%;width:18px;height:18px;font-size:.7rem;display:flex;align-items:center;justify-content:center}.notifications-panel{position:absolute;top:100%;right:0;width:350px;background:var(--card-bg-color);border:1px solid var(--border-color);border-radius:var(--border-radius-lg);box-shadow:0 10px 25px rgba(0,0,0,.2);z-index:1000;display:none;max-height:400px;overflow-y:auto}.notifications-header{display:flex;justify-content:space-between;align-items:center;padding:1rem;border-bottom:1px solid var(--border-color)}.notifications-list{padding:.5rem}.notification-item{padding:.75rem;border-bottom:1px solid var(--border-color);cursor:pointer;transition:background-color .2s}.notification-item:hover{background-color:var(--input-bg-color)}.notification-item:last-child{border-bottom:none}.notification-item.unread{background-color:rgba(78,140,255,.1);border-left:3px solid var(--primary-color)}.notification-time{font-size:.8rem;color:var(--text-color-light);margin-top:.25rem}.clear-btn{background:0 0;border:none;color:var(--primary-color);cursor:pointer;font-size:.85rem}.search-container{width:100%;max-width:400px;margin-top:1rem}.search-box{position:relative;display:flex;align-items:center}.search-box svg{position:absolute;left:12px;color:var(--text-color-light)}.search-box input{width:100%;padding:.75rem 1rem .75rem 2.5rem;background:var(--input-bg-color);border:1px solid var(--border-color);border-radius:var(--border-radius-md);color:var(--text-color);font-size:.9rem}.search-box input:focus{outline:0;border-color:var(--primary-color)}.highlight-row{animation:highlight 2s ease}@keyframes highlight{0%{background-color:rgba(78,140,255,.3)}100%{background-color:transparent}}.toast{position:fixed;top:20px;right:20px;background:var(--primary-color);color:#fff;padding:1rem;border-radius:var(--border-radius-md);box-shadow:0 4px 12px rgba(0,0,0,.3);z-index:10000;display:flex;align-items:center;gap:1rem;min-width:300px;animation:slideIn .3s ease}.toast-success{background:var(--success-color)}.toast-warning{background:var(--warning-color)}.toast-error{background:var(--danger-color)}.toast-close{background:0 0;border:none;color:#fff;font-size:1.2rem;cursor:pointer;padding:0;width:20px;height:20px;display:flex;align-items:center;justify-content:center}@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}.chart-legend{display:flex;justify-content:center;flex-wrap:wrap;gap:1rem;margin-top:1rem}.legend-item{display:flex;align-items:center;font-size:.85rem}.legend-color{width:12px;height:12px;border-radius:50%;margin-right:.5rem}@media (max-width:768px){.notifications-panel{width:300px;right:-50px}.search-container{max-width:100%}}.table-section{background-color:var(--card-bg-color);padding:2rem;border-radius:var(--border-radius-lg);box-shadow:0 4px 10px rgba(0,0,0,.3);margin-bottom:2rem;animation:fadeIn .6s ease-out}#liveUnifiedTable{width:100%;border-collapse:collapse;background-color:#111827;color:var(--text-color);border-radius:var(--border-radius-md);overflow:hidden}#liveUnifiedTable th{background-color:#1e293b;color:#f1f5f9;font-weight:600;text-transform:uppercase;letter-spacing:.5px;font-size:.85em;padding:1rem 1.25rem;border-bottom:1px solid #2d3748}#liveUnifiedTable td{padding:1rem 1.25rem;border-bottom:1px solid #2d3748}#liveUnifiedTable tbody tr:nth-child(odd){background-color:#162032}#liveUnifiedTable tbody tr:nth-child(2n){background-color:#111827}#liveUnifiedTable tbody tr:hover{background-color:#1e293b;box-shadow:0 2px 6px rgba(0,0,0,.25);transition:background-color .2s ease,box-shadow .2s ease}#liveUnifiedTable tbody tr:last-child td{border-bottom:none}.table-section h2{font-size:1.2rem;font-weight:600;color:var(--text-color);margin-bottom:1.25rem}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.quick-stats-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin-top:1rem}.quick-stat-box{background-color:var(--card-bg-color);border:1px solid var(--border-color);border-radius:var(--border-radius-md);padding:1rem;text-align:center;box-shadow:0 4px 8px rgba(0,0,0,.15);transition:transform .2s ease,box-shadow .2s ease}.quick-stat-box:hover{transform:translateY(-3px);box-shadow:0 8px 16px rgba(0,0,0,.25)}.quick-stat-box h3{font-size:.9rem;color:var(--text-color-light);margin-bottom:.5rem}.quick-stat-box p{font-size:1.6rem;font-weight:700;color:var(--primary-color);margin:0}.shimmer-row{height:18px;width:100%;background:linear-gradient(90deg,#f0f3f6 25%,#e2e8f0 37%,#f0f3f6 63%);background-size:400% 100%;animation:shimmer 1.2s linear infinite;border-radius:6px}@keyframes shimmer{100%{background-position:-200% 0}}</style>
<style>:root{--primary-color:#4e8cff;--accent-color:#60a5fa;--success-color:#10b981;--danger-color:#ef4444;--warning-color:#f59e0b;--card-bg-color:#1f2937;--border-color:#374151;--input-bg-color:#111827;--text-color:#f9fafb;--text-color-light:#d1d5db;--border-radius-md:8px;--border-radius-lg:12px}body.dark{background-color:#0f172a;color:var(--text-color);font-family:Poppins,sans-serif}.dashboard-card,.main-chart-container,.stat-card,.table-section{background-color:var(--card-bg-color)!important;border:1px solid var(--border-color);color:var(--text-color);border-radius:var(--border-radius-lg);box-shadow:0 4px 12px rgba(0,0,0,.2);transition:transform .2s ease,box-shadow .2s ease}.dashboard-card:hover,.stat-card:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,.25)}.app-footer,.app-header{background-color:#111827;color:var(--text-color)}.action-button{border-radius:var(--border-radius-md);padding:.6rem 1rem;font-weight:500}.primary-button{background-color:var(--primary-color);color:#fff;border:none}.secondary-button{background-color:transparent;border:1px solid var(--border-color);color:var(--text-color-light)}</style>
</head>
<body>
<div class=app-container>
<header class=app-header>
<div class=logo-container>
<svg class=company-logo viewBox="0 0 24 24" fill=none xmlns=http://www.w3.org/2000/svg style=color:var(--primary-color);width:28px;height:28px>
<path d="M12 22V12M9 19l3-3 3 3M12 2a4 4 0 0 0-4 4v0a4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4z" stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round />
</svg>
<span class=app-title style=font-size:1.4rem>Elevo Core - Admin Dashboard</span>
</div>
<div class=header-controls>
<a href=core-flow.html class=nav-link>Call App</a>
<a href=agent-portal.html class=nav-link>Agent Portal</a>
<a href=rtm-dashboard.html class=nav-link>RTM Dashboard</a>
<div class=notifications-container>
<button id=notificationsBtn class=nav-link>
<svg xmlns=http://www.w3.org/2000/svg width=18 height=18 viewBox="0 0 24 24" fill=none stroke=currentColor stroke-width=2>
<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
<path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
</svg>
<span id=notificationBadge class=notification-badge style=display:none>0</span>
</button>
<div id=notificationsPanel class=notifications-panel>
<div class=notifications-header>
<h4>Notifications</h4>
<button id=clearNotifications class=clear-btn>Clear All</button>
</div>
<div id=notificationsList class=notifications-list>
</div>
</div>
</div>
<div class=user-info id=userInfo style=display:none>
<span id=userName class=user-name-display></span>
<button id=logoutButton class=logout-btn>
<svg xmlns=http://www.w3.org/2000/svg width=16 height=16 viewBox="0 0 24 24" fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1=21 y1=12 x2=9 y2=12></line></svg>
Logout
</button>
</div>
</div>
</header>
<main class="app-main dashboard-main">
<div id=auth-loading class=loading-container style=display:flex;flex-direction:column;align-items:center;justify-content:center;height:70vh>
<div class=spinner></div>
<p>Syncing data with Elevo Core...</p>
</div>
<div id=dashboardContent style=display:none>
<div class=dashboard-header style=display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem>
<div>
<h1>Admin Dashboard</h1>
<p class=text-color-light>Overview of call center performance and metrics</p>
</div>
<div style=display:flex;gap:.75rem>
<button id=refreshDataBtn class="action-button primary-button">
<svg xmlns=http://www.w3.org/2000/svg width=16 height=16 viewBox="0 0 24 24" fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
Refresh Data
</button>
<button id=exportReportBtn class="action-button secondary-button">
<svg xmlns=http://www.w3.org/2000/svg width=16 height=16 viewBox="0 0 24 24" fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1=12 y1=15 x2=12 y2=3></line></svg>
Export Report
</button>
</div>
</div>
<div class=search-container>
<div class=search-box>
<svg xmlns=http://www.w3.org/2000/svg width=16 height=16 viewBox="0 0 24 24" fill=none stroke=currentColor stroke-width=2>
<circle cx=11 cy=11 r=8></circle>
<line x1=21 y1=21 x2=16.65 y2=16.65></line>
</svg>
<input id=globalSearch placeholder="Search in data...">
</div>
</div>
<div class=dashboard-grid>
<div class=dashboard-card style="border-left:4px solid var(--primary-color)">
<h3>Live Tickets</h3>
<div class=value id=liveTicketsCount>0</div>
<div class=trend id=liveTicketsTrend>
<span class=trend-icon>→</span>
<span>Real-time</span>
</div>
</div>
<div class=dashboard-card style="border-left:4px solid var(--warning-color)">
<h3>Delayed Tickets</h3>
<div class=value id=delayedTicketsCount>0</div>
<div class=trend id=delayedTicketsTrend>
<span class=trend-icon>→</span>
<span>Over 5 minutes</span>
</div>
</div>
<div class=dashboard-card style="border-left:4px solid var(--success-color)">
<h3>Recent Tickets</h3>
<div class=value id=recentTicketsCount>0</div>
<div class=trend id=recentTicketsTrend>
<span class=trend-icon>→</span>
<span>Last 10 minutes</span>
</div>
</div>
<div class=dashboard-card style="border-left:4px solid var(--accent-color)">
<h3>Total Calls Today</h3>
<div class=value id=totalCallsToday>0</div>
<div class=trend id=totalCallsTrend>
<span class=trend-icon>→</span>
<span>All scenarios</span>
</div>
</div>
<div class="dashboard-card card-large">
<h3>Call Quality Summary</h3>
<div class=chart-container>
<canvas id=qualitySummaryChart></canvas>
</div>
<div class=chart-legend id=qualityLegend></div>
</div>
<div class=dashboard-card>
<h3>Top 5 Agents Today</h3>
<ul class=top-agents-list id=topAgentsList>
<li class=top-agent-item>
<span class=agent-name>Loading...</span>
<span class=agent-count>-</span>
</li>
</ul>
</div>
<div class=dashboard-card>
<h3>Top Scenario Today</h3>
<div id=topScenarioContainer>
<div class=top-scenario-item>
<span class=scenario-name>Loading...</span>
<span class=scenario-count>-</span>
</div>
</div>
</div>
<div class="dashboard-card card-full">
<h3>Call Volume Trends (Last 7 Days)</h3>
<div class=chart-container>
<canvas id=volumeTrendChart></canvas>
</div>
</div>
<div class="dashboard-card card-large">
<h3>Agent Performance Distribution</h3>
<div class=chart-container>
<canvas id=agentPerformanceChart></canvas>
</div>
</div>
<div class=dashboard-card>
<h3>Quick Stats</h3>
<div class=stats-grid>
<div class=stat-item>
<div class=stat-value id=avgHandleTime>0m</div>
<div class=stat-label>Avg Handle Time</div>
</div>
<div class=stat-item>
<div class=stat-value id=completionRate>0%</div>
<div class=stat-label>Completion Rate</div>
</div>
<div class=stat-item>
<div class=stat-value id=goodQualityRate>0%</div>
<div class=stat-label>Good Quality</div>
</div>
<div class=stat-item>
<div class=stat-value id=activeAgents>0</div>
<div class=stat-label>Active Agents</div>
</div>
</div>
</div>
<div class="dashboard-card card-full" id=recentTicketsCard style=margin-top:0>
<h3 style=color:#60a5fa>🕓 Recent Ticket Sessions (Last 10 minutes)</h3>
<div class=table-responsive>
<table id=recentTicketsTable style=width:100%;border-collapse:collapse>
<thead style=background-color:#1e3a8a;color:#fff>
<tr>
<th style=padding:8px>Agent</th>
<th style=padding:8px>Agent Email</th>
<th style=padding:8px>Scenario</th>
<th style=padding:8px>Quality</th>
<th style=padding:8px>Reason</th>
<th style=padding:8px>Start (EG)</th>
<th style=padding:8px>End (EG)</th>
<th style=padding:8px>Duration</th>
</tr>
</thead>
<tbody id=recentTicketsTbody></tbody>
</table>
</div>
<div class=pagination-controls>
<button id=recentTicketsPrev class="action-button secondary-button">Previous</button>
<span id=recentTicketsPageInfo style=color:var(--text-color-light)>Page 1</span>
<button id=recentTicketsNext class="action-button secondary-button">Next</button>
</div>
</div>
</div>
</div>
</main>
<footer class=app-footer>
<p>© <span id=currentYear></span> Mohamed Elmenisy - Elevo Core. All rights reserved.</p>
</footer>
</div>
<script type=module>const SUPABASE_URL="https://aefiigottnlcmjzilqnh.supabase.co",SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlZmlpZ290dG5sY21qemlscW5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNzY2MDQsImV4cCI6MjA2Mjc1MjYwNH0.FypB02v3tGMnxXV9ZmZMdMC0oQpREKOJWgHMPxUzwX4",{createClient:createClient}=supabase,supabaseClient=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);let currentUser=null,qualitySummaryChart=null,volumeTrendChart=null,agentPerformanceChart=null,autoRefreshInterval=null,recentTicketsPage=1;const RECENT_TICKETS_PAGE_SIZE=10;let notifications=JSON.parse(localStorage.getItem("elevo_notifications"))||[];function setupEventListeners(){document.getElementById("logoutButton").addEventListener("click",(async()=>{await supabaseClient.auth.signOut(),window.location.href="index.html"})),document.getElementById("refreshDataBtn").addEventListener("click",(async()=>{await loadDashboardData(),addNotification("Dashboard data refreshed","success")})),document.getElementById("exportReportBtn").addEventListener("click",exportDashboardReport),document.getElementById("recentTicketsPrev").addEventListener("click",(()=>{recentTicketsPage>1&&(recentTicketsPage--,loadRecentTickets(recentTicketsPage))})),document.getElementById("recentTicketsNext").addEventListener("click",(()=>{recentTicketsPage++,loadRecentTickets(recentTicketsPage)}))}function initNotifications(){updateNotificationBadge(),renderNotifications(),document.getElementById("notificationsBtn").addEventListener("click",toggleNotifications),document.getElementById("clearNotifications").addEventListener("click",clearNotifications),document.addEventListener("click",(t=>{const e=document.getElementById("notificationsPanel"),n=document.getElementById("notificationsBtn");!e||"block"!==e.style.display||e.contains(t.target)||n.contains(t.target)||(e.style.display="none")}))}function toggleNotifications(){const t=document.getElementById("notificationsPanel");t.style.display="block"===t.style.display?"none":"block"}function addNotification(t,e="info"){const n={id:Date.now(),message:t,type:e,timestamp:new Date,read:!1};notifications.unshift(n),notifications.length>50&&notifications.pop(),localStorage.setItem("elevo_notifications",JSON.stringify(notifications)),updateNotificationBadge(),renderNotifications(),showToast(t,e)}function renderNotifications(){const t=document.getElementById("notificationsList");t&&(0!==notifications.length?t.innerHTML=notifications.map((t=>`\n                <div class="notification-item ${t.read?"":"unread"}" onclick="markAsRead(${t.id})">\n                    <div>${t.message}</div>\n                    <div class="notification-time">${formatTime(t.timestamp)}</div>\n                </div>\n            `)).join(""):t.innerHTML='<div class="notification-item" style="text-align: center; color: var(--text-color-light);">No notifications</div>')}function updateNotificationBadge(){const t=document.getElementById("notificationBadge"),e=notifications.filter((t=>!t.read)).length;e>0?(t.textContent=e>99?"99+":e,t.style.display="flex"):t.style.display="none"}function markAsRead(t){notifications=notifications.map((e=>e.id===t?{...e,read:!0}:e)),localStorage.setItem("elevo_notifications",JSON.stringify(notifications)),updateNotificationBadge(),renderNotifications()}function clearNotifications(){notifications=[],localStorage.setItem("elevo_notifications",JSON.stringify(notifications)),updateNotificationBadge(),renderNotifications(),showToast("All notifications cleared","success")}function initSearch(){const t=document.getElementById("globalSearch");t&&t.addEventListener("input",debounce(handleSearch,300))}function handleSearch(t){const e=t.target.value.toLowerCase().trim();e.length<2?clearSearchHighlights():highlightSearchResults(e)}function highlightSearchResults(t){clearSearchHighlights();const e=document.getElementById("recentTicketsTable");if(e){e.querySelectorAll("tbody tr").forEach((e=>{e.textContent.toLowerCase().includes(t)&&e.classList.add("highlight-row")}))}document.querySelectorAll(".dashboard-card").forEach((e=>{e.textContent.toLowerCase().includes(t)&&(e.style.boxShadow="0 0 0 2px var(--primary-color)")}))}function clearSearchHighlights(){document.querySelectorAll(".highlight-row").forEach((t=>t.classList.remove("highlight-row")));document.querySelectorAll(".dashboard-card").forEach((t=>t.style.boxShadow=""))}function showToast(t,e="info"){const n=document.createElement("div");n.className=`toast toast-${e}`,n.innerHTML=`\n                <div class="toast-message">${t}</div>\n                <button class="toast-close" onclick="this.parentElement.remove()">×</button>\n            `,document.body.appendChild(n),setTimeout((()=>{n.parentElement&&n.remove()}),5e3)}async function loadDashboardData(){try{document.getElementById("auth-loading").style.display="flex",document.getElementById("dashboardContent").style.display="none",await Promise.all([loadTicketCounts(),loadCallQualitySummary(),loadTopAgents(),loadTopScenario(),loadVolumeTrends(),loadAgentPerformance(),loadQuickStats(),loadRecentTickets()]),document.getElementById("auth-loading").style.display="none",document.getElementById("dashboardContent").style.display="block"}catch(t){console.error("Error loading dashboard data:",t),document.getElementById("auth-loading").innerHTML="<p>Error loading data. Please try again.</p>",addNotification("Error loading dashboard data","error")}}async function loadTicketCounts(){try{const{data:t,error:e}=await supabaseClient.from("call_sessions").select("id").eq("completed",!1);e||(document.getElementById("liveTicketsCount").textContent=t.length);const n=new Date(Date.now()-3e5).toISOString(),{data:o,error:a}=await supabaseClient.from("call_sessions").select("id").eq("completed",!1).lt("start_time_egypt",n);a||(document.getElementById("delayedTicketsCount").textContent=o.length);const i=new Date(Date.now()-6e5).toISOString(),{data:r,error:s}=await supabaseClient.from("call_sessions").select("id").eq("completed",!0).gte("end_time_egypt",i);s||(document.getElementById("recentTicketsCount").textContent=r.length);const l=(new Date).toISOString().split("T")[0],{data:c,error:d}=await supabaseClient.from("call_sessions").select("id").gte("start_time_egypt",`${l}T00:00:00`).lt("start_time_egypt",`${l}T23:59:59`);d||(document.getElementById("totalCallsToday").textContent=c.length)}catch(t){console.error("Error loading ticket counts:",t)}}async function loadCallQualitySummary(){try{const{data:t,error:e}=await supabaseClient.from("call_sessions").select("call_quality").not("call_quality","is",null);if(e)return void console.error("Error fetching call quality summary:",e);const n={};t.forEach((t=>{const e=t.call_quality||"Unknown";n[e]=(n[e]||0)+1}));const o=Object.keys(n),a=Object.values(n),i=o.map((t=>"good"===t.toLowerCase()?"#10B981":"bad"===t.toLowerCase()?"#EF4444":"#6B7280")),r=document.getElementById("qualitySummaryChart").getContext("2d");qualitySummaryChart&&qualitySummaryChart.destroy(),qualitySummaryChart=new Chart(r,{type:"doughnut",data:{labels:o,datasets:[{data:a,backgroundColor:i,borderColor:i.map((t=>t.replace("0.8","1"))),borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom",labels:{color:"#D1D5DB",font:{size:12}}},title:{display:!0,text:"Call Quality Distribution",color:"#F9FAFB",font:{size:14,weight:"bold"}}}}});const s=document.getElementById("qualityLegend");s&&(s.innerHTML=o.map(((t,e)=>`\n                        <div class="legend-item">\n                            <div class="legend-color" style="background-color: ${i[e]}"></div>\n                            <span>${t}: ${a[e]}</span>\n                        </div>\n                    `)).join(""))}catch(t){console.error("Error loading call quality summary:",t)}}async function loadTopAgents(){try{const t=(new Date).toISOString().split("T")[0],{data:e,error:n}=await supabaseClient.from("call_sessions").select("agent_name").gte("start_time_egypt",`${t}T00:00:00`).lt("start_time_egypt",`${t}T23:59:59`);if(n)return void console.error("Error fetching top agents:",n);const o={};e.forEach((t=>{const e=t.agent_name||"Unknown";o[e]=(o[e]||0)+1}));const a=Object.entries(o).map((([t,e])=>({agent_name:t,total_tickets:e}))).sort(((t,e)=>e.total_tickets-t.total_tickets)).slice(0,5),i=document.getElementById("topAgentsList");if(0===a.length)return void(i.innerHTML='<li class="top-agent-item"><span class="agent-name">No data available</span><span class="agent-count">-</span></li>');i.innerHTML=a.map((t=>`\n                    <li class="top-agent-item">\n                        <span class="agent-name">${t.agent_name}</span>\n                        <span class="agent-count">${t.total_tickets}</span>\n                    </li>\n                `)).join("")}catch(t){console.error("Error loading top agents:",t)}}async function loadTopScenario(){try{const t=(new Date).toISOString().split("T")[0],{data:e,error:n}=await supabaseClient.from("call_sessions_egypt").select("scenario_title").gte("start_time_egypt",`${t}T00:00:00`).lt("start_time_egypt",`${t}T23:59:59`);if(n)return console.error("Error fetching top scenario:",n),void(document.getElementById("topScenarioContainer").innerHTML='\n                        <div class="top-scenario-item">\n                            <span class="scenario-name">No data available</span>\n                            <span class="scenario-count">-</span>\n                        </div>\n                    ');const o={};e.forEach((t=>{const e=t.scenario_title||"Unknown";o[e]=(o[e]||0)+1}));let a={scenario_title:"No data",total_runs:0};Object.entries(o).forEach((([t,e])=>{e>a.total_runs&&(a={scenario_title:t,total_runs:e})})),document.getElementById("topScenarioContainer").innerHTML=`\n                    <div class="top-scenario-item">\n                        <span class="scenario-name">${a.scenario_title}</span>\n                        <span class="scenario-count">${a.total_runs}</span>\n                    </div>\n                `}catch(t){console.error("Error loading top scenario:",t)}}async function loadVolumeTrends(){try{const t=[];for(let e=6;e>=0;e--){const n=new Date;n.setDate(n.getDate()-e),t.push(n.toISOString().split("T")[0])}const e=[];for(const n of t){const{data:t,error:o}=await supabaseClient.from("call_sessions").select("id",{count:"exact"}).gte("start_time_egypt",`${n}T00:00:00`).lt("start_time_egypt",`${n}T23:59:59`);o?e.push(0):e.push(t.length)}const n=t.map((t=>new Date(t).toLocaleDateString("en-US",{month:"short",day:"numeric"}))),o=document.getElementById("volumeTrendChart").getContext("2d");volumeTrendChart&&volumeTrendChart.destroy(),volumeTrendChart=new Chart(o,{type:"line",data:{labels:n,datasets:[{label:"Call Volume",data:e,borderColor:"#4e8cff",backgroundColor:"rgba(78, 140, 255, 0.1)",borderWidth:2,fill:!0,tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{labels:{color:"#D1D5DB"}},title:{display:!0,text:"Call Volume Over Time",color:"#F9FAFB",font:{size:14,weight:"bold"}}},scales:{x:{ticks:{color:"#9CA3AF"},grid:{color:"#374151"}},y:{ticks:{color:"#9CA3AF"},grid:{color:"#374151"},beginAtZero:!0}}}})}catch(t){console.error("Error loading volume trends:",t)}}async function loadAgentPerformance(){try{const{data:t,error:e}=await supabaseClient.from("call_sessions").select("agent_name").gte("start_time_egypt",(new Date).toISOString().split("T")[0]+"T00:00:00");if(e)return void console.error("Error fetching agent performance data:",e);const n={};t.forEach((t=>{const e=t.agent_name||"Unknown";n[e]=(n[e]||0)+1}));const o=Object.keys(n),a=Object.values(n),i=document.getElementById("agentPerformanceChart").getContext("2d");agentPerformanceChart&&agentPerformanceChart.destroy(),agentPerformanceChart=new Chart(i,{type:"bar",data:{labels:o,datasets:[{label:"Calls Today",data:a,backgroundColor:"rgba(78, 140, 255, 0.7)",borderColor:"#4e8cff",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{labels:{color:"#D1D5DB"}},title:{display:!0,text:"Calls per Agent (Today)",color:"#F9FAFB",font:{size:14,weight:"bold"}}},scales:{x:{ticks:{color:"#9CA3AF",maxRotation:45},grid:{display:!1}},y:{ticks:{color:"#9CA3AF"},grid:{color:"#374151"},beginAtZero:!0}}}})}catch(t){console.error("Error loading agent performance:",t)}}async function loadQuickStats(){try{const t=(new Date).toISOString().split("T")[0],{data:e,error:n}=await supabaseClient.from("call_sessions").select("*").gte("start_time_egypt",`${t}T00:00:00`).lt("start_time_egypt",`${t}T23:59:59`);if(n)return void console.error("Error fetching today's calls:",n);const o=e.filter((t=>t.completed));let a=0;o.forEach((t=>{if(t.duration_interval){const e=t.duration_interval.split(":");if(3===e.length){const t=parseInt(e[0])||0,n=parseInt(e[1])||0,o=parseInt(e[2])||0;a+=3600*t+60*n+o}}}));const i=o.length>0?a/o.length:0,r=Math.floor(i/60);document.getElementById("avgHandleTime").textContent=`${r}m`;const s=e.length>0?Math.round(o.length/e.length*100):0;document.getElementById("completionRate").textContent=`${s}%`;const l=e.filter((t=>t.call_quality&&"good"===t.call_quality.toLowerCase())).length,c=e.length>0?Math.round(l/e.length*100):0;document.getElementById("goodQualityRate").textContent=`${c}%`;const d=new Set;e.forEach((t=>{t.agent_name&&d.add(t.agent_name)})),document.getElementById("activeAgents").textContent=d.size}catch(t){console.error("Error loading quick stats:",t)}}async function loadRecentTickets(t=1){try{recentTicketsPage=t;const e=10*(t-1),n=document.getElementById("recentTicketsTbody");if(n){let t="";for(let e=0;e<10;e++)t+='<tr style="background:#fff;"><td colspan="8" style="padding:12px;"><div class="shimmer-row"></div></td></tr>';n.innerHTML=t}const o=new Date(Date.now()-6e5).toISOString(),{data:a,error:i}=await supabaseClient.from("call_sessions").select("\n                        agent_name,\n                        agent_email,\n                        scenario_id,\n                        call_quality,\n                        quality_reason,\n                        start_time_egypt,\n                        end_time_egypt,\n                        duration_interval\n                    ").eq("completed",!0).gte("end_time_egypt",o).order("end_time_egypt",{ascending:!1}).range(e,e+10-1);if(i)return void console.error("Error loading recent tickets:",i);renderRecentTicketsTable(a||[]),document.getElementById("recentTicketsPageInfo").textContent="Page "+recentTicketsPage}catch(t){console.error("loadRecentTickets error",t)}}function renderRecentTicketsTable(t){const e=document.getElementById("recentTicketsTbody");if(!e)return;if(!t||0===t.length)return void fadeUpdate(e,'<tr><td colspan="8" style="padding:16px; text-align:center; color:var(--text-color-subtle)">No recent ticket sessions in the last 10 minutes.</td></tr>');let n="";t.forEach(((t,e)=>{const o=e%2==0?"#ffffff":"#f8fafc",a=t.start_time_egypt?new Date(t.start_time_egypt).toLocaleString():"--",i=t.end_time_egypt?new Date(t.end_time_egypt).toLocaleString():"--",r=formatDuration(t.duration_interval);n+=`<tr style="background:${o};">\n                    <td style="padding:8px;">${t.agent_name||"-"}</td>\n                    <td style="padding:8px;">${t.agent_email||"-"}</td>\n                    <td style="padding:8px;">${t.scenario_id||"-"}</td>\n                    <td style="padding:8px;">${t.call_quality||"-"}</td>\n                    <td style="padding:8px;">${t.quality_reason||"-"}</td>\n                    <td style="padding:8px;">${a}</td>\n                    <td style="padding:8px;">${i}</td>\n                    <td style="padding:8px;">${r}</td>\n                </tr>`})),fadeUpdate(e,n)}function startAutoRefresh(){autoRefreshInterval=setInterval((async()=>{await loadDashboardData()}),3e4)}function stopAutoRefresh(){autoRefreshInterval&&(clearInterval(autoRefreshInterval),autoRefreshInterval=null)}function exportDashboardReport(){let t="Elevo Core Dashboard Report\n";t+=`Generated: ${(new Date).toLocaleString()}\n\n`,t+="Ticket Counts\n",t+=`Live Tickets,${document.getElementById("liveTicketsCount").textContent}\n`,t+=`Delayed Tickets,${document.getElementById("delayedTicketsCount").textContent}\n`,t+=`Recent Tickets,${document.getElementById("recentTicketsCount").textContent}\n`,t+=`Total Calls Today,${document.getElementById("totalCallsToday").textContent}\n\n`,t+="Performance Metrics\n",t+=`Average Handle Time,${document.getElementById("avgHandleTime").textContent}\n`,t+=`Completion Rate,${document.getElementById("completionRate").textContent}\n`,t+=`Good Quality Rate,${document.getElementById("goodQualityRate").textContent}\n`,t+=`Active Agents,${document.getElementById("activeAgents").textContent}\n`;const e=new Blob([t],{type:"text/csv"}),n=URL.createObjectURL(e),o=document.createElement("a");o.href=n,o.download=`elevo-dashboard-report-${(new Date).toISOString().split("T")[0]}.csv`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n),addNotification("Report exported successfully","success")}function formatDuration(t){if(null==t)return"--:--";let e=Number(t);e>1e6&&(e=Math.floor(e/1e3));const n=e%60,o=Math.floor(e/60)%60,a=Math.floor(e/3600);if(a>0){return`${String(a).padStart(2,"0")}:${String(o).padStart(2,"0")}:${String(n).padStart(2,"0")}`}return o>0?`${o}m ${n}s`:`${n}s`}function fadeUpdate(t,e){t&&(t.style.transition="opacity 0.25s ease",t.style.opacity=0,setTimeout((()=>{t.innerHTML=e,t.style.opacity=1}),260))}function startAutoRefreshRealTime(t=[],e=30){window._elevoAutoRefreshInterval&&clearInterval(window._elevoAutoRefreshInterval),Array.isArray(t)&&0!==t.length&&(t.forEach((t=>{try{t()}catch(t){console.error(t)}})),window._elevoAutoRefreshInterval=setInterval((()=>{t.forEach((t=>{try{t()}catch(t){console.error(t)}}))}),1e3*e))}function stopAutoRefreshRealTime(){window._elevoAutoRefreshInterval&&(clearInterval(window._elevoAutoRefreshInterval),window._elevoAutoRefreshInterval=null)}function debounce(t,e){let n;return function(...o){clearTimeout(n),n=setTimeout((()=>{clearTimeout(n),t(...o)}),e)}}function formatTime(t){const e=new Date-new Date(t),n=Math.floor(e/6e4),o=Math.floor(e/36e5),a=Math.floor(e/864e5);return n<1?"Just now":n<60?`${n} min ago`:o<24?`${o} hours ago`:a<7?`${a} days ago`:new Date(t).toLocaleDateString("en-US")}document.addEventListener("DOMContentLoaded",(async function(){document.getElementById("currentYear").textContent=(new Date).getFullYear();const t=await window.roleCheck.checkAdminAccess();t&&(currentUser=t,window.roleCheck.updateUserInterface(t),setupEventListeners(),initNotifications(),initSearch(),await loadDashboardData(),startAutoRefresh(),startAutoRefreshRealTime([loadTicketCounts,loadRecentTickets],30),setTimeout((()=>{addNotification("Dashboard data loaded successfully","success"),addNotification("There are 5 delayed tickets that need review","warning")}),2e3))})),window.addEventListener("beforeunload",(()=>{stopAutoRefresh(),stopAutoRefreshRealTime()}))</script>
<script>document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("userName"),t=JSON.parse(localStorage.getItem("user"));e&&t&&(e.textContent=t.name||t.email||"User"),"function"==typeof initializeDashboard&&initializeDashboard(),"function"==typeof initializeRTM&&initializeRTM(),"function"==typeof loadDashboardData&&loadDashboardData()}))</script>
</body>
</html>
