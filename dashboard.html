<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Dashboard | Leadership & Coaching</title>
    <!-- Favicon Links (Same as index.html) -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Chart.js Library (for Admin Charts) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Feather Icons (Optional, for nicer icons) -->
     <script src="https://unpkg.com/feather-icons"></script>

    <style>
        /* --- Base Styles (Keep from previous files) --- */
        :root {
            --primary-color: #3b82f6; /* Blue-500 */
            --primary-darker: #2563eb; /* Blue-600 */
            --secondary-color: #10b981; /* Emerald-500 */
            --secondary-darker: #059669; /* Emerald-600 */
            --accent-color: #f59e0b; /* Amber-500 */
            --accent-darker: #d97706; /* Amber-600 */
            --text-dark: #1f2937;
            --text-medium: #4b5563;
            --text-light: #6b7280;
            --bg-light: #f9fafb; /* Light Gray */
            --bg-white: #ffffff;
            --bg-dark: #111827; /* Dark Gray for Header/Footer */
            --border-color: #e5e7eb;
            --error-red: #ef4444;
            --success-green: #22c55e;
            --success-bg-light: #f0fdf4;
            --success-border: #bbf7d0;
            --warn-yellow: #f59e0b;
            --info-blue: #3b82f6;
            --info-bg-light: #eff6ff;
            --info-border: #bfdbfe;
            --admin-bg: #f1f5f9; /* Slightly different bg for admin */
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html { scroll-behavior: smooth; }
        body {
            background-color: var(--bg-light);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            color: var(--text-medium);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            font-size: 16px;
        }
        main { flex-grow: 1; }
        .container { max-width: 72rem; margin: 2.5rem auto; padding: 0 1.5rem; } /* Wider container for dashboard */

        /* --- Header, User Bar, Footer (Same Styles as Assessment) --- */
        .header { background-color: var(--bg-dark); color: white; padding: 1.125rem 0; text-align: center; font-size: 1.625rem; font-weight: 600; box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1); }
        .user-bar { background-color: #374151; padding: 0.625rem 1.875rem; display: flex; justify-content: space-between; align-items: center; color: #e5e7eb; font-size: 0.9375rem; }
        .user-info { display: flex; align-items: center; gap: 0.9375rem; }
        .user-info svg { opacity: 0.8; margin-right: 0.5rem; color: #9ca3af; width: 20px; height: 20px; }
        .user-details { display: flex; flex-direction: column; text-align: left; }
        .user-name { font-weight: 600; font-size: 0.9375rem; color: #f9fafb; }
        .user-email { font-size: 0.8125rem; opacity: 0.8; }
        .logout-button { background-color: var(--error-red); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; font-weight: 500; transition: all 0.3s; display: flex; align-items: center; gap: 0.375rem; font-size: 0.9375rem; }
        .logout-button svg { margin-right: 0.375rem; width: 16px; height: 16px;}
        .logout-button:hover { background-color: #dc2626; transform: translateY(-1px); }
        .logout-button:active { transform: translateY(0); }
        .footer { text-align: center; padding: 1.5625rem 1.875rem; background: var(--bg-dark); color: rgba(229, 231, 235, 0.8); margin-top: 3.125rem; font-size: 0.875rem; display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 1.5625rem; border-top: 1px solid #374151; }
        .footer-text { text-align: center; }
        .social-icons { display: flex; gap: 1.25rem; align-items: center; }
        .social-icons a { color: rgba(229, 231, 235, 0.8); text-decoration: none; display: inline-block; transition: transform 0.3s ease, color 0.3s ease; }
        .social-icons a:hover { color: #ffffff; transform: translateY(-2px); }
        .social-icons svg { width: 1.5rem; height: 1.5rem; fill: currentColor; vertical-align: middle; }

        /* --- Dashboard Specific Styles --- */
        h2 { color: var(--text-dark); font-weight: 700; margin-bottom: 1rem; font-size: 2rem; text-align: center; }
        h3 { margin: 2rem 0 1rem; font-size: 1.5rem; color: var(--text-dark); border-bottom: 2px solid var(--primary-color); padding-bottom: 0.5rem; }
        .dashboard-intro { text-align: center; font-size: 1.1rem; color: var(--text-medium); margin-bottom: 2.5rem; max-width: 600px; margin-left: auto; margin-right: auto; }

        /* Module Grid */
        .modules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Responsive grid */
            gap: 1.5rem;
        }
        .module-card {
            background-color: var(--bg-white);
            border-radius: 0.75rem;
            padding: 1.5rem 1.75rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
            border-left: 5px solid var(--primary-color); /* Accent border */
        }
        .module-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        .module-card h4 {
            font-size: 1.25rem;
            color: var(--text-dark);
            margin-bottom: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .module-card h4 i { /* For Feather Icons */
            color: var(--primary-color);
        }
        .module-card p {
            font-size: 0.95rem;
            color: var(--text-medium);
            flex-grow: 1; /* Pushes button to bottom */
            margin-bottom: 1.25rem;
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 999px; /* Pill shape */
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            align-self: flex-start; /* Align badge to the start */
        }
        .status-badge.not-started { background-color: #e5e7eb; color: #4b5563; }
        .status-badge.in-progress { background-color: var(--info-bg-light); color: var(--info-blue); border: 1px solid var(--info-border); }
        .status-badge.completed { background-color: var(--success-bg-light); color: #166534; border: 1px solid var(--success-border); }

        .module-action-button {
            background: linear-gradient(90deg, var(--secondary-color), var(--secondary-darker));
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none; /* For <a> tags */
            text-align: center;
            display: inline-flex; /* Align icon and text */
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
        }
        .module-action-button i { /* Feather icons */
             width: 16px; height: 16px;
        }

        .module-action-button:hover:not(:disabled) {
            background: linear-gradient(90deg, var(--secondary-darker), #047857); /* Darker Emerald */
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2);
            transform: translateY(-2px);
        }
        .module-action-button:disabled {
            background: #d1d5db; /* Gray-300 */
            color: #6b7280;
            cursor: not-allowed;
            opacity: 0.7;
        }
         .module-card.locked {
             border-left-color: #d1d5db;
             opacity: 0.7;
             background-color: #f3f4f6;
         }
         .module-card.locked:hover {
              transform: none;
              box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07);
         }

        /* Admin Section Styles */
        #adminDashboard {
            background-color: var(--admin-bg);
            padding: 2rem;
            margin-top: 3rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
        }
        #adminDashboard h3 {
             border-color: var(--accent-color);
             color: var(--text-dark);
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }
        .filters label { font-weight: 500; color: var(--text-medium); }
        .filters select, .filters input[type="text"] {
            padding: 0.5rem 0.8rem;
            border: 1px solid #ccc;
            border-radius: 0.375rem;
            font-size: 0.9rem;
        }
        .filters button {
             background-color: var(--accent-color);
             color: white;
             border: none;
             padding: 0.5rem 1rem;
             border-radius: 0.375rem;
             cursor: pointer;
             transition: background-color 0.3s;
             font-weight: 500;
        }
         .filters button:hover {
              background-color: var(--accent-darker);
         }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
            background-color: var(--bg-white);
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .chart-box h4 {
            text-align: center;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            color: var(--text-dark);
        }

        .table-container {
            overflow-x: auto; /* Allow horizontal scroll on small screens */
             background-color: var(--bg-white);
             border-radius: 0.5rem;
             box-shadow: 0 2px 10px rgba(0,0,0,0.05);
             padding: 0.5rem; /* Add some padding around the table */
        }
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        .admin-table th, .admin-table td {
            padding: 0.8rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .admin-table th {
            background-color: #f3f4f6; /* Light gray header */
            font-weight: 600;
            color: var(--text-dark);
        }
        .admin-table tbody tr:hover {
            background-color: #f9fafb;
        }
        .admin-table td { color: var(--text-medium); }
        .admin-status-badge {
            padding: 0.2rem 0.6rem;
            border-radius: 0.25rem;
            font-weight: 500;
            font-size: 0.8rem;
            text-transform: capitalize;
        }
        .admin-status-badge.completed, .admin-status-badge.passed { background-color: var(--success-bg-light); color: #15803d; border: 1px solid var(--success-border);}
        .admin-status-badge.failed, .admin-status-badge.needs-support { background-color: #fef2f2; color: #b91c1c; border: 1px solid #fecaca;}
        .admin-status-badge.in-progress { background-color: var(--info-bg-light); color: var(--info-blue); border: 1px solid var(--info-border); }

         #adminRestrictionMsg {
             background-color: var(--info-bg-light);
             color: var(--info-blue);
             border: 1px solid var(--info-border);
             padding: 1rem 1.5rem;
             border-radius: 0.5rem;
             margin-top: 2rem;
             text-align: center;
             font-weight: 500;
             display: flex; /* Use flex for icon alignment */
             align-items: center;
             justify-content: center;
             gap: 0.75rem;
         }
         #adminRestrictionMsg i { width: 20px; height: 20px; }

         .loading-indicator {
            text-align: center;
            padding: 2rem;
            font-size: 1.1rem;
            color: var(--text-medium);
         }

         /* --- Responsive Adjustments --- */
        @media (max-width: 768px) {
            h2 { font-size: 1.8rem; }
            h3 { font-size: 1.3rem; }
            .container { padding: 0 1rem; }
            .user-bar { padding: 0.5rem 1rem; font-size: 0.85rem; }
            .logout-button { padding: 0.4rem 0.8rem; font-size: 0.85rem;}
            .filters { flex-direction: column; align-items: stretch; }
            .filters select, .filters input, .filters button { width: 100%; }
            .charts-container { grid-template-columns: 1fr; } /* Stack charts */
        }
        @media (max-width: 480px) {
             body { font-size: 15px; }
             h2 { font-size: 1.6rem; }
             h3 { font-size: 1.2rem; }
             .dashboard-intro { font-size: 1rem; }
             .module-card { padding: 1.2rem; }
             .module-card h4 { font-size: 1.1rem; }
             .module-card p { font-size: 0.9rem; }
             .module-action-button { font-size: 0.85rem; padding: 0.5rem 1rem; }
             .admin-table { font-size: 0.85rem; }
             .admin-table th, .admin-table td { padding: 0.6rem 0.8rem; }
             #adminDashboard { padding: 1.5rem; }
             #adminRestrictionMsg { padding: 0.8rem 1rem; font-size: 0.9rem;}
             .footer { flex-direction: column; gap: 1rem; padding: 1rem; font-size: 0.8rem; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">Coaching & Leadership Course</header>

    <!-- User Bar -->
    <div class="user-bar">
         <div class="user-info">
             <i data-feather="user"></i> <!-- Feather Icon -->
             <div class="user-details">
                 <span class="user-name" id="userName">Loading...</span>
                 <span class="user-email" id="userEmail"></span>
             </div>
         </div>
         <button class="logout-button" onclick="logout()">
             <i data-feather="log-out"></i> <!-- Feather Icon -->
             <span>Logout</span>
         </button>
    </div>

    <!-- Main Content -->
    <main class="container" id="mainContainer" style="display: none;">
        <h2>👋 Welcome to Your Dashboard!</h2>
        <p class="dashboard-intro">
            Track your progress through the Coaching & Leadership course modules. Complete each section to unlock the next step in your journey.
        </p>

        <!-- Course Modules Section -->
        <section id="courseModules">
            <h3><i data-feather="layers" style="margin-right: 0.5rem; vertical-align: bottom;"></i>Course Modules</h3>
            <div class="modules-grid">
                <!-- Module Cards will be dynamically checked/updated -->
                <div class="module-card" id="module-intro" data-module-id="intro" data-next-module="coaching-skills">
                    <h4><i data-feather="play-circle"></i>Introduction to Coaching & Leadership</h4>
                    <p>Understand the core concepts, differences, and importance of coaching and leadership in today's environment.</p>
                    <span class="status-badge not-started" id="status-intro">Not Started</span>
                    <a href="introduction.html" class="module-action-button" id="action-intro">
                        <i data-feather="arrow-right-circle"></i><span>Start Module</span>
                    </a>
                </div>

                <div class="module-card locked" id="module-coaching-skills" data-module-id="coaching-skills" data-previous-module="intro" data-next-module="coaching-individuals">
                    <h4><i data-feather="tool"></i>Coaching Skills</h4>
                    <p>Develop essential coaching skills like active listening, powerful questioning, and providing effective feedback.</p>
                    <span class="status-badge not-started" id="status-coaching-skills">Not Started</span>
                    <a href="coaching_skills.html" class="module-action-button" id="action-coaching-skills" disabled>
                        <i data-feather="arrow-right-circle"></i><span>View Module</span>
                    </a>
                </div>

                <div class="module-card locked" id="module-coaching-individuals" data-module-id="coaching-individuals" data-previous-module="coaching-skills" data-next-module="coaching-team">
                     <h4><i data-feather="user-check"></i>Coaching Individuals</h4>
                     <p>Learn strategies and models for coaching individual team members for performance and development.</p>
                     <span class="status-badge not-started" id="status-coaching-individuals">Not Started</span>
                     <a href="coaching_individuals.html" class="module-action-button" id="action-coaching-individuals" disabled>
                          <i data-feather="arrow-right-circle"></i><span>View Module</span>
                     </a>
                </div>

                <div class="module-card locked" id="module-coaching-team" data-module-id="coaching-team" data-previous-module="coaching-individuals" data-next-module="coaching-yourself">
                     <h4><i data-feather="users"></i>Coaching Teams</h4>
                     <p>Explore dynamics of team coaching, fostering collaboration, and addressing group challenges.</p>
                     <span class="status-badge not-started" id="status-coaching-team">Not Started</span>
                     <a href="coaching_team.html" class="module-action-button" id="action-coaching-team" disabled>
                          <i data-feather="arrow-right-circle"></i><span>View Module</span>
                     </a>
                </div>

                 <div class="module-card locked" id="module-coaching-yourself" data-module-id="coaching-yourself" data-previous-module="coaching-team" data-next-module="action-plan">
                     <h4><i data-feather="compass"></i>Coaching Yourself</h4>
                     <p>Apply coaching principles to your own self-development, goal setting, and self-reflection.</p>
                     <span class="status-badge not-started" id="status-coaching-yourself">Not Started</span>
                     <a href="coaching_yourself.html" class="module-action-button" id="action-coaching-yourself" disabled>
                          <i data-feather="arrow-right-circle"></i><span>View Module</span>
                     </a>
                 </div>

                 <div class="module-card locked" id="module-action-plan" data-module-id="action-plan" data-previous-module="coaching-yourself" data-next-module="post-assessment"> <!-- Link to next logical step -->
                     <h4><i data-feather="clipboard"></i>Action Plan</h4>
                     <p>Create a personal action plan to implement your learnings and continue your growth as a leader and coach.</p>
                     <span class="status-badge not-started" id="status-action-plan">Not Started</span>
                     <a href="action_plan.html" class="module-action-button" id="action-action-plan" disabled>
                          <i data-feather="arrow-right-circle"></i><span>View Module</span>
                     </a>
                 </div>
            </div>
        </section>

         <!-- What's Next Section -->
         <section id="whatsNext">
             <h3><i data-feather="fast-forward" style="margin-right: 0.5rem; vertical-align: bottom;"></i>What's Next?</h3>
             <div class="modules-grid">
                 <div class="module-card locked" id="module-post-assessment" data-module-id="post-assessment" data-previous-module="action-plan" data-next-module="feedback">
                     <h4><i data-feather="check-circle"></i>Final Assessment</h4>
                     <p>Complete the final assessment to evaluate your overall understanding of the course material.</p>
                     <span class="status-badge not-started" id="status-post-assessment">Not Started</span>
                     <a href="post_assessment.html" class="module-action-button" id="action-post-assessment" disabled>
                          <i data-feather="arrow-right-circle"></i><span>Take Assessment</span>
                     </a>
                 </div>
                 <div class="module-card locked" id="module-feedback" data-module-id="feedback" data-previous-module="post-assessment">
                     <h4><i data-feather="message-square"></i>Course Feedback</h4>
                     <p>Share your valuable feedback to help us improve the course for future participants.</p>
                     <span class="status-badge not-started" id="status-feedback">Not Started</span>
                     <a href="feedback_form.html" class="module-action-button" id="action-feedback" disabled>
                          <i data-feather="arrow-right-circle"></i><span>Provide Feedback</span>
                     </a>
                 </div>
             </div>
         </section>

        <!-- Admin Dashboard Section (Hidden by default) -->
        <section id="adminDashboard" style="display: none;">
            <h3><i data-feather="bar-chart-2" style="margin-right: 0.5rem; vertical-align: bottom;"></i>Admin Analytics Dashboard</h3>

            <!-- Filters -->
            <div class="filters">
                <div>
                    <label for="statusFilter">Filter by Status:</label>
                    <select id="statusFilter">
                        <option value="all">All</option>
                        <option value="passed">Passed</option>
                        <option value="failed">Failed/Needs Support</option>
                        <!-- Add more statuses if needed -->
                    </select>
                </div>
                 <div>
                     <label for="typeFilter">Filter by Type:</label>
                     <select id="typeFilter">
                         <option value="all">All Assessment Types</option>
                         <option value="quiz_lc_main">Leadership & Coaching Quiz</option>
                         <option value="post-assessment">Final Assessment</option>
                         <!-- Add other assessment types/IDs -->
                     </select>
                 </div>
                 <div>
                     <label for="nameFilter">Filter by Name/Email:</label>
                     <input type="text" id="nameFilter" placeholder="Search name or email...">
                 </div>
                <button id="applyFiltersBtn"><i data-feather="filter" style="width:14px; height:14px; margin-right: 5px;"></i>Apply Filters</button>
            </div>

             <div id="adminLoadingIndicator" class="loading-indicator" style="display: none;">
                  <p>Loading analytics data...</p>
             </div>

             <div id="adminDataContainer" style="display: none;"> <!-- Hide until data loads -->
                 <!-- Charts -->
                 <div class="charts-container">
                     <div class="chart-box">
                         <h4>Assessment Status Overview</h4>
                         <canvas id="statusChart"></canvas>
                     </div>
                      <div class="chart-box">
                         <h4>Score Distribution (Example)</h4>
                         <canvas id="scoreChart"></canvas> <!-- Placeholder for score chart -->
                     </div>
                 </div>

                 <!-- Results Table -->
                 <div class="table-container">
                      <table class="admin-table">
                          <thead>
                              <tr>
                                  <th>User Name</th>
                                  <th>Email</th>
                                  <th>Assessment</th>
                                  <th>Status</th>
                                  <th>Score</th>
                                  <th>Submitted At</th>
                                  <th>Actions</th> <!-- Placeholder for future actions -->
                              </tr>
                          </thead>
                          <tbody id="adminTableBody">
                              <!-- Data will be populated here by JavaScript -->
                              <tr><td colspan="7" style="text-align:center;">Loading data...</td></tr>
                          </tbody>
                      </table>
                 </div>
                 <!-- Add Export Buttons Later if needed -->
                  <!-- <button id="exportExcelBtn">Export to Excel</button> -->
             </div>
        </section>

        <!-- Message for Non-Admins -->
         <p id="adminRestrictionMsg" style="display: none;">
              <i data-feather="lock"></i>
              <span>The analytics section is restricted to administrators.</span>
         </p>

    </main>

    <!-- Footer -->
    <footer class="footer">
         <span class="footer-text">© 2025 Elmenisy Leadership Coaching - All Rights Reserved</span>
         <div class="social-icons">
            <a href="https://www.linkedin.com/in/mohamedmenisy17/" target="_blank" rel="noopener noreferrer" aria-label="LinkedIn Profile"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg> </a>
            <a href="https://wa.me/201014527321" target="_blank" rel="noopener noreferrer" aria-label="WhatsApp Chat"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01s-.521.074-.792.372c-.272.296-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg> </a>
            <a href="https://www.instagram.com/mohamed_menisyy/profilecard/?igsh=d3ZwZDM4czRqMzB2" target="_blank" rel="noopener noreferrer" aria-label="Instagram Profile"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 1.172.053 1.905.33 2.46.538.7.268 1.192.64 1.64 1.092.45.447.83 1.004 1.093 1.64.208.555.485 1.288.538 2.46.058 1.265.07 1.646.07 4.85s-.012 3.584-.07 4.85c-.053 1.172-.33 1.905-.538 2.46-.268.7-.64 1.192-1.092 1.64-.447.45-.997.827-1.64 1.093-.555.208-1.288.485-2.46.538-1.265.058-1.646.07-4.85.07s-3.584-.012-4.85-.07c-1.172-.053-1.905-.33-2.46-.538-.697-.268-1.19-.64-1.64-1.093-.45-.447-.827-.997-1.093-1.64-.208-.555-.485-1.288-.538-2.46-.058-1.265-.07-1.646-.07-4.85s.012-3.584.07-4.85c.053-1.172.33-1.905.538-2.46.268-.697.64-1.19 1.093-1.64.45-.45.997-.827 1.64-1.093.555-.208 1.288.485 2.46.538 1.265-.058 1.646-.07 4.85-.07zm0-2.163c-3.259 0-3.667.014-4.947.072-1.356.06-2.31.344-3.174.732-.884.396-1.627.96-2.377 1.71-.755.752-1.318 1.494-1.716 2.378-.386.863-.67 1.818-.73 3.172C.014 8.333 0 8.741 0 12s.014 3.667.072 4.947c.06 1.356.344 2.31.73 3.174.396.884.96 1.627 1.716 2.377.752.755 1.494 1.318 2.378 1.716.863.386 1.818.67 3.172.73 1.28.058 1.688.072 4.947.072s3.667-.014 4.947-.072c1.356-.06 2.31-.344 3.174-.73.884-.396 1.627-.96 2.377-1.716.755-.752 1.318-1.494 1.716-2.378.386.863.67-1.818.73-3.172.058-1.28.072-1.688.072-4.947s-.014-3.667-.072-4.947c-.06-1.356-.344-2.31-.73-3.174-.396-.884-.96-1.627-1.716-2.377-.752-.755-1.494-1.318-2.378-1.716-.863-.386-1.818-.67-3.172-.73C15.667.014 15.259 0 12 0zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.162 6.162 6.162 6.162-2.759 6.162-6.162S15.403 5.838 12 5.838zm0 10.333c-2.306 0-4.171-1.865-4.171-4.171s1.865-4.171 4.171-4.171 4.171 1.865 4.171 4.171-1.865 4.171-4.171 4.171zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg> </a>
        </div>
    </footer>

    <script>
        // --- Supabase Configuration ---
        const SUPABASE_URL = 'https://lgcutmuspcaralydycmg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnY3V0bXVzcGNhcmFseWR5Y21nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0NDY3MDEsImV4cCI6MjA2MTAyMjcwMX0.3u5Y7pkH2NNnnoGLMWVfAa5b8fq88o1itRYnG1K38tE';
        let supabase = null;

        // --- Unified Keys & Configuration ---
        const LOGGED_IN_KEY = 'isUserLoggedIn';
        const CURRENT_USER_KEY = 'currentUser';
        const SIGNUP_FLAG_KEY = 'hasSignedUpBefore'; // Keep if used for redirection logic
        const ADMIN_EMAIL = 'M.elsayed@thechefz.co'; // <<< Your Admin Email

        // --- Module/Assessment IDs (Must match data-module-id and potentially DB identifiers) ---
        // Define IDs used to track progress for each step
        const MODULE_IDS = {
            INTRO: 'intro', // Corresponds to intro module/assessment
            SKILLS: 'coaching-skills',
            INDIVIDUALS: 'coaching-individuals',
            TEAM: 'coaching-team',
            YOURSELF: 'coaching-yourself',
            ACTION_PLAN: 'action-plan',
            POST_ASSESSMENT: 'post-assessment',
            FEEDBACK: 'feedback'
            // Add IDs for assessments linked to these modules if they are different
            // e.g., INTRO_ASSESSMENT_ID: 'quiz_lc_main'
        };

        // --- DOM Element References ---
        let userNameDisplay, userEmailDisplay, mainContainer, adminDashboardSection,
            adminRestrictionMsg, adminTableBody, statusChartCanvas, scoreChartCanvas,
            adminLoadingIndicator, adminDataContainer, applyFiltersBtn, statusFilter, typeFilter, nameFilter;

        // --- Chart Instances ---
        let statusChartInstance = null;
        let scoreChartInstance = null;

        // --- State ---
        let currentUser = null;
        let allAssessmentData = []; // To store data for admin view

        // Initialize Supabase Client
        try {
            if (window.supabase && window.supabase.createClient) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log("Supabase client initialized successfully on Dashboard page.");
            } else { throw new Error("Supabase library not found."); }
        } catch (error) { console.error("CRITICAL ERROR initializing Supabase:", error); }

        // ***** ---> IMMEDIATE REDIRECTION LOGIC (Important for security) <--- *****
        console.log("%cDashboard Page: Running IMMEDIATE redirection check...", "color: purple; font-weight: bold;");
        function quickCheckCurrentUser() { const data = localStorage.getItem(CURRENT_USER_KEY); return data && data.startsWith('{') && data.endsWith('}'); }
        const isLoggedIn_immediate_dash = localStorage.getItem(LOGGED_IN_KEY) === 'true' && quickCheckCurrentUser();
        const currentPage_immediate_dash = window.location.pathname.split('/').pop() || 'dashboard.html';
        console.log(`Dashboard Page IMMEDIATE Check: isLoggedIn=${isLoggedIn_immediate_dash}, currentPage=${currentPage_immediate_dash}`);
        if (!isLoggedIn_immediate_dash) {
            const hasSignedUp_immediate_dash = localStorage.getItem(SIGNUP_FLAG_KEY) === 'true';
            const targetUrl_dash = hasSignedUp_immediate_dash ? 'login.html' : 'signup.html';
            console.error(`%cDashboard Page IMMEDIATE Redirect: Not logged in. Redirecting to ${targetUrl_dash}...`, "color: orange;");
            window.location.replace(targetUrl_dash); // Use replace to prevent back button
            throw new Error("Redirecting user: Not logged in."); // Stop script execution
        } else {
            console.log("%cDashboard Page IMMEDIATE Check: User IS logged in. Proceeding.", "color: green;");
        }
        // ***** ---> END IMMEDIATE REDIRECTION LOGIC <--- *****


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("%cDashboard page: DOMContentLoaded event fired.", "color: green;");
            mainContainer = document.getElementById('mainContainer');
            if (!supabase) {
                console.error("Supabase client failed to initialize. Stopping page load.");
                if (mainContainer) mainContainer.innerHTML = '<p style="color:red; text-align:center; padding: 2rem;">Connection Error. Cannot load dashboard.</p>';
                return;
            }

            // Activate Feather Icons
            feather.replace();

            try {
                // Assign DOM elements
                userNameDisplay = document.getElementById('userName');
                userEmailDisplay = document.getElementById('userEmail');
                adminDashboardSection = document.getElementById('adminDashboard');
                adminRestrictionMsg = document.getElementById('adminRestrictionMsg');
                adminTableBody = document.getElementById('adminTableBody');
                statusChartCanvas = document.getElementById('statusChart');
                scoreChartCanvas = document.getElementById('scoreChart'); // Assuming you have this canvas
                adminLoadingIndicator = document.getElementById('adminLoadingIndicator');
                adminDataContainer = document.getElementById('adminDataContainer');
                applyFiltersBtn = document.getElementById('applyFiltersBtn');
                statusFilter = document.getElementById('statusFilter');
                typeFilter = document.getElementById('typeFilter');
                nameFilter = document.getElementById('nameFilter');


                // Check essential elements
                if (!mainContainer || !userNameDisplay || !userEmailDisplay || !adminDashboardSection || !adminRestrictionMsg) {
                    throw new Error("Essential DOM elements for dashboard page not found!");
                }

                currentUser = getCurrentUser(); // Get user info early
                if (!currentUser || !currentUser.id || !currentUser.email) {
                    console.error("Dashboard DOMContentLoaded: Failsafe check - User data invalid/missing! Redirecting.");
                    logout(); // Use logout function to handle redirection
                    return;
                }

                console.log(`%cDashboard DOMContentLoaded: User verified (${currentUser.email}, ID: ${currentUser.id}). Initializing dashboard.`, "color: green;");
                displayUserInfo(currentUser); // Display user info first
                 mainContainer.style.display = 'block'; // Show main content area

                await initializeDashboard(); // Fetch data and update UI

                // Add event listener for filter button *after* initializing
                 if (applyFiltersBtn) {
                    applyFiltersBtn.addEventListener('click', applyAdminFilters);
                 } else {
                    console.warn("Filter button not found.");
                 }


                console.log("Dashboard page content successfully initialized and displayed.");

            } catch (error) {
                 console.error("CRITICAL ERROR during Dashboard DOMContentLoaded or initializeDashboard:", error);
                 if(mainContainer){
                     mainContainer.innerHTML = `<p style="color: red; text-align:center; padding: 2rem;">An error occurred loading the dashboard. Please refresh or contact support. Error: ${error.message}</p>`;
                     mainContainer.style.display = 'block';
                 } else {
                     document.body.innerHTML = `<p style="color: red; padding: 20px;">Critical Error: Page structure incomplete or major script error. (${error.message})</p>`;
                 }
            }
        });

        // --- Main Initialization Function ---
        async function initializeDashboard() {
            console.log("Initializing dashboard content...");
            try {
                // 1. Fetch progress for the CURRENT user to update module statuses
                const userProgress = await fetchUserProgress(currentUser.id);
                console.log("Fetched user progress:", userProgress);
                updateModuleCards(userProgress);

                // 2. Check if the current user is the Admin
                if (currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                    console.log("User is ADMIN. Initializing admin section...");
                    adminDashboardSection.style.display = 'block';
                    adminRestrictionMsg.style.display = 'none';
                    adminLoadingIndicator.style.display = 'block';
                    adminDataContainer.style.display = 'none'; // Hide data area while loading

                    // 3. Fetch ALL assessment data needed for the admin view
                    allAssessmentData = await fetchAllAssessmentData(); // Fetch and store globally
                    console.log("Fetched all assessment data for admin:", allAssessmentData);


                     if (allAssessmentData && allAssessmentData.length > 0) {
                         populateAdminTable(allAssessmentData); // Populate with all data initially
                         renderCharts(allAssessmentData);
                         adminLoadingIndicator.style.display = 'none';
                         adminDataContainer.style.display = 'block'; // Show data area
                     } else {
                         adminLoadingIndicator.innerHTML = '<p>No assessment data found.</p>';
                         adminTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No assessment data available.</td></tr>';
                         // Optionally hide charts or show empty state
                     }


                } else {
                    console.log("User is not admin. Hiding admin section.");
                    adminDashboardSection.style.display = 'none';
                    adminRestrictionMsg.style.display = 'block';
                     // Activate icons in the restriction message too
                     feather.replace();
                }
            } catch (error) {
                console.error("Error initializing dashboard:", error);
                showDashboardError(`Failed to load dashboard data: ${error.message}`);
                 if (adminLoadingIndicator) adminLoadingIndicator.style.display = 'none';
                 if (currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                      adminTableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; color: var(--error-red);">Failed to load data: ${error.message}</td></tr>`;
                      adminDataContainer.style.display = 'block'; // Show the table area with the error
                 }
            }
        }

         // --- Data Fetching Functions ---

        // Fetches progress relevant for the *current* user's dashboard view
        async function fetchUserProgress(userId) {
            if (!supabase || !userId) return []; // Return empty if no supabase or user ID
            try {
                // Fetch summary status from 'assessments' for this user
                // We need to know which assessments (linked to modules) are 'completed'
                 console.log(`Fetching assessment summaries for user ID: ${userId}`);
                const { data, error } = await supabase
                    .from('assessments') // Assuming 'assessments' table stores the final status per quiz/section
                    .select('question_id, completion_status, is_correct') // Select relevant fields
                    .eq('user_id', userId);

                if (error) throw error;
                console.log(`Supabase response for user progress (assessments):`, data);

                 // Process data into a more usable format, e.g., { 'quiz_lc_main': 'completed', 'post-assessment': 'passed' }
                 const progressMap = {};
                 if (data) {
                     data.forEach(item => {
                         // Use a combined status if possible (e.g., passed/failed takes precedence over just completed)
                         let status = item.completion_status;
                         if (item.is_correct === 'passed' || item.is_correct === 'failed') {
                             status = item.is_correct; // Use passed/failed if available
                         }
                         progressMap[item.question_id] = status || 'unknown'; // Store status by assessment/question_id
                     });
                 }
                 console.log("Processed Progress Map:", progressMap);
                 return progressMap; // Return the map { assessment_id: status }

            } catch (error) {
                console.error("Error fetching user progress:", error);
                showDashboardError(`Could not load your course progress: ${error.message}`);
                return {}; // Return empty object on error
            }
        }

         // Fetches all data needed for the ADMIN dashboard
         async function fetchAllAssessmentData() {
             if (!supabase) return [];
             try {
                 console.log("Fetching all assessment data for admin...");
                  // Fetch data from 'assessments' table. Select all columns needed for the table and charts.
                  // Order by submission date or user name if desired.
                 const { data, error } = await supabase
                     .from('assessments')
                     .select('user_id, name, user_email, question_id, question_text, score, is_correct, completion_status, submitted_at')
                     .order('submitted_at', { ascending: false }); // Example: order by most recent

                 if (error) throw error;
                  console.log("Supabase response for all assessment data:", data);
                 return data || []; // Return data or empty array

             } catch (error) {
                 console.error("Error fetching all assessment data:", error);
                  showDashboardError(`Could not load admin analytics data: ${error.message}`);
                 return []; // Return empty array on error
             }
         }


        // --- UI Update Functions ---

        function updateModuleCards(progressMap) {
            console.log("Updating module cards with progress:", progressMap);
            const moduleCards = document.querySelectorAll('.module-card');
            let previousModuleCompleted = true; // Start with true to unlock the first module

            moduleCards.forEach(card => {
                const moduleId = card.dataset.moduleId; // e.g., 'intro', 'coaching-skills'
                 // *** IMPORTANT: Determine which assessment ID corresponds to this module completion ***
                 // This mapping might need adjustment based on your actual `question_id` values in the 'assessments' table
                 let associatedAssessmentId = moduleId; // Simple assumption: module ID is the assessment ID
                 if (moduleId === MODULE_IDS.INTRO) associatedAssessmentId = 'quiz_lc_main'; // Example explicit mapping
                 if (moduleId === MODULE_IDS.POST_ASSESSMENT) associatedAssessmentId = 'post-assessment'; // Example explicit mapping
                 // Add other mappings if needed

                const status = progressMap[associatedAssessmentId] || 'not-started'; // Get status from fetched data
                const statusBadge = card.querySelector('.status-badge');
                const actionButton = card.querySelector('.module-action-button');
                 const cardIcon = card.querySelector('h4 i'); // Get the icon

                // Update Status Badge
                if (statusBadge) {
                    statusBadge.textContent = status.replace('-', ' '); // Make it readable
                    statusBadge.className = 'status-badge'; // Reset classes
                     if (status === 'completed' || status === 'passed' || status === 'failed') { // Treat passed/failed also as completed for unlocking
                        statusBadge.classList.add('completed');
                     } else if (status === 'in-progress') { // You might need a way to track 'in-progress'
                         statusBadge.classList.add('in-progress');
                     } else {
                         statusBadge.classList.add('not-started');
                    }
                }

                // Update Button State and Card Lock State (Sequential Logic)
                const isCompleted = (status === 'completed' || status === 'passed' || status === 'failed');

                if (previousModuleCompleted) {
                    card.classList.remove('locked');
                    if (actionButton) {
                        actionButton.disabled = false;
                         // Change text/icon based on status
                         if (isCompleted) {
                             actionButton.innerHTML = `<i data-feather="eye"></i><span>View Module</span>`;
                             if(cardIcon) cardIcon.setAttribute('data-feather', 'check-square'); // Change icon if completed
                         } else {
                             actionButton.innerHTML = `<i data-feather="arrow-right-circle"></i><span>${status === 'in-progress' ? 'Continue' : 'Start'} Module</span>`;
                             if(cardIcon) cardIcon.setAttribute('data-feather', 'play-circle'); // Default icon
                         }
                    }
                } else {
                    card.classList.add('locked');
                    if (actionButton) {
                        actionButton.disabled = true;
                        actionButton.innerHTML = `<i data-feather="lock"></i><span>Locked</span>`;
                         if(cardIcon) cardIcon.setAttribute('data-feather', 'lock'); // Lock icon
                    }
                }

                // Update for next iteration: the next module requires *this* one to be completed
                previousModuleCompleted = isCompleted;

                 // Re-apply feather icons after changing attributes/innerHTML
                 feather.replace();
            });
             console.log("Module cards updated.");
        }


        // --- Admin Section Functions ---

        function populateAdminTable(data) {
            if (!adminTableBody) return;
            adminTableBody.innerHTML = ''; // Clear previous data

            if (!data || data.length === 0) {
                adminTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No matching assessment data found.</td></tr>';
                return;
            }

            data.forEach(item => {
                const row = adminTableBody.insertRow();

                // Format status for display
                let displayStatus = item.is_correct || item.completion_status || 'N/A';
                let statusClass = displayStatus.toLowerCase().replace(' ', '-'); // e.g., needs-support

                row.innerHTML = `
                    <td>${item.name || 'N/A'}</td>
                    <td>${item.user_email || 'N/A'}</td>
                    <td>${item.question_text || item.question_id || 'N/A'}</td>
                    <td><span class="admin-status-badge ${statusClass}">${displayStatus.replace('-', ' ')}</span></td>
                    <td>${item.score ?? 'N/A'}</td>
                    <td>${item.submitted_at ? new Date(item.submitted_at).toLocaleDateString() : 'N/A'}</td>
                    <td><button class="view-details-btn" data-userid="${item.user_id}" data-assessmentid="${item.question_id}" style="font-size: 0.8em; padding: 3px 6px; cursor:pointer;" title="View Details (Not Implemented Yet)"><i data-feather="eye" style="width:12px; height:12px;"></i></button></td>
                `;
            });
             // Activate icons in the table
             feather.replace();
             console.log("Admin table populated.");
        }

        function applyAdminFilters() {
             if (!allAssessmentData) return; // No data to filter

             console.log("Applying filters...");
             const statusValue = statusFilter.value;
             const typeValue = typeFilter.value;
             const nameValue = nameFilter.value.toLowerCase().trim();

             const filteredData = allAssessmentData.filter(item => {
                 // Status Filter
                 let statusMatch = true;
                 if (statusValue !== 'all') {
                     // Handle combined "failed/needs-support" category if needed
                     if (statusValue === 'failed') {
                          statusMatch = (item.is_correct === 'failed' || item.completion_status === 'failed' || item.is_correct === 'needs-support');
                     } else {
                          statusMatch = (item.is_correct === statusValue || item.completion_status === statusValue);
                     }
                 }

                 // Type Filter (matches question_id which we use as assessment type identifier)
                 const typeMatch = typeValue === 'all' || item.question_id === typeValue;

                 // Name/Email Filter
                 const nameMatch = nameValue === '' ||
                                   (item.name && item.name.toLowerCase().includes(nameValue)) ||
                                   (item.user_email && item.user_email.toLowerCase().includes(nameValue));

                 return statusMatch && typeMatch && nameMatch;
             });

             console.log("Filtered Data:", filteredData);
             populateAdminTable(filteredData);
             renderCharts(filteredData); // Re-render charts with filtered data
         }


         function renderCharts(data) {
             if (!statusChartCanvas || !scoreChartCanvas || !data) return; // Ensure canvases and data exist

             // --- Status Chart (Pie Chart) ---
             const statusCounts = data.reduce((acc, item) => {
                 let status = item.is_correct || item.completion_status || 'unknown';
                 // Group 'failed' and 'needs-support' if desired
                 if (status === 'needs-support') status = 'failed';
                 acc[status] = (acc[status] || 0) + 1;
                 return acc;
             }, {});

             const statusLabels = Object.keys(statusCounts);
             const statusData = Object.values(statusCounts);
             const statusColors = statusLabels.map(label => {
                 if (label === 'passed' || label === 'completed') return 'rgba(34, 197, 94, 0.7)'; // Green
                 if (label === 'failed') return 'rgba(239, 68, 68, 0.7)'; // Red
                 if (label === 'in-progress') return 'rgba(59, 130, 246, 0.7)'; // Blue
                 return 'rgba(156, 163, 175, 0.7)'; // Gray
             });

             // Destroy previous chart instance if it exists
             if (statusChartInstance) {
                 statusChartInstance.destroy();
             }

             statusChartInstance = new Chart(statusChartCanvas, {
                 type: 'pie',
                 data: {
                     labels: statusLabels.map(l => l.replace('-', ' ').charAt(0).toUpperCase() + l.slice(1)), // Capitalize
                     datasets: [{
                         label: 'Assessment Status',
                         data: statusData,
                         backgroundColor: statusColors,
                         borderColor: '#ffffff',
                         borderWidth: 1
                     }]
                 },
                 options: {
                     responsive: true,
                     plugins: {
                         legend: {
                             position: 'top',
                         },
                         tooltip: {
                              callbacks: {
                                 label: function(context) {
                                     let label = context.label || '';
                                     if (label) {
                                         label += ': ';
                                     }
                                     if (context.parsed !== null) {
                                         label += context.parsed;
                                         const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                         const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) + '%' : '0%';
                                          label += ` (${percentage})`;
                                     }
                                     return label;
                                 }
                             }
                         }
                     }
                 }
             });

             // --- Score Distribution Chart (Bar Chart - Example) ---
              // This needs adjustment based on how scores are structured and what you want to show
              // Example: Group scores into ranges (0-20, 21-40, etc.)
             const scoreCounts = data.reduce((acc, item) => {
                  const score = item.score ?? -1; // Handle null scores
                  let range = 'N/A';
                  if (score >= 0 && score <= 49) range = '0-49%'; // Example ranges (adjust based on max score)
                  else if (score >= 50 && score <= 74) range = '50-74%';
                  else if (score >= 75 && score <= 100) range = '75-100%';
                  // This assumes score is a percentage or comparable value. Adapt if needed.
                  acc[range] = (acc[range] || 0) + 1;
                  return acc;
              }, {});


             const scoreLabels = Object.keys(scoreCounts).sort(); // Sort ranges
             const scoreData = scoreLabels.map(label => scoreCounts[label]);

             if (scoreChartInstance) {
                  scoreChartInstance.destroy();
             }

             scoreChartInstance = new Chart(scoreChartCanvas, {
                  type: 'bar',
                  data: {
                      labels: scoreLabels,
                      datasets: [{
                          label: 'Number of Users by Score Range',
                          data: scoreData,
                          backgroundColor: 'rgba(245, 158, 11, 0.7)', // Amber color
                          borderColor: 'rgba(217, 119, 6, 1)',
                          borderWidth: 1
                      }]
                  },
                  options: {
                      responsive: true,
                      scales: {
                          y: {
                              beginAtZero: true,
                              title: { display: true, text: 'Number of Users' }
                          },
                           x: {
                               title: { display: true, text: 'Score Range (%)' }
                           }
                      },
                      plugins: {
                          legend: { display: false } // Hide legend for bar chart if only one dataset
                      }
                  }
              });


             console.log("Charts rendered/updated.");
         }


        // --- Utility Functions ---
        function getCurrentUser() {
             try { const userData = localStorage.getItem(CURRENT_USER_KEY); if (!userData) return null; const user = JSON.parse(userData); if (user && typeof user === 'object' && user.email && user.id) { if (!user.name) user.name = user.email.split('@')[0]; return user; } else { console.warn("Stored user data is invalid or missing ID. Clearing."); localStorage.removeItem(CURRENT_USER_KEY); localStorage.removeItem(LOGGED_IN_KEY); return null; } } catch (e) { console.error("Error parsing current user data:", e); localStorage.removeItem(CURRENT_USER_KEY); localStorage.removeItem(LOGGED_IN_KEY); return null; }
         }
        function displayUserInfo(currentUserInfo) {
             try { let uN = 'User'; let uE = ''; if (currentUserInfo) { uN = currentUserInfo.name || currentUserInfo.email.split('@')[0]; uE = currentUserInfo.email || ''; } if (userNameDisplay) userNameDisplay.textContent = `${uN}`; if (userEmailDisplay) userEmailDisplay.textContent = uE; } catch (err) { console.error("Error in displayUserInfo:", err); if (userNameDisplay) userNameDisplay.textContent = 'Welcome'; if (userEmailDisplay) userEmailDisplay.textContent = ''; }
         }
        function logout() {
             try { localStorage.removeItem(LOGGED_IN_KEY); localStorage.removeItem(CURRENT_USER_KEY); console.log("User logged out from Dashboard page, relevant keys cleared."); window.location.href = 'login.html'; } catch (e) { console.error("Logout error:", e); window.location.href = 'login.html'; }
         }

        // Function to display errors on the dashboard
         function showDashboardError(message) {
              console.error("Dashboard Error:", message);
              // You could display this in a dedicated error div on the page if needed
              // For now, it logs to console.
              // Example: const errorDiv = document.getElementById('dashboardError');
              // if (errorDiv) errorDiv.textContent = message;
         }

    </script>
</body>
</html>
