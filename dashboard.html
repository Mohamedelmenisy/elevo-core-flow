<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Coaching & Leadership</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- Base Styles (Enhanced) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f8fafc; margin: 0; padding: 0; line-height: 1.6; color: #374151; display: flex; flex-direction: column; min-height: 100vh; }
        main { flex-grow: 1; display: flex; justify-content: center; align-items: flex-start; flex-direction: column; width: 100%; max-width: 1000px; margin: 20px auto; padding: 0 20px; /* Adjusted padding */ }
        .header { background: linear-gradient(90deg, #2c3e50, #34495e); color: white; padding: 18px 0; text-align: center; font-size: 26px; font-weight: 600; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); width: 100%; border-bottom: 3px solid #3498db; }
        .user-bar { background-color: #ffffff; padding: 12px 30px; display: flex; justify-content: space-between; align-items: center; color: #4b5563; font-size: 15px; width: 100%; border-bottom: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-info svg { color: #3498db; opacity: 1; }
        .user-details-bar { display: flex; flex-direction: column; }
        .user-name-bar { font-weight: 600; font-size: 16px; color: #1f2937; }
        .user-email-bar { font-size: 13px; opacity: 0.8; color: #6b7280; }
        .logout-button { background-color: #ef4444; color: white; border: none; padding: 9px 18px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; }
        .logout-button:hover { background-color: #dc2626; box-shadow: 0 2px 5px rgba(239, 68, 68, 0.3); transform: translateY(-1px); }
        .logout-button:active { transform: translateY(0); }
        .footer { text-align: center; padding: 25px 30px; background: #f9fafb; color: #6b7280; margin-top: auto; font-size: 14px; width: 100%; border-top: 1px solid #e5e7eb; }

        /* --- Dashboard & Assessment Container Styles --- */
        .dashboard-container, #assessmentSection {
            background: white;
            padding: 35px 45px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); /* Subtle shadow */
            border-radius: 12px;
            width: 100%;
            margin-bottom: 35px;
            text-align: left;
            opacity: 0; /* Initially hidden for fade-in */
            transition: opacity 0.7s ease-in-out;
             border: 1px solid #e5e7eb;
        }
        .dashboard-container.fade-in, #assessmentSection.fade-in { opacity: 1; }
        .dashboard-container h2, #assessmentSection h2 {
            color: #1f2937;
            margin-bottom: 25px;
            font-size: 28px; /* Slightly larger */
            font-weight: 600;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 15px;
        }
         .dashboard-user-details {
            background-color: #f9fafb; /* Lighter bg */
            padding: 18px 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 18px;
             border: 1px solid #e5e7eb;
        }
        .dashboard-user-details svg { color: #3b82f6; width: 36px; height: 36px; }
        .dashboard-user-info { font-size: 17px; color: #374151; }
        .dashboard-user-info strong { font-weight: 600; color: #111827; }

        /* --- Course Section Styles --- */
        .course-sections h3 { color: #1f2937; margin-top: 35px; margin-bottom: 20px; font-size: 22px; font-weight: 600; }
        .course-section { background-color: #ffffff; border: 1px solid #e5e7eb; padding: 18px 25px; margin-bottom: 18px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; transition: box-shadow 0.3s ease, transform 0.2s ease, border-color 0.3s ease; flex-wrap: wrap; gap: 15px; }
        .course-section:hover { box-shadow: 0 4px 12px rgba(0,0,0, 0.08); transform: translateY(-2px); border-left: 4px solid #3b82f6; padding-left: 22px; } /* Added left border on hover */
        .section-title { font-size: 18px; font-weight: 500; color: #374151; flex-grow: 1; margin-right: 20px; }
        .section-progress { display: flex; align-items: center; gap: 18px; flex-shrink: 0; flex-basis: 300px; /* Slightly wider */ }
        .progress-bar-container { width: 160px; /* Wider bar */ height: 12px; background-color: #e5e7eb; border-radius: 6px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #60a5fa, #3b82f6); border-radius: 6px; transition: width 0.8s cubic-bezier(0.25, 0.1, 0.25, 1); } /* Smoother cubic-bezier transition */
        .progress-text { font-size: 14px; color: #6b7280; min-width: 90px; text-align: right; font-weight: 500; }
        .section-link { background-color: #3b82f6; color: white; padding: 8px 15px; border-radius: 6px; text-decoration: none; font-size: 14px; font-weight: 500; transition: background-color 0.3s, transform 0.2s ease, box-shadow 0.3s ease; white-space: nowrap; }
        .section-link:hover { background-color: #2563eb; transform: translateY(-1px); box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3); }
        /* Button styles for different states */
         .section-link.status-review { background-color: #10b981; }
         .section-link.status-review:hover { background-color: #059669; box-shadow: 0 2px 5px rgba(16, 185, 129, 0.3); }
         .section-link.status-continue { background-color: #f59e0b; }
         .section-link.status-continue:hover { background-color: #d97706; box-shadow: 0 2px 5px rgba(245, 158, 11, 0.3); }

        /* --- Pre-Course Assessment Styles --- */
        #assessmentSection { display: none; }
        #assessmentSection .intro-note {
            background-color: #eff6ff; /* Light blue */
            border-left: 5px solid #3b82f6;
            padding: 18px 25px;
            margin-bottom: 30px;
            border-radius: 6px;
            font-size: 16px;
            color: #374151;
            line-height: 1.7;
        }
        #assessmentForm .form-group { margin-bottom: 30px; }
        #assessmentForm label { display: block; margin-bottom: 10px; font-weight: 600; color: #374151; font-size: 17px; }
        #assessmentForm textarea, #assessmentForm input[type="number"], #assessmentForm select {
            width: 100%;
            padding: 14px 16px; /* More padding */
            border: 1px solid #d1d5db; /* Slightly darker border */
            border-radius: 8px; /* More rounded */
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
            color: #1f2937;
        }
        #assessmentForm textarea { min-height: 120px; resize: vertical; }
        #assessmentForm textarea:focus, #assessmentForm input[type="number"]:focus, #assessmentForm select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
            outline: none;
        }
        #assessmentForm .input-meta-info { display: flex; justify-content: space-between; align-items: center; margin-top: 6px; }
        #assessmentForm .word-count-info { font-size: 13px; color: #6b7280; }
        #assessmentForm .paste-warning { font-size: 13px; color: #f97316; /* Orange warning */ display: none; }
        #assessmentForm .error-message { color: #ef4444; font-size: 14px; margin-top: 8px; display: none; font-weight: 500;}
        #assessmentForm input.invalid, #assessmentForm textarea.invalid { border-color: #ef4444; }
        #assessmentSubmitBtn {
            background-color: #10b981; /* Emerald green */
            color: white;
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
        }
        #assessmentSubmitBtn:hover { background-color: #059669; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2); }
        #assessmentSubmitBtn:disabled { background-color: #9ca3af; cursor: not-allowed; transform: none; box-shadow: none;}

        /* Success Popup */
        #assessmentSuccessPopup {
            display: none; position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%);
            background-color: white; padding: 45px 50px; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); z-index: 1000; text-align: center;
            border-top: 6px solid #10b981; min-width: 350px;
        }
         #assessmentSuccessPopup p { font-size: 19px; color: #374151; margin-bottom: 30px; line-height: 1.6; }
         #assessmentSuccessPopup button {
            background-color: #3b82f6; color: white; padding: 12px 25px; border: none;
            border-radius: 6px; cursor: pointer; font-size: 17px; transition: background-color 0.3s; font-weight: 500;
         }
         #assessmentSuccessPopup button:hover { background-color: #2563eb; }
         .popup-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 999; }


        /* --- Admin Section Styles --- */
        #adminSection {
            background-color: #fef3c7; /* Light yellow for admin */ border: 1px solid #fcd34d; border-radius: 12px;
            padding: 35px 45px; margin-top: 25px; width: 100%; display: none; opacity: 0;
            transition: opacity 0.7s ease-in-out;
        }
        #adminSection.fade-in { opacity: 1; }
        #adminSection h3 { color: #b45309; /* Dark yellow/brown */ margin-bottom: 25px; font-size: 24px; border-bottom: 2px solid #fcd34d; padding-bottom: 15px; display: flex; align-items: center; gap: 10px; font-weight: 600; }
        #adminSection h3 svg { color: #b45309; }
        /* Updated Admin Note */
        .admin-note {
            font-size: 15px; color: #78350f; background-color: #fffbeb;
            border: 1px solid #fef08a; padding: 15px 20px; border-radius: 6px;
            margin-bottom: 30px; line-height: 1.7;
        }
        /* Table for Admin's OWN Progress */
        .admin-self-progress-table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }
        .admin-self-progress-table th, .admin-self-progress-table td { border: 1px solid #fde68a; padding: 12px 15px; text-align: left; font-size: 15px; word-wrap: break-word; }
        .admin-self-progress-table th { background-color: #fef9c3; color: #92400e; font-weight: 600; }
        .admin-self-progress-table td { background-color: #fffbeb; color: #374151;}
        .admin-self-progress-table th:nth-child(1) { width: 40%; } /* Section Title */
        .admin-self-progress-table th:nth-child(2) { width: 25%; text-align: center;} /* Progress */
        .admin-self-progress-table th:nth-child(3) { width: 35%; } /* Status */
        .admin-self-progress-table td:nth-child(2) { text-align: center; font-weight: 500;}
        /* Admin Analysis Styles (Existing - for self-analysis) */
        .admin-analysis-section { margin-top: 35px; border-top: 1px dashed #fcd34d; padding-top: 30px; }
        .admin-analysis-section h4 { color: #b45309; font-size: 20px; margin-bottom: 20px; font-weight: 600; }
        #adminChartContainer { max-width: 500px; margin: 0 auto 30px auto; } /* Center chart */
        #adminAssessmentDetails { background-color: #fffbeb; border: 1px solid #fef08a; padding: 20px; border-radius: 8px; margin-top: 20px; }
        #adminAssessmentDetails h5 { color: #92400e; margin-bottom: 15px; font-size: 17px; border-bottom: 1px solid #fde68a; padding-bottom: 8px; }
        #adminAssessmentDetails dl { margin: 0; }
        #adminAssessmentDetails dt { font-weight: 600; color: #78350f; margin-top: 12px; font-size: 15px; }
        #adminAssessmentDetails dd { margin-left: 0; margin-bottom: 10px; color: #374151; font-size: 14px; padding-left: 10px; border-left: 3px solid #fcd34d; background: #fef9c3; padding-top: 5px; padding-bottom: 5px; border-radius: 0 4px 4px 0;}
        #adminAssessmentDetails dd pre { white-space: pre-wrap; word-wrap: break-word; font-family: inherit; font-size: inherit; margin:0; } /* Preserve formatting */
        #adminProgressAnalysis p { font-size: 16px; margin-bottom: 10px; }
        #adminProgressAnalysis .progress-value { font-weight: bold; color: #1f2937; }
        #adminProgressAnalysis .feedback-good { color: #059669; font-weight: bold; background-color: #d1fae5; padding: 8px 12px; border-radius: 6px; display: inline-block; }
        #adminProgressAnalysis .feedback-neutral { color: #4b5563; font-style: italic; }


         /* Loading Message */
         #loadingMessage { text-align: center; padding: 60px 20px; font-size: 20px; color: #6b7280; width: 100%; }

         /* Responsive Adjustments */
         @media (max-width: 768px) {
             main { padding: 0 15px; margin: 15px auto; }
             .dashboard-container, #assessmentSection, #adminSection { padding: 25px 30px; }
             .header { font-size: 22px; padding: 15px 0; }
             .user-bar { padding: 10px 20px; }
             /* Adjusted table class name */
             .admin-self-progress-table th, .admin-self-progress-table td { font-size: 14px; padding: 10px; }
             #adminChartContainer { max-width: 100%; }
         }
         @media (max-width: 600px) {
             .dashboard-container, #assessmentSection, #adminSection { padding: 20px; }
             .course-section { flex-direction: column; align-items: flex-start; padding: 15px; }
             .section-title { margin-right: 0; margin-bottom: 12px; font-size: 17px;}
             .section-progress { flex-basis: auto; width: 100%; justify-content: space-between; gap: 10px; }
             .progress-bar-container { flex-grow: 1; margin-right: 10px; height: 10px; }
             .progress-text { min-width: auto; }
             .section-link { padding: 7px 12px; font-size: 13px; }
              /* Adjusted table class name */
             .admin-self-progress-table th, .admin-self-progress-table td { font-size: 13px; padding: 8px; } /* Smaller table font */
             #assessmentSuccessPopup { width: 90%; padding: 30px 25px; }
             #assessmentForm textarea { min-height: 100px; }
             #assessmentForm label { font-size: 16px; }
             #assessmentForm input[type="number"], #assessmentForm textarea, #assessmentForm select { padding: 12px 14px; font-size: 15px; }
             #assessmentSubmitBtn { padding: 12px 25px; font-size: 16px; }
             #adminSection h3 { font-size: 20px; }
             .admin-analysis-section h4 { font-size: 18px; }
             #adminAssessmentDetails { padding: 15px; }
             #adminAssessmentDetails h5 { font-size: 16px; }
             #adminAssessmentDetails dt { font-size: 14px; }
             #adminAssessmentDetails dd { font-size: 13px; }
         }

    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">Coaching & Leadership Dashboard</header>

    <!-- User Bar -->
    <div class="user-bar">
        <div class="user-info">
             <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path> <circle cx="12" cy="7" r="4"></circle> </svg>
            <div class="user-details-bar">
                <span class="user-name-bar" id="userNameBar">Loading...</span>
                <span class="user-email-bar" id="userEmailBar"></span>
            </div>
        </div>
        <button class="logout-button" onclick="logout()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path> <polyline points="16 17 21 12 16 7"></polyline> <line x1="21" y1="12" x2="9" y2="12"></line> </svg>
            Logout
        </button>
    </div>

    <!-- Main Content Area -->
    <main>
        <div id="loadingMessage">Loading Dashboard...</div>

        <!-- Pre-Course Assessment Section -->
        <section id="assessmentSection">
            <h2>Pre-Course Assessment</h2>
            <p class="intro-note">
                <strong>Welcome!</strong> Before you begin the course modules, please take a moment to answer these questions. Your answers help us personalize your experience. Please answer honestly in your own words. <span id="adminAssessmentNote" style="display: none; font-weight: bold; color: #b45309;"> (Admin: Word count and paste restrictions are disabled for your account.)</span>
            </p>
            <form id="assessmentForm" novalidate>
                 <!-- Question 1 -->
                <div class="form-group">
                    <label for="q1_coaching_meaning">What does coaching mean to you?</label>
                    <textarea id="q1_coaching_meaning" name="coaching_meaning" required data-min-words="20" placeholder="Describe your understanding of coaching..."></textarea>
                    <div class="input-meta-info">
                        <div class="paste-warning" id="q1_paste_warning">Pasting content is discouraged. Please use your own words.</div>
                        <div class="word-count-info" id="q1_word_count_container">Words: <span id="q1_word_count">0</span>/20</div>
                    </div>
                    <div class="error-message" id="q1_error"></div>
                </div>

                <!-- Question 2 (Randomized) -->
                 <div class="form-group" id="randomQuestionContainer">
                     <!-- Label and Input will be inserted here by JS -->
                     <div class="input-meta-info">
                         <div class="paste-warning" id="q_random_paste_warning">Pasting content is discouraged. Please use your own words.</div>
                         <div class="word-count-info" id="q_random_word_count_container">Words: <span id="q_random_word_count">0</span>/<span id="q_random_min_words_display">?</span></div>
                     </div>
                     <div class="error-message" id="q_random_error"></div>
                 </div>

                <!-- Question 3 -->
                <div class="form-group">
                    <label for="q3_expectations">What are your expectations from this course?</label>
                    <textarea id="q3_expectations" name="expectations" required data-min-words="15" placeholder="What do you hope to learn or achieve?"></textarea>
                     <div class="input-meta-info">
                         <div class="paste-warning" id="q3_paste_warning">Pasting content is discouraged. Please use your own words.</div>
                         <div class="word-count-info" id="q3_word_count_container">Words: <span id="q3_word_count">0</span>/15</div>
                     </div>
                    <div class="error-message" id="q3_error"></div>
                </div>

                <!-- Question 4 -->
                 <div class="form-group">
                    <label for="q4_confidence_rating">Rate your current coaching confidence (1=Low, 5=High)</label>
                    <input type="number" id="q4_confidence_rating" name="confidence_rating" required min="1" max="5" step="1" placeholder="Enter a number between 1 and 5">
                    <div class="error-message" id="q4_rating_error"></div>

                    <label for="q4_confidence_explanation" style="margin-top: 15px;">Briefly explain your rating:</label>
                    <textarea id="q4_confidence_explanation" name="confidence_explanation" required data-min-words="10" placeholder="Why did you choose this rating?"></textarea>
                     <div class="input-meta-info">
                         <div class="paste-warning" id="q4_exp_paste_warning">Pasting content is discouraged. Please use your own words.</div>
                         <div class="word-count-info" id="q4_exp_word_count_container">Words: <span id="q4_exp_word_count">0</span>/10</div>
                     </div>
                    <div class="error-message" id="q4_exp_error"></div>
                </div>

                <button type="submit" id="assessmentSubmitBtn">Submit Assessment</button>
            </form>
        </section>

         <!-- Success Popup -->
         <div class="popup-overlay" id="popupOverlay"></div>
         <div id="assessmentSuccessPopup">
             <p>Thank you! Your answers have been saved. You can now start your journey!</p>
             <button id="startJourneyBtn">Start Course</button>
         </div>

        <!-- User Dashboard Container -->
        <div class="dashboard-container" id="userDashboardContent" style="display: none;">
            <h2 id="welcomeMessage">Welcome!</h2>
            <div class="dashboard-user-details">
                 <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                 <div class="dashboard-user-info">
                     Logged in as: <strong id="dashboardUserName">Name</strong> (<span id="dashboardUserEmail">email</span>)
                 </div>
            </div>
            <div class="course-sections">
                <h3>Your Course Progress</h3>
                <div id="courseSectionsList">
                    <!-- Course sections will be loaded here -->
                </div>
            </div>
        </div>

        <!-- ======================== -->
        <!-- Admin-Only Section       -->
        <!-- ======================== -->
        <div id="adminSection">
             <h3>
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                 Admin Panel - Personal Analysis Overview
             </h3>
             <p class="admin-note">
                 <strong>Important Note:</strong> Due to browser limitations (using localStorage), this panel currently only shows analysis for <strong>your own admin account</strong> (<span id="adminEmailDisplay"></span>).
                 <br> Features like viewing/filtering *all* users, overall status charts, and CSV downloads require a server-side database (e.g., Supabase) to access all user data and are not implemented here.
             </p>

            <!-- Container for Admin's OWN Progress -->
            <div id="adminCourseProgressContainer">
                 <h4>Your Course Section Progress</h4>
                 <p>Loading your progress data...</p>
                 <!-- Admin's own course progress table will be loaded here -->
            </div>

            <!-- Container for Admin's OWN Analysis (Chart + Assessment) -->
            <div class="admin-analysis-section">
                <h4>Your Confidence & Assessment Analysis</h4>
                <div id="adminChartContainer">
                     <canvas id="confidenceChart" width="400" height="200"></canvas>
                     <p style="text-align: center; font-size: 12px; color: #78350f; margin-top: 5px;"><em>Note: 'Post-Course' score is simulated for demonstration.</em></p>
                </div>
                <div id="adminAssessmentDetails">
                    <h5>Your Pre-Course Assessment Answers & Progress</h5>
                    <div id="adminProgressAnalysis">
                        <!-- Progress stats based on your data will be loaded here -->
                    </div>
                     <div id="adminAssessmentAnswersDisplay">
                         <!-- Your answers will be loaded here -->
                     </div>
                    <p style="margin-top: 15px; font-size: 13px; color: #78350f;"><em>Reminder: 'During' and 'Post-Course' assessment answers are not currently collected or displayed.</em></p>
                </div>
            </div>
             <!--
                Placeholder Comments for Future (Backend-Enabled) Features:

                <div class="admin-user-management" style="margin-top: 40px; border-top: 2px solid #fcd34d; padding-top: 30px;">
                    <h3>All User Management (Requires Backend)</h3>
                    <p class="admin-note" style="background-color: #e0f2fe; border-color: #7dd3fc; color: #075985;">
                        The following features (User Table, Filtering, Overall Chart, CSV Download) require a backend connection (like Supabase) to fetch data for all users. They are not functional in this localStorage-only version.
                    </p>

                    <div class="user-filters" style="margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
                        <input type="text" placeholder="Search by Name/Email..." id="adminUserSearch" style="padding: 8px 12px; border: 1px solid #fde68a; border-radius: 6px; flex-grow: 1;" disabled>
                        <select id="adminStatusFilter" style="padding: 8px 12px; border: 1px solid #fde68a; border-radius: 6px;" disabled>
                            <option value="">Filter by Status</option>
                            <option value="Completed">Completed</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Not Started">Not Started</option>
                        </select>
                        <button id="adminDownloadCsvBtn" style="padding: 8px 15px; background-color: #fbbf24; border: none; color: #78350f; border-radius: 6px; font-weight: 500; cursor: not-allowed;" disabled>Download CSV</button>
                    </div>

                    <div id="adminAllUsersTableContainer" style="margin-bottom: 30px;">
                        <p style="font-style: italic; color: #78350f;">(All users table would be displayed here if connected to a backend)</p>
                    </div>

                    <div id="adminOverallStatusChartContainer" style="max-width: 400px; margin: 0 auto;">
                        <p style="font-style: italic; color: #78350f; text-align: center;">(Overall status pie chart would be displayed here)</p>
                        <canvas id="adminOverallStatusChart" width="300" height="150" style="display: none;"></canvas> // Initially hidden
                    </div>
                </div>
            -->
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        © 2025 Elmenisy Leadership Coaching - All Rights Reserved
    </footer>

    <script>
        // --- Constants ---
        const LOGGED_IN_KEY = 'isUserLoggedIn';
        const CURRENT_USER_KEY = 'currentUser';
        const SIGNUP_FLAG_KEY = 'hasSignedUpBefore';
        const ADMIN_EMAIL = 'm.elsayed@thechefz.co'; // Case-insensitive comparison

        // Assessment Question Pool
        const randomQuestionPool = [
            { id: 'q_leadership_vs_management', label: 'How do you differentiate leadership from management?', minWords: 20 },
            { id: 'q_coaching_challenge', label: 'What do you see as the biggest challenge in coaching others?', minWords: 20 },
            { id: 'q_leadership_style', label: 'Briefly describe your ideal leadership style.', minWords: 15 }
        ];
        let selectedRandomQuestion = null; // Will hold the chosen question object

        const courseSections = [
            { id: 'index', title: 'Course Introduction Goal', link: 'index.html' },
            { id: 'article1', title: 'Introduction to Coaching and Leadership', link: 'article1.html' },
            { id: 'skills', title: 'Coaching Skills', link: 'coaching-skills.html' },
            { id: 'individuals', title: 'Coaching Individuals', link: 'coaching-individuals.html' },
            { id: 'team', title: 'Team Coaching', link: 'coaching-team.html' },
            { id: 'self', title: 'Self Coaching', link: 'coaching-yourself.html' },
            { id: 'action', title: 'Action Plan', link: 'action-plan.html' },
        ];

        // --- Global variable for admin status ---
        let IS_ADMIN_USER = false;
        let confidenceChartInstance = null; // To hold the chart instance

        // --- IMMEDIATE REDIRECTION LOGIC ---
        console.log("%cDashboard Page: Running IMMEDIATE redirection check...", "color: purple; font-weight: bold;");
        function quickCheckCurrentUserFormat() {
            const data = localStorage.getItem(CURRENT_USER_KEY);
            return data && data.length > 2 && data.startsWith('{') && data.endsWith('}');
        }
        const isLoggedIn_immediate = localStorage.getItem(LOGGED_IN_KEY) === 'true' && quickCheckCurrentUserFormat();
        const hasSignedUp_immediate = localStorage.getItem(SIGNUP_FLAG_KEY) === 'true';

        if (!isLoggedIn_immediate) {
            const targetUrl = hasSignedUp_immediate ? 'login.html' : 'signup.html';
            console.error(`%cDashboard Page IMMEDIATE Redirect: Not logged in or user data invalid. Redirecting to ${targetUrl}...`, "color: orange;");
            window.location.replace(`${targetUrl}?redirect=${encodeURIComponent(window.location.pathname)}`);
            // Use throw to stop script execution immediately after redirect attempt
            throw new Error("Redirecting user: Not logged in or invalid user data.");
        } else {
            console.log("%cDashboard Page IMMEDIATE Check: User IS logged in. Proceeding.", "color: green;");
        }
        // --- END IMMEDIATE REDIRECTION ---

        document.addEventListener('DOMContentLoaded', function() {
            console.log("Dashboard page DOM loaded.");

            // --- Element References ---
            const loadingMessage = document.getElementById('loadingMessage');
            const assessmentSection = document.getElementById('assessmentSection');
            const userDashboardContent = document.getElementById('userDashboardContent');
            const adminSection = document.getElementById('adminSection');
            const assessmentForm = document.getElementById('assessmentForm');
            const assessmentSuccessPopup = document.getElementById('assessmentSuccessPopup');
            const popupOverlay = document.getElementById('popupOverlay');
            const startJourneyBtn = document.getElementById('startJourneyBtn');

             // Get current user data
            const currentUser = getCurrentUser();

            if (!currentUser) {
                // getCurrentUser() already handles logout if data is corrupt/missing
                // No need to explicitly call logout() here again, just stop execution
                console.error("Dashboard DOMContentLoaded: Critical - User data missing/invalid after check. Execution stopped.");
                loadingMessage.textContent = 'Error loading user data. Please try logging in again.';
                loadingMessage.style.color = '#ef4444'; // Error color
                return;
            }

            console.log("Current User Data (Dashboard):", currentUser);

            // *** Determine if the current user is the admin ***
            IS_ADMIN_USER = currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
            console.log(`User is admin: ${IS_ADMIN_USER}`);

            // Populate user info in the top bar immediately
            populateTopBar(currentUser);

            // --- Assessment Check ---
            if (!currentUser.assessmentCompleted) {
                console.log("Assessment not completed. Displaying assessment form.");
                setupAssessmentForm(); // This function now knows about IS_ADMIN_USER
                loadingMessage.style.display = 'none';
                assessmentSection.style.display = 'block';
                 setTimeout(() => assessmentSection.classList.add('fade-in'), 50);
            } else {
                console.log("Assessment already completed. Displaying main dashboard.");
                displayMainDashboard(currentUser);
            }

             // Attach listener for the success popup button
             startJourneyBtn.addEventListener('click', () => {
                 assessmentSuccessPopup.style.display = 'none';
                 popupOverlay.style.display = 'none';
                 assessmentSection.style.display = 'none';
                 assessmentSection.classList.remove('fade-in');
                 displayMainDashboard(getCurrentUser()); // Re-display dashboard after assessment
             });
        });

        // --- Helper Functions ---

        function getCurrentUser() {
            try {
                const userData = localStorage.getItem(CURRENT_USER_KEY);
                if (!userData) {
                    console.warn("getCurrentUser: No current user data found in localStorage.");
                    logout(); // Force logout if no data
                    return null;
                }
                const parsedUser = JSON.parse(userData);

                // Robust check for essential user properties
                if (parsedUser && typeof parsedUser === 'object' && parsedUser.name && parsedUser.email) {
                    let dataUpdated = false; // Use a single flag
                    // Initialize progress if needed
                    if (typeof parsedUser.progress !== 'object' || parsedUser.progress === null) {
                        parsedUser.progress = {}; dataUpdated = true;
                        console.log("Initialized user progress object.");
                    }
                    // Initialize assessment status/answers if needed
                     if (parsedUser.assessmentCompleted === undefined) {
                         parsedUser.assessmentCompleted = false; dataUpdated = true;
                         console.log("Initialized assessmentCompleted flag.");
                     }
                     if (typeof parsedUser.assessmentAnswers !== 'object' || parsedUser.assessmentAnswers === null) {
                        parsedUser.assessmentAnswers = {}; dataUpdated = true;
                        console.log("Initialized assessmentAnswers object.");
                     }
                     // Ensure progress exists for all defined sections
                     courseSections.forEach(section => {
                        if (parsedUser.progress[section.id] === undefined || parsedUser.progress[section.id] === null) {
                            parsedUser.progress[section.id] = 0; dataUpdated = true;
                        }
                    });
                    // Save only if data structure was modified
                    if (dataUpdated) {
                        console.log("User data structure updated, saving changes.");
                        saveCurrentUser(parsedUser);
                    }
                    return parsedUser;
                } else {
                    console.error("getCurrentUser: Parsed user data is invalid or missing essential fields.", parsedUser);
                    logout(); return null;
                }
            } catch (error) {
                console.error("Error parsing current user data from localStorage:", error);
                logout(); return null;
            }
        }

        function saveCurrentUser(userObject) {
             try {
                 if (!userObject || typeof userObject !== 'object') { throw new Error("Invalid user object provided for saving."); }
                 localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(userObject));
                 console.log("Saved user data to localStorage:", userObject);
             } catch (error) {
                 console.error("Error saving current user data to localStorage:", error);
                 // Optional: Add user feedback here if saving fails critically
             }
        }

        function populateTopBar(user) {
            const userNameBar = document.getElementById('userNameBar');
            const userEmailBar = document.getElementById('userEmailBar');
            // Check if elements exist before setting textContent
            if (userNameBar) userNameBar.textContent = user.name || 'User';
            if (userEmailBar) userEmailBar.textContent = user.email || 'No email';
        }

        function setupAssessmentForm() {
             const form = document.getElementById('assessmentForm');
             if (!form) { console.error("Assessment form element not found!"); return; }

             const q1Textarea = document.getElementById('q1_coaching_meaning');
             const q3Textarea = document.getElementById('q3_expectations');
             const q4Rating = document.getElementById('q4_confidence_rating');
             const q4Explanation = document.getElementById('q4_confidence_explanation');
             const randomQuestionContainer = document.getElementById('randomQuestionContainer');

             // Check if elements exist before proceeding
             if (!q1Textarea || !q3Textarea || !q4Rating || !q4Explanation || !randomQuestionContainer) {
                 console.error("One or more assessment form elements are missing!");
                 return;
             }

             // Show admin note if applicable
             const adminNote = document.getElementById('adminAssessmentNote');
             if (adminNote) {
                 adminNote.style.display = IS_ADMIN_USER ? 'inline' : 'none';
             }
             if (IS_ADMIN_USER) {
                q1Textarea.placeholder = "Admin: No word count required.";
                q3Textarea.placeholder = "Admin: No word count required.";
                q4Explanation.placeholder = "Admin: No word count required.";
             } else {
                 // Ensure attributes exist before accessing
                 const q1MinWords = q1Textarea.getAttribute('data-min-words') || '20';
                 const q3MinWords = q3Textarea.getAttribute('data-min-words') || '15';
                 const q4ExpMinWords = q4Explanation.getAttribute('data-min-words') || '10';
                q1Textarea.placeholder = `Describe your understanding of coaching... (min ${q1MinWords} words)`;
                q3Textarea.placeholder = `What do you hope to learn or achieve? (min ${q3MinWords} words)`;
                q4Explanation.placeholder = `Why did you choose this rating? (min ${q4ExpMinWords} words)`;
             }

             // --- Select and Inject Random Question ---
             if (randomQuestionPool.length === 0) {
                 console.error("Random question pool is empty!");
                 randomQuestionContainer.innerHTML = '<p style="color: red;">Error: Could not load assessment question.</p>';
                 return;
             }
             selectedRandomQuestion = randomQuestionPool[Math.floor(Math.random() * randomQuestionPool.length)];
             console.log("Selected Random Question:", selectedRandomQuestion);

             const randomPlaceholder = IS_ADMIN_USER ? "Admin: No word count required." : `Please provide your thoughts... (min ${selectedRandomQuestion.minWords} words)`;

             // Check if selectedRandomQuestion is valid
             if (!selectedRandomQuestion || !selectedRandomQuestion.id || !selectedRandomQuestion.label) {
                  console.error("Invalid random question selected:", selectedRandomQuestion);
                  randomQuestionContainer.innerHTML = '<p style="color: red;">Error loading question.</p>';
                  return;
             }

             const randomQuestionHTML = `
                 <label for="${selectedRandomQuestion.id}">${selectedRandomQuestion.label}</label>
                 <textarea id="${selectedRandomQuestion.id}" name="${selectedRandomQuestion.id}" required data-min-words="${selectedRandomQuestion.minWords}" placeholder="${randomPlaceholder}"></textarea>
                 <div class="input-meta-info">
                     <div class="paste-warning" id="${selectedRandomQuestion.id}_paste_warning">Pasting content is discouraged. Please use your own words.</div>
                     <div class="word-count-info" id="${selectedRandomQuestion.id}_word_count_container">Words: <span id="${selectedRandomQuestion.id}_word_count">0</span>/${selectedRandomQuestion.minWords}</div>
                 </div>
                 <div class="error-message" id="${selectedRandomQuestion.id}_error"></div>
             `;
             randomQuestionContainer.innerHTML = randomQuestionHTML;

             // Get reference AFTER injecting HTML
             const qRandomTextarea = document.getElementById(selectedRandomQuestion.id);
             const qRandomWordCount = document.getElementById(`${selectedRandomQuestion.id}_word_count`);
             const qRandomError = document.getElementById(`${selectedRandomQuestion.id}_error`);
             const qRandomWordCountContainer = document.getElementById(`${selectedRandomQuestion.id}_word_count_container`);
             const qRandomPasteWarning = document.getElementById(`${selectedRandomQuestion.id}_paste_warning`);

             // Check if dynamically added elements exist
             if (!qRandomTextarea || !qRandomWordCount || !qRandomError || !qRandomWordCountContainer || !qRandomPasteWarning) {
                 console.error("Failed to find dynamically added elements for the random question!");
                 return; // Prevent setting up listeners on null elements
             }

             // --- Setup Conditional Validation/Restrictions ---
             setupWordCountValidation(q1Textarea, document.getElementById('q1_word_count'), document.getElementById('q1_error'), document.getElementById('q1_word_count_container'), IS_ADMIN_USER);
             setupWordCountValidation(qRandomTextarea, qRandomWordCount, qRandomError, qRandomWordCountContainer, IS_ADMIN_USER);
             setupWordCountValidation(q3Textarea, document.getElementById('q3_word_count'), document.getElementById('q3_error'), document.getElementById('q3_word_count_container'), IS_ADMIN_USER);
             setupWordCountValidation(q4Explanation, document.getElementById('q4_exp_word_count'), document.getElementById('q4_exp_error'), document.getElementById('q4_exp_word_count_container'), IS_ADMIN_USER);

             setupPastePrevention(q1Textarea, document.getElementById('q1_paste_warning'), IS_ADMIN_USER);
             setupPastePrevention(qRandomTextarea, qRandomPasteWarning, IS_ADMIN_USER);
             setupPastePrevention(q3Textarea, document.getElementById('q3_paste_warning'), IS_ADMIN_USER);
             setupPastePrevention(q4Explanation, document.getElementById('q4_exp_paste_warning'), IS_ADMIN_USER);

             // --- Form Submission ---
             form.addEventListener('submit', handleAssessmentSubmit);
             console.log("Assessment form setup complete.");
        }

        function countWords(text) {
            // Ensure text is a string before attempting to trim or split
            return text && typeof text === 'string' ? text.trim().split(/\s+/).filter(Boolean).length : 0;
        }

        function setupWordCountValidation(textarea, countSpan, errorElement, countContainer, isAdmin) {
             // Defensive check for elements
             if (!textarea || !countSpan || !errorElement || !countContainer) {
                 console.warn("Missing element for word count setup on:", textarea ? textarea.id : 'unknown textarea');
                 // Hide related elements if possible, even if some are missing
                 if(countContainer) countContainer.style.display = 'none';
                 if(errorElement) errorElement.style.display = 'none';
                 return;
             }

             const minWords = parseInt(textarea.getAttribute('data-min-words'), 10);
             if (isNaN(minWords) && !isAdmin) {
                 console.warn(`Invalid or missing data-min-words attribute on textarea: ${textarea.id}`);
                  countContainer.style.display = 'none'; // Hide count if minWords is invalid
                 return;
             }

             if (isAdmin) {
                 countContainer.style.display = 'none';
                 errorElement.style.display = 'none'; // Also hide error element for admin
                 return;
             }

             // Ensure container is visible for non-admins
             countContainer.style.display = 'flex'; // Assuming it's part of a flex layout in input-meta-info

             textarea.addEventListener('input', () => {
                 const words = countWords(textarea.value);
                 countSpan.textContent = words;
                 validateWordCount(textarea, minWords, errorElement, isAdmin);
             });
             // Initial validation check on load
             validateWordCount(textarea, minWords, errorElement, isAdmin);
         }

        function validateWordCount(textarea, minWords, errorElement, isAdmin) {
             // Check elements again inside the function
             if (!textarea || !errorElement) return true; // Cannot validate

             if (isAdmin) {
                 errorElement.style.display = 'none';
                 textarea.classList.remove('invalid');
                 return true;
             }

             const words = countWords(textarea.value);
             // Only show error if the field is not empty but below the word count
             // Allows empty field initially without error, handled by 'required' check on submit
             if (textarea.value.trim() && words < minWords) {
                 errorElement.textContent = `Minimum ${minWords} words required.`;
                 errorElement.style.display = 'block';
                 textarea.classList.add('invalid');
                 return false;
             } else {
                 errorElement.style.display = 'none';
                 textarea.classList.remove('invalid');
                 return true;
             }
        }

        function setupPastePrevention(textarea, warningElement, isAdmin) {
            if (!textarea || !warningElement) {
                console.warn("Missing element for paste prevention setup on:", textarea ? textarea.id : 'unknown textarea');
                return;
            }

            // Always hide the warning initially
            warningElement.style.display = 'none';

            if (!isAdmin) {
                textarea.addEventListener('paste', (event) => {
                    event.preventDefault(); // Prevent the paste action
                    // Show a more prominent warning or feedback if desired
                    warningElement.textContent = 'Pasting is disabled. Please type your answer.';
                    warningElement.style.display = 'block';
                    // Optionally shake the textarea or give other visual feedback
                    textarea.style.borderColor = '#f97316'; // Temporary orange border
                    setTimeout(() => {
                        warningElement.style.display = 'none';
                        textarea.style.borderColor = ''; // Reset border color
                        // Refocus or trigger input event if needed after preventing paste
                        textarea.dispatchEvent(new Event('input')); // Trigger word count update if needed
                    }, 3000); // Hide warning after 3 seconds
                });
            }
            // No 'else' needed, warning is hidden by default if isAdmin is true
        }


        function handleAssessmentSubmit(event) {
            event.preventDefault();
            console.log("Assessment submit triggered.");
            const form = event.target;
            if (!form) return; // Should not happen if called from event listener

            const submitButton = document.getElementById('assessmentSubmitBtn');
            if (submitButton) submitButton.disabled = true; // Disable button immediately

            // Reset previous errors
            form.querySelectorAll('.error-message').forEach(el => { el.textContent = ''; el.style.display = 'none'; });
            form.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));

            // --- Get references to all required elements ---
            const q1Textarea = document.getElementById('q1_coaching_meaning');
            // Crucially, check if selectedRandomQuestion is defined before accessing its id
            if (!selectedRandomQuestion || !selectedRandomQuestion.id) {
                 console.error("Cannot submit assessment: Random question data is missing.");
                 alert("An error occurred loading the assessment questions. Please refresh and try again.");
                 if (submitButton) submitButton.disabled = false;
                 return;
            }
            const qRandomTextarea = document.getElementById(selectedRandomQuestion.id); // Use dynamic ID
            const q3Textarea = document.getElementById('q3_expectations');
            const q4Rating = document.getElementById('q4_confidence_rating');
            const q4Explanation = document.getElementById('q4_confidence_explanation');

            // Error elements
            const q1Error = document.getElementById('q1_error');
            const qRandomError = document.getElementById(`${selectedRandomQuestion.id}_error`); // Use dynamic ID
            const q3Error = document.getElementById('q3_error');
            const q4RatingError = document.getElementById('q4_rating_error');
            const q4ExpError = document.getElementById('q4_exp_error');

            // --- Check if all elements were found ---
            if (!q1Textarea || !qRandomTextarea || !q3Textarea || !q4Rating || !q4Explanation ||
                !q1Error || !qRandomError || !q3Error || !q4RatingError || !q4ExpError) {
                console.error("One or more assessment form elements or error elements could not be found during submit.");
                alert("A problem occurred with the form. Please refresh the page.");
                if (submitButton) submitButton.disabled = false;
                return;
            }

            let isValid = true;

            // --- Validation Checks ---

            // Q1: Required + Word Count (if not admin)
            if (!q1Textarea.value.trim()) {
                q1Error.textContent = 'This field is required.'; q1Error.style.display = 'block'; q1Textarea.classList.add('invalid'); isValid = false;
            } else if (!IS_ADMIN_USER) {
                 const q1MinWords = parseInt(q1Textarea.getAttribute('data-min-words'), 10) || 20;
                 if (!validateWordCount(q1Textarea, q1MinWords, q1Error, false)) { isValid = false; }
            }

            // Random Q: Required + Word Count (if not admin)
             if (!qRandomTextarea.value.trim()) {
                 qRandomError.textContent = 'This field is required.'; qRandomError.style.display = 'block'; qRandomTextarea.classList.add('invalid'); isValid = false;
             } else if (!IS_ADMIN_USER) {
                  const qRandomMinWords = selectedRandomQuestion.minWords || 20;
                  if (!validateWordCount(qRandomTextarea, qRandomMinWords, qRandomError, false)) { isValid = false; }
             }

            // Q3: Required + Word Count (if not admin)
            if (!q3Textarea.value.trim()) {
                q3Error.textContent = 'This field is required.'; q3Error.style.display = 'block'; q3Textarea.classList.add('invalid'); isValid = false;
            } else if (!IS_ADMIN_USER) {
                 const q3MinWords = parseInt(q3Textarea.getAttribute('data-min-words'), 10) || 15;
                 if (!validateWordCount(q3Textarea, q3MinWords, q3Error, false)) { isValid = false; }
            }

            // Q4 Rating: Required + Range
            const ratingVal = parseInt(q4Rating.value, 10);
            if (!q4Rating.value || isNaN(ratingVal) || ratingVal < 1 || ratingVal > 5) {
                q4RatingError.textContent = 'Please enter a valid rating between 1 and 5.'; q4RatingError.style.display = 'block'; q4Rating.classList.add('invalid'); isValid = false;
            }

            // Q4 Explanation: Required + Word Count (if not admin)
             if (!q4Explanation.value.trim()) {
                q4ExpError.textContent = 'This field is required.'; q4ExpError.style.display = 'block'; q4Explanation.classList.add('invalid'); isValid = false;
            } else if (!IS_ADMIN_USER) {
                 const q4ExpMinWords = parseInt(q4Explanation.getAttribute('data-min-words'), 10) || 10;
                 if (!validateWordCount(q4Explanation, q4ExpMinWords, q4ExpError, false)) { isValid = false; }
            }

            // --- Process if Valid ---
            if (isValid) {
                console.log("Assessment form is valid. Proceeding to save.");
                const currentUser = getCurrentUser(); // Re-fetch user data to ensure it's current
                if (!currentUser) {
                    console.error("Cannot save assessment, user data lost or invalid before save.");
                    alert("An error occurred saving your data. Please try logging out and back in.");
                     if (submitButton) submitButton.disabled = false;
                    return;
                }

                // Ensure assessmentAnswers object exists
                 if (typeof currentUser.assessmentAnswers !== 'object' || currentUser.assessmentAnswers === null) {
                     currentUser.assessmentAnswers = {};
                 }

                // Save answers under assessmentAnswers key
                currentUser.assessmentAnswers = {
                    [q1Textarea.name]: q1Textarea.value.trim(),
                    // Use the actual name/id from the selected random question object
                    [selectedRandomQuestion.id]: qRandomTextarea.value.trim(),
                    [q3Textarea.name]: q3Textarea.value.trim(),
                    [q4Rating.name]: ratingVal, // Save the number
                    [q4Explanation.name]: q4Explanation.value.trim()
                };
                currentUser.assessmentCompleted = true;

                saveCurrentUser(currentUser);
                console.log("Assessment answers saved to localStorage.");

                // Show success popup
                const successPopup = document.getElementById('assessmentSuccessPopup');
                const overlay = document.getElementById('popupOverlay');
                 if(successPopup) successPopup.style.display = 'block';
                 if(overlay) overlay.style.display = 'block';

                 // Button remains disabled until popup is closed

            } else {
                console.warn("Assessment form is invalid. Submission halted.");
                 if (submitButton) submitButton.disabled = false; // Re-enable button on validation failure
                 // Scroll to the first error field for better UX
                 const firstError = form.querySelector('.invalid');
                 if (firstError) {
                     firstError.focus(); // Focus the field
                     firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                 }
                 alert("Please correct the errors highlighted on the form.");
            }
        }


        function displayMainDashboard(user) {
            console.log("Displaying main dashboard content.");
            const loadingMessage = document.getElementById('loadingMessage');
            const userDashboardContent = document.getElementById('userDashboardContent');
            const adminSection = document.getElementById('adminSection');
            const courseSectionsList = document.getElementById('courseSectionsList');
            const welcomeMessage = document.getElementById('welcomeMessage');
            const dashboardUserName = document.getElementById('dashboardUserName');
            const dashboardUserEmail = document.getElementById('dashboardUserEmail');

            // Ensure main elements exist
             if (!loadingMessage || !userDashboardContent || !adminSection || !courseSectionsList || !welcomeMessage || !dashboardUserName || !dashboardUserEmail) {
                 console.error("Critical dashboard elements are missing from the DOM!");
                 if(loadingMessage) {
                     loadingMessage.textContent = "Error: Failed to load dashboard components.";
                     loadingMessage.style.color = 'red';
                 }
                 return;
             }

            loadingMessage.style.display = 'none';

             // Populate User Info in Dashboard Area
             welcomeMessage.textContent = `Welcome back, ${user.name || 'User'}!`;
             dashboardUserName.textContent = user.name || 'N/A';
             dashboardUserEmail.textContent = user.email || 'N/A';

            // Display Course Sections for the user
            displayCourseSections(user, courseSectionsList);

            // Check for Admin Access and display admin panel if needed
            if (IS_ADMIN_USER) {
                console.log("Admin user detected. Displaying admin panel.");
                const adminEmailDisplay = document.getElementById('adminEmailDisplay');
                if (adminEmailDisplay) { adminEmailDisplay.textContent = user.email; }
                else { console.warn("Admin email display span not found."); }

                // Display admin-specific data (their own progress table AND self-analysis)
                const adminCourseProgressContainer = document.getElementById('adminCourseProgressContainer'); // Container for the progress table
                if (adminCourseProgressContainer) {
                     displayAdminData(user, adminCourseProgressContainer); // Pass the specific container
                     adminSection.style.display = 'block';
                     setTimeout(() => adminSection.classList.add('fade-in'), 50); // Fade in admin section
                } else {
                     console.error("Admin course progress container (#adminCourseProgressContainer) not found!");
                     adminSection.innerHTML = '<p style="color: red;">Error loading admin progress view.</p>'; // Show error inside admin section
                     adminSection.style.display = 'block'; // Still show the section, but with an error
                }
            } else {
                 console.log("Regular user detected. Admin panel hidden.");
                 adminSection.style.display = 'none';
            }

            // Show User Dashboard Content & Apply Fade-in
            userDashboardContent.style.display = 'block';
            setTimeout(() => userDashboardContent.classList.add('fade-in'), 50);
        }

        function displayCourseSections(user, containerElement) {
            if (!user || !containerElement) {
                console.error("Invalid user or container provided to displayCourseSections.");
                if (containerElement) containerElement.innerHTML = '<p>Error loading course sections.</p>';
                return;
            }
            containerElement.innerHTML = ''; // Clear previous content

            // Ensure user.progress exists and is an object
            if (!user.progress || typeof user.progress !== 'object') {
                 console.warn("User progress data is missing or invalid. Defaulting to 0%.", user.progress);
                 user.progress = {}; // Initialize to prevent errors below
            }

            if (courseSections.length === 0) {
                containerElement.innerHTML = '<p>No course sections defined.</p>';
                return;
            }

            courseSections.forEach(section => {
                if (!section || !section.id || !section.title) {
                     console.warn("Skipping invalid course section definition:", section);
                     return; // Skip this iteration if section data is bad
                }

                const progress = user.progress[section.id] || 0; // Default to 0 if specific progress not found
                // Ensure progress is a number between 0 and 100
                const progressPercentage = Math.max(0, Math.min(100, Math.round(Number(progress) || 0)));

                const sectionElement = document.createElement('div');
                sectionElement.className = 'course-section';
                // Use template literals for cleaner HTML generation
                sectionElement.innerHTML = `
                    <span class="section-title">${section.title}</span>
                    <div class="section-progress">
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: 0%;"></div>
                        </div>
                        <span class="progress-text">${progressPercentage}% Complete</span>
                        <a href="${section.link || '#'}" class="section-link" title="Go to ${section.title}">Start</a>
                    </div>
                `;

                const progressBar = sectionElement.querySelector('.progress-bar');
                const linkButton = sectionElement.querySelector('.section-link');

                 // Ensure elements exist before modifying
                 if (linkButton) {
                     linkButton.classList.remove('status-review', 'status-continue');
                     if (progress >= 100) {
                         linkButton.textContent = 'Review';
                         linkButton.classList.add('status-review');
                     } else if (progress > 0) {
                         linkButton.textContent = 'Continue';
                         linkButton.classList.add('status-continue');
                     } else {
                         linkButton.textContent = 'Start';
                     }
                 } else { console.warn(`Link button not found for section: ${section.title}`); }

                containerElement.appendChild(sectionElement);

                // Animate progress bar after appending
                 if (progressBar) {
                     // Use requestAnimationFrame for potentially smoother animation start
                     requestAnimationFrame(() => {
                         setTimeout(() => { progressBar.style.width = `${progressPercentage}%`; }, 50); // Short delay after frame paint
                     });
                 } else { console.warn(`Progress bar not found for section: ${section.title}`); }
            });
        }

         // Updated function to display Admin's OWN data: progress table and analysis section
         function displayAdminData(adminUser, courseProgressContainer) {
             console.log("Displaying admin-specific data (self-analysis).");

             // --- 1. Check prerequisites ---
             if (!adminUser) {
                 console.error("Admin user data is missing in displayAdminData.");
                 if(courseProgressContainer) courseProgressContainer.innerHTML = '<p style="color: red;">Error: Admin user data unavailable.</p>';
                 // Optionally hide other admin analysis parts
                 document.getElementById('adminChartContainer').style.display = 'none';
                 document.getElementById('adminAssessmentDetails').style.display = 'none';
                 return;
             }
             if (!courseProgressContainer) {
                 console.error("Admin course progress container element not found in displayAdminData.");
                 // Cannot display progress table, but maybe analysis can still work
             }

             // Ensure progress and assessment answers exist, initialize if necessary (should be handled by getCurrentUser, but double-check)
             const userProgress = (adminUser.progress && typeof adminUser.progress === 'object') ? adminUser.progress : {};
             const userAssessmentAnswers = (adminUser.assessmentAnswers && typeof adminUser.assessmentAnswers === 'object') ? adminUser.assessmentAnswers : {};


             // --- 2. Display Admin's OWN Course Section Progress Table ---
             if (courseProgressContainer) {
                 let tableHTML = `
                    <h4>Your Course Section Progress</h4>
                    <table class="admin-self-progress-table">
                        <thead> <tr> <th>Section</th> <th>Progress (%)</th> <th>Status</th> </tr> </thead>
                        <tbody>`;

                 if (courseSections.length > 0) {
                     courseSections.forEach(section => {
                         if (!section || !section.id || !section.title) return; // Skip invalid sections
                         const progress = userProgress[section.id] || 0;
                         const progressPercentage = Math.max(0, Math.min(100, Math.round(Number(progress) || 0)));
                         let status = 'Not Started';
                         if (progress >= 100) status = 'Completed';
                         else if (progress > 0) status = 'In Progress';
                         tableHTML += `<tr><td>${section.title}</td><td>${progressPercentage}%</td><td>${status}</td></tr>`;
                     });
                 } else {
                     tableHTML += '<tr><td colspan="3">No course sections defined.</td></tr>';
                 }

                 tableHTML += `</tbody></table>`;
                 courseProgressContainer.innerHTML = tableHTML; // Put table in its specific container
             } else {
                  console.warn("Cannot display admin progress table - container missing.");
             }


             // --- 3. Prepare Data for Self-Analysis Section ---
             // Use assessment answers safely, providing defaults
             const preConfidenceScore = Number(userAssessmentAnswers.confidence_rating) || 0; // Default to 0 if missing/invalid

             // *** SIMULATE Post-Course Score for Demonstration ***
             let simulatedPostConfidenceScore = preConfidenceScore; // Default to pre-score
             if (preConfidenceScore < 5) {
                 // Simulate a plausible improvement, ensure it doesn't exceed 5
                 simulatedPostConfidenceScore = Math.min(5, preConfidenceScore + Math.floor(Math.random() * (5 - preConfidenceScore + 1)));
             }
             console.log(`Admin self-analysis: Pre-score=${preConfidenceScore}, Simulated post-score=${simulatedPostConfidenceScore}`);


             // --- 4. Render Confidence Chart (Admin's Own) ---
             renderConfidenceChart(preConfidenceScore, simulatedPostConfidenceScore);


             // --- 5. Display Assessment Details and Progress Analysis (Admin's Own) ---
             displayAssessmentDetails(userAssessmentAnswers, preConfidenceScore, simulatedPostConfidenceScore);
         }


         // Renders the Bar chart for Admin's own confidence comparison
         function renderConfidenceChart(preScore, postScore) {
             const chartContainer = document.getElementById('adminChartContainer');
             const canvas = document.getElementById('confidenceChart');
             if (!chartContainer || !canvas) {
                 console.error("Canvas element 'confidenceChart' or its container not found.");
                 if(chartContainer) chartContainer.innerHTML = '<p style="color: red;">Error loading confidence chart.</p>';
                 return;
             }
             const context = canvas.getContext('2d');
             if (!context) {
                  console.error("Failed to get 2D context for confidence chart canvas.");
                  return;
             }

             // Make container visible if it might have been hidden
             chartContainer.style.display = 'block';

             // Destroy previous chart instance if it exists to prevent memory leaks and rendering issues
             if (confidenceChartInstance) {
                 console.log("Destroying previous confidence chart instance.");
                 confidenceChartInstance.destroy();
                 confidenceChartInstance = null; // Ensure it's cleared
             }

             console.log(`Rendering confidence chart with Pre: ${preScore}, Post (Simulated): ${postScore}`);
             try {
                 confidenceChartInstance = new Chart(context, {
                     type: 'bar',
                     data: {
                         labels: ['Pre-Course', 'Post-Course (Simulated)'],
                         datasets: [{
                             label: 'Confidence Level (1-5)',
                             data: [preScore, postScore],
                             backgroundColor: [
                                 'rgba(245, 158, 11, 0.6)', // Amber 60%
                                 'rgba(16, 185, 129, 0.6)'  // Emerald 60%
                             ],
                             borderColor: [
                                 'rgba(217, 119, 6, 1)',   // Amber solid
                                 'rgba(5, 150, 105, 1)'    // Emerald solid
                             ],
                             borderWidth: 1,
                             barThickness: 60 // Optional: Adjust bar thickness
                         }]
                     },
                     options: {
                         responsive: true,
                         maintainAspectRatio: false, // Allow chart to adjust height based on container
                         scales: {
                             y: {
                                 beginAtZero: true,
                                 min: 0, // Explicitly start at 0
                                 max: 5, // Explicitly set max to 5
                                 ticks: {
                                      stepSize: 1, // Ensure ticks are integers 0, 1, 2, 3, 4, 5
                                      // Format ticks as integers if needed (though usually default)
                                      // callback: function(value) { if (Number.isInteger(value)) { return value; } },
                                 }
                             }
                         },
                         plugins: {
                             legend: { display: false }, // Hide legend as dataset label is clear enough
                             title: {
                                 display: true,
                                 text: 'Your Confidence Score Comparison', // Personalize title
                                 font: { size: 16 }
                             },
                             tooltip: {
                                 callbacks: {
                                     label: function(context) {
                                         let label = context.dataset.label || '';
                                         if (label) { label += ': '; }
                                         if (context.parsed.y !== null) {
                                             label += context.parsed.y;
                                         }
                                         return label;
                                     }
                                 }
                             }
                         }
                     }
                 });
             } catch (error) {
                  console.error("Error creating Chart.js instance:", error);
                  chartContainer.innerHTML = '<p style="color: red;">Failed to render chart.</p>';
             }
         }


         // Displays the Admin's OWN Assessment Answers and Calculated Progress/Feedback
         function displayAssessmentDetails(answers, preScore, postScore) {
             const detailsContainer = document.getElementById('adminAssessmentDetails');
             const answersContainer = document.getElementById('adminAssessmentAnswersDisplay');
             const progressContainer = document.getElementById('adminProgressAnalysis');

             if (!detailsContainer || !answersContainer || !progressContainer) {
                 console.error("Admin assessment detail containers ('adminAssessmentDetails', 'adminAssessmentAnswersDisplay', 'adminProgressAnalysis') not found.");
                 if(detailsContainer) detailsContainer.innerHTML = '<p style="color: red;">Error loading assessment details.</p>';
                 return;
             }

              // Ensure containers are visible
             detailsContainer.style.display = 'block';
             answersContainer.innerHTML = ''; // Clear previous content
             progressContainer.innerHTML = ''; // Clear previous content


             // --- Display Answers ---
             let answersHTML = '<dl>';
             // Map internal keys to user-friendly labels more robustly
             const answerLabels = {
                 'coaching_meaning': 'Meaning of Coaching',
                 'expectations': 'Course Expectations',
                 'confidence_rating': 'Initial Confidence Rating',
                 'confidence_explanation': 'Explanation for Rating'
                 // Add mappings for the *possible* random question IDs
                 // Note: Only one of these random Qs will actually be in the 'answers' object per user
                 'q_leadership_vs_management': 'Leadership vs Management',
                 'q_coaching_challenge': 'Biggest Coaching Challenge',
                 'q_leadership_style': 'Ideal Leadership Style',
             };

             // Check if answers object is empty or not an object
             if (!answers || typeof answers !== 'object' || Object.keys(answers).length === 0) {
                 answersHTML += '<dt>No assessment answers found.</dt><dd>N/A</dd>';
             } else {
                 // Iterate through the known/expected keys to maintain order and clarity
                 const expectedKeys = Object.keys(answerLabels);
                 expectedKeys.forEach(key => {
                     if (answers.hasOwnProperty(key)) { // Check if the user actually answered this question
                         const label = answerLabels[key]; // Get the friendly label
                         const value = answers[key];

                         // Use <pre> for potentially multi-line text answers
                         const isTextAreaAnswer = key.includes('meaning') || key.includes('explanation') || key.includes('expectations') || key.startsWith('q_');
                         const formattedValue = value !== null && value !== undefined ? String(value).trim() : 'N/A'; // Ensure value is string, trim, handle null/undefined

                         answersHTML += `<dt>${label}:</dt>`;
                         if (isTextAreaAnswer) {
                            // Basic sanitization for display within <pre> (prevent HTML injection)
                            const escapedValue = formattedValue.replace(/</g, "<").replace(/>/g, ">");
                            answersHTML += `<dd><pre>${escapedValue || 'N/A'}</pre></dd>`;
                         } else {
                             answersHTML += `<dd>${formattedValue}</dd>`;
                         }
                     }
                 });

                  // Optional: Check for any unexpected keys in answers (for debugging)
                  // for (const key in answers) {
                  //     if (!answerLabels.hasOwnProperty(key)) {
                  //         console.warn("Unexpected key found in assessment answers:", key);
                  //     }
                  // }
             }
             answersHTML += '</dl>';
             answersContainer.innerHTML = answersHTML;


             // --- Calculate and Display Progress/Feedback ---
             let progressHTML = '';
             const scoreChange = postScore - preScore;
             const maxPossibleGain = 5 - preScore; // Max possible points to gain
             let progressPercentage = 0; // Percentage of possible gain achieved

             // Calculate percentage only if there was room to improve
             if (maxPossibleGain > 0) {
                 // Ensure scoreChange is not negative if preScore was already high
                 const effectiveChange = Math.max(0, scoreChange);
                 progressPercentage = Math.round((effectiveChange / maxPossibleGain) * 100);
             } else if (preScore === 5) {
                  // If started at max, 100% progress if they stayed at 5, 0% otherwise
                 progressPercentage = (postScore === 5) ? 100 : 0;
             }

             // Display score change information
             progressHTML += `<p>Confidence Change: <span class="progress-value">${scoreChange >= 0 ? '+' : ''}${scoreChange} points</span> (from ${preScore} to ${postScore})</p>`;

             // Display progress towards max only if relevant
             if (preScore < 5) {
                 progressHTML += `<p>Progress Towards Max Confidence: <span class="progress-value">${progressPercentage}% achieved</span></p>`;
             } else {
                  progressHTML += `<p>Progress Towards Max Confidence: <span class="progress-value">N/A (Started at max score)</span></p>`;
             }


             // --- Add Qualitative Feedback based on change ---
             if (scoreChange > 1) { // Significant positive change
                 progressHTML += `<p><span class="feedback-good">Excellent Progress! Confidence significantly increased.</span></p>`;
             } else if (scoreChange === 1) { // Moderate positive change
                 progressHTML += `<p><span class="feedback-neutral" style="color: #059669; background-color: #d1fae5; padding: 4px 8px; border-radius: 4px;">Good progress noted.</span></p>`;
             } else if (scoreChange === 0) { // No change
                 progressHTML += `<p><span class="feedback-neutral">Confidence level maintained.</span></p>`;
             } else { // Decrease
                 progressHTML += `<p><span class="feedback-neutral" style="color: #dc2626; font-weight: bold;">Confidence level decreased.</span></p>`; // Warning color for decrease
             }

             progressContainer.innerHTML = progressHTML;
         }


        function logout() {
            console.log("Logging out user...");
            try {
                localStorage.removeItem(LOGGED_IN_KEY);
                localStorage.removeItem(CURRENT_USER_KEY);
                // No need to remove SIGNUP_FLAG_KEY on logout generally

                IS_ADMIN_USER = false; // Reset global admin flag

                // Destroy the chart instance if it exists
                if (confidenceChartInstance) {
                    console.log("Destroying chart instance on logout.");
                    confidenceChartInstance.destroy();
                    confidenceChartInstance = null;
                }

                console.log("Local storage cleared for logout (logged in status and user data).");
                // Redirect to login page
                window.location.replace('login.html'); // Use replace to prevent back button going to dashboard
            } catch (e) {
                console.error("Error during logout:", e);
                // Fallback redirect even if errors occur during cleanup
                window.location.replace('login.html');
            }
        }
    </script>
</body>
</html>
