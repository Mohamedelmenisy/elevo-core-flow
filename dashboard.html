<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Coaching & Leadership</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #e67e22;
            --danger-color: #e74c3c;
            --light-bg: #f8fafc;
            --text-color: #333;
            --text-muted: #7f8c8d;
            --border-color: #ecf0f1;
            --card-bg: #ffffff;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 5px 15px rgba(0,0,0,0.07);
            --border-radius: 8px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--light-bg); margin: 0; padding: 0; line-height: 1.6; color: var(--text-color); display: flex; flex-direction: column; min-height: 100vh; }
        main { flex-grow: 1; display: flex; justify-content: center; align-items: flex-start; flex-direction: column; width: 100%; max-width: 1000px; margin: 0 auto; padding: 25px; }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }

        /* --- Header & User Bar --- */
        .header { background-color: var(--primary-color); color: white; padding: 15px 0; text-align: center; font-size: 24px; box-shadow: var(--shadow-sm); width: 100%; }
        .user-bar { background-color: var(--secondary-color); padding: 10px 30px; display: flex; justify-content: space-between; align-items: center; color: white; font-size: 15px; width: 100%; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-info svg { opacity: 0.8; }
        .user-details-bar { display: flex; flex-direction: column; }
        .user-name-bar { font-weight: 600; font-size: 15px; }
        .user-email-bar { font-size: 13px; opacity: 0.8; }
        .logout-button { background-color: var(--danger-color); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s; display: flex; align-items: center; gap: 6px; }
        .logout-button:hover { background-color: #c0392b; transform: translateY(-1px); }
        .logout-button:active { transform: translateY(0); }

        /* --- Dashboard Container & User Details --- */
        .dashboard-container { background: var(--card-bg); padding: 35px 45px; box-shadow: var(--shadow-md); border-radius: var(--border-radius); width: 100%; margin-bottom: 30px; animation: fadeIn 0.5s ease-out; }
        .dashboard-container h2 { color: var(--primary-color); margin-bottom: 15px; font-size: 26px; border-bottom: 2px solid var(--border-color); padding-bottom: 12px; }
        .dashboard-user-details { background-color: var(--border-color); padding: 15px 20px; border-radius: var(--border-radius); margin-bottom: 30px; display: flex; align-items: center; gap: 15px; border-left: 4px solid var(--accent-color); }
        .dashboard-user-details svg { color: var(--accent-color); flex-shrink: 0;}
        .dashboard-user-info { font-size: 16px; color: var(--primary-color); }
        .dashboard-user-info strong { font-weight: 600; }

        /* --- Course Sections --- */
        .course-sections-container { margin-top: 20px; } /* Container for visibility toggle */
        .course-sections h3 { color: var(--secondary-color); margin-top: 30px; margin-bottom: 20px; font-size: 22px; }
        .course-section { background-color: #fdfdfd; border: 1px solid #eef2f7; padding: 18px 25px; margin-bottom: 18px; border-radius: var(--border-radius); display: flex; justify-content: space-between; align-items: center; transition: box-shadow 0.3s ease, transform 0.3s ease; flex-wrap: wrap; gap: 15px; }
        .course-section:hover { box-shadow: var(--shadow-sm); transform: translateY(-2px); }
        .section-title { font-size: 17px; font-weight: 500; color: var(--secondary-color); flex-grow: 1; margin-right: 15px; }
        .section-progress { display: flex; align-items: center; gap: 15px; flex-shrink: 0; flex-basis: 290px; /* Slightly wider */ }
        .progress-bar-container { width: 160px; /* Slightly wider */ height: 12px; background-color: var(--border-color); border-radius: 6px; overflow: hidden; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); }
        .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent-color), #2980b9); border-radius: 6px; transition: width 0.6s ease-in-out; }
        .progress-text { font-size: 14px; color: var(--text-muted); min-width: 85px; text-align: right; font-weight: 500; }
        .section-link { background-color: var(--accent-color); color: white; padding: 7px 14px; border-radius: 5px; text-decoration: none; font-size: 14px; transition: background-color 0.3s; white-space: nowrap; }
        .section-link:hover { background-color: #2980b9; }

        /* --- Assessment Sections --- */
        .assessment-section { background: #f0f4f8; padding: 25px 30px; border-radius: var(--border-radius); margin-bottom: 30px; border: 1px solid #dfe6ed; }
        .assessment-section h3 { color: var(--primary-color); font-size: 20px; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; }
        .assessment-status { font-size: 13px; font-weight: 500; padding: 4px 10px; border-radius: 15px; background-color: var(--grey-medium); color: white; }
        .assessment-status.completed { background-color: var(--success-color); }
        .assessment-status.in-progress { background-color: var(--warning-color); }
        .assessment-section p { margin-bottom: 20px; color: var(--secondary-color); font-size: 15px; }
        .assessment-content { display: none; /* Shown by JS when active */ margin-top: 15px; }
        .assessment-content label { display: block; margin: 10px 0 5px; font-weight: 500; color: var(--secondary-color); text-align: left; }
        .assessment-content textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; min-height: 80px; margin-bottom: 10px; }
        .assessment-section button { background: var(--success-color); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: background-color 0.3s; font-size: 15px; margin-top: 10px; }
        .assessment-section button:hover { background-color: #219653; }

        /* --- Admin Section Styles --- */
        #adminSection { background-color: #e8f6fd; border: 1px solid #bde0fe; border-radius: var(--border-radius); padding: 30px 40px; margin-top: 20px; width: 100%; }
        #adminSection h3 { color: #1c5a8d; margin-bottom: 20px; font-size: 22px; border-bottom: 2px solid #bde0fe; padding-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .admin-note { font-size: 14px; color: #555; background-color: #fff9e0; border: 1px solid #ffeccc; padding: 10px; border-radius: 5px; margin-bottom: 20px; }
        .admin-user-table { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: fixed; }
        .admin-user-table th, .admin-user-table td { border: 1px solid #d0e4f5; padding: 11px 13px; text-align: left; font-size: 14px; word-wrap: break-word; vertical-align: middle; }
        .admin-user-table th { background-color: #d6ebfa; color: #1c5a8d; font-weight: 600; }
        .admin-user-table td { background-color: #f8fcff; }
        .admin-user-table th:nth-child(1) { width: 30%; } /* Section */
        .admin-user-table th:nth-child(2) { width: 15%; text-align: center;} /* Progress */
        .admin-user-table th:nth-child(3) { width: 15%; text-align: center;} /* Pre Score */
        .admin-user-table th:nth-child(4) { width: 15%; text-align: center;} /* Post Score */
        .admin-user-table th:nth-child(5) { width: 25%; } /* Status */
        .admin-user-table td:nth-child(2),
        .admin-user-table td:nth-child(3),
        .admin-user-table td:nth-child(4) { text-align: center; font-weight: 500; }
         .admin-user-table td:nth-child(3),
         .admin-user-table td:nth-child(4) { color: var(--text-muted); } /* Mute score placeholders */


        /* Loading Message */
        #loadingMessage { text-align: center; padding: 50px; font-size: 18px; color: #555; }
        /* Footer */
        .footer { text-align: center; padding: 20px 30px; background: var(--primary-color); color: rgba(255, 255, 255, 0.8); margin-top: auto; font-size: 14px; width: 100%; }

         /* Responsive Adjustments */
         @media (max-width: 768px) {
            main { padding: 15px; }
            .dashboard-container, #adminSection, .assessment-section { padding: 25px; }
            .dashboard-container h2 { font-size: 22px; }
            .course-section { flex-direction: column; align-items: flex-start; }
             .section-title { margin-right: 0; margin-bottom: 10px; }
             .section-progress { flex-basis: auto; width: 100%; justify-content: space-between; }
             .progress-bar-container { flex-grow: 1; margin-right: 10px; }
             .admin-user-table th, .admin-user-table td { font-size: 13px; padding: 8px 10px; }
             .assessment-section h3 { flex-direction: column; align-items: flex-start; gap: 5px;}
         }
         @media (max-width: 480px) {
             .dashboard-user-details { flex-direction: column; align-items: flex-start; text-align: center; }
             .dashboard-user-details svg { margin-bottom: 5px; }
             .admin-user-table { display: block; overflow-x: auto; } /* Allow horizontal scroll for table */
         }

    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">Coaching & Leadership Dashboard</header>

    <!-- User Bar -->
    <div class="user-bar"> <div class="user-info"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path> <circle cx="12" cy="7" r="4"></circle> </svg> <div class="user-details-bar"> <span class="user-name-bar" id="userNameBar">Loading...</span> <span class="user-email-bar" id="userEmailBar"></span> </div> </div> <button class="logout-button" onclick="logout()"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path> <polyline points="16 17 21 12 16 7"></polyline> <line x1="21" y1="12" x2="9" y2="12"></line> </svg> Logout </button> </div>

    <!-- Main Content Area -->
    <main>
        <div id="loadingMessage" style="width: 100%; text-align: center;">Loading Dashboard...</div>

        <!-- User Dashboard Container -->
        <div class="dashboard-container fade-in" id="userDashboardContent" style="display: none;">
            <h2 id="welcomeMessage">Welcome!</h2>

            <!-- User Details Display Area -->
            <div class="dashboard-user-details">
                 <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                 <div class="dashboard-user-info">
                     Logged in as: <strong id="dashboardUserName">Name</strong> (<span id="dashboardUserEmail">email</span>)
                 </div>
            </div>

             <!-- Pre-Course Assessment Section -->
             <div class="assessment-section" id="preAssessmentSection" style="display: none;">
                <h3>
                    Pre-Course Assessment
                    <span class="assessment-status" id="preAssessmentStatus">Not Started</span>
                </h3>
                <p>Please complete this short assessment before starting the course content. Your honest answers help tailor the learning experience.</p>
                <button onclick="startPreAssessment()">Start Assessment</button>
                 <div class="assessment-content" id="preAssessmentContent">
                    <form id="preAssessmentForm">
                        <label for="preQ1">1. On a scale of 1-5 (1=Not Confident, 5=Very Confident), how confident are you in your current coaching abilities?</label>
                        <textarea id="preQ1" placeholder="Enter rating (1-5) and brief explanation..." data-assessment-question="preQ1"></textarea>

                        <label for="preQ2">2. What specific coaching skill do you most want to improve through this course?</label>
                        <textarea id="preQ2" placeholder="e.g., Active listening, giving feedback..." data-assessment-question="preQ2"></textarea>

                        <!-- Add more placeholder questions as needed -->

                        <button type="button" onclick="submitPreAssessment()">Submit Pre-Assessment</button>
                    </form>
                </div>
            </div>

            <!-- Course Sections Area (Conditionally Displayed) -->
            <div class="course-sections-container" id="courseSectionsContainer" style="display: none;">
                <div class="course-sections">
                    <h3>Your Course Progress</h3>
                    <div id="courseSectionsList">
                        <!-- Course sections will be loaded here by JavaScript -->
                    </div>
                </div>
            </div>

             <!-- Post-Course Evaluation Section -->
             <div class="assessment-section" id="postAssessmentSection" style="display: none;">
                 <h3>
                     Post-Course Evaluation
                     <span class="assessment-status" id="postAssessmentStatus">Not Started</span>
                 </h3>
                <p>Congratulations on reaching this milestone! Please take a few moments to reflect on your learning journey.</p>
                 <button onclick="startPostAssessment()">Start Evaluation</button>
                 <div class="assessment-content" id="postAssessmentContent">
                     <form id="postAssessmentForm">
                        <label for="postQ1">1. On a scale of 1-5 (1=Not Confident, 5=Very Confident), how confident are you NOW in your coaching abilities after completing the course material?</label>
                        <textarea id="postQ1" placeholder="Enter rating (1-5) and explain changes..." data-assessment-question="postQ1"></textarea>

                        <label for="postQ2">2. Which course section or concept was most impactful for your development?</label>
                        <textarea id="postQ2" placeholder="Mention specific sections or ideas..." data-assessment-question="postQ2"></textarea>

                        <!-- Add more placeholder questions as needed -->

                        <button type="button" onclick="submitPostAssessment()">Submit Evaluation</button>
                    </form>
                 </div>
             </div>

        </div>

        <!-- Admin-Only Section -->
        <div id="adminSection" style="display: none;">
            <h3><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>Admin Panel - User Progress Overview</h3>
             <p class="admin-note"> <strong>Note:</strong> This view shows data stored in <strong>your</strong> browser (for user: <span id="adminUserEmailDisplay"></span>). For a complete overview of all users, a backend database is required. This panel currently simulates the admin view structure using local data. </p>
            <div id="adminDataContainer">
                <p>Loading admin data...</p>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer"> Â© 2025 Elmenisy Leadership Coaching - All Rights Reserved </footer>

    <script>
        // --- Unified Keys ---
        const LOGGED_IN_KEY = 'isUserLoggedIn';
        const CURRENT_USER_KEY = 'currentUser';
        const SIGNUP_FLAG_KEY = 'hasSignedUpBefore';
        const ADMIN_EMAIL = 'm.elsayed@thechefz.co';
        const POST_ASSESSMENT_THRESHOLD = 80; // Percentage to trigger post-assessment

        // --- Course Structure (ensure IDs match section progress keys) ---
        const courseSections = [
            { id: 'index', title: 'Course Introduction Goal', link: 'index.html' },
            { id: 'article1', title: 'Introduction to Coaching and Leadership', link: 'article1.html' },
            { id: 'skills', title: 'Coaching Skills', link: 'coaching-skills.html' },
            { id: 'individuals', title: 'Coaching Individuals', link: 'coaching-individuals.html' },
            { id: 'team', title: 'Team Coaching', link: 'coaching-team.html' },
            { id: 'self', title: 'Self Coaching', link: 'coaching-yourself.html' },
            { id: 'action', title: 'Action Plan', link: 'action-plan.html' },
        ];

        // --- IMMEDIATE REDIRECTION LOGIC ---
        // ... (Keep existing immediate redirection logic) ...
         console.log("%cDashboard Page: Running IMMEDIATE redirection check...", "color: purple; font-weight: bold;"); function quickCheckCurrentUserFormat() { const data = localStorage.getItem(CURRENT_USER_KEY); return data && data.length > 2 && data.startsWith('{') && data.endsWith('}'); } const isLoggedIn_immediate = localStorage.getItem(LOGGED_IN_KEY) === 'true' && quickCheckCurrentUserFormat(); const hasSignedUp_immediate = localStorage.getItem(SIGNUP_FLAG_KEY) === 'true'; if (!isLoggedIn_immediate) { const targetUrl = hasSignedUp_immediate ? 'login.html' : 'signup.html'; console.error(`%cDashboard Page IMMEDIATE Redirect: Not logged in or user data invalid. Redirecting to ${targetUrl}...`, "color: orange;"); window.location.replace(`${targetUrl}?redirect=${encodeURIComponent(window.location.pathname)}`); throw new Error("Redirecting user: Not logged in or invalid user data."); } else { console.log("%cDashboard Page IMMEDIATE Check: User IS logged in. Proceeding.", "color: green;"); }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Dashboard page DOM loaded.");
            const currentUser = getCurrentUser(); // Gets user data, including progress & assessment status

            // Failsafe check
            if (!currentUser) { console.error("Dashboard DOMContentLoaded: Critical - User data missing! Forcing logout."); logout(); return; }
            console.log("Current User Data (Dashboard):", currentUser);

            // Display User Info
            setupUserInfoDisplay(currentUser);

            // Handle Assessment Visibility & Course Content Display
            handleContentVisibility(currentUser);

             // Display Course Sections (if container is visible)
             const courseSectionsList = document.getElementById('courseSectionsList');
             if(courseSectionsList && document.getElementById('courseSectionsContainer')?.style.display !== 'none') {
                 displayCourseSections(currentUser, courseSectionsList);
             }

            // Handle Admin Panel
            setupAdminPanel(currentUser);

            // Show Main Content Area
            const loadingMessage = document.getElementById('loadingMessage');
            const userDashboardContent = document.getElementById('userDashboardContent');
            if (loadingMessage) loadingMessage.style.display = 'none';
            if (userDashboardContent) userDashboardContent.style.display = 'block';

            console.log("Dashboard initialized successfully.");
        });

        // --- Helper Functions ---
        function getCurrentUser() {
            try {
                const userData = localStorage.getItem(CURRENT_USER_KEY);
                if (!userData) return null;
                const user = JSON.parse(userData);
                if (user && typeof user === 'object' && user.name && user.email) {
                    let updated = false;
                    // Ensure progress object exists and initialize sections
                    if (typeof user.progress !== 'object' || user.progress === null) { user.progress = {}; updated = true; }
                    courseSections.forEach(section => { if (user.progress[section.id] === undefined) { user.progress[section.id] = 0; updated = true; } });
                    // Ensure assessments object exists
                    if (typeof user.assessments !== 'object' || user.assessments === null) { user.assessments = { preCompleted: false, postCompleted: false, preAnswers: {}, postAnswers: {}, preScore: null, postScore: null }; updated = true; }
                    if (updated) saveCurrentUser(user); // Save back if structure was initialized
                    return user;
                } else { localStorage.removeItem(CURRENT_USER_KEY); localStorage.removeItem(LOGGED_IN_KEY); return null; }
            } catch (error) { console.error("Error parsing user data:", error); localStorage.removeItem(CURRENT_USER_KEY); localStorage.removeItem(LOGGED_IN_KEY); return null; }
        }

        function saveCurrentUser(userObject) {
             try { if (!userObject) throw new Error("Invalid user object"); localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(userObject)); console.log("Saved user data:", userObject); }
             catch (error) { console.error("Error saving user data:", error); }
        }

        function setupUserInfoDisplay(user) {
             document.getElementById('userNameBar').textContent = user.name;
             document.getElementById('userEmailBar').textContent = user.email;
             document.getElementById('welcomeMessage').textContent = `Welcome back, ${user.name}!`;
             document.getElementById('dashboardUserName').textContent = user.name;
             document.getElementById('dashboardUserEmail').textContent = user.email;
              // Update admin email display if admin panel exists
             const adminEmailDisplay = document.getElementById('adminUserEmailDisplay');
             if (adminEmailDisplay) adminEmailDisplay.textContent = user.email;
        }

        function handleContentVisibility(user) {
            const preAssessmentSection = document.getElementById('preAssessmentSection');
            const postAssessmentSection = document.getElementById('postAssessmentSection');
            const courseSectionsContainer = document.getElementById('courseSectionsContainer');
            const preAssessmentStatusEl = document.getElementById('preAssessmentStatus');
            const postAssessmentStatusEl = document.getElementById('postAssessmentStatus');

            const isPreComplete = user.assessments?.preCompleted === true;
            const isPostComplete = user.assessments?.postCompleted === true;
            const overallProgress = calculateOverallProgress(user);

            console.log(`PreAssessment Complete: ${isPreComplete}, PostAssessment Complete: ${isPostComplete}, Overall Progress: ${overallProgress}%`);

             // Pre-Assessment Logic
            if (!isPreComplete) {
                console.log("Showing Pre-Assessment");
                if (preAssessmentSection) preAssessmentSection.style.display = 'block';
                if (preAssessmentStatusEl) { preAssessmentStatusEl.textContent = 'Not Started'; preAssessmentStatusEl.className = 'assessment-status'; }
                if (courseSectionsContainer) courseSectionsContainer.style.display = 'none'; // Hide course content
                if (postAssessmentSection) postAssessmentSection.style.display = 'none'; // Hide post-assessment
            } else {
                 console.log("Pre-Assessment Complete. Hiding it.");
                 if (preAssessmentSection) preAssessmentSection.style.display = 'none'; // Hide completed pre-assessment
                 if (courseSectionsContainer) courseSectionsContainer.style.display = 'block'; // Show course content

                // Post-Assessment Logic (only if pre is complete)
                 if (overallProgress >= POST_ASSESSMENT_THRESHOLD && !isPostComplete) {
                     console.log("Showing Post-Assessment");
                     if (postAssessmentSection) postAssessmentSection.style.display = 'block';
                     if (postAssessmentStatusEl) { postAssessmentStatusEl.textContent = 'Required'; postAssessmentStatusEl.className = 'assessment-status in-progress'; }
                 } else if (isPostComplete) {
                      console.log("Post-Assessment Complete. Hiding it.");
                      if (postAssessmentSection) postAssessmentSection.style.display = 'none'; // Hide completed post-assessment
                 } else {
                     console.log("Post-Assessment not yet triggered or already hidden.");
                      if (postAssessmentSection) postAssessmentSection.style.display = 'none'; // Ensure hidden otherwise
                 }
            }
        }

        function calculateOverallProgress(user) {
            if (!user || !user.progress) return 0;
            const progressValues = courseSections.map(section => user.progress[section.id] || 0);
            if (progressValues.length === 0) return 0;
            const sum = progressValues.reduce((acc, current) => acc + current, 0);
            return Math.round(sum / progressValues.length);
        }

        function displayCourseSections(user, containerElement) { /* ... (Keep existing display logic, reads user.progress) ... */
            if (!user || !containerElement) { console.error("Cannot display sections."); return; }
            containerElement.innerHTML = '';
            if (!user.progress) user.progress = {};

            courseSections.forEach(section => {
                const progress = user.progress[section.id] || 0;
                const progressPercentage = Math.max(0, Math.min(100, Math.round(progress)));
                const sectionElement = document.createElement('div');
                sectionElement.className = 'course-section';
                sectionElement.innerHTML = ` <span class="section-title">${section.title}</span> <div class="section-progress"> <div class="progress-bar-container"> <div class="progress-bar" style="width: ${progressPercentage}%;"></div> </div> <span class="progress-text">${progressPercentage}% Complete</span> <a href="${section.link || '#'}" class="section-link" title="Go to ${section.title}">Start</a> </div> `;
                 const linkButton = sectionElement.querySelector('.section-link');
                 if(progress >= 100){linkButton.textContent='Review'; linkButton.style.backgroundColor='var(--success-color)'; linkButton.onmouseover=()=>linkButton.style.backgroundColor='#219653'; linkButton.onmouseout=()=>linkButton.style.backgroundColor='var(--success-color)';}
                 else if(progress > 0){linkButton.textContent='Continue'; linkButton.style.backgroundColor='var(--warning-color)'; linkButton.onmouseover=()=>linkButton.style.backgroundColor='#d35400'; linkButton.onmouseout=()=>linkButton.style.backgroundColor='var(--warning-color)';}
                 else{linkButton.style.backgroundColor='var(--accent-color)'; linkButton.onmouseover=()=>linkButton.style.backgroundColor='#2980b9'; linkButton.onmouseout=()=>linkButton.style.backgroundColor='var(--accent-color)';}
                containerElement.appendChild(sectionElement);
            });
        }

        function setupAdminPanel(user) {
            const isAdmin = user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
            const adminSection = document.getElementById('adminSection');
            const adminDataContainer = document.getElementById('adminDataContainer');

            if (isAdmin) {
                console.log("Admin user detected.");
                if (adminSection) adminSection.style.display = 'block';
                if (adminDataContainer) displayAdminData(adminDataContainer, user);
                 else console.error("Admin data container not found!");
            } else {
                console.log("Regular user detected.");
                if (adminSection) adminSection.style.display = 'none';
            }
        }

        function displayAdminData(containerElement, adminUser) { /* Displays admin's *own* data */
             if (!containerElement || !adminUser) return;
              if (!adminUser.progress) { containerElement.innerHTML = '<p>Error: Admin user progress data missing.</p>'; return; }
              if (!adminUser.assessments) { adminUser.assessments = { preScore: null, postScore: null };} // Ensure assessments obj exists

             let tableHTML = `
                <table class="admin-user-table">
                    <thead> <tr> <th>Section</th> <th>Progress (%)</th> <th>Pre-Score</th> <th>Post-Score</th> <th>Status</th> </tr> </thead>
                    <tbody> `;

             courseSections.forEach(section => {
                 const progress = adminUser.progress[section.id] || 0;
                 const progressPercentage = Math.max(0, Math.min(100, Math.round(progress)));
                 let status = 'Not Started'; if (progress >= 100) status = 'Completed'; else if (progress > 0) status = 'In Progress';
                 tableHTML += ` <tr> <td>${section.title}</td> <td>${progressPercentage}%</td> <td>${adminUser.assessments.preScore ?? 'N/A'}</td> <td>${adminUser.assessments.postScore ?? 'N/A'}</td> <td>${status}</td> </tr> `;
             });

             tableHTML += ` </tbody> </table> <p style="margin-top: 15px; font-size: 14px;"><em>(Showing data for logged-in admin only. Full implementation requires backend.)</em></p> `;
             containerElement.innerHTML = tableHTML;
         }

        function logout() { /* ... (Keep existing logout logic) ... */
             console.log("Logging out user..."); try { localStorage.removeItem(LOGGED_IN_KEY); localStorage.removeItem(CURRENT_USER_KEY); console.log("Local storage cleared for logout."); window.location.href = 'login.html'; } catch (e) { console.error("Error during logout:", e); window.location.href = 'login.html'; }
        }

        // --- Assessment Functions (Placeholders) ---
        function startPreAssessment() {
             console.log("Starting Pre-Assessment...");
             document.getElementById('preAssessmentContent').style.display = 'block';
             // Hide the start button maybe?
             event.target.style.display = 'none';
         }

        function submitPreAssessment() {
            console.log("Submitting Pre-Assessment...");
            const currentUser = getCurrentUser();
            if (!currentUser) return;

            const answers = {};
            const form = document.getElementById('preAssessmentForm');
             form.querySelectorAll('textarea[data-assessment-question]').forEach(field => {
                 answers[field.dataset.assessmentQuestion] = field.value.trim();
             });

            // Basic validation (e.g., ensure all are filled - add if needed)
             // let allFilled = Object.values(answers).every(ans => ans !== '');
             // if (!allFilled) { alert("Please answer all pre-assessment questions."); return; }

            currentUser.assessments.preCompleted = true;
            currentUser.assessments.preAnswers = answers;
            // Placeholder for scoring logic - maybe just based on completion for now
            currentUser.assessments.preScore = 100; // Indicate completion

            saveCurrentUser(currentUser);
            console.log("Pre-Assessment saved:", currentUser.assessments);

            // Update UI
            handleContentVisibility(currentUser); // Re-check visibility
            displayCourseSections(currentUser, document.getElementById('courseSectionsList')); // Reload sections now they are visible
            // Potentially update admin view if visible
            if (currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                 displayAdminData(document.getElementById('adminDataContainer'), currentUser);
            }

             alert("Pre-Assessment Submitted! You can now access the course content.");
         }

        function startPostAssessment() {
             console.log("Starting Post-Assessment...");
             document.getElementById('postAssessmentContent').style.display = 'block';
             event.target.style.display = 'none';
         }

         function submitPostAssessment() {
             console.log("Submitting Post-Assessment...");
             const currentUser = getCurrentUser();
             if (!currentUser) return;

             const answers = {};
             const form = document.getElementById('postAssessmentForm');
              form.querySelectorAll('textarea[data-assessment-question]').forEach(field => {
                  answers[field.dataset.assessmentQuestion] = field.value.trim();
              });

             // Basic validation
              // let allFilled = Object.values(answers).every(ans => ans !== '');
              // if (!allFilled) { alert("Please answer all post-assessment questions."); return; }


             currentUser.assessments.postCompleted = true;
             currentUser.assessments.postAnswers = answers;
             currentUser.assessments.postScore = 100; // Placeholder score

             saveCurrentUser(currentUser);
             console.log("Post-Assessment saved:", currentUser.assessments);

             // Update UI
             handleContentVisibility(currentUser); // Hide the post-assessment section
             // Potentially update admin view if visible
             if (currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                  displayAdminData(document.getElementById('adminDataContainer'), currentUser);
             }
             alert("Post-Course Evaluation Submitted! Thank you.");
         }


    </script>
</body>
</html>
