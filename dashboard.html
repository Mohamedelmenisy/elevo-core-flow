<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Coaching & Leadership</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- Base Styles (Enhanced) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f8fafc; margin: 0; padding: 0; line-height: 1.6; color: #374151; display: flex; flex-direction: column; min-height: 100vh; }
        main { flex-grow: 1; display: flex; justify-content: center; align-items: flex-start; flex-direction: column; width: 100%; max-width: 1000px; margin: 20px auto; padding: 0 20px; /* Adjusted padding */ }
        .header { background: linear-gradient(90deg, #2c3e50, #34495e); color: white; padding: 18px 0; text-align: center; font-size: 26px; font-weight: 600; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); width: 100%; border-bottom: 3px solid #3498db; }
        .user-bar { background-color: #ffffff; padding: 12px 30px; display: flex; justify-content: space-between; align-items: center; color: #4b5563; font-size: 15px; width: 100%; border-bottom: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-info svg { color: #3498db; opacity: 1; }
        .user-details-bar { display: flex; flex-direction: column; }
        .user-name-bar { font-weight: 600; font-size: 16px; color: #1f2937; }
        .user-email-bar { font-size: 13px; opacity: 0.8; color: #6b7280; }
        .logout-button { background-color: #ef4444; color: white; border: none; padding: 9px 18px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; }
        .logout-button:hover { background-color: #dc2626; box-shadow: 0 2px 5px rgba(239, 68, 68, 0.3); transform: translateY(-1px); }
        .logout-button:active { transform: translateY(0); }
        .footer { text-align: center; padding: 25px 30px; background: #f9fafb; color: #6b7280; margin-top: auto; font-size: 14px; width: 100%; border-top: 1px solid #e5e7eb; }

        /* --- Dashboard & Assessment Container Styles --- */
        .dashboard-container, #assessmentSection {
            background: white;
            padding: 35px 45px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); /* Subtle shadow */
            border-radius: 12px;
            width: 100%;
            margin-bottom: 35px;
            text-align: left;
            opacity: 0; /* Initially hidden for fade-in */
            transition: opacity 0.7s ease-in-out;
             border: 1px solid #e5e7eb;
        }
        .dashboard-container.fade-in, #assessmentSection.fade-in { opacity: 1; }
        .dashboard-container h2, #assessmentSection h2 {
            color: #1f2937;
            margin-bottom: 25px;
            font-size: 28px; /* Slightly larger */
            font-weight: 600;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 15px;
        }
         .dashboard-user-details {
            background-color: #f9fafb; /* Lighter bg */
            padding: 18px 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 18px;
             border: 1px solid #e5e7eb;
        }
        .dashboard-user-details svg { color: #3b82f6; width: 36px; height: 36px; }
        .dashboard-user-info { font-size: 17px; color: #374151; }
        .dashboard-user-info strong { font-weight: 600; color: #111827; }

        /* --- Course Section Styles --- */
        .course-sections h3 { color: #1f2937; margin-top: 35px; margin-bottom: 20px; font-size: 22px; font-weight: 600; }
        .course-section { background-color: #ffffff; border: 1px solid #e5e7eb; padding: 18px 25px; margin-bottom: 18px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; transition: box-shadow 0.3s ease, transform 0.2s ease, border-color 0.3s ease; flex-wrap: wrap; gap: 15px; }
        .course-section:hover { box-shadow: 0 4px 12px rgba(0,0,0, 0.08); transform: translateY(-2px); border-left: 4px solid #3b82f6; padding-left: 22px; } /* Added left border on hover */
        .section-title { font-size: 18px; font-weight: 500; color: #374151; flex-grow: 1; margin-right: 20px; }
        .section-progress { display: flex; align-items: center; gap: 18px; flex-shrink: 0; flex-basis: 300px; /* Slightly wider */ }
        .progress-bar-container { width: 160px; /* Wider bar */ height: 12px; background-color: #e5e7eb; border-radius: 6px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #60a5fa, #3b82f6); border-radius: 6px; transition: width 0.8s cubic-bezier(0.25, 0.1, 0.25, 1); } /* Smoother cubic-bezier transition */
        .progress-text { font-size: 14px; color: #6b7280; min-width: 90px; text-align: right; font-weight: 500; }
        .section-link { background-color: #3b82f6; color: white; padding: 8px 15px; border-radius: 6px; text-decoration: none; font-size: 14px; font-weight: 500; transition: background-color 0.3s, transform 0.2s ease, box-shadow 0.3s ease; white-space: nowrap; }
        .section-link:hover { background-color: #2563eb; transform: translateY(-1px); box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3); }
        /* Button styles for different states */
         .section-link.status-review { background-color: #10b981; }
         .section-link.status-review:hover { background-color: #059669; box-shadow: 0 2px 5px rgba(16, 185, 129, 0.3); }
         .section-link.status-continue { background-color: #f59e0b; }
         .section-link.status-continue:hover { background-color: #d97706; box-shadow: 0 2px 5px rgba(245, 158, 11, 0.3); }

        /* --- Pre-Course Assessment Styles --- */
        #assessmentSection { display: none; }
        #assessmentSection .intro-note {
            background-color: #eff6ff; /* Light blue */
            border-left: 5px solid #3b82f6;
            padding: 18px 25px;
            margin-bottom: 30px;
            border-radius: 6px;
            font-size: 16px;
            color: #374151;
            line-height: 1.7;
        }
        #assessmentForm .form-group { margin-bottom: 30px; }
        #assessmentForm label { display: block; margin-bottom: 10px; font-weight: 600; color: #374151; font-size: 17px; }
        #assessmentForm textarea, #assessmentForm input[type="number"], #assessmentForm select {
            width: 100%;
            padding: 14px 16px; /* More padding */
            border: 1px solid #d1d5db; /* Slightly darker border */
            border-radius: 8px; /* More rounded */
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
            color: #1f2937;
        }
        #assessmentForm textarea { min-height: 120px; resize: vertical; }
        #assessmentForm textarea:focus, #assessmentForm input[type="number"]:focus, #assessmentForm select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
            outline: none;
        }
        #assessmentForm .input-meta-info { display: flex; justify-content: space-between; align-items: center; margin-top: 6px; }
        #assessmentForm .word-count-info { font-size: 13px; color: #6b7280; }
        #assessmentForm .paste-warning { font-size: 13px; color: #f97316; /* Orange warning */ display: none; }
        #assessmentForm .error-message { color: #ef4444; font-size: 14px; margin-top: 8px; display: none; font-weight: 500;}
        #assessmentForm input.invalid, #assessmentForm textarea.invalid { border-color: #ef4444; }
        #assessmentSubmitBtn {
            background-color: #10b981; /* Emerald green */
            color: white;
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
        }
        #assessmentSubmitBtn:hover { background-color: #059669; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2); }
        #assessmentSubmitBtn:disabled { background-color: #9ca3af; cursor: not-allowed; transform: none; box-shadow: none;}

        /* Success Popup */
        #assessmentSuccessPopup {
            display: none; position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%);
            background-color: white; padding: 45px 50px; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); z-index: 1000; text-align: center;
            border-top: 6px solid #10b981; min-width: 350px;
        }
         #assessmentSuccessPopup p { font-size: 19px; color: #374151; margin-bottom: 30px; line-height: 1.6; }
         #assessmentSuccessPopup button {
            background-color: #3b82f6; color: white; padding: 12px 25px; border: none;
            border-radius: 6px; cursor: pointer; font-size: 17px; transition: background-color 0.3s; font-weight: 500;
         }
         #assessmentSuccessPopup button:hover { background-color: #2563eb; }
         .popup-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 999; }


        /* --- Admin Section Styles --- */
        #adminSection {
            background-color: #fef3c7; /* Light yellow for admin */ border: 1px solid #fcd34d; border-radius: 12px;
            padding: 35px 45px; margin-top: 25px; width: 100%; display: none; opacity: 0;
            transition: opacity 0.7s ease-in-out;
        }
        #adminSection.fade-in { opacity: 1; }
        #adminSection h3 { color: #b45309; /* Dark yellow/brown */ margin-bottom: 25px; font-size: 24px; border-bottom: 2px solid #fcd34d; padding-bottom: 15px; display: flex; align-items: center; gap: 10px; font-weight: 600; }
        #adminSection h3 svg { color: #b45309; }
        .admin-note { font-size: 15px; color: #78350f; background-color: #fffbeb; border: 1px solid #fef08a; padding: 15px 20px; border-radius: 6px; margin-bottom: 30px; line-height: 1.7; }
        .admin-note strong { color: #92400e; } /* Make strong text darker */
        /* NEW: Admin User Info Styles */
        .admin-user-info { background-color: #fffbeb; border: 1px solid #fde68a; padding: 10px 15px; border-radius: 6px; margin-bottom: 20px; font-size: 15px; color: #374151; }
        .admin-user-info strong { color: #92400e; }
        /* Admin Table Styles */
        .admin-user-table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; /* Use fixed for better column control */ }
        .admin-user-table th, .admin-user-table td { border: 1px solid #fde68a; padding: 12px 15px; text-align: left; font-size: 15px; word-wrap: break-word; vertical-align: middle; }
        .admin-user-table th { background-color: #fef9c3; color: #92400e; font-weight: 600; }
        .admin-user-table td { background-color: #fffbeb; color: #374151;}

        /* Specific widths for the OLD progress table (admin's own) */
        #adminCourseProgressContainer .admin-user-table th:nth-child(1) { width: 40%; } /* Section Title */
        #adminCourseProgressContainer .admin-user-table th:nth-child(2) { width: 25%; text-align: center;} /* Progress */
        #adminCourseProgressContainer .admin-user-table th:nth-child(3) { width: 35%; } /* Status */
        #adminCourseProgressContainer .admin-user-table td:nth-child(2) { text-align: center; font-weight: 500;}

        /* Specific widths for the NEW All Users table */
        #allUsersTable th:nth-child(1) { width: 20%; } /* Name */
        #allUsersTable th:nth-child(2) { width: 25%; } /* Email */
        #allUsersTable th:nth-child(3) { width: 15%; text-align: center; } /* Avg Progress */
        #allUsersTable th:nth-child(4) { width: 15%; text-align: center; } /* Status */
        #allUsersTable th:nth-child(5) { width: 25%; } /* Last Update */
        #allUsersTable td { font-size: 14px; } /* Slightly smaller font for all users table */
        #allUsersTable td:nth-child(3) { text-align: center; font-weight: 500; } /* Center progress */
        #allUsersTable td:nth-child(4) { text-align: center; font-weight: 500; } /* Center status */
        .status-completed { color: #059669; font-weight: bold; }
        .status-in-progress { color: #d97706; }
        .status-not-started { color: #6b7280; font-style: italic; }


        /* Admin Analysis Styles */
        .admin-analysis-section { margin-top: 35px; border-top: 1px dashed #fcd34d; padding-top: 30px; }
        .admin-analysis-section h4 { color: #b45309; font-size: 20px; margin-bottom: 20px; font-weight: 600; }
        /* Chart Styling */
        .admin-chart-row { display: flex; flex-wrap: wrap; gap: 30px; justify-content: space-around; margin-bottom: 30px;}
        .admin-chart-container { flex: 1 1 400px; /* Allow wrapping */ max-width: 450px; height: 250px; background: #fffbeb; padding: 15px; border-radius: 8px; border: 1px solid #fef08a; }
        .admin-chart-container canvas { max-width: 100%; height: auto; } /* Responsive canvas */

        #adminAssessmentDetails { background-color: #fffbeb; border: 1px solid #fef08a; padding: 20px; border-radius: 8px; margin-top: 20px; }
        #adminAssessmentDetails h5 { color: #92400e; margin-bottom: 15px; font-size: 17px; border-bottom: 1px solid #fde68a; padding-bottom: 8px; }
        #adminAssessmentDetails dl { margin: 0; }
        #adminAssessmentDetails dt { font-weight: 600; color: #78350f; margin-top: 12px; font-size: 15px; }
        #adminAssessmentDetails dd { margin-left: 0; margin-bottom: 10px; color: #374151; font-size: 14px; padding-left: 10px; border-left: 3px solid #fcd34d; background: #fef9c3; padding-top: 5px; padding-bottom: 5px; border-radius: 0 4px 4px 0;}
        #adminAssessmentDetails dd pre { white-space: pre-wrap; word-wrap: break-word; font-family: inherit; font-size: inherit; margin:0; } /* Preserve formatting */
        #adminProgressAnalysis p { font-size: 16px; margin-bottom: 10px; }
        #adminProgressAnalysis .progress-value { font-weight: bold; color: #1f2937; }
        #adminProgressAnalysis .feedback-good { color: #059669; font-weight: bold; background-color: #d1fae5; padding: 8px 12px; border-radius: 6px; display: inline-block; }
        .feedback-good-inline { /* NEW Style for inline feedback in table */
            font-size: 12px;
            font-weight: bold;
            color: #059669;
            background-color: #d1fae5;
            padding: 2px 5px;
            border-radius: 4px;
            margin-left: 5px;
            white-space: nowrap;
        }
        #adminProgressAnalysis .feedback-neutral { color: #4b5563; font-style: italic; }

        /* NEW: All Users Section Styles */
        #allUsersAdminSection { margin-top: 30px; border-top: 1px dashed #fcd34d; padding-top: 30px; }
        #allUsersAdminSection h4 { color: #b45309; font-size: 20px; margin-bottom: 15px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        #adminFilterContainer { margin-bottom: 20px; background-color: #fffbeb; padding: 15px 20px; border-radius: 8px; border: 1px solid #fde68a; display: flex; flex-wrap: wrap; align-items: center; gap: 15px; }
        #adminFilterContainer label { font-weight: 600; color: #92400e; font-size: 15px; margin-right: 5px;}
        #adminFilterContainer select, #adminFilterContainer input[type="text"] { padding: 8px 12px; border-radius: 5px; border: 1px solid #fcd34d; font-size: 14px; flex-grow: 1; min-width: 150px; }
        #adminFilterContainer button { background-color: #d97706; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; font-size: 14px;}
        #adminFilterContainer button:hover { background-color: #b45309;}
        #adminDownloadCsvBtn { background-color: #059669; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; font-size: 14px; margin-left: auto;} /* Positioned with label */
        #adminDownloadCsvBtn:hover { background-color: #047857;}
        #noUsersMessage { text-align: center; color: #78350f; margin-top: 20px; font-style: italic; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #b45309; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-left: 10px; vertical-align: middle;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }


         /* Loading Message */
         #loadingMessage { text-align: center; padding: 60px 20px; font-size: 20px; color: #6b7280; width: 100%; }
         .content-placeholder { background-color: #e5e7eb; border-radius: 6px; min-height: 20px; margin: 5px 0; animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
         @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }


         /* Responsive Adjustments */
         @media (max-width: 768px) {
             main { padding: 0 15px; margin: 15px auto; }
             .dashboard-container, #assessmentSection, #adminSection { padding: 25px 30px; }
             .header { font-size: 22px; padding: 15px 0; }
             .user-bar { padding: 10px 20px; }
             .admin-user-table th, .admin-user-table td { font-size: 14px; padding: 10px; }
             .admin-chart-row { flex-direction: column; gap: 20px;}
             .admin-chart-container { max-width: 100%; height: 280px; /* Adjust height for stacking */ }
             #allUsersTable th, #allUsersTable td { font-size: 13px; padding: 8px;}
             #allUsersAdminSection { overflow-x: auto; }
             #allUsersTable { table-layout: auto; min-width: 600px; /* Ensure scroll */ }
             #allUsersTable th, #allUsersTable td { white-space: nowrap; }
             #adminFilterContainer { gap: 10px; }
             #adminDownloadCsvBtn { margin-left: 0; margin-top: 10px; width: 100%; } /* Stack button on mobile */
         }
         @media (max-width: 600px) {
             .dashboard-container, #assessmentSection, #adminSection { padding: 20px; }
             .course-section { flex-direction: column; align-items: flex-start; padding: 15px; }
             .section-title { margin-right: 0; margin-bottom: 12px; font-size: 17px;}
             .section-progress { flex-basis: auto; width: 100%; justify-content: space-between; gap: 10px; }
             .progress-bar-container { flex-grow: 1; margin-right: 10px; height: 10px; }
             .progress-text { min-width: auto; }
             .section-link { padding: 7px 12px; font-size: 13px; }
             .admin-user-table th, .admin-user-table td { font-size: 13px; padding: 8px; }
             #assessmentSuccessPopup { width: 90%; padding: 30px 25px; }
             #assessmentForm textarea { min-height: 100px; }
             #assessmentForm label { font-size: 16px; }
             #assessmentForm input[type="number"], #assessmentForm textarea, #assessmentForm select { padding: 12px 14px; font-size: 15px; }
             #assessmentSubmitBtn { padding: 12px 25px; font-size: 16px; }
             #adminSection h3 { font-size: 20px; }
             .admin-analysis-section h4, #allUsersAdminSection h4 { font-size: 18px; }
             #adminAssessmentDetails { padding: 15px; }
             #adminAssessmentDetails h5 { font-size: 16px; }
             #adminAssessmentDetails dt { font-size: 14px; }
             #adminAssessmentDetails dd { font-size: 13px; }
             .admin-chart-container { height: 250px; }
             #adminFilterContainer { flex-direction: column; align-items: stretch; }
             #adminFilterContainer select, #adminFilterContainer input[type="text"], #adminFilterContainer button { width: 100%; margin-bottom: 5px; }
         }

    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">Coaching & Leadership Dashboard</header>

    <!-- User Bar -->
    <div class="user-bar">
        <div class="user-info">
             <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path> <circle cx="12" cy="7" r="4"></circle> </svg>
            <div class="user-details-bar">
                <span class="user-name-bar" id="userNameBar"><span class="content-placeholder" style="width: 100px; display: inline-block;"></span></span>
                <span class="user-email-bar" id="userEmailBar"><span class="content-placeholder" style="width: 150px; display: inline-block;"></span></span>
            </div>
        </div>
        <button class="logout-button" onclick="logout()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path> <polyline points="16 17 21 12 16 7"></polyline> <line x1="21" y1="12" x2="9" y2="12"></line> </svg>
            Logout
        </button>
    </div>

    <!-- Main Content Area -->
    <main>
        <div id="loadingMessage">Loading Dashboard Data... <div class="loading-spinner" style="width: 25px; height: 25px;"></div></div>
        <div id="errorMessage" style="color: red; text-align: center; padding: 20px; display: none;"></div>

        <!-- Pre-Course Assessment Section -->
        <section id="assessmentSection">
             <h2>Pre-Course Assessment</h2>
            <p class="intro-note">
                <strong>Welcome!</strong> Before you begin the course modules, please take a moment to answer these questions. Your answers help us personalize your experience. Please answer honestly in your own words. <span id="adminAssessmentNote" style="display: none; font-weight: bold; color: #b45309;"> (Admin: Word count and paste restrictions are disabled for your account.)</span>
            </p>
            <form id="assessmentForm" novalidate>
                 <!-- Question 1 -->
                <div class="form-group">
                    <label for="q1_coaching_meaning">What does coaching mean to you?</label>
                    <textarea id="q1_coaching_meaning" name="coaching_meaning" required data-min-words="20" placeholder="Describe your understanding of coaching..."></textarea>
                    <div class="input-meta-info">
                        <div class="paste-warning" id="q1_paste_warning">Pasting content is discouraged. Please use your own words.</div>
                        <div class="word-count-info" id="q1_word_count_container">Words: <span id="q1_word_count">0</span>/20</div>
                    </div>
                    <div class="error-message" id="q1_error"></div>
                </div>

                <!-- Question 2 (Randomized) -->
                 <div class="form-group" id="randomQuestionContainer">
                     <!-- Label and Input will be inserted here by JS -->
                     <div class="input-meta-info">
                         <div class="paste-warning" id="q_random_paste_warning">Pasting content is discouraged. Please use your own words.</div>
                         <div class="word-count-info" id="q_random_word_count_container">Words: <span id="q_random_word_count">0</span>/<span id="q_random_min_words_display">?</span></div>
                     </div>
                     <div class="error-message" id="q_random_error"></div>
                 </div>

                <!-- Question 3 -->
                <div class="form-group">
                    <label for="q3_expectations">What are your expectations from this course?</label>
                    <textarea id="q3_expectations" name="expectations" required data-min-words="15" placeholder="What do you hope to learn or achieve?"></textarea>
                     <div class="input-meta-info">
                         <div class="paste-warning" id="q3_paste_warning">Pasting content is discouraged. Please use your own words.</div>
                         <div class="word-count-info" id="q3_word_count_container">Words: <span id="q3_word_count">0</span>/15</div>
                     </div>
                    <div class="error-message" id="q3_error"></div>
                </div>

                <!-- Question 4 -->
                 <div class="form-group">
                    <label for="q4_confidence_rating">Rate your current coaching confidence (1=Low, 5=High)</label>
                    <input type="number" id="q4_confidence_rating" name="confidence_rating" required min="1" max="5" step="1" placeholder="Enter a number between 1 and 5">
                    <div class="error-message" id="q4_rating_error"></div>

                    <label for="q4_confidence_explanation" style="margin-top: 15px;">Briefly explain your rating:</label>
                    <textarea id="q4_confidence_explanation" name="confidence_explanation" required data-min-words="10" placeholder="Why did you choose this rating?"></textarea>
                     <div class="input-meta-info">
                         <div class="paste-warning" id="q4_exp_paste_warning">Pasting content is discouraged. Please use your own words.</div>
                         <div class="word-count-info" id="q4_exp_word_count_container">Words: <span id="q4_exp_word_count">0</span>/10</div>
                     </div>
                    <div class="error-message" id="q4_exp_error"></div>
                </div>

                <button type="submit" id="assessmentSubmitBtn">Submit Assessment</button>
            </form>
        </section>

         <!-- Success Popup -->
         <div class="popup-overlay" id="popupOverlay"></div>
         <div id="assessmentSuccessPopup">
             <p>Thank you! Your answers have been saved. You can now start your journey!</p>
             <button id="startJourneyBtn">Start Course</button>
         </div>

        <!-- User Dashboard Container -->
        <div class="dashboard-container" id="userDashboardContent" style="display: none;">
            <h2 id="welcomeMessage">Welcome!</h2>
            <div class="dashboard-user-details">
                 <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                 <div class="dashboard-user-info">
                     Logged in as: <strong id="dashboardUserName"><span class="content-placeholder" style="width: 80px;"></span></strong> (<span id="dashboardUserEmail"><span class="content-placeholder" style="width: 120px;"></span></span>)
                 </div>
            </div>
            <div class="course-sections">
                <h3>Your Course Progress</h3>
                <div id="courseSectionsList">
                    <!-- Placeholder for loading -->
                    <div class="content-placeholder" style="height: 80px; margin-bottom: 15px;"></div>
                    <div class="content-placeholder" style="height: 80px; margin-bottom: 15px;"></div>
                    <div class="content-placeholder" style="height: 80px;"></div>
                </div>
            </div>
        </div>

        <!-- Admin-Only Section -->
        <div id="adminSection">
             <h3>
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                 Admin Panel - Analysis Overview
             </h3>
             <!-- Admin User Info Display -->
             <div class="admin-user-info">
                 <p><strong>Admin User:</strong> <span id="adminPanelName"><span class="content-placeholder" style="width: 80px;"></span></span></p>
                 <p><strong>Email:</strong> <span id="adminPanelEmail"><span class="content-placeholder" style="width: 120px;"></span></span></p>
             </div>
             <p class="admin-note">
                 <strong>Data Source:</strong> This panel displays data fetched directly from the Supabase database. Ensure Row Level Security (RLS) is properly configured in Supabase for data protection.
             </p>

            <!-- Admin's Own Course Progress -->
            <div id="adminCourseProgressContainer">
                 <h4>Your (Admin) Course Section Progress</h4>
                 <div class="content-placeholder" style="height: 150px;"></div>
                 <!-- Admin's own course progress table will be loaded here -->
            </div>

            <!-- Admin's Own Analysis Section -->
            <div class="admin-analysis-section">
                <h4>Your (Admin) Confidence & Assessment Analysis</h4>
                 <div class="admin-chart-row">
                     <div class="admin-chart-container" id="adminChartContainer">
                         <canvas id="confidenceChart"></canvas>
                         <p style="text-align: center; font-size: 12px; color: #78350f; margin-top: 5px;"><em>Confidence Score Comparison (Pre vs Post*)</em></p>
                     </div>
                     <!-- Placeholder for another chart if needed -->
                     <!-- <div class="admin-chart-container"> ... </div> -->
                 </div>
                <div id="adminAssessmentDetails">
                    <h5>Your (Admin) Pre-Course Assessment Answers & Progress</h5>
                    <div id="adminProgressAnalysis">
                        <div class="content-placeholder" style="height: 60px;"></div>
                    </div>
                     <div id="adminAssessmentAnswersDisplay">
                          <div class="content-placeholder" style="height: 100px;"></div>
                     </div>
                    <p style="margin-top: 15px; font-size: 13px; color: #78350f;"><em>*Note: 'Post-Course' confidence score/assessment is currently simulated or fetched if available in DB.</em></p>
                </div>
            </div>

            <!-- All User Data Section (Supabase Powered) -->
            <div id="allUsersAdminSection">
                 <h4>
                     All User Data
                     <span id="adminDataLoadingSpinner" style="display: none;"><div class="loading-spinner"></div> Loading...</span>
                     <button id="adminDownloadCsvBtn" title="Download current view as CSV">
                         <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: middle; margin-right: 5px;">
                             <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                             <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                         </svg>Download CSV
                     </button>
                 </h4>
                 <!-- Filters -->
                 <div id="adminFilterContainer">
                     <div>
                         <label for="filterNameEmail">Name/Email:</label>
                         <input type="text" id="filterNameEmail" placeholder="Search name or email...">
                     </div>
                     <div>
                        <label for="filterSection">Section:</label>
                         <select id="filterSection">
                             <option value="">All Sections</option>
                             <!-- Options populated by JS -->
                         </select>
                     </div>
                     <div>
                         <label for="filterProgress">Min Progress:</label>
                         <select id="filterProgress">
                             <option value="0">Any Progress</option>
                             <option value="25">25%+</option>
                             <option value="50">50%+</option>
                             <option value="75">75%+</option>
                             <option value="100">100% (Completed)</option>
                         </select>
                     </div>
                     <button id="applyFiltersBtn">Apply Filters</button>
                 </div>
                 <!-- All Users Table -->
                 <table id="allUsersTable" class="admin-user-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Avg Progress</th>
                            <th>Status</th>
                            <th>Last Update</th>
                        </tr>
                    </thead>
                    <tbody id="allUsersTableBody">
                        <!-- Loading Placeholder -->
                        <tr><td colspan="5" style="text-align: center; padding: 30px;">Loading user data... <div class="loading-spinner"></div></td></tr>
                    </tbody>
                 </table>
                 <p id="noUsersMessage" style="display: none;">No users match the current filters.</p>

                 <!-- NEW: Overall Progress Distribution Chart -->
                 <h4>Overall Progress Distribution</h4>
                  <div class="admin-chart-row">
                     <div class="admin-chart-container" id="progressDistributionChartContainer">
                          <canvas id="progressDistributionChart"></canvas>
                     </div>
                     <!-- Add more charts here if needed -->
                  </div>

            </div>

        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        © 2025 Elmenisy Leadership Coaching - All Rights Reserved
    </footer>

    <script>
        // --- Constants ---
        const LOGGED_IN_KEY = 'isUserLoggedIn';
        const CURRENT_USER_KEY = 'currentUser'; // Still used for initial email/name retrieval
        // const ALL_USERS_KEY = 'allUsers'; // NO LONGER USED FOR PRIMARY DATA
        const SIGNUP_FLAG_KEY = 'hasSignedUpBefore';
        const ADMIN_EMAIL = 'm.elsayed@thechefz.co'; // Case-insensitive comparison

        // --- SUPABASE Setup ---
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        // !!! Values below have been replaced with your details.  !!!
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        const SUPABASE_URL = 'https://lgcutmuspcaralydycmg.supabase.co'; // <-- YOUR URL HERE
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnY3V0bXVzcGNhcmFseWR5Y21nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0NDY3MDEsImV4cCI6MjA2MTAyMjcwMX0.3u5Y7pkH2NNnnoGLMWVfAa5b8fq88o1itRYnG1K38tE'; // <-- YOUR ANON KEY HERE

        // Check if placeholders are still present (redundant now, but safe to keep)
        if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
            console.warn("Supabase URL or Key not set. Please replace placeholders in the script.");
            // Display error message to user
             const loadingMsg = document.getElementById('loadingMessage');
             const errorMsg = document.getElementById('errorMessage');
             if (loadingMsg) loadingMsg.style.display = 'none';
             if (errorMsg) {
                 // This error *should not* appear now.
                 errorMsg.textContent = 'Configuration Error: Supabase connection details are missing. Please contact support.';
                 errorMsg.style.display = 'block';
             }
             // Prevent further execution if config is missing
             throw new Error("Supabase configuration missing.");
        }

        // This part is CORRECT and uses the constants defined above.
        // Ensure the @supabase/supabase-js library is included in the <head> (which it is).
        const { createClient } = supabase; // Ensure Supabase is loaded
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log("Supabase client initialized with provided credentials."); // Confirmation message

        // Assessment Question Pool (No changes needed)
        const randomQuestionPool = [
            { id: 'q_leadership_vs_management', label: 'How do you differentiate leadership from management?', minWords: 20 },
            { id: 'q_coaching_challenge', label: 'What do you see as the biggest challenge in coaching others?', minWords: 20 },
            { id: 'q_leadership_style', label: 'Briefly describe your ideal leadership style.', minWords: 15 }
        ];
        let selectedRandomQuestion = null;

        const courseSections = [
            { id: 'index', title: 'Course Introduction Goal', link: 'index.html' },
            { id: 'article1', title: 'Introduction to Coaching and Leadership', link: 'article1.html' },
            { id: 'skills', title: 'Coaching Skills', link: 'coaching-skills.html' },
            { id: 'individuals', title: 'Coaching Individuals', link: 'coaching-individuals.html' },
            { id: 'team', title: 'Team Coaching', link: 'coaching-team.html' },
            { id: 'self', title: 'Self Coaching', link: 'coaching-yourself.html' },
            { id: 'action', title: 'Action Plan', link: 'action-plan.html' },
        ];

        // --- Global Variables ---
        let IS_ADMIN_USER = false;
        let confidenceChartInstance = null;
        let progressDistributionChartInstance = null; // For the new chart
        let currentAdminTableData = []; // To store data for CSV export

        // --- IMMEDIATE REDIRECTION LOGIC (Keep as is, relies on localStorage flag) ---
        console.log("%cDashboard Page: Running IMMEDIATE redirection check...", "color: purple; font-weight: bold;");
        function quickCheckCurrentUserFormat() {
            const data = localStorage.getItem(CURRENT_USER_KEY);
            // Basic check: is it a string that looks like a JSON object?
            return data && data.length > 2 && data.startsWith('{') && data.endsWith('}');
        }
        const isLoggedIn_immediate = localStorage.getItem(LOGGED_IN_KEY) === 'true' && quickCheckCurrentUserFormat();
        const hasSignedUp_immediate = localStorage.getItem(SIGNUP_FLAG_KEY) === 'true';

        if (!isLoggedIn_immediate) {
            const targetUrl = hasSignedUp_immediate ? 'login.html' : 'signup.html';
            console.error(`%cDashboard Page IMMEDIATE Redirect: Not logged in or user data invalid. Redirecting to ${targetUrl}...`, "color: orange;");
            window.location.replace(`${targetUrl}?redirect=${encodeURIComponent(window.location.pathname)}`);
            throw new Error("Redirecting user: Not logged in or invalid user data.");
        } else {
            console.log("%cDashboard Page IMMEDIATE Check: User IS logged in. Proceeding.", "color: green;");
        }
        // --- END IMMEDIATE REDIRECTION ---

        // --- DOMContentLoaded Event Listener ---
        document.addEventListener('DOMContentLoaded', async function() {
            console.log("Dashboard page DOM loaded.");

            // --- Element References ---
            const loadingMessage = document.getElementById('loadingMessage');
            const errorMessage = document.getElementById('errorMessage');
            const assessmentSection = document.getElementById('assessmentSection');
            const userDashboardContent = document.getElementById('userDashboardContent');
            const adminSection = document.getElementById('adminSection');
            const assessmentForm = document.getElementById('assessmentForm');
            const assessmentSuccessPopup = document.getElementById('assessmentSuccessPopup');
            const popupOverlay = document.getElementById('popupOverlay');
            const startJourneyBtn = document.getElementById('startJourneyBtn');
            const applyFiltersBtn = document.getElementById('applyFiltersBtn');
            const downloadCsvBtn = document.getElementById('adminDownloadCsvBtn');
            const filterSectionSelect = document.getElementById('filterSection');

            // Populate section filter dropdown
            courseSections.forEach(section => {
                const option = document.createElement('option');
                option.value = section.id;
                option.textContent = section.title;
                filterSectionSelect.appendChild(option);
            });

            // --- Get Initial User Info (from localStorage for now) ---
            let initialUserData = null;
            try {
                const storedUser = localStorage.getItem(CURRENT_USER_KEY);
                if (storedUser) {
                    initialUserData = JSON.parse(storedUser);
                }
            } catch (e) {
                console.error("Error parsing initial user data from localStorage:", e);
            }

            if (!initialUserData || !initialUserData.email) {
                console.error("Dashboard DOMContentLoaded: Critical - Initial user email missing from localStorage. Forcing logout.");
                showErrorMessage("Failed to load user identity. Please log in again.");
                logout();
                return;
            }

            console.log("Initial User Data (from localStorage):", initialUserData);
            populateTopBar(initialUserData); // Populate top bar early

            // Determine if admin based on email from localStorage
            IS_ADMIN_USER = initialUserData.email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
            console.log(`User is admin: ${IS_ADMIN_USER}`);

            // --- Fetch Full User Data from Supabase ---
            loadingMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            try {
                const currentUserData = await fetchCurrentUserFromSupabase(initialUserData.email);

                if (!currentUserData) {
                    // This case might mean the user exists in localStorage but not Supabase - potential inconsistency
                    console.error("Failed to fetch user data from Supabase for email:", initialUserData.email);
                    showErrorMessage("Could not retrieve your data from the server. Please try refreshing or contact support.");
                    loadingMessage.style.display = 'none';
                    // Optionally logout() here if Supabase data is strictly required
                    return;
                }
                console.log("Current User Data (from Supabase):", currentUserData);

                // --- Assessment Check ---
                if (!currentUserData.assessment_completed) {
                    console.log("Assessment not completed. Displaying assessment form.");
                    setupAssessmentForm(); // Knows about IS_ADMIN_USER
                    loadingMessage.style.display = 'none';
                    assessmentSection.style.display = 'block';
                    setTimeout(() => assessmentSection.classList.add('fade-in'), 50);
                } else {
                    console.log("Assessment completed. Displaying main dashboard.");
                    await displayMainDashboard(currentUserData); // Now async
                }

            } catch (error) {
                console.error("Error during initial data fetch:", error);
                // Provide more specific Supabase error feedback if possible
                let displayError = `An error occurred: ${error.message}. Please try again later.`;
                 if (error.message.includes('fetch')) { // Basic check for network issues
                     displayError = 'Network error: Could not connect to the server. Please check your internet connection.';
                 } else if (error.message.includes('JWT') || error.message.includes('Unauthorized')) { // Basic check for auth issues
                      displayError = 'Authentication error: Your session might have expired. Please try logging out and back in.';
                 } else if (error.code) { // Use Supabase error code if available
                      displayError = `Database error (${error.code}): ${error.message}. Please contact support if the issue persists.`;
                 }
                showErrorMessage(displayError);
                loadingMessage.style.display = 'none';
            }

             // Attach listener for the success popup button
             startJourneyBtn.addEventListener('click', async () => {
                 assessmentSuccessPopup.style.display = 'none';
                 popupOverlay.style.display = 'none';
                 assessmentSection.style.display = 'none';
                 assessmentSection.classList.remove('fade-in');
                 // Re-fetch and display dashboard after assessment submission
                 loadingMessage.style.display = 'block';
                 try {
                     const updatedUserData = await fetchCurrentUserFromSupabase(initialUserData.email); // Re-fetch fresh data
                     if (updatedUserData) {
                        await displayMainDashboard(updatedUserData);
                     } else {
                         showErrorMessage("Could not refresh dashboard after assessment.");
                     }
                 } catch (error) {
                    showErrorMessage(`Error refreshing dashboard: ${error.message}`);
                 } finally {
                     loadingMessage.style.display = 'none';
                 }
             });

             // Attach listener for Admin filter button
             if (applyFiltersBtn) {
                 applyFiltersBtn.addEventListener('click', () => {
                    if (IS_ADMIN_USER) {
                        fetchAllUsersAdminData(); // Re-fetch and display with new filters
                    }
                 });
             }
             // Attach listener for CSV download button
             if (downloadCsvBtn) {
                 downloadCsvBtn.addEventListener('click', () => {
                     if (IS_ADMIN_USER && currentAdminTableData.length > 0) {
                         downloadAdminTableAsCSV(currentAdminTableData);
                     } else {
                         alert("No data available to download or you are not an admin.");
                     }
                 });
             }
        });

        // --- Supabase Data Fetching Functions ---

        async function fetchCurrentUserFromSupabase(email) {
            console.log(`Fetching data for user: ${email}`);
            if (!email) {
                console.error("fetchCurrentUserFromSupabase: Email is required.");
                return null;
            }

            try {
                // 1. Fetch basic user info (assuming an RLS policy allows this)
                const { data: userData, error: userError } = await supabaseClient
                    .from('users') // Assuming a 'users' table
                    .select('name, email, assessment_completed, is_admin') // Add is_admin if you store it
                    .eq('email', email)
                    .maybeSingle(); // Use maybeSingle in case user not found yet

                if (userError) {
                    console.error("Supabase error fetching user data:", userError);
                    throw userError; // Throw to be caught by the main try/catch
                }
                if (!userData) {
                     // If user not in 'users' table, maybe create them? Or handle as error.
                     // For now, we'll try to proceed with localStorage info if needed, but log warning.
                     console.warn(`User with email ${email} not found in 'users' table.`);
                     // Try to construct a minimal object if needed for basic display
                     const storedUser = JSON.parse(localStorage.getItem(CURRENT_USER_KEY) || '{}');
                     return {
                         name: storedUser.name || 'Unknown User',
                         email: email,
                         assessment_completed: false, // Assume false if not found
                         progress: {}, // Initialize empty progress
                         assessmentAnswers: {} // Initialize empty answers
                         // IS_ADMIN_USER is determined separately by email match for now
                     }
                }

                // 2. Fetch user progress
                const { data: progressData, error: progressError } = await supabaseClient
                    .from('user_progress')
                    .select('section_id, progress_percentage')
                    .eq('user_email', email);

                if (progressError) {
                     console.error("Supabase error fetching user progress:", progressError);
                     throw progressError;
                 }

                // Format progress data into an object { section_id: progress }
                const progressMap = (progressData || []).reduce((acc, item) => {
                    acc[item.section_id] = item.progress_percentage;
                    return acc;
                }, {});

                // Initialize progress for sections not yet in DB
                courseSections.forEach(section => {
                    if (progressMap[section.id] === undefined) {
                        progressMap[section.id] = 0;
                    }
                });


                // 3. Fetch pre-assessment answers (assuming type='pre')
                const { data: assessmentData, error: assessmentError } = await supabaseClient
                    .from('assessments')
                    .select('answers, type') // Fetch type to potentially handle 'post' later
                    .eq('user_email', email)
                    .eq('type', 'pre') // Fetch only pre-assessment for now
                    .maybeSingle(); // Expecting only one 'pre' assessment

                if (assessmentError) {
                     console.error("Supabase error fetching assessment data:", assessmentError);
                     throw assessmentError;
                 }

                // Combine into a single user object
                const fullUserData = {
                    ...userData,
                    progress: progressMap,
                    assessmentAnswers: assessmentData ? assessmentData.answers : {}, // Use empty object if no assessment found
                    // assessment_completed flag comes directly from the 'users' table now
                };

                 // Override IS_ADMIN_USER based on DB if available and reliable
                 // if (typeof userData.is_admin === 'boolean') {
                 //    IS_ADMIN_USER = userData.is_admin;
                 // }

                return fullUserData;

            } catch (error) {
                console.error(`Error fetching data from Supabase for ${email}:`, error);
                throw error; // Re-throw to be caught by the caller
            }
        }

        // NEW: Fetch data for the Admin Panel (All Users)
        async function fetchAllUsersAdminData() {
            const spinner = document.getElementById('adminDataLoadingSpinner');
            const tableBody = document.getElementById('allUsersTableBody');
            const noUsersMessage = document.getElementById('noUsersMessage');
            const filterNameEmail = document.getElementById('filterNameEmail').value.trim().toLowerCase();
            const filterSection = document.getElementById('filterSection').value;
            const filterProgress = parseInt(document.getElementById('filterProgress').value, 10);

            if (spinner) spinner.style.display = 'inline-block';
            if (tableBody) tableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 30px;">Applying filters and loading data... <div class="loading-spinner"></div></td></tr>`; // Update loading message
            noUsersMessage.style.display = 'none';

            try {
                // Start building the query for users
                let userQuery = supabaseClient
                    .from('users') // Select from your main user table
                    .select(`
                        email,
                        name,
                        assessment_completed,
                        user_progress ( section_id, progress_percentage, updated_at )
                    `); // Select related progress

                // Apply Name/Email Filter (using OR condition)
                if (filterNameEmail) {
                    userQuery = userQuery.or(`name.ilike.%${filterNameEmail}%,email.ilike.%${filterNameEmail}%`);
                }

                // Execute the main user query
                const { data: users, error: usersError } = await userQuery;

                if (usersError) {
                     console.error("Supabase error fetching all users:", usersError);
                     throw usersError;
                 }

                if (!users || users.length === 0) {
                    currentAdminTableData = []; // Reset data
                    displayAllUsersTable([]); // Display empty table
                    await generateProgressDistributionChart([]); // Generate empty chart
                    if (spinner) spinner.style.display = 'none';
                    return;
                }

                console.log("Raw users fetched:", users);

                // Process fetched data: Calculate average progress, find latest update, and apply filters
                const processedUsers = users.map(user => {
                    const progressEntries = user.user_progress || [];
                    const progressMap = progressEntries.reduce((acc, item) => {
                        acc[item.section_id] = item.progress_percentage;
                        return acc;
                    }, {});

                     // Initialize progress for sections not yet in DB for avg calculation consistency
                     courseSections.forEach(section => {
                        if (progressMap[section.id] === undefined) {
                            progressMap[section.id] = 0;
                        }
                     });

                    const averageProgress = calculateAverageProgress(progressMap);

                    // Find the latest update timestamp among progress entries
                    let latestUpdate = null;
                    if (progressEntries.length > 0) {
                         latestUpdate = progressEntries.reduce((latest, entry) => {
                            const entryDate = entry.updated_at ? new Date(entry.updated_at) : null;
                            if (!entryDate || isNaN(entryDate.getTime())) return latest; // Ignore invalid dates
                            return latest === null || entryDate > latest ? entryDate : latest;
                         }, null);
                    }


                    return {
                        name: user.name,
                        email: user.email,
                        avgProgress: averageProgress,
                        lastUpdate: latestUpdate,
                        assessmentCompleted: user.assessment_completed,
                        progressEntries: progressEntries // Keep original entries for section filtering
                    };
                }).filter(user => {
                    // Apply Section and Progress Filters *after* calculating average
                    let sectionMatch = true;
                    if (filterSection) {
                        // Check if user has *any* progress entry for the selected section
                        const sectionProgress = user.progressEntries.find(p => p.section_id === filterSection)?.progress_percentage ?? 0;
                        sectionMatch = sectionProgress >= filterProgress; // Match if progress for that section meets minimum
                    } else {
                        // If no specific section is filtered, use average progress
                        sectionMatch = user.avgProgress >= filterProgress;
                    }
                    return sectionMatch;
                });

                console.log("Processed & Filtered users:", processedUsers);

                currentAdminTableData = processedUsers; // Store for CSV export
                displayAllUsersTable(processedUsers);
                await generateProgressDistributionChart(processedUsers); // Generate Pie chart

            } catch (error) {
                console.error("Error fetching all users admin data:", error);
                tableBody.innerHTML = `<tr><td colspan="5" style="color: red; text-align: center;">Error loading data: ${error.message}</td></tr>`;
                noUsersMessage.style.display = 'none';
                currentAdminTableData = []; // Clear data on error
                await generateProgressDistributionChart([]); // Show empty chart on error
            } finally {
                if (spinner) spinner.style.display = 'none';
            }
        }


        // --- Helper & Utility Functions ---

        function showErrorMessage(message) {
            const errorMessage = document.getElementById('errorMessage');
            const loadingMessage = document.getElementById('loadingMessage');
            if (errorMessage) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
            }
             if (loadingMessage) loadingMessage.style.display = 'none'; // Hide loading msg
            console.error("Error Displayed:", message);
        }

        // Calculate Average Progress (Provided in Request)
        function calculateAverageProgress(userProgressMap) {
            if (!userProgressMap || typeof userProgressMap !== 'object') return 0;
            // Ensure we only average based on defined course sections
            const relevantProgressValues = courseSections
                .map(section => userProgressMap[section.id] || 0); // Get progress or 0

            if (relevantProgressValues.length === 0) return 0;

            const total = relevantProgressValues.reduce((sum, val) => sum + (Number(val) || 0), 0); // Ensure values are numbers
            return total / relevantProgressValues.length;
        }

        // Format Date Nicely (Provided in Request)
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            try {
                const date = new Date(timestamp);
                if (isNaN(date.getTime())) return 'Invalid Date'; // Check validity
                // Use 'en-GB' for dd/mm/yyyy or 'en-US' for mm/dd/yyyy
                return date.toLocaleString('en-US', {
                    dateStyle: 'medium', // e.g., "Sep 15, 2023"
                    timeStyle: 'short'   // e.g., "10:30 AM"
                });
            } catch (e) {
                console.warn("Could not format date:", timestamp, e);
                return 'Invalid Date';
            }
        }


        function populateTopBar(user) { // Uses initial data or fetched data
            const userNameBar = document.getElementById('userNameBar');
            const userEmailBar = document.getElementById('userEmailBar');
            if (userNameBar) userNameBar.textContent = user.name || 'User';
            if (userEmailBar) userEmailBar.textContent = user.email || 'No email';
        }

        // --- Assessment Form Logic (Mostly Unchanged, but submit saves to Supabase) ---

        function setupAssessmentForm() {
             // (Keep the existing setup logic for questions, randomization, word count, paste prevention)
             const form = document.getElementById('assessmentForm');
             const q1Textarea = document.getElementById('q1_coaching_meaning');
             const q3Textarea = document.getElementById('q3_expectations');
             const q4Rating = document.getElementById('q4_confidence_rating');
             const q4Explanation = document.getElementById('q4_confidence_explanation');
             const randomQuestionContainer = document.getElementById('randomQuestionContainer');

             // Clear previous random question if any
             const existingLabel = randomQuestionContainer.querySelector('label');
             const existingTextarea = randomQuestionContainer.querySelector('textarea');
             if(existingLabel) existingLabel.remove();
             if(existingTextarea) existingTextarea.remove();


             const qRandomMinWordsDisplay = document.getElementById('q_random_min_words_display'); // Reference for min words display
             const qRandomWordCountContainer = document.getElementById('q_random_word_count_container'); // Reference for word count container
             const qRandomPasteWarning = document.getElementById('q_random_paste_warning');
             const qRandomError = document.getElementById('q_random_error');


             if (IS_ADMIN_USER) {
                document.getElementById('adminAssessmentNote').style.display = 'inline';
                // Adjust placeholders if needed
             }

             // Select and Inject Random Question
             selectedRandomQuestion = randomQuestionPool[Math.floor(Math.random() * randomQuestionPool.length)];

             // Update Label
            const randomLabel = document.createElement('label');
            randomLabel.htmlFor = selectedRandomQuestion.id;
            randomLabel.textContent = selectedRandomQuestion.label;
            randomQuestionContainer.insertBefore(randomLabel, randomQuestionContainer.firstChild); // Insert label at the beginning

            // Create and Insert Textarea
            const randomTextarea = document.createElement('textarea');
            randomTextarea.id = selectedRandomQuestion.id;
            randomTextarea.name = selectedRandomQuestion.id; // Use ID as name for form submission
            randomTextarea.required = true;
            randomTextarea.dataset.minWords = selectedRandomQuestion.minWords;
            randomTextarea.placeholder = IS_ADMIN_USER ? "Admin: No word count required." : `Please provide your thoughts... (min ${selectedRandomQuestion.minWords} words)`;
            randomQuestionContainer.insertBefore(randomTextarea, randomQuestionContainer.querySelector('.input-meta-info')); // Insert textarea before meta info

             // Update min words display
             if (qRandomMinWordsDisplay) {
                 qRandomMinWordsDisplay.textContent = IS_ADMIN_USER ? 'N/A' : selectedRandomQuestion.minWords;
             }

             // Setup validation and paste prevention for the *newly added* random question textarea
             const qRandomWordCountSpan = document.getElementById('q_random_word_count');
             if (randomTextarea && qRandomWordCountSpan && qRandomError && qRandomWordCountContainer) {
                 setupWordCountValidation(randomTextarea, qRandomWordCountSpan, qRandomError, qRandomWordCountContainer, IS_ADMIN_USER);
             }
             if (randomTextarea && qRandomPasteWarning) {
                 setupPastePrevention(randomTextarea, qRandomPasteWarning, IS_ADMIN_USER);
             }

             // Setup validation for static questions (Q1, Q3, Q4)
             const q1WordCount = document.getElementById('q1_word_count');
             const q1Error = document.getElementById('q1_error');
             const q1WordCountContainer = document.getElementById('q1_word_count_container');
             const q1PasteWarning = document.getElementById('q1_paste_warning');
             if (q1Textarea && q1WordCount && q1Error && q1WordCountContainer) {
                 setupWordCountValidation(q1Textarea, q1WordCount, q1Error, q1WordCountContainer, IS_ADMIN_USER);
             }
             if (q1Textarea && q1PasteWarning) {
                 setupPastePrevention(q1Textarea, q1PasteWarning, IS_ADMIN_USER);
             }


             const q3WordCount = document.getElementById('q3_word_count');
             const q3Error = document.getElementById('q3_error');
             const q3WordCountContainer = document.getElementById('q3_word_count_container');
             const q3PasteWarning = document.getElementById('q3_paste_warning');
             if (q3Textarea && q3WordCount && q3Error && q3WordCountContainer) {
                 setupWordCountValidation(q3Textarea, q3WordCount, q3Error, q3WordCountContainer, IS_ADMIN_USER);
             }
             if (q3Textarea && q3PasteWarning) {
                setupPastePrevention(q3Textarea, q3PasteWarning, IS_ADMIN_USER);
             }

             const q4ExpWordCount = document.getElementById('q4_exp_word_count');
             const q4ExpError = document.getElementById('q4_exp_error');
             const q4ExpWordCountContainer = document.getElementById('q4_exp_word_count_container');
             const q4ExpPasteWarning = document.getElementById('q4_exp_paste_warning');
             if (q4Explanation && q4ExpWordCount && q4ExpError && q4ExpWordCountContainer) {
                 setupWordCountValidation(q4Explanation, q4ExpWordCount, q4ExpError, q4ExpWordCountContainer, IS_ADMIN_USER);
             }
             if (q4Explanation && q4ExpPasteWarning) {
                setupPastePrevention(q4Explanation, q4ExpPasteWarning, IS_ADMIN_USER);
             }

             // --- Form Submission ---
             // Remove existing listener before adding a new one to prevent duplicates if setupAssessmentForm is called multiple times
             form.removeEventListener('submit', handleAssessmentSubmit);
             form.addEventListener('submit', handleAssessmentSubmit); // Point to the updated submit handler
        }

        function countWords(text) { return text ? text.trim().split(/\s+/).filter(Boolean).length : 0; }

        function setupWordCountValidation(textarea, countSpan, errorElement, countContainer, isAdmin) {
            if (!textarea || !countSpan || !errorElement || !countContainer) return; // Add checks

            if (isAdmin) {
                 countContainer.style.display = 'none'; // Hide word count for admin
                 textarea.removeEventListener('input', updateCount); // Remove listener if previously added
                 return; // Don't attach listeners
            }
             const minWords = parseInt(textarea.dataset.minWords, 10);
             countContainer.style.display = 'flex'; // Ensure it's visible for non-admins

             // Define updateCount inside so it has access to the correct elements
             function updateCount() {
                 const words = countWords(textarea.value);
                 countSpan.textContent = words;
                 if (words >= minWords) {
                     countSpan.style.color = '#10b981'; // Green
                 } else {
                     countSpan.style.color = '#ef4444'; // Red
                 }
             }
             // Remove previous listener before adding a new one
             textarea.removeEventListener('input', updateCount);
             textarea.addEventListener('input', updateCount);
             updateCount(); // Initial count
        }

        function validateWordCount(textarea, minWords, errorElement, isAdmin) {
             if (isAdmin) return true; // Always valid for admin
             if (!textarea || !errorElement) return true; // Skip if elements missing

             const words = countWords(textarea.value);
             if (words < minWords) {
                 errorElement.textContent = `Please enter at least ${minWords} words.`;
                 errorElement.style.display = 'block';
                 textarea.classList.add('invalid');
                 return false;
             }
             errorElement.style.display = 'none';
             textarea.classList.remove('invalid');
             return true;
        }

        function setupPastePrevention(textarea, warningElement, isAdmin) {
             if (!textarea || !warningElement) return; // Add checks

             // Define the handler
             const pasteHandler = (e) => {
                warningElement.style.color = '#dc2626'; // Make it more prominent on paste
                setTimeout(() => {
                    warningElement.style.color = '#f97316'; // Revert color after a short delay
                }, 2000);
             };

             // Remove existing listener
             textarea.removeEventListener('paste', pasteHandler);

             if (isAdmin) {
                warningElement.style.display = 'none'; // Hide paste warning for admin
                return; // Don't attach listener
             }
             warningElement.style.display = 'block'; // Make sure it's potentially visible
             textarea.addEventListener('paste', pasteHandler); // Add listener
         }


        async function handleAssessmentSubmit(event) {
            event.preventDefault();
            console.log("Assessment submit triggered.");
            const form = event.target;
            const submitButton = document.getElementById('assessmentSubmitBtn');

             // Double-check selectedRandomQuestion is set
             if (!selectedRandomQuestion || !selectedRandomQuestion.id) {
                 console.error("Critical Error: Random assessment question not selected properly.");
                 alert("An internal error occurred with the assessment form. Please refresh the page.");
                 return;
             }


            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...';

            // Clear previous errors
            form.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            form.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));

            // Get form elements (ensure dynamic elements are correctly referenced)
            const q1Textarea = document.getElementById('q1_coaching_meaning');
            const qRandomTextarea = document.getElementById(selectedRandomQuestion.id); // Use the dynamic ID
            const q3Textarea = document.getElementById('q3_expectations');
            const q4Rating = document.getElementById('q4_confidence_rating');
            const q4Explanation = document.getElementById('q4_confidence_explanation');

            // Get error elements
            const q1Error = document.getElementById('q1_error');
            const qRandomError = document.getElementById('q_random_error'); // Use the dynamic ID's error element
            const q3Error = document.getElementById('q3_error');
            const q4RatingError = document.getElementById('q4_rating_error');
            const q4ExpError = document.getElementById('q4_exp_error');

             // Check if elements exist before proceeding
             if (!q1Textarea || !qRandomTextarea || !q3Textarea || !q4Rating || !q4Explanation ||
                 !q1Error || !qRandomError || !q3Error || !q4RatingError || !q4ExpError) {
                 console.error("One or more assessment form elements not found!");
                 alert("Error submitting form: A required element is missing. Please refresh.");
                 submitButton.disabled = false;
                 submitButton.textContent = 'Submit Assessment';
                 return;
             }


            let isValid = true;

            // Perform Validation
            // Required checks
            if (!q1Textarea.value.trim()) { isValid = false; q1Textarea.classList.add('invalid'); q1Error.textContent = 'This field is required.'; q1Error.style.display = 'block'; }
            if (!qRandomTextarea.value.trim()) { isValid = false; qRandomTextarea.classList.add('invalid'); qRandomError.textContent = 'This field is required.'; qRandomError.style.display = 'block'; }
            if (!q3Textarea.value.trim()) { isValid = false; q3Textarea.classList.add('invalid'); q3Error.textContent = 'This field is required.'; q3Error.style.display = 'block'; }
            if (!q4Rating.value) { isValid = false; q4Rating.classList.add('invalid'); q4RatingError.textContent = 'Please select a rating.'; q4RatingError.style.display = 'block'; }
            if (!q4Explanation.value.trim()) { isValid = false; q4Explanation.classList.add('invalid'); q4ExpError.textContent = 'This field is required.'; q4ExpError.style.display = 'block'; }

            // Word count checks (if validation is enabled for the user)
            if (!validateWordCount(q1Textarea, parseInt(q1Textarea.dataset.minWords || '0', 10), q1Error, IS_ADMIN_USER)) { isValid = false; }
            if (!validateWordCount(qRandomTextarea, parseInt(qRandomTextarea.dataset.minWords || '0', 10), qRandomError, IS_ADMIN_USER)) { isValid = false; }
            if (!validateWordCount(q3Textarea, parseInt(q3Textarea.dataset.minWords || '0', 10), q3Error, IS_ADMIN_USER)) { isValid = false; }
            if (!validateWordCount(q4Explanation, parseInt(q4Explanation.dataset.minWords || '0', 10), q4ExpError, IS_ADMIN_USER)) { isValid = false; }

            // Q4 Rating range check
            const ratingVal = parseInt(q4Rating.value, 10);
             if (q4Rating.value && (isNaN(ratingVal) || ratingVal < 1 || ratingVal > 5)) {
                 isValid = false;
                 q4Rating.classList.add('invalid');
                 q4RatingError.textContent = 'Please enter a number between 1 and 5.';
                 q4RatingError.style.display = 'block';
             }

            if (isValid) {
                console.log("Assessment form is valid. Saving to Supabase...");
                // Get email from the initially loaded data (localStorage)
                const initialUserData = JSON.parse(localStorage.getItem(CURRENT_USER_KEY) || '{}');
                const userEmail = initialUserData?.email;

                if (!userEmail) {
                    console.error("Cannot save assessment, user email not found in localStorage.");
                    alert("Critical Error: User identity lost. Cannot save assessment. Please log out and back in.");
                    submitButton.disabled = false;
                    submitButton.textContent = 'Submit Assessment';
                    return;
                }

                // Prepare assessment data object
                const assessmentAnswers = {
                    [q1Textarea.name]: q1Textarea.value.trim(),
                    [selectedRandomQuestion.id]: qRandomTextarea.value.trim(), // Use dynamic ID/name
                    [q3Textarea.name]: q3Textarea.value.trim(),
                    [q4Rating.name]: ratingVal,
                    [q4Explanation.name]: q4Explanation.value.trim()
                };

                try {
                    // 1. Insert/Upsert into 'assessments' table
                    const { error: assessmentError } = await supabaseClient
                        .from('assessments')
                        .upsert({
                            user_email: userEmail,
                            type: 'pre', // Explicitly setting type
                            answers: assessmentAnswers,
                            submitted_at: new Date().toISOString() // Use ISO string for DB consistency
                        }, { onConflict: 'user_email, type' }); // Upsert based on user and type

                    if (assessmentError) {
                         console.error("Supabase error saving assessment:", assessmentError);
                         throw assessmentError;
                     }

                    // 2. Update the 'users' table to mark assessment as completed
                    const { error: userUpdateError } = await supabaseClient
                        .from('users')
                        .update({ assessment_completed: true })
                        .eq('email', userEmail);

                    if (userUpdateError) {
                        console.error("Supabase error updating user assessment status:", userUpdateError);
                         // Decide if this is critical enough to rollback or just warn
                         // For now, we'll proceed but log the error.
                         // throw userUpdateError; // Uncomment to make it critical
                    }

                    console.log("Assessment saved successfully to Supabase.");

                    // Show success popup
                    document.getElementById('assessmentSuccessPopup').style.display = 'block';
                    document.getElementById('popupOverlay').style.display = 'block';
                    // Button remains disabled until popup is closed by user

                } catch (error) {
                    console.error("Error saving assessment to Supabase:", error);
                     let submitErrorMsg = `Failed to save assessment: ${error.message}. Please try again.`;
                     if (error.code === '23505') { // Example: unique constraint violation
                         submitErrorMsg = "It seems you have already submitted this assessment.";
                     } else if (error.message.includes('RLS')) { // Example: Row Level Security issue
                         submitErrorMsg = "Permission denied. Could not save assessment.";
                     }
                    alert(submitErrorMsg);
                    isValid = false; // Mark as invalid to prevent UI changes if save fails
                    submitButton.disabled = false; // Re-enable button on error
                    submitButton.textContent = 'Submit Assessment';
                }

            } else {
                // Re-enable button if validation failed
                console.log("Assessment form invalid.");
                submitButton.disabled = false;
                submitButton.textContent = 'Submit Assessment';
                // Scroll to the first error
                const firstError = form.querySelector('.invalid');
                if (firstError) {
                     firstError.focus();
                     firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                 }
            }
        }


        // --- Dashboard Display Functions ---

        async function displayMainDashboard(user) { // Now potentially async if it fetches more data
            console.log("Displaying main dashboard content for:", user.email);
            const loadingMessage = document.getElementById('loadingMessage');
            const userDashboardContent = document.getElementById('userDashboardContent');
            const adminSection = document.getElementById('adminSection');
            const courseSectionsList = document.getElementById('courseSectionsList');
            const welcomeMessage = document.getElementById('welcomeMessage');
            const dashboardUserName = document.getElementById('dashboardUserName');
            const dashboardUserEmail = document.getElementById('dashboardUserEmail');

            loadingMessage.style.display = 'none'; // Hide loading message

            // Populate User Info in Dashboard Area
            if (welcomeMessage) welcomeMessage.textContent = `Welcome back, ${user.name || 'User'}!`;
            if (dashboardUserName) dashboardUserName.textContent = user.name || 'N/A';
            if (dashboardUserEmail) dashboardUserEmail.textContent = user.email || 'N/A';

            // Display Course Sections for the user (Uses fetched progress)
            if (courseSectionsList) {
                displayCourseSections(user, courseSectionsList); // Pass the user object with progress map
            } else { console.error("Course sections list container not found!"); }

            // Check for Admin Access & Display Admin Panel if applicable
            if (IS_ADMIN_USER) {
                console.log("Admin user detected. Displaying admin panel.");
                if (adminSection) {
                    // Populate admin-specific info (using fetched user data)
                    document.getElementById('adminPanelName').textContent = user.name || 'N/A';
                    document.getElementById('adminPanelEmail').textContent = user.email || 'N/A';

                    // Display admin data (own progress, own analysis, all users table)
                    // This function now fetches data itself if needed or uses passed data
                    await displayAdminData(user); // Made async

                    adminSection.style.display = 'block';
                    setTimeout(() => adminSection.classList.add('fade-in'), 50);
                } else { console.error("Admin section not found!"); }
            } else {
                 console.log("Regular user detected. Admin panel hidden.");
                 if (adminSection) adminSection.style.display = 'none';
            }

            // Show User Dashboard Content & Apply Fade-in
            if (userDashboardContent) {
                userDashboardContent.style.display = 'block';
                 setTimeout(() => userDashboardContent.classList.add('fade-in'), 50);
            } else { console.error("User dashboard content container not found!");}
        }

        // Display Course Sections (Uses progress map from user object)
        function displayCourseSections(user, containerElement) {
            if (!user || !containerElement) { console.error("Invalid user or container for course sections."); return; }
            containerElement.innerHTML = ''; // Clear previous content
            const userProgress = user.progress || {}; // Get progress map

            courseSections.forEach(section => {
                const progress = userProgress[section.id] || 0; // Use the map
                const progressPercentage = Math.max(0, Math.min(100, Math.round(progress)));

                const sectionElement = document.createElement('div');
                sectionElement.className = 'course-section';
                sectionElement.innerHTML = `
                    <span class="section-title">${section.title}</span>
                    <div class="section-progress">
                        <div class="progress-bar-container">
                            <div class="progress-bar"></div>
                        </div>
                        <span class="progress-text">${progressPercentage}% Complete</span>
                        <a href="${section.link}?sectionId=${section.id}" class="section-link" data-section-id="${section.id}">Start</a>
                    </div>
                `;

                const progressBar = sectionElement.querySelector('.progress-bar');
                const linkButton = sectionElement.querySelector('.section-link');

                // Set button text and style based on progress
                 if (progressPercentage >= 100) {
                     linkButton.textContent = 'Review';
                     linkButton.classList.add('status-review');
                 } else if (progressPercentage > 0) {
                     linkButton.textContent = 'Continue';
                     linkButton.classList.add('status-continue');
                 } else {
                     linkButton.textContent = 'Start';
                 }


                containerElement.appendChild(sectionElement);

                 // Animate progress bar after element is added to DOM
                 setTimeout(() => {
                     if (progressBar) {
                        progressBar.style.width = `${progressPercentage}%`;
                     }
                 }, 100); // Small delay for transition
            });
        }

         // Updated function to display all admin data components (Now Async)
         async function displayAdminData(adminUser) {
             const adminCourseProgressContainer = document.getElementById('adminCourseProgressContainer');
              const adminAssessmentDetailsContainer = document.getElementById('adminAssessmentDetails');

             if (!adminUser) {
                 console.error("Admin user data is missing for displayAdminData.");
                 if(adminCourseProgressContainer) adminCourseProgressContainer.innerHTML = '<p>Error: Admin data unavailable.</p>';
                 if(adminAssessmentDetailsContainer) adminAssessmentDetailsContainer.innerHTML = '<p>Error: Admin data unavailable.</p>';
                 return;
             }

             // 1. Display Admin's Own Course Section Progress Table (Uses adminUser.progress map)
             displayAdminOwnProgressTable(adminUser, adminCourseProgressContainer);

             // 2. Prepare Data for Admin's Own Analysis Section
             // Fetch pre-assessment data (already in adminUser object)
             const preAssessmentAnswers = adminUser.assessmentAnswers || {};
             const preConfidenceScore = preAssessmentAnswers?.confidence_rating || 0;

             // Fetch or simulate Post-Course Score
             // Placeholder for actual post-course score fetch from Supabase
             let postConfidenceScore = 0; // Default if not found/implemented
             try {
                // Example: Fetch post-assessment (replace with your actual logic)
                // const { data: postAssessment, error: postError } = await supabaseClient
                //    .from('assessments')
                //    .select('answers')
                //    .eq('user_email', adminUser.email)
                //    .eq('type', 'post')
                //    .maybeSingle();
                // if (postError) throw postError;
                // if (postAssessment) {
                //    postConfidenceScore = postAssessment.answers?.confidence_rating || 0;
                // } else {
                    // Simulate if no real post-assessment data yet
                    if (preConfidenceScore > 0) {
                         postConfidenceScore = preConfidenceScore >= 5 ? 5 : Math.min(5, preConfidenceScore + Math.floor(Math.random() * (5 - preConfidenceScore + 1)));
                         console.log(`Simulating post-course confidence for admin: ${postConfidenceScore} (pre-score was ${preConfidenceScore})`);
                    } else {
                         console.log("Admin pre-confidence score not found or zero, cannot simulate post-score.");
                    }
                // }
             } catch (error) {
                 console.error("Error fetching/simulating post-assessment score:", error);
                 // Keep postConfidenceScore at 0 or its pre-simulation value
             }


             // 3. Render Admin's Own Confidence Chart
             renderConfidenceChart(preConfidenceScore, postConfidenceScore);

             // 4. Display Admin's Own Assessment Details and Progress Analysis
              if (adminAssessmentDetailsContainer) {
                 displayAssessmentDetails(preAssessmentAnswers, preConfidenceScore, postConfidenceScore); // Pass fetched/simulated data
                 adminAssessmentDetailsContainer.style.display = 'block';
              } else {
                  console.error("Admin assessment details container not found.");
              }


             // 5. Fetch and Display the "All Users" table and charts (calls the data fetching function)
             await fetchAllUsersAdminData(); // Initial load without filters
         }

         // Display Admin's *Own* Progress Table (Uses adminUser.progress map)
         function displayAdminOwnProgressTable(adminUser, container) {
              if (!container) { console.error("Admin course progress container element not found."); return; }
              const adminProgress = adminUser.progress || {}; // Use the map

              let tableHTML = `
                 <h4>Your (Admin) Course Section Progress</h4>
                 <table class="admin-user-table">
                     <thead> <tr> <th>Section</th> <th>Progress (%)</th> <th>Status</th> </tr> </thead>
                     <tbody>`;

              if (!courseSections || courseSections.length === 0) {
                   tableHTML += `<tr><td colspan="3">Course sections not defined.</td></tr>`;
              } else if (Object.keys(adminProgress).length === 0 && !courseSections.some(s => adminProgress.hasOwnProperty(s.id))) {
                  // Check if the progress map is truly empty OR if it doesn't contain any of the defined section IDs
                   tableHTML += `<tr><td colspan="3">No progress data found for your account. Start a section to see progress.</td></tr>`;
              } else {
                  courseSections.forEach(section => {
                      const progress = adminProgress[section.id] || 0;
                      const progressPercentage = Math.max(0, Math.min(100, Math.round(progress)));
                      let status = 'Not Started';
                      if (progressPercentage >= 100) status = '<span class="status-completed">Completed</span>';
                      else if (progressPercentage > 0) status = '<span class="status-in-progress">In Progress</span>';
                      else status = '<span class="status-not-started">Not Started</span>';
                      tableHTML += `<tr><td>${section.title}</td><td>${progressPercentage}%</td><td>${status}</td></tr>`;
                  });
              }

              tableHTML += `</tbody></table>`;
              container.innerHTML = tableHTML;
         }


         // Render Confidence Chart (No changes needed here, just uses the data passed)
         function renderConfidenceChart(preScore, postScore) {
              const ctx = document.getElementById('confidenceChart');
              const container = document.getElementById('adminChartContainer'); // Get container too
              if (!ctx || !container) {
                  console.error("Canvas element 'confidenceChart' or its container not found.");
                  if(container) container.style.display = 'none'; // Hide container if canvas missing
                  return;
              }

               // Clear previous content (canvas and paragraph)
              container.innerHTML = '<canvas id="confidenceChart"></canvas>';
              const newCtx = document.getElementById('confidenceChart').getContext('2d');

              container.style.display = 'block'; // Ensure container is visible


              if (confidenceChartInstance) {
                  confidenceChartInstance.destroy();
              }

              // Only display chart if there's at least a pre-score OR post-score
             if (!preScore && !postScore) {
                 container.innerHTML = '<p style="text-align: center; padding: 20px; color: #78350f;">Confidence data not available.</p>';
                 return;
             }


              confidenceChartInstance = new Chart(newCtx, { // Use the new context
                  type: 'bar',
                  data: {
                      labels: ['Pre-Course', 'Post-Course*'],
                      datasets: [{
                          label: 'Confidence Level (1-5)',
                          data: [preScore || 0, postScore || 0], // Handle null/undefined
                          backgroundColor: [ 'rgba(245, 158, 11, 0.6)', 'rgba(16, 185, 129, 0.6)' ],
                          borderColor: [ 'rgba(217, 119, 6, 1)', 'rgba(5, 150, 105, 1)' ],
                          borderWidth: 1
                      }]
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      scales: {
                          y: { beginAtZero: true, max: 5, ticks: { stepSize: 1 } }
                      },
                      plugins: {
                          legend: { display: false },
                          title: { display: true, text: 'Admin Confidence Score Comparison' }
                      }
                  }
              });
              // Add the note below the chart
                const p = document.createElement('p');
                p.style = "text-align: center; font-size: 12px; color: #78350f; margin-top: 5px;";
                p.innerHTML = "<em>Confidence Score Comparison (Pre vs Post*)</em>";
                container.appendChild(p);
         }

         // Display Admin's *Own* Assessment Details (Unchanged logic, uses passed data)
         function displayAssessmentDetails(answers, preScore, postScore) {
              const answersContainer = document.getElementById('adminAssessmentAnswersDisplay');
              const progressContainer = document.getElementById('adminProgressAnalysis');
              const mainContainer = document.getElementById('adminAssessmentDetails'); // To show/hide header

              if (!answersContainer || !progressContainer || !mainContainer) { console.error("Admin assessment display elements missing."); return; }

              // Clear previous content
              answersContainer.innerHTML = '';
              progressContainer.innerHTML = '';

              // Ensure the header is visible
              mainContainer.querySelector('h5').style.display = 'block';


              // --- Display Answers ---
              const answerLabels = {
                  'coaching_meaning': 'Q1: Meaning of Coaching',
                   // Use selectedRandomQuestion if available, otherwise provide a fallback
                  [selectedRandomQuestion?.id || 'random_question']: selectedRandomQuestion?.label || 'Q2: Additional Question',
                  'expectations': 'Q3: Course Expectations',
                  'confidence_rating': 'Q4: Confidence Rating (1-5)',
                  'confidence_explanation': 'Q4: Confidence Explanation'
              };

              let answersHTML = '<dl>';
              let answersFound = false;
              for (const key in answerLabels) {
                   if (answers && answers.hasOwnProperty(key)) {
                       answersFound = true;
                       const label = answerLabels[key];
                       let value = answers[key];
                       // Use <pre> for textareas to preserve formatting
                       const isTextArea = key === 'coaching_meaning' || key === selectedRandomQuestion?.id || key === 'expectations' || key === 'confidence_explanation';
                       // Sanitize value before inserting as HTML (basic example)
                       const sanitizedValue = String(value || 'N/A').replace(/</g, "&lt;").replace(/>/g, "&gt;");
                       const formattedValue = isTextArea ? `<pre>${sanitizedValue}</pre>` : sanitizedValue;

                       answersHTML += `<dt>${label}:</dt><dd>${formattedValue}</dd>`;
                   }
              }
               answersHTML += '</dl>';

              if (answersFound) {
                  answersContainer.innerHTML = answersHTML;
              } else {
                  answersContainer.innerHTML = '<p>No assessment answers found for your account.</p>';
                   // Hide the progress part if no answers
                   progressContainer.style.display = 'none';
                   return; // Exit early if no answers
              }
              progressContainer.style.display = 'block'; // Ensure progress is visible if answers exist


              // --- Calculate and Display Progress (Confidence Score Change) ---
              let progressHTML = '';
              if (preScore > 0 && postScore > 0) {
                  const scoreChange = postScore - preScore;
                  const progressPercentage = ((postScore - 1) / 4) * 100; // Scale 1-5 to 0-100%

                  progressHTML += `<p>Pre-Course Confidence: <span class="progress-value">${preScore}/5</span></p>`;
                  progressHTML += `<p>Post-Course Confidence: <span class="progress-value">${postScore}/5*</span></p>`;

                  if (scoreChange > 0) {
                      progressHTML += `<p><span class="feedback-good">Improvement: +${scoreChange} point(s)</span></p>`;
                  } else if (scoreChange === 0) {
                      progressHTML += `<p><span class="feedback-neutral">Confidence level maintained.</span></p>`;
                  } else {
                       // Add a class for potential styling
                      progressHTML += `<p><span class="feedback-decrease" style="color: #ef4444; background-color: #fee2e2; padding: 4px 8px; border-radius: 4px;">Decrease: ${scoreChange} point(s)</span></p>`;
                  }
               } else if (preScore > 0) {
                   progressHTML += `<p>Pre-Course Confidence: <span class="progress-value">${preScore}/5</span></p>`;
                   progressHTML += `<p><span class="feedback-neutral">Post-course score not available yet.</span></p>`;
               } else {
                   progressHTML = `<p><span class="feedback-neutral">Confidence scores not available.</span></p>`;
               }

              progressContainer.innerHTML = progressHTML;
         }


        // NEW Function: Display All Users Table (Uses data fetched from Supabase)
        function displayAllUsersTable(usersData) {
            const tableBody = document.getElementById('allUsersTableBody');
            const noUsersMessage = document.getElementById('noUsersMessage');

            if (!tableBody || !noUsersMessage) {
                console.error("Missing elements for 'All Users' table display.");
                return;
            }

            tableBody.innerHTML = ''; // Clear previous rows

            if (!usersData || usersData.length === 0) {
                noUsersMessage.style.display = 'block';
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No users match the current filters.</td></tr>';
                return;
            } else {
                noUsersMessage.style.display = 'none';
            }

            usersData.forEach(user => {
                const avgProgress = user.avgProgress || 0;
                const lastUpdateFormatted = formatTimestamp(user.lastUpdate); // Use new formatting

                let status = 'Not Started';
                let statusClass = 'status-not-started';
                if (avgProgress >= 100) {
                    status = 'Completed';
                    statusClass = 'status-completed';
                } else if (avgProgress > 0 || (user.assessmentCompleted && avgProgress === 0)) { // Show In Progress if assessment done but 0% avg
                    status = 'In Progress';
                    statusClass = 'status-in-progress';
                }

                const row = document.createElement('tr');
                // Basic sanitization for display - escape HTML characters
                const escapeHtml = (unsafe) => {
                    if (unsafe === null || typeof unsafe === 'undefined') return 'N/A';
                    return String(unsafe)
                         .replace(/&/g, "&amp;")
                         .replace(/</g, "&lt;")
                         .replace(/>/g, "&gt;")
                         .replace(/"/g, "&quot;")
                         .replace(/'/g, "&#039;");
                }

                row.innerHTML = `
                    <td>${escapeHtml(user.name)}</td>
                    <td>${escapeHtml(user.email)}</td>
                    <td>${avgProgress.toFixed(1)}%</td>
                    <td class="${statusClass}">${status}</td>
                    <td>${escapeHtml(lastUpdateFormatted)}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // NEW Function: Generate Progress Distribution Pie Chart
        async function generateProgressDistributionChart(usersData) {
            const ctx = document.getElementById('progressDistributionChart');
             const container = document.getElementById('progressDistributionChartContainer');
            if (!ctx || !container) {
                console.error("Canvas element 'progressDistributionChart' or its container not found.");
                 if(container) container.style.display = 'none';
                return;
            }
             // Clear potential old messages/notes and ensure canvas exists
             container.innerHTML = '<canvas id="progressDistributionChart"></canvas>';
             const newCtx = document.getElementById('progressDistributionChart').getContext('2d'); // Get context from new/cleared canvas
             container.style.display = 'block'; // Make sure it's visible

            // Categorize users based on average progress
            let completed = 0;
            let inProgress = 0;
            let notStarted = 0;

            const validUsersData = usersData || []; // Ensure it's an array

            validUsersData.forEach(user => {
                const avgProgress = user.avgProgress || 0;
                 // Refined categorization: Consider assessment completed status for "Not Started"
                 if (avgProgress >= 100) {
                     completed++;
                 } else if (avgProgress > 0 || (user.assessmentCompleted && avgProgress === 0)) {
                     inProgress++;
                 } else { // Only truly "Not Started" if assessment not done AND progress is 0
                     notStarted++;
                 }
            });

            const totalUsers = completed + inProgress + notStarted;

            // Destroy previous chart instance if it exists
            if (progressDistributionChartInstance) {
                progressDistributionChartInstance.destroy();
            }

             if (totalUsers === 0) {
                 container.innerHTML = '<p style="text-align: center; padding: 20px; color: #78350f;">No user data available for progress distribution chart.</p>';
                 return; // Don't render chart if no data
             }


            progressDistributionChartInstance = new Chart(newCtx, { // Use the potentially new context
                type: 'pie',
                data: {
                    labels: [
                        `Completed (${completed})`,
                        `In Progress (${inProgress})`,
                        `Not Started (${notStarted})`
                    ],
                    datasets: [{
                        label: 'User Progress Status',
                        data: [completed, inProgress, notStarted],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.7)', // Emerald 700
                            'rgba(245, 158, 11, 0.7)', // Amber 500
                            'rgba(156, 163, 175, 0.7)' // Gray 400
                        ],
                        borderColor: [
                            'rgba(5, 150, 105, 1)', // Emerald 800
                            'rgba(217, 119, 6, 1)', // Amber 600
                            'rgba(107, 114, 128, 1)' // Gray 500
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: `Progress Distribution (${totalUsers} Users Shown)`
                        },
                        tooltip: {
                             callbacks: {
                                 label: function(context) {
                                     let label = context.dataset.label || '';
                                     let valueLabel = context.label || ''; // Gets the full label e.g., "Completed (5)"
                                      if (valueLabel) {
                                         label += ': ';
                                     }
                                     const value = context.raw; // The numerical value
                                     const percentage = totalUsers > 0 ? ((value / totalUsers) * 100).toFixed(1) : 0;

                                      // Reconstruct label for clarity
                                     const statusText = valueLabel.substring(0, valueLabel.lastIndexOf('(')).trim();
                                     label = `${statusText}: ${value} (${percentage}%)`;
                                     return label;
                                 }
                             }
                         }
                    }
                }
            });
        }


        // NEW Function: Download Admin Table as CSV
        function downloadAdminTableAsCSV(data) {
             if (!data || data.length === 0) {
                 alert("No data to download.");
                 return;
             }

             const headers = ["Name", "Email", "Average Progress (%)", "Status", "Last Update"];
             const rows = data.map(user => {
                 const avgProgress = (user.avgProgress || 0).toFixed(1);
                 let status = 'Not Started';
                 if (avgProgress >= 100) status = 'Completed';
                 else if (avgProgress > 0 || (user.assessmentCompleted && avgProgress === 0)) status = 'In Progress';

                 // Format date robustly for CSV (e.g., YYYY-MM-DD HH:MM)
                 let lastUpdateFormatted = 'N/A';
                  if(user.lastUpdate) {
                      try {
                         const d = new Date(user.lastUpdate);
                         // Check if date is valid before formatting
                         if (!isNaN(d.getTime())) {
                             lastUpdateFormatted = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
                         } else {
                              lastUpdateFormatted = 'Invalid Date';
                         }
                      } catch { lastUpdateFormatted = 'Invalid Date';}
                  }


                 // Escape commas and double quotes within fields
                 const escapeCSV = (field) => {
                     const stringField = String(field === null || typeof field === 'undefined' ? 'N/A' : field); // Ensure it's a string, default to 'N/A'
                     // If field contains comma, newline, or double quote, wrap in double quotes and escape internal double quotes
                     if (stringField.includes(',') || stringField.includes('\n') || stringField.includes('"')) {
                         return `"${stringField.replace(/"/g, '""')}"`;
                     }
                     return stringField;
                 };

                 const name = escapeCSV(user.name);
                 const email = escapeCSV(user.email);

                 return [name, email, avgProgress, status, lastUpdateFormatted]; // Already strings or numbers
             });

             // Combine headers and rows into CSV string
             let csvContent = headers.join(",") + "\n"
                 + rows.map(e => e.join(",")).join("\n");

            // Add BOM for better Excel compatibility with UTF-8 characters
            const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });

             // Create download link using Blob URL
             const link = document.createElement("a");
             const url = URL.createObjectURL(blob);
             link.setAttribute("href", url);
             const timestamp = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
             link.setAttribute("download", `user_progress_report_${timestamp}.csv`);
             document.body.appendChild(link); // Required for Firefox
             link.click();
             document.body.removeChild(link);
             URL.revokeObjectURL(url); // Clean up blob URL
             console.log("CSV download initiated.");
        }


        function logout() {
            console.log("Logging out user...");
            try {
                // Clear specific keys
                localStorage.removeItem(LOGGED_IN_KEY);
                localStorage.removeItem(CURRENT_USER_KEY); // Still clear this as it holds initial identity
                localStorage.removeItem(SIGNUP_FLAG_KEY); // Optional, but good practice

                IS_ADMIN_USER = false; // Reset global flag

                // Destroy charts
                if (confidenceChartInstance) confidenceChartInstance.destroy();
                if (progressDistributionChartInstance) progressDistributionChartInstance.destroy();
                confidenceChartInstance = null;
                progressDistributionChartInstance = null;

                console.log("User logged out, relevant keys removed.");
                window.location.href = 'login.html'; // Redirect to login
            } catch (e) {
                console.error("Error during logout:", e);
                window.location.href = 'login.html'; // Attempt redirect anyway
            }
        }
    </script>
</body>
</html>
