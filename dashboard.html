<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Coaching & Leadership</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <style>
        /* --- Base Styles (from original) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f8fafc; margin: 0; padding: 0; line-height: 1.6; color: #333; display: flex; flex-direction: column; min-height: 100vh; }
        main { flex-grow: 1; display: flex; justify-content: center; align-items: flex-start; /* Align top */ flex-direction: column; width: 100%; max-width: 1000px; /* Control max width */ margin: 0 auto; padding: 20px; }
        .header { background-color: #2c3e50; color: white; padding: 15px 0; text-align: center; font-size: 24px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); width: 100%; }
        .user-bar { background-color: #34495e; padding: 10px 30px; display: flex; justify-content: space-between; align-items: center; color: white; font-size: 15px; width: 100%; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-info svg { opacity: 0.8; }
        .user-details-bar { display: flex; flex-direction: column; } /* Renamed for clarity */
        .user-name-bar { font-weight: 600; font-size: 15px; } /* Renamed */
        .user-email-bar { font-size: 13px; opacity: 0.8; } /* Renamed */
        .logout-button { background-color: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s; display: flex; align-items: center; gap: 6px; }
        .logout-button:hover { background-color: #c0392b; transform: translateY(-1px); }
        .logout-button:active { transform: translateY(0); }
        .footer { text-align: center; padding: 20px 30px; background: #2c3e50; color: rgba(255, 255, 255, 0.8); margin-top: auto; /* Pushes footer down */ font-size: 14px; width: 100%; }

        /* --- Dashboard Specific Styles --- */
        .dashboard-container {
            background: white;
            padding: 30px 40px;
            box-shadow: 0px 0px 25px rgba(0, 0, 0, 0.07);
            border-radius: 12px;
            width: 100%;
            margin-bottom: 30px; /* Space before admin section or footer */
            text-align: left; /* Align content left */
        }
        .dashboard-container h2 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 26px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }
         .dashboard-user-details {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .dashboard-user-details svg {
            color: #3498db;
        }
        .dashboard-user-info {
            font-size: 16px;
            color: #2c3e50;
        }
        .dashboard-user-info strong {
            font-weight: 600;
        }

        .course-sections h3 {
            color: #34495e;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .course-section {
            background-color: #fdfdfe;
            border: 1px solid #eef2f7;
            padding: 15px 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: box-shadow 0.3s ease;
        }
        .course-section:hover {
            box-shadow: 0 3px 10px rgba(0,0,0, 0.05);
        }

        .section-title {
            font-size: 17px;
            font-weight: 500;
            color: #34495e;
        }

        .section-progress {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .progress-bar-container {
            width: 150px; /* Adjust width as needed */
            height: 10px;
            background-color: #ecf0f1;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            width: 0%; /* Will be set by JS */
            background: linear-gradient(90deg, #3498db, #2980b9);
            border-radius: 5px;
            transition: width 0.5s ease-in-out;
        }
        .progress-text {
            font-size: 14px;
            color: #7f8c8d;
            min-width: 80px; /* Ensure text doesn't wrap awkwardly */
            text-align: right;
        }

         .section-link {
            background-color: #3498db;
            color: white;
            padding: 6px 12px;
            border-radius: 5px;
            text-decoration: none;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .section-link:hover {
             background-color: #2980b9;
        }

        /* --- Admin Section Styles --- */
        #adminSection {
            background-color: #e8f6fd;
            border: 1px solid #bde0fe;
            border-radius: 12px;
            padding: 30px 40px;
            margin-top: 20px; /* Space from user dashboard */
             width: 100%;
        }
        #adminSection h3 {
            color: #1c5a8d;
            margin-bottom: 20px;
            font-size: 22px;
            border-bottom: 2px solid #bde0fe;
            padding-bottom: 10px;
        }
         .admin-note {
            font-size: 14px;
            color: #555;
            background-color: #fff9e0;
            border: 1px solid #ffeccc;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
         }
        /* Style for admin user table (example) */
        .admin-user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .admin-user-table th, .admin-user-table td {
            border: 1px solid #d0e4f5;
            padding: 10px 12px;
            text-align: left;
            font-size: 15px;
        }
        .admin-user-table th {
            background-color: #d6ebfa;
            color: #1c5a8d;
            font-weight: 600;
        }
         .admin-user-table td {
             background-color: #f8fcff;
         }

         /* Loading Message */
         #loadingMessage { text-align: center; padding: 50px; font-size: 18px; color: #555; }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">Coaching & Leadership Dashboard</header>

    <!-- User Bar -->
    <div class="user-bar">
        <div class="user-info">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path> <circle cx="12" cy="7" r="4"></circle> </svg>
            <div class="user-details-bar">
                <span class="user-name-bar" id="userNameBar">Loading...</span>
                <span class="user-email-bar" id="userEmailBar"></span>
            </div>
        </div>
        <button class="logout-button" onclick="logout()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path> <polyline points="16 17 21 12 16 7"></polyline> <line x1="21" y1="12" x2="9" y2="12"></line> </svg>
            Logout
        </button>
    </div>

    <!-- Main Content Area -->
    <main>
        <div id="loadingMessage" style="width: 100%; text-align: center;">Loading Dashboard...</div>

        <!-- User Dashboard Container -->
        <div class="dashboard-container" id="userDashboardContent" style="display: none;">
            <h2 id="welcomeMessage">Welcome!</h2>

            <!-- User Details Display Area -->
            <div class="dashboard-user-details">
                 <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                 <div class="dashboard-user-info">
                     Logged in as: <strong id="dashboardUserName">Name</strong> (<span id="dashboardUserEmail">email</span>)
                 </div>
            </div>

            <!-- Course Sections Area -->
            <div class="course-sections">
                <h3>Your Course Progress</h3>
                <div id="courseSectionsList">
                    <!-- Course sections will be loaded here by JavaScript -->
                </div>
            </div>

             <!-- Example Button (Optional - can be removed or repurposed) -->
            <!-- <button class="course-button" id="goToCourseBtn">Go to Course Introduction</button> -->
        </div>

        <!-- Admin-Only Section -->
        <div id="adminSection" style="display: none;">
            <h3><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>Admin Panel - User Progress Overview</h3>
             <p class="admin-note">
                 <strong>Note:</strong> This view shows progress data stored in *your* browser. For a complete overview of all users, a backend database is required. This panel currently simulates the admin view structure.
             </p>
            <div id="adminDataContainer">
                <!-- Admin-specific data will be loaded here -->
                 <p>Loading admin data...</p>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        Â© 2025 Elmenisy Leadership Coaching - All Rights Reserved
    </footer>

    <script>
        // --- Unified Keys ---
        const LOGGED_IN_KEY = 'isUserLoggedIn';
        const CURRENT_USER_KEY = 'currentUser'; // Stores { name: '...', email: '...', progress: {...} }
        const SIGNUP_FLAG_KEY = 'hasSignedUpBefore';
        const ADMIN_EMAIL = 'm.elsayed@thechefz.co'; // Case-insensitive comparison will be used

        // --- Course Structure ---
        const courseSections = [
            { id: 'intro', title: 'Introduction to Coaching and Leadership', link: 'course/intro.html' },
            { id: 'skills', title: 'Coaching Skills', link: 'course/skills.html' },
            { id: 'individuals', title: 'Coaching Individuals', link: 'course/individuals.html' },
            { id: 'teams', title: 'Coaching Teams', link: 'course/teams.html' },
            { id: 'self', title: 'Coaching Yourself', link: 'course/self.html' },
            { id: 'action', title: 'Action Plan', link: 'course/action.html' },
            { id: 'next', title: "What's Next", link: 'course/next.html' }
        ];

        // --- IMMEDIATE REDIRECTION LOGIC (Slightly adjusted) ---
        console.log("%cDashboard Page: Running IMMEDIATE redirection check...", "color: purple; font-weight: bold;");
        function quickCheckCurrentUserFormat() {
            const data = localStorage.getItem(CURRENT_USER_KEY);
            // Basic check: is it a non-empty string that looks like a JSON object?
            return data && data.length > 2 && data.startsWith('{') && data.endsWith('}');
        }
        const isLoggedIn_immediate = localStorage.getItem(LOGGED_IN_KEY) === 'true' && quickCheckCurrentUserFormat();
        const hasSignedUp_immediate = localStorage.getItem(SIGNUP_FLAG_KEY) === 'true';

        if (!isLoggedIn_immediate) {
            const targetUrl = hasSignedUp_immediate ? 'login.html' : 'signup.html';
            console.error(`%cDashboard Page IMMEDIATE Redirect: Not logged in or user data invalid. Redirecting to ${targetUrl}...`, "color: orange;");
            window.location.replace(targetUrl + '?redirect=dashboard.html');
            throw new Error("Redirecting user: Not logged in or invalid user data."); // Stop script execution
        } else {
            console.log("%cDashboard Page IMMEDIATE Check: User IS logged in. Proceeding.", "color: green;");
        }
        // --- END IMMEDIATE REDIRECTION ---

        document.addEventListener('DOMContentLoaded', function() {
            console.log("Dashboard page DOM loaded.");

            // --- Element References ---
            const userNameBar = document.getElementById('userNameBar');
            const userEmailBar = document.getElementById('userEmailBar');
            const welcomeMessage = document.getElementById('welcomeMessage');
            const dashboardUserName = document.getElementById('dashboardUserName');
            const dashboardUserEmail = document.getElementById('dashboardUserEmail');
            const courseSectionsList = document.getElementById('courseSectionsList');
            const userDashboardContent = document.getElementById('userDashboardContent');
            const adminSection = document.getElementById('adminSection');
            const adminDataContainer = document.getElementById('adminDataContainer');
            const loadingMessage = document.getElementById('loadingMessage');

            const currentUser = getCurrentUser(); // Gets user data, including progress

            // Failsafe check
            if (!currentUser) {
                console.error("Dashboard DOMContentLoaded: Critical - User data missing/invalid despite passing initial check! Forcing logout.");
                logout();
                return; // Stop further execution
            }

            console.log("Current User Data:", currentUser);

            // --- Display User Info ---
            // Top Bar
            if (userNameBar) userNameBar.textContent = currentUser.name;
            if (userEmailBar) userEmailBar.textContent = currentUser.email;
            // Main Dashboard Area
            if (welcomeMessage) welcomeMessage.textContent = `Welcome back, ${currentUser.name}!`;
            if (dashboardUserName) dashboardUserName.textContent = currentUser.name;
            if (dashboardUserEmail) dashboardUserEmail.textContent = currentUser.email;

            // --- Display Course Sections for the User ---
            displayCourseSections(currentUser, courseSectionsList);

            // --- Check for Admin Access ---
            const isAdmin = currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
            if (isAdmin) {
                console.log("Admin user detected.");
                if (adminSection) adminSection.style.display = 'block';
                displayAdminData(adminDataContainer); // Call function to populate admin view
            } else {
                 console.log("Regular user detected.");
                 if (adminSection) adminSection.style.display = 'none';
            }

            // --- Show Content ---
            if (loadingMessage) loadingMessage.style.display = 'none';
            if (userDashboardContent) userDashboardContent.style.display = 'block';

            console.log("Dashboard initialized successfully.");
        });

        // --- Helper Functions ---

        function getCurrentUser() {
            try {
                const userData = localStorage.getItem(CURRENT_USER_KEY);
                if (!userData) {
                    console.warn("getCurrentUser: No current user data found.");
                    return null;
                }
                const parsedUser = JSON.parse(userData);

                if (parsedUser && typeof parsedUser === 'object' && parsedUser.name && parsedUser.email) {
                    // Ensure progress object exists
                    if (typeof parsedUser.progress !== 'object' || parsedUser.progress === null) {
                        console.log("getCurrentUser: Initializing progress for user.");
                        parsedUser.progress = {}; // Initialize progress object if missing
                        // Optionally pre-populate with 0% for all sections
                        courseSections.forEach(section => {
                            if (parsedUser.progress[section.id] === undefined) {
                                parsedUser.progress[section.id] = 0; // Default progress to 0%
                            }
                        });
                        // Save the updated user object with initialized progress back to localStorage
                        saveCurrentUser(parsedUser);
                    } else {
                         // Ensure progress exists for all *defined* sections, defaulting to 0 if needed
                         let progressUpdated = false;
                         courseSections.forEach(section => {
                            if (parsedUser.progress[section.id] === undefined) {
                                parsedUser.progress[section.id] = 0;
                                progressUpdated = true;
                                console.log(`getCurrentUser: Added default progress for section ${section.id}`);
                            }
                        });
                        if (progressUpdated) {
                             saveCurrentUser(parsedUser); // Save if defaults were added
                        }
                    }
                    return parsedUser;
                } else {
                    console.error("getCurrentUser: Parsed user data is invalid.", parsedUser);
                    localStorage.removeItem(CURRENT_USER_KEY);
                    localStorage.removeItem(LOGGED_IN_KEY);
                    return null;
                }
            } catch (error) {
                console.error("Error parsing current user data:", error);
                localStorage.removeItem(CURRENT_USER_KEY);
                localStorage.removeItem(LOGGED_IN_KEY);
                return null;
            }
        }

         // Function to save the current user object (including progress) to localStorage
        function saveCurrentUser(userObject) {
             try {
                 if (!userObject || typeof userObject !== 'object') {
                     throw new Error("Invalid user object provided for saving.");
                 }
                 localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(userObject));
                 console.log("Saved user data to localStorage:", userObject);
             } catch (error) {
                 console.error("Error saving current user data:", error);
             }
        }

        function displayCourseSections(user, containerElement) {
            if (!user || !containerElement) {
                console.error("Cannot display course sections: Invalid user or container.");
                return;
            }
            containerElement.innerHTML = ''; // Clear previous content

            courseSections.forEach(section => {
                const progress = user.progress[section.id] || 0; // Get progress, default to 0
                const progressPercentage = Math.max(0, Math.min(100, progress)); // Clamp between 0-100

                const sectionElement = document.createElement('div');
                sectionElement.className = 'course-section';
                sectionElement.innerHTML = `
                    <span class="section-title">${section.title}</span>
                    <div class="section-progress">
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${progressPercentage}%;"></div>
                        </div>
                        <span class="progress-text">${progressPercentage}% Complete</span>
                        <a href="${section.link || '#'}" class="section-link" title="Go to ${section.title}">Start</a>
                         <!-- V2: Could change 'Start' to 'Continue' or 'Review' based on progress -->
                    </div>
                `;
                // TODO: Add event listener or proper links to navigate to the section content later
                 const linkButton = sectionElement.querySelector('.section-link');
                 if (progress >= 100) {
                     linkButton.textContent = 'Review';
                     linkButton.style.backgroundColor = '#2ecc71'; // Green for completed
                     linkButton.addEventListener('mouseover', () => linkButton.style.backgroundColor = '#27ae60');
                     linkButton.addEventListener('mouseout', () => linkButton.style.backgroundColor = '#2ecc71');
                 } else if (progress > 0) {
                     linkButton.textContent = 'Continue';
                     linkButton.style.backgroundColor = '#f39c12'; // Orange for in progress
                      linkButton.addEventListener('mouseover', () => linkButton.style.backgroundColor = '#e67e22');
                      linkButton.addEventListener('mouseout', () => linkButton.style.backgroundColor = '#f39c12');
                 } else {
                     // Keep as 'Start'
                 }


                containerElement.appendChild(sectionElement);
            });
        }

        function displayAdminData(containerElement) {
             if (!containerElement) return;

             // **Simulated Data Fetching**
             // In a real app, this would fetch data from a backend API.
             // Here, we can only access data in the *admin's* localStorage.
             // We could try to list *all* `currentUser` keys if we had a way
             // to know them, but localStorage doesn't provide a way to list keys easily
             // across different origins or without a naming convention.

             // For this example, let's just show the admin's *own* progress in a table format
             // as a placeholder for a future user list.

             const adminUser = getCurrentUser(); // Get the currently logged-in admin's data
             if (!adminUser) {
                 containerElement.innerHTML = '<p>Error: Could not load admin user data.</p>';
                 return;
             }

             let tableHTML = `
                <p>Displaying progress for the logged-in admin (${adminUser.email}):</p>
                <table class="admin-user-table">
                    <thead>
                        <tr>
                            <th>Section</th>
                            <th>Progress (%)</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
             `;

             courseSections.forEach(section => {
                 const progress = adminUser.progress[section.id] || 0;
                 const progressPercentage = Math.max(0, Math.min(100, progress));
                 let status = 'Not Started';
                 if (progress >= 100) status = 'Completed';
                 else if (progress > 0) status = 'In Progress';

                 tableHTML += `
                    <tr>
                        <td>${section.title}</td>
                        <td>${progressPercentage}%</td>
                        <td>${status}</td>
                    </tr>
                 `;
             });

             tableHTML += `
                    </tbody>
                </table>
                <p style="margin-top: 15px; font-size: 14px;"><em>(In a full implementation, this table would list all registered users and their progress, fetched from a server.)</em></p>
             `;

             containerElement.innerHTML = tableHTML;
         }


        function logout() {
            console.log("Logging out user...");
            try {
                // Clear core session data
                localStorage.removeItem(LOGGED_IN_KEY);
                localStorage.removeItem(CURRENT_USER_KEY);

                // Optional: Clear signup flag if you want returning users to see signup first after logout
                // localStorage.removeItem(SIGNUP_FLAG_KEY);

                // Optional: Clear course-specific data if needed
                // courseSections.forEach(section => localStorage.removeItem(`progress_${section.id}`)); // Example if progress was stored separately

                console.log("Local storage cleared for logout.");
                window.location.href = 'login.html'; // Redirect to login page
            } catch (e) {
                console.error("Error during logout:", e);
                // Force redirect even if storage fails
                window.location.href = 'login.html';
            }
        }

        // --- Progress Update Function (Placeholder) ---
        // This function would be called from your course content pages when a user makes progress
        function updateProgress(sectionId, newProgressValue) {
            console.log(`Attempting to update progress for section ${sectionId} to ${newProgressValue}%`);
            const currentUser = getCurrentUser();
            if (!currentUser) {
                console.error("Cannot update progress: No user logged in.");
                return;
            }

            // Validate progress value
             newProgressValue = Math.max(0, Math.min(100, Number(newProgressValue))); // Ensure it's a number 0-100

            // Check if the sectionId is valid
            const isValidSection = courseSections.some(section => section.id === sectionId);
            if (!isValidSection) {
                 console.error(`Cannot update progress: Invalid section ID "${sectionId}"`);
                 return;
            }

            // Update the progress in the user object
            currentUser.progress[sectionId] = newProgressValue;

            // Save the updated user object back to localStorage
            saveCurrentUser(currentUser);

            console.log(`Progress updated for ${sectionId}. New user data:`, currentUser);

            // Refresh the dashboard display if the user is currently on the dashboard page
             if (document.getElementById('courseSectionsList')) {
                 displayCourseSections(currentUser, document.getElementById('courseSectionsList'));
                 // If admin view is visible, refresh it too
                 if (document.getElementById('adminSection') && document.getElementById('adminSection').style.display !== 'none') {
                     displayAdminData(document.getElementById('adminDataContainer'));
                 }
                 console.log("Dashboard display refreshed.");
             }
        }

        // Example of how you might call updateProgress from another page (e.g., after finishing a lesson):
        // updateProgress('intro', 50); // Sets 'Introduction' progress to 50%
        // updateProgress('skills', 100); // Sets 'Coaching Skills' progress to 100%

    </script>
</body>
</html>
