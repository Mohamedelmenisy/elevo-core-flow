<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Elevo Core</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2317a2b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M3 12h18M3 6h12M3 18h15'/><path d='M17 9l4 3l-4 3'/></svg>">
    <link rel="stylesheet" href="style.css"> 
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Hide scrollbar but keep scrolling */
        ::-webkit-scrollbar {
          display: none;
        }

        html, body {
          scrollbar-width: none; /* For Firefox */
          -ms-overflow-style: none; /* For Internet Explorer and Edge */
        }

        /* --- Global Layout/Theme Vars (Assumed from style.css but included for completeness) --- */
        :root {
            --primary-color: #4e8cff; /* Blue */
            --accent-color: #10b981; /* Green */
            --danger-color: #ef4444;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --text-color: #e5e7eb;
            --text-color-light: #9ca3af;
            --card-bg-color: #1f2937;
            --input-bg-color: #374151;
            --border-color: #4b5563;
            --border-radius-md: 0.5rem;
            --border-radius-lg: 0.75rem;
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        /* --- MODIFICATION START Page Layout Rework & Responsive KPI Grid --- */
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .app-main {
            flex-grow: 1;
            padding: 2rem;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }

        .dashboard-main { 
            display: flex; 
            flex-direction: column; 
            gap: 2rem; 
        }

        /* FIX: Ensure 5 cards fit responsively */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        .stats-grid .stat-card {
            background-color: var(--card-bg-color);
            padding: 1.25rem;
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 120px;
        }
        .stats-grid .stat-card-content p {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .chart-container {
            background-color: var(--card-bg-color);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-color);
            min-height: 360px;
            display: flex;
            flex-direction: column;
        }
        .chart-container canvas {
            flex-grow: 1;
            width: 100% !important;
            height: 100% !important;
        }

        .bottom-row-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            align-items: flex-start;
        }
        /* --- MODIFICATION END --- */

        /* Quality Gauge Styles */
        .quality-gauge { display: flex; align-items: center; gap: 0.75rem; }
        .gauge-bar-container { display: flex; flex-grow: 1; height: 10px; border-radius: 5px; overflow: hidden; }
        .gauge-segment { height: 100%; transition: width 0.5s ease-in-out; }
        .gauge-segment.good { background-color: var(--success-color); }
        .gauge-segment.normal { background-color: var(--warning-color); }
        .gauge-segment.bad { background-color: var(--danger-color); }

        /* Top Agents/Scenarios Table */
        .kpi-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .kpi-table td { text-align: left; padding: 0.75rem 0.5rem; border-bottom: 1px solid var(--border-color); font-size: 0.9rem; }
        .kpi-table td .value { font-weight: 600; font-size: 1rem; color: var(--primary-color); }
        .top-agents-list-table li { display: flex; justify-content: space-between; padding: 0.5rem 0; font-size: 0.95rem; border-bottom: 1px solid var(--border-color); }
        .top-agents-list-table li:last-child { border-bottom: none; }
        
    </style>
</head>
<body>
    <div class="app-container" id="appContainerContent" style="display: none;">
        <header class="app-header">
            <div class="logo-container">
                <span class="app-title">Admin Dashboard - Elevo Core</span>
            </div>
            <div class="header-controls">
                <a href="core-flow.html" class="nav-link">Core Flow</a>
                <a href="rtm-dashboard.html" class="nav-link" id="rtmDashboardLink">RTM Dashboard</a>
                <a href="agent-portal.html" class="nav-link" id="agentPortalLink">Agent Portal</a>
                <div id="liveStatusBox" class="nav-link" style="font-weight: 600;"></div>
                <div class="user-info" id="userInfo" style="display: none;">
                    <span id="userNameDisplay" class="user-name-display"></span>
                    <button id="logoutButton" class="logout-btn">
                        <span>Logout</span>
                    </button>
                </div>
            </div>
        </header>

        <main class="app-main dashboard-main">
            <div id="authLoadingMessage" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 70vh;">
                <div class="spinner"></div>
                <p>Verifying access and loading dashboard...</p>
            </div>

            <div id="dashboardContent" style="display:none; flex-direction: column; gap: 2rem;">
                
                <div class="dashboard-header">
                    <div class="greeting-section">
                        <h1>Welcome, Admin!</h1>
                        <p>Historical performance data and agent analytics.</p>
                    </div>
                </div>

                <section class="kpi-section">
                    <div class="stats-grid" id="statsGrid">
                        <div class="stat-card">
                            <div class="stat-card-content">
                                <h3>Total Tickets</h3>
                                <p id="totalCalls">0</p>
                                <span class="stat-period" id="statsPeriod">Today</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-content">
                                <h3>Avg. Duration</h3>
                                <p id="avgCallDuration">0m 0s</p>
                                <span class="stat-period" id="statsPeriodDuration">Today</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-content">
                                <h3>Completion Rate</h3>
                                <p id="completionRate">0%</p>
                                <span class="stat-period" id="statsPeriodCompletion">Today</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-content">
                                <h3>Quality Score</h3>
                                <div class="quality-gauge">
                                    <div class="gauge-bar-container">
                                        <div id="gaugeGood" class="gauge-segment good" style="width: 0%;"></div>
                                        <div id="gaugeNormal" class="gauge-segment normal" style="width: 0%;"></div>
                                        <div id="gaugeBad" class="gauge-segment bad" style="width: 0%;"></div>
                                    </div>
                                    <span id="avgQualityText">N/A</span>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-content">
                                <h3>Avg. Sentiment</h3>
                                <p id="avgSentiment">N/A</p>
                                <span class="stat-period">Past Week</span>
                            </div>
                        </div>
                    </div>
                </section>

                <div class="filter-controls card" id="filterControlsCard">
                    <h3>Filter Ticket Sessions</h3>
                    <div class="filter-grid">
                        <div class="form-group">
                            <label for="userFilterDropdown">Agent</label>
                            <select id="userFilterDropdown">
                                <option value="">All Agents</option>
                            </select>
                        </div>
                        </div>
                </div>

                <section class="analytics-section">
                    <h2>Overall Performance Analytics</h2>
                    <div class="charts-row">
                        <div class="chart-container" id="volumeChartContainer">
                            <h2>Ticket Volume (Last 7 Days)</h2>
                            <canvas id="volumeChart"></canvas>
                        </div>
                        <div class="chart-container" id="scenarioChartContainer">
                            <h2>Ticket Scenario Distribution</h2>
                            <canvas id="scenarioChart"></canvas>
                        </div>
                    </div>
                </section>

                <section class="bottom-row-section">
                    <div class="bottom-row-grid">
                        
                        <div class="widget-card kpi-sidebar-card">
                            <h3>Today's Highlights</h3>
                            <div class="highlight-kpis">
                                <table class="kpi-table">
                                    <tbody>
                                        <tr>
                                            <td><span class="label">Fastest Ticket:</span></td>
                                            <td><span id="kpi-fastest" class="value">—</span></td>
                                        </tr>
                                        <tr>
                                            <td><span class="label">Longest Ticket:</span></td>
                                            <td><span id="kpi-longest" class="value">—</span></td>
                                        </tr>
                                        <tr>
                                            <td><span class="label">Top Scenario:</span></td>
                                            <td><span id="kpi-top-scenario" class="value">—</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <h4 style="margin-top: 2rem;">Top 5 Agents by Volume</h4>
                            <ul class="top-agents-list-table" id="topAgentsList">
                                <li>No agent data today.</li>
                            </ul>
                        </div>
                        
                        <div class="widget-card monitoring-card">
                            <h2>Live Ticket Monitoring</h2>
                            <div class="monitoring-tabs-nav">
                                <button class="tab-link active" data-tab="tab-live">Live <span id="liveCount" class="tab-count">0</span></button>
                                <button class="tab-link" data-tab="tab-delayed">Delayed <span id="delayedCount" class="tab-count">0</span></button>
                                <button class="tab-link" data-tab="tab-recent">Recent <span id="recentCount" class="tab-count">0</span></button>
                            </div>
                            
                            <div id="tab-live" class="tab-pane active">
                                <div class="live-calls-list" id="liveTicketsList">
                                    <p class="empty-state">No live tickets currently.</p>
                                </div>
                            </div>

                            <div id="tab-delayed" class="tab-pane">
                                <div class="live-calls-list" id="delayedTicketsList">
                                    <p class="empty-state">No delayed tickets currently.</p>
                                </div>
                            </div>

                            <div id="tab-recent" class="tab-pane">
                                <div class="live-calls-list" id="recentTicketsList">
                                    <p class="empty-state">No recent tickets in the last hour.</p>
                                </div>
                            </div>
                        </div>

                    </div>
                </section>
            </div>
        </main>
    </div>
    
    <div id="accessDeniedModal" style="display: none;">
        </div>
    
</body>
<script>
    // --- Configuration and Utility Functions ---
    const SUPABASE_URL = 'https://aefiigottnlcmjzilqnh.supabase.co'; // Replace with your actual URL
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlZmlpZ290dG5sY21qemlscW5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNzY2MDQsImV4cCI6MjA2Mjc1MjYwNH0.FypB02v3tGMnxXV9ZmZMdMC0oQpREKOJWgHMPxUzwX4'; // Replace with your actual public key
    SUPABASE_KEY);
    const EGYPT_TIMEZONE = 'Africa/Cairo';

    let volumeChartInstance = null;
    let scenarioChartInstance = null;

    // Utility to format duration (seconds to m:ss)
    function formatDuration(seconds) {
        if (typeof seconds !== 'number' || isNaN(seconds) || seconds < 0) return 'N/A';
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.floor(seconds % 60);
        return `${minutes}m ${remainingSeconds}s`;
    }

    // Utility to format timestamp to Cairo local time
    function formatDateTime(timestamp) {
        if (!timestamp) return 'N/A';
        const date = new Date(timestamp);
        return date.toLocaleString('en-US', {
            timeZone: EGYPT_TIMEZONE,
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });
    }

    // --- Chart Initialization Functions (Included for full copy-paste) ---
    function initVolumeChart(labels = [], data = []) {
        const ctx = document.getElementById('volumeChart').getContext('2d');
        const colors = getThemeColors(); // Assumed function to get theme colors
        
        if (volumeChartInstance) volumeChartInstance.destroy();
        
        volumeChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Tickets',
                    data: data,
                    backgroundColor: colors.primary,
                    borderColor: colors.primary,
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        ticks: { color: colors.text, beginAtZero: true, precision: 0 },
                        grid: { color: colors.border }
                    },
                    x: {
                        ticks: { color: colors.text },
                        grid: { display: false }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: { mode: 'index', intersect: false }
                }
            }
        });
    }

    function initScenarioChart(labels = [], data = []) {
        const ctx = document.getElementById('scenarioChart').getContext('2d');
        const colors = getThemeColors();
        
        if (scenarioChartInstance) scenarioChartInstance.destroy();
        
        // Define a color palette (can be customized)
        const backgroundColors = ['#4e8cff', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'];

        scenarioChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { color: colors.text }
                    },
                    tooltip: { mode: 'index', intersect: false }
                }
            }
        });
    }

    function getThemeColors() {
        return {
            primary: '#4e8cff',
            accent: '#10b981',
            text: document.documentElement.style.getPropertyValue('--text-color') || '#e5e7eb',
            border: document.documentElement.style.getPropertyValue('--border-color') || '#4b5563'
        };
    }

    // --- Authentication and Initialization ---

    async function checkAuth() {
        const { data: { user } } = await supabase.auth.getUser();
        
        if (!user) {
            window.location.replace("login.html");
            return null;
        }

        // --- Role-Based Access Control ---
        // Assuming admin role is required for the dashboard
        const { data: profile, error } = await supabase
            .from('profiles')
            .select('user_role')
            .eq('user_id', user.id)
            .single();

        if (error || !profile || profile.user_role !== 'admin') {
            document.getElementById('authLoadingMessage').style.display = 'none';
            document.getElementById('accessDeniedModal').style.display = 'flex';
            return null;
        }

        document.getElementById('userNameDisplay').textContent = user.email.split('@')[0];
        document.getElementById('userInfo').style.display = 'flex';
        document.getElementById('authLoadingMessage').style.display = 'none';
        document.getElementById('dashboardContent').style.display = 'flex';
        return user;
    }

    async function initializeDashboard() {
        const user = await checkAuth();
        if (!user) return;

        await fetchUsersForFilter();
        await fetchDashboardData();
        
        // Initializing Charts with placeholder data to show structure
        initVolumeChart(['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'], [120, 190, 300, 150, 220, 180, 250]);
        initScenarioChart(['Scenario A', 'Scenario B', 'Scenario C', 'Other'], [45, 30, 15, 10]);

        // Setup Event Listeners for Filters/Tabs
        document.getElementById('userFilterDropdown').addEventListener('change', fetchDashboardData);
        document.querySelectorAll('.monitoring-tabs-nav .tab-link').forEach(link => {
            link.addEventListener('click', handleTabClick);
        });

        // Initial Data Fetch
        await fetchDashboardData();
    }
    
    // --- Data Fetching Functions with Correct Views ---

    async function fetchUsersForFilter() {
        const { data, error } = await supabase
            .from('profiles')
            .select('user_id, agent_name')
            .order('agent_name', { ascending: true });

        if (error) {
            console.error('Error fetching users:', error.message);
            return;
        }

        const dropdown = document.getElementById('userFilterDropdown');
        const currentSelected = dropdown.value;
        dropdown.innerHTML = '<option value="">All Agents</option>';

        data.forEach(user => {
            const option = document.createElement('option');
            option.value = user.user_id;
            option.textContent = user.agent_name || user.user_id;
            dropdown.appendChild(option);
        });

        if (currentSelected) {
            dropdown.value = currentSelected;
        }
    }

    async function fetchDashboardData() {
        const selectedAgentId = document.getElementById('userFilterDropdown').value || null;
        
        // 1. Fetch Main KPIs
        // Using the correct views for aggregation:
        const { data: totalTicketsData, error: totalTicketsError } = await supabase.from('v_total_tickets_today').select('total_tickets');
        const { data: avgDurationData, error: avgDurationError } = await supabase.from('v_avg_duration_today').select('avg_duration_seconds');
        const { data: completionRateData, error: completionRateError } = await supabase.from('v_completion_rate_today').select('completion_rate');
        const { data: qualitySummaryData, error: qualitySummaryError } = await supabase.from('v_call_quality_summary').select('avg_score, good_percentage, normal_percentage, bad_percentage');
        
        if (totalTicketsError) console.error('Total Tickets View Error', totalTicketsError.message);
        if (avgDurationError) console.error('Avg Duration View Error', avgDurationError.message);
        if (completionRateError) console.error('Completion Rate View Error', completionRateError.message);
        if (qualitySummaryError) console.error('Quality Summary View Error', qualitySummaryError.message);


        // Update KPI Cards
        const totalTickets = totalTicketsData ? totalTicketsData[0]?.total_tickets || 0 : 0;
        const avgDuration = avgDurationData ? avgDurationData[0]?.avg_duration_seconds || 0 : 0;
        const completionRate = completionRateData ? completionRateData[0]?.completion_rate || 0 : 0;
        const qualitySummary = qualitySummaryData ? qualitySummaryData[0] : null;

        document.getElementById('totalCalls').textContent = totalTickets.toLocaleString();
        document.getElementById('avgCallDuration').textContent = formatDuration(avgDuration);
        document.getElementById('completionRate').textContent = `${(completionRate * 100).toFixed(1)}%`;
        
        if (qualitySummary) {
            const avgScoreText = qualitySummary.avg_score ? (qualitySummary.avg_score * 100).toFixed(1) + '%' : 'N/A';
            document.getElementById('avgQualityText').textContent = avgScoreText;
            document.getElementById('gaugeGood').style.width = `${qualitySummary.good_percentage * 100}%`;
            document.getElementById('gaugeNormal').style.width = `${qualitySummary.normal_percentage * 100}%`;
            document.getElementById('gaugeBad').style.width = `${qualitySummary.bad_percentage * 100}%`;
        }


        // 2. Fetch Highlights (Fastest, Longest, Top Scenario, Top Agents)
        try {
            const { data: fastestTicketRes, error: fastestTicketError } = await supabase.from('v_fastest_ticket').select('duration_seconds').limit(1).single();
            const { data: longestTicketRes, error: longestTicketError } = await supabase.from('v_longest_ticket').select('duration_seconds').limit(1).single();
            const { data: topScenarioRes, error: topScenarioError } = await supabase.from('v_top_scenario_today').select('scenario_title').limit(1).single();
            const { data: topAgentsRes, error: topAgentsError } = await supabase.from('v_top_5_agents_today').select('agent_name, total_tickets:count').limit(5);

            if (fastestTicketError && fastestTicketError.code !== 'PGRST116') console.error('Fastest Ticket View Error', fastestTicketError.message);
            if (longestTicketError && longestTicketError.code !== 'PGRST116') console.error('Longest Ticket View Error', longestTicketError.message);
            if (topScenarioError && topScenarioError.code !== 'PGRST116') console.error('Top Scenario View Error', topScenarioError.message);
            if (topAgentsError) console.error('Top Agents View Error', topAgentsError.message);


            const topAgentsList = document.getElementById('topAgentsList');
            if (topAgentsRes && topAgentsRes.length > 0) {
                topAgentsList.innerHTML = topAgentsRes.map(t => `<li>${t.agent_name || 'Unknown'}<span>${t.total_tickets} tickets</span></li>`).join('');
            } else {
                topAgentsList.innerHTML = '<li>No agent data today.</li>';
            }

            document.getElementById('kpi-fastest').textContent = fastestTicketRes ? formatDuration(fastestTicketRes.duration_seconds) : '—';
            document.getElementById('kpi-longest').textContent = longestTicketRes ? formatDuration(longestTicketRes.duration_seconds) : '—';
            document.getElementById('kpi-top-scenario').textContent = topScenarioRes ? topScenarioRes.scenario_title : '—';

        } catch(e) {
            console.error('Error fetching KPIs from views', e);
            document.getElementById('kpi-fastest').textContent = 'Error'; document.getElementById('kpi-longest').textContent = 'Error'; document.getElementById('kpi-top-scenario').textContent = 'Error'; document.getElementById('topAgentsList').innerHTML = '<li>Error loading data.</li>';
        }


        // 3. Fetch Tickets for Monitoring Tabs (Live, Delayed, Recent)
        await fetchMonitoringTickets(selectedAgentId);

        // NOTE: Chart data fetching (volume and scenario) would go here, updating initVolumeChart/initScenarioChart instances.
    }

    async function fetchMonitoringTickets(agentId = null) {
        let liveQuery = supabase.from('live_tickets').select('*', { count: 'exact' }).order('session_start_time', { ascending: false });
        let delayedQuery = supabase.from('delayed_tickets').select('*', { count: 'exact' }).order('session_start_time', { ascending: false });
        let recentQuery = supabase.from('recent_tickets').select('*', { count: 'exact' }).order('session_start_time', { ascending: false });
        
        if (agentId) {
            liveQuery = liveQuery.eq('agent_id', agentId);
            delayedQuery = delayedQuery.eq('agent_id', agentId);
            recentQuery = recentQuery.eq('agent_id', agentId);
        }

        const [liveRes, delayedRes, recentRes] = await Promise.all([
            liveQuery,
            delayedQuery,
            recentQuery
        ]);

        if (liveRes.error) console.error('Live Tickets Error:', liveRes.error.message);
        if (delayedRes.error) console.error('Delayed Tickets Error:', delayedRes.error.message);
        if (recentRes.error) console.error('Recent Tickets Error:', recentRes.error.message);


        // Update Counts
        document.getElementById('liveCount').textContent = liveRes.count || 0;
        document.getElementById('delayedCount').textContent = delayedRes.count || 0;
        document.getElementById('recentCount').textContent = recentRes.count || 0;

        // Render Lists
        renderTicketList(liveRes.data || [], 'liveTicketsList', 'No live tickets currently.');
        renderTicketList(delayedRes.data || [], 'delayedTicketsList', 'No delayed tickets currently.');
        renderTicketList(recentRes.data || [], 'recentTicketsList', 'No recent tickets in the last hour.');
    }

    function renderTicketList(tickets, elementId, emptyMessage) {
        const listElement = document.getElementById(elementId);
        if (tickets.length === 0) {
            listElement.innerHTML = `<p class="empty-state">${emptyMessage}</p>`;
            return;
        }

        listElement.innerHTML = tickets.map(ticket => `
            <div class="live-call-item">
                <div class="live-call-item-agent">${ticket.agent_name || 'Unknown Agent'}</div>
                <div class="live-call-item-details">
                    <span style="color: var(--text-color-light);">${ticket.scenario_title || 'N/A'}</span>
                    <span style="float: right;">${formatDuration(ticket.duration_seconds || 0)}</span>
                </div>
                <div style="font-size: 0.8em; color: var(--text-color-light); margin-top: 0.25rem;">
                    Started: ${formatDateTime(ticket.session_start_time)}
                </div>
            </div>
        `).join('');
    }

    function handleTabClick(event) {
        const tabLink = event.target.closest('.tab-link');
        if (!tabLink) return;

        const targetTabId = tabLink.getAttribute('data-tab');

        // Deactivate all links and panes
        document.querySelectorAll('.monitoring-tabs-nav .tab-link').forEach(link => link.classList.remove('active'));
        document.querySelectorAll('.monitoring-card .tab-pane').forEach(pane => pane.classList.remove('active'));

        // Activate the clicked link and target pane
        tabLink.classList.add('active');
        document.getElementById(targetTabId).classList.add('active');
    }

    document.addEventListener('DOMContentLoaded', initializeDashboard);
    
    document.getElementById('logoutButton').addEventListener('click', async () => {
        await supabase.auth.signOut();
        localStorage.removeItem('elevoCoreUserData');
        window.location.replace("login.html");
    });
</script>
</html>
