<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Coaching & Leadership</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <style>
        /* --- Base Styles (from original) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f8fafc; margin: 0; padding: 0; line-height: 1.6; color: #333; display: flex; flex-direction: column; min-height: 100vh; }
        main { flex-grow: 1; display: flex; justify-content: center; align-items: flex-start; flex-direction: column; width: 100%; max-width: 1000px; margin: 0 auto; padding: 20px; }
        .header { background-color: #2c3e50; color: white; padding: 15px 0; text-align: center; font-size: 24px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); width: 100%; }
        .user-bar { background-color: #34495e; padding: 10px 30px; display: flex; justify-content: space-between; align-items: center; color: white; font-size: 15px; width: 100%; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-info svg { opacity: 0.8; }
        .user-details-bar { display: flex; flex-direction: column; }
        .user-name-bar { font-weight: 600; font-size: 15px; }
        .user-email-bar { font-size: 13px; opacity: 0.8; }
        .logout-button { background-color: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s; display: flex; align-items: center; gap: 6px; }
        .logout-button:hover { background-color: #c0392b; transform: translateY(-1px); }
        .logout-button:active { transform: translateY(0); }
        .footer { text-align: center; padding: 20px 30px; background: #2c3e50; color: rgba(255, 255, 255, 0.8); margin-top: auto; font-size: 14px; width: 100%; }

        /* --- Dashboard Specific Styles --- */
        .dashboard-container, #assessmentSection {
            background: white;
            padding: 30px 40px;
            box-shadow: 0px 0px 25px rgba(0, 0, 0, 0.07);
            border-radius: 12px;
            width: 100%;
            margin-bottom: 30px;
            text-align: left;
             opacity: 0; /* Initially hidden for fade-in */
             transition: opacity 0.6s ease-in-out;
        }
        .dashboard-container.fade-in, #assessmentSection.fade-in {
             opacity: 1;
        }
        .dashboard-container h2, #assessmentSection h2 {
            color: #2c3e50;
            margin-bottom: 20px; /* Increased margin */
            font-size: 26px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }
         .dashboard-user-details {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .dashboard-user-details svg { color: #3498db; }
        .dashboard-user-info { font-size: 16px; color: #2c3e50; }
        .dashboard-user-info strong { font-weight: 600; }
        .course-sections h3 { color: #34495e; margin-top: 30px; margin-bottom: 15px; font-size: 20px; }
        .course-section { background-color: #fdfdfe; border: 1px solid #eef2f7; padding: 15px 20px; margin-bottom: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; transition: box-shadow 0.3s ease, transform 0.2s ease; flex-wrap: wrap; gap: 10px; }
        .course-section:hover { box-shadow: 0 4px 12px rgba(0,0,0, 0.08); transform: translateY(-2px); }
        .section-title { font-size: 17px; font-weight: 500; color: #34495e; flex-grow: 1; margin-right: 15px; }
        .section-progress { display: flex; align-items: center; gap: 15px; flex-shrink: 0; flex-basis: 280px; }
        .progress-bar-container { width: 150px; height: 10px; background-color: #ecf0f1; border-radius: 5px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #3498db, #2980b9); border-radius: 5px; transition: width 0.6s ease-in-out; } /* Enhanced transition */
        .progress-text { font-size: 14px; color: #7f8c8d; min-width: 80px; text-align: right; font-weight: 500; }
        .section-link { background-color: #3498db; color: white; padding: 6px 12px; border-radius: 5px; text-decoration: none; font-size: 14px; transition: background-color 0.3s, transform 0.2s ease; white-space: nowrap; }
        .section-link:hover { background-color: #2980b9; transform: translateY(-1px); }

        /* --- Pre-Course Assessment Styles --- */
        #assessmentSection { display: none; /* Initially hidden, shown by JS */ }
        #assessmentSection .intro-note {
            background-color: #e8f4fd;
            border-left: 4px solid #3498db;
            padding: 15px 20px;
            margin-bottom: 25px;
            border-radius: 4px;
            font-size: 15px;
            color: #333;
        }
        #assessmentForm .form-group { margin-bottom: 25px; }
        #assessmentForm label { display: block; margin-bottom: 8px; font-weight: 600; color: #34495e; font-size: 16px; }
        #assessmentForm textarea, #assessmentForm input[type="number"], #assessmentForm select {
            width: 100%;
            padding: 12px;
            border: 1px solid #dce4ec;
            border-radius: 6px;
            font-size: 15px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        #assessmentForm textarea { min-height: 100px; resize: vertical; }
        #assessmentForm textarea:focus, #assessmentForm input[type="number"]:focus, #assessmentForm select:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
            outline: none;
        }
        #assessmentForm .word-count-info { font-size: 12px; color: #7f8c8d; margin-top: 5px; text-align: right; }
        #assessmentForm .paste-warning { font-size: 12px; color: #e74c3c; margin-top: 5px; display: none; /* Hidden by default */ }
        #assessmentForm .error-message { color: #e74c3c; font-size: 13px; margin-top: 6px; display: none; /* Hidden by default */ }
        #assessmentForm input.invalid, #assessmentForm textarea.invalid { border-color: #e74c3c; }
        #assessmentSubmitBtn {
            background-color: #2ecc71;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        #assessmentSubmitBtn:hover { background-color: #27ae60; transform: translateY(-1px); }
        #assessmentSubmitBtn:disabled { background-color: #bdc3c7; cursor: not-allowed; }

        /* Success Popup */
        #assessmentSuccessPopup {
            display: none; /* Hidden by default */
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.15);
            z-index: 1000;
            text-align: center;
            border-top: 5px solid #2ecc71;
        }
         #assessmentSuccessPopup p { font-size: 18px; color: #333; margin-bottom: 25px; }
         #assessmentSuccessPopup button {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
             font-size: 16px;
             transition: background-color 0.3s;
         }
         #assessmentSuccessPopup button:hover { background-color: #2980b9; }
         .popup-overlay { /* Optional: Dark overlay behind popup */
             display: none; /* Hidden by default */
             position: fixed;
             top: 0; left: 0; width: 100%; height: 100%;
             background-color: rgba(0,0,0,0.5);
             z-index: 999;
         }


        /* --- Admin Section Styles --- */
        #adminSection {
            background-color: #e8f6fd; border: 1px solid #bde0fe; border-radius: 12px;
            padding: 30px 40px; margin-top: 20px; width: 100%;
             display: none; /* Hidden by default, shown only for admin */
             opacity: 0; /* For fade-in */
             transition: opacity 0.6s ease-in-out;
        }
        #adminSection.fade-in { opacity: 1; }
        #adminSection h3 { color: #1c5a8d; margin-bottom: 20px; font-size: 22px; border-bottom: 2px solid #bde0fe; padding-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .admin-note { font-size: 14px; color: #555; background-color: #fff9e0; border: 1px solid #ffeccc; padding: 12px 15px; border-radius: 5px; margin-bottom: 25px; }
        .admin-user-table { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: fixed; }
        .admin-user-table th, .admin-user-table td { border: 1px solid #d0e4f5; padding: 10px 12px; text-align: left; font-size: 15px; word-wrap: break-word; }
        .admin-user-table th { background-color: #d6ebfa; color: #1c5a8d; font-weight: 600; }
        .admin-user-table td { background-color: #f8fcff; }
        .admin-user-table th:nth-child(1) { width: 40%; } /* Section Title */
        .admin-user-table th:nth-child(2) { width: 25%; text-align: center;} /* Progress */
        .admin-user-table th:nth-child(3) { width: 35%; } /* Status */
        .admin-user-table td:nth-child(2) { text-align: center; }

         /* Loading Message */
         #loadingMessage { text-align: center; padding: 50px; font-size: 18px; color: #555; width: 100%; }

         /* Responsive Adjustments */
         @media (max-width: 600px) {
             main { padding: 15px; }
             .dashboard-container, #assessmentSection { padding: 20px; }
             .course-section { flex-direction: column; align-items: flex-start; }
             .section-title { margin-right: 0; margin-bottom: 10px; }
             .section-progress { flex-basis: auto; width: 100%; justify-content: space-between; }
             .progress-bar-container { flex-grow: 1; margin-right: 10px; }
             .admin-user-table th, .admin-user-table td { font-size: 14px; padding: 8px; }
             #assessmentSuccessPopup { width: 90%; padding: 30px; }
         }

    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">Coaching & Leadership Dashboard</header>

    <!-- User Bar -->
    <div class="user-bar">
        <div class="user-info">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path> <circle cx="12" cy="7" r="4"></circle> </svg>
            <div class="user-details-bar">
                <span class="user-name-bar" id="userNameBar">Loading...</span>
                <span class="user-email-bar" id="userEmailBar"></span>
            </div>
        </div>
        <button class="logout-button" onclick="logout()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path> <polyline points="16 17 21 12 16 7"></polyline> <line x1="21" y1="12" x2="9" y2="12"></line> </svg>
            Logout
        </button>
    </div>

    <!-- Main Content Area -->
    <main>
        <div id="loadingMessage">Loading Dashboard...</div>

        <!-- Pre-Course Assessment Section -->
        <section id="assessmentSection">
            <h2>Pre-Course Assessment</h2>
            <p class="intro-note">
                <strong>Welcome!</strong> Before you begin the course modules, please take a moment to answer these questions. Your answers help us personalize your experience. Please answer honestly in your own words.
            </p>
            <form id="assessmentForm" novalidate>
                 <!-- Question 1 -->
                <div class="form-group">
                    <label for="q1_coaching_meaning">What does coaching mean to you?</label>
                    <textarea id="q1_coaching_meaning" name="coaching_meaning" required data-min-words="20" placeholder="Describe your understanding of coaching... (min 20 words)"></textarea>
                    <div class="word-count-info">Words: <span id="q1_word_count">0</span>/20</div>
                    <div class="paste-warning" id="q1_paste_warning">Pasting content is discouraged. Please use your own words.</div>
                    <div class="error-message" id="q1_error"></div>
                </div>

                <!-- Question 2 (Randomized) -->
                 <div class="form-group" id="randomQuestionContainer">
                     <!-- Label and Input will be inserted here by JS -->
                      <div class="paste-warning" id="q_random_paste_warning">Pasting content is discouraged. Please use your own words.</div>
                      <div class="error-message" id="q_random_error"></div>
                 </div>

                <!-- Question 3 -->
                <div class="form-group">
                    <label for="q3_expectations">What are your expectations from this course?</label>
                    <textarea id="q3_expectations" name="expectations" required data-min-words="15" placeholder="What do you hope to learn or achieve? (min 15 words)"></textarea>
                    <div class="word-count-info">Words: <span id="q3_word_count">0</span>/15</div>
                     <div class="paste-warning" id="q3_paste_warning">Pasting content is discouraged. Please use your own words.</div>
                    <div class="error-message" id="q3_error"></div>
                </div>

                <!-- Question 4 -->
                 <div class="form-group">
                    <label for="q4_confidence_rating">Rate your current coaching confidence (1=Low, 5=High)</label>
                    <input type="number" id="q4_confidence_rating" name="confidence_rating" required min="1" max="5" step="1" placeholder="Enter a number between 1 and 5">
                    <div class="error-message" id="q4_rating_error"></div>
                    <label for="q4_confidence_explanation" style="margin-top: 15px;">Briefly explain your rating:</label>
                    <textarea id="q4_confidence_explanation" name="confidence_explanation" required data-min-words="10" placeholder="Why did you choose this rating? (min 10 words)"></textarea>
                    <div class="word-count-info">Words: <span id="q4_exp_word_count">0</span>/10</div>
                     <div class="paste-warning" id="q4_exp_paste_warning">Pasting content is discouraged. Please use your own words.</div>
                    <div class="error-message" id="q4_exp_error"></div>
                </div>

                <button type="submit" id="assessmentSubmitBtn">Submit Assessment</button>
            </form>
        </section>

         <!-- Success Popup -->
         <div class="popup-overlay" id="popupOverlay"></div>
         <div id="assessmentSuccessPopup">
             <p>Thank you! Your answers have been saved. You can now start your journey!</p>
             <button id="startJourneyBtn">Start Course</button>
         </div>

        <!-- User Dashboard Container -->
        <div class="dashboard-container" id="userDashboardContent" style="display: none;">
            <h2 id="welcomeMessage">Welcome!</h2>
            <div class="dashboard-user-details">
                 <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                 <div class="dashboard-user-info">
                     Logged in as: <strong id="dashboardUserName">Name</strong> (<span id="dashboardUserEmail">email</span>)
                 </div>
            </div>
            <div class="course-sections">
                <h3>Your Course Progress</h3>
                <div id="courseSectionsList">
                    <!-- Course sections will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Admin-Only Section -->
        <div id="adminSection">
             <h3><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>Admin Panel - Progress Overview</h3>
             <p class="admin-note">
                 <strong>Important Note:</strong> Due to browser limitations (using localStorage), this panel currently only shows the progress data for <strong>your own admin account</strong> (<span id="adminEmailDisplay"></span>). A full implementation displaying *all* users requires a server-side database to store and retrieve everyone's progress centrally.
             </p>
            <div id="adminDataContainer">
                 <p>Loading your progress data...</p>
                 <!-- Admin table will be loaded here -->
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        Â© 2025 Elmenisy Leadership Coaching - All Rights Reserved
    </footer>

    <script>
        // --- Constants ---
        const LOGGED_IN_KEY = 'isUserLoggedIn';
        const CURRENT_USER_KEY = 'currentUser';
        const SIGNUP_FLAG_KEY = 'hasSignedUpBefore';
        const ADMIN_EMAIL = 'm.elsayed@thechefz.co'; // Case-insensitive comparison

        // Assessment Question Pool (Random Selection)
        const randomQuestionPool = [
            { id: 'q_leadership_vs_management', label: 'How do you differentiate leadership from management?', minWords: 20 },
            { id: 'q_coaching_challenge', label: 'What do you see as the biggest challenge in coaching others?', minWords: 20 },
            { id: 'q_leadership_style', label: 'Briefly describe your ideal leadership style.', minWords: 15 }
        ];
        let selectedRandomQuestion = null; // Will hold the chosen question object

        const courseSections = [
            { id: 'index', title: 'Course Introduction Goal', link: 'index.html' },
            { id: 'article1', title: 'Introduction to Coaching and Leadership', link: 'article1.html' },
            { id: 'skills', title: 'Coaching Skills', link: 'coaching-skills.html' },
            { id: 'individuals', title: 'Coaching Individuals', link: 'coaching-individuals.html' },
            { id: 'team', title: 'Team Coaching', link: 'coaching-team.html' },
            { id: 'self', title: 'Self Coaching', link: 'coaching-yourself.html' },
            { id: 'action', title: 'Action Plan', link: 'action-plan.html' },
        ];

        // --- IMMEDIATE REDIRECTION LOGIC ---
        console.log("%cDashboard Page: Running IMMEDIATE redirection check...", "color: purple; font-weight: bold;");
        function quickCheckCurrentUserFormat() {
            const data = localStorage.getItem(CURRENT_USER_KEY);
            return data && data.length > 2 && data.startsWith('{') && data.endsWith('}');
        }
        const isLoggedIn_immediate = localStorage.getItem(LOGGED_IN_KEY) === 'true' && quickCheckCurrentUserFormat();
        const hasSignedUp_immediate = localStorage.getItem(SIGNUP_FLAG_KEY) === 'true';

        if (!isLoggedIn_immediate) {
            const targetUrl = hasSignedUp_immediate ? 'login.html' : 'signup.html';
            console.error(`%cDashboard Page IMMEDIATE Redirect: Not logged in or user data invalid. Redirecting to ${targetUrl}...`, "color: orange;");
            window.location.replace(`${targetUrl}?redirect=${encodeURIComponent(window.location.pathname)}`);
            throw new Error("Redirecting user: Not logged in or invalid user data.");
        } else {
            console.log("%cDashboard Page IMMEDIATE Check: User IS logged in. Proceeding.", "color: green;");
        }
        // --- END IMMEDIATE REDIRECTION ---

        document.addEventListener('DOMContentLoaded', function() {
            console.log("Dashboard page DOM loaded.");

            // --- Element References ---
            const loadingMessage = document.getElementById('loadingMessage');
            const assessmentSection = document.getElementById('assessmentSection');
            const userDashboardContent = document.getElementById('userDashboardContent');
            const adminSection = document.getElementById('adminSection');
            const assessmentForm = document.getElementById('assessmentForm');
            const assessmentSuccessPopup = document.getElementById('assessmentSuccessPopup');
            const popupOverlay = document.getElementById('popupOverlay');
            const startJourneyBtn = document.getElementById('startJourneyBtn');

             // Get current user data
            const currentUser = getCurrentUser();

            if (!currentUser) {
                console.error("Dashboard DOMContentLoaded: Critical - User data missing/invalid. Forcing logout.");
                logout();
                return; // Stop further execution
            }

            console.log("Current User Data (Dashboard):", currentUser);

            // Populate user info in the top bar immediately
            populateTopBar(currentUser);

            // --- Assessment Check ---
            if (!currentUser.assessmentCompleted) {
                console.log("Assessment not completed. Displaying assessment form.");
                setupAssessmentForm();
                loadingMessage.style.display = 'none';
                assessmentSection.style.display = 'block';
                 setTimeout(() => assessmentSection.classList.add('fade-in'), 50); // Trigger fade-in
            } else {
                console.log("Assessment already completed. Displaying main dashboard.");
                displayMainDashboard(currentUser);
            }

             // Attach listener for the success popup button
             startJourneyBtn.addEventListener('click', () => {
                 assessmentSuccessPopup.style.display = 'none';
                 popupOverlay.style.display = 'none';
                 assessmentSection.style.display = 'none';
                 assessmentSection.classList.remove('fade-in');
                 displayMainDashboard(getCurrentUser()); // Re-fetch user data just in case
             });
        });

        // --- Helper Functions ---

        function getCurrentUser() {
            try {
                const userData = localStorage.getItem(CURRENT_USER_KEY);
                if (!userData) {
                    console.warn("getCurrentUser: No current user data found.");
                    return null;
                }
                const parsedUser = JSON.parse(userData);

                if (parsedUser && typeof parsedUser === 'object' && parsedUser.name && parsedUser.email) {
                    let progressUpdated = false;
                    // Ensure progress object exists
                    if (typeof parsedUser.progress !== 'object' || parsedUser.progress === null) {
                        parsedUser.progress = {};
                        progressUpdated = true;
                    }
                     // Ensure assessment status and answers object exist (initialize if needed)
                     if (parsedUser.assessmentCompleted === undefined) {
                         parsedUser.assessmentCompleted = false;
                         progressUpdated = true; // Changed user structure
                     }
                     if (typeof parsedUser.assessmentAnswers !== 'object' || parsedUser.assessmentAnswers === null) {
                        parsedUser.assessmentAnswers = {};
                         progressUpdated = true; // Changed user structure
                     }

                     // Ensure progress exists for all defined sections
                     courseSections.forEach(section => {
                        if (parsedUser.progress[section.id] === undefined || parsedUser.progress[section.id] === null) {
                            parsedUser.progress[section.id] = 0;
                            progressUpdated = true;
                        }
                    });

                    if (progressUpdated) {
                        saveCurrentUser(parsedUser);
                    }

                    return parsedUser;
                } else {
                    console.error("getCurrentUser: Parsed user data is invalid.", parsedUser);
                    logout(); // Force logout if data is corrupt
                    return null;
                }
            } catch (error) {
                console.error("Error parsing current user data:", error);
                logout(); // Force logout on parse error
                return null;
            }
        }

        function saveCurrentUser(userObject) {
             try {
                 if (!userObject || typeof userObject !== 'object') {
                     throw new Error("Invalid user object provided for saving.");
                 }
                 localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(userObject));
                 console.log("Saved user data to localStorage:", userObject);
             } catch (error) {
                 console.error("Error saving current user data:", error);
             }
        }

        function populateTopBar(user) {
            const userNameBar = document.getElementById('userNameBar');
            const userEmailBar = document.getElementById('userEmailBar');
            if (userNameBar) userNameBar.textContent = user.name;
            if (userEmailBar) userEmailBar.textContent = user.email;
        }

        function setupAssessmentForm() {
             const form = document.getElementById('assessmentForm');
             const q1Textarea = document.getElementById('q1_coaching_meaning');
             const q3Textarea = document.getElementById('q3_expectations');
             const q4Rating = document.getElementById('q4_confidence_rating');
             const q4Explanation = document.getElementById('q4_confidence_explanation');
             const randomQuestionContainer = document.getElementById('randomQuestionContainer');

             // --- Select and Inject Random Question ---
             selectedRandomQuestion = randomQuestionPool[Math.floor(Math.random() * randomQuestionPool.length)];
             randomQuestionContainer.innerHTML = `
                 <label for="${selectedRandomQuestion.id}">${selectedRandomQuestion.label}</label>
                 <textarea id="${selectedRandomQuestion.id}" name="${selectedRandomQuestion.id}" required data-min-words="${selectedRandomQuestion.minWords}" placeholder="Please provide your thoughts... (min ${selectedRandomQuestion.minWords} words)"></textarea>
                 <div class="word-count-info">Words: <span id="${selectedRandomQuestion.id}_word_count">0</span>/${selectedRandomQuestion.minWords}</div>
                 <div class="paste-warning" id="${selectedRandomQuestion.id}_paste_warning">Pasting content is discouraged. Please use your own words.</div>
                 <div class="error-message" id="${selectedRandomQuestion.id}_error"></div>
             `;
             const qRandomTextarea = document.getElementById(selectedRandomQuestion.id);

             // --- Word Count Validation Setup ---
             setupWordCountValidation(q1Textarea, document.getElementById('q1_word_count'), document.getElementById('q1_error'));
             setupWordCountValidation(qRandomTextarea, document.getElementById(`${selectedRandomQuestion.id}_word_count`), document.getElementById(`${selectedRandomQuestion.id}_error`));
             setupWordCountValidation(q3Textarea, document.getElementById('q3_word_count'), document.getElementById('q3_error'));
             setupWordCountValidation(q4Explanation, document.getElementById('q4_exp_word_count'), document.getElementById('q4_exp_error'));

             // --- Paste Prevention Setup ---
             setupPastePrevention(q1Textarea, document.getElementById('q1_paste_warning'));
             setupPastePrevention(qRandomTextarea, document.getElementById(`${selectedRandomQuestion.id}_paste_warning`));
             setupPastePrevention(q3Textarea, document.getElementById('q3_paste_warning'));
             setupPastePrevention(q4Explanation, document.getElementById('q4_exp_paste_warning'));

             // --- Form Submission ---
             form.addEventListener('submit', handleAssessmentSubmit);
        }

        function countWords(text) {
            return text.trim().split(/\s+/).filter(Boolean).length; // Split by whitespace, filter empty strings
        }

         function setupWordCountValidation(textarea, countSpan, errorElement) {
             const minWords = parseInt(textarea.getAttribute('data-min-words'), 10);
             textarea.addEventListener('input', () => {
                 const words = countWords(textarea.value);
                 countSpan.textContent = words;
                 validateWordCount(textarea, minWords, errorElement); // Validate on input
             });
             // Initial validation in case of pre-filled data (unlikely here but good practice)
             validateWordCount(textarea, minWords, errorElement);
         }

        function validateWordCount(textarea, minWords, errorElement) {
             const words = countWords(textarea.value);
             if (textarea.value.trim() !== '' && words < minWords) { // Only show error if something is typed but not enough
                 errorElement.textContent = `Minimum ${minWords} words required.`;
                 errorElement.style.display = 'block';
                 textarea.classList.add('invalid');
                 return false;
             } else {
                 errorElement.style.display = 'none';
                 textarea.classList.remove('invalid');
                 return true;
             }
        }

        function setupPastePrevention(textarea, warningElement) {
            textarea.addEventListener('paste', (event) => {
                event.preventDefault();
                warningElement.style.display = 'block';
                // Hide the warning after a few seconds
                setTimeout(() => { warningElement.style.display = 'none'; }, 3000);
            });
        }

        function handleAssessmentSubmit(event) {
            event.preventDefault();
            console.log("Assessment submit triggered.");
            const form = event.target;
            const submitButton = document.getElementById('assessmentSubmitBtn');
            submitButton.disabled = true; // Prevent double submission

            // --- Clear previous errors ---
            form.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            form.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));

            // --- Get elements ---
            const q1Textarea = document.getElementById('q1_coaching_meaning');
            const qRandomTextarea = document.getElementById(selectedRandomQuestion.id);
            const q3Textarea = document.getElementById('q3_expectations');
            const q4Rating = document.getElementById('q4_confidence_rating');
            const q4Explanation = document.getElementById('q4_confidence_explanation');

             const q1Error = document.getElementById('q1_error');
             const qRandomError = document.getElementById(`${selectedRandomQuestion.id}_error`);
             const q3Error = document.getElementById('q3_error');
             const q4RatingError = document.getElementById('q4_rating_error');
             const q4ExpError = document.getElementById('q4_exp_error');

            // --- Validation ---
            let isValid = true;

            // Q1
            if (!q1Textarea.value.trim()) {
                q1Error.textContent = 'This field is required.'; q1Error.style.display = 'block'; q1Textarea.classList.add('invalid'); isValid = false;
            } else if (!validateWordCount(q1Textarea, parseInt(q1Textarea.getAttribute('data-min-words'), 10), q1Error)) {
                 isValid = false; // validateWordCount handles error display
            }

             // Random Q
             if (!qRandomTextarea.value.trim()) {
                 qRandomError.textContent = 'This field is required.'; qRandomError.style.display = 'block'; qRandomTextarea.classList.add('invalid'); isValid = false;
             } else if (!validateWordCount(qRandomTextarea, selectedRandomQuestion.minWords, qRandomError)) {
                  isValid = false;
             }

            // Q3
            if (!q3Textarea.value.trim()) {
                q3Error.textContent = 'This field is required.'; q3Error.style.display = 'block'; q3Textarea.classList.add('invalid'); isValid = false;
            } else if (!validateWordCount(q3Textarea, parseInt(q3Textarea.getAttribute('data-min-words'), 10), q3Error)) {
                 isValid = false;
            }

            // Q4 Rating
            const ratingVal = parseInt(q4Rating.value, 10);
            if (!q4Rating.value || isNaN(ratingVal) || ratingVal < 1 || ratingVal > 5) {
                q4RatingError.textContent = 'Please enter a valid rating between 1 and 5.'; q4RatingError.style.display = 'block'; q4Rating.classList.add('invalid'); isValid = false;
            }

            // Q4 Explanation
             if (!q4Explanation.value.trim()) {
                q4ExpError.textContent = 'This field is required.'; q4ExpError.style.display = 'block'; q4Explanation.classList.add('invalid'); isValid = false;
            } else if (!validateWordCount(q4Explanation, parseInt(q4Explanation.getAttribute('data-min-words'), 10), q4ExpError)) {
                 isValid = false;
            }

            // --- Process if Valid ---
            if (isValid) {
                console.log("Assessment form is valid.");
                const currentUser = getCurrentUser();
                if (!currentUser) { // Double check user data exists
                    console.error("Cannot save assessment, user data lost.");
                    alert("An error occurred. Please try logging out and back in.");
                     submitButton.disabled = false;
                    return;
                }

                // Save answers
                currentUser.assessmentAnswers = {
                    [q1Textarea.name]: q1Textarea.value.trim(),
                    [qRandomTextarea.name]: qRandomTextarea.value.trim(), // Use name from the random question
                    [q3Textarea.name]: q3Textarea.value.trim(),
                    [q4Rating.name]: ratingVal,
                    [q4Explanation.name]: q4Explanation.value.trim()
                };
                currentUser.assessmentCompleted = true;

                saveCurrentUser(currentUser); // Save updated user data

                // Show success popup
                document.getElementById('assessmentSuccessPopup').style.display = 'block';
                document.getElementById('popupOverlay').style.display = 'block';
                // Button inside popup now handles the transition to dashboard

            } else {
                console.log("Assessment form is invalid.");
                 submitButton.disabled = false; // Re-enable button if validation fails
                 // Optionally scroll to the first error
                 const firstError = form.querySelector('.invalid');
                 if (firstError) {
                     firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                 }
            }
        }

        function displayMainDashboard(user) {
            console.log("Displaying main dashboard content.");
            const loadingMessage = document.getElementById('loadingMessage');
            const userDashboardContent = document.getElementById('userDashboardContent');
            const adminSection = document.getElementById('adminSection');
            const adminDataContainer = document.getElementById('adminDataContainer');
            const courseSectionsList = document.getElementById('courseSectionsList');
            const welcomeMessage = document.getElementById('welcomeMessage');
            const dashboardUserName = document.getElementById('dashboardUserName');
            const dashboardUserEmail = document.getElementById('dashboardUserEmail');

             // Hide loading message
            loadingMessage.style.display = 'none';

             // Populate User Info in Dashboard Area
             if (welcomeMessage) welcomeMessage.textContent = `Welcome back, ${user.name}!`;
             if (dashboardUserName) dashboardUserName.textContent = user.name;
             if (dashboardUserEmail) dashboardUserEmail.textContent = user.email;

            // Display Course Sections
            if (courseSectionsList) {
                 displayCourseSections(user, courseSectionsList);
            } else {
                 console.error("Course sections list container not found!");
            }

            // Check for Admin Access
            const isAdmin = user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
            if (isAdmin) {
                console.log("Admin user detected. Displaying admin panel.");
                 document.getElementById('adminEmailDisplay').textContent = user.email; // Show admin email in note
                if (adminSection) {
                    adminSection.style.display = 'block';
                    setTimeout(() => adminSection.classList.add('fade-in'), 50); // Fade in admin section
                }
                if (adminDataContainer) {
                    displayAdminData(user, adminDataContainer); // Pass admin's own data
                } else {
                     console.error("Admin data container not found!");
                }
            } else {
                 console.log("Regular user detected. Admin panel hidden.");
                 if (adminSection) adminSection.style.display = 'none';
            }

            // Show User Dashboard Content & Apply Fade-in
            if (userDashboardContent) {
                userDashboardContent.style.display = 'block';
                 setTimeout(() => userDashboardContent.classList.add('fade-in'), 50); // Trigger fade-in
            }
        }


        function displayCourseSections(user, containerElement) {
            if (!user || !containerElement) {
                console.error("Cannot display course sections: Invalid user or container."); return;
            }
            containerElement.innerHTML = ''; // Clear previous content
            if (!user.progress) {
                 console.warn("Displaying sections, user.progress missing. Defaulting to 0%. User:", user);
                 user.progress = {};
            }

            courseSections.forEach(section => {
                const progress = user.progress[section.id] || 0;
                const progressPercentage = Math.max(0, Math.min(100, Math.round(progress)));

                const sectionElement = document.createElement('div');
                sectionElement.className = 'course-section';
                sectionElement.innerHTML = `
                    <span class="section-title">${section.title}</span>
                    <div class="section-progress">
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: 0%;"></div> {/* Start at 0 for animation */}
                        </div>
                        <span class="progress-text">${progressPercentage}% Complete</span>
                        <a href="${section.link || '#'}" class="section-link" title="Go to ${section.title}">Start</a>
                    </div>
                `;

                const progressBar = sectionElement.querySelector('.progress-bar');
                const linkButton = sectionElement.querySelector('.section-link');

                 // Update link button text based on progress
                 if (progress >= 100) {
                     linkButton.textContent = 'Review'; linkButton.style.backgroundColor = '#2ecc71';
                     linkButton.onmouseover = () => linkButton.style.backgroundColor = '#27ae60';
                     linkButton.onmouseout = () => linkButton.style.backgroundColor = '#2ecc71';
                 } else if (progress > 0) {
                     linkButton.textContent = 'Continue'; linkButton.style.backgroundColor = '#f39c12';
                     linkButton.onmouseover = () => linkButton.style.backgroundColor = '#e67e22';
                     linkButton.onmouseout = () => linkButton.style.backgroundColor = '#f39c12';
                 } else {
                     linkButton.style.backgroundColor = '#3498db';
                     linkButton.onmouseover = () => linkButton.style.backgroundColor = '#2980b9';
                     linkButton.onmouseout = () => linkButton.style.backgroundColor = '#3498db';
                 }

                containerElement.appendChild(sectionElement);

                 // Animate progress bar width after element is added to DOM
                 setTimeout(() => { progressBar.style.width = `${progressPercentage}%`; }, 100); // Small delay allows animation
            });
        }

         function displayAdminData(adminUser, containerElement) {
             // This function now ONLY displays the provided adminUser's data
             if (!containerElement) { console.error("Admin container element not found."); return; }
             if (!adminUser || !adminUser.progress) {
                 containerElement.innerHTML = '<p>Error: Could not load your progress data.</p>';
                 return;
             }

             let tableHTML = `
                <p>Displaying progress for your account (${adminUser.email}):</p>
                <table class="admin-user-table">
                    <thead>
                        <tr>
                            <th>Section</th>
                            <th>Progress (%)</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
             `;

             courseSections.forEach(section => {
                 const progress = adminUser.progress[section.id] || 0;
                 const progressPercentage = Math.max(0, Math.min(100, Math.round(progress)));
                 let status = 'Not Started';
                 if (progress >= 100) status = 'Completed';
                 else if (progress > 0) status = 'In Progress';

                 tableHTML += `
                    <tr>
                        <td>${section.title}</td>
                        <td>${progressPercentage}%</td>
                        <td>${status}</td>
                    </tr>
                 `;
             });

             tableHTML += `
                    </tbody>
                </table>
                 <p style="margin-top: 15px; font-size: 14px; color: #777;"><em>Reminder: This table shows only *your* data due to technical limitations. A full admin view requires a server backend.</em></p>
             `;

             containerElement.innerHTML = tableHTML;
         }

        function logout() {
            console.log("Logging out user...");
            try {
                localStorage.removeItem(LOGGED_IN_KEY);
                localStorage.removeItem(CURRENT_USER_KEY);
                // Keep SIGNUP_FLAG_KEY so they are directed to login, not signup
                console.log("Local storage cleared for logout.");
                window.location.href = 'login.html';
            } catch (e) {
                console.error("Error during logout:", e);
                window.location.href = 'login.html'; // Force redirect
            }
        }

    </script>
</body>
</html>
