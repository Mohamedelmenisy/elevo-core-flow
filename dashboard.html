<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Dashboard | Leadership & Coaching</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3281/3281289.png">
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Chart.js Library (Optional, keep if you want charts later) -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script> -->
    <!-- Feather Icons -->
     <script src="https://unpkg.com/feather-icons"></script>

    <style>
        /* --- Base Styles (Keep consistent) --- */
        :root {
            --primary-color: #3b82f6; /* Blue-500 */
            --primary-darker: #2563eb; /* Blue-600 */
            --secondary-color: #10b981; /* Emerald-500 */
            --secondary-darker: #059669; /* Emerald-600 */
            --accent-color: #f59e0b; /* Amber-500 */
            --accent-darker: #d97706; /* Amber-600 */
            --text-dark: #1f2937;
            --text-medium: #4b5563;
            --text-light: #6b7280;
            --bg-light: #f9fafb; /* Light Gray */
            --bg-white: #ffffff;
            --bg-dark: #111827; /* Dark Gray for Header/Footer */
            --border-color: #e5e7eb;
            --error-red: #ef4444;
            --success-green: #22c55e;
            --success-bg-light: #f0fdf4;
            --success-border: #bbf7d0;
            --warn-yellow: #f59e0b;
            --info-blue: #3b82f6;
            --info-bg-light: #eff6ff;
            --info-border: #bfdbfe;
            --admin-bg: #f1f5f9; /* Slightly different bg for admin */
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html { scroll-behavior: smooth; }
        body {
            background-color: var(--bg-light); margin: 0; padding: 0; line-height: 1.6; color: var(--text-medium);
            display: flex; flex-direction: column; min-height: 100vh; font-size: 16px;
        }
        main { flex-grow: 1; }
        .container { max-width: 72rem; margin: 2.5rem auto; padding: 0 1.5rem; }

        /* --- Header, User Bar, Footer (Original Styles) --- */
        .header { background-color: var(--bg-dark); color: white; padding: 1.125rem 0; text-align: center; font-size: 1.625rem; font-weight: 600; box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1); }
        .user-bar { background-color: #374151; padding: 0.625rem 1.875rem; display: flex; justify-content: space-between; align-items: center; color: #e5e7eb; font-size: 0.9375rem; }
        .user-info { display: flex; align-items: center; gap: 0.9375rem; }
        .user-info svg, .user-info i { opacity: 0.8; margin-right: 0.5rem; color: #9ca3af; width: 20px; height: 20px; }
        .user-details { display: flex; flex-direction: column; text-align: left; }
        .user-name { font-weight: 600; font-size: 0.9375rem; color: #f9fafb; }
        .user-email { font-size: 0.8125rem; opacity: 0.8; }
        .logout-button { background-color: var(--error-red); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; font-weight: 500; transition: all 0.3s; display: flex; align-items: center; gap: 0.375rem; font-size: 0.9375rem; }
        .logout-button svg, .logout-button i { margin-right: 0.375rem; width: 16px; height: 16px;}
        .logout-button:hover { background-color: #dc2626; transform: translateY(-1px); }
        .logout-button:active { transform: translateY(0); }
        .footer { text-align: center; padding: 1.5625rem 1.875rem; background: var(--bg-dark); color: rgba(229, 231, 235, 0.8); margin-top: 3.125rem; font-size: 0.875rem; display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 1.5625rem; border-top: 1px solid #374151; }
        .footer-text { text-align: center; }
        .social-icons { display: flex; gap: 1.25rem; align-items: center; }
        .social-icons a { color: rgba(229, 231, 235, 0.8); text-decoration: none; display: inline-block; transition: transform 0.3s ease, color 0.3s ease; }
        .social-icons a:hover { color: #ffffff; transform: translateY(-2px); }
        .social-icons svg { width: 1.5rem; height: 1.5rem; fill: currentColor; vertical-align: middle; }

        /* --- Dashboard Specific Styles --- */
        h2 { color: var(--text-dark); font-weight: 700; margin-bottom: 1rem; font-size: 2rem; text-align: center; }
        h3 { margin: 2rem 0 1rem; font-size: 1.5rem; color: var(--text-dark); border-bottom: 2px solid var(--primary-color); padding-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;}
        h3 i { width: 24px; height: 24px; }
        .dashboard-intro { text-align: center; font-size: 1.1rem; color: var(--text-medium); margin-bottom: 2.5rem; max-width: 600px; margin-left: auto; margin-right: auto; }
        .modules-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
        .module-card { background-color: var(--bg-white); border-radius: 0.75rem; padding: 1.5rem 1.75rem; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07); border: 1px solid var(--border-color); display: flex; flex-direction: column; transition: transform 0.2s ease-out, box-shadow 0.2s ease-out; border-left: 5px solid var(--primary-color); }
        .module-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); }
        .module-card h4 { font-size: 1.25rem; color: var(--text-dark); margin-bottom: 0.75rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
        .module-card h4 i { color: var(--primary-color); width: 20px; height: 20px;}
        .module-card p { font-size: 0.95rem; color: var(--text-medium); flex-grow: 1; margin-bottom: 1.25rem; }
        .status-badge { display: inline-block; padding: 0.25rem 0.75rem; font-size: 0.75rem; font-weight: 600; border-radius: 999px; margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.5px; align-self: flex-start; }
        .status-badge.not-started { background-color: #e5e7eb; color: #4b5563; }
        .status-badge.in-progress { background-color: var(--info-bg-light); color: var(--info-blue); border: 1px solid var(--info-border); }
        .status-badge.completed { background-color: var(--success-bg-light); color: #166534; border: 1px solid var(--success-border); }
        .module-action-button { background: linear-gradient(90deg, var(--secondary-color), var(--secondary-darker)); color: white; border: none; padding: 0.6rem 1.2rem; font-size: 0.9rem; font-weight: 500; border-radius: 0.5rem; cursor: pointer; transition: all 0.3s ease; text-decoration: none; text-align: center; display: inline-flex; align-items: center; justify-content: center; gap: 0.4rem; }
        .module-action-button i { width: 16px; height: 16px; }
        .module-action-button:hover:not(:disabled) { background: linear-gradient(90deg, var(--secondary-darker), #047857); box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2); transform: translateY(-2px); }
        .module-action-button:disabled { background: #d1d5db; color: #6b7280; cursor: not-allowed; opacity: 0.7; }
        .module-card.locked { border-left-color: #d1d5db; opacity: 0.7; background-color: #f3f4f6; }
        .module-card.locked:hover { transform: none; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07); }

        /* --- Admin Section Styles --- */
        #adminDashboard { background-color: var(--admin-bg); padding: 2rem; margin-top: 3rem; border-radius: 0.75rem; border: 1px solid var(--border-color); }
        #adminDashboard h3 { border-color: var(--accent-color); color: var(--text-dark); }
        .admin-controls { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; }
        .filters { display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;}
        .filters label { font-weight: 500; color: var(--text-medium); margin-right: 0.25rem;}
        .filters select, .filters input[type="text"] { padding: 0.5rem 0.8rem; border: 1px solid #ccc; border-radius: 0.375rem; font-size: 0.9rem; height: 38px; }
        .filters input[type="text"] { min-width: 180px; }
        .filters button { background-color: var(--accent-color); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.3s; font-weight: 500; height: 38px; display: inline-flex; align-items: center; gap: 0.3rem;}
        .filters button:hover { background-color: var(--accent-darker); }
        .filters button i { width: 14px; height: 14px;}
        .export-button { background-color: var(--primary-color); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.3s; font-weight: 500; height: 38px; display: inline-flex; align-items: center; gap: 0.3rem; }
        .export-button:hover { background-color: var(--primary-darker); }
        .export-button i { width: 16px; height: 16px; }
        .charts-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; margin-bottom: 2rem; background-color: var(--bg-white); padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .chart-box h4 { text-align: center; margin-bottom: 1rem; font-size: 1.1rem; color: var(--text-dark); }
        .table-container { overflow-x: auto; background-color: var(--bg-white); border-radius: 0.5rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding: 0.5rem; margin-bottom: 1.5rem; /* Space below tables */ }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 0; /* Removed top margin */ font-size: 0.9rem; }
        .admin-table th, .admin-table td { padding: 0.8rem 1rem; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        .admin-table th { background-color: #f3f4f6; font-weight: 600; color: var(--text-dark); }
        .admin-table tbody tr:hover { background-color: #f9fafb; }
        .admin-table td { color: var(--text-medium); }
        .admin-status-badge { padding: 0.2rem 0.6rem; border-radius: 0.25rem; font-weight: 500; font-size: 0.8rem; text-transform: capitalize; }
        .admin-status-badge.completed, .admin-status-badge.passed { background-color: var(--success-bg-light); color: #15803d; border: 1px solid var(--success-border);}
        .admin-status-badge.failed, .admin-status-badge.needs-support { background-color: #fef2f2; color: #b91c1c; border: 1px solid #fecaca;}
        .admin-status-badge.in-progress { background-color: var(--info-bg-light); color: var(--info-blue); border: 1px solid var(--info-border); }
        .view-details-btn { background: none; border: none; color: var(--primary-color); cursor: pointer; padding: 2px; }
        .view-details-btn:hover { color: var(--primary-darker); }
        .view-details-btn i { width: 16px; height: 16px; vertical-align: middle;}

        /* Pagination Styles */
        .pagination-container { display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin-top: 1.5rem; padding: 0.5rem; }
        .pagination-button { background-color: var(--bg-white); border: 1px solid var(--border-color); color: var(--primary-color); padding: 0.4rem 0.8rem; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.2s, color 0.2s; font-weight: 500; }
        .pagination-button:hover:not(:disabled) { background-color: var(--info-bg-light); border-color: var(--info-border); }
        .pagination-button:disabled { color: #9ca3af; cursor: not-allowed; background-color: #f3f4f6; }
        .pagination-info { font-size: 0.9rem; color: var(--text-light); }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); padding-top: 60px; animation: fadeInModal 0.3s ease-out; }
         @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 25px 30px; border: 1px solid #888; width: 80%; max-width: 700px; border-radius: 0.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.2); position: relative; animation: slideInModal 0.4s ease-out; }
          @keyframes slideInModal { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-close { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; }
        .modal-close:hover, .modal-close:focus { color: black; text-decoration: none; }
        .modal h4 { margin-bottom: 1.5rem; color: var(--text-dark); border-bottom: 1px solid var(--border-color); padding-bottom: 0.8rem; }
        .modal-body { max-height: 60vh; overflow-y: auto; /* Scroll for long content */ padding-right: 10px; /* Space for scrollbar */ }
        .detail-item { margin-bottom: 1rem; padding-bottom: 0.8rem; border-bottom: 1px dotted var(--border-color); }
        .detail-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0;}
        .detail-item strong { display: block; color: var(--text-dark); margin-bottom: 0.3rem; font-weight: 600; font-size: 0.95rem; }
        .detail-item span { color: var(--text-medium); font-size: 0.95rem; white-space: pre-wrap; word-wrap: break-word; }
        .detail-item span.correct { color: var(--success-green); font-weight: bold; }
        .detail-item span.incorrect { color: var(--error-red); font-weight: bold; }
        .detail-item span.feedback-answer { background-color: #f8f9fa; padding: 5px 8px; border-radius: 4px; display: inline-block; } /* Style for feedback answers */

        #adminRestrictionMsg { background-color: var(--info-bg-light); color: var(--info-blue); border: 1px solid var(--info-border); padding: 1rem 1.5rem; border-radius: 0.5rem; margin-top: 2rem; text-align: center; font-weight: 500; display: none; align-items: center; justify-content: center; gap: 0.75rem; }
        #adminRestrictionMsg i { width: 20px; height: 20px; }
        .loading-indicator { text-align: center; padding: 2rem; font-size: 1.1rem; color: var(--text-medium); }

        /* --- Responsive Adjustments --- */
        @media (max-width: 768px) { /* ... (keep previous responsive styles) ... */ h2{font-size:1.8rem}h3{font-size:1.3rem}.container{padding:0 1rem}.user-bar{padding:.5rem 1rem;font-size:.85rem}.logout-button{padding:.4rem .8rem;font-size:.85rem}.admin-controls{flex-direction:column;align-items:stretch}.filters{flex-direction:column;align-items:stretch;width:100%}.filters select,.filters input,.filters button{width:100%;margin-bottom:.5rem}.export-button{width:100%}.charts-container{grid-template-columns:1fr}.modal-content{width:90%;margin:10% auto} }
        @media (max-width: 480px) { /* ... (keep previous responsive styles) ... */ body{font-size:15px}h2{font-size:1.6rem}h3{font-size:1.2rem}.dashboard-intro{font-size:1rem}.module-card{padding:1.2rem}.module-card h4{font-size:1.1rem}.module-card p{font-size:.9rem}.module-action-button{font-size:.85rem;padding:.5rem 1rem}.admin-table{font-size:.85rem}.admin-table th,.admin-table td{padding:.6rem .8rem;white-space:normal}#adminDashboard{padding:1.5rem}#adminRestrictionMsg{padding:.8rem 1rem;font-size:.9rem}.footer{flex-direction:column;gap:1rem;padding:1rem;font-size:.8rem}.pagination-button{padding:.3rem .6rem;font-size:.9rem}.pagination-info{font-size:.8rem} }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">Coaching & Leadership Course</header>

    <!-- User Bar -->
    <div class="user-bar">
        <div class="user-info"> <i data-feather="user"></i> <div class="user-details"> <span class="user-name" id="userName">Loading...</span> <span class="user-email" id="userEmail"></span> </div> </div> <button class="logout-button" onclick="logout()"> <i data-feather="log-out"></i> <span>Logout</span> </button>
    </div>

    <!-- Main Content -->
    <main class="container" id="mainContainer" style="display: none;">
        <h2>👋 Welcome to Your Dashboard!</h2>
        <p class="dashboard-intro"> Track your progress through the Coaching & Leadership course modules. Complete each section to unlock the next step in your journey. </p>

        <!-- Course Modules Section -->
        <section id="courseModules">
            <h3><i data-feather="layers"></i>Course Modules</h3>
            <div class="modules-grid">
                <!-- Cards will be populated by JS -->
                <div class="module-card" id="module-introduction" data-module-id="introduction" data-page-name="introduction.html" data-next-module="coaching-skills"><h4><i data-feather="play-circle"></i>Introduction</h4><p>Understand core concepts...</p><span class="status-badge not-started" id="status-introduction">Not Started</span><a href="introduction.html" class="module-action-button" id="action-introduction"><i data-feather="arrow-right-circle"></i><span>Start Module</span></a></div>
                <div class="module-card locked" id="module-coaching-skills" data-module-id="coaching-skills" data-page-name="coaching-skills.html" data-previous-module="introduction" data-next-module="coaching-individuals"><h4><i data-feather="tool"></i>Coaching Skills</h4><p>Develop essential coaching skills...</p><span class="status-badge not-started" id="status-coaching-skills">Not Started</span><a href="coaching-skills.html" class="module-action-button" id="action-coaching-skills" disabled><i data-feather="lock"></i><span>Locked</span></a></div>
                <div class="module-card locked" id="module-coaching-individuals" data-module-id="coaching-individuals" data-page-name="coaching-individuals.html" data-previous-module="coaching-skills" data-next-module="coaching-team"><h4><i data-feather="user-check"></i>Coaching Individuals</h4><p>Learn strategies for one-on-one...</p><span class="status-badge not-started" id="status-coaching-individuals">Not Started</span><a href="coaching-individuals.html" class="module-action-button" id="action-coaching-individuals" disabled><i data-feather="lock"></i><span>Locked</span></a></div>
                <div class="module-card locked" id="module-coaching-team" data-module-id="coaching-team" data-page-name="coaching-team.html" data-previous-module="coaching-individuals" data-next-module="coaching-yourself"><h4><i data-feather="users"></i>Coaching Teams</h4><p>Explore team dynamics...</p><span class="status-badge not-started" id="status-coaching-team">Not Started</span><a href="coaching-team.html" class="module-action-button" id="action-coaching-team" disabled><i data-feather="lock"></i><span>Locked</span></a></div>
                <div class="module-card locked" id="module-coaching-yourself" data-module-id="coaching-yourself" data-page-name="coaching-yourself.html" data-previous-module="coaching-team" data-next-module="action-plan"><h4><i data-feather="compass"></i>Coaching Yourself</h4><p>Apply principles to self-development...</p><span class="status-badge not-started" id="status-coaching-yourself">Not Started</span><a href="coaching-yourself.html" class="module-action-button" id="action-coaching-yourself" disabled><i data-feather="lock"></i><span>Locked</span></a></div>
                <div class="module-card locked" id="module-action-plan" data-module-id="action-plan" data-page-name="action-plan.html" data-previous-module="coaching-yourself" data-next-module="assessment"><h4><i data-feather="clipboard"></i>Action Plan</h4><p>Create your personal action plan...</p><span class="status-badge not-started" id="status-action-plan">Not Started</span><a href="action-plan.html" class="module-action-button" id="action-action-plan" disabled><i data-feather="lock"></i><span>Locked</span></a></div>
                 <div class="module-card locked" id="module-assessment" data-module-id="assessment" data-page-name="ass.html" data-previous-module="action-plan" data-next-module="final_assessment"><h4><i data-feather="check-circle"></i>Leadership Quiz</h4><p>Test your knowledge on leadership...</p><span class="status-badge not-started" id="status-assessment">Not Started</span><a href="ass.html" class="module-action-button" id="action-assessment" disabled><i data-feather="lock"></i><span>Locked</span></a></div>
                 <div class="module-card locked" id="module-final_assessment" data-module-id="final_assessment" data-page-name="final_ass.html" data-previous-module="assessment" data-next-module="feedback"><h4><i data-feather="award"></i>Final Assessment</h4><p>Complete the final evaluation...</p><span class="status-badge not-started" id="status-final_assessment">Not Started</span><a href="final_ass.html" class="module-action-button" id="action-final_assessment" disabled><i data-feather="lock"></i><span>Locked</span></a></div>
                 <div class="module-card locked" id="module-feedback" data-module-id="feedback" data-page-name="feedback.html" data-previous-module="final_assessment"><h4><i data-feather="message-square"></i>Course Feedback</h4><p>Share your valuable feedback...</p><span class="status-badge not-started" id="status-feedback">Not Started</span><a href="feedback.html" class="module-action-button" id="action-feedback" disabled><i data-feather="lock"></i><span>Locked</span></a></div>
            </div>
        </section>

        <!-- Admin Dashboard Section (Initially hidden) -->
        <section id="adminDashboard" style="display: none;">
             <h3><i data-feather="bar-chart-2"></i>Admin Analytics Dashboard</h3>

             <div class="admin-controls">
                 <div class="filters">
                     <div> <label for="userFilter">User:</label> <select id="userFilter"><option value="all">All Users</option></select> </div>
                     <div> <label for="sectionFilter">Section:</label> <select id="sectionFilter"><option value="all">All Sections</option></select> </div>
                     <button id="applyAdminFiltersBtn"><i data-feather="filter"></i>Apply Filters</button>
                 </div>
                 <button id="exportCsvBtn" class="export-button"><i data-feather="download"></i>Export CSV</button>
             </div>

             <div id="adminLoadingIndicator" class="loading-indicator" style="display: none;"><p>Loading data...</p></div>

             <div id="adminDataContainer" style="display: none;">
                  <!-- Users Overview Table -->
                 <div class="table-container">
                     <h4>Users Overview</h4>
                     <table class="admin-table">
                         <thead><tr><th>Name</th><th>Email</th><th>Joined</th><th>Quiz 1 Complete</th><th>Final Assessment Complete</th><th>Feedback Submitted</th></tr></thead>
                         <tbody id="usersTableBody"></tbody>
                     </table>
                 </div>

                 <!-- Assessment Results Table -->
                 <div class="table-container">
                     <h4>Assessment Submissions</h4>
                     <table class="admin-table">
                         <thead><tr><th>User</th><th>Assessment</th><th>Status</th><th>Score</th><th>Submitted</th><th>Details</th></tr></thead>
                         <tbody id="assessmentsTableBody"></tbody>
                     </table>
                 </div>

                 <!-- Feedback Table -->
                 <div class="table-container">
                     <h4>Feedback Responses</h4>
                      <div class="filters"> <!-- Filter specific to feedback -->
                          <label for="feedbackQuestionFilter">Filter by Question:</label>
                          <select id="feedbackQuestionFilter"><option value="all">All Feedback Questions</option></select>
                      </div>
                     <table class="admin-table">
                         <thead><tr><th>User</th><th>Question</th><th>Answer</th><th>Submitted</th></tr></thead>
                         <tbody id="feedbackTableBody"></tbody>
                     </table>
                       <!-- Pagination for Feedback -->
                       <div class="pagination-container" id="feedbackPaginationContainer"></div>
                 </div>

                 <!-- Progress Details Table (Example - can be expanded) -->
                 <div class="table-container">
                      <h4>Progress Details (Example: Action Plan)</h4>
                      <p style="font-size:0.9em; color: var(--text-light); margin-bottom: 0.5rem;">Select a user from the filter above to see their specific answers for a section.</p>
                       <table class="admin-table">
                          <thead><tr><th>User</th><th>Question</th><th>Answer</th></tr></thead>
                          <tbody id="progressDetailsTableBody"></tbody>
                      </table>
                  </div>

             </div>
        </section>

        <!-- Message for Non-Admins -->
         <p id="adminRestrictionMsg" style="display: none;"> <i data-feather="lock"></i> <span>The analytics section is restricted to administrators.</span> </p>

         <!-- Details Modal -->
         <div id="detailsModal" class="modal">
             <div class="modal-content">
                 <span class="modal-close" onclick="closeDetailsModal()">×</span>
                 <h4 id="modalTitle">Submission Details</h4>
                 <div id="modalBody" class="modal-body"> <p>Loading details...</p> </div>
             </div>
         </div>

    </main>

    <!-- Footer -->
    <footer class="footer">
          <span class="footer-text">© 2025 Elmenisy Leadership Coaching - All Rights Reserved</span> <div class="social-icons"> <a href="https://www.linkedin.com/in/mohamedmenisy17/" target="_blank" rel="noopener noreferrer" aria-label="LinkedIn Profile"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg> </a> <a href="https://wa.me/201014527321" target="_blank" rel="noopener noreferrer" aria-label="WhatsApp Chat"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01s-.521.074-.792.372c-.272.296-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg> </a> <a href="https://www.instagram.com/mohamed_menisyy/profilecard/?igsh=d3ZwZDM4czRqMzB2" target="_blank" rel="noopener noreferrer" aria-label="Instagram Profile"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 1.172.053 1.905.33 2.46.538.7.268 1.192.64 1.64 1.092.45.447.83 1.004 1.093 1.64.208.555.485 1.288.538 2.46.058 1.265.07 1.646.07 4.85s-.012 3.584-.07 4.85c-.053 1.172-.33 1.905-.538 2.46-.268.7-.64 1.192-1.092 1.64-.447.45-.997.827-1.64 1.093-.555.208-1.288.485-2.46.538-1.265.058-1.646.07-4.85.07s-3.584-.012-4.85-.07c-1.172-.053-1.905-.33-2.46-.538-.697-.268-1.19-.64-1.64-1.093-.45-.447-.827-.997-1.093-1.64-.208-.555-.485-1.288-.538-2.46-.058-1.265-.07-1.646-.07-4.85s.012-3.584.07-4.85c.053-1.172.33-1.905.538-2.46.268-.697.64-1.19 1.093-1.64.45-.45.997-.827 1.64-1.093.555-.208 1.288.485 2.46.538 1.265-.058 1.646-.07 4.85-.07zm0-2.163c-3.259 0-3.667.014-4.947.072-1.356.06-2.31.344-3.174.732-.884.396-1.627.96-2.377 1.71-.755.752-1.318 1.494-1.716 2.378-.386.863-.67 1.818-.73 3.172C.014 8.333 0 8.741 0 12s.014 3.667.072 4.947c.06 1.356.344 2.31.73 3.174.396.884.96 1.627 1.716 2.377.752.755 1.494 1.318 2.378 1.716.863.386 1.818.67 3.172.73 1.28.058 1.688.072 4.947.072s3.667-.014 4.947-.072c1.356-.06 2.31-.344 3.174-.73.884-.396 1.627-.96 2.377-1.716.755-.752 1.318-1.494 1.716-2.378.386.863.67-1.818.73-3.172.058-1.28.072-1.688.072-4.947s-.014-3.667-.072-4.947c-.06-1.356-.344-2.31-.73-3.174-.396-.884-.96-1.627-1.716-2.377-.752-.755-1.494-1.318-2.378-1.716-.863-.386-1.818-.67-3.172-.73C15.667.014 15.259 0 12 0zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.162 6.162 6.162 6.162-2.759 6.162-6.162S15.403 5.838 12 5.838zm0 10.333c-2.306 0-4.171-1.865-4.171-4.171s1.865-4.171 4.171-4.171 4.171 1.865 4.171 4.171-1.865 4.171-4.171 4.171zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg> </a> </div>
    </footer>

    <script>
        // --- Supabase Config ---
        const SUPABASE_URL = 'https://lgcutmuspcaralydycmg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnY3V0bXVzcGNhcmFseWR5Y21nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0NDY3MDEsImV4cCI6MjA2MTAyMjcwMX0.3u5Y7pkH2NNnnoGLMWVfAa5b8fq88o1itRYnG1K38tE';
        let supabase = null;

        // --- Unified Keys & Config ---
        const LOGGED_IN_KEY = 'isUserLoggedIn';
        const CURRENT_USER_KEY = 'currentUser';
        const PAGE_NAME = 'dashboard.html'; // Ensure this matches the filename

        // --- Module IDs ---
         // Define module data directly in JS for easier management
         const modules = [
             { id: 'introduction', name: 'Introduction', page: 'introduction.html', icon: 'play-circle', next: 'coaching-skills', assessmentId: 'intro_goal_q1' }, // Intro completion based on goal save
             { id: 'coaching-skills', name: 'Coaching Skills', page: 'coaching-skills.html', icon: 'tool', prev: 'introduction', next: 'coaching-individuals' },
             { id: 'coaching-individuals', name: 'Coaching Individuals', page: 'coaching-individuals.html', icon: 'user-check', prev: 'coaching-skills', next: 'coaching-team' },
             { id: 'coaching-team', name: 'Coaching Teams', page: 'coaching-team.html', icon: 'users', prev: 'coaching-individuals', next: 'coaching-yourself' },
             { id: 'coaching-yourself', name: 'Coaching Yourself', page: 'coaching-yourself.html', icon: 'compass', prev: 'coaching-team', next: 'action-plan' },
             { id: 'action-plan', name: 'Action Plan', page: 'action-plan.html', icon: 'clipboard', prev: 'coaching-yourself', next: 'assessment' },
             { id: 'assessment', name: 'Leadership Quiz', page: 'ass.html', icon: 'check-circle', prev: 'action-plan', next: 'final_assessment', assessmentId: 'quiz_lc_main' }, // quiz_lc_main marks this complete
             { id: 'final_assessment', name: 'Final Assessment', page: 'final_ass.html', icon: 'award', prev: 'assessment', next: 'feedback', assessmentId: 'final_assessment_lc' }, // final_assessment_lc marks this complete
             { id: 'feedback', name: 'Course Feedback', page: 'feedback.html', icon: 'message-square', prev: 'final_assessment' }
         ];


        // --- DOM Elements ---
        let userNameDisplay, userEmailDisplay, mainContainer, adminDashboardSection,
            adminRestrictionMsg, usersTableBody, assessmentsTableBody, feedbackTableBody,
            progressDetailsTableBody, statusChartCanvas, scoreChartCanvas,
            adminLoadingIndicator, adminDataContainer, applyAdminFiltersBtn, userFilter, sectionFilter, /* Removed statusFilter, typeFilter, searchFilter */
            feedbackQuestionFilter, exportCsvBtn, assessmentsPaginationContainer, feedbackPaginationContainer, // Separate pagination
            detailsModal, modalBody, modalTitle;

        // --- Chart Instances ---
        let statusChartInstance = null;
        let scoreChartInstance = null;

        // --- State ---
        let currentUser = null;
        let isAdmin = false;
        let allUsersData = []; // For Users Overview table
        let allAssessmentsData = []; // Raw assessment data for admin
        let allFeedbackData = []; // Raw feedback data for admin
        let allProgressData = {}; // Cache for user progress details { userId: { sectionId: [answers] } }
        let currentFeedbackPage = 1;
        let currentAssessmentPage = 1;
        const rowsPerPage = 10;

        // Initialize Supabase
        try {
            if (window.supabase && window.supabase.createClient) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log("Supabase client initialized on Dashboard.");
            } else { throw new Error("Supabase library not found."); }
        } catch (error) { console.error("Supabase init error:", error); }

        // --- Immediate Redirection Check ---
         console.log("%cDashboard: Immediate redirection check...", "color: purple;");
         function quickCheckCurrentUser() { const d=localStorage.getItem(CURRENT_USER_KEY); try { return d && JSON.parse(d).id; } catch { return false; } }
         if (!(localStorage.getItem(LOGGED_IN_KEY)==='true' && quickCheckCurrentUser())) {
             const target = localStorage.getItem('hasSignedUpBefore')==='true' ? 'login.html' : 'signup.html';
             console.error(`%cDashboard Redirect: Not logged in. To ${target}...`, "color: orange;");
             window.location.replace(target); throw new Error("Redirect: Not logged in.");
         } else { console.log("%cDashboard: User logged in. Proceeding.", "color: green;"); }
         // --- End Redirection Check ---

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("%cDashboard: DOMContentLoaded.", "color: green;");
            if (!supabase) { handleFatalError('Database connection failed.'); return; }

            try {
                assignDOMElements(); // Assign DOM elements first
                feather.replace(); // Initialize Feather icons

                currentUser = getCurrentUser();
                if (!currentUser?.id || !currentUser?.email) { logout(); return; } // Failsafe

                isAdmin = await fetchAdminStatus(currentUser.id); // Fetch admin status
                console.log(`User: ${currentUser.email}, Fetched is_admin status: ${isAdmin}`);

                displayUserInfo(currentUser); // Display user info
                mainContainer.style.display = 'block'; // Show main container

                // Always initialize user modules first
                await initializeUserModules();

                // Initialize admin section only if user is admin
                if (isAdmin) {
                    await initializeAdminDashboard();
                } else {
                     adminDashboardSection.style.display = 'none';
                     adminRestrictionMsg.style.display = 'flex'; // Show restriction message
                     feather.replace({'stroke-width': 2, width: 20, height: 20}); // Ensure icon in message renders
                }

                setupEventListeners(); // Setup listeners after initial load
                console.log("Dashboard initialized.");

            } catch (error) {
                 console.error("Dashboard Init CRITICAL ERROR:", error);
                 handleFatalError(`Dashboard loading failed: ${error.message}`);
            }
        });

         function assignDOMElements() {
             mainContainer = document.getElementById('mainContainer');
             userNameDisplay = document.getElementById('userName');
             userEmailDisplay = document.getElementById('userEmail');
             adminDashboardSection = document.getElementById('adminDashboard');
             adminRestrictionMsg = document.getElementById('adminRestrictionMsg');
             // Admin Table Bodies
             usersTableBody = document.getElementById('usersTableBody');
             assessmentsTableBody = document.getElementById('assessmentsTableBody');
             feedbackTableBody = document.getElementById('feedbackTableBody');
             progressDetailsTableBody = document.getElementById('progressDetailsTableBody');
             // Charts (Keep references even if charts are optional)
             statusChartCanvas = document.getElementById('statusChart');
             scoreChartCanvas = document.getElementById('scoreChart');
             // Indicators and Containers
             adminLoadingIndicator = document.getElementById('adminLoadingIndicator');
             adminDataContainer = document.getElementById('adminDataContainer');
             // Filters and Buttons
             applyAdminFiltersBtn = document.getElementById('applyAdminFiltersBtn');
             userFilter = document.getElementById('userFilter');
             sectionFilter = document.getElementById('sectionFilter');
             feedbackQuestionFilter = document.getElementById('feedbackQuestionFilter');
             exportCsvBtn = document.getElementById('exportCsvBtn');
             // Pagination Containers
             assessmentsPaginationContainer = document.getElementById('assessmentsPaginationContainer'); // Ensure this ID exists in HTML
             feedbackPaginationContainer = document.getElementById('feedbackPaginationContainer'); // Ensure this ID exists in HTML
             // Modal Elements
             detailsModal = document.getElementById('detailsModal');
             modalBody = document.getElementById('modalBody');
             modalTitle = document.getElementById('modalTitle');

             // Basic check
             if (!mainContainer || !userNameDisplay || !adminDashboardSection || !exportCsvBtn || !detailsModal || !usersTableBody || !assessmentsTableBody || !feedbackTableBody) {
                 throw new Error("Essential dashboard DOM elements missing!");
             }
         }

         function setupEventListeners() {
             if (applyAdminFiltersBtn) applyAdminFiltersBtn.addEventListener('click', applyAdminFilters);
             if (exportCsvBtn) exportCsvBtn.addEventListener('click', handleExportCsv);
             // Event delegation for details buttons
             if (assessmentsTableBody) assessmentsTableBody.addEventListener('click', handleTableClicks);
             if (progressDetailsTableBody) progressDetailsTableBody.addEventListener('click', handleTableClicks); // Allow details for progress too

             // Pagination listeners
             if (assessmentsPaginationContainer) assessmentsPaginationContainer.addEventListener('click', (e) => handlePaginationClicks(e, 'assessments'));
             if (feedbackPaginationContainer) feedbackPaginationContainer.addEventListener('click', (e) => handlePaginationClicks(e, 'feedback'));


             // Close modal events
              const closeButton = document.querySelector('.modal-close');
              if(closeButton) closeButton.addEventListener('click', closeDetailsModal);
              window.addEventListener('click', (event) => { if (event.target == detailsModal) closeDetailsModal(); });
              window.addEventListener('keydown', (event) => { if (event.key === 'Escape') closeDetailsModal(); });

              // Filter change listeners to potentially re-apply filters automatically or enable button
              if (userFilter) userFilter.addEventListener('change', applyAdminFilters);
              if (sectionFilter) sectionFilter.addEventListener('change', applyAdminFilters);
              if (feedbackQuestionFilter) feedbackQuestionFilter.addEventListener('change', applyAdminFilters);
         }

        // --- Main Initialization Functions ---
        async function initializeUserModules() {
             console.log("Initializing user modules...");
             try {
                 const progress = await fetchUserProgress(currentUser.id);
                 updateModuleCards(progress);
             } catch (error) {
                 console.error("Error initializing user modules:", error);
                 showDashboardError("Could not load your module progress.");
             }
         }

        async function initializeAdminDashboard() {
            if (!isAdmin) return; // Double check
            console.log("Initializing ADMIN dashboard...");
            adminDashboardSection.style.display = 'block';
            adminRestrictionMsg.style.display = 'none';
            adminLoadingIndicator.style.display = 'block';
            adminDataContainer.style.display = 'none';

            try {
                // Fetch all necessary data in parallel
                const [users, assessments, feedback] = await Promise.all([
                    fetchAllUsersData(),
                    fetchAllAssessments(), // Fetch assessment summaries
                    fetchAllFeedback() // Fetch feedback responses
                ]);

                allUsersData = users;
                allAssessmentsData = assessments;
                allFeedbackData = feedback;

                if (!users.length && !assessments.length && !feedback.length) {
                     adminLoadingIndicator.innerHTML = '<p>No data found in any section.</p>';
                     return; // Exit if no data at all
                }

                // Populate filters initially
                populateUserFilter(users);
                populateSectionFilter(); // Add based on known sections/assessments
                populateFeedbackQuestionFilter(feedback); // Populate based on fetched feedback

                // Initial render
                applyAdminFilters(); // Apply "all" filters initially

                adminLoadingIndicator.style.display = 'none';
                adminDataContainer.style.display = 'block';
                feather.replace(); // Redraw icons after content is added

            } catch (error) {
                console.error("Error initializing admin dashboard:", error);
                showDashboardError(`Failed to load admin data: ${error.message}`);
                adminLoadingIndicator.innerHTML = `<p style="color: var(--error-red);">Error loading admin data.</p>`;
            }
        }


         // --- Data Fetching Functions ---
         async function fetchAdminStatus(userId) { /* ... (Keep unchanged) ... */ if(!supabase||!userId)return!1;try{console.log(`%cFetching admin status for user ID: ${userId}`,"color: blue;");const{data:a,error:e,status:r}=await supabase.from("users").select("is_admin").eq("id",userId).single();return e&&406!==r?(console.error("Error fetching admin status:",e.message),!1):a?(console.log(`%cRaw is_admin value from DB: ${a.is_admin}`,"color: blue;"),!0===a.is_admin):(console.log(`%cNo user record found or is_admin not set for user ID: ${userId}. Assuming not admin.`,"color: orange;"),!1)}catch(a){return console.error("Exception during fetchAdminStatus:",a),!1}}

         async function fetchUserProgress(userId) { // Fetches progress percentages and completion status
             if (!supabase || !userId) return {};
             try {
                 const progressData = {};
                 // 1. Get section percentages from user profile (if stored there)
                  const user = getCurrentUser(); // Assumes progress is stored here now
                  if (user && user.progress) {
                      Object.assign(progressData, user.progress); // Copy progress percentages
                      console.log("Loaded progress from user object:", progressData);
                  } else {
                       console.warn("No progress data found in user object.");
                  }

                 // 2. Get Assessment completion status from 'users' table
                 const { data: userData, error: userError } = await supabase
                     .from('users')
                     .select('assessment_completed, final_assessment_completed')
                     .eq('id', userId)
                     .single();

                 if (userError && userError.code !== 'PGRST116') throw userError;

                 if (userData) {
                      if (userData.assessment_completed) progressData['assessment'] = 'completed'; // Use module ID 'assessment'
                      if (userData.final_assessment_completed) progressData['final_assessment'] = 'completed'; // Use module ID 'final_assessment'
                 }

                  // 3. Get Feedback completion status (check if any feedback submitted for this user)
                   const { data: feedbackData, error: feedbackError } = await supabase
                     .from('feedback_responses')
                     .select('id', { count: 'exact', head: true }) // Just check if count > 0
                     .eq('user_id', userId);

                   if (feedbackError) console.error("Error checking feedback submissions:", feedbackError); // Log but don't throw
                   else if (feedbackData && feedbackData.count > 0) {
                       progressData['feedback'] = 'completed'; // Mark feedback as completed if any row exists
                   }


                 console.log("Combined User Progress Map:", progressData);
                 return progressData;
             } catch (error) { console.error("Error fetchUserProgress:", error); showDashboardError(error.message); return {}; }
         }

         async function fetchAllUsersData() { // Fetches data for admin users table
             if (!supabase) return [];
             try {
                 const { data, error } = await supabase
                     .from('users')
                     .select('id, name, email, created_at, assessment_completed, final_assessment_completed') // Select necessary columns
                     .order('created_at', { ascending: false });
                 if (error) throw error;
                 // Add feedback status check here
                 const feedbackUsers = await fetchUsersWhoGaveFeedback();
                 const usersWithFeedback = data.map(user => ({
                     ...user,
                     feedback_submitted: feedbackUsers.has(user.id) // Add boolean flag
                 }));

                 console.log(`Fetched ${usersWithFeedback?.length || 0} user records.`);
                 return usersWithFeedback || [];
             } catch (error) { console.error("Error fetchAllUsersData:", error); showDashboardError(error.message); return []; }
         }

         async function fetchUsersWhoGaveFeedback() { // Helper to get IDs of users who submitted feedback
            const userIds = new Set();
            if (!supabase) return userIds;
            try {
                const { data, error } = await supabase
                    .from('feedback_responses')
                    .select('user_id');
                if (error) throw error;
                if (data) data.forEach(item => userIds.add(item.user_id));
            } catch (error) { console.error("Error fetching feedback user IDs:", error); }
            return userIds;
         }


         async function fetchAllAssessments() { // Fetches data for admin assessments table
             if (!supabase) return [];
             try {
                 // Fetch from assessments table
                 const { data, error } = await supabase
                     .from('assessments')
                     .select('user_id, name, user_email, question_id, question_text, score, is_correct, completion_status, submitted_at')
                     .order('submitted_at', { ascending: false });
                 if (error) throw error;
                 console.log(`Fetched ${data?.length || 0} assessment records.`);
                 return data || [];
             } catch (error) { console.error("Error fetchAllAssessments:", error); showDashboardError(error.message); return []; }
         }

          async function fetchAllFeedback() { // Fetches data for admin feedback table
             if (!supabase) return [];
             try {
                 const { data, error } = await supabase
                     .from('feedback_responses')
                     .select('user_id, email, question, answer, submitted_at')
                     .order('submitted_at', { ascending: false });
                 if (error) throw error;
                 console.log(`Fetched ${data?.length || 0} feedback records.`);
                 return data || [];
             } catch (error) { console.error("Error fetchAllFeedback:", error); showDashboardError(error.message); return []; }
         }

        async function fetchProgressDetails(userId, sectionId) { // Fetches specific answers for modal
            if (!supabase || !userId || !sectionId) return [];
             try {
                 console.log(`Fetching progress details for User: ${userId}, Section: ${sectionId}`);
                 const { data, error } = await supabase
                     .from('user_progress')
                     .select('question_text, answer')
                     .eq('user_id', userId)
                     .eq('section_id', sectionId) // Use section_id from user_progress
                     .order('submitted_at', { ascending: true }); // Order answers consistently
                 if (error) throw error;
                 console.log("Fetched progress details:", data);
                 return data || [];
            } catch (error) {
                console.error("Error fetching progress details:", error);
                showDashboardError(`Could not load details: ${error.message}`);
                return [];
            }
        }


        // --- UI Update Functions ---
        function updateModuleCards(progressData) {
            const moduleGrid = document.getElementById('courseModules')?.querySelector('.modules-grid');
             const nextStepsGrid = document.getElementById('whatsNext')?.querySelector('.modules-grid');
             if (!moduleGrid || !nextStepsGrid) return; // Exit if grids not found

             // Clear existing cards before regenerating (optional, can also update in place)
             // moduleGrid.innerHTML = '';
             // nextStepsGrid.innerHTML = '';

             let previousModuleCompleteOrAttempted = true; // Intro is always accessible

             modules.forEach(module => {
                 const cardId = `module-${module.id}`;
                 const cardElement = document.getElementById(cardId); // Find existing card
                 if (!cardElement) { console.warn(`Card element not found for module: ${module.id}`); return; } // Skip if card not in HTML

                 const statusBadge = cardElement.querySelector('.status-badge');
                 const actionButton = cardElement.querySelector('.module-action-button');
                 const cardIcon = cardElement.querySelector('h4 i');

                  // Determine status based on progressData
                 let status = 'Not Started';
                 let isCompleted = false;
                 if (module.id === 'introduction') { // Special check for intro based on goal submission
                     if (localStorage.getItem(MODULE_IDS.INTRO + '_goal_q1_completed') === 'true') { // Check specific local storage flag
                           status = 'Completed';
                           isCompleted = true;
                     }
                  } else if (progressData[module.assessmentId]) { // Check assessments table status first
                       status = progressData[module.assessmentId]; // e.g., 'passed', 'failed'
                       isCompleted = (status === 'completed' || status === 'passed');
                  } else if (progressData[module.id] !== undefined) { // Check progress percentage from user object
                      const percentage = progressData[module.id];
                      if (percentage >= 100) { status = 'Completed'; isCompleted = true; }
                      else if (percentage > 0) { status = 'In Progress'; }
                  }


                  // Update Status Badge
                 if (statusBadge) {
                     statusBadge.textContent = status.replace(/[-_]/g, ' ');
                     statusBadge.className = 'status-badge'; // Reset
                     if (isCompleted) statusBadge.classList.add('completed');
                     else if (status === 'In Progress') statusBadge.classList.add('in-progress');
                     else statusBadge.classList.add('not-started');
                 }

                 // Apply Locking Logic
                 let allowAccess = isAdmin || previousModuleCompleteOrAttempted;

                 if (allowAccess) {
                     cardElement.classList.remove('locked');
                     if (actionButton) {
                         actionButton.disabled = false;
                         actionButton.href = module.page; // Set the correct link
                         if (isCompleted) { actionButton.innerHTML = `<i data-feather="eye"></i><span>View Module</span>`; if (cardIcon) cardIcon.setAttribute('data-feather', 'check-square'); }
                         else { actionButton.innerHTML = `<i data-feather="arrow-right-circle"></i><span>${status === 'In Progress' ? 'Continue' : 'Start'} Module</span>`; if (cardIcon) cardIcon.setAttribute('data-feather', 'play-circle'); }
                     }
                 } else {
                     cardElement.classList.add('locked');
                     if (actionButton) {
                         actionButton.disabled = true; actionButton.removeAttribute('href');
                         actionButton.innerHTML = `<i data-feather="lock"></i><span>Locked</span>`; if (cardIcon) cardIcon.setAttribute('data-feather', 'lock');
                     }
                 }

                 // Update condition for the next module
                 previousModuleCompleteOrAttempted = isCompleted || (status === 'failed'); // Unlock next if completed/passed or failed

             });
             feather.replace(); // Redraw icons
             console.log("Module cards updated.");
        }


        // --- Admin Section Functions ---

        function applyAdminFilters() { // Renamed for clarity
             if (!isAdmin) return;
             renderFilteredAdminData(); // Call the main rendering function
         }

        async function renderFilteredAdminData() {
             if (!isAdmin) return;
             adminLoadingIndicator.style.display = 'block';
             adminDataContainer.style.display = 'none';

             try {
                 // --- 1. Filter Users Table ---
                 const userSearchValue = userFilter.value; // Assuming userFilter is the SELECT dropdown ID
                 const filteredUsers = allUsersData.filter(user => {
                     return userSearchValue === 'all' || user.id === userSearchValue;
                 });
                 populateUsersTable(filteredUsers); // Populate users table

                 // --- 2. Filter Assessments Table ---
                  const assessmentSearchValue = userFilter.value; // Use the same user filter
                  const assessmentTypeValue = sectionFilter.value; // Use section filter for assessment type
                 const filteredAssessments = allAssessmentsData.filter(item => {
                      const userMatch = assessmentSearchValue === 'all' || item.user_id === assessmentSearchValue;
                      const typeMatch = assessmentTypeValue === 'all' || item.question_id === assessmentTypeValue; // question_id in assessments holds QUIZ_ID
                      return userMatch && typeMatch;
                  });
                 // Paginate and populate assessments table
                 const assessmentStartIndex = (currentAssessmentPage - 1) * rowsPerPage;
                 const assessmentEndIndex = assessmentStartIndex + rowsPerPage;
                 populateAssessmentsTable(filteredAssessments.slice(assessmentStartIndex, assessmentEndIndex));
                 renderPaginationControls(filteredAssessments.length, currentAssessmentPage, assessmentsPaginationContainer, 'assessments');

                 // --- 3. Filter Feedback Table ---
                 const feedbackUserValue = userFilter.value;
                  const feedbackQuestionValue = feedbackQuestionFilter.value;
                 const filteredFeedback = allFeedbackData.filter(item => {
                      const userMatch = feedbackUserValue === 'all' || item.user_id === feedbackUserValue;
                      const questionMatch = feedbackQuestionValue === 'all' || item.question === feedbackQuestionValue;
                      return userMatch && questionMatch;
                 });
                  // Paginate and populate feedback table
                  const feedbackStartIndex = (currentFeedbackPage - 1) * rowsPerPage;
                  const feedbackEndIndex = feedbackStartIndex + rowsPerPage;
                  populateFeedbackTable(filteredFeedback.slice(feedbackStartIndex, feedbackEndIndex));
                  renderPaginationControls(filteredFeedback.length, currentFeedbackPage, feedbackPaginationContainer, 'feedback');

                 // --- 4. Fetch and Display Progress Details (If User and Section Selected) ---
                 if (userFilter.value !== 'all' && sectionFilter.value !== 'all') {
                     const progressDetails = await fetchProgressDetails(userFilter.value, sectionFilter.value);
                     populateProgressDetailsTable(progressDetails);
                 } else {
                      if(progressDetailsTableBody) progressDetailsTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Select a specific user and section to view details.</td></tr>';
                 }


                 // --- 5. Render Charts (Optional) ---
                 // renderCharts(filteredAssessments); // Pass filtered assessment data to charts

                 adminLoadingIndicator.style.display = 'none';
                 adminDataContainer.style.display = 'block';
                 feather.replace();

             } catch (error) {
                 console.error("Error applying admin filters:", error);
                 showDashboardError("Failed to filter or display admin data.");
                 adminLoadingIndicator.style.display = 'none';
                 adminDataContainer.style.display = 'block'; // Show container to display potential error message in tables
                  if(usersTableBody) usersTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; color: var(--error-red);">Error loading user data.</td></tr>';
                  if(assessmentsTableBody) assessmentsTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; color: var(--error-red);">Error loading assessment data.</td></tr>';
                  if(feedbackTableBody) feedbackTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; color: var(--error-red);">Error loading feedback data.</td></tr>';
                  if(progressDetailsTableBody) progressDetailsTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; color: var(--error-red);">Error loading progress details.</td></tr>';
             }
         }

         // --- Populate Admin Tables ---
        function populateUsersTable(users) {
             if (!usersTableBody) return;
             usersTableBody.innerHTML = '';
             if (!users || users.length === 0) { usersTableBody.innerHTML = '<tr><td colspan="6">No users found.</td></tr>'; return; }
             users.forEach(user => {
                 const row = usersTableBody.insertRow();
                 row.innerHTML = `
                     <td>${user.name || 'N/A'}</td>
                     <td>${user.email || 'N/A'}</td>
                     <td>${user.created_at ? new Date(user.created_at).toLocaleDateString() : 'N/A'}</td>
                     <td><span class="admin-status-badge ${user.assessment_completed ? 'completed' : 'not-started'}">${user.assessment_completed ? 'Yes' : 'No'}</span></td>
                     <td><span class="admin-status-badge ${user.final_assessment_completed ? 'completed' : 'not-started'}">${user.final_assessment_completed ? 'Yes' : 'No'}</span></td>
                      <td><span class="admin-status-badge ${user.feedback_submitted ? 'completed' : 'not-started'}">${user.feedback_submitted ? 'Yes' : 'No'}</span></td>
                 `;
             });
              feather.replace();
        }

        function populateAssessmentsTable(assessments) {
             if (!assessmentsTableBody) return;
             assessmentsTableBody.innerHTML = '';
             if (!assessments || assessments.length === 0) { assessmentsTableBody.innerHTML = '<tr><td colspan="7">No assessment submissions found.</td></tr>'; return; }
             assessments.forEach(item => {
                  let displayStatus = item.is_correct || item.completion_status || 'N/A';
                  let statusClass = displayStatus.toLowerCase().replace(/[\s_]+/g, '-');
                  if (statusClass === 'needs-support') statusClass = 'failed'; // Group for styling

                 const row = assessmentsTableBody.insertRow();
                 row.innerHTML = `
                     <td>${item.name || item.user_email || 'N/A'}</td>
                     <td>${item.question_text || item.question_id || 'N/A'}</td>
                     <td><span class="admin-status-badge ${statusClass}">${displayStatus.replace(/[-_]/g, ' ')}</span></td>
                     <td>${item.score ?? 'N/A'}</td>
                     <td>${item.submitted_at ? new Date(item.submitted_at).toLocaleDateString() : 'N/A'}</td>
                     <td>
                          <button class="view-details-btn" data-userid="${item.user_id}" data-assessmentid="${item.question_id}" data-username="${item.name || item.user_email}" title="View Details">
                              <i data-feather="eye"></i>
                          </button>
                     </td>
                 `;
             });
              feather.replace();
        }

        function populateFeedbackTable(feedback) {
             if (!feedbackTableBody) return;
             feedbackTableBody.innerHTML = '';
             if (!feedback || feedback.length === 0) { feedbackTableBody.innerHTML = '<tr><td colspan="4">No feedback found.</td></tr>'; return; }
             feedback.forEach(item => {
                 const row = feedbackTableBody.insertRow();
                 row.innerHTML = `
                      <td>${item.email || 'N/A'}</td>
                      <td>${item.question || 'N/A'}</td>
                      <td>${item.answer || 'N/A'}</td>
                      <td>${item.submitted_at ? new Date(item.submitted_at).toLocaleString() : 'N/A'}</td>
                  `;
             });
              feather.replace(); // Ensure icons render if any are added later
        }

        function populateProgressDetailsTable(details) {
            if (!progressDetailsTableBody) return;
            progressDetailsTableBody.innerHTML = '';
            if (!details || details.length === 0) {
                 progressDetailsTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No progress details found for this selection.</td></tr>';
                 return;
             }
             details.forEach(item => {
                 const row = progressDetailsTableBody.insertRow();
                  // Assuming 'user_progress' has user email or name might need a join, using user email from currentUser for now if needed
                 const userName = currentUser?.name || currentUser?.email || 'N/A';
                 row.innerHTML = `
                     <td>${userName}</td>
                     <td>${item.question_text || 'N/A'}</td>
                     <td>${item.answer || 'N/A'}</td>
                 `;
             });
        }

        // --- Populate Filter Functions ---
        function populateUserFilter(users) {
             if (!userFilter) return;
             userFilter.innerHTML = '<option value="all">All Users</option>'; // Reset
             const uniqueUsers = [...new Map(users.map(user => [user.id, user])).values()]; // Ensure unique users
             uniqueUsers.sort((a,b) => (a.name || a.email).localeCompare(b.name || b.email)); // Sort by name/email
             uniqueUsers.forEach(user => {
                 const option = document.createElement('option');
                 option.value = user.id;
                 option.textContent = `${user.name} (${user.email})`;
                 userFilter.appendChild(option);
             });
        }
        function populateSectionFilter() {
             if (!sectionFilter) return;
             sectionFilter.innerHTML = '<option value="all">All Sections</option>';
             // Add options based on your MODULE_IDS or specific assessment/feedback IDs
             sectionFilter.appendChild(new Option('Introduction Goal', 'intro_goal_q1')); // From index.html
             sectionFilter.appendChild(new Option('Leadership Quiz', 'quiz_lc_main')); // From ass.html
             sectionFilter.appendChild(new Option('Final Assessment', 'final_assessment_lc')); // From final_ass.html
             // Add options for other sections if you want to view their user_progress data
             modules.forEach(module => {
                  // Add article sections if needed, skip assessments already added
                 if (module.id !== 'introduction' && module.id !== 'assessment' && module.id !== 'final_assessment' && module.id !== 'feedback') {
                      sectionFilter.appendChild(new Option(module.name, module.id)); // Use module.id as section_id
                 }
             });
        }
         function populateFeedbackQuestionFilter(feedbackData) {
             if (!feedbackQuestionFilter) return;
             feedbackQuestionFilter.innerHTML = '<option value="all">All Feedback Questions</option>';
             const uniqueQuestions = [...new Set(feedbackData.map(item => item.question))];
             uniqueQuestions.sort();
             uniqueQuestions.forEach(question => {
                 const option = document.createElement('option');
                 option.value = question;
                 option.textContent = question.length > 50 ? question.substring(0, 50) + '...' : question; // Truncate long questions
                 feedbackQuestionFilter.appendChild(option);
             });
         }


         // --- Pagination ---
         function renderPaginationControls(totalItems, currentPageNum, container, type) {
             if (!container) return;
             container.innerHTML = ''; // Clear previous controls
             const totalPages = Math.ceil(totalItems / rowsPerPage);

             if (totalPages <= 1) return; // No pagination needed for 1 page or less

             // Previous Button
             const prevButton = document.createElement('button');
             prevButton.innerHTML = '« Prev';
             prevButton.classList.add('pagination-button');
             prevButton.disabled = currentPageNum === 1;
             prevButton.dataset.page = currentPageNum - 1;
             prevButton.dataset.type = type; // Add type identifier
             container.appendChild(prevButton);

             // Page Info
             const pageInfo = document.createElement('span');
             pageInfo.classList.add('pagination-info');
             pageInfo.textContent = `Page ${currentPageNum} of ${totalPages}`;
             container.appendChild(pageInfo);

             // Next Button
             const nextButton = document.createElement('button');
             nextButton.innerHTML = 'Next »';
             nextButton.classList.add('pagination-button');
             nextButton.disabled = currentPageNum === totalPages;
             nextButton.dataset.page = currentPageNum + 1;
              nextButton.dataset.type = type; // Add type identifier
             container.appendChild(nextButton);
         }

        function handlePaginationClicks(event, tableType) {
              const targetButton = event.target.closest('.pagination-button');
              if (targetButton && !targetButton.disabled) {
                   const targetPage = parseInt(targetButton.dataset.page, 10);
                   if (targetPage) {
                       if (tableType === 'assessments') {
                           currentAssessmentPage = targetPage;
                       } else if (tableType === 'feedback') {
                           currentFeedbackPage = targetPage;
                       }
                       renderFilteredAdminData(); // Re-render tables with new page
                   }
              }
          }

        // --- Modal Functions ---
         async function openDetailsModal(userId, assessmentId, userName) {
              if (!detailsModal || !modalBody || !modalTitle) return;
               const assessmentText = document.querySelector(`#assessmentsTableBody button[data-assessmentid="${assessmentId}"]`)?.closest('tr')?.cells[2]?.textContent || assessmentId;
               modalTitle.textContent = `Details for ${userName || 'User'} - ${assessmentText}`;
               modalBody.innerHTML = '<p class="loading-indicator">Loading details...</p>';
               detailsModal.style.display = "block"; // Use block instead of flex for modal

               // --- MODIFIED: Fetch details based on type ---
               let details = [];
               if (assessmentId === 'intro_goal_q1') {
                    // Fetch the single intro goal answer
                     details = await fetchProgressDetails(userId, 'introduction'); // Fetch using section_id 'introduction'
               } else if (assessmentId === 'quiz_lc_main' || assessmentId === 'final_assessment_lc') {
                    // Fetch all answers for the assessment using assessmentId as section_id
                    details = await fetchProgressDetails(userId, assessmentId);
               } else {
                    // Potentially handle other section details if needed
                    details = await fetchProgressDetails(userId, assessmentId); // Default: try fetching using the assessmentId as section_id
               }
               // --- END MODIFICATION ---


               if (details === null) {
                   modalBody.innerHTML = '<p style="color: var(--error-red);">Could not load details.</p>';
               } else if (details.length === 0) {
                    // Specific message for intro goal if expected but not found
                    if (assessmentId === 'intro_goal_q1') {
                         modalBody.innerHTML = '<p>No introductory goal answer found in progress records.</p>';
                    } else {
                         modalBody.innerHTML = '<p>No detailed answers found for this submission.</p>';
                    }
               } else {
                   let detailsHtml = '';
                   details.forEach((item, index) => {
                       let answerDisplay = item.answer || 'N/A';
                        // Format answer for display (e.g., line breaks)
                       answerDisplay = String(answerDisplay).replace(/\n/g, '<br>');

                        let correctnessClass = '';
                        if (item.is_passed === true) correctnessClass = 'correct';
                        if (item.is_passed === false) correctnessClass = 'incorrect';

                        detailsHtml += `
                           <div class="detail-item">
                               <strong>${index + 1}. ${item.question_text || 'Question'}</strong>
                               <span class="${correctnessClass}">${answerDisplay}</span>
                               ${item.score !== null ? `<span style='font-size:0.8em; color: var(--text-light);'> (Score: ${item.score})</span>` : ''}
                           </div>
                       `;
                   });
                   modalBody.innerHTML = detailsHtml;
               }
         }
         function closeDetailsModal() { if (detailsModal) detailsModal.style.display = "none"; if (modalBody) modalBody.innerHTML = ''; }


        // --- Export CSV Function ---
        function handleExportCsv() {
             console.log("Exporting CSV...");
             // Decide which table's data to export (e.g., assessments or feedback based on context/button)
             // For simplicity, let's export the currently filtered Assessments data
             if (!filteredAdminData || filteredAdminData.length === 0) { alert("No data to export."); return; }
              exportDataToCSV(`assessments_export_${new Date().toISOString().slice(0,10)}.csv`, filteredAdminData);
         }
        function exportDataToCSV(filename, dataToExport) { /* ... (Keep unchanged) ... */ if(!dataToExport||dataToExport.length===0){alert("No data available to export.");return;}const csv=[];const headers=["User Name","Email","Assessment","Status","Score","Submitted At"];csv.push(headers.join(','));dataToExport.forEach(item=>{const row=[`"${(item.name||'N/A').replace(/"/g,'""')}"`,`"${(item.user_email||'N/A').replace(/"/g,'""')}"`,`"${(item.question_text||item.question_id||'N/A').replace(/"/g,'""')}"`,`"${(item.is_correct||item.completion_status||'N/A').replace(/"/g,'""')}"`,item.score??'N/A',`"${(item.submitted_at?new Date(item.submitted_at).toISOString():'N/A').replace(/"/g,'""')}"`];csv.push(row.join(','));});const csvContent=csv.join('\n');const blob=new Blob([csvContent],{type:'text/csv;charset=utf-8;'});const link=document.createElement("a");if(link.download!==undefined){const url=URL.createObjectURL(blob);link.setAttribute("href",url);link.setAttribute("download",filename);link.style.visibility='hidden';document.body.appendChild(link);link.click();document.body.removeChild(link);URL.revokeObjectURL(url);}else{alert("CSV export is not supported in your browser.");}}

        // --- Utility Functions ---
        function showDashboardError(message) { console.error("Dashboard Error:", message); /* Optionally display user-facing error */ }
        function handleFatalError(message) { console.error("FATAL ERROR:", message); if(mainContainer) mainContainer.innerHTML = `<p style="color:red; text-align:center; padding: 2rem;">${message}</p>`; else document.body.innerHTML = `<p style="color: red; padding: 20px;">${message}</p>`; if(mainContainer) mainContainer.style.display = 'block'; }

    </script>
</body>
</html>
