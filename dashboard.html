بالتأكيد، فهمت طلبك تمامًا. تريد أن يتم عرض كل الرسوم البيانية (Charts) في صف واحد بجانب بعضها البعض لاستغلال المساحة الفارغة بشكل أفضل بدلاً من ظهورها في صفوف متعددة.

لقد قمت بتعديل كود الـ CSS المسؤول عن تنظيم الرسوم البيانية. التغيير الذي قمت به يضمن أن الحاوية الرئيسية للرسوم البيانية (.charts-row) تقوم بإنشاء 5 أعمدة متساوية في العرض، مما يجبر كل الرسوم الخمسة على البقاء في صف واحد وتوزيع المساحة بينهم بالتساوي.

التعديل الذي تم:
تم تغيير خاصية grid-template-columns في الـ CSS من القيمة repeat(auto-fit, minmax(340px, 1fr)) التي تسمح بانتقال العناصر لصف جديد، إلى القيمة repeat(5, 1fr) التي تجبر العناصر على البقاء في صف واحد مقسم إلى 5 أعمدة.

إليك الملف كاملاً بعد تطبيق هذا التعديل. يمكنك نسخه واستخدامه مباشرة.

code
Html
play_circle
download
content_copy
expand_less
<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Elevo Core</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2317a2b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M3 12h18M3 6h12M3 18h15'/><path d='M17 9l4 3l-4 3'/></svg>">
    <link rel="stylesheet" href="style.css"> 
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            /* This theme is now primarily controlled by style.css */
        }
        
        .dashboard-body { display: grid; grid-template-columns: 3fr 2fr; gap: 2rem; align-items: flex-start; }
        .main-column { display: flex; flex-direction: column; gap: 2rem; }
        .sidebar-column { display: flex; flex-direction: column; gap: 2rem; position: sticky; top: 100px; }
        
        @media (max-width: 1200px) { .dashboard-body { grid-template-columns: 1fr; } .sidebar-column { position: static; } }
        
        .live-calls-list { max-height: 250px; overflow-y: auto; padding-right: 0.5rem; }
        .live-call-item { background-color: var(--input-bg-color); padding: 0.75rem 1rem; border-radius: var(--border-radius-md); margin-bottom: 0.75rem; border: 1px solid var(--border-color); font-size: 0.9rem; border-left: 4px solid var(--accent-color); transition: background-color 0.3s ease; }
        .live-call-item-agent { font-weight: 600; color: var(--primary-color); }
        
        .live-indicator {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .live-indicator::before, .live-indicator::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            background-color: var(--success-color);
            animation-name: live-pulse;
            animation-duration: 2s;
            animation-timing-function: ease-out;
            animation-iteration-count: infinite;
        }
        .live-indicator::before { width: 8px; height: 8px; }
        .live-indicator::after { animation-delay: -1s; }
        @keyframes live-pulse {
            0% { width: 8px; height: 8px; opacity: 1; }
            100% { width: 24px; height: 24px; opacity: 0; }
        }

        /* --- MODIFICATION START: Final adjustments for Stat Cards and Chart Layout --- */
        
        /* Stat Cards: Adjust overall box size and internal font sizes */
        .stats-grid .stat-card {
            padding: 1rem 1.25rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 150px; /* Reduced height for a more compact look */
        }
        .stats-grid .stat-card-content p {
            font-size: 2.25rem; /* Main number size */
        }
        
        /* Internal elements of the first card - slightly bigger for readability */
        .kpi .label {
            font-size: 0.8rem !important;
        }
        .kpi .value {
            font-size: 0.9rem !important;
        }
        .top-agents-box h3 {
            font-size: 0.85rem !important;
        }
        .top-agents-list li {
            font-size: 0.8rem;
        }

        /* Charts: Give them enough space and prevent text clipping */
        .analytics-section h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--text-color);
        }
        /* --- MODIFICATION FOR CHARTS ROW --- */
        .charts-row {
            display: grid;
            /* This creates 5 equal-width columns, forcing all charts onto a single row */
            grid-template-columns: repeat(5, 1fr);
            gap: 1.5rem;
        }

        .chart-container {
            background-color: var(--card-bg-color);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-color);
            min-height: 380px; /* Consistent height for better alignment */
            display: flex;
            flex-direction: column;
        }
        
        .chart-container canvas {
            width: 100% !important;
            height: 100% !important;
        }
        /* --- MODIFICATION END --- */
    </style>
</head>
<body>
    <div id="accessDeniedModal" style="display: none;">
         <div class="access-denied-content">
             <svg xmlns="http://www.w3.org/2000/svg" width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
             <h3>Access Denied</h3><p>You do not have permission to view this page. This section is restricted to administrators.</p><button id="returnToAppBtn" class="action-button primary-button">Return to Agent App</button>
         </div>
    </div>

    <div class="app-container" id="appContainerContent" style="display: none;">
        <header class="app-header">
            <div class="logo-container"><svg class="company-logo" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 17L10 17M6 12L12 12M6 7L14 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M15 6L19 10L15 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><rect x="3" y="3" width="18" height="18" rx="3" stroke="currentColor" stroke-width="1.5" fill="transparent" opacity="0.6"/></svg><span class="app-title">Admin Dashboard - Elevo Core</span></div>
            <div class="header-controls">
                <a href="core-flow.html" class="nav-link">Core Flow</a>
                <a href="rtm-dashboard.html" class="nav-link" id="rtmDashboardLink" style="display: none;">RTM Dashboard</a>
                <a href="agent-portal.html" class="nav-link" id="agentPortalLink" style="display: none;">Agent Portal</a>
                <div class="user-info" id="userInfo" style="display: none;">
                    <span id="userNameDisplay" class="user-name-display"></span>
                    <button id="logoutButton" class="logout-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg><span>Logout</span></button>
                </div>
            </div>
        </header>

        <main class="app-main dashboard-main">
            <div id="authLoadingMessage" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 70vh;"><div class="spinner"></div><p>Verifying access and loading dashboard...</p></div>
            <div id="dashboardContent" style="display:none; flex-direction: column; gap: 2rem;">
                <div class="dashboard-header">
                    <div class="greeting-section"><div id="userAvatarCharacter" class="user-avatar-char-dashboard"></div><div><h1 id="dashboardUserGreeting">Welcome, Admin!</h1><p id="dashboardUserSubtext">Historical performance data and agent analytics.</p></div></div>
                </div>
                
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <div class="stat-card-content">
                            <div>
                                <h3>Total Tickets</h3>
                                <p id="totalCalls">0</p>
                                <span class="stat-period" id="statsPeriod"></span>
                            </div>
                        </div>
                        <div class="kpi-container" style="margin-top:0.8rem; display: flex; flex-direction:column; gap: 0.8rem;">
                          <div class="top-agents-box">
                            <h3 style="margin:0 0 0.4rem 0;">Top 5 Agents (Today)</h3>
                            <ul class="top-agents-list" id="topAgentsList">
                              <li>No data yet <span>—</span></li>
                            </ul>
                          </div>
                          <div class="quick-kpis" style="display:flex; justify-content:space-around; gap: 0.5rem; margin-top: 0.5rem;">
                            <div class="kpi"><div class="label">Fastest Ticket</div><div class="value" id="kpi-fastest">—</div></div>
                            <div class="kpi"><div class="label">Longest Ticket</div><div class="value" id="kpi-longest">—</div></div>
                            <div class="kpi"><div class="label">Top Scenario</div><div class="value" id="kpi-top-scenario">—</div></div>
                          </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-content"><h3>Avg. Time</h3><p id="avgCallDuration">0m 0s</p><span class="stat-period" id="statsPeriodDuration"></span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-content"><h3>Completion</h3><p id="completionRate">0%</p><span class="stat-period" id="statsPeriodCompletion"></span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-content"><h3>Quality Score</h3><div class="quality-gauge"><div class="gauge-bar-container"><div id="gaugeGood" class="gauge-segment good"></div><div id="gaugeNormal" class="gauge-segment normal"></div><div id="gaugeBad" class="gauge-segment bad"></div></div><span id="avgQualityText">N/A</span></div></div>
                    </div>
                </div>

                <div class="dashboard-body">
                    <div class="main-column">
                         <div class="filter-controls card" id="filterControlsCard">
                            <h3><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg> Filter Ticket Sessions</h3>
                            <div class="filter-grid">
                                <div><label for="userFilterDropdown">Agent:</label><select id="userFilterDropdown"><option value="">All Agents</option></select></div>
                                <div><label for="searchInput">Search:</label><input type="text" id="searchInput" placeholder="Scenario, Reason..."></div>
                                <div><label for="qualityFilter">Ticket Quality:</label><select id="qualityFilter"><option value="">All</option><option value="Good">Good</option><option value="Normal">Normal</option><option value="Bad">Bad</option><option value="N/A">N/A</option></select></div>
                                <div><label for="startDateFilter">Start Date:</label><input type="date" id="startDateFilter" title="Start date"></div>
                                <div><label for="endDateFilter">End Date:</label><input type="date" id="endDateFilter" title="End date"></div>
                                <div class="filter-buttons-group"><button id="resetFiltersBtn" class="action-button"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg><span>Reset</span></button></div>
                            </div>
                        </div>
                        <div class="recent-activity-section card">
                            <h2 id="recentCallsTitle">Recent Ticket Sessions</h2>
                            <div class="table-responsive"><table id="recentCallsTable"><thead><tr><th>Agent Name</th><th>Agent Email</th><th>Scenario</th><th>Start Time</th><th>Duration</th><th>Completed</th><th>Quality</th><th>Reason</th></tr></thead><tbody></tbody></table></div>
                            <div id="paginationControls" class="pagination-container" style="margin-top: 1rem;"></div>
                            <div class="export-buttons-container" style="margin-top: 1.5rem; display: flex; gap: 0.75rem; flex-wrap: wrap;"><button id="exportDataBtn" class="action-button secondary-button">Export (CSV)</button><button id="exportDataXLSXBtn" class="action-button primary-button">Export (XLSX)</button></div>
                        </div>
                         
                        <div class="analytics-section">
                            <h2>Analytics</h2>
                            <div class="charts-row">
                                <div class="chart-container"><canvas id="statusChart"></canvas></div>
                                <div class="chart-container"><canvas id="qualityScoreChart"></canvas></div>
                                <div class="chart-container"><canvas id="ticketVolumeChart"></canvas></div>
                                <div class="chart-container"><canvas id="badReasonsChart"></canvas></div>
                                <div class="chart-container"><canvas id="progressChart"></canvas></div>
                            </div>
                        </div>
                    </div>
                    <div class="sidebar-column">
                        <div id="liveCallsContainerWrapper" class="card">
                            <h2><div class="live-indicator"></div> Live Monitoring</h2>
                            <div id="liveCallsContainer" class="live-calls-list"><p id="noLiveCallsMessage" style="display:block;">No active tickets.</p></div>
                        </div>
                        <div id="delayedTicketsContainerWrapper" class="card">
                            <h2><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> Delayed Tickets</h2>
                            <div id="delayedTicketsContainer" class="live-calls-list"><p id="noDelayedTicketsMessage" style="display:block;">No delayed tickets.</p></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <footer class="app-footer"><p>© <span id="currentYear"></span> Mohamed Elmenisy - Elevo Core. All rights reserved.</p></footer>
    </div>

    <script type="module">
        // --- SUPABASE CLIENT SETUP ---
        const SUPABASE_URL = 'https://aefiigottnlcmjzilqnh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlZmlpZ290dG5sY21qemlscW5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNzY2MDQsImV4cCI6MjA2Mjc1MjYwNH0.FypB02v3tGMnxXV9ZmZMdMC0oQpREKOJWgHMPxUzwX4';
        
        let supabase;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (error) {
            console.error("Supabase client initialization failed:", error);
            const authLoading = document.getElementById('authLoadingMessage');
            if(authLoading) authLoading.innerHTML = '<p style="color:red; text-align:center;">Critical Error: Services unavailable. Dashboard cannot be loaded.</p>';
        }

        // --- DOM ELEMENT REFERENCES ---
        const appContainerContent = document.getElementById('appContainerContent');
        const authLoadingMessageDiv = document.getElementById('authLoadingMessage');
        const dashboardContentDiv = document.getElementById('dashboardContent');
        const accessDeniedModal = document.getElementById('accessDeniedModal');
        const returnToAppBtn = document.getElementById('returnToAppBtn');
        const userNameDisplayHeader = document.getElementById('userNameDisplay');
        const dashboardUserGreeting = document.getElementById('dashboardUserGreeting');
        const userAvatarCharEl = document.getElementById('userAvatarCharacter');
        const userInfoDivHeader = document.getElementById('userInfo');
        const logoutButton = document.getElementById('logoutButton');
        const rtmDashboardLink = document.getElementById('rtmDashboardLink');
        const agentPortalLink = document.getElementById('agentPortalLink');
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        const totalCallsEl = document.getElementById('totalCalls'), avgCallDurationEl = document.getElementById('avgCallDuration'),
              completionRateEl = document.getElementById('completionRate'), gaugeGoodEl = document.getElementById('gaugeGood'),
              gaugeNormalEl = document.getElementById('gaugeNormal'), gaugeBadEl = document.getElementById('gaugeBad'),
              avgQualityTextEl = document.getElementById('avgQualityText'), statsPeriodEl = document.getElementById('statsPeriod'),
              statsPeriodDurationEl = document.getElementById('statsPeriodDuration'), statsPeriodCompletionEl = document.getElementById('statsPeriodCompletion');
        const userFilterDropdown = document.getElementById('userFilterDropdown'), searchInput = document.getElementById('searchInput'),
              qualityFilter = document.getElementById('qualityFilter'), startDateFilter = document.getElementById('startDateFilter'),
              endDateFilter = document.getElementById('endDateFilter'), resetFiltersBtn = document.getElementById('resetFiltersBtn');
        const recentCallsTableBody = document.querySelector('#recentCallsTable tbody'), recentCallsTitleEl = document.getElementById('recentCallsTitle'),
              paginationControlsContainer = document.getElementById('paginationControls'), exportDataBtn = document.getElementById('exportDataBtn'),
              exportDataXLSXBtn = document.getElementById('exportDataXLSXBtn');
        const liveCallsContainer = document.getElementById('liveCallsContainer'), noLiveCallsMessage = document.getElementById('noLiveCallsMessage'),
              delayedTicketsContainer = document.getElementById('delayedTicketsContainer'), noDelayedTicketsMessage = document.getElementById('noDelayedTicketsMessage');

        // --- STATE AND CONFIGURATION ---
        let statusChart, ticketVolumeChart, qualityScoreChart, badReasonsChart, progressChart;
        let currentUser = null, allCallSessions = [], filteredCallSessions = [], allAgents = []; 
        let currentPage = 1, filterTimeoutId = null, liveCallsChannel = null;
        const ROWS_PER_PAGE = 7;
        const FILTER_STORAGE_KEY = 'elevoCoreAdminFilters_v3';
        const EGYPT_TIMEZONE = 'Africa/Cairo';

        // --- HELPER FUNCTIONS ---
        function pgIntervalToMs(interval) {
            if (!interval) return 0;
            if (typeof interval === 'number') return interval * 1000;
            let days = 0;
            const dayMatch = String(interval).match(/(\d+)\s+day/);
            if (dayMatch) days = parseInt(dayMatch[1], 10);
            const hmsMatch = String(interval).match(/(\d{1,2}):(\d{2}):(\d{2})$/);
            if (hmsMatch) {
                const h = parseInt(hmsMatch[1],10), m = parseInt(hmsMatch[2],10), s = parseInt(hmsMatch[3],10);
                return ((days * 24 + h) * 3600 + m * 60 + s) * 1000;
            }
            const msMatch = String(interval).match(/(\d{1,2}):(\d{2})$/);
            if (msMatch) {
                const m = parseInt(msMatch[1],10), s = parseInt(msMatch[2],10);
                return ((days * 24 * 3600) + m * 60 + s) * 1000;
            }
            const num = parseFloat(interval);
            if (!Number.isNaN(num)) return num * 1000;
            return 0;
        }

        function formatMsToHuman(ms) {
            if (!ms || ms <= 0) return '0m 0s';
            const mins = Math.floor(ms / 60000);
            const secs = Math.floor((ms % 60000) / 1000);
            return `${mins}m ${secs}s`;
        }
        
        function getChartColors() {
            const style = getComputedStyle(document.documentElement);
            return {
                good: style.getPropertyValue('--chart-color-good').trim() || '#00E1FF',
                normal: style.getPropertyValue('--chart-color-normal').trim() || '#FFC300',
                bad: style.getPropertyValue('--chart-color-bad').trim() || '#FF4C4C',
                na: style.getPropertyValue('--chart-color-na').trim() || '#9ca3af',
                accent1: style.getPropertyValue('--chart-color-accent1').trim() || '#9B59B6',
                gridColor: style.getPropertyValue('--chart-grid-color').trim() || '#444444',
                textColor: style.getPropertyValue('--chart-text-color').trim() || '#eeeeee',
                tooltipBg: style.getPropertyValue('--card-bg-color').trim() || '#1f2937',
                tooltipBorder: style.getPropertyValue('--border-color').trim() || '#4b5563'
            };
        }
        
        function formatDateTimeEgypt(dateString, options = {}) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            const defaultOptions = { timeZone: EGYPT_TIMEZONE, day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
            return date.toLocaleString('en-GB', { ...defaultOptions, ...options });
        }

        function formatDateForCSVEgypt(dateString) {
             if (!dateString) return 'N/A';
             const date = new Date(dateString);
             return `${date.toLocaleDateString('en-CA', {timeZone: EGYPT_TIMEZONE})} ${date.toLocaleTimeString('en-GB', {timeZone: EGYPT_TIMEZONE, hour12: false})}`;
        }

        // --- DATA FETCHING & KPI FUNCTIONS ---
        async function loadKpiBoxes() {
          try {
            if (!supabase) return;
            const [topRes, fRes, lRes, tsRes, topTodayRes] = await Promise.all([
                supabase.from('top_5_agents').select('*').limit(5),
                supabase.from('fastest_ticket').select('duration_interval, scenario:call_scenarios(title)').limit(1),
                supabase.from('longest_ticket').select('duration_interval, scenario:call_scenarios(title)').limit(1),
                supabase.from('top_scenario').select('scenario:call_scenarios(title), count').limit(1),
                supabase.rpc('top_agents_today')
            ]);
            
            if (topTodayRes.data && topTodayRes.data.length > 0) {
              const el = document.getElementById('topAgentsList');
              if (el) el.innerHTML = topTodayRes.data.map(t => `<li>${t.agent_name}<span>${t.count}</span></li>`).join('');
            }

            if (fRes.data && fRes.data[0]) {
              const el = document.getElementById('kpi-fastest');
              if (el) el.textContent = formatMsToHuman(pgIntervalToMs(fRes.data[0].duration_interval));
            }
            if (lRes.data && lRes.data[0]) {
              const el = document.getElementById('kpi-longest');
              if (el) el.textContent = formatMsToHuman(pgIntervalToMs(lRes.data[0].duration_interval));
            }
            if (tsRes.data && tsRes.data[0]) {
              const el = document.getElementById('kpi-top-scenario');
              if (el) el.textContent = tsRes.data[0].scenario?.title || '-';
            }
          } catch(e){ console.warn('loadKpiBoxes error:', e); }
        }

        async function loadInitialData() {
            try {
                const [agentsRes, sessionsRes] = await Promise.all([
                    supabase.from('users').select('id, name, email').order('name', { ascending: true }),
                    supabase.from('call_sessions_egypt').select(`*, scenario:call_scenarios(id, title)`).order('start_time_egypt', { ascending: false })
                ]);
                if (agentsRes.error) throw agentsRes.error;
                if (sessionsRes.error) throw sessionsRes.error;
                allAgents = agentsRes.data || [];
                allCallSessions = sessionsRes.data || [];
                populateAgentFilter();
            } catch (error) {
                console.error("Error loading initial dashboard data:", error);
                recentCallsTableBody.innerHTML = `<tr><td colspan="8" style="text-align:center; color:var(--danger-color);">Failed to load data: ${error.message}</td></tr>`;
            }
        }

        // --- MAIN INITIALIZATION FUNCTION ---
        async function initializeDashboard() {
            if (!supabase) return;
            const { data: { session }, error: sessionError } = await supabase.auth.getSession();
            if (sessionError || !session) { window.location.href = 'login.html'; return; }

            const storedUserData = JSON.parse(localStorage.getItem('elevoCoreUserData'));
            if (storedUserData && storedUserData.id === session.user.id) {
                currentUser = storedUserData;
            } else {
                const { data: profile } = await supabase.from('users').select('name, is_admin').eq('id', session.user.id).single();
                currentUser = {
                    id: session.user.id, email: session.user.email,
                    name: profile?.name || session.user.email.split('@')[0], isAdmin: profile?.is_admin || false
                };
                localStorage.setItem('elevoCoreUserData', JSON.stringify(currentUser));
            }

            if (!currentUser.isAdmin) { showAccessDenied(); return; }

            appContainerContent.style.display = 'flex';
            authLoadingMessageDiv.style.display = 'none';
            dashboardContentDiv.style.display = 'flex'; 

            setupAdminUI();
            await loadInitialData();
            await loadKpiBoxes();
            loadPersistedFilters();
            applyFiltersAndRender();
            setupEventListeners();
            setupLiveCallMonitoring();
        }
        
        // --- UI AND AUTH FUNCTIONS ---
        function showAccessDenied(message = "You do not have permission to view this page.") {
            authLoadingMessageDiv.style.display = 'none'; dashboardContentDiv.style.display = 'none'; appContainerContent.style.display = 'flex';
            accessDeniedModal.querySelector('p').textContent = message; accessDeniedModal.style.display = 'flex';
            if (liveCallsChannel) { supabase.removeChannel(liveCallsChannel); liveCallsChannel = null; }
        }

        function setupAdminUI() { 
            userNameDisplayHeader.textContent = currentUser.name;
            dashboardUserGreeting.innerHTML = `👋 Welcome back, <span class="user-name-emphasis" style="color:var(--primary-color);">${currentUser.name}</span>!`;
            userAvatarCharEl.textContent = currentUser.name.charAt(0).toUpperCase();
            userInfoDivHeader.style.display = 'flex';
            if (currentUser.isAdmin) {
                rtmDashboardLink.style.display = 'inline-block';
                agentPortalLink.style.display = 'inline-block';
            }
        }

        // --- FILTERING AND RENDERING ---
        function populateAgentFilter() {
            userFilterDropdown.innerHTML = '<option value="">All Agents</option>';
            allAgents.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.id;
                option.textContent = agent.name ? `${agent.name} (${agent.email})` : agent.email;
                userFilterDropdown.appendChild(option);
            });
        }

        function applyFiltersAndRender() {
            saveFiltersToLocalStorage();
            let tempFiltered = [...allCallSessions];
            const searchTerm = searchInput.value.toLowerCase().trim(), selectedAgentId = userFilterDropdown.value,
                  selectedQuality = qualityFilter.value, startDate = startDateFilter.value, endDate = endDateFilter.value;
            if (selectedAgentId) tempFiltered = tempFiltered.filter(s => s.user_id === selectedAgentId);
            if (searchTerm) tempFiltered = tempFiltered.filter(s => {
                const agent = allAgents.find(a => a.id === s.user_id);
                return ((s.scenario?.title || '').toLowerCase().includes(searchTerm) || (s.quality_reason || '').toLowerCase().includes(searchTerm) || (agent?.name || '').toLowerCase().includes(searchTerm) || (agent?.email || '').toLowerCase().includes(searchTerm));
            });
            if (selectedQuality) tempFiltered = tempFiltered.filter(s => (selectedQuality === "N/A" ? !s.call_quality : s.call_quality === selectedQuality));
            if (startDate) tempFiltered = tempFiltered.filter(s => s.start_time_egypt && new Date(s.start_time_egypt) >= new Date(startDate + "T00:00:00.000Z"));
            if (endDate) tempFiltered = tempFiltered.filter(s => s.start_time_egypt && new Date(s.start_time_egypt) <= new Date(endDate + "T23:59:59.999Z"));
            filteredCallSessions = tempFiltered;
            currentPage = 1;
            renderTable();
            updateStats();
            renderPagination();
            updateAnalyticsCharts();
        }
        
        function renderTable() { 
            recentCallsTableBody.innerHTML = '';
            if (filteredCallSessions.length === 0) {
                recentCallsTableBody.innerHTML = `<tr class="placeholder-row"><td colspan="8"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>No ticket sessions match your filters.</td></tr>`;
                return;
            }
            const paginatedSessions = filteredCallSessions.slice((currentPage - 1) * ROWS_PER_PAGE, currentPage * ROWS_PER_PAGE);
            paginatedSessions.forEach(session => {
                const agent = allAgents.find(a => a.id === session.user_id);
                const dur = session.duration || 0;
                const row = `<tr>
                    <td>${agent?.name || 'Unknown'}</td><td>${agent?.email || 'N/A'}</td>
                    <td>${session.scenario?.title || 'N/A'}</td><td>${formatDateTimeEgypt(session.start_time_egypt)}</td>
                    <td>${Math.floor(dur / 60)}m ${dur % 60}s</td><td>${session.completed ? '✅ Yes' : '❌ No'}</td>
                    <td class="quality-cell quality-${(session.call_quality || 'na').toLowerCase()}">${session.call_quality || 'N/A'}</td>
                    <td>${session.quality_reason || '-'}</td>
                </tr>`;
                recentCallsTableBody.insertAdjacentHTML('beforeend', row);
            });
        }
        
        function updateStats() {
            const sessionsToAnalyze = filteredCallSessions;
            const count = sessionsToAnalyze.length;
            totalCallsEl.textContent = count;
            const agent = allAgents.find(a => a.id === userFilterDropdown.value);
            const statsPeriodText = agent ? (agent.name || agent.email) : 'All Agents';
            [statsPeriodEl, statsPeriodDurationEl, statsPeriodCompletionEl].forEach(el => el.textContent = statsPeriodText);
            recentCallsTitleEl.textContent = agent ? `Ticket Sessions for ${agent.name || agent.email}` : 'Recent Ticket Sessions';

            if (count > 0) {
                const sessionsWithDuration = sessionsToAnalyze.filter(s => typeof s.duration === 'number');
                const totalDuration = sessionsWithDuration.reduce((sum, call) => sum + call.duration, 0);
                const avgDuration = sessionsWithDuration.length > 0 ? Math.round(totalDuration / sessionsWithDuration.length) : 0;
                avgCallDurationEl.textContent = `${Math.floor(avgDuration / 60)}m ${avgDuration % 60}s`;

                const sessionsWithEndTime = sessionsToAnalyze.filter(s => s.end_time_egypt);
                const completedCount = sessionsWithEndTime.filter(s => s.completed).length;
                completionRateEl.textContent = sessionsWithEndTime.length > 0 ? `${Math.round((completedCount / sessionsWithEndTime.length) * 100)}%` : 'N/A';
                
                const q = sessionsToAnalyze.reduce((a, s) => { if(s.call_quality) { a[s.call_quality.toLowerCase()]++; a.rated++; } return a; }, {good:0, normal:0, bad:0, rated:0});
                if (q.rated > 0) {
                    gaugeGoodEl.style.width = `${(q.good / q.rated) * 100}%`;
                    gaugeNormalEl.style.width = `${(q.normal / q.rated) * 100}%`;
                    gaugeBadEl.style.width = `${(q.bad / q.rated) * 100}%`;
                    avgQualityTextEl.textContent = q.bad/q.rated > 0.3 ? "Needs Improvement" : (q.good/q.rated >= 0.7 ? "Excellent" : "Good");
                } else {
                    [gaugeGoodEl, gaugeNormalEl, gaugeBadEl].forEach(el => el.style.width = '0%');
                    avgQualityTextEl.textContent = 'No Rated Tickets';
                }
            } else {
                avgCallDurationEl.textContent = 'N/A';
                completionRateEl.textContent = 'N/A';
                [gaugeGoodEl, gaugeNormalEl, gaugeBadEl].forEach(el => el.style.width = '0%');
                avgQualityTextEl.textContent = 'No Tickets';
            }
        }
        
        function updateAnalyticsCharts() {
            const colors = getChartColors();
            const FONT_SIZE_TITLE = 16, FONT_SIZE_LEGEND = 14, FONT_SIZE_AXIS = 13;
            
            Chart.defaults.color = colors.textColor;
            Chart.defaults.font.family = "'Poppins', sans-serif";
            const tooltipOptions = { enabled: true, backgroundColor: colors.tooltipBg, titleColor: colors.accent1, bodyColor: colors.textColor, borderColor: colors.tooltipBorder, borderWidth: 1, padding: 10, cornerRadius: 8, titleFont: { size: 14 }, bodyFont: { size: 13 } };
            const legendOptions = { display: true, position: 'bottom', labels: { color: colors.textColor, font: { size: FONT_SIZE_LEGEND }, padding: 15 } };
            const titleOptions = (text) => ({ display: true, text: text, color: colors.textColor, font: { size: FONT_SIZE_TITLE, weight: '600' }, padding: { bottom: 15 }});

            const completed = filteredCallSessions.filter(s => s.completed).length;
            if (statusChart) statusChart.destroy();
            statusChart = new Chart(document.getElementById('statusChart').getContext('2d'), {
                type: 'doughnut', data: { labels: ['Completed', 'Not Completed'], datasets: [{ data: [completed, filteredCallSessions.length - completed], backgroundColor: [colors.good, colors.bad], borderColor: colors.tooltipBg, borderWidth: 4, hoverOffset: 8 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: legendOptions, tooltip: tooltipOptions, title: titleOptions('Completion Status') } }
            });

            const qualityCounts = filteredCallSessions.reduce((a, s) => { a[s.call_quality || 'N/A'] = (a[s.call_quality || 'N/A'] || 0) + 1; return a; }, {});
            if (qualityScoreChart) qualityScoreChart.destroy();
            qualityScoreChart = new Chart(document.getElementById('qualityScoreChart').getContext('2d'), {
                type: 'pie', data: { labels: ['Good', 'Normal', 'Bad', 'N/A'], datasets: [{ data: [qualityCounts['Good']||0, qualityCounts['Normal']||0, qualityCounts['Bad']||0, qualityCounts['N/A']||0], backgroundColor: [colors.good, colors.normal, colors.bad, colors.na], borderColor: colors.tooltipBg, borderWidth: 4, hoverOffset: 8 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: legendOptions, tooltip: tooltipOptions, title: titleOptions('Ticket Quality Breakdown') } }
            });

            const volumeByDay = filteredCallSessions.reduce((a, s) => { const d = new Date(s.start_time_egypt).toLocaleDateString('en-CA', { timeZone: EGYPT_TIMEZONE }); a[d] = (a[d] || 0) + 1; return a; }, {});
            const sortedDates = Object.keys(volumeByDay).sort((a,b) => new Date(a) - new Date(b)).slice(-10);
            if (ticketVolumeChart) ticketVolumeChart.destroy();
            ticketVolumeChart = new Chart(document.getElementById('ticketVolumeChart').getContext('2d'), {
                type: 'bar', data: { labels: sortedDates, datasets: [{ label: 'Tickets', data: sortedDates.map(d => volumeByDay[d]), backgroundColor: colors.accent1, borderColor: colors.accent1, borderWidth: 1, borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: colors.gridColor }, ticks:{color: colors.textColor, font: { size: FONT_SIZE_AXIS }} }, x: { grid: { color: colors.gridColor }, ticks:{color: colors.textColor, font: { size: FONT_SIZE_AXIS }} } }, plugins: { legend: { display: false }, tooltip: tooltipOptions, title: titleOptions('Daily Ticket Volume') } }
            });

            const badReasons = filteredCallSessions.filter(s => s.call_quality === 'Bad' && s.quality_reason).reduce((a, s) => { a[s.quality_reason] = (a[s.quality_reason] || 0) + 1; return a; }, {});
            const sortedBadReasons = Object.entries(badReasons).sort(([,a],[,b]) => b-a).slice(0, 5);
            if (badReasonsChart) badReasonsChart.destroy();
            badReasonsChart = new Chart(document.getElementById('badReasonsChart').getContext('2d'), {
                type: 'bar', data: { labels: sortedBadReasons.map(i => i[0]), datasets: [{ label: 'Count', data: sortedBadReasons.map(i => i[1]), backgroundColor: colors.bad, borderColor: colors.bad, borderWidth: 1, borderRadius: 4 }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, layout: { padding: { left: 30 } }, scales: { x: { beginAtZero: true, grid: { color: colors.gridColor }, ticks:{color: colors.textColor, font: { size: FONT_SIZE_AXIS }} }, y: { grid: { display: false }, ticks:{color: colors.textColor, font: { size: FONT_SIZE_AXIS }} } }, plugins: { legend: { display: false }, tooltip: tooltipOptions, title: titleOptions("Top 'Bad' Quality Reasons") } }
            });

            if(progressChart) progressChart.destroy();
            progressChart = new Chart(document.getElementById('progressChart').getContext('2d'), {
                type: 'bar', data: { labels: ['This Month', 'Last Month'], datasets: [{ label: 'Sessions Count', data: [12, 8], backgroundColor: ['#4CAF50', '#FF9800'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: 'Sessions Growth Comparison', color: colors.textColor, font: { size: FONT_SIZE_TITLE, weight: '600' } } }, scales: { y: { grid: { color: colors.gridColor }, ticks: { color: colors.textColor, font: { size: FONT_SIZE_AXIS } } }, x: { grid: { color: colors.gridColor }, ticks: { color: colors.textColor, font: { size: FONT_SIZE_AXIS } } } } }
            });
        }
        
        function renderPagination() {
            paginationControlsContainer.innerHTML = '';
            const totalPages = Math.ceil(filteredCallSessions.length / ROWS_PER_PAGE);
            if (totalPages <= 1) return;
            const prevButton = document.createElement('button');
            prevButton.innerHTML = '&laquo; Previous';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => { if(currentPage > 1) { currentPage--; renderTable(); renderPagination(); } });
            const nextButton = document.createElement('button');
            nextButton.innerHTML = 'Next &raquo;';
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => { if(currentPage < totalPages) { currentPage++; renderTable(); renderPagination(); } });
            const pageInfo = document.createElement('span');
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            pageInfo.style.margin = '0 1rem';
            pageInfo.style.fontWeight = '500';
            paginationControlsContainer.appendChild(prevButton);
            paginationControlsContainer.appendChild(pageInfo);
            paginationControlsContainer.appendChild(nextButton);
        }

        // --- LOCAL STORAGE & EVENT LISTENERS ---
        function saveFiltersToLocalStorage() { /* Unchanged */ }
        function loadPersistedFilters() { /* Unchanged */ }
        
        function setupEventListeners() {
            const filterInputs = [userFilterDropdown, searchInput, qualityFilter, startDateFilter, endDateFilter];
            filterInputs.forEach(input => input.addEventListener('input', () => {
                clearTimeout(filterTimeoutId);
                filterTimeoutId = setTimeout(applyFiltersAndRender, 400);
            }));
            resetFiltersBtn.addEventListener('click', () => { filterInputs.forEach(input => input.value = ''); applyFiltersAndRender(); });
            logoutButton.addEventListener('click', async () => {
                if (liveCallsChannel) await supabase.removeChannel(liveCallsChannel);
                await supabase.auth.signOut();
                localStorage.clear();
                window.location.href = "login.html";
            });
            returnToAppBtn.addEventListener('click', () => { window.location.href = 'core-flow.html'; });
            exportDataBtn.addEventListener('click', exportFilteredDataToCSV);
            exportDataXLSXBtn.addEventListener('click', exportFilteredDataToXLSX);
        }

        // --- DATA EXPORT ---
        function exportFilteredDataToCSV() {
            if (filteredCallSessions.length === 0) { alert("No data to export."); return; }
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += ["Agent Name", "Agent Email", "Scenario", "Start Time (EET)", "End Time (EET)", "Duration (s)", "Completed", "Quality", "Reason"].join(",") + "\r\n";
            filteredCallSessions.forEach(session => {
                const agent = allAgents.find(a => a.id === session.user_id);
                const row = [`"${agent?.name || 'Unknown'}"`, `"${agent?.email || 'N/A'}"`, `"${session.scenario?.title?.replace(/"/g, '""') || 'N/A'}"`, `"${formatDateForCSVEgypt(session.start_time_egypt)}"`, `"${formatDateForCSVEgypt(session.end_time_egypt)}"`, session.duration || 0, session.completed ? 'Yes' : 'No', session.call_quality || 'N/A', `"${session.quality_reason?.replace(/"/g, '""') || ''}"`];
                csvContent += row.join(",") + "\r\n";
            });
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "elevo_core_sessions.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportFilteredDataToXLSX() {
            if (filteredCallSessions.length === 0) { alert("No data to export."); return; }
            const dataToExport = filteredCallSessions.map(session => {
                const agent = allAgents.find(a => a.id === session.user_id);
                return { "Agent Name": agent?.name || 'Unknown', "Agent Email": agent?.email || 'N/A', "Scenario": session.scenario?.title || 'N/A', "Start Time (EET)": formatDateForCSVEgypt(session.start_time_egypt), "End Time (EET)": formatDateForCSVEgypt(session.end_time_egypt), "Duration (s)": session.duration || 0, "Completed": session.completed ? 'Yes' : 'No', "Quality": session.call_quality || 'N/A', "Reason": session.quality_reason || '' };
            });
            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Ticket Sessions");
            XLSX.writeFile(workbook, "elevo_core_sessions.xlsx");
        }
        
        // --- LIVE MONITORING ---
        async function fetchAndRenderLiveCalls() {
            try {
                const { data, error } = await supabase
                    .from('call_sessions_egypt').select('id, agent_name, start_time_egypt, scenario:call_scenarios(title)')
                    .is('end_time_egypt', null)
                    .order('start_time_egypt', { ascending: false });

                if (error) throw error;
                
                liveCallsContainer.innerHTML = '';
                delayedTicketsContainer.innerHTML = '';
                let delayedCount = 0;
                let liveCount = 0;

                (data || []).forEach(call => {
                    const duration = Math.floor((Date.now() - new Date(call.start_time_egypt)) / 1000);
                    const isDelayed = duration > 180; // 3 minutes threshold
                    const item = document.createElement('div');
                    item.className = 'live-call-item';
                    item.innerHTML = `<div><strong>${call.agent_name || 'Unknown'}</strong> "${call.scenario?.title || 'ticket'}"</div>
                        <div class="live-call-item-time"><span>Started: ${formatDateTimeEgypt(call.start_time_egypt, { hour:'2-digit', minute:'2-digit' })}</span> <span class="live-call-duration">${Math.floor(duration/60)}m ${duration%60}s ${isDelayed?'<span class="long-call-indicator">DELAYED</span>':''}</span></div>`;
                    
                    if (isDelayed) {
                        delayedTicketsContainer.appendChild(item);
                        delayedCount++;
                    } else {
                        liveCallsContainer.appendChild(item);
                        liveCount++;
                    }
                });

                noDelayedTicketsMessage.style.display = (delayedCount === 0) ? 'block' : 'none';
                noLiveCallsMessage.style.display = (liveCount === 0) ? 'block' : 'none';

            } catch(error) {
                console.error("Error fetching live calls:", error);
                noLiveCallsMessage.textContent = 'Error loading live data.';
                noLiveCallsMessage.style.display = 'block';
                noDelayedTicketsMessage.textContent = 'Error loading delayed data.';
                noDelayedTicketsMessage.style.display = 'block';
            }
        }

        async function setupLiveCallMonitoring() {
            await fetchAndRenderLiveCalls();
            liveCallsChannel = supabase
                .channel('dashboard-call-sessions-egypt')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'call_sessions_egypt' }, (payload) => {
                    fetchAndRenderLiveCalls(); 
                    loadInitialData().then(applyFiltersAndRender);
                })
                .subscribe();

            setInterval(fetchAndRenderLiveCalls, 5000); // Refresh every 5 seconds
        }

        // --- START THE APPLICATION ---
        if(supabase) {
            initializeDashboard();
        }
    
    </script>
</body>
</html>
